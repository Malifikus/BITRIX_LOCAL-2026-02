{"version":3,"file":"script.js","sources":["src/index.js"],"sourcesContent":["import { Type, Dom, ajax } from 'main.core';\nimport { BitrixVue } from 'ui.vue3';\n\nexport type SystemAuthAuthorizeParamsType = {\n\tauthContainerNode: HTMLElement,\n\tisQrAvailable: 'Y' | 'N',\n\tisStorePasswordAvailable: 'Y' | 'N',\n\tisCaptchaAvailable: 'Y' | 'N',\n\tqrText: string,\n\tqrConfig: string,\n\tfocusInput: string,\n}\n\nexport class SystemAuthAuthorize\n{\n\t#application;\n\t#authContainerNode: HTMLElement;\n\t#isQrAvailable: boolean;\n\t#isStorePasswordAvailable: boolean;\n\t#isCaptchaAvailable: boolean;\n\t#qrText: string;\n\t#qrConfig: string;\n\t#focusInput: string;\n\n\tconstructor(params: SystemAuthAuthorizeParamsType)\n\t{\n\t\tthis.#authContainerNode = params.authContainerNode;\n\t\tthis.#isQrAvailable = params.isQrAvailable === 'Y';\n\t\tthis.#isStorePasswordAvailable = params.isStorePasswordAvailable === 'Y';\n\t\tthis.#isCaptchaAvailable = params.isCaptchaAvailable === 'Y';\n\t\tthis.#qrText = params.qrText || '';\n\t\tthis.#qrConfig = params.qrConfig || '';\n\t\tthis.#focusInput = params.focusInput || '';\n\n\t\tif (!Type.isDomNode(this.#authContainerNode))\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tthis.#initVueApp();\n\t}\n\n\t#initVueApp(): void\n\t{\n\t\tconst context = this;\n\n\t\tthis.#application = BitrixVue.createApp({\n\t\t\tname: 'SystemAuthAuthorize',\n\t\t\tdata()\n\t\t\t{\n\t\t\t\treturn {\n\t\t\t\t\tisWaiting: false,\n\t\t\t\t\tauthContainerNode: this.getApplication().#authContainerNode,\n\t\t\t\t\tisQrAvailable: this.getApplication().#isQrAvailable,\n\t\t\t\t\tisStorePasswordAvailable: this.getApplication().#isStorePasswordAvailable,\n\t\t\t\t\tisCaptchaAvailable: this.getApplication().#isCaptchaAvailable,\n\t\t\t\t\tfocusInput: this.getApplication().#focusInput,\n\t\t\t\t\tqrText: this.getApplication().#qrText,\n\t\t\t\t\tqrConfig: this.getApplication().#qrConfig,\n\t\t\t\t\tisFormBlockVisible: true,\n\t\t\t\t\tisCaptchaBlockVisible: false,\n\t\t\t\t};\n\t\t\t},\n\t\t\tbeforeCreate(): void\n\t\t\t{\n\t\t\t\tthis.$bitrix.Application.set(context);\n\t\t\t},\n\t\t\tmounted(): void\n\t\t\t{\n\t\t\t\tBX.UI.Hint.init(this.authContainerNode);\n\n\t\t\t\tconst focusInput = document.forms.form_auth[this.focusInput];\n\t\t\t\tfocusInput?.focus();\n\n\t\t\t\tif (this.isQrAvailable)\n\t\t\t\t{\n\t\t\t\t\tthis.initQrCode();\n\t\t\t\t}\n\t\t\t},\n\t\t\tmethods: {\n\t\t\t\tonButtonClick(event): void\n\t\t\t\t{\n\t\t\t\t\tif (this.isCaptchaAvailable && !this.isCaptchaBlockVisible)\n\t\t\t\t\t{\n\t\t\t\t\t\tevent.preventDefault();\n\t\t\t\t\t\tthis.showCaptchaBlock();\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.isWaiting = true;\n\t\t\t\t\t}\n\t\t\t\t},\n\n\t\t\t\tshowCaptchaBlock(): void\n\t\t\t\t{\n\t\t\t\t\tthis.isFormBlockVisible = false;\n\t\t\t\t\tthis.isCaptchaBlockVisible = true;\n\t\t\t\t},\n\n\t\t\t\tinitQrCode(): void\n\t\t\t\t{\n\t\t\t\t\tnew QRCode('bx_auth_qr_code', {\n\t\t\t\t\t\ttext: this.qrText,\n\t\t\t\t\t\twidth: 220,\n\t\t\t\t\t\theight: 220,\n\t\t\t\t\t\tcolorDark: '#000000',\n\t\t\t\t\t\tcolorLight: '#ffffff',\n\t\t\t\t\t});\n\n\t\t\t\t\tif (!this.qrConfig)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.qrCodeSuccessIcon = this.authContainerNode.querySelector('.intranet-qr-scan-form__code-overlay');\n\n\t\t\t\t\tconst Pull = new BX.PullClient();\n\t\t\t\t\tPull.subscribe({\n\t\t\t\t\t\tmoduleId: 'main',\n\t\t\t\t\t\tcommand: 'qrAuthorize',\n\t\t\t\t\t\tcallback: (params) => {\n\t\t\t\t\t\t\tif (params.token)\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tthis.showQrCodeSuccessIcon();\n\n\t\t\t\t\t\t\t\tajax.runAction(\n\t\t\t\t\t\t\t\t\t'main.qrcodeauth.authenticate',\n\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\tdata: {\n\t\t\t\t\t\t\t\t\t\t\ttoken: params.token,\n\t\t\t\t\t\t\t\t\t\t\tremember: (this.isStorePasswordAvailable ? 1 : 0),\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t).then((response) => {\n\t\t\t\t\t\t\t\t\tthis.hideQrCodeSuccessIcon();\n\n\t\t\t\t\t\t\t\t\tif (response.status === 'success')\n\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\twindow.location = (params.redirectUrl !== '' ? params.redirectUrl : window.location);\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t}).catch((error) => console.error(error));\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t},\n\t\t\t\t\t});\n\t\t\t\t\tPull.start(this.qrConfig);\n\t\t\t\t},\n\n\t\t\t\tshowQrCodeSuccessIcon(): void\n\t\t\t\t{\n\t\t\t\t\tif (!Type.isDomNode(this.qrCodeSuccessIcon))\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tDom.addClass(this.qrCodeSuccessIcon, 'intranet-qr-scan-form__code-overlay--active');\n\t\t\t\t},\n\n\t\t\t\thideQrCodeSuccessIcon(): void\n\t\t\t\t{\n\t\t\t\t\tif (!Type.isDomNode(this.qrCodeSuccessIcon))\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tDom.removeClass(this.qrCodeSuccessIcon, 'intranet-qr-scan-form__code-overlay--active');\n\t\t\t\t},\n\n\t\t\t\tgetApplication()\n\t\t\t\t{\n\t\t\t\t\treturn this.$bitrix.Application.get();\n\t\t\t\t},\n\t\t\t},\n\t\t});\n\t\tthis.#application.mount(this.#authContainerNode);\n\t}\n}\n"],"names":["SystemAuthAuthorize","constructor","params","authContainerNode","isQrAvailable","isStorePasswordAvailable","isCaptchaAvailable","qrText","qrConfig","focusInput","Type","isDomNode","context","BitrixVue","createApp","name","data","isWaiting","getApplication","isFormBlockVisible","isCaptchaBlockVisible","beforeCreate","$bitrix","Application","set","mounted","BX","UI","Hint","init","document","forms","form_auth","focus","initQrCode","methods","onButtonClick","event","preventDefault","showCaptchaBlock","QRCode","text","width","height","colorDark","colorLight","qrCodeSuccessIcon","querySelector","Pull","PullClient","subscribe","moduleId","command","callback","token","showQrCodeSuccessIcon","ajax","runAction","remember","then","response","hideQrCodeSuccessIcon","status","window","location","redirectUrl","catch","error","console","start","Dom","addClass","removeClass","get","mount"],"mappings":"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"}