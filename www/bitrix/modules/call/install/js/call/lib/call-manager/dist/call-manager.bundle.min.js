this.BX=this.BX||{};this.BX.Call=this.BX.Call||{};(function(e,t,s,a,l,r,i,o,n,c,d,b,v,u,h,p,C){"use strict";let g=e=>e,L;const P=async e=>{const t=()=>{const t=l.getSelectedItems();const s=y(t);e.onSelect({users:s})};const s=()=>{l.hide()};const{Dialog:a}=await h.Runtime.loadExtension("ui.entity-selector");const l=new a({targetNode:e.bindElement,width:400,enableSearch:true,dropdownMode:true,context:"IM_CHAT_SEARCH",entities:[{id:"user",dynamicLoad:true,itemOptions:{default:{linkTitle:"",link:""}},options:{inviteEmployeeLink:false,"!userId":C.Core.getUserId()},filters:[{id:"im.userDataFilter"}]}],footer:B(t,s)});l.show();return Promise.resolve({close:()=>{l.hide()}})};const y=e=>e.map((e=>({id:e.id,name:e.title.text,avatar:e.avatar,avatar_hr:e.avatar,gender:e.customData.get("imUser").GENDER})));const B=(e,t)=>{const s=h.Loc.getMessage("CALL_LIB_CALL_ADD_BUTTON");const a=h.Loc.getMessage("CALL_LIB_CALL_CANCEL_BUTTON");return h.Tag.render(L||(L=g`
		<button class="ui-btn ui-btn-xs ui-btn-primary" onclick="${0}">${0}</button>
		<button class="ui-btn ui-btn-xs ui-btn-light-border" onclick="${0}">${0}</button>
	`),e,s,t,a)};var f=babelHelpers.classPrivateFieldLooseKey("controller");var F=babelHelpers.classPrivateFieldLooseKey("restClient");var H=babelHelpers.classPrivateFieldLooseKey("openChatActionByChatType");var S=babelHelpers.classPrivateFieldLooseKey("onCallJoinHandler");var m=babelHelpers.classPrivateFieldLooseKey("onCallLeaveHandler");var E=babelHelpers.classPrivateFieldLooseKey("onCallDestroyHandler");var I=babelHelpers.classPrivateFieldLooseKey("getController");var O=babelHelpers.classPrivateFieldLooseKey("getChatService");var A=babelHelpers.classPrivateFieldLooseKey("subscribeToEvents");var M=babelHelpers.classPrivateFieldLooseKey("subscribeToCallEvents");var D=babelHelpers.classPrivateFieldLooseKey("unsubscribeFromCallEvents");var j=babelHelpers.classPrivateFieldLooseKey("onCallCreated");var T=babelHelpers.classPrivateFieldLooseKey("onCallJoin");var K=babelHelpers.classPrivateFieldLooseKey("onCallLeave");var X=babelHelpers.classPrivateFieldLooseKey("onCallDestroy");var w=babelHelpers.classPrivateFieldLooseKey("onOpenChat");var U=babelHelpers.classPrivateFieldLooseKey("checkCallSupport");var R=babelHelpers.classPrivateFieldLooseKey("checkUserCallSupport");var _=babelHelpers.classPrivateFieldLooseKey("checkChatCallSupport");var k=babelHelpers.classPrivateFieldLooseKey("pushServerIsActive");var N=babelHelpers.classPrivateFieldLooseKey("getCurrentDialogId");var x=babelHelpers.classPrivateFieldLooseKey("getDialog");var J=babelHelpers.classPrivateFieldLooseKey("getChatId");var V=babelHelpers.classPrivateFieldLooseKey("isUser");var $=babelHelpers.classPrivateFieldLooseKey("getChatInfo");var q=babelHelpers.classPrivateFieldLooseKey("prepareChatInfo");var G=babelHelpers.classPrivateFieldLooseKey("prepareCall");var W=babelHelpers.classPrivateFieldLooseKey("getChatUserCounter");class Z{static getInstance(){if(!this.instance){this.instance=new this}return this.instance}constructor(){Object.defineProperty(this,W,{value:Le});Object.defineProperty(this,G,{value:ge});Object.defineProperty(this,q,{value:Ce});Object.defineProperty(this,$,{value:pe});Object.defineProperty(this,V,{value:he});Object.defineProperty(this,J,{value:ue});Object.defineProperty(this,x,{value:ve});Object.defineProperty(this,N,{value:be});Object.defineProperty(this,k,{value:de});Object.defineProperty(this,_,{value:ce});Object.defineProperty(this,R,{value:ne});Object.defineProperty(this,U,{value:oe});Object.defineProperty(this,w,{value:ie});Object.defineProperty(this,X,{value:re});Object.defineProperty(this,K,{value:le});Object.defineProperty(this,T,{value:ae});Object.defineProperty(this,j,{value:se});Object.defineProperty(this,D,{value:te});Object.defineProperty(this,M,{value:ee});Object.defineProperty(this,A,{value:Y});Object.defineProperty(this,O,{value:Q});Object.defineProperty(this,I,{value:z});Object.defineProperty(this,f,{writable:true,value:void 0});Object.defineProperty(this,F,{writable:true,value:void 0});Object.defineProperty(this,H,{writable:true,value:{[i.ChatType.taskComments]:e=>{if(a.Messenger.isEmbeddedMode()||a.Messenger.isMessengerSliderOpened()){return a.Messenger.openTaskComments(e)}return Promise.resolve()}}});Object.defineProperty(this,S,{writable:true,value:void 0});Object.defineProperty(this,m,{writable:true,value:void 0});Object.defineProperty(this,E,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,F)[F]=C.Core.getRestClient();babelHelpers.classPrivateFieldLooseBase(this,f)[f]=babelHelpers.classPrivateFieldLooseBase(this,I)[I]();babelHelpers.classPrivateFieldLooseBase(this,A)[A]();babelHelpers.classPrivateFieldLooseBase(this,S)[S]=babelHelpers.classPrivateFieldLooseBase(this,T)[T].bind(this);babelHelpers.classPrivateFieldLooseBase(this,m)[m]=babelHelpers.classPrivateFieldLooseBase(this,K)[K].bind(this);babelHelpers.classPrivateFieldLooseBase(this,E)[E]=babelHelpers.classPrivateFieldLooseBase(this,X)[X].bind(this)}async sendBroadcastRequest(e){if(!d.DesktopApi.isDesktop()){return[]}return await babelHelpers.classPrivateFieldLooseBase(this,f)[f].callMultiBroadcastClient.broadcastRequest(e,{timeout:100})}startCall(e,t=true,s=""){o.Logger.warn("CallManager: startCall",e,t);v.CallSliderManager.getInstance().setTopSliderId();babelHelpers.classPrivateFieldLooseBase(this,G)[G](e);babelHelpers.classPrivateFieldLooseBase(this,$)[$](e).then((s=>{babelHelpers.classPrivateFieldLooseBase(this,f)[f].startCall(e,t,s)}))}joinCall(e,t,s,a=true){o.Logger.warn("CallManager: joinCall",e,t,a);v.CallSliderManager.getInstance().setTopSliderId();babelHelpers.classPrivateFieldLooseBase(this,G)[G](s);babelHelpers.classPrivateFieldLooseBase(this,$)[$](s).then((s=>{babelHelpers.classPrivateFieldLooseBase(this,f)[f].joinCall(e,t,a,{chatInfo:s})}))}leaveCurrentCall(){o.Logger.warn("CallManager: leaveCurrentCall");babelHelpers.classPrivateFieldLooseBase(this,f)[f].leaveCurrentCall();v.CallSliderManager.getInstance().clearSliderId()}onAnswerButtonClick(e,t){babelHelpers.classPrivateFieldLooseBase(this,f)[f].onAnswerButtonClick(e,t)}onJoinFromRecentItem(){babelHelpers.classPrivateFieldLooseBase(this,f)[f].closeCallNotification()}deleteRecentCall(e){C.Core.getStore().dispatch("recent/calls/deleteActiveCall",{dialogId:e})}foldCurrentCall(){if(!babelHelpers.classPrivateFieldLooseBase(this,f)[f].hasActiveCall()||!babelHelpers.classPrivateFieldLooseBase(this,f)[f].hasVisibleCall()){return}babelHelpers.classPrivateFieldLooseBase(this,f)[f].fold()}unfoldCurrentCall(){if(!babelHelpers.classPrivateFieldLooseBase(this,f)[f].hasActiveCall()){return}babelHelpers.classPrivateFieldLooseBase(this,f)[f].unfold()}getCurrentCallDialogId(){var e,t;if(!babelHelpers.classPrivateFieldLooseBase(this,f)[f].hasActiveCall()){return""}return(e=babelHelpers.classPrivateFieldLooseBase(this,f)[f])==null?void 0:(t=e.currentCall)==null?void 0:t.associatedEntity.id}getCurrentCall(){if(!babelHelpers.classPrivateFieldLooseBase(this,f)[f].hasActiveCall()){return false}return babelHelpers.classPrivateFieldLooseBase(this,f)[f].currentCall}getCurrentUser(){const e=C.Core.getUserId();return C.Core.getStore().getters["users/get"](e)}hasCurrentCall(){return babelHelpers.classPrivateFieldLooseBase(this,f)[f].hasActiveCall()}hasCurrentScreenSharing(){if(!babelHelpers.classPrivateFieldLooseBase(this,f)[f].hasActiveCall()){return false}return babelHelpers.classPrivateFieldLooseBase(this,f)[f].currentCall.isScreenSharingStarted()}hasVisibleCall(){if(!babelHelpers.classPrivateFieldLooseBase(this,f)[f].hasActiveCall()){return false}return babelHelpers.classPrivateFieldLooseBase(this,f)[f].hasVisibleCall()}startTest(){babelHelpers.classPrivateFieldLooseBase(this,f)[f].test()}toggleDebugFlag(e){if(!babelHelpers.classPrivateFieldLooseBase(this,f)[f]){return}babelHelpers.classPrivateFieldLooseBase(this,f)[f].debug=e}chatCanBeCalled(e){const t=babelHelpers.classPrivateFieldLooseBase(this,U)[U](e);const s=C.Core.getStore().getters["recent/calls/hasActiveCall"](e);return t&&!s}hasActiveCurrentCall(e){return C.Core.getStore().getters["recent/calls/hasActiveCall"](e)&&this.getCurrentCallDialogId()===e}hasActiveAnotherCall(e){return C.Core.getStore().getters["recent/calls/hasActiveCall"]()&&!this.hasActiveCurrentCall(e)}getCallUserLimit(){return BX.Call.Util.getUserLimit()}isChatUserLimitExceeded(e){return babelHelpers.classPrivateFieldLooseBase(this,W)[W](e)>this.getCallUserLimit()}updateRecentCallsList(e){const t=C.Core.getStore().getters["recent/calls/get"];const a=new Map(Object.values(e).map((e=>[e.ID,e])));a.forEach((e=>{const t=babelHelpers.classPrivateFieldLooseBase(this,f)[f].isLegacyCall(e.PROVIDER,e.SCHEME)?s.EngineLegacy.instantiateCall(e,e.USERS,e.LOG_TOKEN,e.CONNECTION_DATA,e.USER_DATA):s.Engine.instantiateCall(e,e.CALL_TOKEN,e.LOG_TOKEN,e.USER_DATA);babelHelpers.classPrivateFieldLooseBase(this,M)[M](t)}));t.filter((e=>!a.has(e.call.id))).forEach((e=>{C.Core.getStore().dispatch("recent/calls/deleteActiveCall",{dialogId:e.dialogId})}))}isConference(e){const t=C.Core.getStore().getters["chats/get"](e);return t.type===i.ChatType.videoconf}}function z(){return new s.Controller({init:true,language:C.Core.getLanguageId(),messengerFacade:{getDefaultZIndex:()=>r.MessengerSlider.getInstance().getZIndex(),isMessengerOpen:()=>r.MessengerSlider.getInstance().isOpened(),isSliderFocused:()=>r.MessengerSlider.getInstance().isFocused(),isThemeDark:()=>false,openMessenger:(e,t=false)=>{const s=babelHelpers.classPrivateFieldLooseBase(this,x)[x](e);if(!t&&s&&s.type in babelHelpers.classPrivateFieldLooseBase(this,H)[H]){return babelHelpers.classPrivateFieldLooseBase(this,H)[H][s.type](e)}return a.Messenger.openChat(e)},openHistory:e=>a.Messenger.openChat(e),openSettings:()=>a.Messenger.openSettings(),openHelpArticle:()=>{},getMessageCount:()=>C.Core.getStore().getters["counters/getTotalChatCounter"],getCurrentDialogId:()=>babelHelpers.classPrivateFieldLooseBase(this,N)[N](),isPromoRequired:e=>n.PromoManager.getInstance().needToShow(e),repeatSound:(e,t,s)=>{c.SoundNotificationManager.getInstance().playLoop(e,t,s)},stopRepeatSound:e=>{c.SoundNotificationManager.getInstance().stop(e)},showUserSelector:P},events:{[s.Controller.Events.onPromoViewed]:e=>{const{code:t}=e.getData();n.PromoManager.getInstance().markAsWatched(t)},[s.Controller.Events.onOpenVideoConference]:e=>{var t;const{dialogId:s}=e.getData();const l=C.Core.getStore().getters["chats/get"](`chat${s}`,true);return a.Messenger.openConference({code:(t=l.public)==null?void 0:t.code})}}})}function Q(){if(!this.chatService){this.chatService=new l.ChatService}return this.chatService}function Y(){t.EventEmitter.subscribe(i.EventType.layout.onLayoutChange,babelHelpers.classPrivateFieldLooseBase(this,w)[w].bind(this));t.EventEmitter.subscribe(i.EventType.layout.onOpenNotifications,this.foldCurrentCall.bind(this));t.EventEmitter.subscribe(i.EventType.call.onJoinFromRecentItem,this.onJoinFromRecentItem.bind(this));t.EventEmitter.subscribe("CallEvents::callCreated",babelHelpers.classPrivateFieldLooseBase(this,j)[j].bind(this))}function ee(e){e.addEventListener(BX.Call.Event.onJoin,babelHelpers.classPrivateFieldLooseBase(this,S)[S]);e.addEventListener(BX.Call.Event.onLeave,babelHelpers.classPrivateFieldLooseBase(this,m)[m]);e.addEventListener(BX.Call.Event.onDestroy,babelHelpers.classPrivateFieldLooseBase(this,E)[E])}function te(e){e.removeEventListener(BX.Call.Event.onJoin,babelHelpers.classPrivateFieldLooseBase(this,S)[S]);e.removeEventListener(BX.Call.Event.onLeave,babelHelpers.classPrivateFieldLooseBase(this,m)[m]);e.removeEventListener(BX.Call.Event.onDestroy,babelHelpers.classPrivateFieldLooseBase(this,E)[E])}function se(e){const{call:t}=e.getData()[0];const a=C.Core.getStore().getters["recent/calls/getCallByDialog"](t.associatedEntity.id);const l=(a==null?void 0:a.call.uuid)!==t.uuid;const r=t.state===s.State.Connected||t.state===s.State.Proceeding?i.RecentCallStatus.joined:i.RecentCallStatus.waiting;if(l){if(a){babelHelpers.classPrivateFieldLooseBase(this,D)[D](a.call)}babelHelpers.classPrivateFieldLooseBase(this,M)[M](t);C.Core.getStore().dispatch("recent/calls/addActiveCall",{dialogId:t.associatedEntity.id,name:t.associatedEntity.name,call:t,state:r});return}C.Core.getStore().dispatch("recent/calls/updateActiveCall",{dialogId:t.associatedEntity.id,fields:{name:t.associatedEntity.name,state:r,call:t}})}function ae(e){C.Core.getStore().dispatch("recent/calls/updateActiveCall",{dialogId:e.call.associatedEntity.id,fields:{state:i.RecentCallStatus.joined}})}function le(e){C.Core.getStore().dispatch("recent/calls/updateActiveCall",{dialogId:e.call.associatedEntity.id,fields:{state:i.RecentCallStatus.waiting}})}function re(e){const t=e.call.associatedEntity.id;const s=C.Core.getStore().getters["recent/calls/getCallByDialog"](t);if(s){babelHelpers.classPrivateFieldLooseBase(this,D)[D](s.call)}if((s==null?void 0:s.call.uuid)===e.call.uuid){C.Core.getStore().dispatch("recent/calls/deleteActiveCall",{dialogId:t})}}function ie(e){const t=this.getCurrentCallDialogId();const s=e.getData().to.entityId;if(t===s){return}this.foldCurrentCall()}function oe(e){if(!babelHelpers.classPrivateFieldLooseBase(this,k)[k]()||!BX.Call.Util.isWebRTCSupported()){return false}const t=Number(e);return t>0?babelHelpers.classPrivateFieldLooseBase(this,R)[R](t):babelHelpers.classPrivateFieldLooseBase(this,_)[_](e)}function ne(e){const t=C.Core.getStore().getters["users/get"](e);const s=t.type===i.UserType.bot;return t&&t.status!=="guest"&&!s&&!t.network&&t.id!==C.Core.getUserId()&&Boolean(t.lastActivityDate)}function ce(e){const t=babelHelpers.classPrivateFieldLooseBase(this,W)[W](e);return(t>1||this.isConference(e))&&t<=this.getCallUserLimit()}function de(){return true}function be(){const e=C.Core.getStore().getters["application/getLayout"];if(e.name!==i.Layout.chat&&e.name!==i.Layout.taskComments){return""}return e.entityId}function ve(e){return C.Core.getStore().getters["chats/get"](e)}function ue(e){var t;return(t=babelHelpers.classPrivateFieldLooseBase(this,x)[x](e))==null?void 0:t.chatId}function he(e){const t=babelHelpers.classPrivateFieldLooseBase(this,x)[x](e);return(t==null?void 0:t.type)===i.ChatType.user}function pe(e){const t=C.Core.getStore().getters["chats/get"](e,true);if(t.chatId===0){return babelHelpers.classPrivateFieldLooseBase(this,O)[O]().loadChat(e).then((()=>{const t=C.Core.getStore().getters["chats/get"](e,true);return babelHelpers.classPrivateFieldLooseBase(this,q)[q](t)})).catch((e=>{o.Logger.error("Open chat error",e);return babelHelpers.classPrivateFieldLooseBase(this,q)[q](t)}))}return new Promise((e=>{e(babelHelpers.classPrivateFieldLooseBase(this,q)[q](t))}))}function Ce(e){return{advanced:{chatType:e.type,entityType:e.entityType,entityId:e.entityId,entityData1:e.entityData1,entityData2:e.entityData2,entityData3:e.entityData3},id:e.dialogId,chatId:e.chatId,name:e.name,avatar:e.avatar||"/bitrix/js/im/images/blank.gif",avatarColor:e.color,type:"chat",userCounter:e.userCounter}}function ge(e){const t=C.Core.getUserId();const s=C.Core.getStore().getters["users/get"](t);const a={dialogId:e,userData:{[t]:s}};if(babelHelpers.classPrivateFieldLooseBase(this,V)[V](e)){const t=C.Core.getStore().getters["users/get"](e);a["user"]=t.id;a["userData"][t.id]=t}babelHelpers.classPrivateFieldLooseBase(this,f)[f].prepareCall(a)}function Le(e){const{userCounter:t}=C.Core.getStore().getters["chats/get"](e,true);return t}Z.viewContainerClass="bx-im-messenger__call_container";e.CallManager=Z})(this.BX.Call.Lib=this.BX.Call.Lib||{},BX.Event,BX.Call,BX.Messenger.v2.Lib,BX.Messenger.v2.Service,BX.Messenger.v2.Lib,BX.Messenger.v2.Const,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX,BX.Call.Lib,BX,BX,BX.UI,BX.Messenger.v2.Application);
//# sourceMappingURL=call-manager.bundle.map.js