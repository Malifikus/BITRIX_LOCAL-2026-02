this.BX=this.BX||{};this.BX.Messenger=this.BX.Messenger||{};(function(e,t,i,n,a,r,o,l,s,c,u,d,h,C,f,p,m,v,g,S,w,y,k,E,I,R,b,_,T,A,U,L,M,P){"use strict";var V=Object.freeze({guest:"guest"});var B=function(){function e(t){babelHelpers.classCallCheck(this,e);this.queryAuthRestore=false;this.setAuthId(V.guest);this.restClient=new M.RestClient({endpoint:t.endpoint,queryParams:this.queryParams,cors:true})}babelHelpers.createClass(e,[{key:"setAuthId",value:function e(t){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:"";if(babelHelpers["typeof"](this.queryParams)!=="object"){this.queryParams={}}if(t==V.guest||typeof t==="string"&&t.match(/^[a-f0-9]{32}$/)){this.queryParams.call_auth_id=t}else{console.error("%CallRestClient.setAuthId: auth is not correct (%c".concat(t,"%c)"),"color: black;","font-weight: bold; color: red","color: black");return false}if(t==V.guest&&typeof i==="string"&&i.match(/^[a-f0-9]{32}$/)){this.queryParams.call_custom_auth_id=i}return true}},{key:"setChatId",value:function e(t){if(babelHelpers["typeof"](this.queryParams)!=="object"){this.queryParams={}}this.queryParams.call_chat_id=t}},{key:"setConfId",value:function e(t){if(babelHelpers["typeof"](this.queryParams)!=="object"){this.queryParams={}}this.queryParams.videoconf_id=t}},{key:"setPassword",value:function e(t){if(babelHelpers["typeof"](this.queryParams)!=="object"){this.queryParams={}}this.queryParams.videoconf_password=t}},{key:"callMethod",value:function e(t,i,n,a){var r=this;var o=arguments.length>4&&arguments[4]!==undefined?arguments[4]:null;if(!o){o=P.Utils.getLogTrackingParams({name:t})}var l=new BX.Promise;this.restClient.callMethod(t,i,null,a,o).then((function(e){r.queryAuthRestore=false;l.fulfill(e)}))["catch"]((function(e){var n=e.error();if(n.ex.error=="LIVECHAT_AUTH_WIDGET_USER"){r.setAuthId(n.ex.hash);if(t===RestMethod.widgetUserRegister){console.warn("BX.LiveChatRestClient: ".concat(n.ex.error_description," (").concat(n.ex.error,")"));r.queryAuthRestore=false;l.reject(e);return false}if(!r.queryAuthRestore){console.warn("BX.LiveChatRestClient: your auth-token has expired, send query with a new token");r.queryAuthRestore=true;r.restClient.callMethod(t,i,null,a,o).then((function(e){r.queryAuthRestore=false;l.fulfill(e)}))["catch"]((function(e){r.queryAuthRestore=false;l.reject(e)}));return false}}r.queryAuthRestore=false;l.reject(e)}));return l}},{key:"callBatch",value:function e(t,i,n,a,r){var o=this;var l=function e(l){for(var s in t){if(!t.hasOwnProperty(s)){continue}var c=l[s].error();if(c&&c.ex.error=="LIVECHAT_AUTH_WIDGET_USER"){o.setAuthId(c.ex.hash);if(s===RestMethod.widgetUserRegister){console.warn("BX.LiveChatRestClient: ".concat(c.ex.error_description," (").concat(c.ex.error,")"));o.queryAuthRestore=false;i(l);return false}if(!o.queryAuthRestore){console.warn("BX.LiveChatRestClient: your auth-token has expired, send query with a new token");o.queryAuthRestore=true;o.restClient.callBatch(t,i,n,a,r);return false}}}o.queryAuthRestore=false;i(l);return true};return this.restClient.callBatch(t,l,n,a,r)}}]);return e}();function H(){/*! regenerator-runtime -- Copyright (c) 2014-present, Facebook, Inc. -- license (MIT): https://github.com/facebook/regenerator/blob/main/LICENSE */H=function t(){return e};var e={},t=Object.prototype,i=t.hasOwnProperty,n=Object.defineProperty||function(e,t,i){e[t]=i.value},a="function"==typeof Symbol?Symbol:{},r=a.iterator||"@@iterator",o=a.asyncIterator||"@@asyncIterator",l=a.toStringTag||"@@toStringTag";function s(e,t,i){return Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{s({},"")}catch(e){s=function e(t,i,n){return t[i]=n}}function c(e,t,i,a){var r=t&&t.prototype instanceof h?t:h,o=Object.create(r.prototype),l=new R(a||[]);return n(o,"_invoke",{value:y(e,i,l)}),o}function u(e,t,i){try{return{type:"normal",arg:e.call(t,i)}}catch(e){return{type:"throw",arg:e}}}e.wrap=c;var d={};function h(){}function C(){}function f(){}var p={};s(p,r,(function(){return this}));var m=Object.getPrototypeOf,v=m&&m(m(b([])));v&&v!==t&&i.call(v,r)&&(p=v);var g=f.prototype=h.prototype=Object.create(p);function S(e){["next","throw","return"].forEach((function(t){s(e,t,(function(e){return this._invoke(t,e)}))}))}function w(e,t){function a(n,r,o,l){var s=u(e[n],e,r);if("throw"!==s.type){var c=s.arg,d=c.value;return d&&"object"==babelHelpers["typeof"](d)&&i.call(d,"__await")?t.resolve(d.__await).then((function(e){a("next",e,o,l)}),(function(e){a("throw",e,o,l)})):t.resolve(d).then((function(e){c.value=e,o(c)}),(function(e){return a("throw",e,o,l)}))}l(s.arg)}var r;n(this,"_invoke",{value:function e(i,n){function o(){return new t((function(e,t){a(i,n,e,t)}))}return r=r?r.then(o,o):o()}})}function y(e,t,i){var n="suspendedStart";return function(a,r){if("executing"===n)throw new Error("Generator is already running");if("completed"===n){if("throw"===a)throw r;return _()}for(i.method=a,i.arg=r;;){var o=i.delegate;if(o){var l=k(o,i);if(l){if(l===d)continue;return l}}if("next"===i.method)i.sent=i._sent=i.arg;else if("throw"===i.method){if("suspendedStart"===n)throw n="completed",i.arg;i.dispatchException(i.arg)}else"return"===i.method&&i.abrupt("return",i.arg);n="executing";var s=u(e,t,i);if("normal"===s.type){if(n=i.done?"completed":"suspendedYield",s.arg===d)continue;return{value:s.arg,done:i.done}}"throw"===s.type&&(n="completed",i.method="throw",i.arg=s.arg)}}}function k(e,t){var i=t.method,n=e.iterator[i];if(undefined===n)return t.delegate=null,"throw"===i&&e.iterator["return"]&&(t.method="return",t.arg=undefined,k(e,t),"throw"===t.method)||"return"!==i&&(t.method="throw",t.arg=new TypeError("The iterator does not provide a '"+i+"' method")),d;var a=u(n,e.iterator,t.arg);if("throw"===a.type)return t.method="throw",t.arg=a.arg,t.delegate=null,d;var r=a.arg;return r?r.done?(t[e.resultName]=r.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=undefined),t.delegate=null,d):r:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,d)}function E(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function I(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function R(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(E,this),this.reset(!0)}function b(e){if(e){var t=e[r];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var n=-1,a=function t(){for(;++n<e.length;)if(i.call(e,n))return t.value=e[n],t.done=!1,t;return t.value=undefined,t.done=!0,t};return a.next=a}}return{next:_}}function _(){return{value:undefined,done:!0}}return C.prototype=f,n(g,"constructor",{value:f,configurable:!0}),n(f,"constructor",{value:C,configurable:!0}),C.displayName=s(f,l,"GeneratorFunction"),e.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===C||"GeneratorFunction"===(t.displayName||t.name))},e.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,f):(e.__proto__=f,s(e,l,"GeneratorFunction")),e.prototype=Object.create(g),e},e.awrap=function(e){return{__await:e}},S(w.prototype),s(w.prototype,o,(function(){return this})),e.AsyncIterator=w,e.async=function(t,i,n,a,r){void 0===r&&(r=Promise);var o=new w(c(t,i,n,a),r);return e.isGeneratorFunction(i)?o:o.next().then((function(e){return e.done?e.value:o.next()}))},S(g),s(g,l,"Generator"),s(g,r,(function(){return this})),s(g,"toString",(function(){return"[object Generator]"})),e.keys=function(e){var t=Object(e),i=[];for(var n in t)i.push(n);return i.reverse(),function e(){for(;i.length;){var n=i.pop();if(n in t)return e.value=n,e.done=!1,e}return e.done=!0,e}},e.values=b,R.prototype={constructor:R,reset:function e(t){if(this.prev=0,this.next=0,this.sent=this._sent=undefined,this.done=!1,this.delegate=null,this.method="next",this.arg=undefined,this.tryEntries.forEach(I),!t)for(var n in this)"t"===n.charAt(0)&&i.call(this,n)&&!isNaN(+n.slice(1))&&(this[n]=undefined)},stop:function e(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function e(t){if(this.done)throw t;var n=this;function a(e,i){return l.type="throw",l.arg=t,n.next=e,i&&(n.method="next",n.arg=undefined),!!i}for(var r=this.tryEntries.length-1;r>=0;--r){var o=this.tryEntries[r],l=o.completion;if("root"===o.tryLoc)return a("end");if(o.tryLoc<=this.prev){var s=i.call(o,"catchLoc"),c=i.call(o,"finallyLoc");if(s&&c){if(this.prev<o.catchLoc)return a(o.catchLoc,!0);if(this.prev<o.finallyLoc)return a(o.finallyLoc)}else if(s){if(this.prev<o.catchLoc)return a(o.catchLoc,!0)}else{if(!c)throw new Error("try statement without catch or finally");if(this.prev<o.finallyLoc)return a(o.finallyLoc)}}}},abrupt:function e(t,n){for(var a=this.tryEntries.length-1;a>=0;--a){var r=this.tryEntries[a];if(r.tryLoc<=this.prev&&i.call(r,"finallyLoc")&&this.prev<r.finallyLoc){var o=r;break}}o&&("break"===t||"continue"===t)&&o.tryLoc<=n&&n<=o.finallyLoc&&(o=null);var l=o?o.completion:{};return l.type=t,l.arg=n,o?(this.method="next",this.next=o.finallyLoc,d):this.complete(l)},complete:function e(t,i){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&i&&(this.next=i),d},finish:function e(t){for(var i=this.tryEntries.length-1;i>=0;--i){var n=this.tryEntries[i];if(n.finallyLoc===t)return this.complete(n.completion,n.afterLoc),I(n),d}},catch:function e(t){for(var i=this.tryEntries.length-1;i>=0;--i){var n=this.tryEntries[i];if(n.tryLoc===t){var a=n.completion;if("throw"===a.type){var r=a.arg;I(n)}return r}}throw new Error("illegal catch attempt")},delegateYield:function e(t,i,n){return this.delegate={iterator:b(t),resultName:i,nextLoc:n},"next"===this.method&&(this.arg=undefined),d}},e}function O(e,t){N(e,t);t.add(e)}function D(e,t,i){N(e,t);t.set(e,i)}function N(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}function F(e,t,i){if(!t.has(e)){throw new TypeError("attempted to get private field on non-instance")}return i}var x="bx-call-control-notification-right-offset";var W=new WeakMap;var X=new WeakMap;var Y=new WeakSet;var j=new WeakSet;var q=new WeakSet;var G=new WeakSet;var Q=new WeakSet;var J=new WeakSet;var K=new WeakSet;var z=new WeakSet;var $=new WeakSet;var Z=new WeakSet;var ee=new WeakSet;var te=new WeakSet;var ie=new WeakSet;var ne=new WeakSet;var ae=function(){function e(){var t,i=this;var n=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};babelHelpers.classCallCheck(this,e);O(this,ne);O(this,ie);O(this,te);O(this,ee);O(this,Z);O(this,$);O(this,z);O(this,K);O(this,J);O(this,Q);O(this,G);O(this,q);O(this,j);O(this,Y);D(this,W,{writable:true,value:void 0});D(this,X,{writable:true,value:void 0});this.inited=false;this.hardwareInited=false;this.dialogInited=false;this.initPromise=new BX.Promise;this.params=n;this.params.userId=this.params.userId?parseInt(this.params.userId):0;this.params.siteId=this.params.siteId||"";this.params.chatId=this.params.chatId?parseInt(this.params.chatId):0;this.params.dialogId=this.params.chatId?"chat"+this.params.chatId.toString():"0";this.params.passwordRequired=!!this.params.passwordRequired;this.params.isBroadcast=!!this.params.isBroadcast;BX.Messenger.Lib.Logger.setConfig(n.loggerConfig);this.messagesQueue=[];this.template=null;this.rootNode=this.params.node||document.createElement("div");this.event=new I.VueVendorV2;this.callContainer=null;this.preCall=null;this.currentCall=null;this.callToken=(t=this.params.callToken)!==null&&t!==void 0?t:null;this.videoStrategy=null;this.callDetails={};this.showFeedback=true;this.callScheme=null;this.promotedToAdminTimeoutValue=10*1e3;this.promotedToAdminTimeout=null;this.featureConfig={};(n.featureConfig||[]).forEach((function(e){i.featureConfig[e.id]=e}));this.localVideoStream=null;this.lastUsedCameraId=null;this.reconnectingCameraId=null;this.conferencePageTagInterval=null;this.onCallUserInvitedHandler=this.onCallUserInvited.bind(this);this.onCallUserJoinedHandler=this.onCallUserJoined.bind(this);this.onCallUserStateChangedHandler=this.onCallUserStateChanged.bind(this);this.onCallUserMicrophoneStateHandler=this.onCallUserMicrophoneState.bind(this);this.onCallUserCameraStateHandler=this.onCallUserCameraState.bind(this);this.onNeedResetMediaDevicesStateHandler=this.onNeedResetMediaDevicesState.bind(this);this.onCallUserVideoPausedHandler=this.onCallUserVideoPaused.bind(this);this.onCallLocalMediaReceivedHandler=BX.debounce(this.onCallLocalMediaReceived.bind(this),1e3);this.onCallLocalMediaStoppedHandler=this.onCallLocalMediaStopped.bind(this);this.onCallRemoteMediaReceivedHandler=this.onCallRemoteMediaReceived.bind(this);this.onCallRemoteMediaStoppedHandler=this.onCallRemoteMediaStopped.bind(this);this.onCallUserVoiceStartedHandler=this.onCallUserVoiceStarted.bind(this);this.onCallUserVoiceStoppedHandler=this.onCallUserVoiceStopped.bind(this);this.onUserStatsReceivedHandler=this.onUserStatsReceived.bind(this);this.onCallUserScreenStateHandler=this.onCallUserScreenState.bind(this);babelHelpers.classPrivateFieldSet(this,W,F(this,te,me).bind(this));babelHelpers.classPrivateFieldSet(this,X,F(this,ee,pe).bind(this));this.onCallUserFloorRequestHandler=this.onCallUserFloorRequest.bind(this);this.onMicrophoneLevelHandler=this.onMicrophoneLevel.bind(this);this._onCallJoinHandler=this.onCallJoin.bind(this);this.onCallFailureHandler=this.onCallFailure.bind(this);this.onCallLeaveHandler=this.onCallLeave.bind(this);this.onCallDestroyHandler=this.onCallDestroy.bind(this);this.onInputFocusHandler=this.onInputFocus.bind(this);this.onInputBlurHandler=this.onInputBlur.bind(this);this.onReconnectingHandler=this.onReconnecting.bind(this);this.onReconnectedHandler=this.onReconnected.bind(this);this.onReconnectingFailedHandler=this.onReconnectingFailed.bind(this);this.onUpdateLastUsedCameraIdHandler=this.onUpdateLastUsedCameraId.bind(this);this.onCallConnectionQualityChangedHandler=this.onCallConnectionQualityChanged.bind(this);this.onCallToggleRemoteParticipantVideoHandler=this.onCallToggleRemoteParticipantVideo.bind(this);this._onGetUserMediaEndedHandler=this.onGetUserMediaEnded.bind(this);this._onSwitchTrackRecordStatusHandler=this.onUpdateCallCopilotState.bind(this);this.onCameraPublishingHandler=this.onCameraPublishing.bind(this);this.onMicrophonePublishingdHandler=this.onMicrophonePublishingd.bind(this);this._onTurnOnCameraHandler=this._onTurnOnCamera.bind(this);this._onAllParticipantsAudioMutedHandler=this._onAllParticipantsAudioMuted.bind(this);this._onAllParticipantsVideoMutedHandler=this._onAllParticipantsVideoMuted.bind(this);this._onAllParticipantsScreenshareHandler=this._onAllParticipantsScreenshareMuted.bind(this);this._onYouMuteAllParticipantsHandler=this._onYouMuteAllParticipants.bind(this);this._onRoomSettingsChangedHandler=this._onRoomSettingsChanged.bind(this);this._onUserPermissionsChangedHandler=this._onUserPermissionsChanged.bind(this);this._onUserRoleChangedHandler=this._onUserRoleChanged.bind(this);this._onParticipantMutedHandler=this._onParticipantMuted.bind(this);this.onPreCallDestroyHandler=this.onPreCallDestroy.bind(this);this.onPreCallUserStateChangedHandler=this.onPreCallUserStateChanged.bind(this);this.waitingForCallStatus=false;this.waitingForCallStatusTimeout=null;this.callEventReceived=false;this.commonRecord=F(this,ie,ve).call(this);this.floatingScreenShareWindow=null;this.webScreenSharePopup=null;this.screenShareStartTime=null;this.mutePopup=null;this.riseYouHandToTalkPopup=null;this.allowMutePopup=true;this.loopTimers={};this.isFileChooserActive=false;this.pictureInPictureDebounceForOpen=null;this.isWindowFocus=true;if(c.DesktopApi.isDesktop()){r.ConferenceChannel.getInstance().setExecuter((function(e){var t=i.params.alias;var n=Boolean(i.callView);var a=t===e&&n;if(a){BXDesktopSystem.SetActiveTab()}return a}))}this.initDesktopEvents().then((function(){return i.initAdditionalEvents()})).then((function(){return i.initRestClient()})).then((function(){return i.subscribePreCallChanges()})).then((function(){return i.subscribeNotifierEvents()})).then((function(){return i.initPullClient()})).then((function(){return i.initCore()})).then((function(){return i.setModelData()})).then((function(){return i.initComponent()})).then((function(){return i.initCallInterface()})).then((function(){return i.initHardware()})).then((function(){return i.initUserComplete()}))["catch"]((function(e){console.error("Init error",e)}))}babelHelpers.createClass(e,[{key:"initDesktopEvents",value:function e(){var i=this;if(!c.DesktopApi.isDesktop()){return new Promise((function(e,t){return e()}))}this.floatingScreenShareWindow=new t.FloatingScreenShare({onBackToCallClick:this.onFloatingScreenShareBackToCallClick.bind(this),onStopSharingClick:this.onFloatingScreenShareStopClick.bind(this),onChangeScreenClick:this.onFloatingScreenShareChangeScreenClick.bind(this)});if(this.floatingScreenShareWindow){c.DesktopApi.subscribe("BXScreenMediaSharing",(function(e,t,n,a,r,o,l){i.floatingScreenShareWindow.setSharingData({title:t,x:n,y:a,width:r,height:o,app:l}).then((function(){i.floatingScreenShareWindow.show()}))["catch"]((function(e){f.Logger.error("setSharingData error",e)}))}))}c.DesktopApi.subscribe("bxImUpdateCounterMessage",(function(e){if(!i.controller){return false}i.controller.getStore().commit("conference/common",{messageCount:e})}));if(c.DesktopApi.isDesktop()){c.DesktopApi.subscribe("BXVpnStatusChange",(function(e){if(e){i.showVpnIsActiveNotification()}}))}A.EventEmitter.subscribe(v.EventType.textarea.focus,this.onInputFocusHandler);A.EventEmitter.subscribe(v.EventType.textarea.blur,this.onInputBlurHandler);A.EventEmitter.subscribe(v.EventType.conference.userRenameFocus,this.onInputFocusHandler);A.EventEmitter.subscribe(v.EventType.conference.userRenameBlur,this.onInputBlurHandler);return new Promise((function(e,t){return e()}))}},{key:"initAdditionalEvents",value:function e(){var t=this;window.addEventListener("focus",(function(){t.onWindowFocus()}));window.addEventListener("blur",(function(){t.onWindowBlur()}));document.body.addEventListener("click",(function(e){t.onDocumentBodyClick(e)}));return new Promise((function(e,t){return e()}))}},{key:"initRestClient",value:function e(){this.restClient=new B({endpoint:this.getHost()+"/rest"});this.restClient.setConfId(this.params.conferenceId);return new Promise((function(e,t){return e()}))}},{key:"subscribePreCallChanges",value:function e(){BX.addCustomEvent(window,"CallEvents::callCreated",this.onCallCreated.bind(this))}},{key:"subscribeNotifierEvents",value:function e(){var t=this;S.Notifier.subscribe("click",(function(e){var i=e.getData(),n=i.id;if(n.startsWith("im-videconf")){t.toggleChat()}}))}},{key:"initPullClient",value:function e(){if(!this.params.isIntranetOrExtranet){this.pullClient=new U.PullClient({serverEnabled:true,userId:this.params.userId,siteId:this.params.siteId,restClient:this.restClient,skipStorageInit:true,configTimestamp:0,skipCheckRevision:true,getPublicListMethod:"im.call.channel.public.list"});return new Promise((function(e,t){return e()}))}else{this.pullClient=BX.PULL;return this.pullClient.start().then((function(){return new Promise((function(e,t){return e()}))}))}}},{key:"initCore",value:function e(){var t=this;this.controller=new d.Controller({host:this.getHost(),siteId:this.params.siteId,userId:this.params.userId,languageId:this.params.language,pull:{client:this.pullClient},rest:{client:this.restClient},vuexBuilder:{database:!P.Utils.browser.isIe(),databaseName:"imol/call",databaseType:R.VuexBuilder.DatabaseType.localStorage,models:[u.ConferenceModel.create(),u.CallModel.create()]}});window.BX.Messenger.Application.Core={controller:this.controller};return new Promise((function(e,i){t.controller.ready().then((function(){return e()}))}))}},{key:"setModelData",value:function e(){var t=this;this.controller.getStore().commit("application/set",{dialog:{chatId:this.getChatId(),dialogId:this.getDialogId()},options:{darkBackground:true}});var i=this.params.presenters.map((function(e){return e["id"]}));this.controller.getStore().dispatch("conference/setBroadcastMode",{broadcastMode:this.params.isBroadcast});this.controller.getStore().dispatch("conference/setPresenters",{presenters:i});this.params.presenters.forEach((function(e){t.controller.getStore().dispatch("users/set",e)}));if(this.params.passwordRequired){this.controller.getStore().commit("conference/common",{passChecked:false})}if(this.params.conferenceTitle){this.controller.getStore().dispatch("conference/setConferenceTitle",{conferenceTitle:this.params.conferenceTitle})}if(this.params.alias){this.controller.getStore().commit("conference/setAlias",{alias:this.params.alias})}return new Promise((function(e,t){return e()}))}},{key:"initComponent",value:function e(){var t=this;if(this.getStartupErrorCode()){this.setError(this.getStartupErrorCode())}return new Promise((function(e,i){t.controller.createVue(t,{el:t.rootNode,data:function e(){return{dialogId:t.getDialogId()}},template:'<bx-im-component-conference-public :dialogId="dialogId"/>'}).then((function(i){t.template=i;e()}))["catch"]((function(e){return i(e)}))}))}},{key:"initCallInterface",value:function i(){var n=this;return new Promise((function(i,a){try{n.callContainer=document.getElementById("bx-im-component-call-container");var r=["camera","microphone","document"];if(n.isViewerMode()){r=["screen","record","floorRequest","document"]}if(!n.params.isIntranetOrExtranet){r.push("record")}if(!t.Util.isConferenceChatEnabled()){r.push("chat")}n.callView=new t.View({container:n.callContainer,showChatButtons:true,showUsersButton:true,showShareButton:n.getFeatureState("screenSharing")!==e.FeatureState.Disabled,showRecordButton:n.getFeatureState("record")!==e.FeatureState.Disabled,userLimit:t.Util.getUserLimit(),isIntranetOrExtranet:!!n.params.isIntranetOrExtranet,language:n.params.language,layout:P.Utils.device.isMobile()?t.View.Layout.Mobile:t.View.Layout.Centered,uiState:t.View.UiState.Preparing,blockedButtons:["camera","microphone","floorRequest","screen","copilot"],localUserState:t.UserState.Idle,hiddenTopButtons:!n.isBroadcast()||n.getBroadcastPresenters().length>1?[]:["grid"],hiddenButtons:r,broadcastingMode:n.isBroadcast(),broadcastingPresenters:n.getBroadcastPresenters(),isCopilotFeaturesEnabled:false,isCopilotActive:false,isWindowFocus:n.isWindowFocus,isVideoconf:true});n.callView.subscribe(t.View.Event.onButtonClick,n.onCallButtonClick.bind(n));n.callView.subscribe(t.View.Event.onReplaceCamera,n.onCallReplaceCamera.bind(n));n.callView.subscribe(t.View.Event.onReplaceMicrophone,n.onCallReplaceMicrophone.bind(n));n.callView.subscribe(t.View.Event.onReplaceSpeaker,n.onCallReplaceSpeaker.bind(n));n.callView.subscribe(t.View.Event.onHasMainStream,n.onCallViewHasMainStream.bind(n));n.callView.subscribe(t.View.Event.onChangeHdVideo,n.onCallViewChangeHdVideo.bind(n));n.callView.subscribe(t.View.Event.onChangeMicAutoParams,n.onCallViewChangeMicAutoParams.bind(n));n.callView.subscribe(t.View.Event.onChangeFaceImprove,n.onCallViewChangeFaceImprove.bind(n));n.callView.subscribe(t.View.Event.onUserRename,n.onCallViewUserRename.bind(n));n.callView.subscribe(t.View.Event.onUserPinned,n.onCallViewUserPinned.bind(n));n.callView.subscribe(t.View.Event.onToggleSubscribe,n.onCallToggleSubscribe.bind(n));n.callView.subscribe(t.View.Event.onCommonRecordMenu,F(n,$,Ce).bind(n));n.callView.setCallback(t.View.Event.onChangeVideoQuality,n._onChangeVideoQuality.bind(n));n.callView.setCallback(t.View.Event.onTurnOffParticipantMic,n._onCallViewTurnOffParticipantMic.bind(n));n.callView.setCallback(t.View.Event.onTurnOffParticipantCam,n._onCallViewTurnOffParticipantCam.bind(n));n.callView.setCallback(t.View.Event.onTurnOffParticipantScreenshare,n._onCallViewTurnOffParticipantScreenshare.bind(n));n.callView.setCallback(t.View.Event.onAllowSpeakPermission,n._onCallViewAllowSpeakPermission.bind(n));n.callView.setCallback(t.View.Event.onDisallowSpeakPermission,n._onCallViewDisallowSpeakPermission.bind(n));n.callView.blockAddUser();n.callView.blockHistoryButton();if(!P.Utils.device.isMobile()){n.callView.show()}i()}catch(e){f.Logger.error("creating call interface conference",e);var o="UNKNOWN_ERROR";if(b.Type.isString(e)){o=e}else if(b.Type.isPlainObject(e)&&e.code){o=e.code=="access_denied"?"ACCESS_DENIED":e.code}n.onCallFailure({code:o,message:e.message||""});a("call interface error")}}))}},{key:"initUserComplete",value:function e(){var t=this;return new Promise((function(e,i){t.initUser().then((function(){return t.tryJoinExistingCall()})).then((function(){return t.initCall()})).then((function(){return t.startPageTagInterval()})).then((function(){return t.initPullHandlers()})).then((function(){return t.subscribeToStoreChanges()})).then((function(){return t.initComplete()})).then((function(){return e}))["catch"]((function(e){return i(e)}))}))}},{key:"initUser",value:function e(){var i=this;return new Promise((function(e,a){if(i.getStartupErrorCode()||!i.getConference().common.passChecked){return a()}if(i.params.userId>0){i.controller.setUserId(i.params.userId);if(i.params.isIntranetOrExtranet){i.switchToSessAuth();i.controller.getStore().commit("conference/user",{id:i.params.userId})}else{var r=i.getUserHashCookie();if(r){n.CallTokenManager.setQueryParams({call_auth_id:r,videoconf_id:i.params.conferenceId});i.restClient.setAuthId(r);i.restClient.setChatId(i.getChatId());i.controller.getStore().commit("conference/user",{id:i.params.userId,hash:r});i.pullClient.start()}}i.controller.getStore().commit("conference/common",{inited:true});return e()}else{i.restClient.setAuthId("guest");i.restClient.setChatId(i.getChatId());if(typeof BX.SidePanel!=="undefined"){BX.SidePanel.Instance.disableAnchorBinding()}return i.restClient.callMethod("im.call.user.register",{alias:i.params.alias,user_hash:i.getUserHashCookie()||""}).then((function(a){BX.message.USER_ID=a.data().id;i.controller.getStore().commit("conference/user",{id:a.data().id,hash:a.data().hash});i.controller.setUserId(a.data().id);i.callView.setLocalUserId(a.data().id);t.Engine.setCurrentUserId(i.controller.getUserId());t.EngineLegacy.setCurrentUserId(i.controller.getUserId());n.CallTokenManager.setUserToken(a.data().userToken);if(a.data().created){i.params.userCount++}i.controller.getStore().commit("conference/common",{inited:true});n.CallTokenManager.setQueryParams({call_auth_id:a.data().hash,videoconf_id:i.params.conferenceId});i.restClient.setAuthId(a.data().hash);i.pullClient.start();return e()}))}}))}},{key:"startPageTagInterval",value:function e(){var t=this;return new Promise((function(e){clearInterval(t.conferencePageTagInterval);t.conferencePageTagInterval=setInterval((function(){C.LocalStorage.set(t.params.siteId,t.params.userId,t.callEngine.getConferencePageTag(t.params.dialogId),"Y",2)}),1e3);e()}))}},{key:"tryJoinExistingCall",value:function e(){var i=this;return new Promise((function(e,n){var r=a.CallSettingsManager.jwtCallsEnabled?"call.Call.tryJoinCall":"im.call.tryJoinCall";var o=a.CallSettingsManager.jwtCallsEnabled?"callType":"type";BX.ajax.runAction(r,{data:babelHelpers.defineProperty({entityType:"chat",entityId:i.params.dialogId,provider:t.Provider.Bitrix},o,t.Type.Permanent)}).then((function(n){var a=n.data;f.Logger.warn("tryJoinCall",a);if(a.success){i.waitingForCallStatus=true;i.callScheme=a.call.SCHEME;if(i.callScheme===t.CallScheme.jwt){i.callToken=a.callToken;t.Engine.instantiateCall(a.call,a.callToken,a.logToken,a.userData)}else{t.EngineLegacy.instantiateCall(a.call,a.users,a.logToken,a.connectionData,a.userData)}i.waitingForCallStatusTimeout=setTimeout((function(){i.waitingForCallStatus=false;if(!i.callEventReceived){i.setConferenceStatus(false)}i.callEventReceived=false}),5e3)}else{i.setConferenceStatus(false)}e()}))["catch"]((function(){i.setConferenceStatus(false);e()}))}))}},{key:"initCall",value:function e(){var i=this;return new Promise((function(e){if(i.callScheme){i.callEngine=i.callScheme===t.CallScheme.jwt?t.Engine:t.EngineLegacy}else{i.callEngine=a.CallSettingsManager.jwtCallsEnabled?t.Engine:t.EngineLegacy}t.Engine.setRestClient(i.restClient);t.Engine.setPullClient(i.pullClient);t.EngineLegacy.setRestClient(i.restClient);t.EngineLegacy.setPullClient(i.pullClient);i.callView.unblockButtons(["chat"]);e()}))}},{key:"initPullHandlers",value:function e(){this.pullClient.subscribe(new L.ImCallPullHandler({store:this.controller.getStore(),application:this,controller:this.controller}));return new Promise((function(e,t){return e()}))}},{key:"subscribeToStoreChanges",value:function e(){var i=this;this.controller.getStore().subscribe((function(e,n){var a=e.payload,r=e.type;if(r==="users/update"&&a.fields.name){if(!i.callView){return false}i.callView.updateUserData(babelHelpers.defineProperty({},a.id,{name:a.fields.name}))}else if(r==="dialogues/set"){if(a[0].dialogId!==i.getDialogId()){return false}if(!P.Utils.platform.isBitrixDesktop()){if(Number.isNaN(parseInt(a[0].counter,10))){t.Util.sendLog("[conf] setButtonCounter chat: payload[0].counter = ".concat(a[0].counter," (NaN)"))}i.callView.setButtonCounter("chat",a[0].counter)}}else if(r==="dialogues/update"){if(a.dialogId!==i.getDialogId()){return false}if(typeof a.fields.counter==="number"&&i.callView){if(P.Utils.platform.isBitrixDesktop()){if(a.actionName==="decreaseCounter"&&!a.dialogMuted&&typeof a.fields.previousCounter==="number"){var o=a.fields.counter;if(i.getConference().common.messageCount){o=i.getConference().common.messageCount-(a.fields.previousCounter-o);if(o<0){o=0}}if(Number.isNaN(parseInt(o,10))){t.Util.sendLog("[conf] setButtonCounter chat: counter = ".concat(o," (NaN)"))}i.callView.setButtonCounter("chat",o)}}else{if(Number.isNaN(parseInt(a.fields.counter,10))){t.Util.sendLog("[conf] setButtonCounter chat:  payload.fields.counter = ".concat(a.fields.counter," (NaN)"))}i.callView.setButtonCounter("chat",a.fields.counter)}}if(typeof a.fields.name!=="undefined"){document.title=a.fields.name.toString()}}else if(r==="conference/common"&&typeof a.messageCount==="number"){if(i.callView){if(Number.isNaN(parseInt(a.messageCount,10))){t.Util.sendLog("[conf] setButtonCounter chat: payload.messageCount = ".concat(a.messageCount," (NaN)"))}i.callView.setButtonCounter("chat",a.messageCount)}}}))}},{key:"initComplete",value:function e(){if(this.isExternalUser()){this.callView.localUser.userModel.allowRename=true}if(this.getConference().common.inited){this.inited=true;this.initPromise.resolve(this)}if(c.DesktopApi.isDesktop()){c.DesktopApi.emitToMainWindow("bxConferenceLoadComplete",[])}return new Promise((function(e,t){return e()}))}},{key:"initHardware",value:function e(){var i=this;return new Promise((function(e,n){t.Hardware.init().then((function(){if(i.hardwareInited){e();return true}if(Object.values(t.Hardware.microphoneList).length===0){i.setError(g.ConferenceErrorCode.missingMicrophone)}if(!i.isViewerMode()){i.checkAvailableCamera();i.checkAvailableMicrophone();i.callView.enableMediaSelection()}t.Hardware.subscribe(t.Hardware.Events.deviceChanged,i._onDeviceChange.bind(i));i.hardwareInited=true;e()}))["catch"]((function(e){if(e==="NO_WEBRTC"&&i.isHttps()){i.setError(g.ConferenceErrorCode.unsupportedBrowser)}else if(e==="NO_WEBRTC"&&!i.isHttps()){i.setError(g.ConferenceErrorCode.unsafeConnection)}f.Logger.error("Init hardware error",e);n(e)}))}))}},{key:"_onDeviceChange",value:function e(i){var n=this;if(!this.currentCall||!this.currentCall.ready){this.checkAvailableCamera();this.checkAvailableMicrophone();return}var a=i.data.added;var r=i.data.removed;var o=t.Hardware.getRemovedUsedDevices(i.data.removed,{microphoneId:this.currentCall.microphoneId,cameraId:this.currentCall.cameraId,speakerId:this.callView.speakerId});if(a){setTimeout((function(){return n.useDevicesInCurrentCall(a)}),500)}if(o.length>0){BX.UI.Notification.Center.notify({content:BX.message("IM_CALL_DEVICES_DETACHED")+"<br><ul>"+o.map((function(e){return"<li>"+e.label}))+"</ul>",position:"top-right",autoHideDelay:1e4,closeButton:true,actions:[{title:BX.message("IM_CALL_DEVICES_CLOSE"),events:{click:function e(t,i){i.close()}}}]})}if(r){setTimeout((function(){return n.removeDevicesFromCurrentCall(r)}),500)}}},{key:"setDefaultCameraIfNeeded",value:function e(){if(!t.Hardware.hasCamera()||!!t.Hardware.defaultCamera&&!!t.Hardware.cameraList.length&&t.Hardware.cameraList.some((function(e){return e.deviceId===t.Hardware.defaultCamera}))){return}if(!t.Hardware.defaultCamera&&!!t.Hardware.cameraList.length){t.Hardware.defaultCamera=t.Hardware.cameraList[0].deviceId;return}t.Hardware.defaultCamera=""}},{key:"setDefaultMicrophoneIfNeeded",value:function e(){if(!t.Hardware.hasMicrophone()||!!t.Hardware.defaultMicrophone&&!!t.Hardware.microphoneList.length&&t.Hardware.microphoneList.some((function(e){return e.deviceId===t.Hardware.defaultMicrophone}))){return}if(!t.Hardware.defaultMicrophone&&!!t.Hardware.microphoneList.length){t.Hardware.defaultMicrophone=t.Hardware.microphoneList[0].deviceId;return}t.Hardware.defaultMicrophone=""}},{key:"onBlockCameraButton",value:function e(){if(!this.callView){return}this.callView.blockSwitchCamera()}},{key:"onUnblockCameraButton",value:function e(){if(!this.callView){return}this.callView.unblockSwitchCamera()}},{key:"onBlockMicrophoneButton",value:function e(){if(!this.callView){return}this.callView.blockSwitchMicrophone()}},{key:"onUnblockMicrophoneButton",value:function e(){if(!this.callView){return}this.callView.unblockSwitchMicrophone()}},{key:"checkAvailableCamera",value:function e(){var i=this.callView.isButtonBlocked("camera");if(!this.currentCall&&!t.Hardware.hasCamera()){this.onBlockCameraButton()}else{this.onUnblockCameraButton()}this.setDefaultCameraIfNeeded();var n=t.Hardware.hasCamera()&&t.Hardware.defaultCamera;if(!this.currentCall&&i){this.template.$emit("setCameraState",n);this.template.$emit("cameraSelected",t.Hardware.defaultCamera)}this.callView.updateButtons()}},{key:"checkAvailableMicrophone",value:function e(){if(!this.currentCall&&!t.Hardware.hasMicrophone()){this.onBlockMicrophoneButton()}else{this.onUnblockMicrophoneButton()}this.setDefaultMicrophoneIfNeeded();var i=t.Hardware.hasMicrophone();if(!this.currentCall){this.template.$emit("setMicState",i);this.template.$emit("micSelected",t.Hardware.defaultCamera)}this.callView.updateButtons()}},{key:"useDevicesInCurrentCall",value:function e(i){var n=arguments.length>1&&arguments[1]!==undefined?arguments[1]:false;if(!this.currentCall||!this.currentCall.ready){return}for(var a=0;a<i.length;a++){var r=i[a];switch(r.kind){case"audioinput":if(r.deviceId==="default"||n){var o=t.Hardware.getDefaultDeviceIdByGroupId(r.groupId,"audioinput");this.currentCall.setMicrophoneId(o);this.callView.setMicrophoneId(o)}this.checkAvailableMicrophone();break;case"videoinput":if(r.deviceId==="default"||n){this.currentCall.setCameraId(r.deviceId)}if(this.reconnectingCameraId===r.deviceId&&!t.Hardware.isCameraOn){this.updateCameraSettingsInCurrentCallAfterReconnecting(r.deviceId)}this.checkAvailableCamera();break;case"audiooutput":if(this.callView&&r.deviceId==="default"||n){var l=t.Hardware.getDefaultDeviceIdByGroupId(r.groupId,"audiooutput");this.callView.setSpeakerId(l)}break}}}},{key:"removeDevicesFromCurrentCall",value:function e(i){if(!this.currentCall||!this.currentCall.ready){return}for(var n=0;n<i.length;n++){var a=i[n];switch(a.kind){case"audioinput":if(this.currentCall.microphoneId==a.deviceId){var r=Object.keys(t.Hardware.microphoneList);var o=void 0;if(r.includes("default")){var l=t.Hardware.getDeviceGroupIdByDeviceId("default","audioinput");o=t.Hardware.getDefaultDeviceIdByGroupId(l,"audioinput")}if(!o){o=r.length>0?r[0]:""}this.currentCall.setMicrophoneId(o);if(this.currentCall.provider===t.Provider.Bitrix){this.callView.setMicrophoneId(o)}}this.checkAvailableMicrophone();break;case"videoinput":if(this.currentCall.cameraId==a.deviceId){var s=Object.keys(t.Hardware.cameraList);this.currentCall.setCameraId(s.length>0?s[0]:"")}this.checkAvailableCamera();break;case"audiooutput":if(this.callView&&this.callView.speakerId==a.deviceId){var c=Object.keys(t.Hardware.audioOutputList);var u=void 0;if(c.includes("default")){var d=t.Hardware.getDeviceGroupIdByDeviceId("default","audiooutput");u=t.Hardware.getDefaultDeviceIdByGroupId(d,"audiooutput")}if(!u){this.callView.setSpeakerId(c.length>0?c[0]:"")}}break}}}},{key:"startCall",value:function e(r){var o=this;var l=arguments.length>1&&arguments[1]!==undefined?arguments[1]:false;if(this.initCallPromise){return}if(P.Utils.device.isMobile()){this.callView.show();if(Number.isNaN(parseInt(this.getDialogData().counter,10))){t.Util.sendLog("[conf] setButtonCounter chat: this.getDialogData().counter = ".concat(this.getDialogData().counter," (NaN)"))}this.callView.setButtonCounter("chat",this.getDialogData().counter)}else{this.callView.setLayout(t.View.Layout.Grid)}this.callView.setUiState(t.View.UiState.Calling);if(r&&!t.Hardware.hasCamera()){this.showNotification(BX.message("IM_CALL_NO_CAMERA_ERROR"));r=false}if(this.localVideoStream){if(!r){this.stopLocalVideoStream()}}this.controller.getStore().commit("conference/startCall");var s=Promise.resolve(this.callToken);if(a.CallSettingsManager.jwtCallsEnabled&&!this.callToken){s=n.CallTokenManager.getToken(this.params.chatId)}s.then((function(e){o.callToken=e;n.CallTokenManager.setToken(o.params.chatId,o.callToken);return o.callEngine.createCall(o.getCallConfig(r)).then((function(e){f.Logger.warn("call created",e);o.currentCall=e.call;o.currentCall.useHdVideo(true);if(o.promotedToAdminTimeout){clearTimeout(o.promotedToAdminTimeout)}if(!a.CallSettingsManager.jwtCallsEnabled){o.onUpdateCallCopilotState({isTrackRecordOn:o.currentCall.isCopilotActive})}if(t.Hardware.defaultMicrophone){o.currentCall.setMicrophoneId(t.Hardware.defaultMicrophone)}if(t.Hardware.defaultCamera){o.currentCall.setCameraId(t.Hardware.defaultCamera)}o.checkAvailableMicrophone();o.checkAvailableCamera();if(!P.Utils.device.isMobile()){o.callView.setLayout(t.View.Layout.Grid)}if(a.CallSettingsManager.jwtCallsEnabled){var n=o.controller.getStore().getters["users/get"](o.controller.getUserId(),true);o.callView.appendUsers([n.id]);o.callView.updateUserData(babelHelpers.defineProperty({},n.id,n))}else{o.callView.appendUsers(o.currentCall.getUsers());t.Util.getUsers(o.currentCall.id,o.getCallUsers(true)).then((function(e){o.controller.getStore().dispatch("users/set",Object.values(e));o.controller.getStore().dispatch("conference/setUsers",{users:Object.keys(e)});o.callView.updateUserData(e)}))}o.releasePreCall();o.bindCallEvents();o.updateCallUser(o.currentCall.userId,{microphoneState:!t.Hardware.isMicrophoneMuted});if(e.isNew){var s,c;i.Analytics.getInstance().onStartVideoconf({callId:(s=o.currentCall)===null||s===void 0?void 0:s.uuid,withVideo:r,mediaParams:{video:t.Hardware.isCameraOn,audio:!t.Hardware.isMicrophoneMuted},status:i.Analytics.AnalyticsStatus.success,isCopilotActive:o.currentCall.isCopilotActive,isVpnActive:F(o,J,ue).call(o),userCounter:(c=o.currentCall.associatedEntity)===null||c===void 0?void 0:c.userCounter});o.currentCall.inviteUsers()}else{var u;o.currentCall.answer({joinAsViewer:l});i.Analytics.getInstance().onJoinVideoconf({callId:(u=o.currentCall)===null||u===void 0?void 0:u.uuid,withVideo:r,mediaParams:{video:t.Hardware.isCameraOn,audio:!t.Hardware.isMicrophoneMuted},status:i.Analytics.AnalyticsStatus.success,isVpnActive:F(o,J,ue).call(o)})}o.checkVpnStatus();o.onUpdateLastUsedCameraId()}))}))["catch"]((function(e){f.Logger.error("creating call error",e);var n="UNKNOWN_ERROR";if(b.Type.isString(e)){n=e}else if(b.Type.isObject(e)&&e instanceof t.JoinResponseError){n=e.name}else if(b.Type.isPlainObject(e)&&e.code){n=e.code=="access_denied"?"ACCESS_DENIED":e.code}i.Analytics.getInstance().onStartCallError({callType:i.Analytics.AnalyticsType.videoconf,errorCode:n,errorMessage:e===null||e===void 0?void 0:e.message});o.initCallPromise=null}))}},{key:"joinCall",value:function e(r,o,l){var s=this;if(this.initCallPromise){return}var c=BX.prop.getBoolean(l,"video",false);var u=BX.prop.getBoolean(l,"joinAsViewer",false);t.Hardware.isCameraOn=!!c;if(P.Utils.device.isMobile()){this.callView.show()}else{this.callView.setLayout(t.View.Layout.Grid)}if(u){this.callView.setLocalUserDirection(t.EndpointDirection.RecvOnly)}else{this.callView.setLocalUserDirection(t.EndpointDirection.SendRecv)}this.callView.setUiState(t.View.UiState.Calling);var d=Boolean(r)||this.callScheme===t.CallScheme.classic||!this.callScheme&&!a.CallSettingsManager.jwtCallsEnabled;this.initCallPromise=Promise.resolve(this.callToken);if(!d&&!this.callToken){this.initCallPromise=n.CallTokenManager.getToken(this.params.chatId)}this.initCallPromise.then((function(e){if(d){return t.EngineLegacy.getCallWithId(r,s.getCallConfig(c))}s.callToken=e;n.CallTokenManager.setToken(s.params.chatId,s.callToken);return t.Engine.getCallWithId(o,s.getCallConfig(c,o))})).then((function(e){var n,r,o;s.currentCall=e.call;s.releasePreCall();s.bindCallEvents();if(s.promotedToAdminTimeout){clearTimeout(s.promotedToAdminTimeout)}if(((n=s.currentCall)===null||n===void 0?void 0:n.scheme)===t.CallScheme.classic||!a.CallSettingsManager.jwtCallsEnabled){s.onUpdateCallCopilotState({isTrackRecordOn:s.currentCall.isCopilotActive})}s.controller.getStore().commit("conference/startCall");if(((r=s.currentCall)===null||r===void 0?void 0:r.scheme)===t.CallScheme.jwt){var l=s.controller.getStore().getters["users/get"](s.controller.getUserId(),true);s.callView.appendUsers([l.id]);s.callView.updateUserData(babelHelpers.defineProperty({},l.id,l))}else{s.callView.appendUsers(s.currentCall.getUsers());t.Util.getUsers(s.currentCall.id,s.getCallUsers(true)).then((function(e){s.controller.getStore().dispatch("users/set",Object.values(e));s.controller.getStore().dispatch("conference/setUsers",{users:Object.keys(e)});s.callView.updateUserData(e)}))}if(!u){s.currentCall.useHdVideo(true);if(t.Hardware.defaultMicrophone){s.currentCall.setMicrophoneId(t.Hardware.defaultMicrophone)}if(t.Hardware.defaultCamera){s.currentCall.setCameraId(t.Hardware.defaultCamera)}s.checkAvailableMicrophone();s.checkAvailableCamera();s.updateCallUser(s.currentCall.userId,{microphoneState:!t.Hardware.isMicrophoneMuted})}s.currentCall.answer({joinAsViewer:u});i.Analytics.getInstance().onJoinVideoconf({callId:(o=s.currentCall)===null||o===void 0?void 0:o.uuid,withVideo:t.Hardware.isCameraOn,mediaParams:{video:t.Hardware.isCameraOn,audio:!t.Hardware.isMicrophoneMuted},status:i.Analytics.AnalyticsStatus.success,isVpnActive:F(s,J,ue).call(s)});s.checkVpnStatus();s.onUpdateLastUsedCameraId()}))["catch"]((function(e){console.error(e);var n="UNKNOWN_ERROR";if(b.Type.isString(e)){n=e}else if(b.Type.isObject(e)&&e instanceof t.JoinResponseError){n=e.name}else if(b.Type.isPlainObject(e)&&e.code){n=e.code==="access_denied"?"ACCESS_DENIED":e.code}i.Analytics.getInstance().onJoinCallError({callType:i.Analytics.AnalyticsType.videoconf,errorCode:n,callId:o,errorMessage:e===null||e===void 0?void 0:e.message,isVpnActive:F(s,J,ue).call(s)});s.initCallPromise=null}))}},{key:"endCall",value:function e(){var n;var a=arguments.length>0&&arguments[0]!==undefined?arguments[0]:false;if(F(this,G,se).call(this)){i.Analytics.getInstance().onRecordStop({callId:this.currentCall.uuid,callType:i.Analytics.AnalyticsType.videoconf,subSection:a?i.Analytics.AnalyticsSubSection.contextMenu:i.Analytics.AnalyticsSubSection.window,element:a?i.Analytics.AnalyticsElement.finishForAllButton:i.Analytics.AnalyticsElement.disconnectButton,recordTime:t.Util.getRecordTimeText(this.commonRecord.info)})}F(this,z,he).call(this);this.setConferenceHasErrorInCall(false);this.showFeedback=!!((n=this.currentCall)!==null&&n!==void 0&&n.wasConnected);if(this.currentCall){this.callDetails={id:this.currentCall.uuid,provider:this.currentCall.provider,userCount:this.currentCall.users.length,browser:t.Util.getBrowserForStatistics(),isMobile:BX.browser.IsMobile(),isConference:true};this.removeCallEvents();this.removeAdditionalEvents();this.currentCall.hangup(false,"",a)}if(P.Utils.platform.isBitrixDesktop()){if(this.floatingScreenShareWindow){this.floatingScreenShareWindow.destroy();this.floatingScreenShareWindow=null}window.close();location.href="/"}else{this.callView.releaseLocalMedia();this.callView.close();this.closeReconnectionBaloon();this.setError(g.ConferenceErrorCode.userLeftCall);this.controller.getStore().commit("conference/endCall")}if(this.riseYouHandToTalkPopup){this.riseYouHandToTalkPopup.close();this.riseYouHandToTalkPopup=null}A.EventEmitter.unsubscribe(v.EventType.textarea.focus,this.onInputFocusHandler);A.EventEmitter.unsubscribe(v.EventType.textarea.blur,this.onInputBlurHandler);A.EventEmitter.unsubscribe(v.EventType.conference.userRenameFocus,this.onInputFocusHandler);A.EventEmitter.unsubscribe(v.EventType.conference.userRenameBlur,this.onInputBlurHandler)}},{key:"restart",value:function e(){console.trace(" restart");if(this.currentCall){this.removeCallEvents();this.currentCall=null}if(this.promotedToAdminTimeout){clearTimeout(this.promotedToAdminTimeout)}if(this.callView){this.callView.releaseLocalMedia();this.callView.close();this.closeReconnectionBaloon();this.callView.destroy();this.callView=null}this.initCallInterface();this.initCall();this.controller.getStore().commit("conference/endCall")}},{key:"kickFromCall",value:function e(){this.setError(g.ConferenceErrorCode.kickedFromCall);this.pullClient.disconnect();this.endCall()}},{key:"getCallUsers",value:function e(t){if(!this.currentCall){return[]}var i=Object.keys(this.currentCall.getUsers());if(t){i.push(this.currentCall.userId)}return i}},{key:"getActiveCallUsers",value:function e(){var i=this.currentCall.getUsers();var n=[];for(var a in i){if(i.hasOwnProperty(a)){if(i[a]===t.UserState.Connected||i[a]===t.UserState.Connecting||i[a]===t.UserState.Calling){n.push(a)}}}return n}},{key:"setLocalVideoStream",value:function e(t){this.localVideoStream=t}},{key:"updateMediaDevices",value:function e(){t.Hardware.getCurrentDeviceList();console.log("updateMediaDevices")}},{key:"stopLocalVideoStream",value:function e(){if(this.localVideoStream){this.localVideoStream.getTracks().forEach((function(e){return e.stop()}))}this.localVideoStream=null}},{key:"setSelectedCamera",value:function e(t){if(this.callView){this.callView.setCameraId(t)}}},{key:"setSelectedMic",value:function e(t){if(this.callView){this.callView.setMicrophoneId(t)}}},{key:"getFeature",value:function t(i){if(typeof this.featureConfig[i]==="undefined"){return{id:i,state:e.FeatureState.Enabled,articleCode:""}}return this.featureConfig[i]}},{key:"getFeatureState",value:function e(t){return this.getFeature(t).state}},{key:"showFeatureLimitSlider",value:function e(t){var i=this.getFeature(t).articleCode;if(!i||!window.BX.UI.InfoHelper){console.warn("Limit article not found",t);return false}window.BX.UI.InfoHelper.show(i);return true}},{key:"showNotification",value:function e(t,i){if(!i){i=[]}BX.UI.Notification.Center.notify({content:b.Text.encode(t),position:"top-right",autoHideDelay:5e3,closeButton:true,actions:i})}},{key:"checkVpnStatus",value:function e(){if(F(this,J,ue).call(this)){this.showVpnIsActiveNotification()}}},{key:"showVpnIsActiveNotification",value:function e(){if(this.callView){BX.UI.Notification.Center.notify({content:b.Text.encode(b.Loc.getMessage("CALL_MESSAGE_VPN_IS_ACTIVE")),position:"top-right",autoHideDelay:1e4,closeButton:true,category:"vpnIsActive"})}}},{key:"showMicMutedNotification",value:function e(){var i=this;if(this.mutePopup||!this.callView||this.riseYouHandToTalkPopup||!t.Util.havePermissionToBroadcast("mic")){return}this.mutePopup=new t.Hint({bindElement:this.callView.buttons.microphone.elements.icon,targetContainer:this.callView.container,buttons:[this.createUnmuteButton()],onClose:function e(){i.allowMutePopup=false;i.mutePopup.destroy();i.mutePopup=null}});this.mutePopup.show()}},{key:"createUnmuteButton",value:function e(){var t=this;return new BX.UI.Button({baseClass:"ui-btn bx-call-view-popup-call-hint-unmute",text:BX.message("IM_CALL_UNMUTE_MIC"),size:BX.UI.Button.Size.EXTRA_SMALL,color:BX.UI.Button.Color.LIGHT_BORDER,noCaps:true,round:true,events:{click:function e(){t.onCallViewToggleMuteButtonClick({data:{muted:false}});t.mutePopup.destroy();t.mutePopup=null}}})}},{key:"showWebScreenSharePopup",value:function e(){if(this.webScreenSharePopup){this.webScreenSharePopup.show();return}this.webScreenSharePopup=new t.WebScreenSharePopup({bindElement:this.callView.buttons.screen.elements.root,targetContainer:this.callView.container,onClose:function(){this.webScreenSharePopup.destroy();this.webScreenSharePopup=null}.bind(this),onStopSharingClick:function(){this.onCallViewToggleScreenSharingButtonClick();this.webScreenSharePopup.destroy();this.webScreenSharePopup=null}.bind(this)});this.webScreenSharePopup.show()}},{key:"isViewerMode",value:function e(){var t=false;var i=this.isBroadcast();if(i){var n=this.getBroadcastPresenters();var a=this.controller.getStore().state.application.common.userId;var r=n.includes(a);t=i&&!r}return t}},{key:"onCallCreated",value:function e(i){var n=this;f.Logger.warn("we got event onCallCreated",i);if(this.preCall||this.currentCall){return}var a=i.call;if(a.associatedEntity.type==="chat"&&a.associatedEntity.id===this.params.dialogId){this.preCall=i.call;this.updatePreCallCounter();this.preCall.addEventListener(t.Event.onUserStateChanged,this.onPreCallUserStateChangedHandler);this.preCall.addEventListener(t.Event.onDestroy,this.onPreCallDestroyHandler);if(this.waitingForCallStatus){this.callEventReceived=true}this.setConferenceStatus(true);this.setConferenceStartDate(i.call.startDate)}var r=this.getConference().common.userReadyToJoin;if(r){var o=this.isViewerMode();var l=this.getConference().common.joinWithVideo;f.Logger.warn("ready to join call after waiting",l,o);setTimeout((function(){t.Hardware.init().then((function(){if(o&&n.preCall){n.joinCall(n.preCall.id,n.preCall.uuid,{joinAsViewer:true})}else{n.joinCall(n.preCall.id,n.preCall.uuid,{video:l})}}))}),1e3)}}},{key:"releasePreCall",value:function e(){if(this.preCall){this.preCall.removeEventListener(t.Event.onUserStateChanged,this.onPreCallUserStateChangedHandler);this.preCall.removeEventListener(t.Event.onDestroy,this.onPreCallDestroyHandler);this.preCall=null}}},{key:"onPreCallDestroy",value:function e(t){if(this.waitingForCallStatusTimeout){clearTimeout(this.waitingForCallStatusTimeout)}this.setConferenceStatus(false);this.releasePreCall()}},{key:"onPreCallUserStateChanged",value:function e(t){this.updatePreCallCounter()}},{key:"updatePreCallCounter",value:function e(){if(this.preCall){this.controller.getStore().commit("conference/common",{userInCallCount:this.preCall.getParticipatingUsers().length})}else{this.controller.getStore().commit("conference/common",{userInCallCount:0})}}},{key:"createVideoStrategy",value:function e(){if(this.videoStrategy){this.videoStrategy.destroy()}var t=P.Utils.device.isMobile()?VideoStrategy.Type.OnlySpeaker:VideoStrategy.Type.AllowAll;this.videoStrategy=new VideoStrategy({call:this.currentCall,callView:this.callView,strategyType:t})}},{key:"removeVideoStrategy",value:function e(){if(this.videoStrategy){this.videoStrategy.destroy()}this.videoStrategy=null}},{key:"onCallReplaceCamera",value:function e(i){var n=i.data.deviceId;if(this.reconnectingCameraId){this.setReconnectingCameraId(null)}t.Hardware.defaultCamera=n;if(this.currentCall){this.currentCall.setCameraId(n)}else{this.template.$emit("cameraSelected",n)}}},{key:"onCallReplaceMicrophone",value:function e(i){var n=i.data.deviceId;t.Hardware.defaultMicrophone=n.deviceId;if(this.callView){this.callView.setMicrophoneId(n)}if(this.currentCall){this.currentCall.setMicrophoneId(n)}else{this.template.$emit("micSelected",i.data.deviceId)}}},{key:"onCallReplaceSpeaker",value:function e(i){t.Hardware.defaultSpeaker=i.data.deviceId}},{key:"onCallViewHasMainStream",value:function e(i){if(this.currentCall&&this.currentCall.provider===t.Provider.Bitrix){this.currentCall.setMainStream(i.data)}}},{key:"_onCallViewTurnOffParticipantMic",value:function e(t){this.currentCall.turnOffParticipantStream({typeOfStream:"mic",userId:t.userId,fromUserId:this.callEngine.getCurrentUserId()});i.Analytics.getInstance().onTurnOffParticipantStream({callId:this._getCallIdentifier(this.currentCall),callType:this.getCallType(),typeOfSetting:"mic"})}},{key:"_onCallViewTurnOffParticipantCam",value:function e(t){this.currentCall.turnOffParticipantStream({typeOfStream:"cam",userId:t.userId,fromUserId:this.callEngine.getCurrentUserId()});i.Analytics.getInstance().onTurnOffParticipantStream({callId:this._getCallIdentifier(this.currentCall),callType:this.getCallType(),typeOfSetting:"cam"})}},{key:"_onCallViewTurnOffParticipantScreenshare",value:function e(t){this.currentCall.turnOffParticipantStream({typeOfStream:"screenshare",userId:t.userId,fromUserId:this.callEngine.getCurrentUserId()});i.Analytics.getInstance().onTurnOffParticipantStream({callId:this._getCallIdentifier(this.currentCall),callType:this.getCallType(),typeOfSetting:"screenshare"})}},{key:"_onCallViewAllowSpeakPermission",value:function e(t){this.currentCall.allowSpeakPermission({allow:true,userId:t.userId});i.Analytics.getInstance().onAllowPermissionToSpeakResponse({callId:this._getCallIdentifier(this.currentCall),callType:this.getCallType()})}},{key:"_onCallViewDisallowSpeakPermission",value:function e(t){this.currentCall.allowSpeakPermission({allow:false,userId:t.userId});i.Analytics.getInstance().onDisallowPermissionToSpeakResponse({callId:this._getCallIdentifier(this.currentCall),callType:this.getCallType()})}},{key:"onCallViewChangeHdVideo",value:function e(i){t.Hardware.preferHdQuality=i.data.allowHdVideo}},{key:"onCallViewChangeMicAutoParams",value:function e(i){t.Hardware.enableMicAutoParameters=i.data.allowMicAutoParams}},{key:"_onChangeVideoQuality",value:function e(i){if(this.currentCall&&this.currentCall.provider===t.Provider.Bitrix){var n={isCameraWasEnabledBeforeQualityChanged:i.isCameraWasEnabledBeforeQualityChanged,videoQuality:i.videoQuality,otherUsers:this.currentCall.users};this.currentCall.setVideoQualityForStreams(n)}}},{key:"onCallViewChangeFaceImprove",value:function e(t){if(!c.DesktopApi.isDesktop()){return}c.DesktopApi.setCameraSmoothingStatus(t.data.faceImproveEnabled)}},{key:"onCallViewUserRename",value:function e(t){var i=t.data.newName;if(!this.isExternalUser()){return false}if(P.Utils.device.isMobile()){this.renameGuestMobile(i)}else{this.renameGuest(i)}}},{key:"onCallViewUserPinned",value:function e(t){if(t.data.userId){this.updateCallUser(t.data.userId,{pinned:true});return true}this.controller.getStore().dispatch("call/unpinUser");return true}},{key:"onCallToggleSubscribe",value:function e(i){if(this.currentCall&&this.currentCall.provider===t.Provider.Bitrix&&i.data){this.currentCall.toggleRemoteParticipantVideo(i.data.participants,i.data.showVideo,true)}}},{key:"renameGuest",value:function(){var e=babelHelpers.asyncToGenerator(H().mark((function e(t){var i,a,r,o;return H().wrap((function e(l){while(1)switch(l.prev=l.next){case 0:this.callView.localUser.userModel.renameRequested=true;l.prev=1;l.next=4;return this.setUserName(t);case 4:r=l.sent;o=r===null||r===void 0?void 0:(i=r.answer)===null||i===void 0?void 0:i.result;if(b.Type.isString(o===null||o===void 0?void 0:o.userToken)&&o.userToken.length>0){n.CallTokenManager.setUserToken(o.userToken)}(a=this.currentCall)===null||a===void 0?void 0:a.updateUserData({name:t});this.callView.localUser.userModel.wasRenamed=true;f.Logger.log("setting name to",t);l.next=15;break;case 12:l.prev=12;l.t0=l["catch"](1);f.Logger.error("error setting name",l.t0);case 15:case"end":return l.stop()}}),e,this,[[1,12]])})));function t(t){return e.apply(this,arguments)}return t}()},{key:"renameGuestMobile",value:function e(t){var i=this;this.setUserName(t).then((function(){f.Logger.log("setting mobile name to",t);if(i.callView.renameSlider){i.callView.renameSlider.close()}}))["catch"]((function(e){f.Logger.error("error setting name",e)}))}},{key:"onCallButtonClick",value:function e(t){var i=t.data.buttonName;f.Logger.warn("Button clicked!",i);var n={hangup:this.onCallViewHangupButtonClick.bind(this),hangupOptions:this._onCallViewHangupOptionsButtonClick.bind(this),close:this.onCallViewCloseButtonClick.bind(this),toggleMute:this.onCallViewToggleMuteButtonClick.bind(this),toggleScreenSharing:this.onCallViewToggleScreenSharingButtonClick.bind(this),record:F(this,Z,fe).bind(this),toggleVideo:this.onCallViewToggleVideoButtonClick.bind(this),toggleSpeaker:this.onCallViewToggleSpeakerButtonClick.bind(this),showChat:this.onCallViewShowChatButtonClick.bind(this),toggleUsers:this.onCallViewToggleUsersButtonClick.bind(this),share:this.onCallViewShareButtonClick.bind(this),fullscreen:this.onCallViewFullScreenButtonClick.bind(this),floorRequest:this.onCallViewFloorRequestButtonClick.bind(this),feedback:this.onCallViewFeedbackButtonClick.bind(this),callcontrol:this._onCallcontrolButtonClick.bind(this),onUserClick:this.onCallUserClick.bind(this),copilot:this.onCallCopilotButtonClick.bind(this)};if(n[i]){n[i](t)}else{f.Logger.error("Button handler not found!",i)}}},{key:"onCallViewHangupButtonClick",value:function e(n){var a;i.Analytics.getInstance().onDisconnectCall({callId:(a=this.currentCall)===null||a===void 0?void 0:a.uuid,callType:i.Analytics.AnalyticsType.videoconf,subSection:i.Analytics.AnalyticsSubSection.finishButton,mediaParams:{video:t.Hardware.isCameraOn,audio:!t.Hardware.isMicrophoneMuted}});this.stopLocalVideoStream();this.endCall()}},{key:"_onCallViewHangupOptionsButtonClick",value:function e(){var n=this;if(this.hangupOptionsMenu){this.hangupOptionsMenu.destroy();return}var a=this.callView.buttons.hangupOptions.elements.root.offsetWidth;var r=[{text:BX.message("CALL_M_BTN_HANGUP_OPTION_FINISH"),onclick:function e(){var a,r,o,l;i.Analytics.getInstance().onFinishCall({callId:(a=n.currentCall)===null||a===void 0?void 0:a.uuid,callType:i.Analytics.AnalyticsType.videoconf,status:i.Analytics.AnalyticsStatus.finishedForAll,chatId:(r=n.currentCall)===null||r===void 0?void 0:r.associatedEntity.id,callUsersCount:n.getCallUsers(true).length,callLength:t.Util.getTimeText((o=n.currentCall)===null||o===void 0?void 0:o.startDate)});(l=n.hangupOptionsMenu)===null||l===void 0?void 0:l.destroy();n.stopLocalVideoStream();n.endCall(true)}},{text:BX.message("CALL_M_BTN_HANGUP_OPTION_LEAVE"),onclick:function e(){var a,r;i.Analytics.getInstance().onDisconnectCall({callId:(a=n.currentCall)===null||a===void 0?void 0:a.uuid,callType:i.Analytics.AnalyticsType.videoconf,subSection:i.Analytics.AnalyticsSubSection.contextMenu,mediaParams:{video:t.Hardware.isCameraOn,audio:!t.Hardware.isMicrophoneMuted}});(r=n.hangupOptionsMenu)===null||r===void 0?void 0:r.destroy();n.stopLocalVideoStream();n.endCall(false)}}];this.hangupOptionsMenu=new BX.PopupMenuWindow({className:"bx-messenger-videocall-hangup-options-container",background:"#00428F",contentBackground:"#00428F",darkMode:true,contentBorderRadius:"6px",borderRadius:"6px",angle:false,bindElement:this.callView.buttons.hangupOptions.elements.root,targetContainer:this.container,offsetTop:-15,bindOptions:{position:"top"},cacheable:false,subMenuOptions:{maxWidth:450},events:{onShow:function e(t){var i=t.getTarget();i.getPopupContainer().style.display="block";var n=a/2-i.getPopupContainer().offsetWidth/2;i.setOffset({offsetLeft:n+40,offsetTop:0});i.setAngle({offset:i.getPopupContainer().offsetWidth/2-17})},onDestroy:function e(){return n.hangupOptionsMenu=null}},items:r});this.hangupOptionsMenu.show()}},{key:"onCallViewCloseButtonClick",value:function e(t){this.stopLocalVideoStream();this.endCall()}},{key:"onCallViewToggleMuteButtonClick",value:function e(t){i.Analytics.getInstance().onToggleMicrophone({muted:t.data.muted,callId:this.currentCall?this.currentCall.uuid:0,callType:i.Analytics.AnalyticsType.videoconf});this._onCallViewToggleMuteHandler(t.data)}},{key:"_onCallViewToggleMuteHandler",value:function e(i){var n;if(!i.muted&&!(t.Hardware!==null&&t.Hardware!==void 0&&t.Hardware.hasMicrophone())){return}var a=this.currentCall&&this.currentCall.currentRoom&&this.currentCall.currentRoom();if(a&&a.speaker!=this.userId&&!i.muted){this.currentCall.requestRoomSpeaker();return}if(this.currentCall&&!this.currentCall.microphoneId&&!i.muted){this.currentCall.setMicrophoneId(t.Hardware.defaultMicrophone)}t.Hardware.setIsMicrophoneMuted({isMicrophoneMuted:i.muted,calledProgrammatically:!!i.calledProgrammatically});if(this.floatingWindow){this.floatingWindow.setAudioMuted(i.muted)}if(this.mutePopup){this.mutePopup.close()}if(!i.muted){if(!t.Util.havePermissionToBroadcast("mic")){this.showRiseYouHandToTalkNotification({initiatorName:this.lastCalledChangeSettingsUserName})}else{this.allowMutePopup=true}}if(F(this,Q,ce).call(this)&&F(this,Y,re).call(this)){BXDesktopSystem.CallRecordMute(i.muted)}if((n=this.currentCall)!==null&&n!==void 0&&n.userId){this.updateCallUser(this.currentCall.userId,{microphoneState:!i.muted})}if(!this.currentCall){this.template.$emit("setMicState",!i.muted)}}},{key:"onCallViewToggleScreenSharingButtonClick",value:function t(){i.Analytics.getInstance().onScreenShareBtnClick({callId:this.currentCall.uuid,callType:i.Analytics.AnalyticsType.videoconf});if(this.getFeatureState("screenSharing")===e.FeatureState.Limited){this.showFeatureLimitSlider("screenSharing");return}if(this.getFeatureState("screenSharing")===e.FeatureState.Disabled){return}if(this.currentCall.isScreenSharingStarted()){this.currentCall.stopScreenSharing();if(F(this,Q,ce).call(this)&&F(this,Y,re).call(this)){BXDesktopSystem.CallRecordStopSharing()}if(this.floatingScreenShareWindow){this.floatingScreenShareWindow.close()}if(this.webScreenSharePopup){this.webScreenSharePopup.close()}}else{BX.ajax.runAction("call.Call.onShareScreen",{data:{callUuid:this.currentCall.uuid}});this.currentCall.startScreenSharing();this.togglePictureInPictureCallWindow()}}},{key:"togglePictureInPictureCallWindow",value:function e(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};var i=this.currentCall&&(this.currentCall.isScreenSharingStarted()||t.isForceOpen)&&!t.isForceClose;if(!this.callView){return}this.callView.isActivePiPFromController=i;this.callView.toggleStatePictureInPictureCallWindow(i)}},{key:"_onCallViewToggleVideoButtonClickHandler",value:function e(i){if(!t.Hardware.initialized){return}if(i.video&&Object.values(t.Hardware.cameraList).length===0){this.showNotification(b.Loc.getMessage("IM_CALL_CAMERA_ERROR_FALLBACK_TO_MIC"));return}t.Hardware.setIsCameraOn({isCameraOn:i.video,calledProgrammatically:Boolean(i.calledProgrammatically)});if(this.currentCall&&!i.video&&!this.currentCall.isScreenSharingStarted()){this.callView.releaseLocalMedia()}if(this.currentCall&&!this.currentCall.cameraId&&i.video){this.currentCall.setCameraId(t.Hardware.defaultCamera)}if(!this.currentCall){this.template.$emit("setCameraState",i.video)}}},{key:"onCallViewToggleVideoButtonClick",value:function e(t){i.Analytics.getInstance().onToggleCamera({video:t.data.video,callId:this.currentCall?this.currentCall.uuid:0,callType:i.Analytics.AnalyticsType.videoconf});this._onCallViewToggleVideoButtonClickHandler(t.data)}},{key:"onCallViewToggleSpeakerButtonClick",value:function e(t){this.callView.muteSpeaker(!t.data.speakerMuted);if(t.data.fromHotKey){BX.UI.Notification.Center.notify({content:BX.message(this.callView.speakerMuted?"IM_M_CALL_MUTE_SPEAKERS_OFF":"IM_M_CALL_MUTE_SPEAKERS_ON"),position:"top-right",autoHideDelay:3e3,closeButton:true})}}},{key:"onCallViewShareButtonClick",value:function e(){var t=400;if(P.Utils.device.isMobile()&&document.body.clientWidth<400){t=document.body.clientWidth-40}BX.UI.Notification.Center.notify({content:b.Loc.getMessage("BX_IM_VIDEOCONF_LINK_COPY_DONE"),autoHideDelay:4e3,width:t});p.Clipboard.copy(this.getDialogData()["public"].link)}},{key:"onCallViewFullScreenButtonClick",value:function e(){this.toggleFullScreen()}},{key:"onFloatingScreenShareBackToCallClick",value:function e(){c.DesktopApi.activateWindow();c.DesktopApi.changeTab("im");if(this.floatingScreenShareWindow){this.floatingScreenShareWindow.hide()}}},{key:"onFloatingScreenShareStopClick",value:function e(){c.DesktopApi.activateWindow();c.DesktopApi.changeTab("im");this.onCallViewToggleScreenSharingButtonClick()}},{key:"onFloatingScreenShareChangeScreenClick",value:function e(){if(this.currentCall){this.currentCall.startScreenSharing(true)}}},{key:"updateWindowFocusState",value:function e(t){if(t===this.isWindowFocus){return}this.isWindowFocus=t;if(this.callView){this.callView.setWindowFocusState(this.isWindowFocus)}}},{key:"clearPictureInPictureDebounceForOpen",value:function e(){if(this.pictureInPictureDebounceForOpen){clearTimeout(this.pictureInPictureDebounceForOpen);this.pictureInPictureDebounceForOpen=null}}},{key:"onInputFileOpenedStateUpdate",value:function e(t){var i=this;if(t){this.clearPictureInPictureDebounceForOpen();this.togglePictureInPictureCallWindow({isForceClose:true});this.isFileChooserActive=true}if(!t&&!this.pictureInPictureDebounceForOpen){this.pictureInPictureDebounceForOpen=setTimeout((function(){i.togglePictureInPictureCallWindow();i.isFileChooserActive=false;i.pictureInPictureDebounceForOpen=null}),1e3)}}},{key:"onDocumentBodyClick",value:function e(){var t=event,i=t.target;if(i.matches('input[type="file"]')){this.onInputFileOpenedStateUpdate(true)}}},{key:"onWindowFocus",value:function e(){if(c.DesktopApi.isDesktop()){this.onWindowDesktopFocus()}if(c.DesktopApi.isDesktop()&&this.isFileChooserActive){this.onInputFileOpenedStateUpdate(false)}this.updateWindowFocusState(true)}},{key:"onWindowBlur",value:function e(){if(c.DesktopApi.isDesktop()){this.onWindowDesktopBlur()}this.updateWindowFocusState(false)}},{key:"onWindowDesktopFocus",value:function e(){if(this.floatingScreenShareWindow){this.floatingScreenShareWindow.hide()}}},{key:"onWindowDesktopBlur",value:function e(){if(this.floatingScreenShareWindow&&this.currentCall&&this.currentCall.isScreenSharingStarted()){this.floatingScreenShareWindow.show()}}},{key:"isFullScreen",value:function e(){if("webkitFullscreenElement"in document){return!!document.webkitFullscreenElement}else if("fullscreenElement"in document){return!!document.fullscreenElement}return false}},{key:"toggleFullScreen",value:function e(){if(this.isFullScreen()){this.exitFullScreen()}else{this.enterFullScreen()}}},{key:"enterFullScreen",value:function e(){if(!this.callView){return}var t=this.callView.elements.root;try{var i=t.requestFullscreen||t.webkitRequestFullscreen||t.mozRequestFullScreen||t.msRequestFullscreen;if(i){i.call(t)["catch"]((function(e){console.error("Failed to enter fullscreen mode:",e)}))}else{console.warn("Fullscreen API is not supported in this browser")}}catch(e){console.error("Error attempting to enable fullscreen mode:",e)}}},{key:"exitFullScreen",value:function e(){try{var t=document.exitFullscreen||document.mozCancelFullScreen||document.webkitExitFullscreen||document.msExitFullscreen||document.cancelFullScreen;if(t){t.call(document)["catch"]((function(e){console.error("Failed to exit fullscreen mode:",e)}))}else{console.warn("Fullscreen API is not fully supported in this browser")}}catch(e){console.error("Error attempting to exit fullscreen mode:",e)}}},{key:"onCallViewShowChatButtonClick",value:function e(){var t;i.Analytics.getInstance().onShowChat({callId:(t=this.currentCall)===null||t===void 0?void 0:t.uuid,callType:i.Analytics.AnalyticsType.videoconf});this.toggleChat()}},{key:"onCallViewToggleUsersButtonClick",value:function e(){this.toggleUserList()}},{key:"_onCallcontrolButtonClick",value:function e(n){var a=this;if(!t.Util.canControlChangeSettings()){return}if(this.participantsPermissionPopup){this.participantsPermissionPopup.close();return}this.participantsPermissionPopup=new t.ParticipantsPermissionPopup({turnOffAllParticipansStream:function e(t){var n;a._onCallViewTurnOffAllParticipansStreamButtonClick(t);i.Analytics.getInstance().onTurnOffAllParticipansStream({callId:a._getCallIdentifier(a.currentCall),callType:a.getCallType(),typeOfStream:(n=t.data)===null||n===void 0?void 0:n.typeOfStream})},onPermissionChanged:function e(t){a.currentCall.changeSettings(t);if(!t.settingEnabled){i.Analytics.getInstance().onCallSettingsChanged({callId:a._getCallIdentifier(a.currentCall),callType:a.getCallType(),typeOfSetting:t.typeOfSetting,settingEnabled:t.settingEnabled})}},onClose:function e(){a.participantsPermissionPopup=null;a._afterCloseParticipantsPermissionPopup()},onOpen:function e(){a._afterOpenParticipantsPermissionPopup();i.Analytics.getInstance().onOpenCallSettings({callId:a._getCallIdentifier(a.currentCall),callType:a.getCallType()})}});if(this.participantsPermissionPopup){this.participantsPermissionPopup.toggle()}}},{key:"onCallViewFeedbackButtonClick",value:function e(){var t=this;BX.loadExt("ui.feedback.form").then((function(){BX.UI.Feedback.Form.open({id:"call_feedback_".concat(t.currentCall.uuid,"-").concat(t.currentCall.instanceId,"-").concat(Math.random()),forms:[{zones:["ru","by","kz"],id:406,sec:"9lhjhn",lang:"ru"},{zones:["de"],id:754,sec:"6upe49",lang:"de"},{zones:["es"],id:750,sec:"whk4la",lang:"es"},{zones:["com.br"],id:752,sec:"is01cs",lang:"com.br"},{zones:["en"],id:748,sec:"pds0h6",lang:"en"}],presets:{sender_page:"call",call_type:t.currentCall.provider,call_amount:t.currentCall.users.length+1,call_id:"id: ".concat(t.currentCall.uuid,", instanceId: ").concat(t.currentCall.instanceId),id_of_user:t.currentCall.userId,from_domain:location.origin}})}))}},{key:"onCallUserClick",value:function e(n){i.Analytics.getInstance().onClickUser({callId:this.currentCall.uuid,callType:i.Analytics.AnalyticsType.videoconf,layout:Object.keys(t.View.Layout).find((function(e){return t.View.Layout[e]===n.layout}))})}},{key:"onCallCopilotButtonClick",value:function e(){this.onChangeStateCopilot()}},{key:"onUpdateCallCopilotState",value:function e(i){var n=i.isTrackRecordOn;var r=this.currentCall.scheme?this.currentCall.scheme===t.CallScheme.classic:!a.CallSettingsManager.jwtCallsEnabled;if(r){this.currentCall.isCopilotActive=n}this.callView.updateCopilotState(this.currentCall.isCopilotActive)}},{key:"_onBlockCameraButton",value:function e(){if(!this.callView){return}this.callView.blockSwitchCamera()}},{key:"_onUnblockCameraButton",value:function e(){if(!this.callView){return}this.callView.unblockSwitchCamera()}},{key:"_onBlockMicrophoneButton",value:function e(){if(!this.callView){return}this.callView.blockSwitchMicrophone()}},{key:"_onUnblockMicrophoneButton",value:function e(){if(!this.callView){return}this.callView.unblockSwitchMicrophone()}},{key:"onCameraPublishing",value:function e(t){if(t.publishing){this.onBlockCameraButton()}else{this.onUnblockCameraButton()}if(this.callView){this.callView.updateButtons()}}},{key:"onMicrophonePublishingd",value:function e(t){if(!this.callView){return}if(t.publishing){this.onBlockMicrophoneButton()}else{this.onUnblockMicrophoneButton()}if(this.callView){this.callView.updateButtons()}}},{key:"onChangeStateCopilot",value:function e(){var t=this;var i=!this.currentCall.isCopilotActive?"call.Track.start":"call.Track.stop";BX.ajax.runAction(i,{data:{callId:this.currentCall.id}}).then((function(){t.onUpdateCallCopilotState({isTrackRecordOn:!t.currentCall.isCopilotActive})}))}},{key:"onCallViewFloorRequestButtonClick",value:function e(){var t=this;i.Analytics.getInstance().onFloorRequest({callId:this.currentCall.uuid,callType:i.Analytics.AnalyticsType.videoconf});var n=this.callView.getUserFloorRequestState(this.callEngine.getCurrentUserId());var a=this.callView.getUserTalking(this.callEngine.getCurrentUserId());this.callView.setUserFloorRequestState(this.callEngine.getCurrentUserId(),!n);if(this.currentCall){this.currentCall.requestFloor(!n)}clearTimeout(this.callViewFloorRequestTimeout);if(a&&!n){this.callViewFloorRequestTimeout=setTimeout((function(){if(t.currentCall){t.currentCall.requestFloor(false)}}),1500)}if(this.riseYouHandToTalkPopup&&!n){this.riseYouHandToTalkPopup.close();this.riseYouHandToTalkPopup=null}}},{key:"_onCallViewTurnOffAllParticipansStreamButtonClick",value:function e(t){if(this.currentCall){this.currentCall.turnOffAllParticipansStream(t)}}},{key:"bindCallEvents",value:function e(){this.currentCall.addEventListener(t.Event.onUserInvited,this.onCallUserInvitedHandler);this.currentCall.addEventListener(t.Event.onUserJoined,this.onCallUserJoinedHandler);this.currentCall.addEventListener(t.Event.onDestroy,this.onCallDestroyHandler);this.currentCall.addEventListener(t.Event.onUserStateChanged,this.onCallUserStateChangedHandler);this.currentCall.addEventListener(t.Event.onUserMicrophoneState,this.onCallUserMicrophoneStateHandler);this.currentCall.addEventListener(t.Event.onUserCameraState,this.onCallUserCameraStateHandler);this.currentCall.addEventListener(t.Event.onNeedResetMediaDevicesState,this.onNeedResetMediaDevicesStateHandler);this.currentCall.addEventListener(t.Event.onUserVideoPaused,this.onCallUserVideoPausedHandler);this.currentCall.addEventListener(t.Event.onLocalMediaReceived,this.onCallLocalMediaReceivedHandler);this.currentCall.addEventListener(t.Event.onLocalMediaStopped,this.onCallLocalMediaStoppedHandler);this.currentCall.addEventListener(t.Event.onRemoteMediaReceived,this.onCallRemoteMediaReceivedHandler);this.currentCall.addEventListener(t.Event.onRemoteMediaStopped,this.onCallRemoteMediaStoppedHandler);this.currentCall.addEventListener(t.Event.onUserVoiceStarted,this.onCallUserVoiceStartedHandler);this.currentCall.addEventListener(t.Event.onUserVoiceStopped,this.onCallUserVoiceStoppedHandler);this.currentCall.addEventListener(t.Event.onUserStatsReceived,this.onUserStatsReceivedHandler);this.currentCall.addEventListener(t.Event.onUserScreenState,this.onCallUserScreenStateHandler);b.Event.bind(this.currentCall,t.Event.onUserCommonRecordState,babelHelpers.classPrivateFieldGet(this,W));b.Event.bind(this.currentCall,t.Event.onCloudRecordStatusChanged,babelHelpers.classPrivateFieldGet(this,X));this.currentCall.addEventListener(t.Event.onUserFloorRequest,this.onCallUserFloorRequestHandler);this.currentCall.addEventListener(t.Event.onMicrophoneLevel,this.onMicrophoneLevelHandler);this.currentCall.addEventListener(t.Event.onCallFailure,this.onCallFailureHandler);this.currentCall.addEventListener(t.Event.onJoin,this._onCallJoinHandler);this.currentCall.addEventListener(t.Event.onLeave,this.onCallLeaveHandler);this.currentCall.addEventListener(t.Event.onReconnecting,this.onReconnectingHandler);this.currentCall.addEventListener(t.Event.onReconnected,this.onReconnectedHandler);this.currentCall.addEventListener(t.Event.onReconnectingFailed,this.onReconnectingFailedHandler);this.currentCall.addEventListener(t.Event.onUpdateLastUsedCameraId,this.onUpdateLastUsedCameraIdHandler);this.currentCall.addEventListener(t.Event.onConnectionQualityChanged,this.onCallConnectionQualityChangedHandler);this.currentCall.addEventListener(t.Event.onToggleRemoteParticipantVideo,this.onCallToggleRemoteParticipantVideoHandler);this.currentCall.addEventListener(t.Event.onGetUserMediaEnded,this._onGetUserMediaEndedHandler);this.currentCall.addEventListener(t.Event.onSwitchTrackRecordStatus,this._onSwitchTrackRecordStatusHandler);this.currentCall.addEventListener(t.Event.onCameraPublishing,this.onCameraPublishingHandler);this.currentCall.addEventListener(t.Event.onMicrophonePublishing,this.onMicrophonePublishingdHandler);this.currentCall.addEventListener(t.Event.onTurnOnCamera,this._onTurnOnCameraHandler);this.currentCall.addEventListener(t.Event.onAllParticipantsAudioMuted,this._onAllParticipantsAudioMutedHandler);this.currentCall.addEventListener(t.Event.onAllParticipantsVideoMuted,this._onAllParticipantsVideoMutedHandler);this.currentCall.addEventListener(t.Event.onAllParticipantsScreenshareMuted,this._onAllParticipantsScreenshareHandler);this.currentCall.addEventListener(t.Event.onRoomSettingsChanged,this._onRoomSettingsChangedHandler);this.currentCall.addEventListener(t.Event.onUserPermissionsChanged,this._onUserPermissionsChangedHandler);this.currentCall.addEventListener(t.Event.onUserRoleChanged,this._onUserRoleChangedHandler);this.currentCall.addEventListener(t.Event.onYouMuteAllParticipants,this._onYouMuteAllParticipantsHandler);this.currentCall.addEventListener(t.Event.onParticipantMuted,this._onParticipantMutedHandler)}},{key:"removeCallEvents",value:function e(){this.currentCall.removeEventListener(t.Event.onUserInvited,this.onCallUserInvitedHandler);this.currentCall.removeEventListener(t.Event.onUserJoined,this.onCallUserJoinedHandler);this.currentCall.removeEventListener(t.Event.onDestroy,this.onCallDestroyHandler);this.currentCall.removeEventListener(t.Event.onUserStateChanged,this.onCallUserStateChangedHandler);this.currentCall.removeEventListener(t.Event.onUserMicrophoneState,this.onCallUserMicrophoneStateHandler);this.currentCall.removeEventListener(t.Event.onUserCameraState,this.onCallUserCameraStateHandler);this.currentCall.removeEventListener(t.Event.onNeedResetMediaDevicesState,this.onNeedResetMediaDevicesStateHandler);this.currentCall.removeEventListener(t.Event.onUserVideoPaused,this.onCallUserVideoPausedHandler);this.currentCall.removeEventListener(t.Event.onLocalMediaReceived,this.onCallLocalMediaReceivedHandler);this.currentCall.removeEventListener(t.Event.onRemoteMediaReceived,this.onCallRemoteMediaReceivedHandler);this.currentCall.removeEventListener(t.Event.onRemoteMediaStopped,this.onCallRemoteMediaStoppedHandler);this.currentCall.removeEventListener(t.Event.onUserVoiceStarted,this.onCallUserVoiceStartedHandler);this.currentCall.removeEventListener(t.Event.onUserVoiceStopped,this.onCallUserVoiceStoppedHandler);this.currentCall.removeEventListener(t.Event.onUserStatsReceived,this.onUserStatsReceivedHandler);this.currentCall.removeEventListener(t.Event.onUserScreenState,this.onCallUserScreenStateHandler);b.Event.unbind(this.currentCall,t.Event.onUserCommonRecordState,babelHelpers.classPrivateFieldGet(this,W));b.Event.unbind(this.currentCall,t.Event.onCloudRecordStatusChanged,babelHelpers.classPrivateFieldGet(this,X));this.currentCall.removeEventListener(t.Event.onUserFloorRequest,this.onCallUserFloorRequestHandler);this.currentCall.removeEventListener(t.Event.onMicrophoneLevel,this.onMicrophoneLevelHandler);this.currentCall.removeEventListener(t.Event.onConnectionQualityChanged,this.onCallConnectionQualityChangedHandler);this.currentCall.removeEventListener(t.Event.onToggleRemoteParticipantVideo,this.onCallToggleRemoteParticipantVideoHandler);this.currentCall.removeEventListener(t.Event.onCallFailure,this.onCallFailureHandler);this.currentCall.removeEventListener(t.Event.onLeave,this.onCallLeaveHandler);this.currentCall.removeEventListener(t.Event.onReconnecting,this.onReconnectingHandler);this.currentCall.removeEventListener(t.Event.onReconnected,this.onReconnectedHandler);this.currentCall.removeEventListener(t.Event.onReconnectingFailed,this.onReconnectingFailedHandler);this.currentCall.removeEventListener(t.Event.onUpdateLastUsedCameraId,this.onUpdateLastUsedCameraIdHandler);this.currentCall.removeEventListener(t.Event.onGetUserMediaEnded,this._onGetUserMediaEndedHandler);this.currentCall.removeEventListener(t.Event.onSwitchTrackRecordStatus,this._onSwitchTrackRecordStatusHandler);this.currentCall.removeEventListener(t.Event.onCameraPublishing,this.onCameraPublishingHandler);this.currentCall.removeEventListener(t.Event.onMicrophonePublishing,this.onMicrophonePublishingdHandler);this.currentCall.removeEventListener(t.Event.onTurnOnCamera,this._onTurnOnCameraHandler);this.currentCall.removeEventListener(t.Event.onAllParticipantsAudioMuted,this._onAllParticipantsAudioMutedHandler);this.currentCall.removeEventListener(t.Event.onAllParticipantsVideoMuted,this._onAllParticipantsVideoMutedHandler);this.currentCall.removeEventListener(t.Event.onAllParticipantsScreenshareMuted,this._onAllParticipantsScreenshareHandler);this.currentCall.removeEventListener(t.Event.onRoomSettingsChanged,this._onRoomSettingsChangedHandler);this.currentCall.removeEventListener(t.Event.onUserPermissionsChanged,this._onUserPermissionsChangedHandler);this.currentCall.removeEventListener(t.Event.onUserRoleChanged,this._onUserRoleChangedHandler);this.currentCall.removeEventListener(t.Event.onYouMuteAllParticipants,this._onYouMuteAllParticipantsHandler);this.currentCall.removeEventListener(t.Event.onParticipantMuted,this._onParticipantMutedHandler)}},{key:"removeAdditionalEvents",value:function e(){var t=this;window.removeEventListener("focus",(function(){t.onWindowFocus()}));window.removeEventListener("blur",(function(){t.onWindowBlur()}));document.body.removeEventListener("click",(function(e){t.onDocumentBodyClick(e)}))}},{key:"onCallUserInvited",value:function e(i){var n=this;this.callView.addUser(i.userId);t.Util.getUsers(this.currentCall.id,[i.userId]).then((function(e){n.controller.getStore().dispatch("users/set",Object.values(e));n.controller.getStore().dispatch("conference/setUsers",{users:Object.keys(e)});n.callView.updateUserData(e)}))}},{key:"onCallUserJoined",value:function e(i){if(this.callView){this.callView.updateUserData(i.userData);this.callView.addUser(i.userId,t.UserState.Connected)}}},{key:"onCallUserStateChanged",value:function e(i){if(i.state!==t.UserState.Connected&&this.loopTimers[i.userId]===undefined){this.loopConnectionQuality(i.userId,1)}if(i.state===t.UserState.Connected){this.clearConnectionQualityTimer(i.userId);this.callView.setUserConnectionQuality(i.userId,5)}if(i.state===t.UserState.Ready&&i.previousState===t.UserState.Connected&&!Object.keys(this.currentCall).includes(i.userId)){i.state=t.UserState.Idle}if(i.state===t.UserState.Idle&&i.previousState===t.UserState.Connected){if(!F(this,j,oe).call(this)&&i.userId===this.commonRecord.initiatorId){F(this,z,he).call(this)}}this.callView.setUserState(i.userId,i.state);this.updateCallUser(i.userId,{state:i.state});if(!F(this,Q,ce).call(this)){this.callView.unblockButtons(["record"])}}},{key:"onCallUserMicrophoneState",value:function e(i){if(i.userId==this.currentCall.userId){t.Hardware.isMicrophoneMuted=!i.microphoneState}else{this.callView.setUserMicrophoneState(i.userId,i.microphoneState);this.updateCallUser(i.userId,{microphoneState:i.microphoneState})}}},{key:"onCallUserCameraState",value:function e(t){this.callView.setUserCameraState(t.userId,t.cameraState);this.updateCallUser(t.userId,{cameraState:t.cameraState})}},{key:"onNeedResetMediaDevicesState",value:function e(i){t.Hardware.isMicrophoneMuted=true;t.Hardware.isCameraOn=false}},{key:"onCallUserVideoPaused",value:function e(t){this.callView.setUserVideoPaused(t.userId,t.videoPaused)}},{key:"onCallLocalMediaReceived",value:function e(n){console.log("Received local media stream "+n);if(this.callView){var a=n.tag=="main"||n.mediaRenderer?t.Hardware.enableMirroring:false;this.callView.setLocalStream(n);this.callView.flipLocalVideo(a);this.callView.setButtonActive("screen",this.currentCall.isScreenSharingStarted());if(this.currentCall.isScreenSharingStarted()){this.screenShareStartTime=new Date;i.Analytics.getInstance().onScreenShareStarted({callId:this.currentCall.uuid,callType:i.Analytics.AnalyticsType.videoconf});this.togglePictureInPictureCallWindow();if(!c.DesktopApi.isDesktop()){this.showWebScreenSharePopup()}this.callView.updateButtons()}else{i.Analytics.getInstance().onScreenShareStopped({callId:this.currentCall.uuid,callType:i.Analytics.AnalyticsType.videoconf,status:i.Analytics.AnalyticsStatus.success,screenShareLength:t.Util.getTimeText(this.screenShareStartTime)});this.screenShareStartTime=null;this.togglePictureInPictureCallWindow();if(this.floatingScreenShareWindow){this.floatingScreenShareWindow.close()}if(this.webScreenSharePopup){this.webScreenSharePopup.close()}}if(!this.currentCall.callFromMobile&&!this.isViewerMode()){this.checkAvailableCamera();this.checkAvailableMicrophone()}}if(this.currentCall&&t.Hardware.isCameraOn&&n.tag==="main"&&n.stream.getVideoTracks().length===0){t.Hardware.isCameraOn=false}}},{key:"onCallLocalMediaStopped",value:function e(i){if(this.callView&&i.kind==="audio"){t.Hardware.isMicrophoneMuted=true;this.showNotification(b.Loc.getMessage("CALL_ERROR_MICROPHONE_STREAM_STOPPED"))}}},{key:"onCallRemoteMediaReceived",value:function e(t){var i=function e(t){var i,n;if(t!==null&&t!==void 0&&(i=t.getVideoTracks())!==null&&i!==void 0&&i.length){return"video"}if(t!==null&&t!==void 0&&(n=t.getAudioTracks())!==null&&n!==void 0&&n.length){return"audio"}return null};if(this.callView){if("track"in t){this.callView.setUserMedia(t.userId,t.kind,t.track)}if("mediaRenderer"in t&&t.mediaRenderer.kind==="audio"&&i(t.mediaRenderer.stream)==="audio"){this.callView.setUserMedia(t.userId,"audio",t.mediaRenderer.stream.getAudioTracks()[0])}if("mediaRenderer"in t&&t.mediaRenderer.kind==="sharing"&&i(t.mediaRenderer.stream)==="audio"){this.callView.setUserMedia(t.userId,"sharingAudio",t.mediaRenderer.stream.getAudioTracks()[0])}if("mediaRenderer"in t&&(t.mediaRenderer.kind==="video"||t.mediaRenderer.kind==="sharing")&&i(t.mediaRenderer.stream)==="video"){this.callView.setVideoRenderer(t.userId,t.mediaRenderer)}}}},{key:"onCallRemoteMediaStopped",value:function e(t){if(this.callView){if("mediaRenderer"in t){if(t.kind==="video"||t.kind==="sharing"){t.mediaRenderer.stream=null;this.callView.setVideoRenderer(t.userId,t.mediaRenderer)}}else{this.callView.setUserMedia(t.userId,t.kind,null)}}}},{key:"isLegacyCall",value:function e(i){var n=arguments.length>1&&arguments[1]!==undefined?arguments[1]:null;if(n){return n===t.CallScheme.classic}var r=i===t.Provider.Plain&&!a.CallSettingsManager.isJwtInPlainCallsEnabled();var o=i===t.Provider.Bitrix&&!a.CallSettingsManager.jwtCallsEnabled;return r||o}},{key:"_getCallIdentifier",value:function e(t){if(!t){return null}return this.isLegacyCall(t.provider,t.scheme)?t.id:t.uuid}},{key:"getCallType",value:function e(){return i.Analytics.AnalyticsType.videoconf}},{key:"loopConnectionQuality",value:function e(t,i){var n=this;var a=arguments.length>2&&arguments[2]!==undefined?arguments[2]:200;if(this.callView){this.loopTimers[t]=setTimeout((function(){n.callView.setUserConnectionQuality(t,i);var e=i>=4?1:i+1;n.loopConnectionQuality(t,e,a)}),a)}}},{key:"clearConnectionQualityTimer",value:function e(t){if(this.loopTimers[t]!==undefined){clearTimeout(this.loopTimers[t]);delete this.loopTimers[t]}}},{key:"onCallConnectionQualityChanged",value:function e(t){this.clearConnectionQualityTimer(t.userId);this.callView.setUserConnectionQuality(t.userId,t.score)}},{key:"onGetUserMediaEnded",value:function e(){this.updateMediaDevices()}},{key:"onCallToggleRemoteParticipantVideo",value:function e(t){if(this.toogleParticipantsVideoBaloon){if(t.isVideoShown){this.toogleParticipantsVideoBaloon.close()}return}if(!t.isVideoShown){this.toogleParticipantsVideoBaloon=BX.UI.Notification.Center.notify({content:b.Text.encode(BX.message("IM_M_CALL_REMOTE_PARTICIPANTS_VIDEO_MUTED")),autoHide:false,position:"top-right",closeButton:false})}}},{key:"onCallUserVoiceStarted",value:function e(t){if(t.local){if(this.currentCall.muted&&this.allowMutePopup){this.showMicMutedNotification()}return}this.callView.setUserTalking(t.userId,true);if(t.userId==this.callView.localUser.id){this.callView.setUserFloorRequestState(t.userId,false)}this.updateCallUser(t.userId,{talking:true,floorRequestState:false})}},{key:"onCallUserVoiceStopped",value:function e(t){this.callView.setUserTalking(t.userId,false);this.updateCallUser(t.userId,{talking:false})}},{key:"_onBlockUnblockCamMicButtons",value:function e(){if(t.Util.havePermissionToBroadcast("cam")){this._onUnblockCameraButton()}else{this._onBlockCameraButton()}if(t.Util.havePermissionToBroadcast("mic")){this._onUnblockMicrophoneButton()}else{this._onBlockMicrophoneButton()}}},{key:"_onTurnOnCamera",value:function e(t){this._onCallViewToggleVideoButtonClickHandler({video:true,calledProgrammatically:true})}},{key:"_onAllParticipantsAudioMuted",value:function e(i){var n=this.callView.userRegistry.get(i.userId);var a='<div class = "bx-call-view-participants-control-stream-notify-icon bx-call-view-mic-muted"></div>'+b.Text.encode(t.Util.getCustomMessage("CALL_USER_TURNED_OFF_MIC_FOR_ALL_MSGVER_1",{gender:n.data.gender?n.data.gender.toUpperCase():"M",name:n.data.name}));if(a&&(!i.reason||i.reason!=="settings")){this.createCallControlNotify({content:a,isAllow:false})}if(t.Util.isRegularUser(t.Util.getCurrentUserRole())){this._onCallViewToggleMuteHandler({muted:true,calledProgrammatically:true})}}},{key:"_onAllParticipantsVideoMuted",value:function e(i){var n=this.callView.userRegistry.get(i.userId);var a='<div class = "bx-call-view-participants-control-stream-notify-icon bx-call-view-cam-muted"></div>'+b.Text.encode(t.Util.getCustomMessage("CALL_USER_TURNED_OFF_CAM_FOR_ALL_MSGVER_1",{gender:n.data.gender?n.data.gender.toUpperCase():"M",name:n.data.name}));if(a&&(!i.reason||i.reason!=="settings")){this.createCallControlNotify({content:a,isAllow:false})}if(t.Util.isRegularUser(t.Util.getCurrentUserRole())){this._onCallViewToggleVideoButtonClickHandler({video:false,calledProgrammatically:true})}}},{key:"_onAllParticipantsScreenshareMuted",value:function e(i){var n=this.callView.userRegistry.get(i.userId);var a='<div class = "bx-call-view-participants-control-stream-notify-icon bx-call-view-cam-muted"></div>'+b.Text.encode(t.Util.getCustomMessage("CALL_USER_TURNED_OFF_SCREENSHARE_FOR_ALL_MSGVER_1",{gender:n.data.gender?n.data.gender.toUpperCase():"M",name:n.data.name}));if(a&&(!i.reason||i.reason!=="settings")){this.createCallControlNotify({content:a,isAllow:false})}if(this.currentCall.isScreenSharingStarted()&&t.Util.isRegularUser(t.Util.getCurrentUserRole())){this.onCallViewToggleScreenSharingButtonClick()}}},{key:"_onParticipantMuted",value:function e(i){var n;if((n=i.data)!==null&&n!==void 0&&n.track.muted){var a="mic";var r="";var o=this.callView.userRegistry.get(i.data.fromUserId);var l=this.callView.userRegistry.get(i.data.toUserId);var s=o.data.gender?o.data.gender.toUpperCase():"M";if(i.data.toUserId==this.callEngine.getCurrentUserId()){if(i.data.track.type===0){r="CALL_CONTROL_MODERATOR_TURNED_OFF_YOUR_MIC_MSGVER_1"+"_"+s;this._onCallViewToggleMuteHandler({muted:true,calledProgrammatically:true})}else if(i.data.track.type===1){a="cam";r="CALL_CONTROL_MODERATOR_TURNED_OFF_YOUR_CAM_MSGVER_1"+"_"+s;this._onCallViewToggleVideoButtonClickHandler({video:false,calledProgrammatically:true})}else if(i.data.track.type===2){a="screenshare";r="CALL_CONTROL_MODERATOR_TURNED_OFF_YOUR_SCREENSHARE"+"_"+s;if(this.currentCall.isScreenSharingStarted()){this.onCallViewToggleScreenSharingButtonClick()}}}else{if(i.data.fromUserId==this.callEngine.getCurrentUserId()){if(i.data.track.type===0){r="CALL_CONTROL_YOU_TURNED_OFF_USER_MIC"}else if(i.data.track.type===1){a="cam";r="CALL_CONTROL_YOU_TURNED_OFF_USER_CAM"}else if(i.data.track.type===2){a="screenshare";r="CALL_CONTROL_YOU_TURNED_OFF_USER_SCREENSHARE"}}else{if(i.data.track.type===0){r="CALL_CONTROL_MODERATOR_TURNED_OFF_USER_MIC_MSGVER_1"+"_"+s}else if(i.data.track.type===1){a="cam";r="CALL_CONTROL_MODERATOR_TURNED_OFF_USER_CAM_MSGVER_1"+"_"+s}else if(i.data.track.type===2){a="screenshare";r="CALL_CONTROL_MODERATOR_TURNED_OFF_USER_SCREENSHARE"+"_"+s}}}var c='<div class = "bx-call-view-participants-control-stream-notify-icon bx-call-view-'+a+'-muted"></div>'+b.Text.encode(t.Util.getCustomMessage(r,{gender:s,initiator_name:o.data.name,target_name:l.data.name}));this.createCallControlNotify({content:c,isAllow:false})}}},{key:"_onYouMuteAllParticipants",value:function e(t){var i={0:"mic",1:"cam",2:"screenshare"};var n={0:"CALL_YOU_TURNED_OFF_MIC_FOR_ALL_MSGVER_1",1:"CALL_YOU_TURNED_OFF_CAM_FOR_ALL_MSGVER_1",2:"CALL_YOU_TURNED_OFF_SCREENSHARE_FOR_ALL_MSGVER_1"};var a='<div class = "bx-call-view-participants-control-stream-notify-icon bx-call-view-'+i[t.data.track.type]+'-muted"></div>'+BX.message[n[t.data.track.type]];this.createCallControlNotify({content:a,isAllow:false})}},{key:"_onUserPermissionsChanged",value:function e(i){var n=this.callView.userRegistry.get(i.data.fromUserId);var a=n.data.gender?n.data.gender.toUpperCase():"M";var r="CALL_ADMIN_ALLOWED_TURN_ON_ALL_FOR_YOU_BY_HANDRAISE_"+a;if(!i.data.allow){r="CALL_ADMIN_NOT_ALLOWED_TURN_ON_ALL_FOR_YOU_BY_HANDRAISE_"+a;var o=this.callView.getUserFloorRequestState(this.callEngine.getCurrentUserId());if(o){this.onCallViewFloorRequestButtonClick()}}var l=b.Text.encode(t.Util.getCustomMessage(r,{gender:a,initiator_name:n.data.name}));if(l){this.createCallControlNotify({content:l,isAllow:i.data.allow})}if(this.callView){this.callView.setUserPermissionToSpeakState(i.data.toUserId,i.data.allow)}this.callView.updateButtons();this._onBlockUnblockCamMicButtons()}},{key:"_onUserRoleChanged",value:function e(t){var i=this;if(t.data.toUserId==this.callEngine.getCurrentUserId()){var n=BX.message("CALL_YOU_HAVE_BEEN_APPOINTED_AS_ADMIN");if(n){this.promotedToAdminTimeout=setTimeout((function(){return i.createCallControlNotify({content:n,isAllow:true})}),this.promotedToAdminTimeoutValue)}if(this.riseYouHandToTalkPopup){this.riseYouHandToTalkPopup.close();this.riseYouHandToTalkPopup=null}if(this.callView){this.callView.updateButtons();this.callView.updateFloorRequestNotification()}this._onBlockUnblockCamMicButtons()}}},{key:"_onRoomSettingsChanged",value:function e(i){var n={audio:"mic",video:"cam",screen_share:"screenshare"};var a="";var r=false;var o=this.callView.userRegistry.get(i.data.fromUserId);var l=o.data.gender?o.data.gender.toUpperCase():"M";if(i.data.eft===true){if(i.data.fromUserId==this.currentCall.userId){var s={audio:"CALL_YOU_PROHIBITED_MIC_FOR_ALL_BY_SETTINGS",video:"CALL_YOU_PROHIBITED_CAM_FOR_ALL_BY_SETTINGS",screen_share:"CALL_YOU_PROHIBITED_SCREENSHARE_FOR_ALL_BY_SETTINGS"};a='<div class = "bx-call-view-participants-control-stream-notify-icon bx-call-view-'+n[i.data.act]+'-muted"></div>'+BX.message[s[i.data.act]]}else{var c={audio:"CALL_ADMIN_PROHIBITED_MIC_FOR_ALL_BY_SETTINGS",video:"CALL_ADMIN_PROHIBITED_CAM_FOR_ALL_BY_SETTINGS",screen_share:"CALL_ADMIN_PROHIBITED_SCREENSHARE_FOR_ALL_BY_SETTINGS"};var u=c[i.data.act]+"_"+l;a='<div class = "bx-call-view-participants-control-stream-notify-icon bx-call-view-'+n[i.data.act]+'-muted"></div>'+b.Text.encode(t.Util.getCustomMessage(u,{gender:l,initiator_name:o.data.name}))}}else{r=true;if(i.data.fromUserId==this.currentCall.userId){if(this.riseYouHandToTalkPopup){this.riseYouHandToTalkPopup.close();this.riseYouHandToTalkPopup=null}var d={audio:"CALL_YOU_ALLOWED_MIC_FOR_ALL_BY_SETTINGS",video:"CALL_YOU_ALLOWED_CAM_FOR_ALL_BY_SETTINGS",screen_share:"CALL_YOU_ALLOWED_SCREENSHARE_FOR_ALL_BY_SETTINGS"};a='<div class = "bx-call-view-participants-control-stream-notify-icon bx-call-view-'+n[i.data.act]+'-unmuted"></div>'+BX.message[d[i.data.act]]}else{var h={audio:"CALL_ADMIN_ALLOWED_MIC_FOR_ALL_BY_SETTINGS",video:"CALL_ADMIN_ALLOWED_CAM_FOR_ALL_BY_SETTINGS",screen_share:"CALL_ADMIN_ALLOWED_SCREENSHARE_FOR_ALL_BY_SETTINGS"};var C=h[i.data.act]+"_"+l;a='<div class = "bx-call-view-participants-control-stream-notify-icon bx-call-view-'+n[i.data.act]+'-unmuted"></div>'+b.Text.encode(t.Util.getCustomMessage(C,{gender:l,initiator_name:o.data.name}));if(this.riseYouHandToTalkPopup&&i.data.act==="audio"){this.riseYouHandToTalkPopup.close();this.riseYouHandToTalkPopup=null}}}if(this.callView&&!r){this.callView.setAllUserPermissionToSpeakState(false)}if(a){this.createCallControlNotify({content:a,isAllow:r})}if(this.participantsPermissionPopup){this.participantsPermissionPopup.updateStatePermissions()}if(i.data.eft===true&&i.data.act==="audio"&&!t.Util.havePermissionToBroadcast("mic")){this.lastCalledChangeSettingsUserName=o.data.name;this.showRiseYouHandToTalkNotification({initiatorName:this.lastCalledChangeSettingsUserName})}this.callView.updateButtons();this._onBlockUnblockCamMicButtons()}},{key:"showRiseYouHandToTalkNotification",value:function e(i){var n=this;if(!this.callView){return}if(this.riseYouHandToTalkPopup){return}if(this.mutePopup){this.mutePopup.close();this.mutePopup=null}this.riseYouHandToTalkPopup=new t.Hint({callFolded:false,bindElement:this.callView.buttons.microphone.elements.icon,targetContainer:this.callView.container,icon:"mic",showAngle:false,initiatorName:i.initiatorName,customClassName:"bx-call-view-popup-call-hint-rise-hand-to-talk",autoCloseDelay:30*60*1e3,customRender:function e(){var t=b.Dom.create("div",{props:{className:"bx-call-view-popup-call-hint-rise-block"},children:[b.Loc.getMessage("CALL_ADMIN_PROHIBITED_TURN_ON_PARTICIPANTS_MICROPHONES_HINT",{"#INITIATOR_NAME#":this.initiatorName,"[hint-label]":'<div class="bx-call-view-popup-call-hint-text">',"[/hint-label]":"</div>","#RISE_HAND_ICON#":'<div class="ui-btn bx-call-view-popup-call-hint-hand-raise-icon"></div>',"[label-or]":'<div class="bx-call-view-popup-call-hint-hand-raise-or-label">',"[/label-or]":"</div>","#REQUEST_NOW_BUTTON#":'<div class = "bx-call-view-popup-call-hint-button-placeholder"></div>'})]});var i=t.getElementsByClassName("bx-call-view-popup-call-hint-button-placeholder")[0];i.replaceWith(this.createAskSpeakButton().render());return t},buttons:[],onClose:function e(){n.riseYouHandToTalkPopup.close();n.riseYouHandToTalkPopup=null},onAskSpeakButtonClicked:function e(){n.onCallViewFloorRequestButtonClick();if(n.riseYouHandToTalkPopup){n.riseYouHandToTalkPopup.close();n.riseYouHandToTalkPopup=null}}});this.riseYouHandToTalkPopup.show()}},{key:"_afterOpenParticipantsPermissionPopup",value:function e(){if(this.participantsPermissionPopup){var t=BX.UI.Notification.Center.balloons;for(var i in t){var n;(n=t[i].container)===null||n===void 0?void 0:n.classList.add(x);t[i].offsetClassNameSetted=true}}}},{key:"_afterCloseParticipantsPermissionPopup",value:function e(){var t=BX.UI.Notification.Center.balloons;for(var i in t){var n;(n=t[i].container)===null||n===void 0?void 0:n.classList.remove(x);t[i].offsetClassNameSetted=false}}},{key:"createCallControlNotify",value:function e(t){if(!this.callView){return}var i="ui-notification-balloon-content bx-call-control-notification ";if(t.isAllow===false){i+="bx-call-control-notification-disallow "}else{i+="bx-call-control-notification-allow "}BX.UI.Notification.Center.notify({content:t.content,position:"top-right",autoHideDelay:8e3,category:t.category||"",closeButton:true,render:function e(){var t=this.getActions().map((function(e){return e.getContainer()}));return BX.create("div",{props:{className:i},children:[BX.create("div",{props:{className:"ui-notification-balloon-message"},html:this.getContent()}),BX.create("div",{props:{className:"ui-notification-balloon-actions"},children:t}),this.isCloseButtonVisible()?this.getCloseButton():null]})}});this._afterOpenParticipantsPermissionPopup()}},{key:"onUserStatsReceived",value:function e(t){if(this.callView){this.callView.setUserStats(t.userId,t.report)}}},{key:"onCallUserScreenState",value:function e(t){if(this.callView){this.callView.setUserScreenState(t.userId,t.screenState)}this.updateCallUser(t.userId,{screenState:t.screenState})}},{key:"onCallUserFloorRequest",value:function e(t){this.callView.setUserFloorRequestState(t.userId,t.requestActive);this.updateCallUser(t.userId,{floorRequestState:t.requestActive})}},{key:"onMicrophoneLevel",value:function e(t){this.callView.setMicrophoneLevel(t.level)}},{key:"onCallJoin",value:function e(i){if(!i.local){return}if(!this.isViewerMode()){this.callView.unblockButtons(["floorRequest","screen"]);this.checkAvailableCamera();this.checkAvailableMicrophone()}if(this.callView.getConnectedUserCount(false)){this.callView.unblockButtons(["record"])}this.callView.setUiState(t.View.UiState.Connected)}},{key:"onCallFailure",value:function e(i){this.setConferenceHasErrorInCall(true);var n=i.code||i.name||i.error;var a="";var r=false;if(i.name==="VoxConnectionError"||i.name==="AuthResult"){t.Util.reportConnectionResult(i.call.id,false)}switch(n){case t.StartCallErrorCode.ErrorUnexpectedAnswer:a=b.Loc.getMessage("IM_CALL_ERROR_UNEXPECTED_ANSWER");break;case t.StartCallErrorCode.BlankAnswerWithErrorCode:a=b.Loc.getMessage("IM_CALL_ERROR_BLANK_ANSWER");break;case t.StartCallErrorCode.BlankAnswer:a=b.Loc.getMessage("IM_CALL_ERROR_BLANK_ANSWER");break;case t.StartCallErrorCode.AccessDenied:a=b.Loc.getMessage("IM_CALL_ERROR_ACCESS_DENIED");break;case t.StartCallErrorCode.NoWebrtc:a=b.Loc.getMessage(this.isHttps?"IM_CALL_NO_WEBRT":"IM_CALL_ERROR_HTTPS_REQUIRED");break;case t.StartCallErrorCode.UnknownError:r=true;a=b.Loc.getMessage("IM_CALL_ERROR_UNKNOWN");break;case t.StartCallErrorCode.NetworkError:a=b.Loc.getMessage("IM_CALL_ERROR_NETWORK");break;case t.StartCallErrorCode.NotAllowedError:a=b.Loc.getMessage("IM_CALL_ERROR_HARDWARE_ACCESS_DENIED");break;case t.StartCallErrorCode.NotReadableError:a=b.Loc.getMessage("IM_CALL_ERROR_HARDWARE");break;default:if(n===t.StartCallErrorCode.AuthorizeError||i.name==="AuthResult"){a=b.Loc.getMessage("IM_CALL_ERROR_AUTHORIZATION")}else if(n==403&&i.name==="Failed"){a=b.Loc.getMessage("IM_CALL_ERROR_HARDWARE_ACCESS_DENIED")}else{r=true;a=b.Loc.getMessage("IM_CALL_ERROR_UNKNOWN_WITH_CODE",{"#ERROR_CODE#":n})}}if(this.callView){if(r){this.callView.showSelfTest()}else if(n===t.DisconnectReason.SecurityKeyChanged){this.callView.showSecurityKeyError()}else{this.callView.showFatalError({text:a})}}else{this.showNotification(a)}this.autoCloseCallView=false;if(this.currentCall){this.removeVideoStrategy();this.removeCallEvents();if(this.currentCallIsNew){this.callEngine.getRestClient().callMethod("im.call.interrupt",{callId:this.currentCall.id})}this.currentCall.destroy();this.currentCall=null;this.currentCallIsNew=false}if(this.promotedToAdminTimeout){clearTimeout(this.promotedToAdminTimeout)}t.Hardware.isMicrophoneMuted=false}},{key:"onCallLeave",value:function e(n){if(!n.local){return}if(this.webScreenSharePopup){this.webScreenSharePopup.close()}F(this,z,he).call(this);this.commonRecord.state=t.CallCommonRecordState.Stopped;this.commonRecord.type=t.CallCommonRecordType.None;this.togglePictureInPictureCallWindow({isForceClose:true});if(!this.getActiveCallUsers().length){var a,r;i.Analytics.getInstance().onFinishCall({callId:(a=this.currentCall)===null||a===void 0?void 0:a.uuid,callType:i.Analytics.AnalyticsType.videoconf,status:i.Analytics.AnalyticsStatus.lastUserLeft,chatId:(r=this.currentCall)===null||r===void 0?void 0:r.associatedEntity.id,callUsersCount:this.getCallUsers(true).length,callLength:t.Util.getTimeText(this.currentCall.startDate)})}this.endCall()}},{key:"onCallDestroy",value:function e(t){this.currentCall=null;if(this.promotedToAdminTimeout){clearTimeout(this.promotedToAdminTimeout)}if(this.floatingScreenShareWindow){this.floatingScreenShareWindow.close}if(this.webScreenSharePopup){this.webScreenSharePopup.close()}if(this.riseYouHandToTalkPopup){this.riseYouHandToTalkPopup.close();this.riseYouHandToTalkPopup=null}F(this,z,he).call(this);this.restart()}},{key:"onCheckDevicesSave",value:function e(i){if(i["camera"]){t.Hardware.defaultCamera=i["camera"]}if(i["microphone"]){t.Hardware.defaultMicrophone=i["microphone"]}if(i["audioOutput"]){t.Hardware.defaultSpeaker=i["audioOutput"]}if(i["preferHDQuality"]){t.Hardware.preferHdQuality=i["preferHDQuality"]}if(i["enableMicAutoParameters"]){t.Hardware.enableMicAutoParameters=i["enableMicAutoParameters"]}}},{key:"setCameraState",value:function e(i){t.Hardware.isCameraOn=i}},{key:"isChatShowed",value:function e(){return this.getConference().common.showChat}},{key:"toggleChat",value:function e(){var t=this.getConference().common.rightPanelMode;if(t===g.ConferenceRightPanelMode.hidden){this.controller.getStore().dispatch("conference/changeRightPanelMode",{mode:g.ConferenceRightPanelMode.chat});this.callView.setButtonActive("chat",true)}else if(t===g.ConferenceRightPanelMode.chat){this.controller.getStore().dispatch("conference/changeRightPanelMode",{mode:g.ConferenceRightPanelMode.hidden});this.callView.setButtonActive("chat",false)}else if(t===g.ConferenceRightPanelMode.users){this.controller.getStore().dispatch("conference/changeRightPanelMode",{mode:g.ConferenceRightPanelMode.split});this.callView.setButtonActive("chat",true)}else if(t===g.ConferenceRightPanelMode.split){this.controller.getStore().dispatch("conference/changeRightPanelMode",{mode:g.ConferenceRightPanelMode.users});this.callView.setButtonActive("chat",false)}}},{key:"toggleUserList",value:function e(){var t=this.getConference().common.rightPanelMode;if(t===g.ConferenceRightPanelMode.hidden){this.controller.getStore().dispatch("conference/changeRightPanelMode",{mode:g.ConferenceRightPanelMode.users});this.callView.setButtonActive("users",true)}else if(t===g.ConferenceRightPanelMode.users){this.controller.getStore().dispatch("conference/changeRightPanelMode",{mode:g.ConferenceRightPanelMode.hidden});this.callView.setButtonActive("users",false)}else if(t===g.ConferenceRightPanelMode.chat){this.controller.getStore().dispatch("conference/changeRightPanelMode",{mode:g.ConferenceRightPanelMode.split});this.callView.setButtonActive("users",true)}else if(t===g.ConferenceRightPanelMode.split){this.controller.getStore().dispatch("conference/changeRightPanelMode",{mode:g.ConferenceRightPanelMode.chat});this.callView.setButtonActive("users",false)}}},{key:"pinUser",value:function e(i){if(!this.callView){return false}this.callView.pinUser(i.id);this.callView.setLayout(t.View.Layout.Centered)}},{key:"unpinUser",value:function e(){if(!this.callView){return false}this.callView.unpinUser()}},{key:"changeBackground",value:function e(){if(!t.Hardware){return false}t.BackgroundDialog.open()}},{key:"openChat",value:function e(t){c.DesktopApi.emitToMainWindow("bxConferenceOpenChat",[t.id])}},{key:"openProfile",value:function e(t){c.DesktopApi.emitToMainWindow("bxConferenceOpenProfile",[t.id])}},{key:"setDialogInited",value:function e(){this.dialogInited=true;var t=this.getDialogData();document.title=t.name}},{key:"changeVideoconfUrl",value:function e(t){window.history.pushState("","",t)}},{key:"sendNewMessageNotify",value:function e(t){if(!this.checkIfMessageNotifyIsNeeded(t)){return false}var i=P.Utils.text.purify(t.message.text,t.message.params,t.files);var n="";var a="";if(t.message.senderId>0&&t.message.system!=="Y"){var r=this.controller.getStore().getters["users/get"](t.message.senderId,true);a=r.name;n=r.avatar}S.Notifier.notify({id:"im-videconf-".concat(t.message.id),title:a,icon:n,text:i});return true}},{key:"checkIfMessageNotifyIsNeeded",value:function e(i){if(!t.Util.isConferenceChatEnabled()){return false}var n=this.getConference().common.rightPanelMode;return!P.Utils.device.isMobile()&&i.chatId===this.getChatId()&&(n!==g.ConferenceRightPanelMode.chat||n!==g.ConferenceRightPanelMode.split)&&i.message.senderId!==this.controller.getUserId()&&!this.getConference().common.error}},{key:"onInputFocus",value:function e(t){this.callView.setHotKeyTemporaryBlock(true)}},{key:"onInputBlur",value:function e(t){this.callView.setHotKeyTemporaryBlock(false)}},{key:"closeReconnectionBaloon",value:function e(){if(this.reconnectionBaloon){this.reconnectionBaloon.close();this.reconnectionBaloon=null}}},{key:"setReconnectingCameraId",value:function e(t){this.reconnectingCameraId=t;if(t){this.updateCameraSettingsInCurrentCallAfterReconnecting(t)}}},{key:"updateCameraSettingsInCurrentCallAfterReconnecting",value:function e(i){if(this.currentCall.cameraId===i){return}var n=t.Hardware.getCameraList();if(!n.find((function(e){return e.deviceId===i}))){return}this.currentCall.setCameraId(i);this.setReconnectingCameraId(null)}},{key:"onUpdateLastUsedCameraId",value:function e(){var t=this.currentCall.cameraId;if(t){this.lastUsedCameraId=t}}},{key:"onReconnecting",value:function e(n){if(!(this.currentCall.provider===t.Provider.Bitrix||this.currentCall.provider===t.Provider.Plain)){return false}i.Analytics.getInstance().onReconnect({callId:this.currentCall.uuid,callType:i.Analytics.AnalyticsType.videoconf,reconnectionReason:n.reconnectionReason,reconnectionReasonInfo:n.reconnectionReasonInfo,reconnectionEventCount:n.reconnectionEventCount,isVpnActive:F(this,J,ue).call(this)});if(this.reconnectionBaloon){return}this.reconnectionBaloon=BX.UI.Notification.Center.notify({content:b.Text.encode(BX.message("IM_CALL_RECONNECTING")),autoHide:false,position:"top-right",closeButton:false})}},{key:"onReconnected",value:function e(){this.setReconnectingCameraId(this.lastUsedCameraId);if(!(this.currentCall.provider===t.Provider.Bitrix||this.currentCall.provider===t.Provider.Plain)){return false}this.closeReconnectionBaloon()}},{key:"onReconnectingFailed",value:function e(t){var n;i.Analytics.getInstance().onReconnectError({callId:(n=this.currentCall)===null||n===void 0?void 0:n.id,callType:i.Analytics.AnalyticsType.videoconf,errorCode:t===null||t===void 0?void 0:t.code,isVpnActive:F(this,J,ue).call(this)})}},{key:"setUserWasRenamed",value:function e(){if(this.callView){this.callView.localUser.userModel.wasRenamed=true}}},{key:"setError",value:function e(t){var i=this.getConference().common.error;if(i&&i===g.ConferenceErrorCode.kickedFromCall){return}this.controller.getStore().commit("conference/setError",{errorCode:t})}},{key:"toggleSmiles",value:function e(){this.controller.getStore().commit("conference/toggleSmiles")}},{key:"setJoinType",value:function e(t){this.controller.getStore().commit("conference/setJoinType",{joinWithVideo:t})}},{key:"setConferenceStatus",value:function e(t){this.controller.getStore().commit("conference/setConferenceStatus",{conferenceStarted:t})}},{key:"setConferenceHasErrorInCall",value:function e(t){this.controller.getStore().commit("conference/setConferenceHasErrorInCall",{hasErrorInCall:t})}},{key:"setConferenceStartDate",value:function e(t){this.controller.getStore().commit("conference/setConferenceStartDate",{conferenceStartDate:t})}},{key:"setUserReadyToJoin",value:function e(){this.controller.getStore().commit("conference/setUserReadyToJoin")}},{key:"updateCallUser",value:function e(t,i){this.controller.getStore().dispatch("call/updateUser",{id:t,fields:i})}},{key:"setUserName",value:function e(t){var i=this;return new Promise((function(e,n){i.restClient.callMethod("im.call.user.update",{name:t,chat_id:i.getChatId()}).then(e)["catch"]((function(e){n(e)}))}))}},{key:"checkPassword",value:function e(t){var i=this;return new Promise((function(e,n){i.restClient.callMethod("im.videoconf.password.check",{password:t,alias:i.params.alias}).then((function(a){if(a.data()===true){i.restClient.setPassword(t);i.controller.getStore().commit("conference/common",{passChecked:true});i.initUserComplete();e()}else{n()}}))["catch"]((function(e){console.error("Password check error",e)}))}))}},{key:"changeLink",value:function e(){var t=this;return new Promise((function(e,i){t.restClient.callMethod("im.videoconf.share.change",{dialog_id:t.getDialogId()}).then((function(){e()}))["catch"]((function(e){i(e)}))}))}},{key:"ready",value:function e(){if(this.inited){var t=new BX.Promise;t.resolve(this);return t}return this.initPromise}},{key:"getConference",value:function e(){return this.controller.getStore().state.conference}},{key:"isBroadcast",value:function e(){return this.getConference().common.isBroadcast}},{key:"getBroadcastPresenters",value:function e(){return this.getConference().common.presenters}},{key:"isExternalUser",value:function e(){return!!this.getUserHash()}},{key:"getCallConfig",value:function e(i,n){var a;var r={videoEnabled:i,type:t.Type.Permanent,entityType:"chat",entityId:this.getDialogId(),provider:t.Provider.Bitrix,enableMicAutoParameters:t.Hardware.enableMicAutoParameters,joinExisting:true,token:this.callToken,chatInfo:{advanced:{chatType:"videoconf",entityData1:"",entityData2:"",entityData3:"",entityId:this.getDialogId(),entityType:"VIDEOCONF"},avatar:"/bitrix/js/im/images/blank.gif",avatarColor:"#ab7761",id:this.getDialogId(),chatId:this.getChatId(),name:this.params.conferenceTitle,type:"chat",userCounter:(a=this.getDialogData())===null||a===void 0?void 0:a.userCounter}};if(n){r.roomId=n}return r}},{key:"getChatId",value:function e(){return parseInt(this.params.chatId)}},{key:"getDialogId",value:function e(){return this.params.dialogId}},{key:"getDialogData",value:function e(){if(!this.dialogInited){return false}return this.controller.getStore().getters["dialogues/get"](this.getDialogId())}},{key:"getHost",value:function e(){return location.origin||""}},{key:"getStartupErrorCode",value:function e(){return this.params.startupErrorCode?this.params.startupErrorCode:""}},{key:"isHttps",value:function e(){return location.protocol==="https:"}},{key:"getUserHash",value:function e(){return this.getConference().user.hash}},{key:"getUserHashCookie",value:function e(){var t="";var i=h.Cookie.get(null,"BITRIX_CALL_HASH");if(typeof i==="string"&&i.match(/^[a-f0-9]{32}$/)){t=i}return t}},{key:"switchToSessAuth",value:function e(){this.restClient.restClient.queryParams=undefined;return true}}]);return e}();function re(){var e=P.Utils.platform.isBitrixDesktop();var i=P.Utils.platform.getDesktopVersion()>=54;if(!e||!i){return false}if(!t.CallCloudRecord.serviceEnabled){return true}if(!t.CallCloudRecord.tariffAvailable){return true}return this.currentCall.provider===t.Provider.Plain}function oe(){return t.CallCloudRecord.serviceEnabled&&t.CallCloudRecord.tariffAvailable}function le(){return F(this,Y,re).call(this)||F(this,j,oe).call(this)}function se(){return F(this,Y,re).call(this)&&this.commonRecord.state!=t.CallCommonRecordState.Stopped&&this.commonRecord.state!=t.CallCommonRecordState.Destroyed}function ce(){return F(this,q,le).call(this)&&this.commonRecord.state!=t.CallCommonRecordState.Stopped&&this.commonRecord.state!=t.CallCommonRecordState.Destroyed}function ue(){var e;if(c.DesktopApi.isDesktop()&&typeof((e=BXDesktopSystem)===null||e===void 0?void 0:e.IsVpnConnected)==="function"&&BXDesktopSystem.IsVpnConnected()){return true}else{return false}}function de(e){var i=this.currentCall.provider===t.Provider.Plain;this.commonRecord.type=e;if(t.CallCloudRecord.serviceEnabled&&!i){var n=e==="audio"?t.CloudRecordKind.AUDIO:t.CloudRecordKind.VIDEO;this.callView.blockButtons(["record"]);this.currentCall.setCloudRecordState(t.CloudRecordStatus.STARTED,n);return}this.callView.setButtonActive("record",true);this.currentCall.sendLocalRecordState({action:t.CallCommonRecordState.Started,type:this.commonRecord.type,date:new Date});this.commonRecord.state=t.CallCommonRecordState.Started}function he(){var e=this.commonRecord.initiatorId;var i=this.commonRecord.state;this.commonRecord=F(this,ie,ve).call(this);if(F(this,Y,re).call(this)){BXDesktopSystem.CallRecordStop()}if(this.callView){this.callView.setCommonRecordState(this.callView.getDefaultCommonRecordState());this.callView.setButtonActive("record",false)}if(i!==t.CallCommonRecordState.Stopped&&this.currentCall&&this.currentCall.isAnyoneParticipating()&&e===this.currentCall.userId){this.currentCall.sendLocalRecordState({action:t.CallCommonRecordState.Stopped,userId:this.currentCall.userId})}}function Ce(e){var i=this;var n=e.data,a=n.state,r=n.kind,o=n.hotkey;switch(a){case t.CallCommonRecordState.Started:{if(o){F(this,K,de).call(this,t.CallCommonRecordType.Video);return}if(r===t.CallCommonRecordType.Audio){if(this.currentCall&&this.currentCall.isCopilotActive){this.callView.showConfirmModal({title:b.Loc.getMessage("CALL_RECORD_AUDIO_WITH_COPILOT_TITLE"),message:b.Loc.getMessage("CALL_RECORD_AUDIO_WITH_COPILOT_MESSAGE"),yesButtonText:b.Loc.getMessage("CALL_RECORD_AUDIO_WITH_COPILOT_YES_BUTTON"),noButtonText:b.Loc.getMessage("CALL_RECORD_AUDIO_WITH_COPILOT_NO_BUTTON")}).then((function(e){if(e==="no"){F(i,K,de).call(i,t.CallCommonRecordType.Audio)}}))["catch"]((function(e){return console.error("Unspecified error in callView.showConfirmModal:",e)}));return}F(this,K,de).call(this,t.CallCommonRecordType.Audio)}if(r===t.CallCommonRecordType.Video){F(this,K,de).call(this,t.CallCommonRecordType.Video)}return}case t.CallCommonRecordState.Paused:case t.CallCommonRecordState.Resumed:{if(F(this,j,oe).call(this)){var l=a===t.CallCommonRecordState.Paused?t.CloudRecordStatus.PAUSED:t.CloudRecordStatus.STARTED;this.currentCall.setCloudRecordState(l);this.commonRecord.state=a;return}if(F(this,Y,re).call(this)){BXDesktopSystem.CallRecordPause(a===t.CallCommonRecordState.Paused)}break}case t.CallCommonRecordState.Stopped:{if(F(this,j,oe).call(this)){this.callView.blockButtons(["record"]);this.currentCall.setCloudRecordState(t.CloudRecordStatus.STOPPED);this.commonRecord.state=t.CallCommonRecordState.Stopped;return}this.callView.setButtonActive("record",false);break}case t.CallCommonRecordState.Destroyed:{if(F(this,j,oe).call(this)){this.callView.showConfirmModal({title:b.Loc.getMessage("CALL_CLOUD_RECORD_DESTROY_TITLE"),message:b.Loc.getMessage("CALL_CLOUD_RECORD_DESTROY_MESSAGE"),yesButtonText:b.Loc.getMessage("CALL_CLOUD_RECORD_DESTROY_RESUME_BUTTON"),noButtonText:b.Loc.getMessage("CALL_CLOUD_RECORD_DESTROY_DELETE_BUTTON")}).then((function(e){if(e==="no"){i.callView.blockButtons(["record"]);i.currentCall.setCloudRecordState(t.CloudRecordStatus.DESTROYED);i.commonRecord.state=t.CallCommonRecordState.Destroyed}}))["catch"]((function(e){return console.error("Unspecified error in callView.showConfirmModal:",e)}));return}break}default:{console.warn("Unknown recording state",a);break}}this.currentCall.sendLocalRecordState({action:a,type:this.commonRecord.type,date:new Date});this.commonRecord.state=a}function fe(){i.Analytics.getInstance().onRecordBtnClick({callId:this.currentCall.uuid,callType:i.Analytics.AnalyticsType.videoconf});if(t.CallCloudRecord.serviceEnabled){if(!t.CallCloudRecord.tariffAvailable){t.Util.openArticle(t.CallCloudRecord.tariffSlider);return}var e=this.currentCall.provider===t.Provider.Plain;if(e&&!c.DesktopApi.isDesktop()){this.callView.showCloudRecordInfoPopup(this.currentCall.isCloudRecordFeaturesEnabled,this.currentCall.id);return}this.callView.showCommonRecordMenuPopup(e&&c.DesktopApi.isDesktop());return}if(!F(this,q,le).call(this)){if(window.BX.Helper){window.BX.Helper.show("redirect=detail&code=22079566")}return}this.callView.showCommonRecordMenuPopup(true)}function pe(e){if(this.controller.getUserId()===e.userId){var n=e.commonRecordState.state;var a=this.currentCall.uuid;var r=i.Analytics.AnalyticsType.videoconf;switch(n){case t.CallCommonRecordState.Started:{if(this.commonRecord.state===t.CallCommonRecordState.Resumed){i.Analytics.getInstance().onRecordResumed({callId:a,callType:r,errorCode:null})}else{i.Analytics.getInstance().onRecordStart({callId:a,callType:r,recordType:e.commonRecordState.type,errorCode:null})}break}case t.CallCommonRecordState.Paused:{i.Analytics.getInstance().onRecordPaused({callId:a,callType:r,errorCode:null});break}case t.CallCommonRecordState.Stopped:{i.Analytics.getInstance().onRecordStop({callId:a,callType:r,subSection:i.Analytics.AnalyticsSubSection.window,element:i.Analytics.AnalyticsElement.recordButton,recordTime:t.Util.getRecordTimeText(this.commonRecord.info,true)});break}case t.CallCommonRecordState.Destroyed:{i.Analytics.getInstance().onRecordDelete({callId:a,callType:r,errorCode:null});break}default:{if(t.Util.isCloudRecordLogEnabled()){console.error("Unknown record state: ".concat(status))}}}}if(e.userId&&e.userId!==this.controller.getUserId()){if(e.justJoined){if(e.commonRecordState.state===t.CallCommonRecordState.Started){if(t.CallCloudRecord.isCisRegion){this.callView.showCommonRecordStartNotify(e.userId,t.CallCommonRecordState.Started)}else{this.callView.showCommonRecordStartModal()}}}else{this.callView.showCommonRecordStartNotify(e.userId,e.commonRecordState.state)}}this.commonRecord.state=e.commonRecordState.state;this.callView.setCommonRecordState(e.commonRecordState);this.commonRecord.initiatorId=e.initiatorId;if(t.Util.isCommonRecordStateInactive(e.commonRecordState.state)){this.commonRecord.info=null;this.commonRecord.initiatorId=null}else{this.commonRecord.info=structuredClone(e.commonRecordState)}this.callView.unblockButtons(["record"]);this.callView.setButtonActive("record",[t.CloudRecordStatus.STARTED,t.CloudRecordStatus.PAUSED].includes(e.code))}function me(e){if(F(this,j,oe).call(this)){return}var n=e.commonRecordState,a=e.userId;var r=n.state,o=n.userId;this.commonRecord.state=r;this.callView.setCommonRecordState(n);this.commonRecord.initiatorId=o;if([t.CallCommonRecordState.Stopped,t.CallCommonRecordState.Destroyed].includes(r)){this.commonRecord.initiatorId=null}else{this.commonRecord.info=n}if(!this.commonRecord.notifyShowed&&r===t.CallCommonRecordState.Started&&o!==this.controller.getUserId()){this.commonRecord.notifyShowed=true;this.callView.showCommonRecordStartNotify(o)}if(t.Util.isCommonRecordStateInactive(r)&&o!==this.controller.getUserId()){this.commonRecord.notifyShowed=false}if(!F(this,q,le).call(this)||a!==this.controller.getUserId()){return}var l=r===t.CallCommonRecordState.Started&&o===this.controller.getUserId();var s=r===t.CallCommonRecordState.Stopped;if(l){var c=i.Analytics.AnalyticsType.videoconf;var u=this.currentCall.uuid;var d=this.currentCall.associatedEntity,h=d.id,C=d.name;var f=BX.Main.Date.format(this.params.formatRecordDate||"d.m.Y");var p=b.Loc.getMessage("IM_CALL_RECORD_NAME");if(p){p=p.replace("#CHAT_TITLE#",C).replace("#CALL_ID#",u).replace("#DATE#",f)}else{p="call_record_".concat(u)}this.callEngine.getRestClient().callMethod("call.Call.onStartRecord",{callUuid:this.currentCall.uuid});i.Analytics.getInstance().onRecordStart({callId:u,callType:c,recordType:this.commonRecord.type,errorCode:null});BXDesktopSystem.CallRecordStart({windowId:window.bxdWindowId||window.document.title,fileName:p,callId:u,callDate:f,dialogId:h,dialogName:C,video:this.commonRecord.type!==t.CallCommonRecordType.Audio,muted:t.Hardware.isMicrophoneMuted,cropTop:72,cropBottom:90,shareMethod:"im.disk.record.share",callType:c});return}if(s){i.Analytics.getInstance().onRecordStop({callId:this.currentCall.uuid,callType:i.Analytics.AnalyticsType.videoconf,subSection:i.Analytics.AnalyticsSubSection.window,element:i.Analytics.AnalyticsElement.recordButton,recordTime:t.Util.getRecordTimeText(this.commonRecord.info)});F(this,z,he).call(this)}}function ve(){return{state:t.CallCommonRecordState.Stopped,type:t.CallCommonRecordType.None,initiatorId:null,info:null,notifyShowed:false}}ae.FeatureState={Enabled:"enabled",Disabled:"disabled",Limited:"limited"};e.ConferenceApplication=ae})(this.BX.Messenger.Application=this.BX.Messenger.Application||{},BX.Call,BX.Call.Lib,BX.Call.Lib,BX.Call.Lib,BX.Messenger.Application,BX,BX.Messenger.Application,BX.Messenger,BX.Messenger.v2.Lib,BX.Call.Model,BX.Messenger,BX.Messenger.Lib,BX.Messenger.Lib,BX.Messenger.Lib,BX.Messenger.Lib,BX.Messenger.Lib,BX.Messenger.Const,BX.Call.Const,BX.UI.NotificationManager,BX,BX.UI,BX.UI,BX.UI.Viewer,BX,BX,BX,BX,BX.Main,BX.Event,BX,BX.Messenger.Provider.Pull,BX,BX.Messenger.Lib);
//# sourceMappingURL=conference.bundle.map.js