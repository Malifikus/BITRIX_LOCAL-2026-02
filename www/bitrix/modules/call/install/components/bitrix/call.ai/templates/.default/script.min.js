(function(){BX.namespace("BX.Call.AI");const t=BX.Call.Lib?.Analytics;BX.Call.AI.Tabs={callId:null,tabsList:[],tabTitle:[],tabContents:[],contentWrapper:[],tabButtons:[],taskButtons:[],meetingButtons:[],mensionElements:[],userListAppInstance:null,audioPlayerInstance:{},playbackMarks:[],scrolling:false,scrollTimer:null,lastActiveScrollTab:null,viewedTabs:[],deletePopupInstance:null,init:function(){this.tabsList=document.getElementsByClassName("bx-call-component-call-ai__tab-content");this.callId=document.getElementsByClassName("bx-call-component-call-ai")[0]?.dataset.callId;this.hideAllTabs();this.initEvents();this.initAudioPlayer();this.initUserList();this.initPlaybackMarks();this.initGradeChart();this.initCallAiEfficiencyChart();this.initCallAiEfficiencyValue();this.initScrollEventForInsights();t.getInstance().copilot.onOpenFollowUpSlider({callId:this.callId})},onTabClick:function(t){const{tabId:e,tabName:n}=t.target.dataset;this.hideAllTabs();this.sendOpenFollowUpTabAnalytics(n);for(let t=0;t<this.tabButtons.length;t++){this.tabButtons[t].className=this.tabButtons[t].className.replace(" --active-button","")}document.getElementById(e).style.display="flex";t.currentTarget.className+=" --active-button"},hideAllTabs:function(){for(let t=0;t<this.tabsList.length;t++){this.tabsList[t].style.display="none"}},onCreateTaskClick:function(e){t.getInstance().copilot.onFollowUpCreateTaskClick({callId:this.callId});const{userId:n,description:i,auditors:a}=e.target.dataset;const s=`/company/personal/user/${n}/tasks/task/edit/0/`;BX.SidePanel.Instance.open(s,{requestMethod:"post",requestParams:{AUDITORS:a,DESCRIPTION:i,RESPONSIBLE_ID:n},cacheable:false})},onCreateMeetingClick:function(e){t.getInstance().copilot.onFollowUpCreateEventClick({callId:this.callId});const{meetingDescription:n,meetingId:i,meetingIdType:a}=e.target.dataset;new(window.top.BX||window.BX).Calendar.SliderLoader(0,{entryDescription:n,sliderId:i,type:a}).show()},getTimeInSeconds:function(t){const e=this.playbackMarks[t].innerText.split(/[-\u2014\u2013]/)[0];const[n,i,a]=e.split(":").map(Number).reverse();return a===undefined?i*60+n:a*3600+i*60+n},initEvents:function(){this.tabButtons=document.getElementsByClassName("bx-call-component-call-ai__tab-header-button");for(let t=0;t<this.tabButtons.length;t++){this.tabButtons[t].addEventListener("click",this.onTabClick.bind(this))}if(this.tabButtons.length){this.tabButtons[0].click()}this.tabTitle=document.querySelectorAll(".bx-call-component-call-ai__tab-title");for(let t=0;t<this.tabTitle.length;t++){this.tabTitle[t].addEventListener("click",this.scrollToTab.bind(this))}this.tabContents=document.querySelectorAll(".bx-call-component-call-ai__tab-details");this.contentWrapper=document.querySelector(".bx-call-component-call-ai__tab-content-wrapper");this.contentWrapper.addEventListener("scroll",this.changeTitleForScroll.bind(this));this.taskButtons=document.getElementsByClassName("bx-call-component-call-ai__task-button");for(let t=0;t<this.taskButtons.length;t++){this.taskButtons[t].addEventListener("click",this.onCreateTaskClick.bind(this))}this.meetingButtons=document.getElementsByClassName("bx-call-component-call-ai__meetings-button");for(let t=0;t<this.meetingButtons.length;t++){this.meetingButtons[t].addEventListener("click",this.onCreateMeetingClick.bind(this))}this.mensionElements=document.getElementsByClassName("bx-call-component-call-ai__user-mention");for(let t=0;t<this.mensionElements.length;t++){this.mensionElements[t].addEventListener("click",this.clickMension.bind(this))}const t=document.getElementsByClassName("bx-call-component-call-ai__disclaimer-link");t[0]?.addEventListener("click",this.clickDisclaimer.bind(this));const e=document.getElementsByClassName("bx-call-component-call-ai__delete");e[0]?.addEventListener("click",this.deleteFollowUp.bind(this))},initAudioPlayer:function(){if(!BX.Vue3){return}const e=BX.Vue3.BitrixVue;const n=document.getElementsByClassName("bx-call-component-call-ai__call-audio-record");if(!n.length){return}const i=this.callId;for(let a=0;a<n.length;a++){const{audioSrc:s,audioId:l}=n[a].dataset;if(!s){continue}this.audioPlayerInstance[l]=e.createApp({components:{AudioPlayer:BX.Call.Component.Elements.AudioPlayer},data(){return{audioSrc:s,analyticsCallback:()=>{t.getInstance().copilot.onAIPlayRecord({callId:i})}}},template:`\n\t\t\t\t\t\t<AudioPlayer :src="audioSrc" :analyticsCallback="analyticsCallback" ref="AudioPlayerRef"/>\n\t\t\t\t\t`}).mount(`#bx-call-component-call-ai__call-audio-record-${l}`)}},initUserList:function(){if(!BX.Vue3){return}const t=BX.Vue3.BitrixVue;const e=document.getElementsByClassName("bx-call-component-call-ai-page__title-users-container");if(e.length===0){return}const{callId:n}=e[0].dataset;if(!n){return}t.createApp({components:{UserList:BX.Call.Component.UserList},data(){return{isLoadingUsers:true,callId:n,usersData:[],withBorder:false,withIcon:true}},created(){BX.ajax.runComponentAction("bitrix:call.ai","getUsers",{mode:"ajax",data:{callId:n}}).then((t=>{this.isLoadingUsers=false;this.usersData=Object.values(t.data.users)})).catch((t=>{this.isLoadingUsers=false}))},template:`\n\t\t\t\t\t<UserList :loading="isLoadingUsers" :usersData="usersData" :withBorder="withBorder" :withIcon="withIcon"/>\n\t\t\t\t`}).mount(".bx-call-component-call-ai-page__title-users-container")},initPlaybackMarks:function(){if(Object.keys(this.audioPlayerInstance).length===0){return}this.playbackMarks=document.getElementsByClassName("bx-call-component-call-ai__time-code");Object.keys(this.audioPlayerInstance).forEach((e=>{for(let n=0;n<this.playbackMarks.length;n++){const{audioId:i}=this.playbackMarks[n].dataset;if(i!==e){continue}this.playbackMarks[n].addEventListener("click",(()=>{t.getInstance().copilot.onAIRecordTimeCodeClick({callId:this.callId});this.audioPlayerInstance[e].$refs.AudioPlayerRef.choosePlaybackTime(this.getTimeInSeconds(n))}))}}))},clickMension:function(t){const{userId:e}=t.target.dataset;if(!e){return}BX.Messenger.Public.openChat(e)},clickDisclaimer:function(){const t=top.BX.Helper||window.top.BX.Helper;if(!t){return}if(t.isOpen()){t.close()}const e=top.BX.Call.CallAI||window.top.BX.Call.CallAI;const n=e.disclaimerArticleCode;t.show(`redirect=detail&code=${n}`)},scrollToTab:function(t){this.scrolling=true;const{tabId:e,tabName:n}=t.target.dataset;const i=document.getElementById(e);if(i){for(let t=0;t<this.tabTitle.length;t++){this.tabTitle[t].classList.remove("--active")}t.target.classList.add("--active");const e=i.offsetParent;const a=i.getBoundingClientRect();const s=e.getBoundingClientRect();const l=a.top-s.top+e.scrollTop;const o=parseFloat(window.getComputedStyle(i).marginTop);e.scrollTo({top:l-o,behavior:"smooth"});this.sendOpenFollowUpTabAnalytics(n)}if(this.scrollTimer){clearTimeout(this.scrollTimer);this.scrollTimer=null}this.scrollTimer=setTimeout((()=>{this.scrolling=false;this.scrollTimer=null}),1e3)},changeTitleForScroll:function(){if(this.scrolling){return}let t=null;this.tabContents.forEach(((e,n)=>{const i=e.getBoundingClientRect();const a=this.contentWrapper.getBoundingClientRect();if(i.top<=a.top+100&&i.bottom>=a.top+100){t=this.tabTitle[n]}}));if(this.contentWrapper.scrollTop+this.contentWrapper.clientHeight>=this.contentWrapper.scrollHeight){this.tabContents.forEach(((t,e)=>{this.checkViewedTabs(this.tabTitle[e].dataset.tabName)}));t=this.tabTitle[this.tabContents.length-1]}if(t&&this.lastActiveScrollTab!==t){this.lastActiveScrollTab=t;this.tabTitle.forEach((t=>t.classList.remove("--active")));t.classList.add("--active");this.checkViewedTabs(t.dataset.tabName)}},checkViewedTabs:function(t){if(!this.viewedTabs.includes(t)){this.sendOpenFollowUpTabAnalytics(t);this.viewedTabs.push(t)}},sendOpenFollowUpTabAnalytics:function(e){t.getInstance().copilot.onOpenFollowUpTab({callId:this.callId,tabName:e})},generateGradientElevent:function(t,e,n,i){const a="http://www.w3.org/2000/svg";const s=document.createElementNS(a,i);s.setAttribute("id",t);s.setAttribute("x1","0%");s.setAttribute("y1","0%");s.setAttribute("x2","100%");s.setAttribute("y2","100%");const l=document.createElementNS(a,"stop");l.setAttribute("offset","0%");l.setAttribute("stop-color",e);s.appendChild(l);const o=document.createElementNS(a,"stop");o.setAttribute("offset","100%");o.setAttribute("stop-color",n);s.appendChild(o);const c=document.createElementNS(a,"svg");c.setAttribute("width","0");c.setAttribute("height","0");c.appendChild(s);document.body.appendChild(c);return t},initGradeChart:function(){const t=document.getElementsByClassName("bx-call-component-call-ai__grade-value-wrapper");if(t.length===0){return}let{efficiencyValue:e}=t[0].dataset;if(!e){e=0}this.generateGradientElevent("bx-call-component-call-ai__gradient-primary","#29D887","#30AC73","linearGradient");this.generateGradientElevent("bx-call-component-call-ai__gradient-secondary","#EBF0F3","#DBDBDB","radialGradient");let n=[];let i=[];if(Number(e)===100){n=[{percentage:100}];i=["url(#bx-call-component-call-ai__gradient-primary)"]}else if(Number(e)>0){n=[{percentage:1},{percentage:e},{percentage:1},{percentage:100-e-2}];i=["#F8F6FD","url(#bx-call-component-call-ai__gradient-primary)","#F8F6FD","url(#bx-call-component-call-ai__gradient-secondary)"]}else{n=[{percentage:100}];i=["url(#bx-call-component-call-ai__gradient-secondary)"]}AmCharts.makeChart("bx-call-component-call-ai__grade-chart",{type:"pie",dataProvider:n,titleField:"status",valueField:"percentage",balloonText:"",labelText:"",innerRadius:"85%",colors:i,legend:{enabled:false},responsive:{enabled:true,addDefaultRules:true,rules:[{minWidth:200,minHeight:200,overrides:{innerRadius:"85%"}}]},startDuration:0,width:"100%",height:"100%",pullOutRadius:0,pullOutOnlyOne:false,outlineAlpha:0,startEffect:"elastic",pullOutEffect:"elastic",listeners:[{event:"clickSlice",method:t=>false}]})},deleteFollowUp:function(){if(!BX.Vue3){return}const t=BX.Vue3.BitrixVue;if(this.deletePopupInstance){this.deletePopupInstance.unmount();this.deletePopupInstance=null}const e=this.callId;this.deletePopupInstance=t.createApp({components:{CallActionPopup:BX.Call.Component.Elements.CallActionPopup},data(){return{titleText:BX.Loc.getMessage("CALL_COMPONENT_DELETE_FOLLOWUP_TITLE"),descriptionText:BX.Loc.getMessage("CALL_COMPONENT_DELETE_FOLLOWUP_DESCRIPTION"),okText:BX.Loc.getMessage("CALL_COMPONENT_DELETE_FOLLOWUP_OK_BTN"),okAction:()=>{BX.ajax.runAction("call.FollowUp.drop",{data:{callId:e}}).then((()=>{const t=BX.SidePanel.Instance.getTopSlider();if(t){t.close()}})).catch((t=>{console.error("FollowUp delete error",t)}))}}},template:`\n\t\t\t\t\t<CallActionPopup\n\t\t\t\t\t\t:titleText="titleText"\n\t\t\t\t\t\t:descriptionText="descriptionText"\n\t\t\t\t\t\t:okText="okText"\n\t\t\t\t\t\t:okAction="okAction"\n\t\t\t\t\t/>\n\t\t\t\t`});this.deletePopupInstance.mount(".bx-call-component-call-ai__delete-popup")},initCallAiEfficiencyChart(){class t extends HTMLElement{constructor(){super();this.percent=Number(this.getAttribute("percent")||"0");this.painted=this.getAttribute("painted")==="true"?true:false;this.div=document.createElement("div");this.div.classList.add("bx-call-component-call-ai__efficiency-chart");this.appendChild(this.div)}connectedCallback(){this._observer=new IntersectionObserver((t=>{for(const e of t){if(e.isIntersecting){this.#t(0,this.percent,500);this._observer.disconnect()}}}),{threshold:.5});this._observer.observe(this)}#e(t=0,e=false){const n={gray:"#e6ebef",blue:"#1f86ff",green:"#1bce7b",orange:"#faa72c",red:"#FF5752"};const i=(()=>{if(!e){return n.blue}else if(t>=80){return n.green}else if(t>=50){return n.orange}else if(t>=0){return n.red}else{return n.gray}})();const a=t*3.6;return`conic-gradient(${i} 0deg ${a}deg, ${n.gray} ${a}deg 360deg)`}#t(t,e,n){const i=performance.now();const a=s=>{const l=Math.min((s-i)/n,1);const o=t+(e-t)*l;this.div.style.background=this.#e(o,this.painted);if(l<1){requestAnimationFrame(a)}};requestAnimationFrame(a)}}customElements.define("call-ai-efficiency-chart",t)},initCallAiEfficiencyValue(){class t extends HTMLElement{constructor(){super();this.span=document.createElement("span");this.span.textContent=0;this.appendChild(this.span)}connectedCallback(){this._observer=new IntersectionObserver((t=>{for(const e of t){if(e.isIntersecting){this.#n();this._observer.disconnect()}}}),{threshold:.5});this._observer.observe(this)}#n(){const t=0;const e=Number(this.getAttribute("value"))||0;const n=500;let i=null;const a=e-t;const s=e=>{if(!i)i=e;const l=Math.min((e-i)/n,1);const o=t+a*l;this.span.textContent=o.toFixed(0);if(l<1){requestAnimationFrame(s)}};this.span.textContent=t.toFixed(0);requestAnimationFrame(s)}}customElements.define("call-ai-efficiency-value",t)},initScrollEventForInsights(){const t=document.querySelector(".bx-call-component-call-ai__tab-content-wrapper");if(!t){return}const e=document.querySelectorAll("[data-insights-user-id]");e.forEach((e=>{e.addEventListener("click",(e=>{const n=e.currentTarget.dataset.insightsUserId;const i=document.querySelector(`[data-insights-user-id-full='${n}']`);if(!i){return}const a=t.getBoundingClientRect();const s=i.getBoundingClientRect();const l=s.top-a.top+t.scrollTop-12;t.scrollTo({top:l,behavior:"smooth"})}))}))}};document.addEventListener("DOMContentLoaded",(()=>{BX.Call.AI.Tabs.init()}))})();
//# sourceMappingURL=script.map.js