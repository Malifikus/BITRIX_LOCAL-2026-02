BX.namespace("BX.MailClientConfig");BX.MailClientConfig.Edit={isSuccessSyncStatus:null,oauthUserIsEmpty:true,isOauthMode:false,isForbiddenToShare:false,serviceName:"other",isNewMailbox:true,smtp:{switcherChecked:false,switcherDisabled:false},crm:{integrationAvailable:false,switcherChecked:false,switcherDisabled:false},isCrmIntegrationAvailable:false,isCrmSwitcherChecked:false,canEditCrmOptions:false,init:function(e){if(BX.type.isNotEmptyObject(e)){this.isForbiddenToShare=e.isForbiddenToShare||false;this.smtp.switcherChecked=e.isSmtpSwitcherChecked||false;this.smtp.switcherDisabled=e.isSmtpSwitcherDisabled||false;this.crm.switcherChecked=e.isCrmSwitcherChecked||false;this.crm.switcherDisabled=e.canEditCrmOptions||false;this.crm.integrationAvailable=e.isCrmIntegrationAvailable||false;this.canEditCrmOptions=e.canEditCrmOptions||false;this.oauthUserIsEmpty=e.oauthUserIsEmpty||false;this.isSuccessSyncStatus=null;this.isOauthMode=e.isOauthMode||false;this.ownerId=e.ownerId||0;this.shareAccessSelectorId=e.shareAccessSelectorId||"";this.shareAccessValueContainerId=e.shareAccessValueContainerId||"";this.shareAccessSelectorPreselectedIds=e.shareAccessSelectorPreselectedIds||[];this.isShareAccessLocked=e.isShareAccessLocked||false;this.crmQueueSelectorId=e.crmQueueSelectorId||"";this.crmQueueValueContainerId=e.crmQueueValueContainerId||"";this.crmQueueSelectorPreselectedIds=e.crmQueueSelectorPreselectedIds||[];this.serviceName=e.serviceName||"other";this.isNewMailbox=e.isNewMailbox===true;if(e.isSuccessSyncStatus!==undefined){this.isSuccessSyncStatus=e.isSuccessSyncStatus}const{crmSyncIntervals:t={},leadSourceList:i={},crmEntityList:s={},messageSyncIntervals:n={},defaultMaxCrmSyncKey:r="",defaultMaxAgeMessageSyncKey:c="",defaultLeadSourceKey:a="",defaultNewEntityInKey:o="",defaultNewEntityOutKey:l=""}=e;const d=BX("mail-connect-crm-allow-entity-in");if(d!==null){const e=new BX.Mail.SettingSelector({settingsMap:s,selectedOptionKey:o,inputName:"fields[crm_entity_in]",disabled:this.canEditCrmOptions});e.renderTo(d)}const m=BX("mail-connect-crm-allow-entity-out");if(m!==null){const e=new BX.Mail.SettingSelector({settingsMap:s,selectedOptionKey:l,inputName:"fields[crm_entity_out]",disabled:this.canEditCrmOptions});e.renderTo(m)}const h=BX("mail-connect-crm-lead-source");if(h!==null){const e=new BX.Mail.SettingSelector({settingsMap:i,selectedOptionKey:a,inputName:"fields[crm_lead_source]",dialogOptions:{width:300,height:300,enableSearch:true},disabled:this.canEditCrmOptions});e.renderTo(h)}const u=BX("mail-message-max-age");if(u!==null){const e=new BX.Mail.SettingSelector({settingsMap:n,selectedOptionKey:c,inputName:"fields[msg_max_age]"});e.renderTo(u)}const f=BX("mail-crm-max-age");if(f!==null){const e=new BX.Mail.SettingSelector({settingsMap:t,selectedOptionKey:r,inputName:"fields[crm_max_age]",disabled:this.canEditCrmOptions});e.renderTo(f)}}if(this.isSuccessSyncStatus===false){if(this.isOauthMode){this.showOauthAuthorizationBlock();this.showOauthErrorTour()}else{this.showPasswordErrorTour()}}if(this.isOauthMode&&this.oauthUserIsEmpty){this.showOauthAuthorizationBlock()}var t=BX.findChildrenByClassName(document,"mail-set-singleselect",true);for(var i in t){if(!t.hasOwnProperty(i)){continue}this.singleselect(t[i])}BX.bind(BX("mail_connect_mb_crm_new_lead_for_link"),"click",(function(e){var t=BX("mail_connect_mb_crm_new_lead_for");var i=t.offsetHeight>0;t.style.display=i?"none":"";BX[i?"removeClass":"addClass"](this,"mail-set-textarea-show-open")}));this.setSmtpSwitcher();this.setCrmSwitcher();this.initShareAccessSelector();this.initCrmQueueSelector()},singleselect:function(e){var t=BX.findChildren(e,{tag:"input",attr:{type:"radio"}},true);for(var i in t){if(!t.hasOwnProperty(i)){continue}BX.bind(t[i],"change",(function(){if(this.checked){if(this.value==0){var t=BX(e.getAttribute("data-checked"));if(t){var i=BX.findNextSibling(this,{tag:"label",attr:{for:this.id}});var s=BX.findNextSibling(t,{tag:"label",attr:{for:t.id}});if(i&&s)BX.adjust(i,{text:s.innerHTML})}}else{e.setAttribute("data-checked",this.id)}}}))}BX.bind(e,"click",(function(t){t=t||window.event;t.skip_singleselect=e}));BX.bind(document,"click",(function(t){t=t||window.event;if(t.skip_singleselect!==e){BX(e.getAttribute("data-checked")).checked=true}}))},beforeOpenDialog:function(){return new Promise((function(e,t){if(BX.MailClientConfig.Edit.isForbiddenToShare){BX.MailClientConfig.Edit.alertForbiddenToShare();return t()}return e()}))},alertForbiddenToShare:function(){B24.licenseInfoPopup.show("mail-shared-mailbox-limit",BX.message("MAIL_MAILBOX_LICENSE_SHARED_LIMIT_TITLE"),BX.message("MAIL_MAILBOX_LICENSE_SHARED_LIMIT_BODY"))},setBlockSwitcher(e,t,i,s,n=false){const r=BX(e);const c=BX(i);if(!r||!c){return}const a=c.querySelector(".mail-connect-form-items");const o=c.querySelector(".mail-connect-title-block");if(!a||!o){return}const l=()=>{BX.Dom.hide(a);BX.Dom.addClass(o,"mail-connect-title-hidden-block");BX.Dom.removeClass(c,"mail-connect-section-block")};const d=()=>{BX.Dom.show(a);BX.Dom.removeClass(o,"mail-connect-title-hidden-block");BX.Dom.addClass(c,"mail-connect-section-block")};const m=BX(t);const h=new BX.UI.Switcher({node:r,checked:s,size:"small",disabled:n??false,handlers:{toggled:()=>{if(h.checked===true){d()}else{l()}if(m){m.click()}}}});if(!s){l()}},showOauthErrorTour(){this.oauthErrorTour=new BX.UI.Tour.Guide({id:"mail-config-oauth-error-tour",simpleMode:true,steps:[{target:"#mail_connect_mb_oauth_btn",title:BX.message("MAIL_CONFIG_OAUTH_ERROR_TOUR_TITLE"),text:BX.message("MAIL_CONFIG_OAUTH_ERROR_TOUR_TEXT"),position:"bottom",article:"19083990"}]});this.oauthErrorTour.start()},showPasswordErrorTour(){this.oauthErrorTour=new BX.UI.Tour.Guide({id:"mail-config-password-error-tour",simpleMode:true,steps:[{target:"#mail_password_form_wrapper",title:BX.message("MAIL_CONFIG_PASSWORD_ERROR_TOUR_TITLE"),text:BX.message("MAIL_CONFIG_PASSWORD_ERROR_TOUR_TEXT"),position:"bottom",article:"19083990"}]});this.oauthErrorTour.start()},showOauthAuthorizationBlock(){var e=BX("mail_connect_form");var t=BX("mail-client-config-email-oauth-field-error");var i=BX("mail-client-config-email-oauth-field-success");var s=BX("mail-email-oauth");var n=BX("mail_connect_mb_oauth_field");if(s){BX.hide(s);BX.hide(t);BX.hide(i)}if(n){n.value="N"}if(!e.elements["fields[mailbox_id]"]){var r=BX("mail_connect_mb_name_field");if(!r["__filled"]){r.value=""}}BX.Dom.style(BX("mail_connect_mb_oauth_status"),"display","none");BX.Dom.style(BX("mail_connect_mb_oauth_btn"),"display",null)},setSmtpSwitcher(){this.setBlockSwitcher("mail-connect-smtp-settings-title","mail_connect_mb_server_smtp_switch","mail-connect-section-smtp-block",this.smtp.switcherChecked,this.smtp.switcherDisabled)},setCrmSwitcher(){if(!this.crm.integrationAvailable){return}this.setBlockSwitcher("mail-connect-crm-settings-title","mail_connect_mb_crm_switch","mail-connect-section-crm-block",this.crm.switcherChecked,this.crm.switcherDisabled)},initShareAccessSelector(){const e=document.getElementById(this.shareAccessSelectorId);if(!e){return}e.innerHTML="";const t=()=>{const e=i.getDialog().getSelectedItems();if(BX.type.isArray(e)){const t=e.map((e=>{let t=null;switch(e.entityId){case"department":t=e.id.toString().split(":")[1]==="F"?"D":"DR";break;case"user":t="U";break;default:break}return t?t+e.id.toString().split(":")[0]:null})).filter((e=>e!==null));const i=document.getElementById(this.shareAccessValueContainerId);if(i){i.value=JSON.stringify(t)}}};const i=new BX.UI.EntitySelector.TagSelector({multiple:true,dialogOptions:{context:"MAIL_CLIENT_CONFIG_SHARE_ACCESS",preselectedItems:this.shareAccessSelectorPreselectedIds,undeselectedItems:[["user",this.ownerId]],entities:[{id:"department",options:{selectMode:"usersAndDepartments",allowSelectRootDepartment:true,allowFlatDepartments:true}}],events:{"Item:onSelect":t,"Item:onDeselect":t,onLoad:()=>{if(this.isForbiddenToShare||this.isShareAccessLocked){i.lock()}}}}});i.renderTo(e)},initCrmQueueSelector(){const e=document.getElementById(this.crmQueueSelectorId);if(!e){return}e.innerHTML="";const t=()=>{const e=i.getDialog().getSelectedItems();if(BX.type.isArray(e)){const t=e.map((e=>e.entityId==="user"?`U${e.id}`:null)).filter((e=>e!==null));const i=document.getElementById(this.crmQueueValueContainerId);if(i){i.value=JSON.stringify(t)}}};const i=new BX.UI.EntitySelector.TagSelector({multiple:true,dialogOptions:{context:"MAIL_CLIENT_CONFIG_CRM_QUEUE",preselectedItems:this.crmQueueSelectorPreselectedIds,entities:[{id:"user",options:{inviteEmployeeLink:false,intranetUsersOnly:true}}],events:{"Item:onSelect":t,"Item:onDeselect":t,onLoad:()=>{if(this.canEditCrmOptions){i.lock()}}}}});i.renderTo(e)},sendAnalyticsData(e){if(!BX.UI.Analytics){return}const t=document.getElementById("mail_connect_form");if(!t){return}const i=this.isNewMailbox?"mailbox_connect":"mailbox_edit";const s=t.elements["fields[use_crm]"];const n=t.elements["fields[ical_access]"];const r=s&&s.checked;const c=n&&n.checked;const a=t.elements["fields[share_access]"];let o=false;if(a&&a.value){try{const e=JSON.parse(a.value);if(Array.isArray(e)&&e.length>1){o=true}}catch(e){console.error("Analytics: share_access parse error",e)}}BX.UI.Analytics.sendData({tool:"mail",event:i,type:this.serviceName,category:"mail_general_ops",c_section:"menu",status:e,p1:`integrationCalendar_${c?"true":"false"}`,p2:`integrationCRM_${r?"true":"false"}`,p3:`shared_${o?"true":"false"}`})}};
//# sourceMappingURL=script.map.js