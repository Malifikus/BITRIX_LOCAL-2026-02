{"version":3,"file":"message-body.bundle.js","sources":["../src/message-body.js"],"sourcesContent":["import { Dom, Event } from 'main.core';\n\nexport type MessageBodyOptionsType = {\n\tcontainer: HTMLElement,\n\tmessageId: number,\n\tprefix?: string,\n}\n\nexport class MessageBody\n{\n\t#container: HTMLElement;\n\t#messageId: number;\n\t#prefix: string;\n\t#iframeResizeHandler: ?Function = null;\n\t#iframe: ?HTMLIFrameElement = null;\n\n\tconstructor(options: MessageBodyOptionsType)\n\t{\n\t\tthis.#container = options?.container;\n\t\tthis.#messageId = options?.messageId;\n\n\t\tif (!this.#container || !this.#messageId)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tthis.#prefix = options.prefix || 'mail-msg';\n\t}\n\n\tgetIframeId(): string\n\t{\n\t\treturn `${this.#prefix}-iframe-${this.#messageId}`;\n\t}\n\n\tgetMessageType(): string\n\t{\n\t\treturn `${this.#prefix}-resize-iframe`;\n\t}\n\n\tgetStylesMessageType(): string\n\t{\n\t\treturn `${this.#prefix}-set-styles`;\n\t}\n\n\tgetBodyClass(): string\n\t{\n\t\treturn `${this.#prefix}-view-body`;\n\t}\n\n\tgetQuoteUnfoldedClass(): string\n\t{\n\t\treturn `${this.#prefix}-quote-unfolded`;\n\t}\n\n\tgetIframe(): ?HTMLIFrameElement\n\t{\n\t\treturn this.#iframe;\n\t}\n\n\trenderTo(html: string): void\n\t{\n\t\tconst iframeId = this.getIframeId();\n\n\t\tif (document.getElementById(iframeId))\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tconst iframeContent = this.#buildIframeContent(html);\n\t\tconst blob = new Blob([iframeContent], { type: 'text/html' });\n\t\tconst blobUrl = URL.createObjectURL(blob);\n\n\t\tconst iframe = document.createElement('iframe');\n\t\tiframe.id = iframeId;\n\t\tiframe.src = blobUrl;\n\t\tiframe.width = '100%';\n\t\tiframe.sandbox = 'allow-popups allow-popups-to-escape-sandbox allow-scripts';\n\t\tiframe.referrerPolicy = 'no-referrer';\n\t\tDom.addClass(iframe, `${this.#prefix}-iframe`);\n\n\t\tEvent.bind(iframe, 'load', () => {\n\t\t\tURL.revokeObjectURL(blobUrl);\n\t\t});\n\n\t\tDom.clean(this.#container);\n\t\tDom.append(iframe, this.#container);\n\n\t\tthis.#iframe = iframe;\n\t\tthis.#bindIframeEvents(iframe);\n\t}\n\n\tdestroy(): void\n\t{\n\t\tif (this.#iframeResizeHandler)\n\t\t{\n\t\t\tEvent.unbind(window, 'message', this.#iframeResizeHandler);\n\t\t\tthis.#iframeResizeHandler = null;\n\t\t}\n\n\t\tif (this.#iframe)\n\t\t{\n\t\t\tDom.remove(this.#iframe);\n\t\t\tthis.#iframe = null;\n\t\t}\n\t}\n\n\t#bindIframeEvents(iframe: HTMLIFrameElement): void\n\t{\n\t\tconst sendStylesToIframe = () => {\n\t\t\tif (!iframe || !iframe.contentWindow)\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst computedStyle = getComputedStyle(document.body);\n\t\t\tiframe.contentWindow.postMessage({\n\t\t\t\ttype: this.getStylesMessageType(),\n\t\t\t\tstyles: {\n\t\t\t\t\t'--ui-font-family-primary': computedStyle.getPropertyValue('--ui-font-family-primary'),\n\t\t\t\t\t'--ui-font-family-helvetica': computedStyle.getPropertyValue('--ui-font-family-helvetica'),\n\t\t\t\t\t'--ui-font-weight-bold': computedStyle.getPropertyValue('--ui-font-weight-bold'),\n\t\t\t\t\t'--ui-font-size-md': computedStyle.getPropertyValue('--ui-font-size-md'),\n\t\t\t\t},\n\t\t\t}, '*');\n\t\t};\n\n\t\tEvent.bind(iframe, 'load', sendStylesToIframe);\n\t\tsendStylesToIframe();\n\n\t\tif (!this.#iframeResizeHandler)\n\t\t{\n\t\t\tthis.#iframeResizeHandler = (event) => {\n\t\t\t\tif (event.data && event.data.type === this.getMessageType())\n\t\t\t\t{\n\t\t\t\t\tconst targetIframe = document.getElementById(this.getIframeId());\n\t\t\t\t\tif (targetIframe && event.data.id === this.#messageId)\n\t\t\t\t\t{\n\t\t\t\t\t\tconst newHeight = event.data.height;\n\t\t\t\t\t\tDom.style(targetIframe, 'height', `${newHeight}px`);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t};\n\n\t\t\tEvent.bind(window, 'message', this.#iframeResizeHandler);\n\t\t}\n\t}\n\n\t#buildIframeContent(html: string): string\n\t{\n\t\tconst styles = this.#buildStyles();\n\t\tconst script = this.#buildScript();\n\t\tconst bodyClass = this.getBodyClass();\n\n\t\treturn `\n\t\t\t<!DOCTYPE html>\n\t\t\t<html>\n\t\t\t\t<head>\n\t\t\t\t\t<meta charset=\"UTF-8\">\n\t\t\t\t\t<meta name=\"referrer\" content=\"no-referrer\">\n\t\t\t\t\t<base target=\"_blank\">\n\t\t\t\t\t<style>${styles}</style>\n\t\t\t\t\t<script>${script}</script>\n\t\t\t\t</head>\n\t\t\t\t<body>\n\t\t\t\t\t<div class=\"${bodyClass}\">${html}</div>\n\t\t\t\t</body>\n\t\t\t</html>\n\t\t`;\n\t}\n\n\t#buildStyles(): string\n\t{\n\t\tconst bodyClass = this.getBodyClass();\n\t\tconst quoteUnfoldedClass = this.getQuoteUnfoldedClass();\n\n\t\treturn `\n\t\t\tbody {\n\t\t\t\tmargin: 0;\n\t\t\t\tpadding: 0;\n\t\t\t\tfont-family: var(--ui-font-family-primary, var(--ui-font-family-helvetica)), sans-serif;\n\t\t\t\tfont-size: var(--ui-font-size-md, 14px);\n\t\t\t}\n\t\t\timg { max-width: 100%; height: auto; }\n\t\t\t.${bodyClass} h1 {\n\t\t\t\tcolor: black;\n\t\t\t\tdisplay: block;\n\t\t\t\tfont-size: 2em;\n\t\t\t\tfont-weight: var(--ui-font-weight-bold);\n\t\t\t}\n\t\t\t.${bodyClass} a:-webkit-any-link {\n\t\t\t\tcolor: -webkit-link;\n\t\t\t\ttext-decoration: underline;\n\t\t\t\tcursor: pointer;\n\t\t\t}\n\t\t\t.${bodyClass} {\n\t\t\t\tposition: relative;\n\t\t\t\tpadding: 10px 20px 33px 20px;\n\t\t\t\tcolor: #535c69;\n\t\t\t\toverflow-x: auto;\n\t\t\t\tword-wrap: break-word;\n\t\t\t}\n\t\t\t.${bodyClass} blockquote {\n\t\t\t\tmargin: 0 0 0 5px;\n\t\t\t\tpadding: 5px 5px 5px 8px;\n\t\t\t\tborder-left: 4px solid #e2e3e5;\n\t\t\t}\n\t\t\t.${bodyClass} blockquote:not(.${quoteUnfoldedClass}) {\n\t\t\t\tposition: relative;\n\t\t\t\toverflow: hidden;\n\t\t\t\tbox-sizing: border-box;\n\t\t\t\twidth: 32px;\n\t\t\t\theight: 12px;\n\t\t\t\tmargin: 0 0 0 10px;\n\t\t\t\tborder: none;\n\t\t\t\tcursor: pointer;\n\t\t\t}\n\t\t\t.${bodyClass} blockquote:not(.${quoteUnfoldedClass}):after {\n\t\t\t\tcontent: \"...\";\n\t\t\t\tdisplay: block;\n\t\t\t\tposition: absolute;\n\t\t\t\ttop: 0;\n\t\t\t\tleft: 0;\n\t\t\t\tright: 0;\n\t\t\t\tbottom: 0;\n\t\t\t\tcolor: #535c69;\n\t\t\t\ttext-align: center;\n\t\t\t\tline-height: 12px;\n\t\t\t\tfont-size: 10px;\n\t\t\t\tbackground: #e2e3e5;\n\t\t\t}\n\t\t`;\n\t}\n\n\t#buildScript(): string\n\t{\n\t\tconst messageType = this.getMessageType();\n\t\tconst stylesMessageType = this.getStylesMessageType();\n\t\tconst quoteUnfoldedClass = this.getQuoteUnfoldedClass();\n\n\t\treturn `\n\t\t\tconst MESSAGE_ID = ${this.#messageId};\n\t\t\tconst MESSAGE_TYPE = \"${messageType}\";\n\t\t\tconst STYLES_MESSAGE_TYPE = \"${stylesMessageType}\";\n\t\t\tconst QUOTE_UNFOLDED_CLASS = \"${quoteUnfoldedClass}\";\n\n\t\t\tfunction sendHeight()\n\t\t\t{\n\t\t\t\tconst body = document.body;\n\t\t\t\tconst html = document.documentElement;\n\t\t\t\tconst height = Math.max(\n\t\t\t\t\tbody.scrollHeight, body.offsetHeight,\n\t\t\t\t\thtml.clientHeight, html.scrollHeight, html.offsetHeight\n\t\t\t\t);\n\t\t\t\tparent.postMessage({ type: MESSAGE_TYPE, height: height, id: MESSAGE_ID }, '*');\n\t\t\t}\n\n\t\t\twindow.addEventListener(\"message\", function(event) {\n\t\t\t\tif (event.data && event.data.type === STYLES_MESSAGE_TYPE)\n\t\t\t\t{\n\t\t\t\t\tconst styles = event.data.styles;\n\t\t\t\t\tconst root = document.documentElement;\n\t\t\t\t\tfor (let key in styles)\n\t\t\t\t\t{\n\t\t\t\t\t\tif (styles.hasOwnProperty(key))\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\troot.style.setProperty(key, styles[key]);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\twindow.requestAnimationFrame(sendHeight);\n\t\t\t\t}\n\t\t\t});\n\n\t\t\twindow.addEventListener(\"load\", function() {\n\t\t\t\tconst quotes = document.querySelectorAll(\"blockquote\");\n\t\t\t\tfor (let i = 0; i < quotes.length; i++)\n\t\t\t\t{\n\t\t\t\t\tquotes[i].addEventListener(\"click\", function() {\n\t\t\t\t\t\tthis.classList.add(QUOTE_UNFOLDED_CLASS);\n\t\t\t\t\t\tsendHeight();\n\t\t\t\t\t});\n\t\t\t\t}\n\n\t\t\t\tsendHeight();\n\t\t\t});\n\n\t\t\tconst resizeObserver = new ResizeObserver(() => {\n\t\t\t\tsendHeight();\n\t\t\t});\n\n\t\t\tif (document.body)\n\t\t\t{\n\t\t\t\tresizeObserver.observe(document.body);\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\twindow.addEventListener('DOMContentLoaded', () => resizeObserver.observe(document.body));\n\t\t\t}\n\t\t`;\n\t}\n}\n"],"names":["MessageBody","options","container","messageId","prefix","html","iframeId","getIframeId","document","getElementById","iframeContent","blob","Blob","type","blobUrl","URL","createObjectURL","iframe","createElement","id","src","width","sandbox","referrerPolicy","Dom","addClass","Event","bind","revokeObjectURL","clean","append","unbind","window","remove","sendStylesToIframe","contentWindow","computedStyle","getComputedStyle","body","postMessage","getStylesMessageType","styles","getPropertyValue","event","data","getMessageType","targetIframe","newHeight","height","style","script","bodyClass","getBodyClass","quoteUnfoldedClass","getQuoteUnfoldedClass","messageType","stylesMessageType"],"mappings":"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"}