jn.define("mail/sending-form",((e,t,i)=>{const{WarningBlock:s}=e("layout/ui/warning-block");const{confirmClosing:n}=e("alert");const{Haptics:l}=e("haptics");const{MailContactField:o,MailContactType:r}=e("layout/ui/fields/mail-contact");const{MenuSelectField:a,MenuSelectType:d}=e("layout/ui/fields/menu-select");const{FileField:h}=e("layout/ui/fields/file");const{MultipleField:c}=e("layout/ui/fields/multiple-field");const{TextAreaField:u,TextAreaType:f}=e("layout/ui/fields/textarea");const{WidgetHeaderButton:g}=e("layout/ui/widget-header-button");const{Loc:m}=e("loc");const{NotifyManager:p}=e("notify-manager");const{Type:E}=e("type");const{useCallback:y}=e("utils/function");const{clone:F}=e("utils/object");const{stringify:S}=e("utils/string");const{MessageBody:C}=e("mail/message/elements/messagebody");const{sendMessage:w,getContactsPromise:M}=e("mail/message/tools/connector");const{ActionPanel:b}=e("mail/chain/action-panel");const _=e("apptheme");const A=155;const{MailDialog:I}=e("mail/dialog");const{AjaxMethod:v}=e("mail/const");class L extends LayoutComponent{replaceOldSignatureFromString(e,t){if(!this.currentSignature){return e+t}return e.replace(this.getCurrentSignature(),(()=>t))}buildSignature(e){return`\n--\n${S(e)}`}setCurrentSignature(e=false){this.currentSignature=e}getCurrentSignature(){return this.currentSignature}getSignature(e){const t=this.signatures[e];if(!t||t.trim()===""){return""}return this.buildSignature(t)}getStringWithSignature(e,t,i=false){const s=this.getSignature(t);if(!s){return String(e)}if(i){this.setCurrentSignature(s)}return String(e+s)}setCursorBeforeSignature(e="message",t=""){const i=this.state.compositeFields;const s=i[e].fields[0].value;if(s){const i=s.length-t.length;this.saveCursorPosition(e,i)}else{this.saveCursorPosition(e)}}placeCursorPosition(){const{fieldName:e,position:t=0}=this.cursorPosition;if(e!==undefined){this.fieldRefs.message.setCursorPositionTo(t,t);this.cursorPosition.fieldName=undefined}}saveCursorPosition(e="message",t=0){this.cursorPosition={fieldName:e,position:t}}setSignatureInField(e,t){const i=this.getSignature(t);const s=F(this.state.compositeFields);const n=s[e].fields[0].value;if(i){if(this.getCurrentSignature()){s[e].fields=[{value:this.replaceOldSignatureFromString(n,i)}]}else{s[e].fields=[{value:String(n+i)}]}this.setCurrentSignature(i)}else{s[e].fields=[{value:this.replaceOldSignatureFromString(n,"")}];this.setCurrentSignature()}this.setState({compositeFields:s});this.setCursorBeforeSignature("message",i)}setSignatures(e){e.forEach((e=>{const{signature:t="",email:i}=e;if(i){this.signatures[i]=t}}))}setSenders(e,t){this.senders=e;this.setSignatures(e);this.constants.compositeFields.from.items=this.buildItemListForSelectField(e);this.onChangeField("from",t,{type:d})}entityTypeToFiledType(e){switch(e){case"contacts":return"contact";case"companies":return"company";default:return"email"}}findRecipientByEmail(e,t){for(const i of e){for(let e=0;e<i.email.length;e++){const s=i.email[e];if(s.value===t){return{recipient:i,idInList:e}}}}return null}buildContact(e,t={}){return e.map((e=>{const{value:i=false,customData:s={},isEmailHidden:n}=e;if(i){let e={};let l={};const o=this.findRecipientByEmail(t,i);if(o){const{recipient:e,idInList:t}=o;const{typeName:s="email",id:n,name:r,email:a}=e;l={selectedEmailId:t,email:a,type:this.entityTypeToFiledType(s),id:n,name:r||i}}let r=null;if(s.name){r=s.name}e={customData:s,selectedEmailId:0,email:[{value:i}],id:i,name:r||i,type:"email",isEmailHidden:n,...l};return e}})).filter(Boolean)}#e(e,t){const i=new Set((Array.isArray(t)?t:[]).map((e=>e?.email)).filter(Boolean));if(i.size===0){return Array.isArray(e)?e:[]}return(Array.isArray(e)?e:[]).filter((e=>{const t=e?.customData?.email;if(!t){return false}return!i.has(t)}))}constructor(e){super(e);let{files:t=[],to:i=[],cc:s=[],bcc:n=[],from:l=[]}=e;const{bindingsData:o={},isSendFiles:a,subject:h="",body:c="",replyMessageBody:u,isForward:g=0,senders:p=[],clients:E,clientIdsByType:y,widget:S,ownerEntity:C,isCrmMessage:w}=e;this.isForward=g;const M={idsForFilterCompany:y.company.length>0?y.company:[0],idsForFilterContact:y.contacts.length>0?y.contacts:[0]};this.signatures={};if(!a){this.files=t;t=[]}const b={};const _=t.map((e=>{if(e.id&&Number.isInteger(parseInt(e.id,10))){b[e.id]=F(e);return e.id}return F(e)}));this.senders=p;i=this.#e(i,p);s=this.#e(s,p);n=this.#e(n,p);this.setSignatures(p);this.forwardedFiles=b;this.layout=S;this.replyMessageBody=u;this.isCrmMessage=w;if(this.isEmptyFieldValue(i)&&E&&E.length>0){const e=E[0];if(Array.isArray(e.email)&&e.email.length>0){const t=e.email[0];if(t.value){i=[{value:t.value}]}}}if(this.isEmptyFieldValue(i)&&this.isEmptyFieldValue(s)&&this.isEmptyFieldValue(n)&&(!E||E.length===0)){this.emptyRecipients=true}i=this.buildContact(i,o);s=this.buildContact(s,o);n=this.buildContact(n,o);if(this.isEmptyFieldValue(l)&&p&&p.length>0){l=p}l=this.buildItemListForSelectField(l);const{startEmailSender:A=(l.length>0?l[0].value:null)}=e;this.ownerEntity=C;this.fieldRefs={};this.cursorPosition={fieldName:undefined,position:0};this.recipientsFieldPresetsFromField={companyMode:y.company.length>0,contactMode:y.contacts.length>0,crmMode:!this.isCrmMessage,addressBookMode:!this.isCrmMessage};this.constants={fieldsOutputFormatFull:"full",fieldsOutputFormatLittle:"little",compositeFields:{to:{config:{...M,...this.recipientsFieldPresetsFromField,userMode:!this.isCrmMessage},testId:"message-sending-form-to-field",ref:e=>{this.fieldRefs.to=e},required:true,isComposite:false,type:r,title:m.getMessage("MESSAGE_SEND_FIELD_TO"),placeholder:m.getMessage("MESSAGE_SEND_CONTACT_PLACEHOLDER"),collapsible:false,parentWidget:this.layout},cc:{config:{...M,...this.recipientsFieldPresetsFromField,userMode:true},testId:"message-sending-form-cc-field",ref:e=>{this.fieldRefs.cc=e},required:false,isComposite:false,type:r,title:m.getMessage("MESSAGE_SEND_FIELD_CC"),placeholder:m.getMessage("MESSAGE_SEND_CONTACT_PLACEHOLDER"),collapsible:true,parentWidget:this.layout},bcc:{config:{...M,...this.recipientsFieldPresetsFromField,userMode:true},testId:"message-sending-form-bcc-field",ref:e=>{this.fieldRefs.bcc=e},required:false,isComposite:false,type:r,title:m.getMessage("MESSAGE_SEND_FIELD_BCC"),placeholder:m.getMessage("MESSAGE_SEND_CONTACT_PLACEHOLDER"),collapsible:true,parentWidget:this.layout},from:{testId:"message-sending-form-from-field",ref:e=>{this.fieldRefs.from=e},items:l,required:true,isShowMoreButton:true,showMoreAction:this.expandFormFields.bind(this),isComposite:false,type:d,title:m.getMessage("MESSAGE_SEND_FIELD_FROM"),placeholder:m.getMessage("MESSAGE_SEND_CONTACT_PLACEHOLDER"),collapsible:false},subject:{testId:"message-sending-form-subject-field",requiredErrorMessage:m.getMessage("MESSAGE_SEND_FIELD_SUBJECT_ERROR"),ref:e=>{this.fieldRefs.subject=e},required:true,isComposite:false,type:f,title:m.getMessage("MESSAGE_SEND_FIELD_SUBJECT"),placeholder:m.getMessage("MESSAGE_SEND_FIELD_SUBJECT_PLACEHOLDER"),collapsible:false}}};this.messageIsSent=false;this.isChanged=false;this.state={files:_,fieldsOutputFormat:this.constants.fieldsOutputFormatLittle,compositeFields:{to:{fields:i},cc:{fields:s},bcc:{fields:n},from:{fields:A},subject:{fields:[{value:h}]},message:{fields:[{value:c?`${c} `:this.getStringWithSignature("",A,true)}]}}};this.focusedFieldName=this.getInitialFocusedFieldName();this.handleExitClick=this.handleExitClick.bind(this);this.bindFileRef=this.bindFileRef.bind(this);this.onFileChange=this.onFileChange.bind(this);this.bindMessageBodyRef=this.bindMessageBodyRef.bind(this);this.onChangeMessageBody=this.onChangeMessageBody.bind(this);this.onAttachmentsButton=this.onAttachmentsButton.bind(this)}buildItemListForSelectField(e){const t=[];e.forEach((e=>{const i=e;if(e.hasOwnProperty("value")){i.subtitle=e.value;i.value=e.value;i.id=e.value}else if(e.hasOwnProperty("email")){i.subtitle=e.email;i.value=e.email;i.id=e.email}if(e.hasOwnProperty("name")){i.title=e.name}else{i.subtitle="";i.title=e.email}i.icon='<svg width="18" height="13" viewBox="0 0 18 13" fill="none" xmlns="http://www.w3.org/2000/svg"> <path fill-rule="evenodd" clip-rule="evenodd" d="M1.7386 0.5L8.94327 5.73976L16.1479 0.5H1.7386ZM17.4574 1.80991V2.07942L8.94284 8.7286L0.428223 2.07939V11.8097C0.428223 12.4372 0.976701 12.9444 1.65279 12.9444H16.2328C16.9106 12.9444 17.4574 12.4365 17.4574 11.8097V2.07942L17.4575 2.07939L17.4574 1.80991Z" fill="#6A737F"/> </svg>';t.push(i)}));t.push({id:"add-new-mailbox",title:m.getMessage("MESSAGE_SEND_CONNECT_NEW_MAILBOX"),icon:'<svg width="16" height="15" viewBox="0 0 16 15" fill="none" xmlns="http://www.w3.org/2000/svg"> <path fill-rule="evenodd" clip-rule="evenodd" d="M9.25 0H6.75V6.25H0.5V8.75H6.75V15H9.25V8.75H15.5V6.25H9.25V0Z" fill="#6A737F"/> </svg>'});return t}componentDidUpdate(e,t){this.placeCursorPosition();if(this.focusedFieldName){const e=this.focusedFieldName;this.focusedFieldName=undefined;this.setFocusField(e)}this.refreshSaveButton()}componentDidMount(){this.saveButton=new g({widget:this.layout,text:m.getMessage("MESSAGE_SEND_BUTTON_SEND"),loadingText:m.getMessage("MESSAGE_SEND_BUTTON_SENDING"),onClick:()=>this.sendEmail(),onDisabledClick:()=>this.checkSendEmail(),disabled:()=>this.hasInvalidFields()});this.layout.setLeftButtons(this.getLeftButtons())}getLeftButtons(){return[{svg:{content:'<svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M14.722 6.79175L10.9495 10.5643L9.99907 11.5L9.06666 10.5643L5.29411 6.79175L3.96289 8.12297L10.008 14.1681L16.0532 8.12297L14.722 6.79175Z" fill="#A8ADB4"/></svg>'},callback:this.handleExitClick}]}handleExitClick(){if(this.isClosing){return}if(this.isChanged){this.showConfirmExitEntity((()=>this.sendEmail()),(()=>this.close()))}else{this.close()}}showConfirmExitEntity(e,t){l.impactLight();n({title:m.getMessage("MESSAGE_SEND_EXIT_ALERT_TITLE"),description:m.getMessage("MESSAGE_SEND_EXIT_ALERT_TEXT"),onSave:e,onClose:t})}close(){this.isClosing=true;if(this.layout){this.layout.back();this.layout.close()}}setFocusField(e){if(this.fieldRefs[e]){if(e==="message"){this.fieldRefs[e].setCursorPositionTo()}else{this.fieldRefs[e].focus()}}}refreshSaveButton(){if(this.saveButton){this.saveButton.refresh()}}getInitialFocusedFieldName(){if(this.isEmptyField("subject")){return"subject"}return"message"}isEmptyField(e){const{compositeFields:t}=this.state;const{[e]:i}=t;if(!E.isPlainObject(i)||!i.hasOwnProperty("fields")){throw new Error(`Field ${e} is not found`)}const{fields:s}=i;return this.isEmptyFieldValue(s)}isEmptyFieldValue(e){if(!Array.isArray(e)){return true}return e.every((e=>!e||!E.isStringFilled(e.value)))}renderMessageBodyInput(e){const{ref:t,onChangeFieldAction:i,value:s,key:n}=e;let{additionalParameters:l}=e;const o=false;if(l===undefined){l=[]}return View({style:{minHeight:100,paddingTop:5,paddingBottom:20,paddingLeft:15,paddingRight:15}},u({testId:"message-sending-form-message-body-field",requiredErrorMessage:m.getMessage("MESSAGE_SEND_FIELD_MESSAGE_BODY_ERROR"),ref:t,showRequired:false,required:true,showTitle:false,onChange:y(i,[n]),...l,showLeftIcon:o,value:s,placeholder:m.getMessage("MESSAGE_SEND_FIELD_MESSAGE_BODY_PLACEHOLDER")}))}getOwnerType(){const{ownerType:e}=this.getOwnerEntity();return e}getOwnerEntity(){return this.ownerEntity}getReplyMessageBody(){return this.replyMessageBody}expandFormFields(){this.setState({fieldsOutputFormat:this.constants.fieldsOutputFormatFull})}onChangeField(e,t,i={}){if(e==="from"&&t==="add-new-mailbox"){I.show({type:I.CONNECTING_MAIL_CRM_TYPE,parentWidget:this.layout,successCallback:(e,t)=>{p.showLoadingIndicator();M(Number(this.getOwnerEntity().ownerId),this.getOwnerEntity().ownerType).then((({data:{senders:e}})=>{if(Array.isArray(e)){this.setSenders(e,t)}})).catch(console.error).finally((()=>p.hideLoadingIndicatorWithoutFallback()))}})}else{if(e==="from"){this.setSignatureInField("message",t)}this.isChanged=true;const{type:s}=i;if((!s||s!==d&&s!==r)&&!Array.isArray(t)){t=[{value:S(t)}]}const n=F(this.state.compositeFields);n[e].fields=t;this.setState({compositeFields:n})}}checkSendEmail(){const e=this.validateFields();if(!e){l.notifyWarning();this.focusFirstInvalidField()}return e}validateFields(){if(!this.state.compositeFields.from.fields){return false}let e=true;Object.values(this.fieldRefs).forEach((t=>{if(t&&!t.validate()){e=false}}));return e}focusFirstInvalidField(){const e=[...Object.keys(this.constants.compositeFields),"message"];const t=e.find((e=>{const t=this.fieldRefs[e];return t&&!t.isValid()}));if(t){this.fieldRefs[t].focus()}}hasInvalidFields(){return Object.values(this.fieldRefs).some((e=>e&&!e.isValid()))}sendEmail(){if(this.messageIsSent){return}if(!this.checkSendEmail()){return}this.messageIsSent=true;p.showLoadingIndicator();this.waitUploadingFiles().then((()=>w({isForward:this.isForward,isCrmMessage:this.isCrmMessage??true,senders:this.senders,fileTokens:this.getFileIds(),...this.getOwnerEntity(),...this.state.compositeFields}))).then((()=>{p.hideLoadingIndicator(true);setTimeout((()=>this.close()),300)})).catch((e=>{console.error(e);if(e&&e.hasError){p.hideLoadingIndicatorWithoutFallback();return}const{errors:t}=e||{};p.showErrors(t)})).finally((()=>{this.messageIsSent=false}))}renderCompositeField(e){const{testId:t,requiredErrorMessage:i,required:s,key:n,placeholder:l,title:h,isComposite:f,fieldsOutputFormat:g,collapsible:p,config:E={},fields:F,type:S,onChangeAction:C,showMoreAction:w,isShowMoreButton:M,ref:b,items:I}=e;const v=false;if(g==="little"&&p){return null}let L;const T=M&&g==="little";const B={testId:t,showTitle:false,requiredErrorMessage:i,ref:b,showRequired:false,required:s,placeholder:l,showLeftIcon:v,onChange:y(C,[n])};if(f){let e;switch(S){case d:e=a;break;default:e=u}L=c({addField:{content:`\n\t\t\t\t\t\t\t<svg width="28" height="28" viewBox="0 0 28 28" fill="none" xmlns="http://www.w3.org/2000/svg">\n\t\t\t\t\t\t\t<rect width="28" height="28" rx="14" fill="white" fill-opacity="0.01"/>\n\t\t\t\t\t\t\t<path d="M17.1878 16.6815L17.421 17.8691C17.488 18.2106 17.3065 18.5543 16.9795 18.6733C15.6122 19.1705 14.0705 19.4651 12.4355 19.5003H11.7728C10.1299 19.4649 8.58128 19.1676 7.20917 18.6661C6.89613 18.5517 6.71323 18.2296 6.76649 17.9006C6.81766 17.5845 6.8743 17.2812 6.93213 17.0557C7.12946 16.2864 8.23942 15.7151 9.26073 15.2757C9.52815 15.1607 9.68959 15.0689 9.85269 14.9761C10.012 14.8855 10.173 14.794 10.4358 14.679C10.4656 14.5374 10.4776 14.3927 10.4715 14.2482L10.9239 14.1945C10.9239 14.1945 10.9834 14.3026 10.8879 13.6671C10.8879 13.6671 10.3796 13.5353 10.356 12.5234C10.356 12.5234 9.97377 12.6505 9.95072 12.0373C9.94595 11.9152 9.91438 11.7977 9.88414 11.6852C9.81159 11.4152 9.74664 11.1736 10.0774 10.963L9.83876 10.3267C9.83876 10.3267 9.58774 7.86978 10.6878 8.06868C10.2415 7.36158 14.0056 6.77381 14.2556 8.93889C14.3539 9.59156 14.3539 10.2549 14.2556 10.9076C14.2556 10.9076 14.8179 10.8429 14.4425 11.912C14.4425 11.912 14.2358 12.6815 13.9184 12.5087C13.9184 12.5087 13.9698 13.4811 13.4701 13.646C13.4701 13.646 13.5058 14.1639 13.5058 14.1989L13.9235 14.2613C13.9235 14.2613 13.9108 14.6932 13.9942 14.7399C14.3752 14.9861 14.7929 15.1726 15.2323 15.2929C16.5292 15.6221 17.1878 16.187 17.1878 16.6815Z" fill="#D5D7DB"/>\n\t\t\t\t\t\t\t<path d="M18.6418 9.04982H20.4311V11.2496H22.7224V13.0532H20.4311V15.3624H18.6418V13.0532H16.46V11.2496H18.6418V9.04982Z" fill="#D5D7DB"/>\n\t\t\t\t\t\t\t</svg>\n\t\t\t\t\t\t`},renderField:e,multiple:true,value:F,...B})}else{switch(S){case r:{const e=o({value:F.map((e=>e.id)),readOnly:false,multiple:true,...B,config:{...E,allMarginsWidthInField:A,enableCreation:false,entityList:F.map((e=>({email:e.email,selectedEmailId:e.selectedEmailId,title:e.name,id:e.id,type:e.type,isEmailHidden:e.isEmailHidden})))}});L=View({style:{marginTop:1.3,width:"90%"}},e);break}case d:{const e=a({value:F,required:true,...B,config:{showCancelButton:true,menuTitle:BX.message("MESSAGE_SEND_SELECT_SENDER_TITLE"),menuItems:I,parentWidget:this.props.parentWidget}});L=View({style:{width:T?"73%":"100%"}},e);break}default:L=u({...B,...F[0]});const e=Application.getPlatform()==="ios";L=View({style:{paddingTop:e?1:.5}},L)}}let R=null;if(T){R=View({testId:"message-sending-form-show-copies-btn",style:{height:"100%",paddingRight:16,justifyContent:"center",right:0,position:"absolute"},onClick:w},View({style:{borderBottomWidth:.5,borderBottomColor:_.colors.bgSeparatorPrimary,borderStyle:"dash",borderDashSegmentLength:2,borderDashGapLength:2}},Text({style:{color:_.colors.base5,fontSize:10},text:m.getMessage("MESSAGE_SEND_FIELD_SHOW_MORE").toLocaleUpperCase(env.languageId)})))}return View({onClick:()=>{this.setFocusField(n)},style:{paddingLeft:16,alignItems:"flex-start",flexDirection:"row",borderBottomWidth:.5,borderBottomColor:_.colors.accentSoftBlue3}},View({style:{justifyContent:"center",height:52}},Text({style:{textAlignVertical:"top",color:_.colors.base5,paddingRight:3,fontSize:16},text:`${h}:`})),View({style:{flex:1,minHeight:52}},View({style:{alignItems:"flex-start",flexDirection:"row"}},View({style:{flex:1,paddingTop:f?1:7}},L),R)))}waitUploadingFiles(){const{files:e}=this.fieldRefs;if(e){return e.getValueWhileReady()}return Promise.resolve()}renderAttachments(e){return View({style:{paddingHorizontal:20,display:this.state.files.length===0?"none":"flex",paddingBottom:16}},h({testId:"message-sending-file-field",ref:this.bindFileRef,showTitle:false,showAddButton:false,multiple:true,value:this.state.files,config:{fileInfo:e,mediaType:"file",parentWidget:this.layout,controller:{options:this.getOwnerEntity(),endpoint:this.isCrmMessage?v.crmFileUploader:v.mailFileUploader}},readOnly:false,onChange:this.onFileChange}))}bindFileRef(e){this.fieldRefs.files=e}onFileChange(e){this.isChanged=true;e=Array.isArray(e)?e:[];this.setState({files:e})}getFiles(){return this.state.files}getFileIds(){return this.getFiles().map((e=>{if(typeof e!=="object"){return e}return e.token||e.id}))}renderEmptyRecipientsWarning(){if(this.emptyRecipients&&this.isCrmMessage){return new s({title:m.getMessage("MESSAGE_SEND_WARNING_EMPTY_RECIPIENT_TITLE"),description:m.getMessage("MESSAGE_SEND_WARNING_EMPTY_RECIPIENT_TEXT")})}}render(){const e=[];Object.entries(this.constants.compositeFields).forEach((([t,i])=>{if(t!=="message"){e.push(this.renderCompositeField({key:t,onChangeAction:y((e=>this.onChangeField(t,e,i)),[t]),...i,...this.state.compositeFields[t],fieldsOutputFormat:this.state.fieldsOutputFormat}))}}));return View({resizableByKeyboard:true},this.renderEmptyRecipientsWarning(),ScrollView({style:{backgroundColor:_.colors.bgContentPrimary,flex:1}},View({},View({style:{flexDirection:"row",flexWrap:"wrap"}}),...e,this.renderAttachments(this.forwardedFiles),this.renderMessageBodyInput({ref:this.bindMessageBodyRef,...this.state.compositeFields.message.fields[0],key:"message",onChangeFieldAction:this.onChangeMessageBody}),new C({borderBeforeFiles:true,files:this.files,isHiddenField:true,content:this.getReplyMessageBody()}),new b({indentStub:true}))),new b({withoutStyles:true,actions:{attachmentsButton:this.onAttachmentsButton}}))}bindMessageBodyRef(e){this.fieldRefs.message=e}onChangeMessageBody(e){this.onChangeField("message",e)}onAttachmentsButton(){const{files:e}=this.fieldRefs;if(e){e.openFilePicker()}}}i.exports={SendingForm:L}}));
//# sourceMappingURL=extension.map.js