jn.define("mail/chain",((e,t,s)=>{const i=e("apptheme");const{FriendlyDate:n}=e("layout/ui/friendly-date");const{Moment:a}=e("utils/date");const{dayShortMonth:o,shortTime:l}=e("utils/date/formats");const{throttle:r}=e("utils/function");const{clone:c,isEqual:h}=e("utils/object");const{ActionPanel:d}=e("mail/chain/action-panel");const{Avatar:g}=e("mail/message/elements/avatar");const{Icon:m,MoreButton:u}=e("mail/message/elements/icon");const{ContactList:f}=e("mail/message/elements/contact/list");const{getChainPromise:p,getMessagePromise:w,deleteMessage:C,getMessageNeighbors:b}=e("mail/message/tools/connector");const{MessageBody:y}=e("mail/message/elements/messagebody");const{MailOpener:E}=e("mail/opener");const{NotifyManager:M}=e("notify-manager");const{ContextMenu:S}=e("layout/ui/context-menu");const{AjaxMethod:I}=e("mail/const");const L={fields:{to:BX.message("MESSAGE_VIEW_HEADER_TO"),cc:BX.message("MESSAGE_VIEW_HEADER_CC"),bcc:BX.message("MESSAGE_VIEW_HEADER_BCC")}};const v=18;const T=22;const A=34;const _=8;const x=8;const B=100;const N=24;const R=v+T+A+_+x+B+N;let V=device.screen.width;if(!V){V=360}const F=V-R;const D={incoming:{content:'<svg width="17" height="16" viewBox="0 0 17 16" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M10.5895 11.0083L5.55807 11.0083C2.6143 11.0083 0.219447 8.61342 0.219447 5.66966C0.219447 2.72589 2.6143 0.331034 5.55807 0.331035L8.16949 0.331035L8.17809 2.46648L5.82683 2.46648C4.06115 2.46648 2.62366 3.90397 2.62366 5.66966C2.62366 7.43677 4.06115 8.87283 5.82683 8.87283L10.5852 8.87283L10.5752 4.35972L16.0012 9.78147L10.5995 15.2018L10.5895 11.0083Z" fill="#BDC1C6"/></svg>'},outgoing:{content:'<svg width="17" height="16" viewBox="0 0 17 16" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M6.41049 4.99172H11.4419C14.3857 4.99172 16.7806 7.38658 16.7806 10.3303C16.7806 13.2741 14.3857 15.669 11.4419 15.669H8.83051L8.82192 13.5335H11.1732C12.9389 13.5335 14.3763 12.096 14.3763 10.3303C14.3763 8.56322 12.9389 7.12717 11.1732 7.12717H6.41479L6.42482 11.6403L0.998779 6.21853L6.40046 0.798218L6.41049 4.99172Z" fill="#BDC1C6"/></svg>'}};function j(e){if(e.isRead===false&&e.uidId){e.isRead=true;BX.ajax.runAction(I.mailChangeReadStatus,{data:{ids:[e.uidId],isRead:1}}).catch((()=>{e.isRead=false}))}}function k(e){const t=e.message;if(t.isVisible===false){return null}const s=t.format;let n=null;let a=null;let o=null;if(s==="full"){o=View({style:{height:42}},u({testId:"message-card-in-chain-more-button-in-footer",style:{bottom:5,right:18,position:"absolute"},action:e.showMenuAction.bind(null,e.id,t.id,t.subject,"full")}));if(t.body===undefined||t.attachments===undefined){n=Loader({style:{width:45,height:45,alignSelf:"center",paddingBottom:100},animating:true,size:"large"})}a=t.subject}return View({style:{backgroundColor:i.colors.bgContentPrimary,marginBottom:4,marginTop:4,borderRadius:12}},O({direction:t.direction,subject:t.subject,date:t.date,time:t.time,format:t.format,to:t.to,from:t.from,bcc:t.bcc,cc:t.cc,id:t.id}),a,new y({subject:a,files:t.attachments,isHiddenField:false,format:t.format,content:t.body}),n,o)}function X(e){const t={width:N,height:24};const s={paddingTop:17,paddingRight:x};if(e.direction===2){return View({style:s},Image({style:t,svg:D.outgoing}))}return View({style:s},Image({style:t,svg:D.incoming}))}function O(e){const t=[];const{format:s,from:r,to:c,bcc:h,cc:d,id:m,date:u,subject:p}=e;const w={to:{list:c},cc:{list:d},bcc:{list:h}};t.push(new f({maxWidthTextFiled:F,format:"big",list:r,fieldId:m}));if(s==="full"){t.push(...Object.entries(w).map((([e,t])=>View({style:{flexDirection:"row",center:"center"}},new f({maxWidthTextFiled:F,format:"little",list:t.list,title:L.fields[e]})))))}else{t.push(Text({style:{textAlignVertical:"top",paddingRight:18,marginTop:2,fontWeight:"500",fontSize:14,color:i.colors.base2},text:p}))}function C(e){if(e===undefined){return null}const t=a.createFromTimestamp(e);return new n({timeSeparator:"\r\n",moment:t,defaultFormat:e=>{const t=e.format(o());const s=e.format(l);return`${t}\r\n${s}`},useTimeAgo:true,showTime:true,style:{maxWidth:B,lineHeightMultiple:1.3,textAlign:"center",fontWeight:"400",fontSize:13,color:i.colors.base4}})}function b(e){return View({style:{flex:1,paddingTop:12,paddingLeft:_}},...e)}function y(){const e=r?.[0]?.customData?.name;const t=r?.[0]?.customData?.email;if(e===undefined||e===null){return null}return View({style:{paddingTop:12}},g({fullName:e,email:t,size:A}))}return View({style:{paddingBottom:12,flexDirection:"row",paddingLeft:T,paddingRight:v,width:"100%",backgroundColor:i.colors.bgContentPrimary}},View({style:{flex:1,flexDirection:"row"}},X({direction:e.direction}),y(),b(t)),View({style:{top:11}},C(u)))}class W extends LayoutComponent{constructor(e){const{threadId:t,chain:s,widget:i,isCrmMessage:n,startEmailSender:a=null}=e;super();this.constant={isCrmMessage:n,startEmailSender:a};this.layout=i;this.actions={replyButton:this.replyMessageAction.bind(this),replyAllButton:this.replyAllMessageAction.bind(this),forwardButton:this.forwardAction.bind(this)};if(n){this.actions.moreButton=this.showContextMenu.bind(this)}this.setChain(t,s.list,s.properties,false)}getNeighbors(){return this.neighborChains}setNeighbors(e={}){const{PREV:t=null,NEXT:s=null,needButtonsUpdate:i=false}=e;if(t&&t.ID){this.neighborChains.prevId=Number(t.ID)}else{this.neighborChains.prevId=false}if(s&&s.ID){this.neighborChains.nextId=Number(s.ID)}else{this.neighborChains.nextId=false}if(i){this.layout.setRightButtons(this.getRightButtons())}}flippingChain(e){this.layout.setRightButtons(this.getRightButtons(true));M.showLoadingIndicator();this.uploadChain(e,this.constant.isCrmMessage).then((()=>{M.hideLoadingIndicator(true,"",1)}))}getRightButtons(e=false){const{nextId:t=false,prevId:s=false}=this.getNeighbors();const n=[];if(t){n.push({id:"flipping-up",svg:{content:`<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M17.6676 7.15039L13.1405 11.6774L12 12.8003L10.8811 11.6774L6.35404 7.15039L4.75657 8.74786L12.0107 16.002L19.2649 8.74786L17.6676 7.15039Z" fill="${i.colors.base4}"/></svg>`},callback:e?undefined:this.flippingChain.bind(this,t,this.constant.isCrmMessage)})}else{n.push({id:"flipping-up",svg:{content:`<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M17.6676 7.15039L13.1405 11.6774L12 12.8003L10.8811 11.6774L6.35404 7.15039L4.75657 8.74786L12.0107 16.002L19.2649 8.74786L17.6676 7.15039Z" fill="${i.colors.base6}"/></svg>`}})}if(s){n.push({id:"flipping-down",svg:{content:`<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M6.34319 15.9915L10.8702 11.4644L11.9893 10.3407L13.1296 11.4644L17.6567 15.9915L19.2542 14.394L12 7.13983L4.74585 14.394L6.34319 15.9915Z" fill="${i.colors.base4}"/></svg>`},callback:e?undefined:this.flippingChain.bind(this,s,this.constant.isCrmMessage)})}else{n.push({id:"flipping-down",svg:{content:`<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M6.34319 15.9915L10.8702 11.4644L11.9893 10.3407L13.1296 11.4644L17.6567 15.9915L19.2542 14.394L12 7.13983L4.74585 14.394L6.34319 15.9915Z" fill="${i.colors.base6}"/></svg>`}})}return n}showContextMenu(e=this.lastIncomingCardId,t=this.lastIncomingId,s=this.lastIncomingTitle,i="little"){if(s===undefined){s=""}const n=[{id:"reply",title:BX.message("MESSAGE_VIEW_CONTEXT_MENU_REPLY"),subTitle:"",data:{svgIcon:m("reply")},onClickCallback:()=>{l.close((()=>{this.replyMessageAction(e)}))}},{id:"reply-all",title:BX.message("MESSAGE_VIEW_CONTEXT_MENU_REPLY_ALL"),subTitle:"",data:{svgIcon:m("replyAll")},onClickCallback:()=>{l.close((()=>{this.replyAllMessageAction(e)}))}},{id:"forward",title:BX.message("MESSAGE_VIEW_CONTEXT_MENU_FORWARD"),subTitle:"",data:{svgIcon:m("forward")},onClickCallback:()=>{l.close((()=>{this.forwardAction(e)}))}}];let a=[];if(this.constant.isCrmMessage){a=[{id:"exclude-from-crm",title:BX.message("MESSAGE_VIEW_CONTEXT_MENU_EXCLUDE_FROM_CRM"),subTitle:"",data:{svgIcon:m("exclude")},onClickCallback:()=>{l.close((()=>{this.deleteMessage(e,t,true)}))}},{id:"mark-as-spam",title:BX.message("MESSAGE_VIEW_CONTEXT_MENU_MARK_AS_SPAM"),subTitle:"",data:{svgIcon:m("spam")},onClickCallback:()=>{l.close((()=>{this.deleteMessage(e,t,false,true)}))}},{id:"delete-message",title:BX.message("MESSAGE_VIEW_CONTEXT_MENU_DELETE"),subTitle:"",data:{svgIcon:m("remove")},onClickCallback:()=>{l.close((()=>{this.deleteMessage(e,t)}))}}]}let o;if(i==="full"){o=[...n,...a]}else{o=[...a]}const l=new S({testId:"message-card-in-chain-action-menu",actions:o,params:{title:`${BX.message("MESSAGE_VIEW_CONTEXT_MENU_TITLE_MESSAGE")} ${s}`,showCancelButton:true}});l.show()}getOwnerEntity(e){return{ownerId:Number(this.state.chain[e].ownerId),ownerType:this.state.chain[e].ownerType,ownerTypeId:Number(this.state.chain[e].ownerTypeId)}}getSendersSet(e){return this.getMessage(e).availableSenders}getFiles(e){return this.state.chain[e].attachments}getOwner(e){let t={};if(this.constant.isCrmMessage){t={...this.getOwnerEntity(e)}}t.inResponseToMessage=this.state.chain[e].id;return t}getMessage(e){return{...this.state.chain[e],owner:this.getOwner(e)}}getSubject(e){return this.state.chain[e].subject}getStartEmailSender(e){if(this.constant.startEmailSender!==null){return this.constant.startEmailSender}const t=this.getMessage(e);if(t.replyFromEmail){return t.replyFromEmail}return null}getReplyParams(e){const t=this.getMessage(e);let s=this.clearFromEmployeeEmails(t.from,t.employees);if(s.length===0){s=this.clearFromEmployeeEmails(t.to,t.employees)}return{startEmailSender:this.getStartEmailSender(e),isCrmMessage:this.constant.isCrmMessage,uploadSenders:false,uploadClients:false,isSendFiles:false,files:this.getFiles(e),senders:this.getSendersSet(e),subject:`Re: ${this.getSubject(e)}`,owner:t.owner,contacts:s,reply_message_body:this.getBodyHtml(e)}}clearFromEmployeeEmails(e,t){if(t===undefined){return e}const s=new Set(t.map((e=>e?.customData?.email.toLowerCase())));return e.filter((e=>{const t=e?.customData?.email??e?.email;if(!t){return false}return!s.has(t.toLowerCase())}))}getReplyAllParams(e){const t=this.getMessage(e);return{startEmailSender:this.getStartEmailSender(e),isCrmMessage:this.constant.isCrmMessage,uploadSenders:false,uploadClients:false,isSendFiles:false,files:this.getFiles(e),senders:this.getSendersSet(e),subject:`Re: ${this.getSubject(e)}`,owner:t.owner,contacts:this.clearFromEmployeeEmails([...t.to,...t.from],t.employees),cc:this.clearFromEmployeeEmails([...t.cc,...t.bcc],t.employees),reply_message_body:this.getBodyHtml(e)}}getForwardParams(e){const t=this.getMessage(e);return{startEmailSender:this.getStartEmailSender(e),isCrmMessage:this.constant.isCrmMessage,uploadSenders:false,uploadClients:false,isSendFiles:true,files:this.getFiles(e),senders:this.getSendersSet(e),subject:`Fwd: ${this.getSubject(e)}`,owner:t.owner,reply_message_body:this.getBodyHtml(e),isForward:1}}getBodyHtml(e){const t=this.state.chain;if(t[e].body===undefined){t[e].body=""}return t[e].body}replyMessageAction(e=this.lastIncomingCardId){E.openSend(this.getReplyParams(e))}replyAllMessageAction(e=this.lastIncomingCardId){E.openSend(this.getReplyAllParams(e))}forwardAction(e=this.lastIncomingCardId){E.openSend(this.getForwardParams(e))}hideChainItem(e){const t=c(this.state.chain);if(t[e]){t[e].isVisible=false;if(!h(this.state.chain,t)){this.setState({chain:t})}}}showChainItem(e){const t=c(this.state.chain);if(t[e]){t[e].isVisible=true;if(!h(this.state.chain,t)){this.setState({chain:t})}}}onMessageDelete(){this.messageCount--;if(this.messageCount===0){layout.close()}}onMessageDeleteFailure(e){this.showChainItem(e)}deleteMessage(e,t,s=false,i=false){this.hideChainItem(e);C({id:t,ownerId:this.state.chain[e].ownerId,ownerType:this.state.chain[e].ownerType,successAction:this.onMessageDelete.bind(this),failureAction:this.onMessageDeleteFailure.bind(this,e),excludeFromCrm:s,markAsSpam:i})}loadMessage(e){const t=this.state.chain;if(t[e].body===undefined){w(t[e].id,true,false,this.constant.isCrmMessage).then((t=>{const s=this.state.chain;const i=t.data;s[e].body=i.body;this.setState({chain:s})}))}if(Array.isArray(t[e].attachments)&&t[e].attachments.length===0){t[e].attachments="";w(t[e].id,false,true,this.constant.isCrmMessage).then((t=>{const s=this.state.chain;const i=t.data;s[e].attachments=i.attachments;this.setState({chain:s})}))}}cardTouch(e){const t=c(this.state.chain);let s;if(t[e].format==="minimized"){t[e].format="full";s=true}else{t[e].format="minimized";s=true}if(s){this.loadMessage(e);this.setState({chain:t})}}uploadChain(e){return p(e,this.constant.isCrmMessage).then((({data:t})=>{this.setChain(e,t.list,t.properties,true)}))}uploadNeighbors(e){const{ownerId:t,ownerTypeId:s}=this.getOwnerEntity(0);b(t,s,Number(e)).then((e=>{this.setNeighbors({needButtonsUpdate:true,...e.data})}))}setChain(e,t,s,i=true){this.neighborChains={};this.setNeighbors({needButtonsUpdate:!i});this.messageCount=t.length;this.properties=s;this.lastIncomingCardId=null;this.lastIncomingTitle="";this.lastIncomingId=this.properties.lastIncomingId;t=t.map(((t,s)=>{if(Number(t.id)===Number(this.properties.lastIncomingId)){this.lastIncomingCardId=s;this.lastIncomingTitle=t.subject}if(Number(e)===Number(t.id)){t.format="full";if(this.constant.isCrmMessage===0){j(t)}}else{t.format="minimized"}return t}));if(!h(this.state.chain,t)){if(i){this.setState({chain:t})}else{this.state.chain=t}if(this.constant.isCrmMessage){this.uploadNeighbors(e)}}}render(){const e=this.state.chain;let t=null;let s=null;if(this.properties.lastIncomingId!==null){s=new d({actions:this.actions});t=new d({indentStub:true})}if(e.length===0){return null}const n=[];for(const[t,s]of e.entries()){let e=this.cardTouch.bind(this,t);e=r(e,500,this);n.push(View({testId:"message-card-in-chain",onClick:()=>{if(this.constant.isCrmMessage===0){j(s)}e()}},k({message:s,id:t,showMenuAction:this.showContextMenu.bind(this)})))}return View({},ScrollView({style:{height:"100%",backgroundColor:i.colors.bgContentPrimary}},View({},View({style:{flexDirection:"row",flexWrap:"wrap"}}),...n,t)),s)}}s.exports={MessageChain:W}}));
//# sourceMappingURL=extension.map.js