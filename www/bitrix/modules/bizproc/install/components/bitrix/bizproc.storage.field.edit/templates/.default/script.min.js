this.BX=this.BX||{};this.BX.Bizproc=this.BX.Bizproc||{};(function(e,t,i,s,o){"use strict";var n=babelHelpers.classPrivateFieldLooseKey("collectFormFields");var r=babelHelpers.classPrivateFieldLooseKey("setNestedValue");class a{constructor(e){Object.defineProperty(this,r,{value:d});Object.defineProperty(this,n,{value:l});this.formNode=null;this.errorsContainer=null;this.tabs=new Map;this.container=null;this.inputs=new Map;this.settingsTable=null;this.saveButton=null;this.deleteButton=null;this.skipSave=false;this.inputs=new Map;if(t.Type.isPlainObject(e)){if(e.formName){this.formNode=document.querySelector(`form[data-role="${e.formName}"]`);const t=this.formNode.querySelector("#ui-button-panel-save");if(t){this.saveButton=i.ButtonManager.createFromNode(t)}const s=this.formNode.querySelector("#ui-button-panel-remove");if(s){this.deleteButton=i.ButtonManager.createFromNode(s)}}if(t.Type.isElementNode(e.tabContainer)){this.tabContainer=e.tabContainer}if(t.Type.isDomNode(e.errorsContainer)){this.errorsContainer=e.errorsContainer}if(e.skipSave){this.skipSave=e.skipSave}}this.init();a.instance=this}init(){if(!this.formNode){return}const e=this.getInput("type");if(e){t.Event.bind(e,"change",this.handleUserTypeChange.bind(this))}t.Event.bind(this.formNode,"submit",(e=>{var t;e.preventDefault();const i=(t=e.submitter)==null?void 0:t.name;this.onHandleSubmitForm(i)}));this.fillTabs()}fillTabs(){if(this.tabContainer){const e=this.tabContainer.querySelectorAll(".bizproc-storage-field-edit-tab");e.forEach((e=>{if(e.dataset.tab){this.tabs.set(e.dataset.tab,e)}}))}}resetSaveButton(){if(this.saveButton){t.Dom.removeClass(this.saveButton.getContainer(),"ui-btn-wait")}}resetRemoveButton(){if(this.deleteButton){t.Dom.removeClass(this.deleteButton.getContainer(),"ui-btn-wait")}}onHandleSubmitForm(e){const i=babelHelpers.classPrivateFieldLooseBase(this,n)[n]();const o=i.id>0;const r=e==="remove";if(r){var a,l;s.MessageBox.confirm((a=t.Loc.getMessage("BIZPROC_STORAGE_FIELD_EDIT_CONFIRM_MESSAGE"))!=null?a:"",(e=>{this.sendForm("bizproc.storage.deleteField",{id:i.id},"BIZPROC_STORAGE_FIELD_EDIT_DELETE_MESSAGE",e)}),(l=t.Loc.getMessage("BIZPROC_STORAGE_FIELD_EDIT_CONFIRM_MESSAGE_OK"))!=null?l:"",(e=>{e.close();this.resetRemoveButton()}));return}let d=o?"bizproc.storage.updateField":"bizproc.storage.addField";let h="BIZPROC_STORAGE_FIELD_EDIT_SAVE_MESSAGE";const c={field:i};if(this.skipSave){d="bizproc.storage.getPreparedForm";h="BIZPROC_STORAGE_FIELD_EDIT_ADD_MESSAGE"}c.format=true;this.sendForm(d,c,h)}sendForm(e,i,o,n){t.ajax.runAction(e,{data:i}).then((s=>{if(s.data){var r;top.BX.UI.Notification.Center.notify({content:(r=t.Loc.getMessage(o))!=null?r:""});const a=this.formNode.querySelector('input[name="id"]');if(a&&s.data.id){a.value=s.data.id}if(n){n.close()}this.reloadListSlider();const l=BX.SidePanel.Instance.getTopSlider();if(l){const t=l.getData();const o=e==="bizproc.storage.deleteField"?{id:(i==null?void 0:i.id)||null,action:e}:s.data;t.set("data",o);l.close()}}this.resetSaveButton()})).catch((e=>{var t,i;const o=((t=e.errors)==null?void 0:(i=t[0])==null?void 0:i.message)||"Unknown error";s.MessageBox.alert(o);this.resetSaveButton()}))}reloadListSlider(){const e=this.getSlider();if(e){BX.SidePanel.Instance.postMessage(e,"storage-field-list-update")}}getSlider(){if(t.Reflection.getClass("BX.SidePanel")){return BX.SidePanel.Instance.getSliderByWindow(window)}return null}showTab(e){[...this.tabs.keys()].forEach((i=>{if(i===e){t.Dom.addClass(this.tabs.get(i),"bizproc-storage-field-edit-tab-current")}else{t.Dom.removeClass(this.tabs.get(i),"bizproc-storage-field-edit-tab-current")}}))}handleUserTypeChange(){const e=this.getSelectedUserTypeId();if(!e){return}}getSettingsContainer(){this.container=this.formNode;if(this.container&&!this.settingsContainer){this.settingsContainer=this.container.querySelector('[data-role="bizproc-storage-field-settings-container"]')}return this.settingsContainer}getSelectedUserTypeId(){const e=this.getSelectedOption("type");if(e){return e.value}return null}getSelectedOption(e){const t=this.getInput(e);if(t){const e=[...t.querySelectorAll("option")];const i=t.selectedIndex;return e[i]}return null}adjustVisibility(){const e=this.getSettingsTable();const i=document.querySelector('[data-role="tab-settings"]');if(!e||!i){return}if(e.childElementCount<=0){t.Dom.hide(i)}else{t.Dom.show(i)}const s=this.getSelectedUserTypeId();if(s==="boolean"){this.changeInputVisibility("multiple","none");this.changeInputVisibility("mandatory","none")}else{this.changeInputVisibility("multiple","block");this.changeInputVisibility("mandatory","block")}}changeInputVisibility(e,i){const s=this.getInput(e);if(s&&s.parentElement&&s.parentElement.parentElement){if(i==="block"){t.Dom.show(s.parentElement.parentElement)}else{t.Dom.hide(s.parentElement.parentElement)}}}getInput(e){if(this.formNode){const t=this.formNode.querySelector(`[name="${e}"]`);if(t){this.inputs.set(e,t)}}return this.inputs.get(e)}showErrors(e){let i="";e.forEach((e=>{i+=e}));if(t.Type.isDomNode(this.errorsContainer)){this.errorsContainer.innerText=i;t.Dom.show(this.errorsContainer.parentElement)}else{console.error(i)}}getLoader(){if(!this.loader){this.loader=new o.Loader({size:150})}return this.loader}startProgress(){this.isProgress=true;if(!this.getLoader().isShown()){this.getLoader().show(this.container)}this.hideErrors()}stopProgress(){this.isProgress=false;this.getLoader().hide();setTimeout((()=>{this.saveButton.setWaiting(false);this.resetSaveButton();if(this.deleteButton){this.deleteButton.setWaiting(false);this.resetRemoveButton()}}),200)}hideErrors(){if(t.Type.isDomNode(this.errorsContainer)){this.errorsContainer.innerText="";t.Dom.hide(this.errorsContainer.parentElement)}}static handleLeftMenuClick(e){if(this.instance){this.instance.showTab(e)}}}function l(){const e=this.formNode.querySelectorAll("[disabled]");e.forEach((e=>{e.removeAttribute("disabled")}));const t=new FormData(this.formNode);const i={};const s=this.formNode.querySelectorAll('input[type="checkbox"]');s.forEach((e=>{if(!e.checked){t.set(e.name,"N")}}));for(const[e,s]of t.entries()){babelHelpers.classPrivateFieldLooseBase(this,r)[r](i,e,s)}e.forEach((e=>{e.setAttribute("disabled","disabled")}));return i}function d(e,i,s){const o=i.match(/[^[\]]+/g);if(!o){return}let n=e;for(let e=0;e<o.length-1;e++){const i=o[e];if(!n[i]||!t.Type.isObject(n[i])){n[i]={}}n=n[i]}n[o[o.length-1]]=s}a.instance=null;e.StorageFieldEdit=a})(this.BX.Bizproc.Component=this.BX.Bizproc.Component||{},BX,BX.UI,BX.UI.Dialogs,BX);
//# sourceMappingURL=script.map.js