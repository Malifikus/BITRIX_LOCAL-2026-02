{"version":3,"file":"script.js","sources":["src/storage-edit.js"],"sourcesContent":["import { Type, Dom, Event, Loc } from 'main.core';\nimport { MessageBox } from 'ui.dialogs.messagebox';\n\nimport './style.css';\n\nexport class StorageEdit\n{\n\tstatic instance: ?StorageEdit = null;\n\tformNode: ?HTMLElement = null;\n\ttabContainer: HTMLElement;\n\ttabs: Map<string, Element> = new Map();\n\n\tconstructor(options: {\n\t\tformName: string,\n\t\ttabContainer: ?HTMLElement,\n\t})\n\t{\n\t\tif (Type.isPlainObject(options))\n\t\t{\n\t\t\tif (options.formName)\n\t\t\t{\n\t\t\t\tthis.formNode = document.querySelector(`form[data-role=\"${options.formName}\"]`);\n\t\t\t}\n\n\t\t\tif (Type.isElementNode(options.tabContainer))\n\t\t\t{\n\t\t\t\tthis.tabContainer = options.tabContainer;\n\t\t\t}\n\t\t}\n\n\t\tthis.init();\n\t\tStorageEdit.instance = this;\n\t}\n\n\tinit(): void\n\t{\n\t\tif (!this.formNode)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tEvent.bind(this.formNode, 'submit', (event: Event) => {\n\t\t\tevent.preventDefault();\n\t\t\tconst eventName = event.submitter?.name;\n\t\t\tthis.onHandleSubmitForm(eventName);\n\t\t});\n\n\t\tthis.fillTabs();\n\t}\n\n\tfillTabs(): void\n\t{\n\t\tif (this.tabContainer)\n\t\t{\n\t\t\tconst tabs = this.tabContainer.querySelectorAll('.bizproc-storage-edit-tab');\n\t\t\ttabs.forEach((tabNode: HTMLDivElement) => {\n\t\t\t\tif (tabNode.dataset.tab)\n\t\t\t\t{\n\t\t\t\t\tthis.tabs.set(tabNode.dataset.tab, tabNode);\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t}\n\n\tresetSaveButton(): void\n\t{\n\t\tconst saveButtonNode = this.formNode.querySelector(\n\t\t\t'.main-user-field-edit-buttons #ui-button-panel-save',\n\t\t);\n\t\tif (saveButtonNode)\n\t\t{\n\t\t\tDom.removeClass(saveButtonNode, 'ui-btn-wait');\n\t\t}\n\t}\n\n\tonHandleSubmitForm(eventName: string): void\n\t{\n\t\tconst fields = this.#collectFormFields();\n\t\tconst isUpdate = fields.id > 0;\n\t\tconst isRemove = eventName === 'remove';\n\n\t\tif (isRemove)\n\t\t{\n\t\t\tMessageBox.confirm(\n\t\t\t\tLoc.getMessage('BIZPROC_STORAGE_EDIT_CONFIRM_MESSAGE') ?? '',\n\t\t\t\t(messageBox) => {\n\t\t\t\t\tthis.runAction(\n\t\t\t\t\t\t'bizproc.storage.delete',\n\t\t\t\t\t\t{ id: fields.id },\n\t\t\t\t\t\t'BIZPROC_STORAGE_EDIT_DELETE_MESSAGE',\n\t\t\t\t\t\tmessageBox,\n\t\t\t\t\t);\n\t\t\t\t},\n\t\t\t\tLoc.getMessage('BIZPROC_STORAGE_EDIT_CONFIRM_MESSAGE_OK') ?? '',\n\t\t\t);\n\n\t\t\treturn;\n\t\t}\n\n\t\tconst action = isUpdate ? 'bizproc.storage.update' : 'bizproc.storage.add';\n\n\t\tthis.runAction(\n\t\t\taction,\n\t\t\t{ storageType: fields },\n\t\t\t'BIZPROC_STORAGE_EDIT_SAVE_MESSAGE',\n\t\t);\n\t}\n\n\t#collectFormFields(): Record<string, any>\n\t{\n\t\tconst formData = new FormData(this.formNode);\n\t\tconst fields: Record<string, any> = {};\n\n\t\tfor (const [key, value] of formData.entries())\n\t\t{\n\t\t\tfields[key] = value;\n\t\t}\n\n\t\treturn fields;\n\t}\n\n\trunAction(action: string, data: Object, successMessageCode: string, messageBox?: any): void\n\t{\n\t\tBX.ajax.runAction(action, { data })\n\t\t\t.then((response) => {\n\t\t\t\tif (response.data)\n\t\t\t\t{\n\t\t\t\t\ttop.BX.UI.Notification.Center.notify({\n\t\t\t\t\t\tcontent: Loc.getMessage(successMessageCode) ?? '',\n\t\t\t\t\t});\n\n\t\t\t\t\tconst idNode = this.formNode.querySelector('input[name=\"id\"]');\n\t\t\t\t\tif (idNode && response.data.id)\n\t\t\t\t\t{\n\t\t\t\t\t\tidNode.value = response.data.id;\n\t\t\t\t\t}\n\n\t\t\t\t\tif (messageBox)\n\t\t\t\t\t{\n\t\t\t\t\t\tmessageBox.close();\n\t\t\t\t\t}\n\n\t\t\t\t\tconst slider = BX.SidePanel.Instance.getTopSlider();\n\t\t\t\t\tif (slider)\n\t\t\t\t\t{\n\t\t\t\t\t\tconst dictionary: BX.SidePanel.Dictionary = slider.getData();\n\t\t\t\t\t\tdictionary.set(\n\t\t\t\t\t\t\t'data',\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tstorageId: response.data.id,\n\t\t\t\t\t\t\t\tstorageTitle: response.data.title,\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t);\n\t\t\t\t\t\tslider.close();\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tthis.resetSaveButton();\n\t\t\t})\n\t\t\t.catch((error) => {\n\t\t\t\tMessageBox.alert(error.errors.pop().message);\n\t\t\t\tthis.resetSaveButton();\n\t\t\t});\n\t}\n\n\tshowTab(tabNameToShow: string)\n\t{\n\t\t[...this.tabs.keys()].forEach((tabName: string) => {\n\t\t\tif (tabName === tabNameToShow)\n\t\t\t{\n\t\t\t\tDom.addClass(this.tabs.get(tabName), 'bizproc-storage-edit-tab-current');\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tDom.removeClass(this.tabs.get(tabName), 'bizproc-storage-edit-tab-current');\n\t\t\t}\n\t\t});\n\t}\n\n\tstatic handleLeftMenuClick(tabName: string)\n\t{\n\t\tif (this.instance)\n\t\t{\n\t\t\tthis.instance.showTab(tabName);\n\t\t}\n\t}\n\n\tstatic showStorageFieldList(storageId: number): void\n\t{\n\t\tBX.Runtime\n\t\t\t.loadExtension('bizproc.router')\n\t\t\t.then(({ Router }) => {\n\t\t\t\tconst slider = BX.SidePanel.Instance.getTopSlider(); // TODO temp logic\n\t\t\t\tslider?.close();\n\n\t\t\t\tif (Router?.openStorageFieldList)\n\t\t\t\t{\n\t\t\t\t\tRouter.openStorageFieldList({\n\t\t\t\t\t\trequestMethod: 'get',\n\t\t\t\t\t\trequestParams: { storageId },\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\tconsole.warn('Router or openStorageFieldList method not available');\n\t\t\t\t}\n\t\t\t})\n\t\t\t.catch((e) => console.error(e));\n\t}\n}\n"],"names":["StorageEdit","constructor","options","formNode","tabs","Map","Type","isPlainObject","formName","document","querySelector","isElementNode","tabContainer","init","instance","Event","bind","event","preventDefault","eventName","submitter","name","onHandleSubmitForm","fillTabs","querySelectorAll","forEach","tabNode","dataset","tab","set","resetSaveButton","saveButtonNode","Dom","removeClass","fields","isUpdate","id","isRemove","MessageBox","confirm","Loc","getMessage","messageBox","runAction","action","storageType","data","successMessageCode","BX","ajax","then","response","top","UI","Notification","Center","notify","content","idNode","value","close","slider","SidePanel","Instance","getTopSlider","dictionary","getData","storageId","storageTitle","title","catch","error","alert","errors","pop","message","showTab","tabNameToShow","keys","tabName","addClass","get","handleLeftMenuClick","showStorageFieldList","Runtime","loadExtension","Router","openStorageFieldList","requestMethod","requestParams","console","warn","e","formData","FormData","key","entries"],"mappings":"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"}