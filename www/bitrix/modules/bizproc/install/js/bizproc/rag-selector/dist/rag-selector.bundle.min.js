this.BX=this.BX||{};this.BX.Bizproc=this.BX.Bizproc||{};(function(t,e,r,n,i,o,a,s,u,l,c,d,f){"use strict";function p(){/*! regenerator-runtime -- Copyright (c) 2014-present, Facebook, Inc. -- license (MIT): https://github.com/facebook/regenerator/blob/main/LICENSE */p=function e(){return t};var t={},e=Object.prototype,r=e.hasOwnProperty,n=Object.defineProperty||function(t,e,r){t[e]=r.value},i="function"==typeof Symbol?Symbol:{},o=i.iterator||"@@iterator",a=i.asyncIterator||"@@asyncIterator",s=i.toStringTag||"@@toStringTag";function u(t,e,r){return Object.defineProperty(t,e,{value:r,enumerable:!0,configurable:!0,writable:!0}),t[e]}try{u({},"")}catch(t){u=function t(e,r,n){return e[r]=n}}function l(t,e,r,i){var o=e&&e.prototype instanceof f?e:f,a=Object.create(o.prototype),s=new O(i||[]);return n(a,"_invoke",{value:_(t,r,s)}),a}function c(t,e,r){try{return{type:"normal",arg:t.call(e,r)}}catch(t){return{type:"throw",arg:t}}}t.wrap=l;var d={};function f(){}function h(){}function v(){}var g={};u(g,o,(function(){return this}));var y=Object.getPrototypeOf,m=y&&y(y(S([])));m&&m!==e&&r.call(m,o)&&(g=m);var b=v.prototype=f.prototype=Object.create(g);function E(t){["next","throw","return"].forEach((function(e){u(t,e,(function(t){return this._invoke(e,t)}))}))}function w(t,e){function i(n,o,a,s){var u=c(t[n],t,o);if("throw"!==u.type){var l=u.arg,d=l.value;return d&&"object"==babelHelpers["typeof"](d)&&r.call(d,"__await")?e.resolve(d.__await).then((function(t){i("next",t,a,s)}),(function(t){i("throw",t,a,s)})):e.resolve(d).then((function(t){l.value=t,a(l)}),(function(t){return i("throw",t,a,s)}))}s(u.arg)}var o;n(this,"_invoke",{value:function t(r,n){function a(){return new e((function(t,e){i(r,n,t,e)}))}return o=o?o.then(a,a):a()}})}function _(t,e,r){var n="suspendedStart";return function(i,o){if("executing"===n)throw new Error("Generator is already running");if("completed"===n){if("throw"===i)throw o;return I()}for(r.method=i,r.arg=o;;){var a=r.delegate;if(a){var s=B(a,r);if(s){if(s===d)continue;return s}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if("suspendedStart"===n)throw n="completed",r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);n="executing";var u=c(t,e,r);if("normal"===u.type){if(n=r.done?"completed":"suspendedYield",u.arg===d)continue;return{value:u.arg,done:r.done}}"throw"===u.type&&(n="completed",r.method="throw",r.arg=u.arg)}}}function B(t,e){var r=e.method,n=t.iterator[r];if(undefined===n)return e.delegate=null,"throw"===r&&t.iterator["return"]&&(e.method="return",e.arg=undefined,B(t,e),"throw"===e.method)||"return"!==r&&(e.method="throw",e.arg=new TypeError("The iterator does not provide a '"+r+"' method")),d;var i=c(n,t.iterator,e.arg);if("throw"===i.type)return e.method="throw",e.arg=i.arg,e.delegate=null,d;var o=i.arg;return o?o.done?(e[t.resultName]=o.value,e.next=t.nextLoc,"return"!==e.method&&(e.method="next",e.arg=undefined),e.delegate=null,d):o:(e.method="throw",e.arg=new TypeError("iterator result is not an object"),e.delegate=null,d)}function x(t){var e={tryLoc:t[0]};1 in t&&(e.catchLoc=t[1]),2 in t&&(e.finallyLoc=t[2],e.afterLoc=t[3]),this.tryEntries.push(e)}function L(t){var e=t.completion||{};e.type="normal",delete e.arg,t.completion=e}function O(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(x,this),this.reset(!0)}function S(t){if(t){var e=t[o];if(e)return e.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var n=-1,i=function e(){for(;++n<t.length;)if(r.call(t,n))return e.value=t[n],e.done=!1,e;return e.value=undefined,e.done=!0,e};return i.next=i}}return{next:I}}function I(){return{value:undefined,done:!0}}return h.prototype=v,n(b,"constructor",{value:v,configurable:!0}),n(v,"constructor",{value:h,configurable:!0}),h.displayName=u(v,s,"GeneratorFunction"),t.isGeneratorFunction=function(t){var e="function"==typeof t&&t.constructor;return!!e&&(e===h||"GeneratorFunction"===(e.displayName||e.name))},t.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,v):(t.__proto__=v,u(t,s,"GeneratorFunction")),t.prototype=Object.create(b),t},t.awrap=function(t){return{__await:t}},E(w.prototype),u(w.prototype,a,(function(){return this})),t.AsyncIterator=w,t.async=function(e,r,n,i,o){void 0===o&&(o=Promise);var a=new w(l(e,r,n,i),o);return t.isGeneratorFunction(r)?a:a.next().then((function(t){return t.done?t.value:a.next()}))},E(b),u(b,s,"Generator"),u(b,o,(function(){return this})),u(b,"toString",(function(){return"[object Generator]"})),t.keys=function(t){var e=Object(t),r=[];for(var n in e)r.push(n);return r.reverse(),function t(){for(;r.length;){var n=r.pop();if(n in e)return t.value=n,t.done=!1,t}return t.done=!0,t}},t.values=S,O.prototype={constructor:O,reset:function t(e){if(this.prev=0,this.next=0,this.sent=this._sent=undefined,this.done=!1,this.delegate=null,this.method="next",this.arg=undefined,this.tryEntries.forEach(L),!e)for(var n in this)"t"===n.charAt(0)&&r.call(this,n)&&!isNaN(+n.slice(1))&&(this[n]=undefined)},stop:function t(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function t(e){if(this.done)throw e;var n=this;function i(t,r){return s.type="throw",s.arg=e,n.next=t,r&&(n.method="next",n.arg=undefined),!!r}for(var o=this.tryEntries.length-1;o>=0;--o){var a=this.tryEntries[o],s=a.completion;if("root"===a.tryLoc)return i("end");if(a.tryLoc<=this.prev){var u=r.call(a,"catchLoc"),l=r.call(a,"finallyLoc");if(u&&l){if(this.prev<a.catchLoc)return i(a.catchLoc,!0);if(this.prev<a.finallyLoc)return i(a.finallyLoc)}else if(u){if(this.prev<a.catchLoc)return i(a.catchLoc,!0)}else{if(!l)throw new Error("try statement without catch or finally");if(this.prev<a.finallyLoc)return i(a.finallyLoc)}}}},abrupt:function t(e,n){for(var i=this.tryEntries.length-1;i>=0;--i){var o=this.tryEntries[i];if(o.tryLoc<=this.prev&&r.call(o,"finallyLoc")&&this.prev<o.finallyLoc){var a=o;break}}a&&("break"===e||"continue"===e)&&a.tryLoc<=n&&n<=a.finallyLoc&&(a=null);var s=a?a.completion:{};return s.type=e,s.arg=n,a?(this.method="next",this.next=a.finallyLoc,d):this.complete(s)},complete:function t(e,r){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&r&&(this.next=r),d},finish:function t(e){for(var r=this.tryEntries.length-1;r>=0;--r){var n=this.tryEntries[r];if(n.finallyLoc===e)return this.complete(n.completion,n.afterLoc),L(n),d}},catch:function t(e){for(var r=this.tryEntries.length-1;r>=0;--r){var n=this.tryEntries[r];if(n.tryLoc===e){var i=n.completion;if("throw"===i.type){var o=i.arg;L(n)}return o}}throw new Error("illegal catch attempt")},delegateYield:function t(e,r,n){return this.delegate={iterator:S(e),resultName:r,nextLoc:n},"next"===this.method&&(this.arg=undefined),d}},t}var h=function(){var t=babelHelpers.asyncToGenerator(p().mark((function t(e,r){var n;return p().wrap((function t(i){while(1)switch(i.prev=i.next){case 0:i.next=2;return s.ajax.runAction("bizproc.v2.Integration.Rag.".concat(e),{method:"POST",json:r||{}});case 2:n=i.sent;if(!(n.status==="success")){i.next=5;break}return i.abrupt("return",n.data);case 5:return i.abrupt("return",null);case 6:case"end":return i.stop()}}),t)})));return function e(r,n){return t.apply(this,arguments)}}();var v=function(){function t(){babelHelpers.classCallCheck(this,t)}babelHelpers.createClass(t,null,[{key:"create",value:function t(e,r,n){return h("KnowledgeBase.create",{name:e,description:r,fileIds:n})}},{key:"update",value:function t(e,r,n,i){return h("KnowledgeBase.update",{uid:e,name:r,description:n,fileIds:i})}},{key:"get",value:function t(e){return h("KnowledgeBase.get",{uid:e})}}]);return t}();function g(t,e){if(t===e){return true}if(babelHelpers["typeof"](t)!==babelHelpers["typeof"](e)){return false}if(babelHelpers["typeof"](t)!=="object"||t===null||e===null){return false}var r=Object.keys(t);var n=Object.keys(e);if(r.length!==n.length){return false}for(var i=0,o=r;i<o.length;i++){var a=o[i];if(!g(t[a],e[a])){return false}}return true}var y={name:"RagFileUploader",components:{TileWidgetComponent:u.TileWidgetComponent},props:{knowledgeBaseUid:{type:String,default:""},fileIds:{type:Array,default:function t(){return[]}},readonly:{type:Boolean,default:false},fileIdsReplaces:{type:[Object,null],default:null}},emits:["filesChanged"],computed:{uploaderOptions:function t(){var e=this,r;var n=s.Extension.getSettings("bizproc.rag-selector");return{controller:"bizproc.fileUploader.KnowledgeBaseUploaderController",controllerOptions:{knowledgeBaseUid:this.knowledgeBaseUid},files:this.fileIds,multiple:true,maxFileCount:n.get("maxFilesCount",0),maxFileSize:n.get("maxFileSize",0),autoUpload:true,hiddenFieldsContainer:this.$refs.ragUploaderHiddenFields,acceptedFileTypes:n.get("acceptedFileTypes",[]),events:(r={},babelHelpers.defineProperty(r,l.UploaderEvent.FILE_COMPLETE,(function(){e.emitFilesChanged()})),babelHelpers.defineProperty(r,l.UploaderEvent.FILE_REMOVE,(function(){e.emitFilesChanged()})),r)}},widgetOptions:function t(){return{readonly:this.readonly,hideDropArea:this.readonly}}},watch:{fileIdsReplaces:function t(e){var r,n;if(!s.Type.isObject(e)){return}var i=(r=this.$refs)===null||r===void 0?void 0:(n=r.tileWidget)===null||n===void 0?void 0:n.uploader;if(!i){return}var o=function t(){var e=babelHelpers.slicedToArray(u[a],2),r=e[0],n=e[1];i.getFiles().forEach((function(t){if(t.getServerFileId()===r){t.setServerFileId(n)}}))};for(var a=0,u=Object.entries(e);a<u.length;a++){o()}}},methods:{emitFilesChanged:function t(){var e,r;var n=(e=this.$refs)===null||e===void 0?void 0:(r=e.tileWidget)===null||r===void 0?void 0:r.uploader;if(!n){return}var i=n.getFiles().map((function(t){return t.getServerFileId()}));this.$emit("filesChanged",i)}},template:'\n\t\t<div ref="ragUploaderHiddenFields"></div>\n\t\t<TileWidgetComponent :uploaderOptions="uploaderOptions" :widgetOptions="widgetOptions" ref="tileWidget"/>\n\t'};var m=500;var b={name:"KnowledgeBaseComponent",components:{RagFileUploader:y,BIcon:d.BIcon},props:{base:{type:Object,required:true},saving:{type:Boolean,default:false},error:{type:String,default:""}},emits:["updated","remove"],data:function t(){return{isEditing:false}},computed:{OutlineIcons:function t(){return c.Outline},getCounterValue:function t(){var e=(this.base.description||"").length;return"".concat(e,"/").concat(m)}},created:function t(){if(!this.base.uid){this.isEditing=true}},methods:{onNameInput:function t(e){this.emitUpdate("name",e.target.value)},onDescriptionInput:function t(e){var r=e.target.value;if(r.length>m){r=r.slice(0,m);e.target.value=r}this.emitUpdate("description",r)},onFilesChanged:function t(e){this.emitUpdate("fileIds",e)},emitUpdate:function t(e,r){this.$emit("updated",{name:e,value:r})},switchToEditMode:function t(){if(!this.saving){this.isEditing=true}},showConfirmPopup:function t(){var e=this;var r=new f.MessageBox({message:this.$Bitrix.Loc.getMessage("BIZPROC_JS_RAG_SELECTOR_BASE_DELETE_CONFIRM"),modal:true,buttons:BX.UI.Dialogs.MessageBoxButtons.OK_CANCEL,onOk:function t(r){e.$emit("remove");r.close()},okCaption:this.$Bitrix.Loc.getMessage("BIZPROC_JS_RAG_SELECTOR_BASE_DELETE_OK"),onCancel:function t(e){e.close()},useAirDesign:true,maxWidth:300});r.show()}},template:'\n\t\t<div class="bizproc-rag-selector__base" :class="{\'--view\': !isEditing}">\n\t\t\t<BIcon\n\t\t\t\t:name="OutlineIcons.CROSS_L"\n\t\t\t\t:hoverable="true"\n\t\t\t\t:size="20"\n\t\t\t\tcolor="#a8adb4"\n\t\t\t\t@click="showConfirmPopup()"\n\t\t\t\tdata-test-id="bizproc-rag-selector__knowledge-delete-btn"\n\t\t\t\tclass="bizproc-rag-selector__base-remove-icon"\n\t\t\t/>\n\t\t\t<template v-if="isEditing">\n\t\t\t\t<div v-if="error" class="bizproc-rag-selector__base-error">\n\t\t\t\t\t<span class="ui-alert-message">{{ error }}</span>\n\t\t\t\t</div>\n\t\t\t\t<div class="ui-form-row">\n\t\t\t\t\t<div class="ui-form-label --required">\n\t\t\t\t\t\t<div class="ui-ctl-label-text bizproc-setup-template__label-text">\n\t\t\t\t\t\t\t{{ $Bitrix.Loc.getMessage(\'BIZPROC_JS_RAG_SELECTOR_BASE_NAME_LABEL\') }}\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="ui-form-content">\n\t\t\t\t\t\t<div class="ui-ctl ui-ctl-w100">\n\t\t\t\t\t\t\t<input \n\t\t\t\t\t\t\t\ttype="text" \n\t\t\t\t\t\t\t\tclass="ui-ctl-element"\n\t\t\t\t\t\t\t\t:value="base.name"\n\t\t\t\t\t\t\t\t:disabled="saving"\n\t\t\t\t\t\t\t\t:placeholder="$Bitrix.Loc.getMessage(\'BIZPROC_JS_RAG_SELECTOR_BASE_NAME_PLACEHOLDER\')"\n\t\t\t\t\t\t\t\t@input="onNameInput"\n\t\t\t\t\t\t\t\tdata-test-id="bizproc-rag-selector__name-field"\n\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t<div class="ui-form-row">\n\t\t\t\t\t<div class="ui-form-label --required">\n\t\t\t\t\t\t<div class="ui-ctl-label-text">\n\t\t\t\t\t\t\t{{ $Bitrix.Loc.getMessage(\'BIZPROC_JS_RAG_SELECTOR_BASE_DESCRIPTION_LABEL\') }}\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="ui-form-content">\n\t\t\t\t\t\t<div class="bizproc-setup-template__textarea-wrapper">\n\t\t\t\t\t\t\t<div class="ui-ctl ui-ctl-textarea ui-ctl-w100">\n\t\t\t\t\t\t\t\t<textarea\n\t\t\t\t\t\t\t\t\tclass="ui-ctl-element"\n\t\t\t\t\t\t\t\t\t:value="base.description"\n\t\t\t\t\t\t\t\t\t:disabled="saving"\n\t\t\t\t\t\t\t\t\t:placeholder="$Bitrix.Loc.getMessage(\'BIZPROC_JS_RAG_SELECTOR_BASE_DESCRIPTION_PLACEHOLDER\')"\n\t\t\t\t\t\t\t\t\t@input="onDescriptionInput"\n\t\t\t\t\t\t\t\t\tdata-test-id="bizproc-rag-selector__description-field"\n\t\t\t\t\t\t\t\t></textarea>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t<div class="bizproc-rag-selector__char-counter">\n\t\t\t\t\t\t\t\t{{ getCounterValue }}\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t<div class="ui-form-row --uploader">\n\t\t\t\t\t<div class="ui-form-label --required">\n\t\t\t\t\t\t<div class="ui-ctl-label-text">\n\t\t\t\t\t\t\t{{ $Bitrix.Loc.getMessage(\'BIZPROC_JS_RAG_SELECTOR_BASE_FILE_LABEL\') }}\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="bizproc-rag-selector__base-text">\n\t\t\t\t\t\t{{ $Bitrix.Loc.getMessage(\'BIZPROC_JS_RAG_SELECTOR_BASE_FILE_DESC\') }}\n\t\t\t\t\t</div>\n\t\t\t\t\t<RagFileUploader\n\t\t\t\t\t\t:key="base.uid"\n\t\t\t\t\t\t:readonly="saving"\n\t\t\t\t\t\t:knowledgeBaseUid="base.uid"\n\t\t\t\t\t\t:fileIds="base.fileIds"\n\t\t\t\t\t\t:fileIdsReplaces="base.fileIdsReplaces"\n\t\t\t\t\t\t@filesChanged="onFilesChanged"\n\t\t\t\t\t/>\n\t\t\t\t</div>\n\t\t\t</template>\n\t\t\t<template v-else>\n\t\t\t\t<div v-if="error" class="bizproc-rag-selector__base-error">\n\t\t\t\t\t<span class="ui-alert-message">{{ error }}</span>\n\t\t\t\t</div>\n\t\t\t\t<div class="ui-ctl-label-text">\n\t\t\t\t\t{{ $Bitrix.Loc.getMessage(\'BIZPROC_JS_RAG_SELECTOR_BASE_NAME_VIEW\') }}\n\t\t\t\t</div>\n\t\t\t\t<div class="bizproc-rag-selector__base-view-title" @click="switchToEditMode">{{ base.name }}</div>\n\t\t\t\t<div class="bizproc-rag-selector__base-view-desc">{{ base.description }}</div>\n\t\t\t</template>\n\t\t</div>\n\t'};function E(t,e){var r=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),r.push.apply(r,n)}return r}function w(t){for(var e=1;e<arguments.length;e++){var r=null!=arguments[e]?arguments[e]:{};e%2?E(Object(r),!0).forEach((function(e){babelHelpers.defineProperty(t,e,r[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(r)):E(Object(r)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(r,e))}))}return t}function _(){/*! regenerator-runtime -- Copyright (c) 2014-present, Facebook, Inc. -- license (MIT): https://github.com/facebook/regenerator/blob/main/LICENSE */_=function e(){return t};var t={},e=Object.prototype,r=e.hasOwnProperty,n=Object.defineProperty||function(t,e,r){t[e]=r.value},i="function"==typeof Symbol?Symbol:{},o=i.iterator||"@@iterator",a=i.asyncIterator||"@@asyncIterator",s=i.toStringTag||"@@toStringTag";function u(t,e,r){return Object.defineProperty(t,e,{value:r,enumerable:!0,configurable:!0,writable:!0}),t[e]}try{u({},"")}catch(t){u=function t(e,r,n){return e[r]=n}}function l(t,e,r,i){var o=e&&e.prototype instanceof f?e:f,a=Object.create(o.prototype),s=new O(i||[]);return n(a,"_invoke",{value:w(t,r,s)}),a}function c(t,e,r){try{return{type:"normal",arg:t.call(e,r)}}catch(t){return{type:"throw",arg:t}}}t.wrap=l;var d={};function f(){}function p(){}function h(){}var v={};u(v,o,(function(){return this}));var g=Object.getPrototypeOf,y=g&&g(g(S([])));y&&y!==e&&r.call(y,o)&&(v=y);var m=h.prototype=f.prototype=Object.create(v);function b(t){["next","throw","return"].forEach((function(e){u(t,e,(function(t){return this._invoke(e,t)}))}))}function E(t,e){function i(n,o,a,s){var u=c(t[n],t,o);if("throw"!==u.type){var l=u.arg,d=l.value;return d&&"object"==babelHelpers["typeof"](d)&&r.call(d,"__await")?e.resolve(d.__await).then((function(t){i("next",t,a,s)}),(function(t){i("throw",t,a,s)})):e.resolve(d).then((function(t){l.value=t,a(l)}),(function(t){return i("throw",t,a,s)}))}s(u.arg)}var o;n(this,"_invoke",{value:function t(r,n){function a(){return new e((function(t,e){i(r,n,t,e)}))}return o=o?o.then(a,a):a()}})}function w(t,e,r){var n="suspendedStart";return function(i,o){if("executing"===n)throw new Error("Generator is already running");if("completed"===n){if("throw"===i)throw o;return I()}for(r.method=i,r.arg=o;;){var a=r.delegate;if(a){var s=B(a,r);if(s){if(s===d)continue;return s}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if("suspendedStart"===n)throw n="completed",r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);n="executing";var u=c(t,e,r);if("normal"===u.type){if(n=r.done?"completed":"suspendedYield",u.arg===d)continue;return{value:u.arg,done:r.done}}"throw"===u.type&&(n="completed",r.method="throw",r.arg=u.arg)}}}function B(t,e){var r=e.method,n=t.iterator[r];if(undefined===n)return e.delegate=null,"throw"===r&&t.iterator["return"]&&(e.method="return",e.arg=undefined,B(t,e),"throw"===e.method)||"return"!==r&&(e.method="throw",e.arg=new TypeError("The iterator does not provide a '"+r+"' method")),d;var i=c(n,t.iterator,e.arg);if("throw"===i.type)return e.method="throw",e.arg=i.arg,e.delegate=null,d;var o=i.arg;return o?o.done?(e[t.resultName]=o.value,e.next=t.nextLoc,"return"!==e.method&&(e.method="next",e.arg=undefined),e.delegate=null,d):o:(e.method="throw",e.arg=new TypeError("iterator result is not an object"),e.delegate=null,d)}function x(t){var e={tryLoc:t[0]};1 in t&&(e.catchLoc=t[1]),2 in t&&(e.finallyLoc=t[2],e.afterLoc=t[3]),this.tryEntries.push(e)}function L(t){var e=t.completion||{};e.type="normal",delete e.arg,t.completion=e}function O(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(x,this),this.reset(!0)}function S(t){if(t){var e=t[o];if(e)return e.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var n=-1,i=function e(){for(;++n<t.length;)if(r.call(t,n))return e.value=t[n],e.done=!1,e;return e.value=undefined,e.done=!0,e};return i.next=i}}return{next:I}}function I(){return{value:undefined,done:!0}}return p.prototype=h,n(m,"constructor",{value:h,configurable:!0}),n(h,"constructor",{value:p,configurable:!0}),p.displayName=u(h,s,"GeneratorFunction"),t.isGeneratorFunction=function(t){var e="function"==typeof t&&t.constructor;return!!e&&(e===p||"GeneratorFunction"===(e.displayName||e.name))},t.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,h):(t.__proto__=h,u(t,s,"GeneratorFunction")),t.prototype=Object.create(m),t},t.awrap=function(t){return{__await:t}},b(E.prototype),u(E.prototype,a,(function(){return this})),t.AsyncIterator=E,t.async=function(e,r,n,i,o){void 0===o&&(o=Promise);var a=new E(l(e,r,n,i),o);return t.isGeneratorFunction(r)?a:a.next().then((function(t){return t.done?t.value:a.next()}))},b(m),u(m,s,"Generator"),u(m,o,(function(){return this})),u(m,"toString",(function(){return"[object Generator]"})),t.keys=function(t){var e=Object(t),r=[];for(var n in e)r.push(n);return r.reverse(),function t(){for(;r.length;){var n=r.pop();if(n in e)return t.value=n,t.done=!1,t}return t.done=!0,t}},t.values=S,O.prototype={constructor:O,reset:function t(e){if(this.prev=0,this.next=0,this.sent=this._sent=undefined,this.done=!1,this.delegate=null,this.method="next",this.arg=undefined,this.tryEntries.forEach(L),!e)for(var n in this)"t"===n.charAt(0)&&r.call(this,n)&&!isNaN(+n.slice(1))&&(this[n]=undefined)},stop:function t(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function t(e){if(this.done)throw e;var n=this;function i(t,r){return s.type="throw",s.arg=e,n.next=t,r&&(n.method="next",n.arg=undefined),!!r}for(var o=this.tryEntries.length-1;o>=0;--o){var a=this.tryEntries[o],s=a.completion;if("root"===a.tryLoc)return i("end");if(a.tryLoc<=this.prev){var u=r.call(a,"catchLoc"),l=r.call(a,"finallyLoc");if(u&&l){if(this.prev<a.catchLoc)return i(a.catchLoc,!0);if(this.prev<a.finallyLoc)return i(a.finallyLoc)}else if(u){if(this.prev<a.catchLoc)return i(a.catchLoc,!0)}else{if(!l)throw new Error("try statement without catch or finally");if(this.prev<a.finallyLoc)return i(a.finallyLoc)}}}},abrupt:function t(e,n){for(var i=this.tryEntries.length-1;i>=0;--i){var o=this.tryEntries[i];if(o.tryLoc<=this.prev&&r.call(o,"finallyLoc")&&this.prev<o.finallyLoc){var a=o;break}}a&&("break"===e||"continue"===e)&&a.tryLoc<=n&&n<=a.finallyLoc&&(a=null);var s=a?a.completion:{};return s.type=e,s.arg=n,a?(this.method="next",this.next=a.finallyLoc,d):this.complete(s)},complete:function t(e,r){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&r&&(this.next=r),d},finish:function t(e){for(var r=this.tryEntries.length-1;r>=0;--r){var n=this.tryEntries[r];if(n.finallyLoc===e)return this.complete(n.completion,n.afterLoc),L(n),d}},catch:function t(e){for(var r=this.tryEntries.length-1;r>=0;--r){var n=this.tryEntries[r];if(n.tryLoc===e){var i=n.completion;if("throw"===i.type){var o=i.arg;L(n)}return o}}throw new Error("illegal catch attempt")},delegateYield:function t(e,r,n){return this.delegate={iterator:S(e),resultName:r,nextLoc:n},"next"===this.method&&(this.arg=undefined),d}},t}var B="Bizproc:SetupTemplate:beforeSubmit";var x=Object.freeze({REQUIRED:"required",LOADING:"loading"});var L={name:"RagAppComponent",components:{KnowledgeBaseComponent:b,UiButton:n.Button},props:{existedKnowledgeBases:{type:Array,default:function t(){return[]}},modelValue:{type:[Array,String],default:function t(){return[]}},isMultiple:{type:Boolean,default:false},isRequired:{type:Boolean,default:false}},emits:["update:modelValue"],data:function t(){var e;return{bases:(e=this.existedKnowledgeBases)!==null&&e!==void 0?e:[],isSaving:false,isLoading:false,errorType:null,errorMessage:"",baseErrors:[]}},computed:{AirButtonStyle:function t(){return n.AirButtonStyle},ButtonSize:function t(){return n.ButtonSize},buttonAddBaseText:function t(){return this.$Bitrix.Loc.getMessage("BIZPROC_JS_RAG_SELECTOR_ADD_KNOWLEDGE_BASE_BUTTON_TEXT")},isRagAvailable:function t(){var e=s.Extension.getSettings("bizproc.rag-selector");return e.get("isAvailable",false)},basesCount:function t(){return this.bases.length},maxBasesCount:function t(){if(this.isMultiple){var e=s.Extension.getSettings("bizproc.rag-selector");return e.get("maxBasesCountPerField",1)}return 1},showAddButton:function t(){return this.basesCount<this.maxBasesCount},loadingErrorText:function t(){if(this.errorType===x.LOADING){return this.errorMessage}return""},isRequiredError:function t(){return this.errorType===x.REQUIRED}},watch:{modelValue:function t(e,r){if(!g(e,r)){this.loadInitialBases()}},bases:{handler:function t(){this.clearError()},deep:true}},mounted:function t(){var e=this;return babelHelpers.asyncToGenerator(_().mark((function t(){var n;return _().wrap((function t(i){while(1)switch(i.prev=i.next){case 0:r.EventEmitter.subscribe(B,e.onSendAll);n=BX.SidePanel.Instance.getTopSlider();if(n){r.EventEmitter.subscribe(n,"SidePanel.Slider:onClose",e.cleanupSubscriptions)}i.next=5;return e.loadInitialBases();case 5:case"end":return i.stop()}}),t)})))()},beforeUnmount:function t(){this.cleanupSubscriptions()},methods:{loadInitialBases:function t(){var e=this;return babelHelpers.asyncToGenerator(_().mark((function t(){var r,n,i;return _().wrap((function t(o){while(1)switch(o.prev=o.next){case 0:r=s.Type.isArray(e.modelValue)?e.modelValue:[e.modelValue];n=r.filter(Boolean);if(!(n.length===0)){o.next=4;break}return o.abrupt("return");case 4:e.isLoading=true;o.prev=5;i=n.map((function(t){return v.get(t)}));o.next=9;return Promise.all(i);case 9:e.bases=o.sent;o.next=16;break;case 12:o.prev=12;o.t0=o["catch"](5);e.errorMessage=e.getErrorFromResponse(o.t0);e.errorType=x.LOADING;case 16:o.prev=16;e.isLoading=false;return o.finish(16);case 19:case"end":return o.stop()}}),t,null,[[5,12,16,19]])})))()},getErrorFromResponse:function t(e){if(!e.errors){return""}if(!s.Type.isArrayFilled(e.errors)){return this.$Bitrix.Loc.getMessage("BIZPROC_JS_RAG_SELECTOR_LOAD_BASES_ERROR")}var r=babelHelpers.slicedToArray(e.errors,1),n=r[0];return n.message},onAddBase:function t(){this.bases.push(this.makeEmptyKnowledgeBase())},makeEmptyKnowledgeBase:function t(){return{uid:"",name:"",description:"",fileIds:[],fileIdsReplaces:null}},onBasePropertyUpdated:function t(e,r){if(!this.bases[e]){return}var n=this.bases[e];var i=n[r.name];if(g(i,r.value)){return}var o=babelHelpers.toConsumableArray(this.baseErrors);if(o[e]){o[e]=""}this.baseErrors=o;n[r.name]=r.value},onBaseRemove:function t(e){this.bases.splice(e,1);this.clearError()},emitIds:function t(){var e=this.bases.map((function(t){return t.uid})).filter(Boolean);this.$emit("update:modelValue",e)},validate:function t(){var e=this;this.clearError();var r=[];var n=true;if(this.isRequired&&this.bases.length===0){this.errorMessage=this.$Bitrix.Loc.getMessage("BIZPROC_JS_RAG_SELECTOR_VALIDATION_REQUIRED");this.errorType=x.REQUIRED;return false}this.bases.forEach((function(t,i){if(e.isBaseIncomplete(t)){r[i]=e.$Bitrix.Loc.getMessage("BIZPROC_JS_RAG_SELECTOR_VALIDATION_INCOMPLETE");n=false}else{r[i]=""}}));this.baseErrors=r;return n},isBaseIncomplete:function t(e){return!s.Type.isString(e.name)||e.name.trim()===""||!s.Type.isString(e.description)||e.description.trim()===""||!s.Type.isArrayFilled(e.fileIds)},onSendAll:function t(){var e=this;return babelHelpers.asyncToGenerator(_().mark((function t(){var r,n,i,o;return _().wrap((function t(a){while(1)switch(a.prev=a.next){case 0:if(e.validate()){a.next=2;break}return a.abrupt("return",false);case 2:e.isSaving=true;a.prev=3;r=0;case 5:if(!(r<e.bases.length)){a.next=16;break}n=e.bases[r];a.next=9;return e.saveBase(n);case 9:i=a.sent;o=babelHelpers.toConsumableArray(e.bases);o[r]=i;e.bases=o;case 13:r++;a.next=5;break;case 16:e.emitIds();case 17:a.prev=17;e.isSaving=false;return a.finish(17);case 20:return a.abrupt("return",true);case 21:case"end":return a.stop()}}),t,null,[[3,,17,20]])})))()},saveBase:function t(e){if(e.uid){return this.updateBase(e)}return this.createBase(e)},createBase:function t(e){return babelHelpers.asyncToGenerator(_().mark((function t(){var r;return _().wrap((function t(n){while(1)switch(n.prev=n.next){case 0:n.next=2;return v.create(e.name,e.description,e.fileIds);case 2:r=n.sent;return n.abrupt("return",w(w({},e),{},{fileIds:r.fileIds,uid:r.uid,fileIdsReplaces:r.fileIdsReplaces}));case 4:case"end":return n.stop()}}),t)})))()},updateBase:function t(e){return babelHelpers.asyncToGenerator(_().mark((function t(){var r;return _().wrap((function t(n){while(1)switch(n.prev=n.next){case 0:n.next=2;return v.update(e.uid,e.name,e.description,e.fileIds);case 2:r=n.sent;return n.abrupt("return",w(w({},e),{},{fileIds:r.fileIds,fileIdsReplaces:r.fileIdsReplaces}));case 4:case"end":return n.stop()}}),t)})))()},clearError:function t(){this.errorType=null;this.errorMessage="";this.baseErrors=[]},cleanupSubscriptions:function t(){r.EventEmitter.unsubscribe(B,this.onSendAll);var e=BX.SidePanel.Instance.getTopSlider();if(e){r.EventEmitter.unsubscribe(e,"SidePanel.Slider:onClose",this.cleanupSubscriptions)}}},template:'\n\t\t<div v-if="!isRagAvailable" class="ui-alert ui-alert-danger">\n\t\t\t<span class="ui-alert-message">{{ $Bitrix.Loc.getMessage(\'BIZPROC_JS_RAG_SELECTOR_NOT_AVAILABLE_ERROR\') }}</span>\n\t\t</div>\n\t\t<template v-else>\n\t\t\t<div v-if="loadingErrorText" class="ui-alert ui-alert-danger">\n\t\t\t\t<span class="ui-alert-message">{{ loadingErrorText }}</span>\n\t\t\t</div>\n\t\t\t<KnowledgeBaseComponent\n\t\t\t\tv-for="(base, index) in bases"\n\t\t\t\t:key="base.uid"\n\t\t\t\t:base="base"\n\t\t\t\t:saving="isSaving"\n\t\t\t\t:error="baseErrors[index] ?? \'\'"\n\t\t\t\t@updated="onBasePropertyUpdated(index, $event)"\n\t\t\t\t@remove="onBaseRemove(index)"\n\t\t\t/>\n\t\t\t<UiButton\n\t\t\t\tv-if="showAddButton"\n\t\t\t\t:text="buttonAddBaseText" \n\t\t\t\t:disabled="isSaving"\n\t\t\t\t:style="AirButtonStyle.OUTLINE_ACCENT_2"\n\t\t\t\t:size="ButtonSize.SMALL"\n\t\t\t\t@click="onAddBase"\n\t\t\t\ttype="button"\n\t\t\t/>\n\t\t\t<div v-if="isRequiredError" class="bizproc-setup-template__error-text">\n\t\t\t\t<div class="ui-icon-set --warning"></div>\n\t\t\t\t{{ errorMessage }}\n\t\t\t</div>\n\t\t</template>\n\t'};function O(t){var r=arguments.length>1&&arguments[1]!==undefined?arguments[1]:false;var n=arguments.length>2&&arguments[2]!==undefined?arguments[2]:[];var i=e.BitrixVue.createApp(L,{isMultiple:r,existedKnowledgeBases:n});i.mount(t)}t.initRagDevApp=O;t.RagAppComponent=L})(this.BX.Bizproc.RagSelector=this.BX.Bizproc.RagSelector||{},BX.Vue3,BX.Event,BX.Vue3.Components,BX.UI,BX,BX.UI,BX,BX.UI.Uploader,BX.UI.Uploader,BX.UI.IconSet,BX.UI.IconSet,BX.UI.Dialogs);
//# sourceMappingURL=rag-selector.bundle.map.js