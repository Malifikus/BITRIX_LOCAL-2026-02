{"version":3,"file":"settings.bundle.js","sources":["../src/settings.js"],"sourcesContent":["import { Core } from 'im.v2.application.core';\nimport { RestMethod, UserStatus, NotificationSettingsMode, Settings } from 'im.v2.const';\nimport { Logger } from 'im.v2.lib.logger';\nimport { runAction } from 'im.v2.lib.rest';\n\nexport type NotificationSubscriptionOptions = {\n\tnotifyModule: string;\n\tnotifyEvent: string;\n\tshouldSubscribe: boolean;\n\tlastSubscribedTypes: Array<string>;\n};\n\nexport class SettingsService\n{\n\tchangeSetting(settingName: string, value: any): void\n\t{\n\t\tLogger.warn('SettingsService: changeSetting', settingName, value);\n\t\tvoid Core.getStore().dispatch('application/settings/set', {\n\t\t\t[settingName]: value,\n\t\t});\n\n\t\tconst payload = {\n\t\t\tdata: {\n\t\t\t\tuserId: Core.getUserId(),\n\t\t\t\tname: settingName,\n\t\t\t\tvalue,\n\t\t\t},\n\t\t};\n\n\t\trunAction(RestMethod.imV2SettingsGeneralUpdate, payload)\n\t\t\t.catch(([error]) => {\n\t\t\t\tconsole.error('SettingsService: changeSetting error', error);\n\t\t\t});\n\t}\n\n\tchangeStatus(status: string): void\n\t{\n\t\tif (!UserStatus[status])\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tLogger.warn(`SettingsService: changeStatus to ${status}`);\n\t\tvoid Core.getStore().dispatch('users/setStatus', { status });\n\t\tvoid Core.getStore().dispatch('application/settings/set', { status });\n\n\t\tconst payload = { STATUS: status };\n\t\tCore.getRestClient().callMethod(RestMethod.imUserStatusSet, payload)\n\t\t\t.catch((result: RestResult) => {\n\t\t\t\tconsole.error('SettingsService: changeStatus error', result.error());\n\t\t\t});\n\t}\n\n\tasync switchScheme(newScheme: $Keys<typeof NotificationSettingsMode>): void\n\t{\n\t\tvoid Core.getStore().dispatch('application/settings/set', {\n\t\t\t[Settings.notification.mode]: newScheme,\n\t\t});\n\n\t\tconst newNotificationsSettings = await runAction(RestMethod.imV2SettingsNotifySwitchScheme, {\n\t\t\tdata: {\n\t\t\t\tuserId: Core.getUserId(),\n\t\t\t\tscheme: newScheme,\n\t\t\t},\n\t\t}).catch(([error]) => {\n\t\t\tconsole.error('SettingsService: switchScheme error', error);\n\t\t});\n\n\t\tvoid Core.getStore().dispatch('application/settings/set', {\n\t\t\tnotifications: newNotificationsSettings,\n\t\t});\n\t}\n\n\tasync changeExpertOption(payload: {\n\t\tmoduleId: string,\n\t\toptionName: string,\n\t\ttype: string,\n\t\tvalue: boolean\n\t}): Promise<void>\n\t{\n\t\tconst { moduleId, optionName, type, value } = payload;\n\t\tvoid Core.getStore().dispatch('application/settings/setNotificationOption', {\n\t\t\tmoduleId,\n\t\t\toptionName,\n\t\t\ttype,\n\t\t\tvalue,\n\t\t});\n\n\t\ttry\n\t\t{\n\t\t\tawait runAction(RestMethod.imV2SettingsNotifyUpdate, {\n\t\t\t\tdata: {\n\t\t\t\t\tuserId: Core.getUserId(),\n\t\t\t\t\tmoduleId,\n\t\t\t\t\tname: optionName,\n\t\t\t\t\ttype,\n\t\t\t\t\tvalue,\n\t\t\t\t},\n\t\t\t});\n\t\t}\n\t\tcatch ([error])\n\t\t{\n\t\t\tconsole.error('SettingsService: changeExpertOption error', error);\n\t\t}\n\t}\n\n\tasync toggleSubscription(notificationSubscriptionOptions: NotificationSubscriptionOptions): Promise<void>\n\t{\n\t\tconst { notifyModule, notifyEvent, shouldSubscribe, lastSubscribedTypes } = notificationSubscriptionOptions;\n\t\tconst notificationSettings = Core.getStore().getters['application/settings/get'](Settings.notifications);\n\t\tconst scheme = Core.getStore().getters['application/settings/get'](Settings.notification.mode);\n\t\tif (scheme === NotificationSettingsMode.simple)\n\t\t{\n\t\t\tawait this.switchScheme(NotificationSettingsMode.expert);\n\t\t}\n\n\t\tconst notificationSetting = notificationSettings[notifyModule].items[notifyEvent];\n\t\tconst promises = lastSubscribedTypes.map((type) => {\n\t\t\treturn this.changeExpertOption({\n\t\t\t\tmoduleId: notifyModule,\n\t\t\t\toptionName: notifyEvent,\n\t\t\t\ttype,\n\t\t\t\toldValue: notificationSetting[type],\n\t\t\t\tvalue: shouldSubscribe,\n\t\t\t});\n\t\t});\n\n\t\treturn Promise.all(promises);\n\t}\n}\n"],"names":["SettingsService","changeSetting","settingName","value","Logger","warn","Core","getStore","dispatch","payload","data","userId","getUserId","name","runAction","RestMethod","imV2SettingsGeneralUpdate","catch","error","console","changeStatus","status","UserStatus","STATUS","getRestClient","callMethod","imUserStatusSet","result","switchScheme","newScheme","Settings","notification","mode","newNotificationsSettings","imV2SettingsNotifySwitchScheme","scheme","notifications","changeExpertOption","moduleId","optionName","type","imV2SettingsNotifyUpdate","toggleSubscription","notificationSubscriptionOptions","notifyModule","notifyEvent","shouldSubscribe","lastSubscribedTypes","notificationSettings","getters","NotificationSettingsMode","simple","expert","notificationSetting","items","promises","map","oldValue","Promise","all"],"mappings":"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"}