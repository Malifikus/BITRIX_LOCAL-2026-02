{"version":3,"file":"entity-creator.bundle.js","sources":["../src/entity-creator.js"],"sourcesContent":["import { Runtime } from 'main.core';\nimport { BaseEvent, EventEmitter } from 'main.core.events';\nimport 'calendar.sliderloader';\n\nimport { runAction } from 'im.v2.lib.rest';\nimport { Core } from 'im.v2.application.core';\nimport { RestMethod } from 'im.v2.const';\n\nimport type { RestClient } from 'rest.client';\nimport type { JsonObject } from 'main.core';\n\nexport type TaskV2Params = {\n\tgroupId?: number,\n\tentityId?: number,\n\tsubEntityId?: number,\n\tta_sec: string,\n\tta_el: string,\n\tdescription?: string,\n\tauditors?: string,\n\tUF_TASK_WEBDAV_FILES: string[],\n};\n\nexport class EntityCreator\n{\n\t#chatId: number = 0;\n\t#restClient: RestClient;\n\n\t#onCalendarEntrySaveHandler: ?Function;\n\n\tconstructor(chatId: number)\n\t{\n\t\tthis.#restClient = Core.getRestClient();\n\t\tthis.#chatId = chatId;\n\t}\n\n\topenTaskCreationForm(): void\n\t{\n\t\tthis.#openTaskV2Card();\n\t}\n\n\tcreateTaskForChat(): Promise\n\t{\n\t\treturn this.#createTask();\n\t}\n\n\tcreateTaskForMessage(messageId: number): Promise\n\t{\n\t\treturn this.#createTask(messageId);\n\t}\n\n\tcreateMeetingForChat(): Promise\n\t{\n\t\treturn this.#createMeeting();\n\t}\n\n\tcreateMeetingForMessage(messageId: number): Promise\n\t{\n\t\treturn this.#createMeeting(messageId);\n\t}\n\n\t#createMeeting(messageId?: number): Promise\n\t{\n\t\tconst queryParams = { CHAT_ID: this.#chatId };\n\t\tif (messageId)\n\t\t{\n\t\t\tqueryParams.MESSAGE_ID = messageId;\n\t\t}\n\n\t\treturn this.#requestPreparedParams(RestMethod.imChatCalendarPrepare, queryParams).then((sliderParams) => {\n\t\t\tconst { params } = sliderParams;\n\n\t\t\tconst CALENDAR_ON_ENTRY_SAVE_EVENT = 'BX.Calendar:onEntrySave';\n\n\t\t\tthis.#onCalendarEntrySaveHandler = this.#onCalendarEntrySave.bind(this, params.sliderId, messageId);\n\t\t\tEventEmitter.subscribeOnce(CALENDAR_ON_ENTRY_SAVE_EVENT, this.#onCalendarEntrySaveHandler);\n\n\t\t\treturn this.#openCalendarSlider(params);\n\t\t});\n\t}\n\n\t#createTask(messageId?: number): Promise\n\t{\n\t\tconst config = {\n\t\t\tdata: { chatId: this.#chatId },\n\t\t};\n\t\tif (messageId)\n\t\t{\n\t\t\tconfig.data.messageId = messageId;\n\t\t}\n\n\t\treturn runAction(RestMethod.imV2ChatTaskPrepare, config).then((taskParams) => {\n\t\t\tconst { link, params } = taskParams;\n\n\t\t\treturn params.is_tasks_v2\n\t\t\t\t? this.#openPrefilledTaskV2Card(params)\n\t\t\t\t: this.#openTaskSlider(link, params)\n\t\t\t;\n\t\t});\n\t}\n\n\t#requestPreparedParams(requestMethod: string, query: Object): Promise\n\t{\n\t\treturn this.#restClient.callMethod(requestMethod, query).then((result) => {\n\t\t\treturn result.data();\n\t\t}).catch((error) => {\n\t\t\tconsole.error(error);\n\t\t});\n\t}\n\n\t#openTaskSlider(sliderUri: string, sliderParams: Object)\n\t{\n\t\tBX.SidePanel.Instance.open(sliderUri, {\n\t\t\trequestMethod: 'post',\n\t\t\trequestParams: sliderParams,\n\t\t\tcacheable: false,\n\t\t});\n\t}\n\n\tasync #openTaskV2Card(payload: JsonObject = {}): void\n\t{\n\t\tconst { TaskCard } = await Runtime.loadExtension('tasks.v2.application.task-card');\n\n\t\tTaskCard.showCompactCard(payload);\n\t}\n\n\t#openPrefilledTaskV2Card(params: TaskV2Params)\n\t{\n\t\tconst entityId = params.entityId ?? null;\n\t\tconst subEntityId = params.subEntityId ?? null;\n\t\tconst auditors = params.auditors\n\t\t\t? params.auditors.split(',').map((auditorId) => parseInt(auditorId.trim(), 10))\n\t\t\t: []\n\t\t;\n\n\t\tconst payload = {\n\t\t\tgroupId: params.groupId ?? null,\n\t\t\tdescription: params.description ?? null,\n\t\t\tauditorsIds: auditors,\n\t\t\tfileIds: params.UF_TASK_WEBDAV_FILES,\n\t\t\tanalytics: {\n\t\t\t\tcontext: params.ta_sec,\n\t\t\t\telement: params.ta_el,\n\t\t\t},\n\t\t\tsource: { type: 'chat', entityId, subEntityId },\n\t\t};\n\n\t\tvoid this.#openTaskV2Card(payload);\n\t}\n\n\t#openCalendarSlider(sliderParams: Object)\n\t{\n\t\tnew (window.top.BX || window.BX).Calendar.SliderLoader(0, sliderParams).show();\n\t}\n\n\t#onCalendarEntrySave(sliderId: string, messageId: ?number, event: BaseEvent)\n\t{\n\t\tconst eventData = event.getData();\n\t\tif (eventData.sliderId !== sliderId)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tconst queryParams = {\n\t\t\tCALENDAR_ID: eventData.responseData.entryId,\n\t\t\tCHAT_ID: this.#chatId,\n\t\t};\n\n\t\tif (messageId)\n\t\t{\n\t\t\tqueryParams.MESSAGE_ID = messageId;\n\t\t}\n\n\t\treturn this.#restClient.callMethod(RestMethod.imChatCalendarAdd, queryParams).catch((error) => {\n\t\t\tconsole.error(error);\n\t\t});\n\t}\n}\n"],"names":["EntityCreator","constructor","chatId","Core","getRestClient","openTaskCreationForm","createTaskForChat","createTaskForMessage","messageId","createMeetingForChat","createMeetingForMessage","queryParams","CHAT_ID","MESSAGE_ID","RestMethod","imChatCalendarPrepare","then","sliderParams","params","CALENDAR_ON_ENTRY_SAVE_EVENT","bind","sliderId","EventEmitter","subscribeOnce","config","data","runAction","imV2ChatTaskPrepare","taskParams","link","is_tasks_v2","requestMethod","query","callMethod","result","catch","error","console","sliderUri","BX","SidePanel","Instance","open","requestParams","cacheable","payload","TaskCard","Runtime","loadExtension","showCompactCard","entityId","subEntityId","auditors","split","map","auditorId","parseInt","trim","groupId","description","auditorsIds","fileIds","UF_TASK_WEBDAV_FILES","analytics","context","ta_sec","element","ta_el","source","type","window","top","Calendar","SliderLoader","show","event","eventData","getData","CALENDAR_ID","responseData","entryId","imChatCalendarAdd"],"mappings":"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"}