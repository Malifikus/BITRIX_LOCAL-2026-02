this.BX=this.BX||{};this.BX.Messenger=this.BX.Messenger||{};this.BX.Messenger.v2=this.BX.Messenger.v2||{};this.BX.Messenger.v2.Provider=this.BX.Messenger.v2.Provider||{};(function(e,s,a,t,l,i,r,o,d,n,c,h,g,p,b,u,v,P,C,f,I,L,H,F,m,B,M,y){"use strict";var U=babelHelpers.classPrivateFieldLooseKey("store");class w{constructor(){Object.defineProperty(this,U,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,U)[U]=y.Core.getStore()}handleBotAdd(e){F.Logger.warn("BotPullHandler: handleBotAdd",e);const{user:s}=e;void(new P.UserManager).addUsersToModel(s)}handleBotUpdate(e){const{user:s}=e;babelHelpers.classPrivateFieldLooseBase(this,U)[U].dispatch("users/update",{id:s.id,fields:s})}}var S=babelHelpers.classPrivateFieldLooseKey("store");var k=babelHelpers.classPrivateFieldLooseKey("stopWriting");var A=babelHelpers.classPrivateFieldLooseKey("closeChannelComments");var O=babelHelpers.classPrivateFieldLooseKey("prepareDialogUpdateFields");class D{constructor(){Object.defineProperty(this,O,{value:j});Object.defineProperty(this,A,{value:T});Object.defineProperty(this,k,{value:R});Object.defineProperty(this,S,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,S)[S]=y.Core.getStore()}deleteMessage(e){babelHelpers.classPrivateFieldLooseBase(this,k)[k](e.dialogId,e.senderId);void babelHelpers.classPrivateFieldLooseBase(this,S)[S].dispatch("messages/update",{id:e.id,fields:{text:"",isDeleted:true,files:[],attach:[],replyId:0}})}deleteMessageComplete(e){babelHelpers.classPrivateFieldLooseBase(this,k)[k](e.dialogId,e.senderId);const s=babelHelpers.classPrivateFieldLooseBase(this,S)[S].getters["messages/comments/areOpenedForChannelPost"](e.id);if(s){babelHelpers.classPrivateFieldLooseBase(this,A)[A](e)}void babelHelpers.classPrivateFieldLooseBase(this,S)[S].dispatch("messages/delete",{id:e.id});const a=babelHelpers.classPrivateFieldLooseBase(this,O)[O](e);void babelHelpers.classPrivateFieldLooseBase(this,S)[S].dispatch("chats/update",{dialogId:e.dialogId,fields:a})}}function R(e,s){i.InputActionListener.getInstance().stopAction({dialogId:e,userId:s})}function T(e){t.EventEmitter.emit(B.EventType.dialog.closeComments);o.Analytics.getInstance().messageDelete.onDeletedPostNotification({dialogId:e.dialogId});d.Notifier.message.onNotFoundError()}function j(e){const s={counter:e.counter};const a=Boolean(e.newLastMessage);if(a){s.lastMessageId=e.newLastMessage.id;s.lastMessageViews=e.lastMessageViews;void babelHelpers.classPrivateFieldLooseBase(this,S)[S].dispatch("messages/store",e.newLastMessage)}return s}var K=babelHelpers.classPrivateFieldLooseKey("store");var N=babelHelpers.classPrivateFieldLooseKey("messageViews");var E=babelHelpers.classPrivateFieldLooseKey("messageDeleteManager");var X=babelHelpers.classPrivateFieldLooseKey("setMessageChat");var V=babelHelpers.classPrivateFieldLooseKey("setUsers");var _=babelHelpers.classPrivateFieldLooseKey("setFiles");var x=babelHelpers.classPrivateFieldLooseKey("setAdditionalEntities");var G=babelHelpers.classPrivateFieldLooseKey("setCommentInfo");var W=babelHelpers.classPrivateFieldLooseKey("handleAddingMessageToModel");var Y=babelHelpers.classPrivateFieldLooseKey("addMessageToModel");var q=babelHelpers.classPrivateFieldLooseKey("updateDialog");var z=babelHelpers.classPrivateFieldLooseKey("updateMessageViewedByOthers");var J=babelHelpers.classPrivateFieldLooseKey("updateChatLastMessageViews");var Q=babelHelpers.classPrivateFieldLooseKey("checkMessageViewsRegistry");var Z=babelHelpers.classPrivateFieldLooseKey("updateMessageViewsRegistry");var $=babelHelpers.classPrivateFieldLooseKey("sendScrollEvent");var ee=babelHelpers.classPrivateFieldLooseKey("getDialog");var se=babelHelpers.classPrivateFieldLooseKey("setCopilotData");var ae=babelHelpers.classPrivateFieldLooseKey("setMessagesAutoDeleteConfig");var te=babelHelpers.classPrivateFieldLooseKey("setStickers");var le=babelHelpers.classPrivateFieldLooseKey("prepareDeleteMessageParams");class ie{constructor(){Object.defineProperty(this,le,{value:Fe});Object.defineProperty(this,te,{value:He});Object.defineProperty(this,ae,{value:Le});Object.defineProperty(this,se,{value:Ie});Object.defineProperty(this,ee,{value:fe});Object.defineProperty(this,$,{value:Ce});Object.defineProperty(this,Z,{value:Pe});Object.defineProperty(this,Q,{value:ve});Object.defineProperty(this,J,{value:ue});Object.defineProperty(this,z,{value:be});Object.defineProperty(this,q,{value:pe});Object.defineProperty(this,Y,{value:ge});Object.defineProperty(this,W,{value:he});Object.defineProperty(this,G,{value:ce});Object.defineProperty(this,x,{value:ne});Object.defineProperty(this,_,{value:de});Object.defineProperty(this,V,{value:oe});Object.defineProperty(this,X,{value:re});Object.defineProperty(this,K,{writable:true,value:void 0});Object.defineProperty(this,N,{writable:true,value:{}});Object.defineProperty(this,E,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,K)[K]=y.Core.getStore();babelHelpers.classPrivateFieldLooseBase(this,E)[E]=new D}handleMessageAdd(e){F.Logger.warn("MessagePullHandler: handleMessageAdd",e);babelHelpers.classPrivateFieldLooseBase(this,X)[X](e);babelHelpers.classPrivateFieldLooseBase(this,V)[V](e);babelHelpers.classPrivateFieldLooseBase(this,_)[_](e);babelHelpers.classPrivateFieldLooseBase(this,x)[x](e);babelHelpers.classPrivateFieldLooseBase(this,G)[G](e);babelHelpers.classPrivateFieldLooseBase(this,se)[se](e);babelHelpers.classPrivateFieldLooseBase(this,ae)[ae](e);babelHelpers.classPrivateFieldLooseBase(this,te)[te](e);const s=babelHelpers.classPrivateFieldLooseBase(this,K)[K].getters["messages/isInChatCollection"]({messageId:e.message.templateId});const a=babelHelpers.classPrivateFieldLooseBase(this,K)[K].getters["messages/isInChatCollection"]({messageId:e.message.id});if(a){F.Logger.warn("New message pull handler: we already have this message",e.message);void babelHelpers.classPrivateFieldLooseBase(this,K)[K].dispatch("messages/update",{id:e.message.id,fields:{...e.message,error:false}});babelHelpers.classPrivateFieldLooseBase(this,$)[$](e.chatId)}else if(!a&&s){F.Logger.warn("New message pull handler: we already have the TEMPORARY message",e.message);void babelHelpers.classPrivateFieldLooseBase(this,K)[K].dispatch("messages/updateWithId",{id:e.message.templateId,fields:{...e.message,error:false}})}else if(!a&&!s){const s=babelHelpers.classPrivateFieldLooseBase(this,K)[K].getters["messages/hasLoadingMessageByMessageId"](e.message.templateId);if(s){void babelHelpers.classPrivateFieldLooseBase(this,K)[K].dispatch("messages/delete",{id:e.message.templateId})}F.Logger.warn("New message pull handler: we dont have this message",e.message);babelHelpers.classPrivateFieldLooseBase(this,W)[W](e)}i.InputActionListener.getInstance().stopAction({userId:e.message.senderId,dialogId:e.dialogId});babelHelpers.classPrivateFieldLooseBase(this,q)[q](e)}handleMessageUpdate(e){F.Logger.warn("MessagePullHandler: handleMessageUpdate",e);i.InputActionListener.getInstance().stopAction({userId:e.senderId,dialogId:e.dialogId});babelHelpers.classPrivateFieldLooseBase(this,K)[K].dispatch("messages/update",{id:e.id,fields:{text:e.text,params:e.params}});babelHelpers.classPrivateFieldLooseBase(this,$)[$](e.chatId)}handleMessageDeleteV2(e){F.Logger.warn("MessageDeletePullHandler: handleMultipleMessageDelete",e);const s=e.messages;s.forEach((s=>{if(s.completelyDeleted){const a=babelHelpers.classPrivateFieldLooseBase(this,le)[le](e,true,s);babelHelpers.classPrivateFieldLooseBase(this,E)[E].deleteMessageComplete(a);return}const a=babelHelpers.classPrivateFieldLooseBase(this,le)[le](e,false,s);babelHelpers.classPrivateFieldLooseBase(this,E)[E].deleteMessage(a)}))}handleMessageDelete(e){F.Logger.warn("MessageDeletePullHandler: handleMessageDelete",e);const s=babelHelpers.classPrivateFieldLooseBase(this,le)[le](e);babelHelpers.classPrivateFieldLooseBase(this,E)[E].deleteMessage(s)}handleMessageDeleteComplete(e){F.Logger.warn("MessageDeletePullHandler: handleMessageDeleteComplete",e);const s=babelHelpers.classPrivateFieldLooseBase(this,le)[le](e,true);babelHelpers.classPrivateFieldLooseBase(this,E)[E].deleteMessageComplete(s)}handleAddReaction(e){F.Logger.warn("MessagePullHandler: handleAddReaction",e);const{actualReactions:{reaction:s,usersShort:a},userId:t,reaction:l}=e;if(y.Core.getUserId()===t){s.ownReactions=[l]}const i=new P.UserManager;void i.addUsersToModel(a);void babelHelpers.classPrivateFieldLooseBase(this,K)[K].dispatch("messages/reactions/set",[s])}handleDeleteReaction(e){F.Logger.warn("MessagePullHandler: handleDeleteReaction",e);const{actualReactions:{reaction:s},reaction:a,userId:t}=e;const l={...s};if(y.Core.getUserId()===t){l.ownReactionsToRemove=[a]}void babelHelpers.classPrivateFieldLooseBase(this,K)[K].dispatch("messages/reactions/set",[l])}handleMessageParamsUpdate(e){F.Logger.warn("MessagePullHandler: handleMessageParamsUpdate",e);babelHelpers.classPrivateFieldLooseBase(this,K)[K].dispatch("messages/update",{id:e.id,chatId:e.chatId,fields:{params:e.params}})}handleReadMessage(e,a){F.Logger.warn("MessagePullHandler: handleReadMessage",e);const t=s.UuidManager.getInstance();if(t.hasActionUuid(a.action_uuid)){F.Logger.warn("MessagePullHandler: handleReadMessage: we have this uuid, skip");t.removeActionUuid(a.action_uuid);return}babelHelpers.classPrivateFieldLooseBase(this,K)[K].dispatch("messages/readMessages",{chatId:e.chatId,messageIds:e.viewedMessages}).then((()=>{babelHelpers.classPrivateFieldLooseBase(this,K)[K].dispatch("chats/update",{dialogId:e.dialogId,fields:{counter:e.counter,lastId:e.lastId}})})).catch((e=>{console.error("MessagePullHandler: error handling readMessage",e)}))}handleReadMessageOpponent(e){if(e.userId===y.Core.getUserId()){return}F.Logger.warn("MessagePullHandler: handleReadMessageOpponent",e);babelHelpers.classPrivateFieldLooseBase(this,z)[z](e);babelHelpers.classPrivateFieldLooseBase(this,J)[J](e)}handlePinAdd(e){F.Logger.warn("MessagePullHandler: handlePinAdd",e);babelHelpers.classPrivateFieldLooseBase(this,_)[_](e);babelHelpers.classPrivateFieldLooseBase(this,V)[V](e);babelHelpers.classPrivateFieldLooseBase(this,K)[K].dispatch("messages/store",e.additionalMessages);babelHelpers.classPrivateFieldLooseBase(this,K)[K].dispatch("messages/pin/add",{chatId:e.pin.chatId,messageId:e.pin.messageId});if(y.Core.getUserId()!==e.pin.authorId);}handlePinDelete(e){F.Logger.warn("MessagePullHandler: handlePinDelete",e);babelHelpers.classPrivateFieldLooseBase(this,K)[K].dispatch("messages/pin/delete",{chatId:e.chatId,messageId:e.messageId})}}function re(e){var s,a,t;const l=(s=e.chat)==null?void 0:s[e.chatId];if(!l){return}const i={...e.chat[e.chatId],dialogId:e.dialogId};const r=Boolean(babelHelpers.classPrivateFieldLooseBase(this,ee)[ee](e.dialogId));const o=!e.notify||((a=e.message)==null?void 0:(t=a.params)==null?void 0:t.NOTIFY)==="N";if(!r&&!o&&!i.role){i.role=B.UserRole.member}babelHelpers.classPrivateFieldLooseBase(this,K)[K].dispatch("chats/set",i)}function oe(e){if(!e.users){return}const s=new P.UserManager;s.setUsersToModel(Object.values(e.users))}function de(e){if(!e.files){return}const s=Object.values(e.files);s.forEach((e=>{void babelHelpers.classPrivateFieldLooseBase(this,K)[K].dispatch("files/set",e)}))}function ne(e){if(!e.message.additionalEntities){return}const{additionalMessages:s,messages:a,files:t,users:l,stickers:i}=e.message.additionalEntities;const r=[...a,...s];void babelHelpers.classPrivateFieldLooseBase(this,K)[K].dispatch("messages/store",r);void babelHelpers.classPrivateFieldLooseBase(this,K)[K].dispatch("files/set",t);void babelHelpers.classPrivateFieldLooseBase(this,K)[K].dispatch("users/set",l);void babelHelpers.classPrivateFieldLooseBase(this,K)[K].dispatch("stickers/set",i)}function ce(e){var s;const a=(s=e.chat)==null?void 0:s[e.chatId];if(!a||a.type!==B.ChatType.comment){return}babelHelpers.classPrivateFieldLooseBase(this,K)[K].dispatch("messages/comments/set",{messageId:a.parent_message_id,chatId:e.chatId,messageCount:a.message_count});babelHelpers.classPrivateFieldLooseBase(this,K)[K].dispatch("messages/comments/setLastUser",{messageId:a.parent_message_id,newUserId:e.message.senderId})}function he(e){const s=babelHelpers.classPrivateFieldLooseBase(this,ee)[ee](e.dialogId,true);if(s.hasNextPage){babelHelpers.classPrivateFieldLooseBase(this,K)[K].dispatch("messages/store",e.message);return}const t=babelHelpers.classPrivateFieldLooseBase(this,K)[K].getters["application/isChatOpen"](e.dialogId);const l=babelHelpers.classPrivateFieldLooseBase(this,K)[K].getters["messages/getChatUnreadMessages"](e.chatId);const i=a.MessageService.getMessageRequestLimit()*5;if(s.inited&&!t&&l.length>i){void babelHelpers.classPrivateFieldLooseBase(this,K)[K].dispatch("messages/store",e.message);const s=new a.MessageService({chatId:e.chatId});s.reloadMessageList();return}babelHelpers.classPrivateFieldLooseBase(this,Y)[Y](e.message);babelHelpers.classPrivateFieldLooseBase(this,$)[$](e.chatId)}function ge(e){const s={...e};if(e.senderId===y.Core.getUserId()){s.unread=false}else{s.unread=true;s.viewed=false}babelHelpers.classPrivateFieldLooseBase(this,K)[K].dispatch("messages/setChatCollection",{messages:[s]})}function pe(e){const s=babelHelpers.classPrivateFieldLooseBase(this,ee)[ee](e.dialogId,true);const a={};if(e.message.id>s.lastMessageId){a.lastMessageId=e.message.id}if(e.message.senderId===y.Core.getUserId()&&e.message.id>s.lastReadId){a.lastId=e.message.id}a.counter=e.counter;babelHelpers.classPrivateFieldLooseBase(this,K)[K].dispatch("chats/update",{dialogId:e.dialogId,fields:a});babelHelpers.classPrivateFieldLooseBase(this,K)[K].dispatch("chats/clearLastMessageViews",{dialogId:e.dialogId})}function be(e){babelHelpers.classPrivateFieldLooseBase(this,K)[K].dispatch("messages/setViewedByOthers",{ids:e.viewedMessages})}function ue(e){const s=babelHelpers.classPrivateFieldLooseBase(this,ee)[ee](e.dialogId);if(!s){return}const a=e.viewedMessages.includes(s.lastMessageId);if(!a){return}if(babelHelpers.classPrivateFieldLooseBase(this,Q)[Q](e.userId,s.lastMessageId)){return}const t=Boolean(s.lastMessageViews.firstViewer);if(t){babelHelpers.classPrivateFieldLooseBase(this,K)[K].dispatch("chats/incrementLastMessageViews",{dialogId:e.dialogId});babelHelpers.classPrivateFieldLooseBase(this,Z)[Z](e.userId,s.lastMessageId);return}babelHelpers.classPrivateFieldLooseBase(this,K)[K].dispatch("chats/setLastMessageViews",{dialogId:e.dialogId,fields:{userId:e.userId,userName:e.userName,date:e.date,messageId:s.lastMessageId}});babelHelpers.classPrivateFieldLooseBase(this,Z)[Z](e.userId,s.lastMessageId)}function ve(e,s){var a;return Boolean((a=babelHelpers.classPrivateFieldLooseBase(this,N)[N][s])==null?void 0:a.has(e))}function Pe(e,s){if(!babelHelpers.classPrivateFieldLooseBase(this,N)[N][s]){babelHelpers.classPrivateFieldLooseBase(this,N)[N][s]=new Set}babelHelpers.classPrivateFieldLooseBase(this,N)[N][s].add(e)}function Ce(e){t.EventEmitter.emit(B.EventType.dialog.scrollToBottom,{chatId:e,threshold:B.DialogScrollThreshold.nearTheBottom})}function fe(e,s=false){return babelHelpers.classPrivateFieldLooseBase(this,K)[K].getters["chats/get"](e,s)}function Ie(e){if(!e.copilot){return}const s=new b.CopilotManager;void s.handleMessageAdd(e.copilot)}function Le(e){const{messagesAutoDeleteConfigs:s}=e;void babelHelpers.classPrivateFieldLooseBase(this,K)[K].dispatch("chats/autoDelete/set",s)}function He(e){const s=H.Type.isPlainObject(e.message.params.STICKER_PARAMS);if(s){void babelHelpers.classPrivateFieldLooseBase(this,K)[K].dispatch("stickers/messages/set",[{messageId:e.message.id,...e.message.params.STICKER_PARAMS}]);void babelHelpers.classPrivateFieldLooseBase(this,K)[K].dispatch("stickers/set",e.stickers)}}function Fe(e,s=false,a=null){const t={id:a?a.id:e.id,senderId:a?a.senderId:e.senderId,dialogId:e.dialogId};if(s){return{...t,newLastMessage:e.newLastMessage,lastMessageViews:e.lastMessageViews,counter:e.counter}}return t}var me=babelHelpers.classPrivateFieldLooseKey("store");var Be=babelHelpers.classPrivateFieldLooseKey("updateChatUsers");class Me{constructor(){Object.defineProperty(this,Be,{value:ye});Object.defineProperty(this,me,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,me)[me]=y.Core.getStore()}handleChatOwner(e){F.Logger.warn("ChatPullHandler: handleChatOwner",e);babelHelpers.classPrivateFieldLooseBase(this,me)[me].dispatch("chats/update",{dialogId:e.dialogId,fields:{ownerId:e.userId}})}handleChatManagers(e){F.Logger.warn("ChatPullHandler: handleChatManagers",e);babelHelpers.classPrivateFieldLooseBase(this,me)[me].dispatch("chats/update",{dialogId:e.dialogId,fields:{managerList:e.list}});const s=babelHelpers.classPrivateFieldLooseBase(this,me)[me].getters["chats/get"](e.dialogId);if(!s){return}const a=e.list.includes(y.Core.getUserId());if(s.role===B.UserRole.member&&a){babelHelpers.classPrivateFieldLooseBase(this,me)[me].dispatch("chats/update",{dialogId:e.dialogId,fields:{role:B.UserRole.manager}})}if(s.role===B.UserRole.manager&&!a){babelHelpers.classPrivateFieldLooseBase(this,me)[me].dispatch("chats/update",{dialogId:e.dialogId,fields:{role:B.UserRole.member}})}}handleChatUserAdd(e){F.Logger.warn("ChatPullHandler: handleChatUserAdd",e);babelHelpers.classPrivateFieldLooseBase(this,Be)[Be](e);const{newUsers:s,dialogId:a,relations:t}=e;const l=y.Core.getUserId();if(s.includes(l)){const e=t.find((e=>e.userId===y.Core.getUserId()));void babelHelpers.classPrivateFieldLooseBase(this,me)[me].dispatch("chats/update",{dialogId:a,fields:{role:e.role}})}}handleChatUserLeave(e){F.Logger.warn("ChatPullHandler: handleChatUserLeave",e);babelHelpers.classPrivateFieldLooseBase(this,Be)[Be](e);const{userId:s,dialogId:a,chatId:t,relations:[l]}=e;const i=s===y.Core.getUserId();if(l!=null&&l.isHidden||!i){return}void babelHelpers.classPrivateFieldLooseBase(this,me)[me].dispatch("chats/update",{dialogId:a,fields:{inited:false}});void babelHelpers.classPrivateFieldLooseBase(this,me)[me].dispatch("messages/clearChatCollection",{chatId:t});const r=v.ChannelManager.isChannel(a);if(r){void babelHelpers.classPrivateFieldLooseBase(this,me)[me].dispatch("counters/deleteForChannel",{channelChatId:t})}const o=babelHelpers.classPrivateFieldLooseBase(this,me)[me].getters["application/isChatOpen"](a);if(o){void h.Messenger.openChat()}I.CallManager.getInstance().deleteRecentCall(a);const d=I.CallManager.getInstance().getCurrentCallDialogId()===a;if(d){I.CallManager.getInstance().leaveCurrentCall()}}handleInputActionNotify(e){F.Logger.warn("ChatPullHandler: handleInputActionNotify",e);i.InputActionListener.getInstance().startAction(e);babelHelpers.classPrivateFieldLooseBase(this,me)[me].dispatch("users/update",{id:e.userId,fields:{lastActivityDate:new Date}})}handleChatUnread(e){F.Logger.warn("ChatPullHandler: handleChatUnread",e);let s=0;if(e.active===true){s=e.markedId}babelHelpers.classPrivateFieldLooseBase(this,me)[me].dispatch("chats/update",{dialogId:e.dialogId,fields:{markedId:s}})}handleChatMuteNotify(e){if(e.muted){babelHelpers.classPrivateFieldLooseBase(this,me)[me].dispatch("chats/mute",{dialogId:e.dialogId});return}babelHelpers.classPrivateFieldLooseBase(this,me)[me].dispatch("chats/unmute",{dialogId:e.dialogId})}handleChatRename(e){const s=babelHelpers.classPrivateFieldLooseBase(this,me)[me].getters["chats/getByChatId"](e.chatId);if(!s){return}babelHelpers.classPrivateFieldLooseBase(this,me)[me].dispatch("chats/update",{dialogId:s.dialogId,fields:{name:e.name}})}handleChatAvatar(e){const s=babelHelpers.classPrivateFieldLooseBase(this,me)[me].getters["chats/getByChatId"](e.chatId);if(!s){return}babelHelpers.classPrivateFieldLooseBase(this,me)[me].dispatch("chats/update",{dialogId:s.dialogId,fields:{avatar:e.avatar}})}handleReadAllChats(){F.Logger.warn("ChatPullHandler: handleReadAllChats");n.CounterClearActionsDefault.forEach((e=>{void babelHelpers.classPrivateFieldLooseBase(this,me)[me].dispatch(e)}))}handleReadAllChatsByType(e){const{type:s}=e;const a=n.CounterClearActionsByChatType[s];if(!a){return}a.forEach((e=>{void babelHelpers.classPrivateFieldLooseBase(this,me)[me].dispatch(e,{type:s})}))}handleChatConvert(e){F.Logger.warn("ChatPullHandler: handleChatConvert",e);const{dialogId:s,oldType:a,newType:t,newPermissions:l,newTypeParams:i}=e;const r={type:t,permissions:l};if([t,a].includes(B.ChatType.collab)){r.diskFolderId=0}babelHelpers.classPrivateFieldLooseBase(this,me)[me].dispatch("chats/update",{dialogId:s,fields:r});const o=babelHelpers.classPrivateFieldLooseBase(this,me)[me].getters["chats/get"](s);if(t===B.ChatType.collab&&(o==null?void 0:o.chatId)>0){babelHelpers.classPrivateFieldLooseBase(this,me)[me].dispatch("chats/collabs/set",{chatId:o.chatId,collabInfo:i.collabInfo})}}handleChatUpdate(e){void babelHelpers.classPrivateFieldLooseBase(this,me)[me].dispatch("chats/update",{dialogId:e.chat.dialogId,fields:{role:r.getChatRoleForUser(e.chat),...e.chat}})}handleChatFieldsUpdate(e){void babelHelpers.classPrivateFieldLooseBase(this,me)[me].dispatch("chats/update",{dialogId:e.dialogId,fields:{...e}})}handleChatDelete(e){F.Logger.warn("ChatPullHandler: handleChatDelete",e);const s=y.Core.getUserId();if(e.userId===s){return}void babelHelpers.classPrivateFieldLooseBase(this,me)[me].dispatch("chats/update",{dialogId:e.dialogId,fields:{inited:false}});void babelHelpers.classPrivateFieldLooseBase(this,me)[me].dispatch("recent/delete",{id:e.dialogId});const a=e.type===B.ChatType.comment;if(a){void babelHelpers.classPrivateFieldLooseBase(this,me)[me].dispatch("counters/deleteForChannel",{channelChatId:e.parentChatId,commentChatId:e.chatId})}const t=v.ChannelManager.isChannel(e.dialogId);if(t){void babelHelpers.classPrivateFieldLooseBase(this,me)[me].dispatch("counters/deleteForChannel",{channelChatId:e.chatId})}void babelHelpers.classPrivateFieldLooseBase(this,me)[me].dispatch("messages/clearChatCollection",{chatId:e.chatId});const l=babelHelpers.classPrivateFieldLooseBase(this,me)[me].getters["application/isChatOpen"](e.dialogId);if(l){o.Analytics.getInstance().chatDelete.onChatDeletedNotification(e.dialogId);d.Notifier.chat.onNotFoundError();void p.LayoutManager.getInstance().clearCurrentLayoutEntityId();void p.LayoutManager.getInstance().deleteLastOpenedElementById(e.dialogId)}const i=I.CallManager.getInstance().getCurrentCallDialogId()===e.dialogId;if(i){I.CallManager.getInstance().leaveCurrentCall()}}handleMessagesAutoDeleteDelayChanged(e){F.Logger.warn("ChatPullHandler: handleMessagesAutoDeleteDelayChanged",e);const{chatId:s,delay:a}=e;void babelHelpers.classPrivateFieldLooseBase(this,me)[me].dispatch("chats/autoDelete/set",{chatId:s,delay:a})}}function ye(e){if(e.users){const s=new P.UserManager;void s.setUsersToModel(Object.values(e.users))}void babelHelpers.classPrivateFieldLooseBase(this,me)[me].dispatch("chats/update",{dialogId:e.dialogId,fields:{userCounter:e.userCount,extranet:e.chatExtranet,containsCollaber:e.containsCollaber}})}class Ue{handleChangeTariff(e){var s;F.Logger.warn("TariffPullHandler: handleChangeTariff",e);const{tariffRestrictions:a}=e;if(!a){return}if(((s=a.fullChatHistory)==null?void 0:s.isAvailable)===true){return}void y.Core.getStore().dispatch("application/tariffRestrictions/set",a)}}var we=babelHelpers.classPrivateFieldLooseKey("store");class Se{constructor(){Object.defineProperty(this,we,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,we)[we]=y.Core.getStore()}handleUserInvite(e){if(e.invited){const s=new P.UserManager;s.setUsersToModel([e.user]);return}babelHelpers.classPrivateFieldLooseBase(this,we)[we].dispatch("users/update",{id:e.userId,fields:e.user})}handleUserShowInRecent(e){const s=e.items.map((e=>e.user));const a=new P.UserManager;a.setUsersToModel(s)}}class ke{handleDesktopOnline(e){F.Logger.warn("DesktopPullHandler: handleDesktopOnline",e);const s=f.DesktopManager.getInstance();s.setDesktopActive(true);s.setDesktopVersion(e.version);n.CounterManager.getInstance().removeBrowserTitleCounter()}handleDesktopOffline(){F.Logger.warn("DesktopPullHandler: handleDesktopOffline");f.DesktopManager.getInstance().setDesktopActive(false);f.DesktopManager.getInstance().setDesktopVersion(0)}}class Ae{handleSettingsUpdate(e){F.Logger.warn("SettingsPullHandler: handleSettingsUpdate",e);Object.entries(e).forEach((([e,s])=>{y.Core.getStore().dispatch("application/settings/set",{[e]:s})}))}}class Oe{handleCommentSubscribe(e){const{messageId:s,subscribe:a}=e;F.Logger.warn("CommentsPullHandler: handleCommentSubscribe",e);if(a){y.Core.getStore().dispatch("messages/comments/subscribe",s);return}y.Core.getStore().dispatch("messages/comments/unsubscribe",s)}handleReadAllChannelComments(e){y.Core.getStore().dispatch("counters/readAllChannelComments",e.chatId)}}var De=babelHelpers.classPrivateFieldLooseKey("isChatFocused");class Re{constructor(){Object.defineProperty(this,De,{value:Te})}handleApplicationOpenChat(e){F.Logger.warn("ApplicationPullHandler: handleOpenChat",e);if(!babelHelpers.classPrivateFieldLooseBase(this,De)[De]()){return}if(f.DesktopManager.isDesktop()){if(!f.DesktopManager.isChatWindow()){return}void h.Messenger.openChat(e.dialogId);return}void h.Messenger.openChat(e.dialogId)}}function Te(){if(!document.hasFocus()){return false}const e=c.SidePanel.Instance;const s=e.getOpenSlidersCount()>0;const a=p.LayoutManager.getInstance().isEmbeddedMode();if(a&&s){return false}const t=g.MessengerSlider.getInstance().isFocused();if(!a&&!t){return false}return true}class je{handleUpdateCollabEntityCounter(e){F.Logger.warn("CollabPullHandler: handleUpdateCollabEntityCounter",e);const{chatId:s,counter:a,entity:t}=e;void y.Core.getStore().dispatch("chats/collabs/setCounter",{chatId:s,entity:t,counter:a})}handleUpdateCollabGuestCount(e){F.Logger.warn("CollabPullHandler: handleUpdateCollabGuestCount",e);const{chatId:s,guestCount:a}=e;void y.Core.getStore().dispatch("chats/collabs/setGuestCount",{chatId:s,guestCount:a})}}var Ke=babelHelpers.classPrivateFieldLooseKey("store");class Ne{constructor(){Object.defineProperty(this,Ke,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,Ke)[Ke]=y.Core.getStore()}handleChangeEngine(e){F.Logger.warn("AiPullHandler: handleChangeEngine",e);const{chatId:s,engineCode:a}=e;const t=babelHelpers.classPrivateFieldLooseBase(this,Ke)[Ke].getters["chats/getByChatId"](s);if(!t){return}babelHelpers.classPrivateFieldLooseBase(this,Ke)[Ke].dispatch("copilot/chats/updateModel",{dialogId:t.dialogId,aiModel:a})}handleFileTranscription(e){F.Logger.warn("AiPullHandler: handleFileTranscription",e);babelHelpers.classPrivateFieldLooseBase(this,Ke)[Ke].dispatch("files/setTranscription",e)}handleChatCopilotRoleUpdate(e){if(!e.copilotRole){return}const s=new b.CopilotManager;void s.handleRoleUpdate(e.copilotRole)}}var Ee=babelHelpers.classPrivateFieldLooseKey("messageHandler");var Xe=babelHelpers.classPrivateFieldLooseKey("chatHandler");var Ve=babelHelpers.classPrivateFieldLooseKey("userHandler");var _e=babelHelpers.classPrivateFieldLooseKey("desktopHandler");var xe=babelHelpers.classPrivateFieldLooseKey("settingsHandler");var Ge=babelHelpers.classPrivateFieldLooseKey("commentsHandler");var We=babelHelpers.classPrivateFieldLooseKey("tariffPullHandler");var Ye=babelHelpers.classPrivateFieldLooseKey("applicationPullHandler");var qe=babelHelpers.classPrivateFieldLooseKey("collabPullHandler");var ze=babelHelpers.classPrivateFieldLooseKey("botPullHandler");var Je=babelHelpers.classPrivateFieldLooseKey("aiPullHandler");class Qe{constructor(){Object.defineProperty(this,Ee,{writable:true,value:void 0});Object.defineProperty(this,Xe,{writable:true,value:void 0});Object.defineProperty(this,Ve,{writable:true,value:void 0});Object.defineProperty(this,_e,{writable:true,value:void 0});Object.defineProperty(this,xe,{writable:true,value:void 0});Object.defineProperty(this,Ge,{writable:true,value:void 0});Object.defineProperty(this,We,{writable:true,value:void 0});Object.defineProperty(this,Ye,{writable:true,value:void 0});Object.defineProperty(this,qe,{writable:true,value:void 0});Object.defineProperty(this,ze,{writable:true,value:void 0});Object.defineProperty(this,Je,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,Ee)[Ee]=new ie;babelHelpers.classPrivateFieldLooseBase(this,Xe)[Xe]=new Me;babelHelpers.classPrivateFieldLooseBase(this,Ve)[Ve]=new Se;babelHelpers.classPrivateFieldLooseBase(this,_e)[_e]=new ke;babelHelpers.classPrivateFieldLooseBase(this,xe)[xe]=new Ae;babelHelpers.classPrivateFieldLooseBase(this,Ge)[Ge]=new Oe;babelHelpers.classPrivateFieldLooseBase(this,We)[We]=new Ue;babelHelpers.classPrivateFieldLooseBase(this,Ye)[Ye]=new Re;babelHelpers.classPrivateFieldLooseBase(this,qe)[qe]=new je;babelHelpers.classPrivateFieldLooseBase(this,ze)[ze]=new w;babelHelpers.classPrivateFieldLooseBase(this,Je)[Je]=new Ne}getModuleId(){return"im"}handleMessage(e){babelHelpers.classPrivateFieldLooseBase(this,Ee)[Ee].handleMessageAdd(e)}handleMessageChat(e){babelHelpers.classPrivateFieldLooseBase(this,Ee)[Ee].handleMessageAdd(e)}handleMessageUpdate(e){babelHelpers.classPrivateFieldLooseBase(this,Ee)[Ee].handleMessageUpdate(e)}handleMessageDeleteV2(e){babelHelpers.classPrivateFieldLooseBase(this,Ee)[Ee].handleMessageDeleteV2(e)}handleMessageDelete(e){babelHelpers.classPrivateFieldLooseBase(this,Ee)[Ee].handleMessageDelete(e)}handleMessageDeleteComplete(e){babelHelpers.classPrivateFieldLooseBase(this,Ee)[Ee].handleMessageDeleteComplete(e)}handleAddReaction(e){babelHelpers.classPrivateFieldLooseBase(this,Ee)[Ee].handleAddReaction(e)}handleDeleteReaction(e){babelHelpers.classPrivateFieldLooseBase(this,Ee)[Ee].handleDeleteReaction(e)}handleMessageParamsUpdate(e){babelHelpers.classPrivateFieldLooseBase(this,Ee)[Ee].handleMessageParamsUpdate(e)}handleReadMessage(e,s){babelHelpers.classPrivateFieldLooseBase(this,Ee)[Ee].handleReadMessage(e,s)}handleReadMessageChat(e,s){babelHelpers.classPrivateFieldLooseBase(this,Ee)[Ee].handleReadMessage(e,s)}handleReadMessageOpponent(e){babelHelpers.classPrivateFieldLooseBase(this,Ee)[Ee].handleReadMessageOpponent(e)}handleReadMessageChatOpponent(e){babelHelpers.classPrivateFieldLooseBase(this,Ee)[Ee].handleReadMessageOpponent(e)}handlePinAdd(e){babelHelpers.classPrivateFieldLooseBase(this,Ee)[Ee].handlePinAdd(e)}handlePinDelete(e){babelHelpers.classPrivateFieldLooseBase(this,Ee)[Ee].handlePinDelete(e)}handleChatOwner(e){babelHelpers.classPrivateFieldLooseBase(this,Xe)[Xe].handleChatOwner(e)}handleChatManagers(e){babelHelpers.classPrivateFieldLooseBase(this,Xe)[Xe].handleChatManagers(e)}handleChatUserAdd(e){babelHelpers.classPrivateFieldLooseBase(this,Xe)[Xe].handleChatUserAdd(e)}handleChatUserLeave(e){babelHelpers.classPrivateFieldLooseBase(this,Xe)[Xe].handleChatUserLeave(e)}handleInputActionNotify(e){babelHelpers.classPrivateFieldLooseBase(this,Xe)[Xe].handleInputActionNotify(e)}handleChatUnread(e){babelHelpers.classPrivateFieldLooseBase(this,Xe)[Xe].handleChatUnread(e)}handleReadAllChats(){babelHelpers.classPrivateFieldLooseBase(this,Xe)[Xe].handleReadAllChats()}handleReadAllChatsByType(e){babelHelpers.classPrivateFieldLooseBase(this,Xe)[Xe].handleReadAllChatsByType(e)}handleChatMuteNotify(e){babelHelpers.classPrivateFieldLooseBase(this,Xe)[Xe].handleChatMuteNotify(e)}handleChatRename(e){babelHelpers.classPrivateFieldLooseBase(this,Xe)[Xe].handleChatRename(e)}handleChatAvatar(e){babelHelpers.classPrivateFieldLooseBase(this,Xe)[Xe].handleChatAvatar(e)}handleChatUpdate(e){babelHelpers.classPrivateFieldLooseBase(this,Xe)[Xe].handleChatUpdate(e)}handleChatFieldsUpdate(e){babelHelpers.classPrivateFieldLooseBase(this,Xe)[Xe].handleChatFieldsUpdate(e)}handleChatDelete(e){babelHelpers.classPrivateFieldLooseBase(this,Xe)[Xe].handleChatDelete(e)}handleChatConvert(e){babelHelpers.classPrivateFieldLooseBase(this,Xe)[Xe].handleChatConvert(e)}handleMessagesAutoDeleteDelayChanged(e){babelHelpers.classPrivateFieldLooseBase(this,Xe)[Xe].handleMessagesAutoDeleteDelayChanged(e)}handleUserInvite(e){babelHelpers.classPrivateFieldLooseBase(this,Ve)[Ve].handleUserInvite(e)}handleUserShowInRecent(e){babelHelpers.classPrivateFieldLooseBase(this,Ve)[Ve].handleUserShowInRecent(e)}handleDesktopOnline(e){babelHelpers.classPrivateFieldLooseBase(this,_e)[_e].handleDesktopOnline(e)}handleDesktopOffline(){babelHelpers.classPrivateFieldLooseBase(this,_e)[_e].handleDesktopOffline()}handleSettingsUpdate(e){babelHelpers.classPrivateFieldLooseBase(this,xe)[xe].handleSettingsUpdate(e)}handleCommentSubscribe(e){babelHelpers.classPrivateFieldLooseBase(this,Ge)[Ge].handleCommentSubscribe(e)}handleReadAllChannelComments(e){babelHelpers.classPrivateFieldLooseBase(this,Ge)[Ge].handleReadAllChannelComments(e)}handleChangeTariff(e){babelHelpers.classPrivateFieldLooseBase(this,We)[We].handleChangeTariff(e)}handleUpdateCollabEntityCounter(e){babelHelpers.classPrivateFieldLooseBase(this,qe)[qe].handleUpdateCollabEntityCounter(e)}handleUpdateCollabGuestCount(e){babelHelpers.classPrivateFieldLooseBase(this,qe)[qe].handleUpdateCollabGuestCount(e)}handleApplicationOpenChat(e){babelHelpers.classPrivateFieldLooseBase(this,Ye)[Ye].handleApplicationOpenChat(e)}handleBotAdd(e){babelHelpers.classPrivateFieldLooseBase(this,ze)[ze].handleBotAdd(e)}handleBotUpdate(e){babelHelpers.classPrivateFieldLooseBase(this,ze)[ze].handleBotUpdate(e)}handleChangeEngine(e){babelHelpers.classPrivateFieldLooseBase(this,Je)[Je].handleChangeEngine(e)}handleFileTranscription(e){babelHelpers.classPrivateFieldLooseBase(this,Je)[Je].handleFileTranscription(e)}handleChatCopilotRoleUpdate(e){babelHelpers.classPrivateFieldLooseBase(this,Je)[Je].handleChatCopilotRoleUpdate(e)}}const Ze={[B.RecentType.default]:"recent/setRecent",[B.RecentType.copilot]:"recent/setCopilot",[B.RecentType.openChannel]:"recent/setChannel",[B.RecentType.collab]:"recent/setCollab",[B.RecentType.taskComments]:"recent/setTask"};var $e=babelHelpers.classPrivateFieldLooseKey("params");var es=babelHelpers.classPrivateFieldLooseKey("extra");class ss{constructor(e,s={}){Object.defineProperty(this,$e,{writable:true,value:void 0});Object.defineProperty(this,es,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,$e)[$e]=e;babelHelpers.classPrivateFieldLooseBase(this,es)[es]=s}getChatId(){return babelHelpers.classPrivateFieldLooseBase(this,$e)[$e].chatId}getParentChatId(){var e;return((e=this.getChat())==null?void 0:e.parent_chat_id)||0}getChat(){var e;const s=this.getChatId();return(e=babelHelpers.classPrivateFieldLooseBase(this,$e)[$e].chat)==null?void 0:e[s]}getChatType(){var e;const s=this.getChat();return(e=s==null?void 0:s.type)!=null?e:""}getRecentTypes(){return babelHelpers.classPrivateFieldLooseBase(this,$e)[$e].recentConfig.sections}isLinesChat(){return Boolean(babelHelpers.classPrivateFieldLooseBase(this,$e)[$e].lines)}isCommentChat(){return this.getChatType()===B.ChatType.comment}isChannelChat(){return v.ChannelManager.channelTypes.has(this.getChatType())}isUserInChat(){const e=babelHelpers.classPrivateFieldLooseBase(this,$e)[$e].userInChat[this.getChatId()];if(!e||this.isChannelListEvent()){return true}return e.includes(y.Core.getUserId())}isChannelListEvent(){return this.isChannelChat()&&babelHelpers.classPrivateFieldLooseBase(this,es)[es].is_shared_event}needToSkipMessageEvent(){return this.isLinesChat()||this.isCommentChat()||!this.isUserInChat()}getAddActions(){const e=this.getRecentTypes();return e.map((e=>Ze[e]))}}var as=babelHelpers.classPrivateFieldLooseKey("params");var ts=babelHelpers.classPrivateFieldLooseKey("setUsers");var ls=babelHelpers.classPrivateFieldLooseKey("setFiles");var is=babelHelpers.classPrivateFieldLooseKey("setMessageChat");var rs=babelHelpers.classPrivateFieldLooseKey("setMessage");class os{constructor(e){Object.defineProperty(this,rs,{value:hs});Object.defineProperty(this,is,{value:cs});Object.defineProperty(this,ls,{value:ns});Object.defineProperty(this,ts,{value:ds});Object.defineProperty(this,as,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,as)[as]=e}setLastMessageInfo(){babelHelpers.classPrivateFieldLooseBase(this,is)[is]();babelHelpers.classPrivateFieldLooseBase(this,ts)[ts]();babelHelpers.classPrivateFieldLooseBase(this,ls)[ls]();babelHelpers.classPrivateFieldLooseBase(this,rs)[rs]()}getDialogId(){return babelHelpers.classPrivateFieldLooseBase(this,as)[as].chat.dialogId}getLastMessageId(){const[e]=babelHelpers.classPrivateFieldLooseBase(this,as)[as].messages;return e.id}}function ds(){const e=new P.UserManager;e.setUsersToModel(babelHelpers.classPrivateFieldLooseBase(this,as)[as].users)}function ns(){y.Core.getStore().dispatch("files/set",babelHelpers.classPrivateFieldLooseBase(this,as)[as].files)}function cs(){const e={...babelHelpers.classPrivateFieldLooseBase(this,as)[as].chat,counter:babelHelpers.classPrivateFieldLooseBase(this,as)[as].counter,dialogId:this.getDialogId()};y.Core.getStore().dispatch("chats/set",e)}function hs(){const[e]=babelHelpers.classPrivateFieldLooseBase(this,as)[as].messages;y.Core.getStore().dispatch("messages/store",e)}function gs(e){const s={id:e.dialogId,chatId:e.chatId,messageId:e.message.id};const a=y.Core.getStore().getters["recent/get"](e.dialogId);if(a){s.isFakeElement=false;s.isBirthdayPlaceholder=false;s.liked=false}return s}var ps=babelHelpers.classPrivateFieldLooseKey("deleteLastMessage");var bs=babelHelpers.classPrivateFieldLooseKey("updateRecentForMessageDelete");class us{constructor(){Object.defineProperty(this,bs,{value:Ps});Object.defineProperty(this,ps,{value:vs})}getModuleId(){return"im"}handleMessage(e,s){this.handleMessageAdd(e,s)}handleMessageChat(e,s){this.handleMessageAdd(e,s)}handleMessageAdd(e,s){const a=new ss(e,s);if(a.needToSkipMessageEvent(e)){return}F.Logger.warn("RecentPullHandler: handleMessageAdd",e);const t=gs(e);const l=a.getAddActions();l.forEach((e=>{if(!e){return}y.Core.getStore().dispatch(e,t)}))}handleMessageDeleteV2(e){babelHelpers.classPrivateFieldLooseBase(this,ps)[ps](e.dialogId,e.newLastMessage)}handleMessageDeleteComplete(e){babelHelpers.classPrivateFieldLooseBase(this,ps)[ps](e.dialogId,e.newLastMessage)}handleChatUnread(e){F.Logger.warn("RecentPullHandler: handleChatUnread",e);y.Core.getStore().dispatch("recent/unread",{id:e.dialogId,action:e.active})}handleAddReaction(e){F.Logger.warn("RecentPullHandler: handleAddReaction",e);const s=y.Core.getStore().getters["recent/get"](e.dialogId);if(!s){return}const a=y.Core.getStore().getters["application/isChatOpen"](e.dialogId);if(a){return}const t=y.Core.getStore().getters["recent/getMessage"](e.dialogId);const l=y.Core.getUserId()===e.userId;const i=y.Core.getUserId()===t.authorId;if(l||!i){return}y.Core.getStore().dispatch("recent/like",{id:e.dialogId,messageId:e.actualReactions.reaction.messageId,liked:true})}handleChatPin(e){F.Logger.warn("RecentPullHandler: handleChatPin",e);const s=y.Core.getStore().getters["recent/get"](e.dialogId);if(!s){return}y.Core.getStore().dispatch("recent/pin",{id:e.dialogId,action:e.active})}handleChatHide(e){F.Logger.warn("RecentPullHandler: handleChatHide",e);const s=y.Core.getStore().getters["recent/get"](e.dialogId);if(!s){return}void y.Core.getStore().dispatch("recent/hide",{id:e.dialogId})}handleChatUserLeave(e){F.Logger.warn("RecentPullHandler: handleChatUserLeave",e);const s=y.Core.getStore().getters["recent/get"](e.dialogId);if(!s||e.userId!==y.Core.getUserId()){return}y.Core.getStore().dispatch("recent/hide",{id:e.dialogId})}handleUserInvite(e){var s;F.Logger.warn("RecentPullHandler: handleUserInvite",e);const a=u.Utils.text.getUuidV4();y.Core.getStore().dispatch("messages/store",{id:a,date:e.date});y.Core.getStore().dispatch("recent/setRecent",{id:e.user.id,invited:(s=e.invited)!=null?s:false,isFakeElement:true,messageId:a})}handleUserShowInRecent(e){F.Logger.warn("RecentPullHandler: handleUserShowInRecent",e);const{items:s}=e;s.forEach((e=>{const s=u.Utils.text.getUuidV4();y.Core.getStore().dispatch("messages/store",{id:s,date:e.date});y.Core.getStore().dispatch("recent/setRecent",{id:e.user.id,messageId:s})}))}handleRecentUpdate(e){F.Logger.warn("RecentPullHandler: handleRecentUpdate",e);const s=new os(e);s.setLastMessageInfo();const a={id:s.getDialogId(),messageId:s.getLastMessageId(),lastActivityDate:e.lastActivityDate};y.Core.getStore().dispatch("recent/setRecent",a)}}function vs(e,s){const a=Boolean(s);if(a){babelHelpers.classPrivateFieldLooseBase(this,bs)[bs](e,s.id)}}function Ps(e,s){if(!s){y.Core.getStore().dispatch("recent/hide",{id:e});return}y.Core.getStore().dispatch("recent/update",{id:e,fields:{messageId:s}})}var Cs=babelHelpers.classPrivateFieldLooseKey("getChannelByParentChatId");class fs{constructor(){Object.defineProperty(this,Cs,{value:Is})}getModuleId(){return"im"}handleMessage(e,s){this.handleMessageAdd(e,s)}handleMessageChat(e,s){this.handleMessageAdd(e,s)}handleMessageAdd(e,s){if(e.counter===0||H.Type.isUndefined(e.counter)){return}F.Logger.warn("UnreadRecentPullHandler: handleMessageAdd",e);const a=new ss(e,s);if(a.isCommentChat()){const e=a.getParentChatId();const s=babelHelpers.classPrivateFieldLooseBase(this,Cs)[Cs](e);if(!s){return}void y.Core.getStore().dispatch("recent/setUnread",s);return}const t=gs(e);void y.Core.getStore().dispatch("recent/setUnread",t)}}function Is(e){const{dialogId:s}=y.Core.getStore().getters["chats/getByChatId"](e);const a=y.Core.getStore().getters["recent/getRecentCollection"];return a.find((e=>e.dialogId===s))}class Ls{constructor(){this.store=y.Core.getStore();this.userManager=new P.UserManager;this.updateCounterDebounced=H.Runtime.debounce(this.updateCounter,1500,this)}getModuleId(){return"im"}getSubscriptionType(){return"server"}handleNotifyAdd(e){if(e.onlyFlash===true){return}this.userManager.setUsersToModel(e.users);this.store.dispatch("notifications/set",e);this.updateCounterDebounced(e.counter)}handleNotifyConfirm(e){this.store.dispatch("notifications/delete",{id:e.id});this.updateCounterDebounced(e.counter)}handleNotifyRead(e){e.list.forEach((e=>{this.store.dispatch("notifications/read",{ids:[e],read:true})}));if(e.counter<this.store.getters["notifications/getCounter"]){this.updateCounterDebounced(e.counter)}}handleNotifyUnread(e){e.list.forEach((e=>{this.store.dispatch("notifications/read",{ids:[e],read:false})}));if(e.counter>this.store.getters["notifications/getCounter"]){this.updateCounterDebounced(e.counter)}}handleNotifyReadAll(e){const s=e.excludeIds||[];void this.store.dispatch("notifications/readAllSimple",{excludeIds:s});this.updateCounterDebounced(e.newCounter)}handleNotifyDelete(e){const s=Object.keys(e.id).map((e=>Number.parseInt(e,10)));s.forEach((e=>{this.store.dispatch("notifications/delete",{id:e})}));this.updateCounterDebounced(e.counter)}updateCounter(e){this.store.dispatch("notifications/setCounter",e)}}class Hs{constructor(){this.store=y.Core.getStore();this.userManager=new P.UserManager}getModuleId(){return"im"}handleChatUserAdd(e){if(this.getMembersCountFromStore(e.chatId)===0){return}const{chatId:s,users:a,newUsers:t,relations:l}=e;void this.userManager.setUsersToModel(Object.values(a));const i=t.filter((e=>{const{isHidden:s}=l.find((s=>s.userId===e));return!s}));void this.store.dispatch("sidebar/members/set",{chatId:s,users:i})}handleChatUserLeave(e){if(this.getMembersCountFromStore(e.chatId)===0){return}void this.store.dispatch("sidebar/members/delete",{chatId:e.chatId,userId:e.userId})}handleTaskAdd(e){if(!this.isSidebarInited(e.link.chatId)){return}void this.userManager.setUsersToModel(e.users);void this.store.dispatch("sidebar/tasks/set",{chatId:e.link.chatId,tasks:[e.link]})}handleTaskUpdate(e,s){this.handleTaskAdd(e,s)}handleTaskDelete(e){if(!this.isSidebarInited(e.chatId)){return}void this.store.dispatch("sidebar/tasks/delete",{chatId:e.chatId,id:e.linkId})}handleCalendarAdd(e){if(!this.isSidebarInited(e.link.chatId)){return}void this.userManager.setUsersToModel(e.users);void this.store.dispatch("sidebar/meetings/set",{chatId:e.link.chatId,meetings:[e.link]})}handleCalendarUpdate(e,s){this.handleCalendarAdd(e,s)}handleCalendarDelete(e){if(!this.isSidebarInited(e.chatId)){return}void this.store.dispatch("sidebar/meetings/delete",{chatId:e.chatId,id:e.linkId})}handleUrlAdd(e){if(!this.isSidebarInited(e.link.chatId)){return}void this.userManager.setUsersToModel(e.users);void this.store.dispatch("sidebar/links/set",{chatId:e.link.chatId,links:[e.link]});const s=this.store.getters["sidebar/links/getCounter"](e.link.chatId);void this.store.dispatch("sidebar/links/setCounter",{chatId:e.link.chatId,counter:s+1})}handleUrlDelete(e){if(!this.isSidebarInited(e.chatId)){return}void this.store.dispatch("sidebar/links/delete",{chatId:e.chatId,id:e.linkId})}handleMessageFavoriteAdd(e){if(!this.isSidebarInited(e.link.chatId)){return}void this.userManager.setUsersToModel(e.users);void this.store.dispatch("files/set",e.files);void this.store.dispatch("messages/store",[e.link.message]);void this.store.dispatch("sidebar/favorites/set",{chatId:e.link.chatId,favorites:[e.link]});const s=this.store.getters["sidebar/favorites/getCounter"](e.link.chatId);void this.store.dispatch("sidebar/favorites/setCounter",{chatId:e.link.chatId,counter:s+1})}handleMessageFavoriteDelete(e){if(!this.isSidebarInited(e.chatId)){return}void this.store.dispatch("sidebar/favorites/delete",{chatId:e.chatId,id:e.linkId})}handleFileAdd(e){var s;if(!this.isSidebarInited(e.link.chatId)){return}void this.userManager.setUsersToModel(e.users);void this.store.dispatch("files/set",e.files);const a=(s=e.link.group)!=null?s:B.SidebarDetailBlock.fileUnsorted;void this.store.dispatch("sidebar/files/set",{chatId:e.link.chatId,files:[e.link],group:a})}handleFileDelete(e){var s;const a=H.Type.isNumber(e.chatId)?e.chatId:Number.parseInt(e.chatId,10);if(!this.isSidebarInited(a)){return}const t=(s=e.linkId)!=null?s:e.fileId;void this.store.dispatch("sidebar/files/delete",{chatId:a,id:t})}handleChangeMultidialogSessionsLimit(e){void this.store.dispatch("sidebar/multidialog/setOpenSessionsLimit",e.limit)}handleAddMultidialog(e){const{multidialog:s,count:a}=e;const t=s.isSupport;if(!t){return}void this.store.dispatch("sidebar/multidialog/setChatsCount",a);void this.store.dispatch("sidebar/multidialog/addMultidialogs",[s])}handleReadMessageChat(e){this.deleteUnreadSupportChats(e)}handleReadMessage(e){this.deleteUnreadSupportChats(e)}handleChangeMultidialogStatus(e){const{bot:s,chat:a,multidialog:t}=e;const l=t.isSupport;if(!l){return}if(a){void this.store.dispatch("chats/set",a)}if(s){void this.userManager.setUsersToModel(s)}void this.store.dispatch("sidebar/multidialog/addMultidialogs",[t])}handleMessage(e){this.setUnreadSupportTickets(e.multidialog)}handleChatUnread(e){const{chatId:s,dialogId:a}=e;const t=this.store.getters["sidebar/multidialog/isSupport"](a);const l=this.store.getters["sidebar/multidialog/isInited"];if(t&&l){void this.store.dispatch("sidebar/multidialog/setUnreadChats",[s])}}handleMessageChat(e){this.setFiles(e);this.setUnreadSupportTickets(e.multidialog)}deleteUnreadSupportChats(e){const s=e.counter===0;if(s){void this.store.dispatch("sidebar/multidialog/deleteUnreadChats",e.chatId)}}setUnreadSupportTickets(e){if(!e){return}const s=this.store.getters["sidebar/multidialog/get"](e.chatId);const a=(s==null?void 0:s.status)||e.status;void this.store.dispatch("sidebar/multidialog/addMultidialogs",[{...e,status:a}]);void this.store.dispatch("sidebar/multidialog/setUnreadChats",[e.chatId])}setFiles(e){const{chatId:s,users:a,files:t}=e;if(!this.isSidebarInited(s)||this.areFilesMigrated()){return}void this.userManager.setUsersToModel(Object.values(a));void this.store.dispatch("files/set",Object.values(t));Object.values(t).forEach((e=>{var s;const a=(s=e.group)!=null?s:B.SidebarDetailBlock.fileUnsorted;void this.store.dispatch("sidebar/files/set",{chatId:e.chatId,files:[e],group:a})}))}isSidebarInited(e){return this.store.getters["sidebar/isInited"](e)}areFilesMigrated(){return this.store.state.sidebar.isFilesMigrated}getMembersCountFromStore(e){return this.store.getters["sidebar/members/getSize"](e)}}var Fs=babelHelpers.classPrivateFieldLooseKey("shouldHandleMessageNotification");var ms=babelHelpers.classPrivateFieldLooseKey("shouldHandleNotification");var Bs=babelHelpers.classPrivateFieldLooseKey("shouldShowLinesNotification");var Ms=babelHelpers.classPrivateFieldLooseKey("isLinesChatOpened");var ys=babelHelpers.classPrivateFieldLooseKey("isImportantMessage");var Us=babelHelpers.classPrivateFieldLooseKey("shouldShowToUser");var ws=babelHelpers.classPrivateFieldLooseKey("isUserDnd");var Ss=babelHelpers.classPrivateFieldLooseKey("desktopWillShowNotification");var ks=babelHelpers.classPrivateFieldLooseKey("restoreLastNotificationId");var As=babelHelpers.classPrivateFieldLooseKey("updateLastNotificationId");var Os=babelHelpers.classPrivateFieldLooseKey("setCurrentUserStatus");var Ds=babelHelpers.classPrivateFieldLooseKey("isExpired");var Rs=babelHelpers.classPrivateFieldLooseKey("checkLastNotificationId");var Ts=babelHelpers.classPrivateFieldLooseKey("isCurrentUserSender");class js{constructor(){Object.defineProperty(this,Ts,{value:Qs});Object.defineProperty(this,Rs,{value:Js});Object.defineProperty(this,Ds,{value:zs});Object.defineProperty(this,Os,{value:qs});Object.defineProperty(this,As,{value:Ys});Object.defineProperty(this,ks,{value:Ws});Object.defineProperty(this,Ss,{value:Gs});Object.defineProperty(this,ws,{value:xs});Object.defineProperty(this,Us,{value:_s});Object.defineProperty(this,ys,{value:Vs});Object.defineProperty(this,Ms,{value:Xs});Object.defineProperty(this,Bs,{value:Es});Object.defineProperty(this,ms,{value:Ns});Object.defineProperty(this,Fs,{value:Ks});this.lastNotificationId=0;this.store=y.Core.getStore();babelHelpers.classPrivateFieldLooseBase(this,Os)[Os]();babelHelpers.classPrivateFieldLooseBase(this,ks)[ks]()}getModuleId(){return"im"}handleMessage(e,s){this.handleMessageAdd(e,s)}handleMessageChat(e,s){this.handleMessageAdd(e,s)}handleMessageAdd(e,s){if(!babelHelpers.classPrivateFieldLooseBase(this,Fs)[Fs](e,s)){return}void C.MessageNotifierManager.getInstance().handleIncomingMessage({dialogId:e.dialogId.toString(),isImportant:babelHelpers.classPrivateFieldLooseBase(this,ys)[ys](e),messageId:e.message.id,isLines:Boolean(e.lines)});babelHelpers.classPrivateFieldLooseBase(this,As)[As](e.message.id)}handleNotifyAdd(e,s){if(!babelHelpers.classPrivateFieldLooseBase(this,ms)[ms](e,s)){return}C.MessageNotifierManager.getInstance().handleIncomingNotification({notificationId:e.id,userId:e.userId,isSilent:e.silent==="Y"});babelHelpers.classPrivateFieldLooseBase(this,As)[As](e.id)}}function Ks(e,s){if(babelHelpers.classPrivateFieldLooseBase(this,Ds)[Ds](s)){return false}if(!babelHelpers.classPrivateFieldLooseBase(this,Rs)[Rs](e.message.id)){return false}if(babelHelpers.classPrivateFieldLooseBase(this,Ts)[Ts](e)){return false}if(e.lines&&!babelHelpers.classPrivateFieldLooseBase(this,Bs)[Bs](e)){return false}if(!babelHelpers.classPrivateFieldLooseBase(this,Us)[Us](e)||babelHelpers.classPrivateFieldLooseBase(this,Ss)[Ss]()){return false}const a=I.CallManager.getInstance().hasCurrentCall();if(a&&I.CallManager.getInstance().getCurrentCallDialogId()!==e.dialogId.toString()){return false}const t=I.CallManager.getInstance().hasCurrentScreenSharing();return!t}function Ns(e,s){if(babelHelpers.classPrivateFieldLooseBase(this,Ds)[Ds](s)||!babelHelpers.classPrivateFieldLooseBase(this,Rs)[Rs](e.id)){return false}if(e.onlyFlash===true||babelHelpers.classPrivateFieldLooseBase(this,ws)[ws]()||babelHelpers.classPrivateFieldLooseBase(this,Ss)[Ss]()||I.CallManager.getInstance().hasCurrentCall()){return false}if(document.hasFocus()){const e=this.store.getters["application/areNotificationsOpen"];if(e){return false}}return true}function Es(e){if(babelHelpers.classPrivateFieldLooseBase(this,Ms)[Ms](e.dialogId)){return false}const s=e.message.senderId;if(s>0&&e.users[s].type!==B.UserType.extranet){return true}const a=this.store.getters["counters/getSpecificLinesCounter"](e.chatId);return a===0}function Xs(e){const s=this.store.getters["application/isLinesChatOpen"](e);return Boolean(document.hasFocus()&&s)}function Vs(e){const{message:s}=e;return s.isImportant||s.importantFor.includes(y.Core.getUserId())}function _s(e){if(babelHelpers.classPrivateFieldLooseBase(this,ys)[ys](e)){return true}const{notify:s,message:a,dialogId:t}=e;const l=a==null?void 0:a.params;const i=!s||(l==null?void 0:l.NOTIFY)==="N";if(i){return false}const r=this.store.getters["chats/get"](t,true);const o=r.muteList.includes(y.Core.getUserId());return!babelHelpers.classPrivateFieldLooseBase(this,ws)[ws]()&&!o}function xs(){const e=this.store.getters["application/settings/get"](B.Settings.user.status);return e===B.UserStatus.dnd}function Gs(){const e=f.DesktopManager.isChatWindow();return!e&&f.DesktopManager.getInstance().isDesktopActive()}function Ws(){const e=L.LocalStorageManager.getInstance().get(B.LocalStorageKey.lastNotificationId,0);this.lastNotificationId=Number.parseInt(e,10)}function Ys(e){const s=2e3;this.lastNotificationId=e;clearTimeout(this.writeToStorageTimeout);this.writeToStorageTimeout=setTimeout((()=>{L.LocalStorageManager.getInstance().set(B.LocalStorageKey.lastNotificationId,e)}),s)}function qs(){var e;const s=y.Core.getApplicationData();if(!((e=s.settings)!=null&&e.status)){return}y.Core.getStore().dispatch("application/settings/set",{[B.Settings.user.status]:s.settings.status})}function zs(e){if(e.server_time_ago>10){F.Logger.warn("NotifierPullHandler: received notification 10 seconds after it was actually sent, ignore");return true}return false}function Js(e){if(e<=this.lastNotificationId){F.Logger.warn("NotifierPullHandler: new message id is smaller than lastNotificationId");return false}return true}function Qs(e){return y.Core.getUserId()===e.message.senderId}class Zs{constructor(){this.store=y.Core.getStore()}getModuleId(){return"online"}getSubscriptionType(){return"online"}handleUserStatus(e){const s=y.Core.getUserId();if(H.Type.isPlainObject(e.users[s])){const{status:a}=e.users[s];this.store.dispatch("application/settings/set",{status:a})}Object.values(e.users).forEach((e=>{this.store.dispatch("users/update",{id:e.id,fields:{lastActivityDate:e.last_activity_date}})}))}}var $s=babelHelpers.classPrivateFieldLooseKey("handleCounters");var ea=babelHelpers.classPrivateFieldLooseKey("getNewCounter");var sa=babelHelpers.classPrivateFieldLooseKey("updateCommentCounter");var aa=babelHelpers.classPrivateFieldLooseKey("handleUnloadedChatCounters");var ta=babelHelpers.classPrivateFieldLooseKey("getRecentSectionConfig");class la{constructor(){Object.defineProperty(this,ta,{value:na});Object.defineProperty(this,aa,{value:da});Object.defineProperty(this,sa,{value:oa});Object.defineProperty(this,ea,{value:ra});Object.defineProperty(this,$s,{value:ia});this.store=y.Core.getStore()}getModuleId(){return"im"}handleMessage(e,s){this.handleMessageAdd(e,s)}handleMessageChat(e,s){this.handleMessageAdd(e,s)}handleMessageAdd(e,s){const a=new m.NewMessageManager(e,s);if(!a.isCommentChat()){return}babelHelpers.classPrivateFieldLooseBase(this,sa)[sa]({channelChatId:a.getParentChatId(),commentChatId:a.getChatId(),commentCounter:e.counter})}handleMessageDeleteComplete(e){babelHelpers.classPrivateFieldLooseBase(this,$s)[$s](e)}handleReadMessage(e){babelHelpers.classPrivateFieldLooseBase(this,$s)[$s](e)}handleReadMessageChat(e){babelHelpers.classPrivateFieldLooseBase(this,$s)[$s](e)}handleUnreadMessage(e){babelHelpers.classPrivateFieldLooseBase(this,$s)[$s](e)}handleUnreadMessageChat(e){babelHelpers.classPrivateFieldLooseBase(this,$s)[$s](e)}handleChatUnread(e){babelHelpers.classPrivateFieldLooseBase(this,$s)[$s]({...e,unread:e.active})}handleChatMuteNotify(e){babelHelpers.classPrivateFieldLooseBase(this,$s)[$s](e)}}function ia(e){const{chatId:s,counter:a,counterType:t=B.CounterType.chat,parentChatId:l=0}=e;if(t===B.CounterType.openline){return}F.Logger.warn("CounterPullHandler: handleCounters:",e);if(t===B.CounterType.comment){babelHelpers.classPrivateFieldLooseBase(this,sa)[sa]({channelChatId:l,commentChatId:s,commentCounter:a});return}babelHelpers.classPrivateFieldLooseBase(this,aa)[aa](e)}function ra(e){const{counter:s,muted:a,unread:t}=e;let l=0;if(a){l=0}else if(t&&s===0){l=1}else if(t&&s>0){l=s}else if(!t){l=s}return l}function oa(e){const{channelChatId:s,commentChatId:a,commentCounter:t}=e;if(H.Type.isUndefined(t)){return}const l={[s]:{[a]:t}};y.Core.getStore().dispatch("counters/setCommentCounters",l)}function da(e){const{chatId:s,recentConfig:a,dialogId:t}=e;const l=babelHelpers.classPrivateFieldLooseBase(this,ea)[ea](e);a.sections.forEach((e=>{const a=babelHelpers.classPrivateFieldLooseBase(this,ta)[ta](e);if(!a){return}const i=this.store.getters[a.collectionGetter](t);if(i){return}void y.Core.getStore().dispatch(a.setUnloadedCounterAction,{[s]:l})}))}function na(e){const s={[B.RecentType.default]:{setUnloadedCounterAction:"counters/setUnloadedChatCounters",collectionGetter:"recent/isInRecentCollection"},[B.RecentType.collab]:{setUnloadedCounterAction:"counters/setUnloadedCollabCounters",collectionGetter:"recent/isInCollabCollection"},[B.RecentType.copilot]:{setUnloadedCounterAction:"counters/setUnloadedCopilotCounters",collectionGetter:"recent/isInCopilotCollection"},[B.RecentType.taskComments]:{setUnloadedCounterAction:"counters/setUnloadedTaskCounters",collectionGetter:"recent/isInTaskCollection"}};return s[e]}class ca{getModuleId(){return"im"}handlePromotionUpdated(e){M.PromoManager.getInstance().onPromotionUpdated(e)}}class ha{constructor(){this.store=y.Core.getStore()}getModuleId(){return"im"}handleAddAnchor(e){this.store.dispatch("messages/anchors/addAnchor",{anchor:e})}handleDeleteAnchor(e){this.store.dispatch("messages/anchors/removeAnchor",{anchor:e})}handleDeleteAnchors(e){const{chatIds:s}=e;s.forEach((e=>{void this.store.dispatch("messages/anchors/removeChatAnchors",e)}))}handleDeleteChatAnchors(e){this.store.dispatch("messages/anchors/removeChatAnchors",e.chatId)}}class ga{constructor(){this.store=y.Core.getStore()}getModuleId(){return"im"}handleStickerRecentDelete(e){const{id:s,packType:a,packId:t}=e;void y.Core.getStore().dispatch("stickers/recent/delete",{id:s,packType:a,packId:t})}handleStickerRecentDeleteAll(){void y.Core.getStore().dispatch("stickers/recent/clear")}handleStickerPackAdd(e){const{pack:s,stickers:a}=e;void y.Core.getStore().dispatch("stickers/packs/addNew",s);void y.Core.getStore().dispatch("stickers/set",a)}handleStickerPackLink(e){this.handleStickerPackAdd(e)}handleStickerPackDelete(e){void y.Core.getStore().dispatch("stickers/packs/delete",e);void y.Core.getStore().dispatch("stickers/deleteByPack",e)}handleStickerPackUnlink(e){void y.Core.getStore().dispatch("stickers/packs/unlink",e)}handleStickerPackRename(e){void y.Core.getStore().dispatch("stickers/packs/rename",e)}handleStickerAdd(e){this.handleStickerPackAdd(e)}handleStickerDelete(e){void y.Core.getStore().dispatch("stickers/delete",e)}}e.BasePullHandler=Qe;e.RecentPullHandler=us;e.RecentUnreadPullHandler=fs;e.NotificationPullHandler=Ls;e.SidebarPullHandler=Hs;e.NotifierPullHandler=js;e.OnlinePullHandler=Zs;e.CounterPullHandler=la;e.PromotionPullHandler=ca;e.AnchorPullHandler=ha;e.StickersPullHandler=ga;e.NewMessageManager=ss})(this.BX.Messenger.v2.Provider.Pull=this.BX.Messenger.v2.Provider.Pull||{},BX.Messenger.v2.Lib,BX.Messenger.v2.Service,BX.Event,BX.Vue3.Vuex,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX.SidePanel,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX,BX.Messenger.v2.Lib,BX.Messenger.v2.Provider.Pull,BX.Messenger.v2.Const,BX.Messenger.v2.Lib,BX.Messenger.v2.Application);
//# sourceMappingURL=registry.bundle.map.js