this.BX=this.BX||{};this.BX.Messenger=this.BX.Messenger||{};this.BX.Messenger.v2=this.BX.Messenger.v2||{};this.BX.Messenger.v2.Component=this.BX.Messenger.v2.Component||{};(function(t,e,i,n,a,s,r,o,l,d,u,c,h,p,m,y,v,b){"use strict";const g=Object.freeze({play:"play",pause:"pause",stop:"stop",none:"none"});const f=Object.freeze({none:"none",metadata:"metadata",auto:"auto"});const P={name:"DefaultVideoPlayer",components:{FadeAnimation:m.FadeAnimation},props:{fileId:{type:[Number,String],default:0},src:{type:String,required:true},previewImageUrl:{type:String,default:""},withAutoplay:{type:Boolean,default:true},elementStyle:{type:Object,default:null},withPlayerControls:{type:Boolean,default:true},viewerAttributes:{type:Object,default:()=>{}}},data(){return{preloadAttribute:f.none,loaded:false,loading:false,state:g.none,timeCurrent:0,timeTotal:0,isMuted:true}},computed:{State:()=>g,isAutoPlayDisabled(){return!this.withAutoplay&&this.state===g.none},showStartButton(){return this.withPlayerControls&&this.isAutoPlayDisabled},showInterface(){return this.withPlayerControls&&!this.showStartButton},formattedTime(){if(!this.loaded&&!this.timeTotal){return"--:--"}let t=0;if(this.state===g.play){t=this.timeTotal-this.timeCurrent}else{t=this.timeTotal}return b.Utils.date.formatMediaDurationTime(t)},controlButtonClass(){if(this.loading){return"--loading"}return this.state===g.play?"--pause":"--play"},source(){return this.$refs.source},hasViewerAttributes(){return Object.keys(this.viewerAttributes).length>0}},created(){if(!this.previewImageUrl){this.preloadAttribute=f.metadata}},mounted(){this.getObserver().observe(this.$refs.body)},beforeUnmount(){this.getObserver().unobserve(this.$refs.body)},methods:{loadFile(){if(this.loaded||this.loading){return}this.preloadAttribute=f.auto;this.loading=true;this.playAfterLoad=true},handleControlClick(){if(this.state===g.play){this.getObserver().unobserve(this.$refs.body);this.pause()}else{this.play()}},handleMuteClick(){if(this.isMuted){this.unmute()}else{this.mute()}},handleContainerClick(){if(this.hasViewerAttributes){this.pause();return}this.handleControlClick()},play(){if(!this.loaded){this.loadFile();return}void this.source.play()},pause(){this.source.pause()},mute(){this.isMuted=true;this.source.muted=true},unmute(){this.isMuted=false;this.source.muted=false},handleError(t){console.error("Im.VideoPlayer: loading failed",this.fileId,t);this.loading=false;this.state=g.none;this.timeTotal=0;this.preloadAttribute=f.none},handleAbort(t){this.handleError(t)},handlePlay(){this.state=g.play},handleLoadedData(){this.timeTotal=this.source.duration},handleDurationChange(){this.handleLoadedData()},handleLoadedMetaData(){this.timeTotal=this.source.duration;this.loaded=true;this.play()},handleCanPlayThrough(){this.loading=false;this.loaded=true;this.play()},handlePause(){if(this.state===g.stop){return}this.state=g.pause},handleVolumeChange(){if(this.source.muted){this.mute()}else{this.unmute()}},handleTimeUpdate(){this.timeCurrent=this.source.currentTime},getObserver(){if(this.observer){return this.observer}this.observer=new IntersectionObserver((t=>{if(this.isAutoPlayDisabled){return}t.forEach((t=>{if(t.isIntersecting){this.play()}else{this.pause()}}))}),{threshold:[0,1]});return this.observer}},template:`\n\t\t<div class="bx-im-video-player__container" @click.stop="handleContainerClick">\n\t\t\t<FadeAnimation :duration="500">\n\t\t\t\t<div v-if="showStartButton" class="bx-im-video-player__start-play_button" @click.stop="handleControlClick">\n\t\t\t\t\t<span class="bx-im-video-player__start-play_icon"></span>\n\t\t\t\t</div>\n\t\t\t</FadeAnimation>\n\t\t\t<FadeAnimation :duration="500">\n\t\t\t\t<div v-if="showInterface" class="bx-im-video-player__control-button_container" @click.stop="handleControlClick">\n\t\t\t\t\t<button class="bx-im-video-player__control-button" :class="controlButtonClass"></button>\n\t\t\t\t</div>\n\t\t\t</FadeAnimation>\n\t\t\t<FadeAnimation :duration="500">\n\t\t\t\t<div \n\t\t\t\t\tv-if="showInterface" \n\t\t\t\t\tclass="bx-im-video-player__info-container" \n\t\t\t\t\t@click.stop="handleMuteClick"\n\t\t\t\t>\n\t\t\t\t\t<span class="bx-im-video-player__time">{{ formattedTime }}</span>\n\t\t\t\t\t<span class="bx-im-video-player__sound" :class="{'--muted': isMuted}"></span>\n\t\t\t\t</div>\n\t\t\t</FadeAnimation>\n\t\t\t<div class="bx-im-video-player__video-container" ref="body">\n\t\t\t\t<video\n\t\t\t\t\tv-bind="viewerAttributes"\n\t\t\t\t\t:src="src"\n\t\t\t\t\tclass="bx-im-video-player__video"\n\t\t\t\t\t:poster="previewImageUrl"\n\t\t\t\t\tref="source"\n\t\t\t\t\t:preload="preloadAttribute"\n\t\t\t\t\tplaysinline\n\t\t\t\t\tloop\n\t\t\t\t\tmuted\n\t\t\t\t\t:style="elementStyle"\n\t\t\t\t\t@abort="handleAbort"\n\t\t\t\t\t@error="handleError"\n\t\t\t\t\t@canplaythrough="handleCanPlayThrough"\n\t\t\t\t\t@durationchange="handleDurationChange"\n\t\t\t\t\t@loadeddata="handleLoadedData"\n\t\t\t\t\t@loadedmetadata="handleLoadedMetaData"\n\t\t\t\t\t@volumechange="handleVolumeChange"\n\t\t\t\t\t@timeupdate="handleTimeUpdate"\n\t\t\t\t\t@play="handlePlay"\n\t\t\t\t\t@pause="handlePause"\n\t\t\t\t></video>\n\t\t\t</div>\n\t\t</div>\n\t`};var T=babelHelpers.classPrivateFieldLooseKey("instance");var _=babelHelpers.classPrivateFieldLooseKey("files");var S=babelHelpers.classPrivateFieldLooseKey("getNextFile");class I{constructor(){Object.defineProperty(this,S,{value:E});Object.defineProperty(this,_,{writable:true,value:{}})}static getInstance(){if(!babelHelpers.classPrivateFieldLooseBase(this,T)[T]){babelHelpers.classPrivateFieldLooseBase(this,T)[T]=new this}return babelHelpers.classPrivateFieldLooseBase(this,T)[T]}register(t){if(!babelHelpers.classPrivateFieldLooseBase(this,_)[_][t.chatId]){babelHelpers.classPrivateFieldLooseBase(this,_)[_][t.chatId]=new Set}babelHelpers.classPrivateFieldLooseBase(this,_)[_][t.chatId].add(t)}unregister(t){babelHelpers.classPrivateFieldLooseBase(this,_)[_][t.chatId].delete(t)}onFileEnded(t){const{file:e,context:{emitter:i}}=t;const n=babelHelpers.classPrivateFieldLooseBase(this,S)[S](e);if(!n){return}i.emit(y.EventType.roundVideoPlayer.playNext,{fileId:n.id})}}function E(t){const e=[...babelHelpers.classPrivateFieldLooseBase(this,_)[_][t.chatId]];e.sort(((t,e)=>t.date-e.date));const i=e.indexOf(t);return e[i+1]}Object.defineProperty(I,T,{writable:true,value:void 0});const A=130;const x=A*2;const k=1;const R={name:"RoundProgressBar",props:{progress:{type:Number,required:true,validator:t=>t>=0&&t<=100}},computed:{PLAYER_RADIUS:()=>A,PLAYER_DIAMETER:()=>x,PLAYER_PROGRESS_MARGIN:()=>k,progressStyles(){const t=A-k;const e=2*Math.PI*t;const i=e-this.progress/100*e;return{strokeDasharray:e,strokeDashoffset:i}}},template:`\n\t\t<div class="bx-im-round-video-player__progress-container">\n\t\t\t<svg :viewBox="\`0 0 ${x} ${x}\`">\n\t\t\t\t<circle\n\t\t\t\t\t:style="progressStyles"\n\t\t\t\t\tclass="bx-im-round-video-player__progress"\n\t\t\t\t\t:transform="\`rotate(-90, ${A}, ${A})\`"\n\t\t\t\t\t:cx="PLAYER_RADIUS"\n\t\t\t\t\t:cy="PLAYER_RADIUS"\n\t\t\t\t\t:r="PLAYER_RADIUS - PLAYER_PROGRESS_MARGIN"\n\t\t\t\t></circle>\n\t\t\t</svg>\n\t\t</div>\n\t`};const C={name:"TranscriptionButton",components:{Spinner:n.Spinner,BIcon:e.BIcon},props:{file:{type:Object,required:true},isOpened:{type:Boolean,required:true},messageId:{type:[String,Number],required:true},isOverlay:{type:Boolean,default:false}},emits:["transcriptionToggle"],computed:{SpinnerSize:()=>n.SpinnerSize,SpinnerColor:()=>n.SpinnerColor,fileId(){return this.file.id},chatId(){return this.file.chatId},transcription(){return this.$store.getters["files/getTranscription"](this.fileId)},status(){return this.transcription?this.transcription.status:null},isPending(){return this.status===y.TranscriptionStatus.PENDING},isSuccess(){return this.status===y.TranscriptionStatus.SUCCESS},buttonIcon(){if(this.isOpened){return e.Outline.CHEVRON_TOP_M}return this.isOverlay?e.SmallOutline.TRANSCRIPTION:e.Outline.TRANSCRIPTION},iconColor(){return this.isOverlay?y.Color.white:y.Color.accentBlue}},watch:{status(t,e){if(e===y.TranscriptionStatus.PENDING){c.Analytics.getInstance().player.onViewTranscription(this.file.id,t);this.open()}}},methods:{async onButtonClick(){if(this.isPending){return}if(this.isOpened){this.close();return}if(this.isSuccess){c.Analytics.getInstance().player.onViewTranscription(this.file.id,y.TranscriptionStatus.SUCCESS);this.open();return}const t=await this.transcribe();if(t){this.open()}},async transcribe(){const t=new a.MessageService({chatId:this.chatId});return t.transcribe(this.fileId,this.messageId)},open(){this.$emit("transcriptionToggle",true)},close(){this.$emit("transcriptionToggle",false)}},template:`\n\t\t<div class="bx-im-transcription-button__container">\n\t\t\t<button\n\t\t\t\tclass="bx-im-transcription-button__button"\n\t\t\t\t:class="{'--overlay': isOverlay}"\n\t\t\t\t@click="onButtonClick"\n\t\t\t>\n\t\t\t\t<Spinner v-if="isPending" :size="SpinnerSize.XXS" :color="SpinnerColor.white" />\n\t\t\t\t<BIcon\n\t\t\t\t\tv-else\n\t\t\t\t\t:name="buttonIcon"\n\t\t\t\t\t:color="iconColor"\n\t\t\t\t\t:size="20"\n\t\t\t\t/>\n\t\t\t</button>\n\t\t</div>\n\t`};const B={autoplay:"autoplay",manual:"manual"};const M={loading:"loading",playing:"playing",paused:"paused"};const O=16;const w={name:"RoundVideoPlayer",components:{BIcon:e.BIcon,FadeAnimation:m.FadeAnimation,RoundProgressBar:R,TranscriptionButton:C},props:{item:{type:Object,required:true},message:{type:Object,required:true},startWithSound:{type:Boolean,default:false}},emits:["openTranscription"],data(){return{playbackMode:B.autoplay,playbackState:M.loading,currentTime:0,duration:0,animationFrameId:null,currentTimeSmoothed:0}},computed:{PlaybackMode:()=>B,OutlineIcons:()=>e.Outline,MUTE_ICON_SIZE:()=>O,Color:()=>y.Color,file(){return this.item},isLoaded(){return this.playbackState===M.loading},isAutoplay(){return this.playbackMode===B.autoplay},formattedTime(){if(!this.isLoaded&&!this.duration){return"--:--"}const t=this.duration-this.currentTime;return b.Utils.date.formatMediaDurationTime(t)},videoElement(){return this.$refs.videoElement},currentProgress(){if(this.duration===0){return 0}return this.currentTimeSmoothed/this.duration*100},isPaused(){return this.playbackState===M.paused},isTranscriptionAvailable(){return this.file.isTranscribable&&o.FeatureManager.isFeatureAvailable(o.Feature.videoNoteTranscriptionAvailable)&&o.FeatureManager.isFeatureAvailable(o.Feature.copilotAvailable)}},created(){I.getInstance().register(this.file)},mounted(){this.getObserver().observe(this.$refs.body);this.getEmitter().subscribe(y.EventType.roundVideoPlayer.playNext,this.handlePlayNextRequest);this.getEmitter().subscribe(y.EventType.roundVideoPlayer.onClickPlay,this.handleOtherVideoStarted);if(this.startWithSound){this.switchToManualMode()}},beforeUnmount(){this.stopProgressAnimation();this.getObserver().unobserve(this.$refs.body);I.getInstance().unregister(this.file);this.getEmitter().unsubscribe(y.EventType.roundVideoPlayer.playNext,this.handlePlayNextRequest);this.getEmitter().unsubscribe(y.EventType.roundVideoPlayer.onClickPlay,this.handleOtherVideoStarted)},methods:{togglePlayMode(){this.getEmitter().emit(y.EventType.roundVideoPlayer.onClickPlay,{fileId:this.file.id});if(this.playbackMode===B.autoplay){c.Analytics.getInstance().player.onPlay(this.file.id);this.switchToManualMode();return}if(this.playbackState===M.playing){c.Analytics.getInstance().player.onPause(this.file.id);this.pauseVideo()}else{c.Analytics.getInstance().player.onPlay(this.file.id);this.playVideo()}},playVideo(){void this.videoElement.play()},pauseVideo(){this.videoElement.pause()},handleLoadedMetaData(){this.duration=this.videoElement.duration;this.playVideo()},handleCanPlayThrough(){if(this.playbackState===M.loading){this.playVideo()}},handlePlay(){this.playbackState=M.playing;this.startProgressAnimation()},handlePause(){this.playbackState=M.paused;this.stopProgressAnimation()},handleEnded(){this.switchToAutoplayMode();I.getInstance().onFileEnded({file:this.file,context:{emitter:this.getEmitter()}})},handleTimeUpdate(){this.currentTime=this.videoElement.currentTime},handleError(t){console.error("Im.RoundVideoPlayer: loading failed",t);this.playbackState=M.loading;this.duration=0;this.stopProgressAnimation()},handlePlayNextRequest(t){const{fileId:e}=t.getData();if(e!==this.file.id){return}this.$refs.body.scrollIntoView({behavior:"smooth",block:"center"});this.switchToManualMode()},handleOtherVideoStarted(t){const{fileId:e}=t.getData();if(e===this.file.id){return}this.switchToAutoplayMode()},switchToAutoplayMode(){this.playbackMode=B.autoplay;this.videoElement.loop=true;this.videoElement.muted=true;this.playVideo()},switchToManualMode(){this.playbackMode=B.manual;this.videoElement.currentTime=0;this.videoElement.loop=false;this.videoElement.muted=false;this.playVideo()},getObserver(){if(this.observer){return this.observer}this.observer=new IntersectionObserver((t=>{t.forEach((t=>{if(!this.isAutoplay){return}if(t.isIntersecting){this.playVideo()}else{this.pauseVideo()}}))}),{threshold:[0,1]});return this.observer},startProgressAnimation(){const t=()=>{if(!this.videoElement){return}this.currentTimeSmoothed=this.videoElement.currentTime;this.animationFrameId=requestAnimationFrame(t)};t()},stopProgressAnimation(){if(!this.animationFrameId){return}cancelAnimationFrame(this.animationFrameId);this.animationFrameId=null},getEmitter(){return this.$Bitrix.eventEmitter}},template:`\n\t\t<div class="bx-im-round-video-player__container">\n\t\t\t<FadeAnimation :duration="200">\n\t\t\t\t<div v-if="isAutoplay" class="bx-im-round-video-player__mute">\n\t\t\t\t\t<BIcon\n\t\t\t\t\t\t:name="OutlineIcons.SOUND_OFF"\n\t\t\t\t\t\t:color="Color.white"\n\t\t\t\t\t\t:size="MUTE_ICON_SIZE"\n\t\t\t\t\t/>\n\t\t\t\t</div>\n\t\t\t</FadeAnimation>\n\t\t\t<div v-if="isTranscriptionAvailable" class="bx-im-round-video-player__transcribe-button">\n\t\t\t\t<TranscriptionButton\n\t\t\t\t\t:file="file"\n\t\t\t\t\t:messageId="message.id"\n\t\t\t\t\t:isOpened="false"\n\t\t\t\t\t:isOverlay="true"\n\t\t\t\t\t@transcriptionToggle="$emit('openTranscription')"\n\t\t\t\t/>\n\t\t\t</div>\n\t\t\t<div class="bx-im-round-video-player__time-container">\n\t\t\t\t<div class="bx-im-round-video-player__time">{{ formattedTime }}</div>\n\t\t\t</div>\n\t\t\t<div class="bx-im-round-video-player__video-container" ref="body" @click.stop="togglePlayMode">\n\t\t\t\t<FadeAnimation :duration="200">\n\t\t\t\t\t<div v-if="isPaused" class="bx-im-round-video-player__start-play_button"></div>\n\t\t\t\t</FadeAnimation>\n\t\t\t\t<video\n\t\t\t\t\t:src="file.urlDownload"\n\t\t\t\t\tclass="bx-im-round-video-player__video"\n\t\t\t\t\t:poster="file.urlPreview"\n\t\t\t\t\tref="videoElement"\n\t\t\t\t\tpreload="metadata"\n\t\t\t\t\tplaysinline\n\t\t\t\t\tloop\n\t\t\t\t\tmuted\n\t\t\t\t\t@abort="handleError"\n\t\t\t\t\t@error="handleError"\n\t\t\t\t\t@canplaythrough="handleCanPlayThrough"\n\t\t\t\t\t@loadedmetadata="handleLoadedMetaData"\n\t\t\t\t\t@timeupdate="handleTimeUpdate"\n\t\t\t\t\t@play="handlePlay"\n\t\t\t\t\t@pause="handlePause"\n\t\t\t\t\t@ended="handleEnded"\n\t\t\t\t></video>\n\t\t\t\t<FadeAnimation :duration="200">\n\t\t\t\t\t<RoundProgressBar \n\t\t\t\t\t\tv-if="playbackMode === PlaybackMode.manual" \n\t\t\t\t\t\t:progress="currentProgress" \n\t\t\t\t\t/>\n\t\t\t\t</FadeAnimation>\n\t\t\t</div>\n\t\t</div>\n\t`};const F={verticalShift:44,activeVerticalShift:19};const L={name:"PLayerTimeline",props:{loaded:{type:Boolean,default:false},timeCurrent:{type:Number,required:true},timeTotal:{type:Number,required:true},withSeeking:{type:Boolean,default:true}},emits:["change"],data(){return{seekerOffset:0}},computed:{progress(){return Math.round(100/this.timeTotal*this.timeCurrent)},seekerPositionStyles(){if(!this.loaded||!this.withSeeking){return{display:"none"}}return{left:`${this.seekerOffset}px`}},progressPosition(){if(!this.loaded||this.timeCurrent===0){return{width:"100%"}}const t=Math.round(this.$refs.timeline.offsetWidth/100*this.progress);return{width:`${t}px`}},activeWaveStyles(){const t=this.waveType*F.verticalShift+F.activeVerticalShift;return{...this.progressPosition,"background-position-y":`-${t}px`}},waveStyles(){const t=this.waveType*F.verticalShift;return{"background-position-y":`-${t}px`}}},created(){this.waveType=Math.floor(Math.random()*5)},methods:{setPosition(){if(!this.loaded||!this.withSeeking){return}const t=this.$refs.timeline.offsetWidth/100;const e=Math.round(this.seekerOffset/t);this.$emit("change",e)},updateSeekerPosition(t){if(!this.loaded||!this.withSeeking){return}this.seekerOffset=t.offsetX>0?t.offsetX:0}},template:`\n\t\t<div \n\t\t\tref="timeline"\n\t\t\t:class="{'--with-seeking': withSeeking}"\n\t\t\tclass="bx-im-player-timeline__container" \n\t\t\t@click="setPosition" \n\t\t\t@mousemove="updateSeekerPosition" \n\t\t>\n\t\t\t<div class="bx-im-player-timeline__wave" :style="waveStyles"></div>\n\t\t\t<div class="bx-im-player-timeline__wave" :style="activeWaveStyles"></div>\n\t\t\t<div class="bx-im-player-timeline__seeker" :style="seekerPositionStyles"></div>\n\t\t</div>\n\t`};const $={[y.FileType.video]:"IM_MESSAGE_FILE_AUDIO_TRANSCRIPTION_ERROR_VIDEO",[y.FileType.audio]:"IM_MESSAGE_FILE_AUDIO_TRANSCRIPTION_ERROR"};const D="LIMIT_IS_EXCEEDED_BAAS";const N={name:"TranscriptionText",components:{ExpandAnimation:m.ExpandAnimation,RichLoc:p.RichLoc},props:{file:{type:Object,required:true},messageId:{type:[String,Number],required:true},isOpened:{type:Boolean,required:true}},computed:{transcription(){return this.$store.getters["files/getTranscription"](this.file.id)},text(){return v.Parser.decode({text:this.transcription.transcriptText})},isError(){return this.transcription&&this.transcription.status===y.TranscriptionStatus.ERROR},isLimitError(){return this.transcription&&this.transcription.errorCode===D},errorText(){if(this.isLimitError){return this.loc("IM_MESSAGE_FILE_TRANSCRIPTION_LIMIT_ERROR")}const t=$[this.file.type];return this.loc(t)},showDivider(){return this.isOpened&&Boolean(this.message.text)},message(){return this.$store.getters["messages/getById"](this.messageId)}},methods:{loc(t){return this.$Bitrix.Loc.getMessage(t)},onLimitErrorLinkClick(){const t=new h.FeaturePromoter({code:y.SliderCode.buyMarketPlus});t.show()}},template:`\n\t\t<div class="bx-im-transcription-text__container">\n\t\t\t<ExpandAnimation>\n\t\t\t\t<div\n\t\t\t\t\tv-if="isOpened"\n\t\t\t\t\tclass="bx-im-transcription-text__content"\n\t\t\t\t>\n\t\t\t\t\t<div v-if="!isError" v-html="text"></div>\n\t\t\t\t\t<RichLoc\n\t\t\t\t\t\tv-else\n\t\t\t\t\t\t:text="errorText"\n\t\t\t\t\t\tclass="--error"\n\t\t\t\t\t\tplaceholder="[url]"\n\t\t\t\t\t>\n\t\t\t\t\t\t<template #url="{ text }">\n\t\t\t\t\t\t\t<span class="bx-im-transcription-text__error-link" @click="onLimitErrorLinkClick">\n\t\t\t\t\t\t\t\t{{ text }}\n\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t</template>\n\t\t\t\t\t</RichLoc>\n\t\t\t\t</div>\n\t\t\t</ExpandAnimation>\n\t\t\t<div v-if="showDivider" class="bx-im-transcription-text__divider"></div>\n\t\t</div>\n\t`};const V="im:audioplayer:id";const X={name:"AudioPlayer",components:{MessageAvatar:u.MessageAvatar,Timeline:L,TranscriptionButton:C,TranscriptionText:N},props:{id:{type:Number,default:0},src:{type:String,default:""},file:{type:Object,required:true},authorId:{type:Number,required:true},messageId:{type:[String,Number],required:true},withContextMenu:{type:Boolean,default:true},withAvatar:{type:Boolean,default:true},withPlaybackRateControl:{type:Boolean,default:false},withTranscription:{type:Boolean,default:true}},data(){return{preload:"none",loaded:false,loading:false,state:y.AudioPlaybackState.none,timeCurrent:0,timeTotal:0,showContextButton:false,currentRate:y.AudioPlaybackRate["1"],isTranscriptionOpened:false}},computed:{State:()=>y.AudioPlaybackState,isPlaying(){return this.state===y.AudioPlaybackState.play},labelTime(){if(!this.loaded&&!this.timeTotal){return"--:--"}let t=0;if(this.isPlaying){t=this.timeTotal-this.timeCurrent}else{t=this.timeTotal}return b.Utils.date.formatMediaDurationTime(t)},AvatarSize:()=>u.AvatarSize,fileSize(){return b.Utils.file.formatFileSize(this.file.size)},getAudioPlayerIds(){return this.$Bitrix.Data.get(V,[])},currentRateLabel(){return this.isPlaying?`${this.currentRate}x`:""},metaInfo(){return`${this.fileSize}, ${this.labelTime}`},isTranscriptionAvailable(){return this.withTranscription&&this.file.isTranscribable&&o.FeatureManager.isFeatureAvailable(o.Feature.aiFileTranscriptionAvailable)&&o.FeatureManager.isFeatureAvailable(o.Feature.copilotAvailable)}},watch:{id(t){this.registerPlayer(t)},timeCurrent(t){const e=Math.round(100/this.timeTotal*t);if(e>70){this.preloadNext()}}},created(){this.localStorageInst=d.LocalStorageManager.getInstance();this.currentRate=this.getRateFromLS();this.preloadRequestSent=false;this.registeredId=0;this.registerPlayer(this.id);this.getEmitter().subscribe(y.EventType.audioPlayer.play,this.onPlay);this.getEmitter().subscribe(y.EventType.audioPlayer.stop,this.onStop);this.getEmitter().subscribe(y.EventType.audioPlayer.pause,this.onPause);this.getEmitter().subscribe(y.EventType.audioPlayer.preload,this.onPreload)},mounted(){this.getObserver().observe(this.$refs.body)},beforeUnmount(){this.unregisterPlayer();this.getEmitter().unsubscribe(y.EventType.audioPlayer.play,this.onPlay);this.getEmitter().unsubscribe(y.EventType.audioPlayer.stop,this.onStop);this.getEmitter().unsubscribe(y.EventType.audioPlayer.pause,this.onPause);this.getEmitter().unsubscribe(y.EventType.audioPlayer.preload,this.onPreload);this.getObserver().unobserve(this.$refs.body)},methods:{loadFile(t=false){if(this.loaded||this.loading&&!t){return}this.preload="auto";if(!t){return}this.loading=true;if(this.source()){void this.source().play()}},clickToButton(){if(!this.src){return}if(this.isPlaying){this.pause()}else{this.play()}},play(){this.updateRate(this.getRateFromLS());if(!this.loaded){this.loadFile(true);return}void this.source().play()},pause(){this.source().pause()},stop(){this.state=y.AudioPlaybackState.stop;this.source().pause()},getRateFromLS(){return this.localStorageInst.get(y.LocalStorageKey.audioPlaybackRate)||y.AudioPlaybackRate["1"]},setRateInLS(t){this.localStorageInst.set(y.LocalStorageKey.audioPlaybackRate,t)},getNextPlaybackRate(t){const e=Object.values(y.AudioPlaybackRate).sort();const i=e.indexOf(t);const n=(i+1)%e.length;return e[n]},changeRate(){if([y.AudioPlaybackState.pause,y.AudioPlaybackState.none].includes(this.state)){return}const t=this.getRateFromLS();const e=this.getNextPlaybackRate(t);c.Analytics.getInstance().player.onChangeRate(this.file.chatId,e);this.setRateInLS(e);this.updateRate(e)},updateRate(t){this.currentRate=t;this.source().playbackRate=t},registerPlayer(t){if(t<=0){return}this.unregisterPlayer();const e=[...new Set([...this.getAudioPlayerIds,t])];this.$Bitrix.Data.set(V,e.sort(((t,e)=>t-e)));this.registeredId=t},unregisterPlayer(){if(!this.registeredId){return}this.$Bitrix.Data.get(V,this.getAudioPlayerIds.filter((t=>t!==this.registeredId)));this.registeredId=0},playNext(){if(!this.registeredId){return}const t=this.getAudioPlayerIds.filter((t=>t>this.registeredId)).slice(0,1)[0];if(t){this.getEmitter().emit(y.EventType.audioPlayer.play,{id:t,start:true})}},preloadNext(){if(this.preloadRequestSent||!this.registeredId){return}this.preloadRequestSent=true;const t=this.getAudioPlayerIds.filter((t=>t>this.registeredId)).slice(0,1)[0];if(t){this.getEmitter().emit(y.EventType.audioPlayer.preload,{id:t})}},onPlay(t){const e=t.getData();if(e.id!==this.id){return}if(e.start){this.stop()}this.play()},onStop(t){const e=t.getData();if(e.initiator===this.id){return}this.stop()},onPause(t){const e=t.getData();if(e.initiator===this.id){return}this.pause()},onPreload(t){const e=t.getData();if(e.id!==this.id){return}this.loadFile()},source(){return this.$refs.source},audioEventRouter(t,e){switch(t){case"durationchange":case"loadeddata":case"loadedmetadata":if(!this.source()){return}this.timeTotal=this.source().duration;break;case"abort":case"error":console.error("BxAudioPlayer: load failed",this.id,e);this.loading=false;this.state=y.AudioPlaybackState.none;this.timeTotal=0;this.preload="none";break;case"canplaythrough":this.loading=false;this.loaded=true;break;case"timeupdate":if(!this.source()){return}this.timeCurrent=this.source().currentTime;if(this.isPlaying&&this.timeCurrent>=this.timeTotal){this.playNext()}break;case"pause":c.Analytics.getInstance().player.onPause(this.file.id);if(this.state!==y.AudioPlaybackState.stop){this.state=y.AudioPlaybackState.pause}break;case"play":c.Analytics.getInstance().player.onPlay(this.file.id);this.state=y.AudioPlaybackState.play;if(this.state===y.AudioPlaybackState.stop){this.timeCurrent=0}if(this.id>0){this.getEmitter().emit(y.EventType.audioPlayer.pause,{initiator:this.id})}break}},getObserver(){if(this.observer){return this.observer}this.observer=new IntersectionObserver((t=>{t.forEach((t=>{if(t.isIntersecting&&this.preload==="none"){this.preload="metadata";this.observer.unobserve(t.target)}}))}),{threshold:[0,1]});return this.observer},onTimelineClick(t){this.play();this.source().currentTime=this.timeTotal/100*t},getEmitter(){return this.$Bitrix.eventEmitter}},template:`\n\t\t<div class="bx-im-audio-player__scope">\n\t\t\t<div \n\t\t\t\tclass="bx-im-audio-player__container" \n\t\t\t\tref="body"\n\t\t\t\t@mouseover="showContextButton = true"\n\t\t\t\t@mouseleave="showContextButton = false"\n\t\t\t>\n\t\t\t\t<div class="bx-im-audio-player__control-container">\n\t\t\t\t\t<button\n\t\t\t\t\t\tclass="bx-im-audio-player__control-button"\n\t\t\t\t\t\t:class="{\n\t\t\t\t\t\t\t'bx-im-audio-player__control-loader': loading,\n\t\t\t\t\t\t\t'bx-im-audio-player__control-play': !loading && !this.isPlaying,\n\t\t\t\t\t\t\t'bx-im-audio-player__control-pause': !loading && this.isPlaying,\n\t\t\t\t\t\t}"\n\t\t\t\t\t\t@click="clickToButton"\n\t\t\t\t\t></button>\n\t\t\t\t\t<div v-if="withAvatar" class="bx-im-audio-player__author-avatar-container">\n\t\t\t\t\t\t<MessageAvatar\n\t\t\t\t\t\t\t:messageId="messageId"\n\t\t\t\t\t\t\t:authorId="authorId"\n\t\t\t\t\t\t\t:size="AvatarSize.XS" \n\t\t\t\t\t\t/>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t<div class="bx-im-audio-player__content-container">\n\t\t\t\t\t<div class="bx-im-audio-player__timeline-container">\n\t\t\t\t\t\t<Timeline \n\t\t\t\t\t\t\t:loaded="loaded"\n\t\t\t\t\t\t\t:timeCurrent="timeCurrent"\n\t\t\t\t\t\t\t:timeTotal="timeTotal"\n\t\t\t\t\t\t\t@change="onTimelineClick"\n\t\t\t\t\t\t/>\n\t\t\t\t\t\t<div class="bx-im-audio-player__timer-container --ellipsis">\n\t\t\t\t\t\t\t{{ metaInfo }}\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div v-if="isTranscriptionAvailable" class="bx-im-audio-player__transcription">\n\t\t\t\t\t\t<TranscriptionButton\n\t\t\t\t\t\t\t:file="file"\n\t\t\t\t\t\t\t:messageId="messageId"\n\t\t\t\t\t\t\t:isOpened="isTranscriptionOpened"\n\t\t\t\t\t\t\t@transcriptionToggle="isTranscriptionOpened = !isTranscriptionOpened"\n\t\t\t\t\t\t/>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div\n\t\t\t\t\t\tv-if="!withPlaybackRateControl"\n\t\t\t\t\t\tclass="bx-im-audio-player__rate-button-container"\n\t\t\t\t\t>\n\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t:class="{'--active': isPlaying}"\n\t\t\t\t\t\t\t@click="changeRate"\n\t\t\t\t\t\t>\n\t\t\t\t\t\t<span :class="{'bx-im-audio-player__rate-icon': !isPlaying}">\n\t\t\t\t\t\t\t{{ currentRateLabel }}\n\t\t\t\t\t\t</span>\n\t\t\t\t\t\t</button>\n\t\t\t\t\t</div>\n\t\t\t\t\t<button\n\t\t\t\t\t\tv-if="showContextButton && withContextMenu"\n\t\t\t\t\t\tclass="bx-im-messenger__context-menu-icon bx-im-audio-player__context-menu-button"\n\t\t\t\t\t\t@click="$emit('contextMenuClick', $event)"\n\t\t\t\t\t></button>\n\t\t\t\t</div>\n\t\t\t\t<audio \n\t\t\t\t\tv-if="src" \n\t\t\t\t\t:src="src" \n\t\t\t\t\tclass="bx-im-audio-player__audio-source" \n\t\t\t\t\tref="source" \n\t\t\t\t\t:preload="preload"\n\t\t\t\t\t@abort="audioEventRouter('abort', $event)"\n\t\t\t\t\t@error="audioEventRouter('error', $event)"\n\t\t\t\t\t@suspend="audioEventRouter('suspend', $event)"\n\t\t\t\t\t@canplay="audioEventRouter('canplay', $event)"\n\t\t\t\t\t@canplaythrough="audioEventRouter('canplaythrough', $event)"\n\t\t\t\t\t@durationchange="audioEventRouter('durationchange', $event)"\n\t\t\t\t\t@loadeddata="audioEventRouter('loadeddata', $event)"\n\t\t\t\t\t@loadedmetadata="audioEventRouter('loadedmetadata', $event)"\n\t\t\t\t\t@timeupdate="audioEventRouter('timeupdate', $event)"\n\t\t\t\t\t@play="audioEventRouter('play', $event)"\n\t\t\t\t\t@playing="audioEventRouter('playing', $event)"\n\t\t\t\t\t@pause="audioEventRouter('pause', $event)"\n\t\t\t\t></audio>\n\t\t\t</div>\n\t\t\t<TranscriptionText\n\t\t\t\t:file="file"\n\t\t\t\t:isOpened="isTranscriptionOpened"\n\t\t\t\t:messageId="messageId"\n\t\t\t/>\n\t\t</div>\n\t`};const U={name:"TranscribedVideoPlayer",components:{TranscriptionText:N,TranscriptionButton:C,Timeline:L},props:{item:{type:Object,required:true},message:{type:Object,required:true}},emits:["closeTranscription","clickPlay"],data(){return{duration:0}},computed:{file(){return this.item},playButtonStyles(){return{backgroundImage:`url(${this.file.urlPreview})`}},formattedTime(){if(this.duration===0){return"--:--"}return b.Utils.date.formatMediaDurationTime(this.duration)}},methods:{handleLoadedMetaData(){this.duration=this.$refs.videoElement.duration}},template:`\n\t\t<div class="bx-im-transcribed-video-player__container">\n\t\t\t<div class="bx-im-transcribed-video-player__video">\n\t\t\t\t<div\n\t\t\t\t\t:style="playButtonStyles"\n\t\t\t\t\tclass="bx-im-transcribed-video-player__play"\n\t\t\t\t\t@click="$emit('clickPlay')"\n\t\t\t\t>\n\t\t\t\t\t<div class="bx-im-transcribed-video-player__play-button-overlay"></div>\n\t\t\t\t\t<div class="bx-im-transcribed-video-player__play-icon"></div>\n\t\t\t\t</div>\n\t\t\t\t<div class="bx-im-transcribed-video-player__content">\n\t\t\t\t\t<div class="bx-im-transcribed-video-player__timeline-container">\n\t\t\t\t\t\t<Timeline\n\t\t\t\t\t\t\t:loaded="duration > 0"\n\t\t\t\t\t\t\t:timeCurrent="duration"\n\t\t\t\t\t\t\t:timeTotal="duration"\n\t\t\t\t\t\t\t:withSeeking="false"\n\t\t\t\t\t\t/>\n\t\t\t\t\t\t<div class="bx-im-transcribed-video-player__metainfo">{{ formattedTime }}</div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="bx-im-transcribed-video-player__transcription-button">\n\t\t\t\t\t\t<TranscriptionButton\n\t\t\t\t\t\t\t:file="file"\n\t\t\t\t\t\t\t:isOpened="true"\n\t\t\t\t\t\t\t:messageId="message.id"\n\t\t\t\t\t\t\t@transcriptionToggle="$emit('closeTranscription')"\n\t\t\t\t\t\t/>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t<video\n\t\t\t\t\t:src="file.urlDownload"\n\t\t\t\t\tclass="bx-im-transcribed-video-player__video-source"\n\t\t\t\t\tref="videoElement"\n\t\t\t\t\tpreload="metadata"\n\t\t\t\t\t@loadedmetadata="handleLoadedMetaData"\n\t\t\t\t></video>\n\t\t\t</div>\n\t\t\t<TranscriptionText\n\t\t\t\t:file="file"\n\t\t\t\t:isOpened="true"\n\t\t\t\t:messageId="message.id"\n\t\t\t\tclass="bx-im-transcribed-video-player__transcription-text"\n\t\t\t/>\n\t\t</div>\n\t`};t.DefaultVideoPlayer=P;t.RoundVideoPlayer=w;t.AudioPlayer=X;t.TranscribedVideoPlayer=U})(this.BX.Messenger.v2.Component.Elements=this.BX.Messenger.v2.Component.Elements||{},BX.UI.IconSet,BX,BX.Messenger.v2.Component.Elements,BX.Messenger.v2.Service,BX,BX,BX.Messenger.v2.Lib,BX.Event,BX.Messenger.v2.Lib,BX.Messenger.v2.Component.Elements,BX.Messenger.v2.Lib,BX.UI,BX.UI.Vue3.Components,BX.Messenger.v2.Component.Animation,BX.Messenger.v2.Const,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib);
//# sourceMappingURL=registry.bundle.map.js