this.BX=this.BX||{};this.BX.Messenger=this.BX.Messenger||{};this.BX.Messenger.v2=this.BX.Messenger.v2||{};(function(e,s,t,a,r,i,l,o,c){"use strict";var n=babelHelpers.classPrivateFieldLooseKey("restResult");var d=babelHelpers.classPrivateFieldLooseKey("withBirthdays");var h=babelHelpers.classPrivateFieldLooseKey("users");var b=babelHelpers.classPrivateFieldLooseKey("chats");var u=babelHelpers.classPrivateFieldLooseKey("messages");var v=babelHelpers.classPrivateFieldLooseKey("files");var g=babelHelpers.classPrivateFieldLooseKey("recentItems");var p=babelHelpers.classPrivateFieldLooseKey("stickerMessages");var P=babelHelpers.classPrivateFieldLooseKey("extractUser");var L=babelHelpers.classPrivateFieldLooseKey("extractChat");var f=babelHelpers.classPrivateFieldLooseKey("extractMessage");var F=babelHelpers.classPrivateFieldLooseKey("extractRecentItem");var m=babelHelpers.classPrivateFieldLooseKey("extractBirthdayItems");var y=babelHelpers.classPrivateFieldLooseKey("extractStickerMessage");var H=babelHelpers.classPrivateFieldLooseKey("prepareGroupChat");var B=babelHelpers.classPrivateFieldLooseKey("prepareChatForUser");var M=babelHelpers.classPrivateFieldLooseKey("prepareChatForAdditionalUser");var I=babelHelpers.classPrivateFieldLooseKey("getBirthdayPlaceholder");var C=babelHelpers.classPrivateFieldLooseKey("mergeFileIds");class O{constructor(e){Object.defineProperty(this,C,{value:x});Object.defineProperty(this,I,{value:X});Object.defineProperty(this,M,{value:A});Object.defineProperty(this,B,{value:T});Object.defineProperty(this,H,{value:E});Object.defineProperty(this,y,{value:D});Object.defineProperty(this,m,{value:K});Object.defineProperty(this,F,{value:j});Object.defineProperty(this,f,{value:w});Object.defineProperty(this,L,{value:S});Object.defineProperty(this,P,{value:R});Object.defineProperty(this,n,{writable:true,value:void 0});Object.defineProperty(this,d,{writable:true,value:void 0});Object.defineProperty(this,h,{writable:true,value:{}});Object.defineProperty(this,b,{writable:true,value:{}});Object.defineProperty(this,u,{writable:true,value:{}});Object.defineProperty(this,v,{writable:true,value:{}});Object.defineProperty(this,g,{writable:true,value:{}});Object.defineProperty(this,p,{writable:true,value:{}});const{rawData:s,withBirthdays:t=true}=e;babelHelpers.classPrivateFieldLooseBase(this,d)[d]=t;babelHelpers.classPrivateFieldLooseBase(this,n)[n]=s}getItems(){const{items:e=[],copilot:s,messagesAutoDeleteConfigs:t}=babelHelpers.classPrivateFieldLooseBase(this,n)[n];e.forEach((e=>{babelHelpers.classPrivateFieldLooseBase(this,P)[P](e);babelHelpers.classPrivateFieldLooseBase(this,L)[L](e);babelHelpers.classPrivateFieldLooseBase(this,f)[f](e);babelHelpers.classPrivateFieldLooseBase(this,F)[F](e);babelHelpers.classPrivateFieldLooseBase(this,y)[y](e)}));babelHelpers.classPrivateFieldLooseBase(this,m)[m]();return{users:Object.values(babelHelpers.classPrivateFieldLooseBase(this,h)[h]),chats:Object.values(babelHelpers.classPrivateFieldLooseBase(this,b)[b]),messages:Object.values(babelHelpers.classPrivateFieldLooseBase(this,u)[u]),files:Object.values(babelHelpers.classPrivateFieldLooseBase(this,v)[v]),recentItems:Object.values(babelHelpers.classPrivateFieldLooseBase(this,g)[g]),copilot:s,messagesAutoDeleteConfigs:t,stickerMessages:Object.values(babelHelpers.classPrivateFieldLooseBase(this,p)[p])}}}function R(e){var s;if((s=e.user)!=null&&s.id&&!babelHelpers.classPrivateFieldLooseBase(this,h)[h][e.user.id]){babelHelpers.classPrivateFieldLooseBase(this,h)[h][e.user.id]=e.user}}function S(e){if(e.type===a.ChatType.chat){babelHelpers.classPrivateFieldLooseBase(this,b)[b][e.id]=babelHelpers.classPrivateFieldLooseBase(this,H)[H](e);if(e.user.id&&!babelHelpers.classPrivateFieldLooseBase(this,b)[b][e.user.id]){babelHelpers.classPrivateFieldLooseBase(this,b)[b][e.user.id]=babelHelpers.classPrivateFieldLooseBase(this,M)[M](e.user)}}else if(e.type===a.ChatType.user){const s=c.Core.getStore().getters["recent/get"](e.user.id);if(!s||!e.options.default_user_record){babelHelpers.classPrivateFieldLooseBase(this,b)[b][e.user.id]=babelHelpers.classPrivateFieldLooseBase(this,B)[B](e)}}}function w(e){const s=e.message;if(!s){return}if(s.id===0){s.id=`${a.FakeMessagePrefix}-${e.id}`}let r=false;if(s.status===a.MessageStatus.delivered){r=true}const i=c.Core.getStore().getters["messages/getById"](s.id);if(t.Type.isArrayFilled(i==null?void 0:i.attach)){delete s.attach}if(t.Type.isPlainObject(s.file)){const e=s.file;if(i){s.files=babelHelpers.classPrivateFieldLooseBase(this,C)[C](i,e.id)}else{s.files=[e.id]}const t=c.Core.getStore().getters["files/get"](e.id);if(!t){babelHelpers.classPrivateFieldLooseBase(this,v)[v][e.id]=e}}babelHelpers.classPrivateFieldLooseBase(this,u)[u][s.id]={...s,viewedByOthers:r}}function j(e){var s,t;const a=(s=(t=e.message)==null?void 0:t.id)!=null?s:0;babelHelpers.classPrivateFieldLooseBase(this,g)[g][e.id]={...e,messageId:a}}function K(){if(!babelHelpers.classPrivateFieldLooseBase(this,d)[d]){return}const{birthdayList:e=[]}=babelHelpers.classPrivateFieldLooseBase(this,n)[n];e.forEach((e=>{if(c.Core.getUserId()===e.id){return}if(!babelHelpers.classPrivateFieldLooseBase(this,h)[h][e.id]){babelHelpers.classPrivateFieldLooseBase(this,h)[h][e.id]=e}if(!babelHelpers.classPrivateFieldLooseBase(this,b)[b][e.id]){babelHelpers.classPrivateFieldLooseBase(this,b)[b][e.id]=babelHelpers.classPrivateFieldLooseBase(this,M)[M](e)}if(!babelHelpers.classPrivateFieldLooseBase(this,g)[g][e.id]){const s=`${a.FakeMessagePrefix}-${e.id}`;babelHelpers.classPrivateFieldLooseBase(this,g)[g][e.id]={...babelHelpers.classPrivateFieldLooseBase(this,I)[I](e),messageId:s};babelHelpers.classPrivateFieldLooseBase(this,u)[u][s]={id:s}}}))}function D(e){var s;const t=(s=e.message)==null?void 0:s.id;if(!t||!e.message.sticker){return}babelHelpers.classPrivateFieldLooseBase(this,p)[p][t]={...e.message.sticker,messageId:t}}function E(e){return{...e.chat,counter:e.counter,dialogId:e.id}}function T(e){return{chatId:e.chat_id,avatar:e.user.avatar,color:e.user.color,dialogId:e.id,name:e.user.name,type:a.ChatType.user,counter:e.counter,role:a.UserRole.member,backgroundId:e.chat.background_id,textFieldEnabled:e.chat.text_field_enabled,muteList:e.chat.mute_list}}function A(e){return{dialogId:e.id,avatar:e.avatar,color:e.color,name:e.name,type:a.ChatType.user,role:a.UserRole.member}}function X(e){return{id:e.id,isBirthdayPlaceholder:true}}function x(e,s){const t=e.files.map((e=>Number.parseInt(e,10)));const a=new Set([...t,s]);return[...a]}class _{constructor(){this.dataIsPreloaded=false;this.firstPageIsLoaded=false;this.itemsPerPage=50;this.isLoading=false;this.pagesLoaded=0;this.hasMoreItemsToLoad=true;this.lastMessageDate=null}static getInstance(){if(!this.instance){this.instance=new this}return this.instance}getCollection(){return c.Core.getStore().getters["recent/getRecentCollection"]}async loadFirstPage({ignorePreloadedItems:e=false}={}){if(this.dataIsPreloaded&&!e){i.Logger.warn("Im.RecentList: first page was preloaded");return Promise.resolve()}this.isLoading=true;const s=await this.requestItems({firstPage:true});this.firstPageIsLoaded=true;return s}loadNextPage(){if(this.isLoading||!this.hasMoreItemsToLoad){return Promise.resolve()}this.isLoading=true;return this.requestItems()}setPreloadedData(e){i.Logger.warn("Im.RecentList: setting preloaded data",e);const{items:s,hasMore:t}=e;this.lastMessageDate=this.getLastMessageDate(s);if(!t){this.hasMoreItemsToLoad=false}this.dataIsPreloaded=true;void this.updateModels(e)}hideChat(e){i.Logger.warn("Im.RecentList: hide chat",e);const t=c.Core.getStore().getters["recent/get"](e);if(!t){return}void c.Core.getStore().dispatch("recent/hide",{id:e});const r=c.Core.getStore().getters["application/isChatOpen"](e);if(r){s.LayoutManager.getInstance().clearCurrentLayoutEntityId();void s.LayoutManager.getInstance().deleteLastOpenedElementById(e)}c.Core.getRestClient().callMethod(a.RestMethod.imRecentHide,{DIALOG_ID:e}).catch((e=>{console.error("Im.RecentList: hide chat error",e.error())}))}async requestItems({firstPage:e=false}={}){const s=this.getQueryParams(e);const t=await c.Core.getRestClient().callMethod(a.RestMethod.imRecentList,s).catch((e=>{console.error("Im.RecentList: page request error",e.error())}));this.pagesLoaded++;i.Logger.warn(`Im.RecentList: ${e?"First":this.pagesLoaded} page request result`,t.data());const{items:r,hasMore:l}=t.data();this.lastMessageDate=this.getLastMessageDate(r);if(!l){this.hasMoreItemsToLoad=false}this.isLoading=false;return this.updateModels(t.data())}getQueryParams(e){return{SKIP_OPENLINES:"Y",LIMIT:this.itemsPerPage,LAST_MESSAGE_DATE:e?null:this.lastMessageDate,GET_ORIGINAL_TEXT:"Y",PARSE_TEXT:"Y"}}getModelSaveMethod(){return"recent/setRecent"}updateModels(e){const s=new O({rawData:e,...this.getExtractorOptions()});const t=s.getItems();const{users:a,chats:l,messages:o,files:n,recentItems:d,copilot:h,messagesAutoDeleteConfigs:b,stickerMessages:u}=t;i.Logger.warn("LegacyRecentService: prepared data for models",t);const v=c.Core.getStore().dispatch("users/set",a);const g=c.Core.getStore().dispatch("chats/set",l);const p=c.Core.getStore().dispatch("chats/autoDelete/set",b);const P=c.Core.getStore().dispatch("messages/store",o);const L=c.Core.getStore().dispatch("files/set",n);const f=c.Core.getStore().dispatch(this.getModelSaveMethod(),d);const F=c.Core.getStore().dispatch("stickers/messages/set",u);const m=new r.CopilotManager;const y=m.handleRecentListResponse(h);return Promise.all([v,g,P,L,f,y,p,F])}getLastMessageDate(e){if(e.length===0){return""}return e.slice(-1)[0].message.date}getExtractorOptions(){return{}}}_.instance=null;var N=babelHelpers.classPrivateFieldLooseKey("itemsPerPage");var q=babelHelpers.classPrivateFieldLooseKey("isLoading");var U=babelHelpers.classPrivateFieldLooseKey("pagesLoaded");var k=babelHelpers.classPrivateFieldLooseKey("hasMoreItemsToLoad");var Q=babelHelpers.classPrivateFieldLooseKey("lastMessageDate");var $=babelHelpers.classPrivateFieldLooseKey("requestItems");var G=babelHelpers.classPrivateFieldLooseKey("updateModels");var Y=babelHelpers.classPrivateFieldLooseKey("getChatsWithCounters");var W=babelHelpers.classPrivateFieldLooseKey("getLastMessageDate");var z=babelHelpers.classPrivateFieldLooseKey("filterPinnedItemsMessages");class J{constructor(){Object.defineProperty(this,z,{value:te});Object.defineProperty(this,W,{value:se});Object.defineProperty(this,Y,{value:ee});Object.defineProperty(this,G,{value:Z});Object.defineProperty(this,$,{value:V});Object.defineProperty(this,N,{writable:true,value:50});Object.defineProperty(this,q,{writable:true,value:false});Object.defineProperty(this,U,{writable:true,value:0});Object.defineProperty(this,k,{writable:true,value:true});Object.defineProperty(this,Q,{writable:true,value:0})}loadFirstPage(){babelHelpers.classPrivateFieldLooseBase(this,q)[q]=true;return babelHelpers.classPrivateFieldLooseBase(this,$)[$]({firstPage:true})}loadNextPage(){if(babelHelpers.classPrivateFieldLooseBase(this,q)[q]||!babelHelpers.classPrivateFieldLooseBase(this,k)[k]){return Promise.resolve()}babelHelpers.classPrivateFieldLooseBase(this,q)[q]=true;return babelHelpers.classPrivateFieldLooseBase(this,$)[$]()}hasMoreItemsToLoad(){return babelHelpers.classPrivateFieldLooseBase(this,k)[k]}getItemsPerPage(){return babelHelpers.classPrivateFieldLooseBase(this,N)[N]}getRestMethodName(){throw new Error('BaseRecentList: you should implement "getRestMethodName" for child class')}getRecentSaveActionName(){throw new Error('BaseRecentList: you should implement "getRecentSaveActionName" for child class')}getQueryParams(e=false){return{limit:this.getItemsPerPage(),filter:this.getRequestFilter(e)}}getRequestFilter(e=false){return{lastMessageDate:e?null:babelHelpers.classPrivateFieldLooseBase(this,Q)[Q]}}handlePaginationField(e){babelHelpers.classPrivateFieldLooseBase(this,Q)[Q]=babelHelpers.classPrivateFieldLooseBase(this,W)[W](e)}onAfterRequest(e){}}async function V({firstPage:e=false}={}){const s={data:this.getQueryParams(e)};const t=await l.runAction(this.getRestMethodName(),s).catch((([e])=>{console.error("BaseRecentList: page request error",e)}));babelHelpers.classPrivateFieldLooseBase(this,U)[U]++;i.Logger.warn(`BaseRecentList: ${e?"First":babelHelpers.classPrivateFieldLooseBase(this,U)[U]} page request result`,t);const{hasNextPage:a}=t;this.handlePaginationField(t);babelHelpers.classPrivateFieldLooseBase(this,k)[k]=a;babelHelpers.classPrivateFieldLooseBase(this,q)[q]=false;this.onAfterRequest(e);return babelHelpers.classPrivateFieldLooseBase(this,G)[G](t)}function Z(e){const{users:s,chats:t,messages:a,files:i,recentItems:l,messagesAutoDeleteConfigs:n,copilot:d}=e;const h=babelHelpers.classPrivateFieldLooseBase(this,Y)[Y](t,l);const b=c.Core.getStore().dispatch("chats/set",h);const u=(new o.UserManager).setUsersToModel(s);const v=c.Core.getStore().dispatch("chats/autoDelete/set",n);const g=c.Core.getStore().dispatch("messages/store",a);const p=c.Core.getStore().dispatch("files/set",i);const P=c.Core.getStore().dispatch(this.getRecentSaveActionName(),l);const L=new r.CopilotManager;const f=L.handleRecentListResponse(d);return Promise.all([u,b,g,p,P,v,f])}function ee(e,s){const t={};e.forEach((e=>{t[e.id]=e}));s.forEach((e=>{const{counter:s,chatId:a}=e;if(s===0){return}t[a]={...t[a],counter:s}}));return Object.values(t)}function se(e){const s=babelHelpers.classPrivateFieldLooseBase(this,z)[z](e);if(s.length===0){return""}let t=s[0].date;s.forEach((e=>{if(e.date<t){t=e.date}}));return t}function te(e){const{messages:s,recentItems:t}=e;return s.filter((e=>{const s=e.chat_id;const a=t.find((e=>e.chatId===s));return a.pinned===false}))}class ae extends _{static getInstance(){if(!this.instance){this.instance=new this}return this.instance}getQueryParams(e){return{...super.getQueryParams(e),UNREAD_ONLY:"Y"}}getModelSaveMethod(){return"recent/setUnread"}getCollection(){return c.Core.getStore().getters["recent/getUnreadCollection"]}}ae.instance=null;e.LegacyRecentService=_;e.BaseRecentService=J;e.UnreadRecentService=ae})(this.BX.Messenger.v2.Service=this.BX.Messenger.v2.Service||{},BX.Messenger.v2.Lib,BX,BX.Messenger.v2.Const,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX.Messenger.v2.Application);
//# sourceMappingURL=registry.bundle.map.js