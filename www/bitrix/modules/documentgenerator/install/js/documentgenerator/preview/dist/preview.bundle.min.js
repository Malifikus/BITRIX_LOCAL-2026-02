this.BX=this.BX||{};(function(e,t,i,s,o,n){"use strict";class a{constructor(e,t){this.progress=false;this.links={};this.linksLoaded=false;this.intranetExtensions=null;this.id=null;this.text="Document";this.className="";this.menuClassName=null;this.provider=null;this.value=null;this.loaderPath=null;this.documentUrl=null;this.templateListUrl=null;this.moduleId=null;this.templatesText="Templates";this.documentsText="Documents";this.sliderWidth=null;this.loader=null;this.id=e;this.fillParameters(t)}fillParameters(e){if(e.links&&o.Type.isObjectLike(e.links)&&Object.keys(e.links).length>0){this.links=e.links;if(this.links.length>0){this.linksLoaded=true}}if(e.menuClassName&&o.Type.isString(e.menuClassName)){this.menuClassName=e.menuClassName}if(e.className&&o.Type.isString(e.className)){this.className=e.className}if(e.moduleId&&o.Type.isString(e.moduleId)){this.moduleId=e.moduleId}if(e.text&&o.Type.isString(e.text)){this.text=e.text}if(e.templatesText&&o.Type.isString(e.templatesText)){this.templatesText=e.templatesText}if(e.documentsText&&o.Type.isString(e.documentsText)){this.documentsText=e.documentsText}this.value=e.value||null;this.provider=e.provider||null;this.loaderPath=e.loaderPath||null;this.templateListUrl=e.templateListUrl||null;this.documentUrl=e.documentUrl||null;this.sliderWidth=Object.hasOwn(e,"sliderWidth")?parseInt(e.sliderWidth,10):null}getElement(){return document.getElementById(this.id)}createElement(){const e=this.getElement();if(e){return e}if(!this.id){return null}const t="button";let i="ui-btn ui-btn-md ui-btn-light-border ui-btn-dropdown ui-btn-themes";if(this.className){i+=` ${this.className}`}const s={id:this.id,className:i};return o.Dom.create(t,{attrs:s,text:this.text})}init(){o.Event.bind(this.getElement(),"click",(()=>{if(this.linksLoaded){this.showPopup()}else{if(this.progress){return}this.progress=true;this.showLoader();o.ajax.runAction("documentgenerator.api.document.getButtonTemplates",{data:{moduleId:this.moduleId,provider:this.provider,value:this.value}}).then((e=>{this.fillLinksFromResponse(e);this.hideLoader();this.progress=false;setTimeout((()=>this.showPopup()),10)})).catch((e=>{this.hideLoader();this.progress=false;i.MessageBox.alert(e.errors.pop().message)}))}}));t.EventEmitter.subscribe("onPullEvent-documentgenerator",(e=>{const[t]=e.getData();if(t==="updateTemplate"){this.linksLoaded=false;this.links={};s.MenuManager.destroy(this.getPopupMenuId())}}))}fillLinksFromResponse(e){this.linksLoaded=true;this.links={};if(this.documentUrl&&e.data.templates&&o.Type.isArray(e.data.templates)){this.links.templates=[];const t=e.data.templates.length;for(let i=0;i<t;i++){const t=BX.util.add_url_param(this.documentUrl,{templateId:parseInt(e.data.templates[i].id,10),providerClassName:this.provider.replaceAll("\\","\\\\"),value:this.value,analyticsLabel:"generateDocument",templateCode:e.data.templates[i].code});const s={};if(this.sliderWidth){s.sliderWidth=this.sliderWidth}this.links.templates[i]={text:o.Text.encode(e.data.templates[i].name),title:o.Text.encode(e.data.templates[i].name),onclick:`BX.DocumentGenerator.Document.onBeforeCreate('${t}',${JSON.stringify(s)},'${this.loaderPath}','${this.moduleId}')`}}}if(e.data.documentList&&this.documentUrl){this.links.documentList=BX.util.add_url_param(e.data.documentList,{provider:this.provider.replaceAll("\\","\\\\"),module:this.moduleId,value:this.value,viewUrl:this.documentUrl,loaderPath:this.loaderPath})}if(e.data.canEditTemplate&&this.templateListUrl){this.links.templateList=this.templateListUrl}if(e.data.intranetExtensions){this.intranetExtensions=e.data.intranetExtensions}}prepareLinksForPopup(){let e=[];let t=false;if(!this.linksLoaded){return e}if(this.links.templates&&o.Type.isArray(this.links.templates)){e=this.links.templates;t=true}if(this.links.documentList){if(t){e[e.length]={delimiter:true};t=false}e[e.length]={text:this.documentsText,onclick:`BX.DocumentGenerator.openUrl('${this.links.documentList}', null, 1060)`}}if(this.links.templateList){if(t){e[e.length]={delimiter:true}}e[e.length]={text:this.templatesText,onclick:`BX.DocumentGenerator.openUrl('${this.links.templateList}', null, 1060)`}}if(this.intranetExtensions){e.push({delimiter:true},this.intranetExtensions)}return e}showPopup(){s.MenuManager.show(this.getPopupMenuId(),this.getElement(),this.prepareLinksForPopup(),{offsetLeft:0,offsetTop:0,closeByEsc:true,className:"document-toolbar-menu",maxWidth:600})}getPopupMenuId(){return`${this.id}_menu`}getLoader(){if(!this.loader){this.loader=new n.Loader({size:50})}return this.loader}showLoader(){if(this.getElement()&&!this.getLoader().isShown()){this.getLoader().show(this.getElement())}}hideLoader(){if(this.getLoader().isShown()){this.getLoader().hide()}}}function r(e,t){const i=document.createElement("a");const s={};let o=null;let n=null;i.href=e;const a=i.search.replace(/^\?/,"").split("&");for(n=0;n<a.length;n++){o=a[n].split("=");s[o[0]]=o[1]}const r={protocol:i.protocol,host:i.host,hostname:i.hostname,port:i.port,pathname:i.pathname,search:i.search,params:s,hash:i.hash};if(t&&Object.hasOwn(r,t)){return r[t]}return r}function l(e,t,i){if(BX.SidePanel){if(!o.Type.isNumber(i)){i=810}BX.SidePanel.Instance.open(e,{width:i,cacheable:false,loader:t});const n=s.MenuManager.getCurrentMenu();if(n&&n.popupWindow){n.popupWindow.close()}}else{location.href=e}}let h=null;function d(e,t,i,n){var a;i=i||"";if(o.Type.isNil(t)||o.Type.isObjectLike(t)&&Object.keys(t).length<=0){t=[new s.PopupWindowButton({text:o.Loc.getMessage("DOCGEN_PREVIEW_CLOSE_BUTTON"),className:"ui-btn ui-btn-md ui-btn-default",events:{click(e){this.popupWindow.close();BX.PreventDefault(e)}}})]}(a=h)==null?void 0:a.destroy();if(!o.Type.isDomNode(e)){const t=document.createElement("div");t.innerHTML=e;e=t}if(!o.Type.isArray(e)){e=[e]}h=new s.Popup("bx-popup-documentgenerator-popup",null,{zIndex:200,autoHide:true,closeByEsc:true,buttons:t,closeIcon:true,overlay:true,events:{onPopupClose(){if(o.Type.isFunction(n)){n()}this.destroy()},onPopupDestroy:()=>{h=null}},content:o.Dom.create("span",{attrs:{className:"bx-popup-documentgenerator-popup-content-text"},children:e}),titleBar:i,contentColor:"white",className:"bx-popup-documentgenerator-popup",maxWidth:470});h.show()}class u{static askAboutUsingPreviousDocumentNumber(e,t,i,n,a){if(o.Type.isString(e)&&parseInt(t,10)>0&&o.Type.isFunction(n)){if(u.isProcessing===true){return}try{u.isProcessing=true;o.ajax.runAction("documentgenerator.api.document.list",{data:{select:["id","number"],filter:{"=provider":e.toLowerCase(),"=templateId":t,"=value":i},order:{id:"desc"}},navigation:{size:1}}).then((e=>{u.isProcessing=false;if(e.data.documents.length>0){const t=e.data.documents[0].number;d(o.Loc.getMessage("DOCGEN_PREVIEW_DO_USE_OLD_NUMBER"),[new s.PopupWindowButton({text:o.Loc.getMessage("DOCGEN_PREVIEW_NEW_BUTTON"),className:"ui-btn ui-btn-md ui-btn-primary",events:{click(){n();this.popupWindow.destroy()}}}),new s.PopupWindowButton({text:o.Loc.getMessage("DOCGEN_PREVIEW_OLD_BUTTON"),className:"ui-btn ui-btn-md ui-btn-primary",events:{click(){n(t);this.popupWindow.destroy()}}})],o.Loc.getMessage("DOCGEN_PREVIEW_NUMBER_TITLE"),a)}else{n()}})).catch((()=>{u.isProcessing=false;if(o.Type.isFunction(a)){a()}}))}catch{u.isProcessing=false;if(o.Type.isFunction(a)){a()}}}}static onBeforeCreate(e,t,i,n){const a=r(e,"params");const h=decodeURIComponent(a.providerClassName).toLowerCase();const m=a.templateId;const p=a.value;const c=Object.hasOwn(t,"sliderWidth")?t.sliderWidth:null;if(Object.hasOwn(a,"documentId")){l(e,i,c)}else{o.ajax.runAction("documentgenerator.api.dataprovider.isPrintable",{data:{provider:h,value:p,options:{},module:n}}).then((()=>{if(Object.hasOwn(a,"documentId")){l(e,i,c)}else{u.askAboutUsingPreviousDocumentNumber(h,m,p,(t=>{if(t){e=BX.util.add_url_param(e,{number:t})}l(e,i,c)}))}})).catch((e=>{d(e.errors.map((e=>e.message)).join("<br>"),[new s.PopupWindowButton({text:o.Loc.getMessage("DOCGEN_PREVIEW_CONTINUE_BUTTON"),className:"ui-btn ui-btn-md ui-btn-success",events:{click(e){this.popupWindow.close();BX.PreventDefault(e)}}})],o.Loc.getMessage("DOCGEN_PREVIEW_PRINT_TITLE"))}))}}}u.isProcessing=false;let m=false;class p{constructor(e){this.loader=null;this.documentId=null;this.pullTag=null;this.startImageUrl=null;this.imageUrl=null;this.imageContainer=null;this.imageNode=null;this.printUrl=null;this.pdfUrl=null;this.hash="";this.isPublicMode=false;this.isTransformationError=false;this.transformationErrorNode=null;this.transformationErrorMessage="";this.transformationErrorCode=0;this.previewNode=null;this.onReady=()=>{};this.hash=e.hash||"";this.isPublicMode=e.isPublicMode||false;this.isTransformationError=false;this.transformationErrorNode=null;this.transformationErrorMessage="";this.transformationErrorCode=0;this.previewNode=null;this.onReady=()=>{};this.applyOptions(e);this.initPushEvent();this.start()}isPullConnected(){if(top.BX.PULL){if(o.Type.isFunction(top.BX.PULL.isConnected)){return top.BX.PULL.isConnected()}const e=top.BX.PULL.getDebugInfoArray();return e.connected}return false}initPushEvent(){if(!m){if(this.isPullConnected()){m=true;top.BX.addCustomEvent("onPullEvent-documentgenerator",this.showImage.bind(this))}else if(this.documentId>0&&!this.imageUrl){let e="documentgenerator.api.document.get";const t={id:this.documentId};if(this.isPublicMode&&o.Type.isString(this.hash)&&this.hash.length>10){e="documentgenerator.api.publicdocument.get";t.hash=this.hash}m=true;setTimeout((()=>{void o.ajax.runAction(e,{data:t}).then((e=>{m=false;if(e.data.document.imageUrl){this.showImage("showImage",e.data.document)}else{this.initPushEvent()}}),(()=>{m=false}))}),5e3)}}}applyOptions(e){if(e.id){this.documentId=e.id}if(e.pullTag){this.pullTag=e.pullTag}if(e.imageUrl){this.imageUrl=e.imageUrl}if(e.startImageUrl){this.startImageUrl=e.startImageUrl}if(e.printUrl){this.printUrl=e.printUrl}if(e.pdfUrl){this.pdfUrl=e.pdfUrl}if(e.emailDiskFile){this.emailDiskFile=e.emailDiskFile}if(o.Type.isDomNode(e.imageContainer)){this.imageContainer=e.imageContainer}if(o.Type.isDomNode(e.previewNode)){this.previewNode=e.previewNode}if(o.Type.isDomNode(e.transformationErrorNode)){this.transformationErrorNode=e.transformationErrorNode}if(o.Type.isBoolean(e.isTransformationError)){this.isTransformationError=e.isTransformationError}if(o.Type.isString(e.transformationErrorMessage)){this.transformationErrorMessage=e.transformationErrorMessage}else{this.transformationErrorMessage=""}if(o.Type.isNumber(e.transformationErrorCode)){this.transformationErrorCode=e.transformationErrorCode}else{this.transformationErrorCode=0}if(o.Type.isFunction(e.onReady)){this.onReady=e.onReady}this.initPushEvent()}getLoader(){if(!this.loader){this.loader=new n.Loader({size:100,offset:{left:"-8%",top:"6%"}})}return this.loader}showLoader(){if(this.imageContainer&&!this.getLoader().isShown()){this.getLoader().show(this.imageContainer)}if(o.Type.isDomNode(this.imageNode)){o.Dom.style(this.imageNode,{opacity:.5})}}hideLoader(){if(this.getLoader().isShown()){this.getLoader().hide()}if(o.Type.isDomNode(this.imageNode)){o.Dom.style(this.imageNode,{opacity:1})}}isValidPullTag(e,t){return e==="showImage"&&t.pullTag===this.pullTag}showImage(e,t){if(this.isValidPullTag(e,t)){this.applyOptions(t);if(o.Type.isDomNode(this.previewNode)){BX.hide(this.previewNode)}if(o.Type.isDomNode(this.transformationErrorNode)){if(this.isTransformationError){BX.show(this.transformationErrorNode)}else{BX.hide(this.transformationErrorNode)}}this.showImageNode();this.onReady(t);if(this.loader&&this.loader.isShown()){this.loader.hide()}}}start(){if(this.imageUrl){this.showImageNode()}else if(this.startImageUrl){this.imageUrl=this.startImageUrl;this.startImageUrl=null;this.showImageNode();if(o.Type.isDomNode(this.imageNode)){o.Dom.style(this.imageNode,{opacity:.2})}if(this.pullTag){this.showLoader()}}else if(!this.isTransformationError&&!this.previewNode){this.showLoader()}}showImageNode(){if(!o.Type.isDomNode(this.imageContainer)){return}if(!o.Type.isDomNode(this.imageNode)){this.imageNode=o.Dom.create("img",{style:{opacity:.1,display:"none"}});o.Dom.append(this.imageNode,this.imageContainer)}if(this.imageUrl){this.imageNode.src=this.imageUrl;BX.show(this.imageNode);o.Dom.style(this.imageNode,{opacity:1})}}}e.openUrl=l;e.parseUrl=r;e.showMessage=d;e.DocumentPreview=p;e.Button=a;e.Document=u})(this.BX.DocumentGenerator=this.BX.DocumentGenerator||{},BX.Event,BX.UI.Dialogs,BX.Main,BX,BX);
//# sourceMappingURL=preview.bundle.map.js