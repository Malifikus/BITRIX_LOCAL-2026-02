this.BX=this.BX||{};this.BX.Crm=this.BX.Crm||{};(function(e,s,t,i,l,a,r,n,o,c){"use strict";let d=e=>e,h,b,u,v,p,y,L,f,P,m,g,H;const B=t.Reflection.namespace("BX.CrmActivityEditor");const F=t.Reflection.namespace("BX.userOptions");const _=t.Reflection.namespace("BX.UI.Notification.Center");const C="PHONE";const T="EMAIL";const I="IM";const E=4;const M="category/crm_robot_sms/";const O="#LINK#";const S=new Map;var N=babelHelpers.classPrivateFieldLooseKey("link");var A=babelHelpers.classPrivateFieldLooseKey("isInsertLinkInMessage");var k=babelHelpers.classPrivateFieldLooseKey("loader");var w=babelHelpers.classPrivateFieldLooseKey("getLinkPromise");var j=babelHelpers.classPrivateFieldLooseKey("menu");var K=babelHelpers.classPrivateFieldLooseKey("menuConfigurable");var R=babelHelpers.classPrivateFieldLooseKey("analytics");var x=babelHelpers.classPrivateFieldLooseKey("getChannelById");var X=babelHelpers.classPrivateFieldLooseKey("isChannelAvailable");var $=babelHelpers.classPrivateFieldLooseKey("getLink");var U=babelHelpers.classPrivateFieldLooseKey("getSignedTemplate");var D=babelHelpers.classPrivateFieldLooseKey("handleFooterClick");var V=babelHelpers.classPrivateFieldLooseKey("handleSettingsClick");var G=babelHelpers.classPrivateFieldLooseKey("openMenu");var W=babelHelpers.classPrivateFieldLooseKey("getMenuItemsInViewMode");var z=babelHelpers.classPrivateFieldLooseKey("getMenu");var q=babelHelpers.classPrivateFieldLooseKey("switchMenuToEditMode");var Y=babelHelpers.classPrivateFieldLooseKey("saveSettings");var J=babelHelpers.classPrivateFieldLooseKey("switchMenuToViewMode");var Q=babelHelpers.classPrivateFieldLooseKey("getMenuItemsInEditMode");var Z=babelHelpers.classPrivateFieldLooseKey("getMenuConfigurable");var ee=babelHelpers.classPrivateFieldLooseKey("showGetLinkErrorNotification");var se=babelHelpers.classPrivateFieldLooseKey("showNotice");var te=babelHelpers.classPrivateFieldLooseKey("handleChannelClick");var ie=babelHelpers.classPrivateFieldLooseKey("getSmsText");var le=babelHelpers.classPrivateFieldLooseKey("openContactCenter");var ae=babelHelpers.classPrivateFieldLooseKey("showLoader");var re=babelHelpers.classPrivateFieldLooseKey("hideLoader");var ne=babelHelpers.classPrivateFieldLooseKey("getLoader");class oe extends i.EventEmitter{constructor(e){super();Object.defineProperty(this,ne,{value:Me});Object.defineProperty(this,re,{value:Ee});Object.defineProperty(this,ae,{value:Ie});Object.defineProperty(this,le,{value:Te});Object.defineProperty(this,ie,{value:Ce});Object.defineProperty(this,te,{value:_e});Object.defineProperty(this,se,{value:Fe});Object.defineProperty(this,ee,{value:Be});Object.defineProperty(this,Z,{value:He});Object.defineProperty(this,Q,{value:ge});Object.defineProperty(this,J,{value:me});Object.defineProperty(this,Y,{value:Pe});Object.defineProperty(this,q,{value:fe});Object.defineProperty(this,z,{value:Le});Object.defineProperty(this,W,{value:ye});Object.defineProperty(this,G,{value:pe});Object.defineProperty(this,V,{value:ve});Object.defineProperty(this,D,{value:ue});Object.defineProperty(this,U,{value:be});Object.defineProperty(this,$,{value:he});Object.defineProperty(this,X,{value:de});Object.defineProperty(this,x,{value:ce});Object.defineProperty(this,N,{writable:true,value:void 0});this.isCombineMessageWithLink=true;Object.defineProperty(this,A,{writable:true,value:false});Object.defineProperty(this,k,{writable:true,value:void 0});Object.defineProperty(this,w,{writable:true,value:void 0});Object.defineProperty(this,j,{writable:true,value:void 0});Object.defineProperty(this,K,{writable:true,value:void 0});Object.defineProperty(this,R,{writable:true,value:void 0});this.title=t.Type.isStringFilled(e.title)?e.title:t.Loc.getMessage("CRM_CHANNEL_SELECTOR_DEFAULT_TITLE_MSGVER_1");this.documentTitle=String(e.documentTitle);this.body=String(e.body);this.fullBody=String(e.fullBody);babelHelpers.classPrivateFieldLooseBase(this,N)[N]=String(e.link);this.isLinkObtainable=t.Text.toBoolean(e.isLinkObtainable);this.entityTypeId=t.Text.toInteger(e.entityTypeId);this.entityId=t.Text.toInteger(e.entityId);this.id=t.Type.isStringFilled(e.id)?e.id:this.entityTypeId+"_"+this.entityId+"_"+Math.random().toString().substring(2);this.storageTypeId=t.Text.toInteger(e.storageTypeId);this.files=t.Type.isArray(e.files)?e.files:[];this.activityEditorId=String(e.activityEditorId);this.smsUrl=String(e.smsUrl);this.isCombineMessageWithLink=t.Type.isBoolean(e.isCombineMessageWithLink)?e.isCombineMessageWithLink:true;babelHelpers.classPrivateFieldLooseBase(this,A)[A]=t.Type.isBoolean(e.isInsertLinkInMessage)?e.isInsertLinkInMessage:false;this.setChannels(e.channels);this.communications=t.Type.isPlainObject(e.communications)?e.communications:{};this.hasVisibleChannels=t.Text.toBoolean(e.hasVisibleChannels);this.channelIcons=t.Type.isArray(e.channelIcons)?e.channelIcons:[];this.contactCenterUrl=t.Type.isStringFilled(e.contactCenterUrl)?e.contactCenterUrl:"/contact_center/";this.layout={channels:{}};this.messageSenderSceneId=String(e.messageSenderSceneId);babelHelpers.classPrivateFieldLooseBase(this,R)[R]=e.analytics;this.setEventNamespace("BX.Crm.ChannelSelector.List");if(S.size===0){S.set("default",this)}S.set(this.id,this)}setChannels(e){this.channels=[];if(t.Type.isArray(e)){e.forEach((e=>{this.channels.push(e)}))}return this}render(){if(this.layout.container){return this.layout.container}this.layout.title=t.Tag.render(h||(h=d`<div class="crm__channel-selector--title">${0}</div>`),t.Text.encode(this.title));if(babelHelpers.classPrivateFieldLooseBase(this,N)[N]||this.isLinkObtainable){this.layout.link=t.Tag.render(b||(b=d`<input type="text" class="crm__channel-selector--footer-link-hidden" value="${0}" />`),t.Text.encode(babelHelpers.classPrivateFieldLooseBase(this,N)[N]));const e=new n.Button({size:n.ButtonSize.LARGE,style:n.AirButtonStyle.OUTLINE,useAirDesign:true,icon:n.ButtonIcon.COPY,wide:true,text:t.Loc.getMessage("CRM_CHANNEL_FOOTER_TITLE"),onclick:()=>babelHelpers.classPrivateFieldLooseBase(this,D)[D]()}).getContainer();this.layout.footer=t.Tag.render(u||(u=d`
				<div class="crm__channel-selector--footer">
					${0}
				</div>
			`),e)}else{this.layout.footer=null}this.layout.settings=null;if(this.hasVisibleChannels){const e=new o.Icon({icon:o.Outline.SETTINGS,size:19}).render();this.layout.settings=t.Tag.render(v||(v=d`<div class="crm__channel-selector--setting-btn" onclick="${0}">${0}</div>`),babelHelpers.classPrivateFieldLooseBase(this,V)[V].bind(this),e);this.layout.list=t.Tag.render(p||(p=d`<div class="crm__channel-selector--list"></div>`));this.channels.forEach((e=>{const s=this.renderChannel(e);if(s){this.layout.channels[e.id]=s}}))}else{this.layout.list=t.Tag.render(y||(y=d`<div class="crm__channel-selector--body">
			<div class="crm__channel-selector--networks">
				<div class="crm__channel-selector--networks-title">${0}</div>
				<div class="crm__channel-selector--networks-block">
					${0}
					<span class="crm__channel-selector--network-link --link" onclick="${0}">+ 15</span>
				</div>
				<span class="ui-btn ui-btn-xs ui-btn-primary ui-btn-no-caps ui-btn-round" onclick="${0};">${0}</span>
			</div>
		</div>`),t.Loc.getMessage("CRM_CHANNEL_SELECTOR_NO_ACTIVE_CHANNELS_TEXT"),this.channelIcons.map((e=>t.Tag.render(L||(L=d`<span class="crm__channel-selector--network-link --${0}" onclick="${0}"></span>`),e,babelHelpers.classPrivateFieldLooseBase(this,le)[le].bind(this)))),babelHelpers.classPrivateFieldLooseBase(this,le)[le].bind(this),babelHelpers.classPrivateFieldLooseBase(this,le)[le].bind(this),t.Loc.getMessage("CRM_CHANNEL_SELECTOR_ACTIVATE_CHANNELS"))}this.layout.container=t.Tag.render(f||(f=d`<div class="crm__channel-selector--container">
			<div class="crm__channel-selector--header">
				${0}
				${0}
			</div>
			${0}
		</div>`),this.layout.title,this.layout.settings,this.layout.list);if(this.layout.footer){this.layout.container.appendChild(this.layout.footer)}this.adjustAppearance();return this.layout.container}renderChannel(e){const s=()=>{babelHelpers.classPrivateFieldLooseBase(this,te)[te](e)};const i=new o.Icon({icon:o.Outline.CHEVRON_RIGHT_M,size:24,color:"var(--crm-channel-selector-chevron-color)"}).render();const l=oe.getChannelIcon(e);return t.Tag.render(P||(P=d`<div 
			class="crm__channel-selector--channel"
			onclick="${0}"
		>
			${0}
			<div class="crm__channel-selector--channel-content">
				${0}
				${0}
			</div>
			<div class="crm__channel-selector--channel-helper">${0}</div>
		</div>`),s,l?t.Tag.render(m||(m=d`<div class="crm__channel-selector--channel-icon ${0}"></div>`),l):"",this.renderChannelMainTitle(e),this.renderChannelTitle(e),i)}renderChannelMainTitle(e){var s;return t.Tag.render(g||(g=d`<div class="crm__channel-selector--channel-main-title">
			${0}
		</div>`),t.Text.encode((s=e.categoryTitle)!=null?s:e.title))}renderChannelTitle(e){const s=e.categoryTitle?e.title:e.status;if(!s){return null}return t.Tag.render(H||(H=d`
			<div 
				class="crm__channel-selector--channel-title" 
				style="${0}"
			>
				${0}
			</div>
		`),e.type==="IM"&&e.isAvailable?"color: var(--ui-color-accent-main-primary);":"",t.Text.encode(s))}adjustAppearance(){if(this.hasVisibleChannels){t.Dom.clean(this.layout.list);let e=true;this.channels.forEach((s=>{const i=this.layout.channels[s.id];if(i){this.layout.list.append(i);if(babelHelpers.classPrivateFieldLooseBase(this,X)[X](s)){t.Dom.removeClass(i,"crm__channel-selector--channel-disabled")}else{t.Dom.addClass(i,"crm__channel-selector--channel-disabled")}if(s.isHidden){t.Dom.addClass(i,"crm__channel-selector--channel-hidden")}else{t.Dom.removeClass(i,"crm__channel-selector--channel-hidden");e=false}}}));if(e){t.Dom.addClass(this.layout.list,"--empty")}else{t.Dom.removeClass(this.layout.list,"--empty")}}}setFiles(e){this.files=t.Type.isArray(e)?e:[];this.adjustAppearance();return this}setLink(e){babelHelpers.classPrivateFieldLooseBase(this,N)[N]=e!=null?e:null;this.adjustAppearance();return this}sendEmail(e){if(this.files.length<=0||Number(this.storageTypeId)<=0){const s=this.layout.channels[e.id];babelHelpers.classPrivateFieldLooseBase(this,$)[$]().then((e=>{var s;B==null?void 0:(s=B.items[this.activityEditorId])==null?void 0:s.addEmail({subject:this.documentTitle,body:t.Loc.getMessage("CRM_CHANNEL_SELECTOR_MESSAGE_WITH_LINK",{"#MESSAGE#":this.documentTitle,"#LINK#":e})})})).catch((e=>{babelHelpers.classPrivateFieldLooseBase(this,ee)[ee](s,e)}))}else{var s;B==null?void 0:(s=B.items[this.activityEditorId])==null?void 0:s.addEmail({subject:this.documentTitle,diskfiles:this.files,storageTypeID:this.storageTypeId})}}sendSms(e){const t=this.layout.channels[e.id];if(!this.smsUrl){babelHelpers.classPrivateFieldLooseBase(this,ee)[ee](t,"No sms url");return}babelHelpers.classPrivateFieldLooseBase(this,$)[$]().then((t=>{const i={entityTypeId:this.entityTypeId,entityId:this.entityId,text:babelHelpers.classPrivateFieldLooseBase(this,ie)[ie](e,t),providerId:e.id,isProviderFixed:"N",canUseBitrix24Provider:"Y",messageSenderSceneId:this.messageSenderSceneId,analytics:babelHelpers.classPrivateFieldLooseBase(this,R)[R]};babelHelpers.classPrivateFieldLooseBase(this,U)[U](e).then((e=>{if(e){i.signedTemplate=e;i.isEditable="N"}})).catch().finally((()=>{s.Router.openSlider(this.smsUrl,{width:900,requestMethod:"post",requestParams:i})}))})).catch((e=>{babelHelpers.classPrivateFieldLooseBase(this,ee)[ee](t,e)}))}openMessenger(e){if(!top.BXIM){return}if(!this.communications[e.type]){return}top.BXIM.openMessenger(this.communications[e.type].VALUE,{RECENT:"N",MENU:"N"})}getId(){return this.id}static getDefault(){return S.get("default")}static getById(e){return S.get(e)}static getChannelIcon(e){return e.icon||oe.getIconByChannelId(e.id)}static getIconByChannelId(e){if(e==="bitrix24"){return"--service-bitrix24"}if(e===T){return"--service-email"}if(e===I){return"--service-livechat"}if(e==="twilio"){return"--service-whatsapp"}if(e==="ednaru"||e==="ednaruimhpx"){return"--service-edna"}return"--service-sms"}}function ce(e){return this.channels.find((s=>s.id===e))}function de(e){if(!e.isAvailable){return false}const s=this.isLinkObtainable||Boolean(babelHelpers.classPrivateFieldLooseBase(this,N)[N]);const t=B&&this.storageTypeId>0&&this.files.length>0;if(e.type===C||e.type===I){return s}if(e.type===T){return s||t}if(e.type===T&&!(B!=null&&B.items[this.activityEditorId])){console.log("Email channel is disabled because the CrmActivityEditor instance is not found");return false}return e.isAvailable}function he(){if(babelHelpers.classPrivateFieldLooseBase(this,N)[N]){return Promise.resolve(babelHelpers.classPrivateFieldLooseBase(this,N)[N])}if(!this.isLinkObtainable){return Promise.reject()}if(babelHelpers.classPrivateFieldLooseBase(this,w)[w]){return babelHelpers.classPrivateFieldLooseBase(this,w)[w]}babelHelpers.classPrivateFieldLooseBase(this,w)[w]=new Promise(((e,s)=>{babelHelpers.classPrivateFieldLooseBase(this,ae)[ae]();this.emitAsync("getLink").then((t=>{t.forEach((e=>{this.setLink(e)}));if(!babelHelpers.classPrivateFieldLooseBase(this,N)[N]){s()}else{e(babelHelpers.classPrivateFieldLooseBase(this,N)[N])}})).catch(s).finally((()=>{babelHelpers.classPrivateFieldLooseBase(this,w)[w]=null;babelHelpers.classPrivateFieldLooseBase(this,re)[re]()}))}));return babelHelpers.classPrivateFieldLooseBase(this,w)[w]}function be(e){if(e.signedTemplate){return Promise.resolve(e.signedTemplate)}return new Promise(((e,s)=>{babelHelpers.classPrivateFieldLooseBase(this,ae)[ae]();this.emitAsync("getSignedTemplate").then((t=>{const i=t[0];if(!i){s()}else{e(i)}})).catch(s).finally((()=>{babelHelpers.classPrivateFieldLooseBase(this,re)[re]()}))}))}function ue(){babelHelpers.classPrivateFieldLooseBase(this,$)[$]().then((e=>{if(BX.clipboard.isCopySupported()&&babelHelpers.classPrivateFieldLooseBase(this,N)[N]){BX.clipboard.copy(e)}babelHelpers.classPrivateFieldLooseBase(this,se)[se](t.Loc.getMessage("CRM_CHANNEL_PUBLIC_LINK_COPIED_NOTIFICATION_MESSAGE"))})).catch((e=>{babelHelpers.classPrivateFieldLooseBase(this,ee)[ee](this.layout.footer,e)}))}function ve(){const e=new i.BaseEvent;this.emit("onSettingsClick",e);if(e.isDefaultPrevented()){return}babelHelpers.classPrivateFieldLooseBase(this,G)[G]()}function pe(){babelHelpers.classPrivateFieldLooseBase(this,z)[z]().show()}function ye(){const e=[];this.channels.forEach((s=>{if(s.isHidden){e.push({text:s.title,id:s.id,onclick:()=>{babelHelpers.classPrivateFieldLooseBase(this,te)[te](s)}})}}));e.push({delimiter:true});e.push({text:t.Loc.getMessage("CRM_CHANNEL_SELECTOR_CHOOSE_FROM_MARKET"),id:"market",href:t.Loc.getMessage("MARKET_BASE_PATH")+M,onclick:(e,s)=>{var t;const i=((t=s.getMenuWindow())==null?void 0:t.getRootMenuWindow())||s.getMenuWindow();i==null?void 0:i.close()}});e.push({delimiter:true});e.push({text:t.Loc.getMessage("CRM_COMMON_ACTION_CONFIG"),id:"configure",onclick:babelHelpers.classPrivateFieldLooseBase(this,q)[q].bind(this)});return e}function Le(){if(!babelHelpers.classPrivateFieldLooseBase(this,j)[j]){babelHelpers.classPrivateFieldLooseBase(this,j)[j]=a.MenuManager.create({id:this.id+"-settings-popup",bindElement:this.layout.settings,items:babelHelpers.classPrivateFieldLooseBase(this,W)[W]()})}return babelHelpers.classPrivateFieldLooseBase(this,j)[j]}function fe(){babelHelpers.classPrivateFieldLooseBase(this,z)[z]().close();babelHelpers.classPrivateFieldLooseBase(this,Z)[Z]().open().then((e=>{if(e.isCanceled){return}if(t.Type.isArray(e.items)){babelHelpers.classPrivateFieldLooseBase(this,Y)[Y](e.items);babelHelpers.classPrivateFieldLooseBase(this,G)[G]()}}))}function Pe(e){const s=[];e.forEach((e=>{const t=babelHelpers.classPrivateFieldLooseBase(this,x)[x](e.id);if(t){t.isHidden=e.isHidden;s.push(t)}}));this.setChannels(s);this.adjustAppearance();babelHelpers.classPrivateFieldLooseBase(this,j)[j].destroy();babelHelpers.classPrivateFieldLooseBase(this,j)[j]=null;F.save("crm","channel-selector","items",JSON.stringify(e))}function me(){var e;(e=babelHelpers.classPrivateFieldLooseBase(this,K)[K])==null?void 0:e.close();babelHelpers.classPrivateFieldLooseBase(this,z)[z]().show()}function ge(){const e=[];this.channels.forEach((s=>{e.push({text:s.title,id:s.id,isHidden:s.isHidden})}));return e}function He(){const e=babelHelpers.classPrivateFieldLooseBase(this,Q)[Q]();if(!babelHelpers.classPrivateFieldLooseBase(this,K)[K]){babelHelpers.classPrivateFieldLooseBase(this,K)[K]=new c.Menu({items:e,bindElement:this.layout.settings,maxVisibleItems:E});babelHelpers.classPrivateFieldLooseBase(this,K)[K].subscribe("Cancel",(()=>{babelHelpers.classPrivateFieldLooseBase(this,G)[G]()}))}else{babelHelpers.classPrivateFieldLooseBase(this,K)[K].setItems(e)}return babelHelpers.classPrivateFieldLooseBase(this,K)[K]}function Be(e,s){if(!t.Type.isStringFilled(s)){s=t.Loc.getMessage("CRM_CHANNEL_PUBLIC_LINK_NOT_AVAILABLE_NOTIFICATION_MESSAGE")}babelHelpers.classPrivateFieldLooseBase(this,se)[se](s)}function Fe(e){if(_){_.notify({content:e})}}function _e(e){const s=new i.BaseEvent;s.setData({channel:e,communications:this.communications[e.type]});this.emit("onChannelClick",s);if(s.isDefaultPrevented()){return}if(!babelHelpers.classPrivateFieldLooseBase(this,X)[X](e)){return}if(e.type===T){this.sendEmail(e);return}if(e.type===C){this.sendSms(e);return}if(e.type===I){this.openMessenger(e)}}function Ce(e,s){const i=e.id==="bitrix24"&&this.fullBody?this.fullBody:this.body;if(this.isCombineMessageWithLink){return t.Loc.getMessage("CRM_CHANNEL_SELECTOR_MESSAGE_WITH_LINK",{"#MESSAGE#":i,"#LINK#":s})}if(babelHelpers.classPrivateFieldLooseBase(this,A)[A]){return i.replace(O,s)}return i}function Te(){s.Router.openSlider(this.contactCenterUrl).then((()=>{location.reload()}))}function Ie(){const e=babelHelpers.classPrivateFieldLooseBase(this,ne)[ne]();if(e){e.show(this.layout.container)}}function Ee(){const e=babelHelpers.classPrivateFieldLooseBase(this,ne)[ne]();if(e){e.hide()}}function Me(){if(!babelHelpers.classPrivateFieldLooseBase(this,k)[k]&&l.Loader){babelHelpers.classPrivateFieldLooseBase(this,k)[k]=new l.Loader({size:100,offset:{left:"35%",top:"-25%"}})}return babelHelpers.classPrivateFieldLooseBase(this,k)[k]}e.List=oe})(this.BX.Crm.ChannelSelector=this.BX.Crm.ChannelSelector||{},BX.Crm,BX,BX.Event,BX,BX.Main,BX,BX.UI,BX.UI.IconSet,BX.UI.MenuConfigurable);
//# sourceMappingURL=channel-selector.bundle.map.js