this.BX=this.BX||{};this.BX.Crm=this.BX.Crm||{};(function(e,t,s,i,a,l,n,r,o,c,d,h,u,p,b,v,m,g,y,L,f,P,_,B,E,T,I,C){"use strict";var F=babelHelpers.classPrivateFieldLooseKey("entityTypeId");var S=babelHelpers.classPrivateFieldLooseKey("entityId");var H=babelHelpers.classPrivateFieldLooseKey("entityCategoryId");var O=babelHelpers.classPrivateFieldLooseKey("isReadonly");var M=babelHelpers.classPrivateFieldLooseKey("menuBarContainer");var N=babelHelpers.classPrivateFieldLooseKey("extras");class w{constructor(e){var t;Object.defineProperty(this,F,{writable:true,value:null});Object.defineProperty(this,S,{writable:true,value:null});Object.defineProperty(this,H,{writable:true,value:null});Object.defineProperty(this,O,{writable:true,value:false});Object.defineProperty(this,M,{writable:true,value:null});Object.defineProperty(this,N,{writable:true,value:{}});babelHelpers.classPrivateFieldLooseBase(this,F)[F]=e.entityTypeId;babelHelpers.classPrivateFieldLooseBase(this,S)[S]=e.entityId;babelHelpers.classPrivateFieldLooseBase(this,H)[H]=I.Type.isNumber(e.entityCategoryId)?e.entityCategoryId:null;babelHelpers.classPrivateFieldLooseBase(this,O)[O]=e.isReadonly;babelHelpers.classPrivateFieldLooseBase(this,M)[M]=e.menuBarContainer;babelHelpers.classPrivateFieldLooseBase(this,N)[N]=(t=e.extras)!=null?t:{}}getEntityTypeId(){return babelHelpers.classPrivateFieldLooseBase(this,F)[F]}getEntityId(){return babelHelpers.classPrivateFieldLooseBase(this,S)[S]}getEntityCategoryId(){return babelHelpers.classPrivateFieldLooseBase(this,H)[H]}isReadonly(){return babelHelpers.classPrivateFieldLooseBase(this,O)[O]}getMenuBarContainer(){return babelHelpers.classPrivateFieldLooseBase(this,M)[M]}getExtras(){return babelHelpers.classPrivateFieldLooseBase(this,N)[N]}}var A=babelHelpers.classPrivateFieldLooseKey("context");var R=babelHelpers.classPrivateFieldLooseKey("settings");var D=babelHelpers.classPrivateFieldLooseKey("eventEmitter");var k=babelHelpers.classPrivateFieldLooseKey("isVisible");var x=babelHelpers.classPrivateFieldLooseKey("container");class j{constructor(){Object.defineProperty(this,A,{writable:true,value:null});Object.defineProperty(this,R,{writable:true,value:{}});Object.defineProperty(this,D,{writable:true,value:null});Object.defineProperty(this,k,{writable:true,value:false});Object.defineProperty(this,x,{writable:true,value:null})}initialize(e,t){babelHelpers.classPrivateFieldLooseBase(this,A)[A]=e;babelHelpers.classPrivateFieldLooseBase(this,R)[R]=t;babelHelpers.classPrivateFieldLooseBase(this,D)[D]=new E.EventEmitter;babelHelpers.classPrivateFieldLooseBase(this,D)[D].setEventNamespace("BX.Crm.Timeline.MenuBar");this.initializeSettings();if(!babelHelpers.classPrivateFieldLooseBase(this,A)[A].isReadonly()&&this.supportsLayout()){babelHelpers.classPrivateFieldLooseBase(this,x)[x]=this.createLayout();I.Dom.prepend(babelHelpers.classPrivateFieldLooseBase(this,x)[x],this.getMenuBarContainer());this.initializeLayout()}this.showTour()}getEntityTypeId(){return babelHelpers.classPrivateFieldLooseBase(this,A)[A].getEntityTypeId()}getEntityId(){return babelHelpers.classPrivateFieldLooseBase(this,A)[A].getEntityId()}getEntityCategoryId(){return babelHelpers.classPrivateFieldLooseBase(this,A)[A].getEntityCategoryId()}getMenuBarContainer(){return babelHelpers.classPrivateFieldLooseBase(this,A)[A].getMenuBarContainer()}getExtras(){return babelHelpers.classPrivateFieldLooseBase(this,A)[A].getExtras()}getContainer(){return babelHelpers.classPrivateFieldLooseBase(this,x)[x]}setContainer(e){if(I.Type.isDomNode(e)&&!babelHelpers.classPrivateFieldLooseBase(this,A)[A].isReadonly()&&this.supportsLayout()){if(babelHelpers.classPrivateFieldLooseBase(this,x)[x]){I.Dom.remove(babelHelpers.classPrivateFieldLooseBase(this,x)[x])}babelHelpers.classPrivateFieldLooseBase(this,x)[x]=e;I.Dom.prepend(babelHelpers.classPrivateFieldLooseBase(this,x)[x],this.getMenuBarContainer());this.initializeLayout()}}supportsLayout(){return true}activate(){if(this.supportsLayout()){this.setVisible(true)}else{this.showSlider()}}deactivate(){this.setVisible(false)}showSlider(){throw new Error("Method showSlider() must be overridden")}getSetting(e,t=null){var s,i;return(s=(i=babelHelpers.classPrivateFieldLooseBase(this,R)[R])==null?void 0:i[e])!=null?s:t}setSettings(e){babelHelpers.classPrivateFieldLooseBase(this,R)[R]=e}getSettings(){return babelHelpers.classPrivateFieldLooseBase(this,R)[R]}setVisible(e){e=!!e;if(babelHelpers.classPrivateFieldLooseBase(this,k)[k]===e){return}babelHelpers.classPrivateFieldLooseBase(this,k)[k]=e;const t=this.getContainer();if(!t){return}if(e){I.Dom.removeClass(t,"--hidden");this.onShow()}else{this.onHide();I.Dom.addClass(t,"--hidden")}}isVisible(){return babelHelpers.classPrivateFieldLooseBase(this,k)[k]}setFocused(e){const t=this.getContainer();if(!t){return}if(e){I.Dom.addClass(t,"--focus")}else{I.Dom.removeClass(t,"--focus")}}setLocked(e){const t=this.getContainer();if(!t){return}if(e){I.Dom.addClass(t,"--locked")}else{I.Dom.removeClass(t,"--locked")}}isLocked(){const e=this.getContainer();if(!e){return false}return I.Dom.hasClass(e,"--locked")}addFinishEditListener(e){babelHelpers.classPrivateFieldLooseBase(this,D)[D].subscribe(j.ON_FINISH_EDIT_EVENT,e)}emitFinishEditEvent(){babelHelpers.classPrivateFieldLooseBase(this,D)[D].emit(j.ON_FINISH_EDIT_EVENT)}createLayout(){throw new Error("Method createLayout() must be overridden")}initializeSettings(){}initializeLayout(){}onShow(){}onHide(){}showTour(){}showNotify(e){t.UI.Notification.Center.notify({content:e})}}j.ON_FINISH_EDIT_EVENT="onFinishEdit";const X="spotlight-crm-timeline-menubar";const K="middle-center";const U=200;const $="crm-entity-stream-content-new-detail-guide-link";const G=400;const V="bottom";var W=babelHelpers.classPrivateFieldLooseKey("params");var z=babelHelpers.classPrivateFieldLooseKey("spotlight");var q=babelHelpers.classPrivateFieldLooseKey("guide");var Y=babelHelpers.classPrivateFieldLooseKey("guideBindElement");var J=babelHelpers.classPrivateFieldLooseKey("targetElementRect");var Z=babelHelpers.classPrivateFieldLooseKey("observerTimeoutId");var Q=babelHelpers.classPrivateFieldLooseKey("getSpotlight");var ee=babelHelpers.classPrivateFieldLooseKey("getGuideBindElement");var te=babelHelpers.classPrivateFieldLooseKey("handleTargetElementResize");var se=babelHelpers.classPrivateFieldLooseKey("assertValidParams");class ie{constructor(e){Object.defineProperty(this,se,{value:re});Object.defineProperty(this,te,{value:ne});Object.defineProperty(this,ee,{value:le});Object.defineProperty(this,Q,{value:ae});Object.defineProperty(this,W,{writable:true,value:{}});Object.defineProperty(this,z,{writable:true,value:null});Object.defineProperty(this,q,{writable:true,value:null});Object.defineProperty(this,Y,{writable:true,value:null});Object.defineProperty(this,J,{writable:true,value:null});Object.defineProperty(this,Z,{writable:true,value:null});if(!babelHelpers.classPrivateFieldLooseBase(this,se)[se](e)){throw new TypeError("Invalid menu bar tour params")}babelHelpers.classPrivateFieldLooseBase(this,W)[W]=e;this.onWindowResize=I.Runtime.debounce(this.onWindowResize.bind(this),100);I.Event.bind(window,"resize",this.onWindowResize)}onWindowResize(){const e=babelHelpers.classPrivateFieldLooseBase(this,ee)[ee](true);babelHelpers.classPrivateFieldLooseBase(this,q)[q].getCurrentStep().setTarget(e);babelHelpers.classPrivateFieldLooseBase(this,q)[q].showNextStep();babelHelpers.classPrivateFieldLooseBase(this,z)[z].setTargetElement(e)}canShow(){return true}show(){babelHelpers.classPrivateFieldLooseBase(this,z)[z]=babelHelpers.classPrivateFieldLooseBase(this,Q)[Q]();babelHelpers.classPrivateFieldLooseBase(this,z)[z].show();this.getGuide().showNextStep()}getGuide(){if(!babelHelpers.classPrivateFieldLooseBase(this,q)[q]){var e;const s={onEvents:true,steps:[{target:babelHelpers.classPrivateFieldLooseBase(this,ee)[ee](),title:babelHelpers.classPrivateFieldLooseBase(this,W)[W].title,text:babelHelpers.classPrivateFieldLooseBase(this,W)[W].text,position:V,rounded:true,events:{onClose:()=>{this.saveUserOption(babelHelpers.classPrivateFieldLooseBase(this,W)[W].userOptionName);babelHelpers.classPrivateFieldLooseBase(this,z)[z].close();if(babelHelpers.classPrivateFieldLooseBase(this,Z)[Z]){clearInterval(babelHelpers.classPrivateFieldLooseBase(this,Z)[Z]);babelHelpers.classPrivateFieldLooseBase(this,Z)[Z]=null}I.Event.unbind(window,"resize",this.onWindowResize)}}}]};if(babelHelpers.classPrivateFieldLooseBase(this,W)[W].articleCode>0){var t;s.steps[0].article=babelHelpers.classPrivateFieldLooseBase(this,W)[W].articleCode;s.steps[0].linkTitle=(t=babelHelpers.classPrivateFieldLooseBase(this,W)[W].linkTitle)!=null?t:I.Loc.getMessage("CRM_TIMELINE_DETAILS")}const i=new p.Guide(s);const a=i.getPopup();a.setWidth((e=babelHelpers.classPrivateFieldLooseBase(this,W)[W].guidePopupWidth)!=null?e:G);const l=a.contentContainer.querySelector(".ui-tour-popup-link");I.Dom.addClass(l,$);babelHelpers.classPrivateFieldLooseBase(this,J)[J]=I.Dom.getPosition(babelHelpers.classPrivateFieldLooseBase(this,ee)[ee]());babelHelpers.classPrivateFieldLooseBase(this,Z)[Z]=setInterval(babelHelpers.classPrivateFieldLooseBase(this,te)[te].bind(this),1e3);babelHelpers.classPrivateFieldLooseBase(this,q)[q]=i}return babelHelpers.classPrivateFieldLooseBase(this,q)[q]}saveUserOption(e=null){console.warn("Method save is not implemented")}getParams(){return babelHelpers.classPrivateFieldLooseBase(this,W)[W]}}function ae(){const e=new BX.SpotLight({id:`${X}-${babelHelpers.classPrivateFieldLooseBase(this,W)[W].itemCode}-guide`,targetElement:babelHelpers.classPrivateFieldLooseBase(this,ee)[ee](),targetVertex:K,zIndex:U,autoSave:"no"});e.bindEvents({onTargetEnter:()=>{if(babelHelpers.classPrivateFieldLooseBase(this,W)[W].stayShowedSpotlight!==true){e.close()}}});return e}function le(e=false){if(I.Type.isDomNode(babelHelpers.classPrivateFieldLooseBase(this,W)[W].guideBindElement)){babelHelpers.classPrivateFieldLooseBase(this,Y)[Y]=babelHelpers.classPrivateFieldLooseBase(this,W)[W].guideBindElement;return babelHelpers.classPrivateFieldLooseBase(this,Y)[Y]}if(!babelHelpers.classPrivateFieldLooseBase(this,Y)[Y]||e){babelHelpers.classPrivateFieldLooseBase(this,Y)[Y]=document.querySelector(`[data-id="${babelHelpers.classPrivateFieldLooseBase(this,W)[W].itemCode}"]`);if(babelHelpers.classPrivateFieldLooseBase(this,Y)[Y].offsetTop){babelHelpers.classPrivateFieldLooseBase(this,Y)[Y]=babelHelpers.classPrivateFieldLooseBase(this,Y)[Y].parentElement.nextElementSibling}}return babelHelpers.classPrivateFieldLooseBase(this,Y)[Y]}function ne(){const e=I.Dom.getPosition(babelHelpers.classPrivateFieldLooseBase(this,ee)[ee]());if(e.left!==babelHelpers.classPrivateFieldLooseBase(this,J)[J].left||e.right!==babelHelpers.classPrivateFieldLooseBase(this,J)[J].right||e.top!==babelHelpers.classPrivateFieldLooseBase(this,J)[J].top||e.bottom!==babelHelpers.classPrivateFieldLooseBase(this,J)[J].bottom){babelHelpers.classPrivateFieldLooseBase(this,J)[J]=I.Dom.getPosition(babelHelpers.classPrivateFieldLooseBase(this,Y)[Y]);const e=babelHelpers.classPrivateFieldLooseBase(this,Y)[Y];const t=Boolean(e.offsetWidth||e.offsetHeight||e.getClientRects().length>0);const s=babelHelpers.classPrivateFieldLooseBase(this,q)[q].getPopup();if(t){I.Dom.removeClass(s.popupContainer,"--hidden");s.adjustPosition()}else{I.Dom.addClass(s.popupContainer,"--hidden")}}}function re(e){if(!I.Type.isPlainObject(e)){console.error('"params" must be specified');return false}if(!I.Type.isStringFilled(e.title)){console.error('"title" must be specified');return false}if(!I.Type.isStringFilled(e.text)){console.error('"text" must be specified');return false}return true}const oe=I.Reflection.namespace("BX.userOptions");var ce=babelHelpers.classPrivateFieldLooseKey("checkOption");class de{constructor(){Object.defineProperty(this,ce,{value:he})}saveUserOption(e){babelHelpers.classPrivateFieldLooseBase(this,ce)[ce](e);oe.save("crm",de.BOOKING_ADS_OPTION,e,1)}}function he(e){if(![de.START_BANNER,de.BEFORE_FIRST_RESOURCE_AHA_OPTION_NAME,de.AFTER_FIRST_RESOURCE_AHA_OPTION_NAME].includes(e)){throw new Error(`User option with name: ${e} unsupported`)}}de.BOOKING_ADS_OPTION="booking_ads";de.START_BANNER="start_banner";de.BEFORE_FIRST_RESOURCE_AHA_OPTION_NAME="before_first_resource";de.AFTER_FIRST_RESOURCE_AHA_OPTION_NAME="after_first_resource";class ue extends ie{saveUserOption(e=null){(new de).saveUserOption(e)}}function pe(){let e;const t=new Promise((t=>{e=t}));t.resolve=e;return t}class be{static sendShowPopup(){const e={tool:be.ANALYTICS_TOOL_BOOKING,category:be.ANALYTICS_CATEGORY_BOOKING,event:"show_popup",c_section:be.ANALYTICS_SECTION_CRM};g.sendData(e)}static sendClickEnable(){const e={tool:be.ANALYTICS_TOOL_BOOKING,category:be.ANALYTICS_CATEGORY_BOOKING,event:"click_enable",c_section:be.ANALYTICS_SECTION_CRM};g.sendData(e)}}be.ANALYTICS_TOOL_BOOKING="booking";be.ANALYTICS_CATEGORY_BOOKING="booking";be.ANALYTICS_SECTION_CRM="crm";var ve=babelHelpers.classPrivateFieldLooseKey("bannerDispatcher");var me=babelHelpers.classPrivateFieldLooseKey("showBanner");var ge=babelHelpers.classPrivateFieldLooseKey("renderBannerComponent");var ye=babelHelpers.classPrivateFieldLooseKey("createBannerComponent");var Le=babelHelpers.classPrivateFieldLooseKey("shouldShowBanner");var fe=babelHelpers.classPrivateFieldLooseKey("setBannerShown");var Pe=babelHelpers.classPrivateFieldLooseKey("showAha");var _e=babelHelpers.classPrivateFieldLooseKey("shouldShowAha");var Be=babelHelpers.classPrivateFieldLooseKey("getAhaParams");var Ee=babelHelpers.classPrivateFieldLooseKey("getBeforeFirstResourceAhaParams");var Te=babelHelpers.classPrivateFieldLooseKey("getAfterFirstResourceAhaParams");var Ie=babelHelpers.classPrivateFieldLooseKey("getFeature");var Ce=babelHelpers.classPrivateFieldLooseKey("isFeatureEnabled");var Fe=babelHelpers.classPrivateFieldLooseKey("showFeaturePromoter");class Se extends j{constructor(){super();Object.defineProperty(this,Fe,{value:Ke});Object.defineProperty(this,Ce,{value:Xe});Object.defineProperty(this,Ie,{value:je});Object.defineProperty(this,Te,{value:xe});Object.defineProperty(this,Ee,{value:ke});Object.defineProperty(this,Be,{value:De});Object.defineProperty(this,_e,{value:Re});Object.defineProperty(this,Pe,{value:Ae});Object.defineProperty(this,fe,{value:we});Object.defineProperty(this,Le,{value:Ne});Object.defineProperty(this,ye,{value:Me});Object.defineProperty(this,ge,{value:Oe});Object.defineProperty(this,me,{value:He});Object.defineProperty(this,ve,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,ve)[ve]=new s.BannerDispatcher}showSlider(){var e;if(!babelHelpers.classPrivateFieldLooseBase(this,Ce)[Ce]()){babelHelpers.classPrivateFieldLooseBase(this,Fe)[Fe]();return}const t=(e=this.getSettings())==null?void 0:e.entities;const s=JSON.stringify(t);const i=`/booking/?embed=${s}`;if(BX.SidePanel){BX.SidePanel.Instance.open(i,{customLeftBoundary:0})}else{window.open(i)}}supportsLayout(){return false}showTour(){babelHelpers.classPrivateFieldLooseBase(this,me)[me]();babelHelpers.classPrivateFieldLooseBase(this,Pe)[Pe]()}}function He(){if(!babelHelpers.classPrivateFieldLooseBase(this,Le)[Le]()){return}babelHelpers.classPrivateFieldLooseBase(this,ve)[ve].toQueue((async e=>{const t=babelHelpers.classPrivateFieldLooseBase(this,ge)[ge]();babelHelpers.classPrivateFieldLooseBase(this,fe)[fe]();await t;e()}),s.Priority.CRITICAL)}async function Oe(){const e=new pe;const t=await babelHelpers.classPrivateFieldLooseBase(this,ye)[ye](e.resolve);const s=I.Dom.create("div");I.Dom.append(s,document.body);t.mount(s);return e}async function Me(e){const{PromoBanner:t}=await I.Runtime.loadExtension("booking.component.promo-banner");const s=o.BitrixVue.createApp({components:{PromoBanner:t},data(){return{isBannerShown:true}},methods:{onClose(){this.isBannerShown=false;e()},buttonClick(){be.sendClickEnable()}},template:'<PromoBanner v-if="isBannerShown" type="crm" @buttonClick="buttonClick" @close="onClose" />'});s.mixin({methods:{loc(e,t){return I.Loc.getMessage(e,t)}}});return s}function Ne(){var e;return((e=this.getSettings())==null?void 0:e.shouldShowBanner)||false}function we(){(new de).saveUserOption(de.START_BANNER);be.sendShowPopup()}function Ae(){if(!babelHelpers.classPrivateFieldLooseBase(this,_e)[_e]()){return}const e=babelHelpers.classPrivateFieldLooseBase(this,Be)[Be]();if(!e){return}const t=document.querySelector('.main-buttons-inner-container .main-buttons-item[data-id="booking"]');if(!t){return}const s=new ue({...e,guideBindElement:t});s.getGuide().getPopup().setAutoHide(true);B.TourManager.getInstance().registerWithLaunch(s)}function Re(){var e;return Boolean((e=this.getSettings())==null?void 0:e.ahaMoments.length)}function De(){var e;switch((e=this.getSettings())==null?void 0:e.ahaMoments[0]){case de.BEFORE_FIRST_RESOURCE_AHA_OPTION_NAME:return babelHelpers.classPrivateFieldLooseBase(this,Ee)[Ee]();case de.AFTER_FIRST_RESOURCE_AHA_OPTION_NAME:return babelHelpers.classPrivateFieldLooseBase(this,Te)[Te]();default:return null}}function ke(){return{itemCode:"booking_before_first_resource",title:I.Loc.getMessage("CRM_TIMELINE_BOOKING_AHA_BEFORE_RESOURCE_TITLE"),text:I.Loc.getMessage("CRM_TIMELINE_BOOKING_AHA_BEFORE_RESOURCE_TEXT"),userOptionName:de.BEFORE_FIRST_RESOURCE_AHA_OPTION_NAME,articleCode:23712054}}function xe(){return{itemCode:"booking_after_first_resource",title:I.Loc.getMessage("CRM_TIMELINE_BOOKING_AHA_AFTER_RESOURCE_TITLE"),text:I.Loc.getMessage("CRM_TIMELINE_BOOKING_AHA_AFTER_RESOURCE_TEXT"),userOptionName:de.AFTER_FIRST_RESOURCE_AHA_OPTION_NAME}}function je(){return this.getSetting("feature")||null}function Xe(){var e;return Boolean((e=babelHelpers.classPrivateFieldLooseBase(this,Ie)[Ie]())==null?void 0:e.isEnabled)}function Ke(){var e;const t=(e=babelHelpers.classPrivateFieldLooseBase(this,Ie)[Ie]())==null?void 0:e.id;if(t){I.Runtime.loadExtension("ui.info-helper").then((({FeaturePromotersRegistry:e})=>{e.getPromoter({featureId:t}).show()})).catch((e=>{console.error(e)}))}}class Ue extends j{showSlider(){const e=new BX.Crm.Activity.Planner;e.showEdit({TYPE_ID:BX.CrmActivityType.call,OWNER_TYPE_ID:this.getEntityTypeId(),OWNER_ID:this.getEntityId()})}supportsLayout(){return false}}class $e extends j{initializeLayout(){this._ownerTypeId=this.getEntityTypeId();this._ownerId=this.getEntityId();this._ownerCategoryId=this.getEntityCategoryId();this._ghostInput=null;this._saveButtonHandler=BX.delegate(this.onSaveButtonClick,this);this._cancelButtonHandler=BX.delegate(this.onCancelButtonClick,this);this._focusHandler=BX.delegate(this.onFocus,this);this._blurHandler=BX.delegate(this.onBlur,this);this._keyupHandler=BX.delegate(this.resizeForm,this);this._delayedKeyupHandler=BX.delegate((function(){setTimeout(this.resizeForm.bind(this),0)}),this);this._hideButtonsOnBlur=true;this.bindInputHandlers();this.doInitialize()}doInitialize(){}bindInputHandlers(){BX.bind(this._input,"focus",this._focusHandler);BX.bind(this._input,"blur",this._blurHandler);BX.bind(this._input,"keyup",this._keyupHandler);BX.bind(this._input,"cut",this._delayedKeyupHandler);BX.bind(this._input,"paste",this._delayedKeyupHandler)}onFocus(e){this.setFocused(true)}onBlur(e){if(!this._hideButtonsOnBlur){return}if(this._input.value===""){window.setTimeout(BX.delegate((function(){this.setFocused(false);this._input.style.minHeight=""}),this),200)}}onSaveButtonClick(e){this.setLocked(true);const t=this.save();if(t instanceof BX.Promise||t instanceof Promise){t.then((()=>this.setLocked(false)),(()=>this.setLocked(false))).catch((()=>this.setLocked(false)))}else{this.setLocked(false)}}onCancelButtonClick(){this.cancel();this.emitFinishEditEvent()}save(){}cancel(){}release(){if(this._ghostInput){this._ghostInput=BX.remove(this._ghostInput)}}ensureGhostCreated(){if(this._ghostInput){return this._ghostInput}this._ghostInput=BX.create("div",{props:{className:"crm-entity-stream-content-new-comment-textarea-shadow"},text:this._input.value});this._ghostInput.style.width=this._input.offsetWidth+"px";document.body.appendChild(this._ghostInput);return this._ghostInput}resizeForm(){const e=this.ensureGhostCreated();const t=getComputedStyle(this._input);const s=parseInt(t.paddingBottom)+parseInt(t.paddingTop)+parseInt(t.borderTopWidth)+parseInt(t.borderBottomWidth)||0;e.innerHTML=BX.util.htmlspecialchars(this._input.value.replace(/[\r\n]{1}/g,"<br>"));this._input.style.minHeight=e.scrollHeight+s+"px"}}let Ge=e=>e,Ve,We,ze,qe;class Ye extends $e{createLayout(){this._saveButton=I.Tag.render(Ve||(Ve=Ge`<button onclick="${0}" class="ui-btn ui-btn-xs ui-btn-primary ui-btn-round" >${0}</button>`),this.onSaveButtonClick.bind(this),I.Loc.getMessage("CRM_TIMELINE_SEND"));this._cancelButton=I.Tag.render(We||(We=Ge`<span onclick="${0}"  class="ui-btn ui-btn-xs ui-btn-link">${0}</span>`),this.onCancelButtonClick.bind(this),I.Loc.getMessage("CRM_TIMELINE_CANCEL_BTN"));this._input=I.Tag.render(ze||(ze=Ge`<textarea  rows="1" class="crm-entity-stream-content-new-comment-textarea" placeholder="${0}"></textarea>`),I.Loc.getMessage("CRM_TIMELINE_COMMENT_PLACEHOLDER"));return I.Tag.render(qe||(qe=Ge`<div class="crm-entity-stream-content-new-detail --hidden">
					${0}
					<div class="crm-entity-stream-content-new-comment-btn-container">
						${0}
						${0}
					</div>
				</div>`),this._input,this._saveButton,this._cancelButton)}doInitialize(){this._postForm=null;this._editor=null;this._isRequestRunning=false;this._isLocked=false;BX.unbind(this._input,"blur",this._blurHandler);BX.unbind(this._input,"keyup",this._keyupHandler)}loadEditor(){this._editorName="CrmTimeLineComment0";if(this._postForm)return;BX.ajax.runAction("crm.api.timeline.loadEditor",{data:{name:this._editorName}}).then(this.onLoadEditorSuccess.bind(this))}onLoadEditorSuccess(e){const t=BX.prop.getString(BX.prop.getObject(e,"data",{}),"html","");BX.html(this._editorContainer,t).then(BX.delegate(this.showEditor,this)).then(BX.delegate(this.addEvents,this))}addEvents(){BX.addCustomEvent(this._editorContainer.firstElementChild,"onFileIsAppended",BX.delegate((function(e,t){BX.addClass(this._saveButton,"ui-btn-disabled");BX.addClass(this._saveButton,"ui-btn-clock");this._saveButton.removeEventListener("click",this._saveButtonHandler)}),this));BX.addCustomEvent(this._editorContainer.firstElementChild,"onFileIsAdded",BX.delegate((function(e,t,s,i){BX.removeClass(this._saveButton,"ui-btn-clock");BX.removeClass(this._saveButton,"ui-btn-disabled");this._saveButton.addEventListener("click",this._saveButtonHandler)}),this))}showEditor(){if(LHEPostForm){window.setTimeout(BX.delegate((function(){this._postForm=LHEPostForm.getHandler(this._editorName);this._editor=BXHtmlEditor.Get(this._editorName);BX.onCustomEvent(this._postForm.eventNode,"OnShowLHE",[true])}),this),100)}}onFocus(e){this._input.style.display="none";if(this._editor&&this._postForm){this._postForm.eventNode.style.display="block";this._editor.Focus()}else{if(!BX.type.isDomNode(this._editorContainer)){this._editorContainer=BX.create("div",{attrs:{className:"crm-entity-stream-section-comment-editor"}});this._editorContainer.appendChild(BX.create("DIV",{attrs:{className:"crm-timeline-wait"}}));this.getContainer().appendChild(this._editorContainer)}window.setTimeout(BX.delegate((function(){this.loadEditor()}),this),100)}this.setFocused(true)}save(){let e="";const t=[];const s={};if(this._postForm){e=this._postForm.oEditor.GetContent();this._postForm.eventNode.querySelectorAll('input[name="UF_CRM_COMMENT_FILES[]"]').forEach((e=>t.push(e.value)));if(I.Type.isArrayFilled(t)){t.forEach((e=>{const t=`input[name="CRM_TIMELINE_DISK_ATTACHED_OBJECT_ALLOW_EDIT[${e}]"`;const i=this._postForm.eventNode.querySelector(t);if(i){s[e]=i.value}}))}}else{e=this._input.value}if(e===""){if(!this.emptyCommentMessage){this.emptyCommentMessage=new BX.PopupWindow("timeline_empty_new_comment_"+this.getEntityId(),this._saveButton,{content:BX.message("CRM_TIMELINE_EMPTY_COMMENT_MESSAGE"),darkMode:true,autoHide:true,zIndex:990,angle:{position:"top",offset:77},closeByEsc:true,bindOptions:{forceBindPosition:true}})}this.emptyCommentMessage.show();return}if(this._isRequestRunning||this._isLocked){return}this._isRequestRunning=this._isLocked=true;const i={fields:{ENTITY_ID:this.getEntityId(),ENTITY_TYPE_ID:this.getEntityTypeId(),COMMENT:e,ATTACHMENTS:t}};if(Object.keys(s).length>0){i.CRM_TIMELINE_DISK_ATTACHED_OBJECT_ALLOW_EDIT=s}return I.ajax.runAction("crm.timeline.comment.add",{data:i}).then((e=>{this.onSaveSuccess();return e})).catch((e=>{this.onSaveFailure();return e}))}cancel(){this._input.value="";this._input.style.minHeight="";if(BX.type.isDomNode(this._editorContainer))this._postForm.eventNode.style.display="none";this._input.style.display="block";this.setFocused(false);this.release()}onSaveSuccess(e){this._isRequestRunning=false;this._isLocked=false;this.release();if(this._postForm){this._postForm.reinit("",{})}this.emitFinishEditEvent();this.cancel()}onSaveFailure(){this._isRequestRunning=this._isLocked=false}}class Je extends j{showSlider(){BX.CrmActivityEditor.getDefault().addDelivery({ownerType:BX.CrmEntityType.resolveName(this.getEntityTypeId()),ownerID:this.getEntityId(),orderList:BX.CrmTimelineManager.getDefault().getOwnerInfo()["ORDER_LIST"]})}supportsLayout(){return false}}var Ze=babelHelpers.classPrivateFieldLooseKey("einvoiceUrl");class Qe extends j{constructor(...e){super(...e);Object.defineProperty(this,Ze,{writable:true,value:void 0})}showSlider(){f.SidePanel.Instance.open(babelHelpers.classPrivateFieldLooseBase(this,Ze)[Ze],{width:575,allowChangeHistory:false})}supportsLayout(){return false}initializeSettings(){babelHelpers.classPrivateFieldLooseBase(this,Ze)[Ze]=this.getSetting("einvoiceUrl")}}class et extends j{showSlider(){const e=BX.CrmTimelineManager.getDefault().getOwnerInfo();BX.CrmActivityEditor.getDefault().addEmail({ownerType:BX.CrmEntityType.resolveName(this.getEntityTypeId()),ownerID:this.getEntityId(),ownerUrl:e["SHOW_URL"],ownerTitle:e["TITLE"],subject:""})}supportsLayout(){return false}}const tt=new Map([["whatsapp",{id:"whatsapp",connectorId:"notifications",connectLabel:I.Loc.getMessage("CRM_TIMELINE_GOTOCHAT_CONNECT_WHATSAPP"),inviteLabel:I.Loc.getMessage("CRM_TIMELINE_GOTOCHAT_INVITE_WHATSAPP"),soonLabel:I.Loc.getMessage("CRM_TIMELINE_GOTOCHAT_SOON_WHATSAPP"),title:I.Loc.getMessage("CRM_TIMELINE_GOTOCHAT_SERVICE_WHATSAPP"),region:"!ru",commonClass:"--whatsapp",iconClass:n.Social.WHATSAPP,checkServiceId:"virtual_whatsapp"}],["telegrambot",{id:"telegrambot",connectorId:"telegrambot",connectLabel:I.Loc.getMessage("CRM_TIMELINE_GOTOCHAT_CONNECT_TELEGRAM"),inviteLabel:I.Loc.getMessage("CRM_TIMELINE_GOTOCHAT_INVITE_TELEGRAM"),title:I.Loc.getMessage("CRM_TIMELINE_GOTOCHAT_SERVICE_TELEGRAM"),commonClass:"--telegram",iconClass:n.Social.TELEGRAM_IN_CIRCLE,iconColor:"#2FC6F6"}],["ru-whatsapp",{id:"ru-whatsapp",connectorId:"notifications",connectLabel:I.Loc.getMessage("CRM_TIMELINE_GOTOCHAT_CONNECT_WHATSAPP"),disabledLabel:I.Loc.getMessage("CRM_TIMELINE_GOTOCHAT_INVITE_WHATSAPP"),inviteLabel:I.Loc.getMessage("CRM_TIMELINE_GOTOCHAT_INVITE_WHATSAPP"),soonLabel:I.Loc.getMessage("CRM_TIMELINE_GOTOCHAT_SOON_WHATSAPP"),disabledHint:I.Loc.getMessage("CRM_TIMELINE_GOTOCHAT_WHATSAPP_DISABLED_HINT"),title:I.Loc.getMessage("CRM_TIMELINE_GOTOCHAT_SERVICE_WHATSAPP"),region:"ru",commonClass:"--whatsapp",iconClass:n.Social.WHATSAPP,checkServiceId:"virtual_whatsapp",hideOnBox:true}],["facebook",{id:"facebook",connectorId:"",connectLabel:I.Loc.getMessage("CRM_TIMELINE_GOTOCHAT_CONNECT_FACEBOOK"),inviteLabel:I.Loc.getMessage("CRM_TIMELINE_GOTOCHAT_INVITE_FACEBOOK"),soonLabel:I.Loc.getMessage("CRM_TIMELINE_GOTOCHAT_SOON_FACEBOOK"),title:I.Loc.getMessage("CRM_TIMELINE_GOTOCHAT_SERVICE_FACEBOOK"),region:"!ru",commonClass:"--facebook",iconClass:n.Social.FACEBOOK}]]);let st=e=>e,it,at,lt,nt,rt,ot,ct;const dt="stub";const ht="menu-popup-item-accept";const ut="menu-popup-item-none";const pt="crm-entity-stream-content-gotochat-toolbar-container";const bt="crm-entity-stream-content-gotochat-buttons-container";const vt="crm-entity-stream-content-gotochat-clients-selector-title";const mt="18114500";var gt=babelHelpers.classPrivateFieldLooseKey("context");var yt=babelHelpers.classPrivateFieldLooseKey("chatServiceButtons");var Lt=babelHelpers.classPrivateFieldLooseKey("region");var ft=babelHelpers.classPrivateFieldLooseKey("isBox");var Pt=babelHelpers.classPrivateFieldLooseKey("entityEditor");var _t=babelHelpers.classPrivateFieldLooseKey("userSelectorDialog");var Bt=babelHelpers.classPrivateFieldLooseKey("clientSelector");var Et=babelHelpers.classPrivateFieldLooseKey("services");var Tt=babelHelpers.classPrivateFieldLooseKey("subscribeToReceiversChanges");var It=babelHelpers.classPrivateFieldLooseKey("fetchConfig");var Ct=babelHelpers.classPrivateFieldLooseKey("prepareParams");var Ft=babelHelpers.classPrivateFieldLooseKey("setCommunicationsParams");var St=babelHelpers.classPrivateFieldLooseKey("setChannelDefaultPhoneId");var Ht=babelHelpers.classPrivateFieldLooseKey("getCurrentChannel");var Ot=babelHelpers.classPrivateFieldLooseKey("getClientTitleHtmlElement");var Mt=babelHelpers.classPrivateFieldLooseKey("getUserSelectorDialogTargetNode");var Nt=babelHelpers.classPrivateFieldLooseKey("getClientSelectorEntities");var wt=babelHelpers.classPrivateFieldLooseKey("bindClient");var At=babelHelpers.classPrivateFieldLooseKey("getOwnerEntity");var Rt=babelHelpers.classPrivateFieldLooseKey("showHelp");var Dt=babelHelpers.classPrivateFieldLooseKey("showSettingsMenu");var kt=babelHelpers.classPrivateFieldLooseKey("getSubmenuStubItems");var xt=babelHelpers.classPrivateFieldLooseKey("onSubMenuShow");var jt=babelHelpers.classPrivateFieldLooseKey("adjustClientTitle");var Xt=babelHelpers.classPrivateFieldLooseKey("showContent");var Kt=babelHelpers.classPrivateFieldLooseKey("showAddClientTitle");var Ut=babelHelpers.classPrivateFieldLooseKey("hideContent");var $t=babelHelpers.classPrivateFieldLooseKey("removeCurrentClient");var Gt=babelHelpers.classPrivateFieldLooseKey("adjustChatServiceButtons");var Vt=babelHelpers.classPrivateFieldLooseKey("getServiceButtons");var Wt=babelHelpers.classPrivateFieldLooseKey("fillChatServiceButtons");var zt=babelHelpers.classPrivateFieldLooseKey("isServiceSupportedInRegion");var qt=babelHelpers.classPrivateFieldLooseKey("createChatServiceButton");var Yt=babelHelpers.classPrivateFieldLooseKey("renderButtonIcon");var Jt=babelHelpers.classPrivateFieldLooseKey("getButtonIconColor");var Zt=babelHelpers.classPrivateFieldLooseKey("isServiceSelected");var Qt=babelHelpers.classPrivateFieldLooseKey("getServiceConfigByCode");var es=babelHelpers.classPrivateFieldLooseKey("isAvailableService");var ts=babelHelpers.classPrivateFieldLooseKey("isEntityInEditorMode");var ss=babelHelpers.classPrivateFieldLooseKey("showEditorInEditModePopup");var is=babelHelpers.classPrivateFieldLooseKey("getEntityEditor");var as=babelHelpers.classPrivateFieldLooseKey("showNotSelectedClientNotify");var ls=babelHelpers.classPrivateFieldLooseKey("showNotify");var ns=babelHelpers.classPrivateFieldLooseKey("setOpenLineItemIsSelected");var rs=babelHelpers.classPrivateFieldLooseKey("getServiceById");var os=babelHelpers.classPrivateFieldLooseKey("restoreButton");var cs=babelHelpers.classPrivateFieldLooseKey("getChannelById");var ds=babelHelpers.classPrivateFieldLooseKey("refreshSettingsMenu");var hs=babelHelpers.classPrivateFieldLooseKey("getLoader");var us=babelHelpers.classPrivateFieldLooseKey("hideLoader");class ps extends j{constructor(...e){super(...e);Object.defineProperty(this,us,{value:ti});Object.defineProperty(this,hs,{value:ei});Object.defineProperty(this,ds,{value:Qs});Object.defineProperty(this,cs,{value:Zs});Object.defineProperty(this,os,{value:Js});Object.defineProperty(this,rs,{value:Ys});Object.defineProperty(this,ns,{value:qs});Object.defineProperty(this,ls,{value:zs});Object.defineProperty(this,as,{value:Ws});Object.defineProperty(this,is,{value:Vs});Object.defineProperty(this,ss,{value:Gs});Object.defineProperty(this,ts,{value:$s});Object.defineProperty(this,es,{value:Us});Object.defineProperty(this,Qt,{value:Ks});Object.defineProperty(this,Zt,{value:Xs});Object.defineProperty(this,Jt,{value:js});Object.defineProperty(this,Yt,{value:xs});Object.defineProperty(this,qt,{value:ks});Object.defineProperty(this,zt,{value:Ds});Object.defineProperty(this,Wt,{value:Rs});Object.defineProperty(this,Vt,{value:As});Object.defineProperty(this,Gt,{value:ws});Object.defineProperty(this,$t,{value:Ns});Object.defineProperty(this,Ut,{value:Ms});Object.defineProperty(this,Kt,{value:Os});Object.defineProperty(this,Xt,{value:Hs});Object.defineProperty(this,jt,{value:Ss});Object.defineProperty(this,xt,{value:Fs});Object.defineProperty(this,kt,{value:Cs});Object.defineProperty(this,Dt,{value:Is});Object.defineProperty(this,Rt,{value:Ts});Object.defineProperty(this,At,{value:Es});Object.defineProperty(this,wt,{value:Bs});Object.defineProperty(this,Nt,{value:_s});Object.defineProperty(this,Mt,{value:Ps});Object.defineProperty(this,Ot,{value:fs});Object.defineProperty(this,Ht,{value:Ls});Object.defineProperty(this,St,{value:ys});Object.defineProperty(this,Ft,{value:gs});Object.defineProperty(this,Ct,{value:ms});Object.defineProperty(this,It,{value:vs});Object.defineProperty(this,Tt,{value:bs});Object.defineProperty(this,gt,{writable:true,value:null});this.selectedClient=null;this.settingsMenu=null;this.channels=[];this.communications=[];this.currentChannelId=null;this.fromPhoneId=null;this.toName=null;this.toPhoneId=null;this.openLineItems=null;this.hasClients=false;this.isFetchedConfig=false;this.isSending=false;Object.defineProperty(this,yt,{writable:true,value:new Map});Object.defineProperty(this,Lt,{writable:true,value:null});Object.defineProperty(this,ft,{writable:true,value:null});Object.defineProperty(this,Pt,{writable:true,value:null});this.marketplaceUrl="";Object.defineProperty(this,_t,{writable:true,value:null});Object.defineProperty(this,Bt,{writable:true,value:null});Object.defineProperty(this,Et,{writable:true,value:{}})}initialize(e,t){super.initialize(e,t);babelHelpers.classPrivateFieldLooseBase(this,gt)[gt]=e;this.onSelectClient=this.onSelectClient.bind(this);this.onSelectClientPhone=this.onSelectClientPhone.bind(this);this.onSelectSender=this.onSelectSender.bind(this);this.onSelectSenderPhone=this.onSelectSenderPhone.bind(this);this.onSelectTelegramOpenLineId=this.onSelectTelegramOpenLineId.bind(this)}initializeLayout(){super.initializeLayout();babelHelpers.classPrivateFieldLooseBase(this,Tt)[Tt]()}initializeSettings(){babelHelpers.classPrivateFieldLooseBase(this,Lt)[Lt]=this.getSetting("region");babelHelpers.classPrivateFieldLooseBase(this,ft)[ft]=this.getSetting("isBox")}activate(){super.activate();babelHelpers.classPrivateFieldLooseBase(this,It)[It]()}createLayout(){for(const e of this.getSetting("tours",[])){if(I.Type.isStringFilled(e)){I.Runtime.html(null,e)}}return I.Tag.render(it||(it=st`<div class="crm-entity-stream-content-new-detail crm-entity-stream-content-new-detail-gotochat --hidden --skeleton">
			<div class="crm-entity-stream-content-new-detail-gotochat-container hidden">
				<div class="crm-entity-stream-content-gotochat-settings-container">
					<div class="crm-entity-stream-content-gotochat-clients-selector-container">
						<div class="${0}">
							${0}
						</div>
						<div class="crm-entity-stream-content-gotochat-clients-selector-description">
							${0}
						</div>
					</div>
					<div class="${0}">
						<button 
							class="ui-btn ui-btn-link ui-btn-xs ui-btn-icon-help"
							onclick="${0}"
						></button>
						<button
							class="ui-btn ui-btn-link ui-btn-xs ui-btn-icon-setting"
							onclick="${0}"
						></button>
					</div>
				</div>
				${0}
			</div>
		</div>`),vt,babelHelpers.classPrivateFieldLooseBase(this,Ot)[Ot](),I.Loc.getMessage("CRM_TIMELINE_GOTOCHAT_CLIENT_SELECTOR_DESCRIPTION"),pt,babelHelpers.classPrivateFieldLooseBase(this,Rt)[Rt],babelHelpers.classPrivateFieldLooseBase(this,Dt)[Dt].bind(this),babelHelpers.classPrivateFieldLooseBase(this,Vt)[Vt]())}onToggleClientSelector(){const e="client-selector-dialog";const{entityTypeId:t}=babelHelpers.classPrivateFieldLooseBase(this,At)[At]();const s=`CRM_TIMELINE_GOTOCHAT-${t}`;if(!babelHelpers.classPrivateFieldLooseBase(this,_t)[_t]){babelHelpers.classPrivateFieldLooseBase(this,_t)[_t]=new y.Dialog({id:e,context:s,targetNode:babelHelpers.classPrivateFieldLooseBase(this,Mt)[Mt](),multiple:false,dropdownMode:false,showAvatars:true,enableSearch:true,width:450,zIndex:2500,entities:babelHelpers.classPrivateFieldLooseBase(this,Nt)[Nt](),events:{"Item:onSelect":this.onSelectClient}})}if(babelHelpers.classPrivateFieldLooseBase(this,_t)[_t].isOpen()){babelHelpers.classPrivateFieldLooseBase(this,_t)[_t].hide()}else{babelHelpers.classPrivateFieldLooseBase(this,_t)[_t].setTargetNode(babelHelpers.classPrivateFieldLooseBase(this,Mt)[Mt]());babelHelpers.classPrivateFieldLooseBase(this,_t)[_t].show()}}async onSelectClient(e){const{item:t}=e.getData();this.selectedClient={entityId:t.id,entityTypeId:BX.CrmEntityType.resolveId(t.entityId)};const s=await babelHelpers.classPrivateFieldLooseBase(this,wt)[wt]();if(s){this.adjustLayout();BX.Crm.EntityEditor.getDefault().reload()}}initSettingsMenu(){var e;const t="crm-gotochat-channels-settings-menu";const s=babelHelpers.classPrivateFieldLooseBase(this,kt)[kt]();this.settingsMenu=P.MenuManager.create({id:t,bindElement:document.querySelector(`.${pt}`),items:[{delimiter:true,text:I.Loc.getMessage("CRM_TIMELINE_GOTOCHAT_SETTINGS")},{id:"channelSubmenu",text:I.Loc.getMessage("CRM_TIMELINE_GOTOCHAT_SENDER_SELECTOR"),items:s,events:{onSubMenuShow:e=>{babelHelpers.classPrivateFieldLooseBase(this,xt)[xt](e,this.getChannelsSubmenuItems())}}},{id:"phoneSubmenu",text:I.Loc.getMessage("CRM_TIMELINE_GOTOCHAT_NUMBER_SELECTOR"),items:s,disabled:!I.Type.isArrayFilled(this.getPhoneSubMenuItems()),events:{onSubMenuShow:e=>{babelHelpers.classPrivateFieldLooseBase(this,xt)[xt](e,this.getPhoneSubMenuItems())}}},{delimiter:true,text:I.Loc.getMessage("CRM_TIMELINE_GOTOCHAT_CONNECTOR_SETTINGS")},{id:"telegramBotSubmenu",text:I.Loc.getMessage("CRM_TIMELINE_GOTOCHAT_TELEGRAMBOT_OPENLINE_SELECTOR"),items:s,disabled:!((e=this.openLineItems.telegrambot)!=null&&e.selected),events:{onSubMenuShow:e=>{babelHelpers.classPrivateFieldLooseBase(this,xt)[xt](e,this.getTelegramOpenLinesSubMenuItems())}}}]})}onShowClientPhoneSelector(){const e=document.getElementById("crm-gotochat-client-selector--selected");if(babelHelpers.classPrivateFieldLooseBase(this,Bt)[Bt]&&babelHelpers.classPrivateFieldLooseBase(this,Bt)[Bt].isOpen()){babelHelpers.classPrivateFieldLooseBase(this,Bt)[Bt].hide()}else{babelHelpers.classPrivateFieldLooseBase(this,Bt)[Bt]=r.ClientSelector.createFromCommunications({targetNode:e,communications:this.communications,events:{onSelect:this.onSelectClientPhone}});babelHelpers.classPrivateFieldLooseBase(this,Bt)[Bt].setSelected([this.toPhoneId]).show()}}onSelectClientPhone(e){const{item:{id:t,customData:s}}=e.getData();this.selectedClient={entityId:s.get("entityId"),entityTypeId:s.get("entityTypeId")};this.toName=this.getCurrentCommunication().caption;this.toPhoneId=t;this.adjustLayout()}getCurrentPhone(){const e=this.getCurrentCommunication();if(!e||!I.Type.isObjectLike(e.phones)){return null}return e.phones.find((e=>e.id===this.toPhoneId))}getCurrentCommunication(){if(!this.selectedClient){return null}const{entityTypeId:e,entityId:t}=this.selectedClient;return this.communications.find((s=>Number(s.entityTypeId)===Number(e)&&Number(s.entityId)===Number(t)))}adjustLayout(){babelHelpers.classPrivateFieldLooseBase(this,jt)[jt]();babelHelpers.classPrivateFieldLooseBase(this,Gt)[Gt]();babelHelpers.classPrivateFieldLooseBase(this,Xt)[Xt]()}async showRegistrarAndSend(e){if(this.isSending||!babelHelpers.classPrivateFieldLooseBase(this,es)[es](e)){return}if(babelHelpers.classPrivateFieldLooseBase(this,ts)[ts]()){await babelHelpers.classPrivateFieldLooseBase(this,ss)[ss]()}if(!this.selectedClient&&!this.hasClients){babelHelpers.classPrivateFieldLooseBase(this,as)[as]();return}if(!this.toPhoneId){const e=I.Loc.getMessage("CRM_TIMELINE_GOTOCHAT_CLIENT_HAVE_NO_PHONE");babelHelpers.classPrivateFieldLooseBase(this,ls)[ls](e);return}this.showButtonLoader(e);const t=babelHelpers.classPrivateFieldLooseBase(this,Qt)[Qt](e);const{entityTypeId:s}=babelHelpers.classPrivateFieldLooseBase(this,At)[At]();const i=await h.ConditionChecker.checkAndGetLine({openLineCode:t.connectorId,senderType:this.getSenderType(),openLineItems:this.openLineItems,serviceId:t.id,entityTypeId:s});if(i===null){babelHelpers.classPrivateFieldLooseBase(this,os)[os](e)}else{this.send(i,e)}}saveEntityEditor(){babelHelpers.classPrivateFieldLooseBase(this,is)[is]().saveChanged()}send(e,t){this.isSending=true;const{entityTypeId:s,entityId:i}=babelHelpers.classPrivateFieldLooseBase(this,At)[At]();const a=this.getSenderType();const l=this.currentChannelId;const n=this.fromPhoneId;const r=this.toPhoneId;const o=babelHelpers.classPrivateFieldLooseBase(this,Qt)[Qt](t).connectorId;const c={ownerTypeId:s,ownerId:i,params:{senderType:a,senderId:l,from:n,to:r,lineId:e,connectorId:o}};I.ajax.runAction("crm.activity.gotochat.send",{data:c}).then((()=>{this.isSending=false;babelHelpers.classPrivateFieldLooseBase(this,ns)[ns](t);babelHelpers.classPrivateFieldLooseBase(this,os)[os](t);babelHelpers.classPrivateFieldLooseBase(this,ls)[ls](I.Loc.getMessage("CRM_TIMELINE_GOTOCHAT_SEND_SUCCESS"));this.emitFinishEditEvent()})).catch((e=>{this.isSending=false;babelHelpers.classPrivateFieldLooseBase(this,os)[os](t);if(e.errors.length>0){babelHelpers.classPrivateFieldLooseBase(this,ls)[ls](e.errors[0].message);return}babelHelpers.classPrivateFieldLooseBase(this,ls)[ls](I.Loc.getMessage("CRM_TIMELINE_GOTOCHAT_SEND_ERROR"))}))}showButtonLoader(e){const t=babelHelpers.classPrivateFieldLooseBase(this,yt)[yt].get(e);I.Dom.addClass(t==null?void 0:t.firstElementChild,"--loading")}getSenderType(){return this.currentChannelId===h.Types.bitrix24?h.Types.bitrix24:h.Types.sms}getEntityAvatarPath(e){e=e.toLowerCase();const t=["contact","company","lead"];if(!t.includes(e)){return""}return`/bitrix/images/crm/entity_provider_icons/${e}.svg`}getChannelsSubmenuItems(){const e=[];this.channels.forEach((({id:t,shortName:s,canUse:i,fromList:a})=>{const l=t===this.currentChannelId?ht:ut;e.push({id:t,text:s,className:l,disabled:!i||!I.Type.isArrayFilled(a),onclick:this.onSelectSender})}));return[...e,{id:"connectOtherSenderDelimiter",delimiter:true},{id:"connectOtherSender",text:I.Loc.getMessage("CRM_TIMELINE_GOTOCHAT_CONNECT_OTHER_SENDER_SERVICE"),className:ut,onclick:()=>BX.SidePanel.Instance.open(this.marketplaceUrl)}]}onSelectSender(e,{id:t}){this.currentChannelId=t;const s=babelHelpers.classPrivateFieldLooseBase(this,cs)[cs](t);this.fromPhoneId=s.fromList[0].id;babelHelpers.classPrivateFieldLooseBase(this,ds)[ds]()}getPhoneSubMenuItems(){const e=babelHelpers.classPrivateFieldLooseBase(this,cs)[cs](this.currentChannelId);const t=[];if(e){e.fromList.forEach((({id:e,name:s})=>{const i=e===this.fromPhoneId?ht:ut;t.push({id:e,text:s,className:i,onclick:this.onSelectSenderPhone})}))}return t}getTelegramOpenLinesSubMenuItems(){var e,t;const s=(e=(t=this.openLineItems)==null?void 0:t.telegrambot)!=null?e:{};const i=[];s.list.forEach((({id:e,name:t,selected:s})=>{const a=s?ht:ut;i.push({id:e,text:t,className:a,onclick:this.onSelectTelegramOpenLineId})}));return i}onSelectSenderPhone(e,{id:t}){this.fromPhoneId=t;babelHelpers.classPrivateFieldLooseBase(this,ds)[ds]()}onSelectTelegramOpenLineId(e,{id:t}){var s,i,a;const l=(s=(i=this.openLineItems)==null?void 0:(a=i.telegrambot)==null?void 0:a.list)!=null?s:null;if(l===null){return}const n=l.find((e=>e.selected));if(!n){return}if(n.id===t){return}l.forEach((e=>e.selected=false));l.find((e=>e.id===t)).selected=true;BX.userOptions.save("crm","gotochat-selected-openline-ids","telegrambot",t);babelHelpers.classPrivateFieldLooseBase(this,ds)[ds]()}onHide(){if(this.loader){this.loader.destroy()}}}function bs(){E.EventEmitter.subscribe("BX.Crm.MessageSender.ReceiverRepository:OnReceiversChanged",(e=>{const{item:t}=e.getData();if(this.getEntityTypeId()!==(t==null?void 0:t.entityTypeId)||this.getEntityId()!==(t==null?void 0:t.entityId)){return}babelHelpers.classPrivateFieldLooseBase(this,Ut)[Ut]();babelHelpers.classPrivateFieldLooseBase(this,$t)[$t]();babelHelpers.classPrivateFieldLooseBase(this,It)[It](true)}))}function vs(e=false){if(this.isFetchedConfig&&!e){return}this.isFetchedConfig=false;if(!babelHelpers.classPrivateFieldLooseBase(this,gt)[gt].getEntityId()){return}const t={entityTypeId:babelHelpers.classPrivateFieldLooseBase(this,gt)[gt].getEntityTypeId(),entityId:babelHelpers.classPrivateFieldLooseBase(this,gt)[gt].getEntityId()};I.ajax.runAction("crm.activity.gotochat.getConfig",{data:t}).then((({data:e})=>{this.isFetchedConfig=true;babelHelpers.classPrivateFieldLooseBase(this,Ct)[Ct](e);babelHelpers.classPrivateFieldLooseBase(this,us)[us]();this.adjustLayout()})).catch((()=>babelHelpers.classPrivateFieldLooseBase(this,ls)[ls](I.Loc.getMessage("CRM_TIMELINE_GOTOCHAT_CONFIG_ERROR"))))}function ms(e){const{currentChannelId:t,channels:s,communications:i,openLineItems:a,marketplaceUrl:l,services:n,hasClients:r}=e;this.currentChannelId=t;this.channels=s;this.communications=i;this.hasClients=r;this.openLineItems=a;this.marketplaceUrl=l;babelHelpers.classPrivateFieldLooseBase(this,Et)[Et]=n;babelHelpers.classPrivateFieldLooseBase(this,Ft)[Ft]();babelHelpers.classPrivateFieldLooseBase(this,St)[St]()}function gs(){if(this.communications.length===0){this.toPhoneId=null;this.selectedClient=null;this.toName=null;return}const e=this.communications[0];if(Array.isArray(e.phones)&&e.phones.length>0){this.toPhoneId=e.phones[0].id}this.selectedClient={entityId:e.entityId,entityTypeId:e.entityTypeId};this.toName=e.caption}function ys(){const e=babelHelpers.classPrivateFieldLooseBase(this,Ht)[Ht]();if(!e||!Array.isArray(e.fromList)||e.fromList.length===0){return}const{fromList:t}=e;const s=t.find((e=>e.default));this.fromPhoneId=s?s.id:t[0].id}function Ls(){const e=this.channels.find((e=>e.id===this.currentChannelId));return e!=null?e:null}function fs(){const e='<span id="crm-gotochat-client-selector" class="crm-entity-stream-content-gotochat-user-selector-link">';const t="</span>";const s=I.Tag.render(at||(at=st`
			<span>
				${0}
			</span>
		`),I.Loc.getMessage("CRM_TIMELINE_GOTOCHAT_CLIENT_SELECTOR_TITLE",{"[client]":e,"[/client]":t}));I.Event.bind(s.childNodes[0],"click",this.onToggleClientSelector.bind(this));return s}function Ps(){return document.getElementById("crm-gotochat-client-selector")}function _s(){const e={id:"contact",dynamicLoad:true,dynamicSearch:true,options:{showTab:true,showPhones:true,showMails:true}};const t={id:"company",dynamicLoad:true,dynamicSearch:true,options:{excludeMyCompany:true,showTab:true,showPhones:true,showMails:true}};const{entityTypeId:s}=babelHelpers.classPrivateFieldLooseBase(this,At)[At]();if(s===BX.CrmEntityType.enumeration.contact){return[t]}if(s===BX.CrmEntityType.enumeration.company){return[e]}return[e,t]}async function Bs(){const{entityId:e,entityTypeId:t}=babelHelpers.classPrivateFieldLooseBase(this,At)[At]();const{entityId:s,entityTypeId:i}=this.selectedClient;const a={entityId:e,entityTypeId:t,clientId:s,clientTypeId:i};return new Promise((e=>{I.ajax.runAction("crm.activity.gotochat.bindClient",{data:a}).then((({data:t})=>{if(!t){e(false)}const{channels:s,communications:i,currentChannelId:a}=t;this.channels=s;this.communications=i;this.currentChannelId=a;babelHelpers.classPrivateFieldLooseBase(this,Ft)[Ft]();babelHelpers.classPrivateFieldLooseBase(this,St)[St]();e(true)})).catch((e=>{if(e.errors.length>0){babelHelpers.classPrivateFieldLooseBase(this,ls)[ls](e.errors[0].message);return}babelHelpers.classPrivateFieldLooseBase(this,ls)[ls](I.Loc.getMessage("CRM_TIMELINE_GOTOCHAT_BIND_CLIENT_ERROR"))}))}))}function Es(){const e=babelHelpers.classPrivateFieldLooseBase(this,gt)[gt];return{entityId:e.getEntityId(),entityTypeId:e.getEntityTypeId()}}function Ts(){top.BX.Helper.show(`redirect=detail&code=${mt}`)}function Is(){if(!this.selectedClient){babelHelpers.classPrivateFieldLooseBase(this,as)[as]();return}if(!this.settingsMenu){this.initSettingsMenu()}this.settingsMenu.show()}function Cs(){return[{id:dt}]}function Fs(e,t){var s;const i=e.getTarget();for(const e of t){var a;(a=i.getSubMenu())==null?void 0:a.addMenuItem(e)}(s=i.getSubMenu())==null?void 0:s.removeMenuItem(dt)}function Ss(){const e=this.getCurrentCommunication();if(!e){babelHelpers.classPrivateFieldLooseBase(this,Xt)[Xt]();babelHelpers.classPrivateFieldLooseBase(this,Kt)[Kt]();return}const t=this.getCurrentPhone();if(!t){babelHelpers.classPrivateFieldLooseBase(this,Xt)[Xt]();babelHelpers.classPrivateFieldLooseBase(this,Kt)[Kt]();return}const s=I.Tag.render(lt||(lt=st`
			<span 
				id="crm-gotochat-client-selector--selected" 
				class="crm-entity-stream-content-gotochat-user-selector-link --selected" 
				onclick="${0}"
			>
				<span 
					class="crm-entity-stream-content-gotochat-client-avatar"
					style="background-image: url('${0}');"
				>
				</span>
				${0}, ${0}
				<span class="crm-entity-stream-content-gotochat-client-chevron"></span>
			</span>
		`),this.onShowClientPhoneSelector.bind(this),this.getEntityAvatarPath(e.entityTypeName.toLowerCase()),I.Text.encode(e.caption),I.Text.encode(t.valueFormatted));const i=I.Tag.render(nt||(nt=st`
			<span>
				${0}
			</span>
		`),I.Loc.getMessage("CRM_TIMELINE_GOTOCHAT_SELECTED_CLIENT_TITLE"));const a=i.firstChild;const l=a.textContent.indexOf("#CLIENT_NAME#");a.nodeValue=a.nodeValue.replace("#CLIENT_NAME#","");I.Dom.insertBefore(s,a.splitText(l));const n=document.querySelector(`.${vt}`);I.Dom.clean(n);I.Dom.append(i,n)}function Hs(){I.Dom.removeClass(document.querySelector(".crm-entity-stream-content-new-detail-gotochat-container"),"hidden");I.Dom.removeClass(document.querySelector(".crm-entity-stream-content-new-detail-gotochat"),"--skeleton")}function Os(){const e=document.querySelector(`.${vt}`);I.Dom.clean(e);I.Dom.append(babelHelpers.classPrivateFieldLooseBase(this,Ot)[Ot](),e)}function Ms(){I.Dom.addClass(document.querySelector(".crm-entity-stream-content-new-detail-gotochat-container"),"hidden");I.Dom.addClass(document.querySelector(".crm-entity-stream-content-new-detail-gotochat"),"--skeleton")}function Ns(){this.selectedClient=null;this.fromPhoneId=null}function ws(){const e=document.querySelector(`.${bt}`);const t=babelHelpers.classPrivateFieldLooseBase(this,Vt)[Vt]();I.Dom.replace(e,t)}function As(){babelHelpers.classPrivateFieldLooseBase(this,Wt)[Wt]();const e=I.Tag.render(rt||(rt=st`
			<div class="${0}">
				${0}
			</div>
		`),bt,[...babelHelpers.classPrivateFieldLooseBase(this,yt)[yt].values()]);BX.UI.Hint.init(e);return e}function Rs(){tt.forEach((e=>{if(!babelHelpers.classPrivateFieldLooseBase(this,zt)[zt](e)){return}if(e.hideOnBox===true&&babelHelpers.classPrivateFieldLooseBase(this,ft)[ft]){return}const t=babelHelpers.classPrivateFieldLooseBase(this,qt)[qt](e);babelHelpers.classPrivateFieldLooseBase(this,yt)[yt].set(e.id,t)}))}function Ds(e){if(!e.region||!babelHelpers.classPrivateFieldLooseBase(this,Lt)[Lt]){return true}if(e.region!==babelHelpers.classPrivateFieldLooseBase(this,Lt)[Lt]&&e.region[0]!=="!"){return false}return e.region!==`!${babelHelpers.classPrivateFieldLooseBase(this,Lt)[Lt]}`}function ks(e){let t=e.commonClass;let s=e.connectLabel;let i=null;if(!babelHelpers.classPrivateFieldLooseBase(this,es)[es](e.id)){t+=" --disabled";s=e.disabledLabel||e.soonLabel;i=e.disabledHint}else if(babelHelpers.classPrivateFieldLooseBase(this,Zt)[Zt](e)){t+=" --ready";s=e.inviteLabel}const a=I.Tag.render(ot||(ot=st`
			<div 
				class="crm-entity-stream-content-gotochat-button"
				onclick="${0}"
			>
				<button 
					class="crm-entity-stream-content-new-detail-gotochat_button ${0}"
					data-code="${0}"
				>
					${0}
					<span class="crm-entity-stream-content-new-detail-gotochat_button-text">${0}</span>
				</button>
			</div>
		`),this.showRegistrarAndSend.bind(this,e.id),t,e.id,babelHelpers.classPrivateFieldLooseBase(this,Yt)[Yt](e),s);if(I.Type.isStringFilled(i)){I.Dom.attr(a,{"data-hint":i,"data-hint-no-icon":"Y","data-hint-center":"Y"})}return a}function xs(e){if(!e){return""}const t=new n.Icon({icon:e.iconClass,size:40,color:babelHelpers.classPrivateFieldLooseBase(this,Jt)[Jt](e)});return I.Tag.render(ct||(ct=st`
			<i class="crm-entity-stream-content-new-detail-gotochat_button-icon">
				${0}
			</i>
		`),t.render())}function js(e){if(!babelHelpers.classPrivateFieldLooseBase(this,es)[es](e.id)){return getComputedStyle(document.body).getPropertyValue("--ui-color-base-40")}if(babelHelpers.classPrivateFieldLooseBase(this,Zt)[Zt](e)){return getComputedStyle(document.body).getPropertyValue("--ui-color-background-primary")}return e.iconColor}function Xs(e){var t,s,i;const a=(t=e.checkServiceId)!=null?t:e.id;return(s=this.openLineItems)==null?void 0:(i=s[a])==null?void 0:i.selected}function Ks(e){return tt.get(e)||null}function Us(e){var t;return(t=babelHelpers.classPrivateFieldLooseBase(this,Et)[Et][e])!=null?t:false}function $s(){return babelHelpers.classPrivateFieldLooseBase(this,is)[is]().getMode()===BX.UI.EntityEditorMode.edit}async function Gs(){const{entityTypeId:e}=babelHelpers.classPrivateFieldLooseBase(this,At)[At]();const t=BX.CrmEntityType.resolveName(e);const s=I.Loc.getMessage(`CRM_TIMELINE_GOTOCHAT_EDITOR_HAVE_UNSAVED_CHANGES_TEXT_${t}`)||I.Loc.getMessage("CRM_TIMELINE_GOTOCHAT_EDITOR_HAVE_UNSAVED_CHANGES_TEXT");return new Promise((e=>{BX.UI.Dialogs.MessageBox.show({modal:true,message:s,buttons:BX.UI.Dialogs.MessageBoxButtons.OK_CANCEL,okCaption:I.Loc.getMessage("CRM_TIMELINE_GOTOCHAT_EDITOR_HAVE_UNSAVED_CHANGES_SAVE_AND_CONTINUE"),onOk:t=>{this.saveEntityEditor();t.close();e()},cancelCaption:I.Loc.getMessage("CRM_TIMELINE_GOTOCHAT_EDITOR_HAVE_UNSAVED_CHANGES_FORCE_CONTINUE"),onCancel:function(t){t.close();e()}})}))}function Vs(){if(!babelHelpers.classPrivateFieldLooseBase(this,Pt)[Pt]){babelHelpers.classPrivateFieldLooseBase(this,Pt)[Pt]=BX.Crm.EntityEditor.getDefault()}return babelHelpers.classPrivateFieldLooseBase(this,Pt)[Pt]}function Ws(){const e=I.Loc.getMessage("CRM_TIMELINE_GOTOCHAT_NO_SELECTED_CLIENT");babelHelpers.classPrivateFieldLooseBase(this,ls)[ls](e)}function zs(e){BX.UI.Notification.Center.notify({content:e})}function qs(e){var t;const s=babelHelpers.classPrivateFieldLooseBase(this,rs)[rs](e);this.openLineItems[(t=s==null?void 0:s.checkServiceId)!=null?t:e].selected=true}function Ys(e){var t;return(t=[...tt.values()].find((t=>t.id===e)))!=null?t:null}function Js(e){const t=babelHelpers.classPrivateFieldLooseBase(this,yt)[yt].get(e);const s=babelHelpers.classPrivateFieldLooseBase(this,qt)[qt](tt.get(e));babelHelpers.classPrivateFieldLooseBase(this,yt)[yt].set(e,s);I.Dom.replace(t,s)}function Zs(e){return this.channels.find((t=>t.id===e))}function Qs(){this.settingsMenu.destroy();this.initSettingsMenu()}function ei(){if(!this.loader){this.loader=new b.Loader({color:"#2fc6f6",size:36})}return this.loader}function ti(){if(this.loader){void this.loader.hide()}}var si=babelHelpers.classPrivateFieldLooseKey("fireUpdateEvent");class ii extends j{constructor(...e){super(...e);Object.defineProperty(this,si,{value:ai})}showSlider(){BX.rest.Marketplace.open({PLACEMENT:this.getSetting("placement","")});top.BX.addCustomEvent(top,"Rest:AppLayout:ApplicationInstall",babelHelpers.classPrivateFieldLooseBase(this,si)[si].bind(this))}supportsLayout(){return false}}function ai(){const e=this.getEntityTypeId();const t=this.getEntityId();setTimeout((function(){console.log("fireUpdate",t,e);BX.Crm.EntityEvent.fire(BX.Crm.EntityEvent.names.invalidate,e,t,"")}),3e3)}class li extends j{showSlider(){const e=new BX.Crm.Activity.Planner;e.showEdit({TYPE_ID:BX.CrmActivityType.meeting,OWNER_TYPE_ID:this.getEntityTypeId(),OWNER_ID:this.getEntityId()})}supportsLayout(){return false}}class ni{}ni.PRIMARY="primary";ni.SECONDARY="secondary";class ri{}ri.LAYOUT_JS_EVENT="layoutEvent";ri.FOOTER_BUTTON_CLICK="footerButtonClick";ri.OPEN_REST_APP="openRestApp";ri.REDIRECT="redirect";class oi{}oi.FOOTER_BUTTON_CLICK="footerButtonClick";oi.LAYOUT_EVENT="layoutEvent";oi.VALUE_CHANGED_EVENT="valueChangedEvent";var ci=babelHelpers.classPrivateFieldLooseKey("type");var di=babelHelpers.classPrivateFieldLooseKey("value");var hi=babelHelpers.classPrivateFieldLooseKey("sliderParams");class ui{constructor(e){var t,s;Object.defineProperty(this,ci,{writable:true,value:null});Object.defineProperty(this,di,{writable:true,value:null});Object.defineProperty(this,hi,{writable:true,value:null});babelHelpers.classPrivateFieldLooseBase(this,ci)[ci]=e.type;babelHelpers.classPrivateFieldLooseBase(this,di)[di]=(t=e.value)!=null?t:null;babelHelpers.classPrivateFieldLooseBase(this,hi)[hi]=(s=e.sliderParams)!=null?s:null}execute(e){return new Promise(((t,s)=>{if(this.isLayoutJsEvent()){var i,a;e.$Bitrix.eventEmitter.emit(vi,{event:oi.LAYOUT_EVENT,value:{id:(i=e.$parent)!=null&&i.getIdByComponentInstance?(a=e.$parent)==null?void 0:a.getIdByComponentInstance(e):null,value:babelHelpers.classPrivateFieldLooseBase(this,di)[di]}});t(true)}else if(this.isOpenRestApp()){var l,n,r,o,c,d,h,u,p,b,v,m;const t={...I.Type.isPlainObject(babelHelpers.classPrivateFieldLooseBase(this,di)[di])?babelHelpers.classPrivateFieldLooseBase(this,di)[di]:{value:`${babelHelpers.classPrivateFieldLooseBase(this,di)[di]}`}};const s=e.$root.getAppId();if(I.Type.isStringFilled((l=(n=babelHelpers.classPrivateFieldLooseBase(this,hi)[hi])==null?void 0:n.title)!=null?l:null)){t.bx24_title=babelHelpers.classPrivateFieldLooseBase(this,hi)[hi].title}if(I.Type.isNumber((r=(o=babelHelpers.classPrivateFieldLooseBase(this,hi)[hi])==null?void 0:o.width)!=null?r:null)){t.bx24_width=babelHelpers.classPrivateFieldLooseBase(this,hi)[hi].width}if(I.Type.isNumber((c=(d=babelHelpers.classPrivateFieldLooseBase(this,hi)[hi])==null?void 0:d.leftBoundary)!=null?c:null)){t.bx24_leftBoundary=babelHelpers.classPrivateFieldLooseBase(this,hi)[hi].leftBoundary}const i={};if(I.Type.isStringFilled((h=(u=babelHelpers.classPrivateFieldLooseBase(this,hi)[hi])==null?void 0:u.labelBgColor)!=null?h:null)){i.bgColor=babelHelpers.classPrivateFieldLooseBase(this,hi)[hi].labelBgColor}if(I.Type.isStringFilled((p=(b=babelHelpers.classPrivateFieldLooseBase(this,hi)[hi])==null?void 0:b.labelColor)!=null?p:null)){i.color=babelHelpers.classPrivateFieldLooseBase(this,hi)[hi].labelColor}if(I.Type.isStringFilled((v=(m=babelHelpers.classPrivateFieldLooseBase(this,hi)[hi])==null?void 0:m.labelText)!=null?v:null)){i.text=babelHelpers.classPrivateFieldLooseBase(this,hi)[hi].labelText}if(Object.keys(i).length>0){t.bx24_label=i}if(BX.rest&&BX.rest.AppLayout){BX.rest.AppLayout.openApplication(s,t)}}else if(this.isRedirect()){const e={href:babelHelpers.classPrivateFieldLooseBase(this,di)[di]};const s=I.Dom.create("a",{attrs:e,text:"",style:{display:"none"}});I.Dom.append(s,document.body);s.click();setTimeout((()=>I.Dom.remove(s)),10);t(babelHelpers.classPrivateFieldLooseBase(this,di)[di])}else if(this.isFooterButtonClick()){e.$Bitrix.eventEmitter.emit(vi,{event:oi.FOOTER_BUTTON_CLICK,value:babelHelpers.classPrivateFieldLooseBase(this,di)[di]});t(true)}else{s(false)}}))}isFooterButtonClick(){return babelHelpers.classPrivateFieldLooseBase(this,ci)[ci]===ri.FOOTER_BUTTON_CLICK}isLayoutJsEvent(){return babelHelpers.classPrivateFieldLooseBase(this,ci)[ci]===ri.LAYOUT_JS_EVENT}isOpenRestApp(){return babelHelpers.classPrivateFieldLooseBase(this,ci)[ci]===ri.OPEN_REST_APP}isRedirect(){return babelHelpers.classPrivateFieldLooseBase(this,ci)[ci]===ri.REDIRECT}getValue(){return babelHelpers.classPrivateFieldLooseBase(this,di)[di]}}class pi{}pi.DEFAULT="";pi.LOADING="loading";pi.DISABLED="disabled";var bi={props:{id:{type:String,required:false,default:""},title:{type:String,required:false,default:""},state:{type:String,required:false,default:pi.DEFAULT},type:{type:String,required:false,default:ni.SECONDARY},action:Object},data(){return{uiButton:Object.freeze(null)}},computed:{buttonContainerRef(){return this.$refs.buttonContainer},itemStateToButtonStateDict(){return{[pi.LOADING]:u.Button.State.WAITING,[pi.DISABLED]:u.Button.State.DISABLED}},itemTypeToButtonColorDict(){return{[ni.PRIMARY]:u.Button.Color.PRIMARY,[ni.SECONDARY]:u.Button.Color.LINK}},className(){var e,t;return[u.Button.BASE_CLASS,(e=this.itemTypeToButtonColorDict[this.type])!=null?e:u.Button.Color.LINK,u.Button.Size.EXTRA_SMALL,u.Button.Style.ROUND,(t=this.itemStateToButtonStateDict[this.state])!=null?t:""]}},methods:{executeAction(){if(this.action&&![pi.LOADING,pi.DISABLED].includes(this.state)){const e=new ui(this.action);e.execute(this)}}},template:`\n\t\t<button :class="className" @click="executeAction">{{ title }}</button>\n\t`};const vi="crm:activityplacement:item:action";const mi={components:{Button:bi},props:{id:String,appId:String,onAction:Function},data(){var e,t;return{layout:{},loader:Object.freeze(null),isLoading:true,primaryButtonParams:this.getButtonParams(ni.PRIMARY,null,(e=this.layout)==null?void 0:e.primaryButton),secondaryButtonParams:this.getButtonParams(ni.SECONDARY,null,(t=this.layout)==null?void 0:t.secondaryButton),primaryButtonAction:Object.freeze({type:ri.FOOTER_BUTTON_CLICK,value:ni.PRIMARY}),secondaryButtonAction:Object.freeze({type:ri.FOOTER_BUTTON_CLICK,value:ni.SECONDARY})}},created(){this.$Bitrix.eventEmitter.subscribe(vi,this.onActionEvent)},mounted(){this.showLoader(true)},beforeUnmount(){this.$Bitrix.eventEmitter.unsubscribe(vi,this.onActionEvent)},watch:{layout(e){this.primaryButtonParams=this.getButtonParams(ni.PRIMARY,this.primaryButtonParams,e.primaryButton);this.secondaryButtonParams=this.getButtonParams(ni.SECONDARY,this.secondaryButtonParams,e.secondaryButton)}},methods:{setLayout(e){this.layout=e;this.$Bitrix.eventEmitter.emit("layout:updated")},showLoader(e){if(e){if(!this.loader){this.loader=new b.Loader({size:50})}this.loader.show(this.$refs.loader)}else if(this.loader){this.loader.hide()}this.isLoading=e},setLayoutItemState(e,t,s,i){if(this.$refs.blocks.setLayoutItemState(e,t,s)){this.$nextTick(i({result:"success"}))}else{this.$nextTick(i({result:"error",errors:["item not found"]}))}},setButtonState(e,t,s){switch(e){case ni.PRIMARY:this.primaryButtonParams=this.getButtonParams(ni.PRIMARY,this.primaryButtonParams,t);break;case ni.SECONDARY:this.secondaryButtonParams=this.getButtonParams(ni.SECONDARY,this.secondaryButtonParams,t);break}this.$nextTick(s({result:"success"}))},getButtonParams(e,t,s){if(I.Type.isNull(s)){return null}return{...t,...s,type:e}},getAppId(){return this.appId},onActionEvent(e){const t=e.getData();this.onAction(I.Runtime.clone(t))}},computed:{hasPrimaryButton(){return Boolean(this.primaryButtonParams)},hasSecondaryButton(){return Boolean(this.secondaryButtonParams)}},template:`\n\t\t<div class="crm-entity-stream-restapp-loader" ref="loader" v-show="isLoading"></div>\n\t\t<BlocksCollection  \n\t\t\tv-show="!isLoading" \n\t\t\tcontainerCssClass="crm-entity-stream-restapp-container"\n\t\t\titemCssClass="crm-timeline__restapp-container_block"\n\t\t\tref="blocks"\n\t\t\t:blocks="layout?.blocks ?? {}"></BlocksCollection>\n\n\t\t<div class="crm-entity-stream-restapp-btn-container" v-show="!isLoading && (hasPrimaryButton || hasSecondaryButton)">\n\t\t\t<Button v-if="hasPrimaryButton" v-bind="primaryButtonParams" :action="primaryButtonAction"></Button>\n\t\t\t<Button v-if="hasSecondaryButton" v-bind="secondaryButtonParams" :action="secondaryButtonAction"></Button>\n\t\t</div>\n\t`};class gi{}gi.text="Text";gi.link="Link";gi.lineOfBlocks="LineOfTextBlocks";gi.withTitle="WithTitle";gi.section="Section";gi.list="List";gi.dropdownMenu="DropdownMenu";gi.input="Input";gi.select="Select";gi.textarea="Textarea";class yi{}yi.PRIMARY="primary";yi.WARNING="warning";yi.DANGER="danger";yi.SUCCESS="success";yi.BASE_50="base-50";yi.BASE_60="base-60";yi.BASE_70="base-70";yi.BASE_90="base-90";class Li{}Li.XS="xs";Li.SM="sm";Li.MD="md";Li.LG="lg";Li.XL="xl";var fi={inheritAttrs:false,props:{value:String|Number,title:{type:String,required:false,default:""},color:{type:String,required:false,default:""},bold:{type:Boolean,required:false,default:false},size:{type:String,required:false,default:"md"},multiline:{type:Boolean,required:false,default:false}},computed:{className(){return["crm-timeline__text-block",this.colorClassname,this.boldClassname,this.sizeClassname]},colorClassname(){var e;const t=this.color?this.color.toUpperCase():"";const s=(e=yi[t])!=null?e:"";return s?`--color-${s}`:""},boldClassname(){const e=this.bold?"bold":"normal";return`--weight-${e}`},sizeClassname(){var e;const t=this.size?this.size.toUpperCase():"";const s=(e=Li[t])!=null?e:Li.SM;return`--size-${s}`},encodedText(){let e=I.Text.encode(this.value);if(this.multiline){e=e.replace(/\n/g,"<br />")}return e}},template:`\n\t\t<span\n\t\t\t:title="title"\n\t\t\t:class="className"\n\t\t\tv-html="encodedText"\n\t\t></span>`};var Pi={inheritAttrs:false,props:{text:String,action:Object,size:{type:String,required:false,default:"md"},bold:{type:Boolean,required:false,default:false}},computed:{href(){if(!this.action){return null}const e=new ui(this.action);if(e.isRedirect()){return e.getValue()}return null},linkAttrs(){if(!this.action){return{}}const e=new ui(this.action);if(!e.isRedirect()){return{}}return{href:e.getValue()}},className(){return["crm-timeline__card_link",this.bold?"--bold":"",this.sizeClassname]},sizeClassname(){var e;const t=this.size?this.size.toUpperCase():"";const s=(e=Li[t])!=null?e:Li.SM;return`--size-${s}`}},methods:{executeAction(){if(this.action){const e=new ui(this.action);e.execute(this)}}},template:`\n\t\t\t<a\n\t\t\t\tv-if="href"\n\t\t\t\tv-bind="linkAttrs"\n\t\t\t\t:class="className"\n\t\t\t>\n\t\t\t{{text}}\n\t\t\t</a>\n\t\t\t<span\n\t\t\t\tv-else\n\t\t\t\t@click="executeAction"\n\t\t\t\t:class="className"\n\t\t\t>\n\t\t\t\t{{text}}\n\t\t\t</span>\n\t\t`};class _i{}_i.SM="sm";_i.MD="md";_i.LG="lg";var Bi={inheritAttrs:false,props:{blocks:Object},computed:{allowedTypes(){return Object.values(gi)},containerCssClass(){return""},containerTagName(){return"div"},itemCssClass(){return""},itemTagName(){return"div"},isInline(){return false}},methods:{setLayoutItemState(e,t,s){return this.$refs.blocks.setLayoutItemState(e,t,s)}},template:`\n\t\t<BlocksCollection \n\t\t\t:containerCssClass="containerCssClass"\n\t\t\t:containerTagName="containerTagName"\n\t\t\t:itemCssClass="itemCssClass"\n\t\t\t:itemTagName="itemTagName"\n\t\t\tref="blocks"\n\t\t\t:blocks="blocks ?? {}" \n\t\t\t:inline="true"\n\t\t\t:allowedTypes="allowedTypes"\n\t\t></BlocksCollection>`};const Ei=o.BitrixVue.cloneComponent(Bi,{computed:{allowedTypes(){return[gi.text,gi.link,gi.dropdownMenu]},containerCssClass(){return"crm-timeline-block-line-of-texts"},containerTagName(){return"span"},itemTagName(){return"span"},isInline(){return true}}});var Ti={inheritAttrs:false,components:{Text:fi,Link:Pi,LineOfTextBlocks:Ei},props:{id:String,title:String,inline:Boolean,titleWidth:{type:String,required:false,default:_i.MD},block:Object},computed:{className(){return["crm-timeline__card-container_info","--word-wrap",this.widthClassname,this.inline?"--inline":""]},widthClassname(){var e;const t=(e=_i[this.titleWidth.toUpperCase()])!=null?e:_i.MD;return`--width-${t}`},isValidBlock(){return[gi.text,gi.link,gi.lineOfBlocks].includes(this.rendererName)},rendererName(){var e,t;return(e=gi[(t=this.block)==null?void 0:t.type])!=null?e:null}},methods:{isTitleCropped(){const e=this.$refs.title;return e.scrollWidth>e.clientWidth}},mounted(){this.$nextTick((()=>{if(this.isTitleCropped()){I.Dom.attr(this.$refs.title,"title",this.title)}}))},template:`\n\t\t\t<div :class="className" v-if="isValidBlock">\n\t\t\t\t<div ref="title" class="crm-timeline__card-container_info-title">{{ title }}</div>\n\t\t\t\t<div class="crm-timeline__card-container_info-value">\n\t\t\t\t\t<component :is="rendererName" v-bind="block.properties" :id="id"></component>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t`};const Ii="restapp-dropdown-menu";var Ci={inheritAttrs:false,props:{values:Object,id:String,selectedValue:{required:false,default:""},size:{type:String,required:false,default:"md"}},data(){return{currentSelectedValue:this.selectedValue}},beforeUnmount(){const e=P.MenuManager.getMenuById(Ii);if(e){e.destroy()}},computed:{className(){return["crm-timeline-block-dropdownmenu",this.sizeClassname]},sizeClassname(){var e;const t=this.size?this.size.toUpperCase():"";const s=(e=Li[t])!=null?e:Li.SM;return`--size-${s}`},selectedValueCode(){let e=this.currentSelectedValue;if(!Object.hasOwn(this.values,e)){const t=Object.keys(this.values);e=t.length>0?t[0]:""}return e},selectedValueTitle(){var e;return String((e=this.values[this.selectedValueCode])!=null?e:"")},isValid(){return I.Type.isPlainObject(this.values)&&Object.keys(this.values).length>0}},watch:{selectedValue(e){this.currentSelectedValue=e}},methods:{onMenuItemClick(e){var t;this.currentSelectedValue=e;(t=P.MenuManager.getCurrentMenu())==null?void 0:t.close();this.$Bitrix.eventEmitter.emit(vi,{event:oi.VALUE_CHANGED_EVENT,value:{id:this.id,value:e}})},showMenu(){const e=[];Object.keys(this.values).forEach((t=>{e.push({text:String(this.values[t]),value:t,onclick:()=>{this.onMenuItemClick(t)}})}));P.MenuManager.show({id:Ii,cacheable:false,bindElement:this.$el,items:e})}},template:`\n\t\t<span v-if="isValid" :class="className" @click="showMenu"><span class="crm-timeline-block-dropdownmenu-content">{{selectedValueTitle}}</span><span class="crm-timeline-block-dropdownmenu-arrow"></span></span>`};var Fi={emits:["update:modelValue"],props:{modelValue:String,placeholder:String,disabled:Boolean},data(){return{currentValue:this.modelValue}},methods:{onChange(){this.$emit("update:modelValue",this.currentValue)}},watch:{modelValue(e){this.currentValue=e}},template:`\n\t\t<div class="ui-ctl ui-ctl-textbox ui-ctl-w100">\n\t\t\t<input :placeholder="placeholder" :disabled="disabled" v-model="currentValue" @input="onChange" type="text" class="ui-ctl-element" />\n\t\t</div>\n\t`};var Si={emits:["update:modelValue"],props:{modelValue:String,values:Array,disabled:Boolean},data(){return{currentValue:this.getSelectedValue(this.modelValue)}},methods:{onChange(){this.$emit("update:modelValue",this.currentValue)},getSelectedValue(e){if(!I.Type.isArray(this.values)){return""}if(this.values.some((t=>t.id===e))){return e}return this.values.length>0?this.values[0].id:""}},watch:{modelValue(e){this.currentValue=this.getSelectedValue(e)}},template:`\n\t\t<div class="ui-ctl ui-ctl-after-icon ui-ctl-dropdown ui-ctl-w100">\n\t\t\t<div class="ui-ctl-after ui-ctl-icon-angle"></div>\n\t\t\t<select :disabled="disabled" v-model="currentValue" @change="onChange" class="ui-ctl-element">\n\t\t\t\t<option :value="option.id" :key="option.id" :selected="option.id===currentValue" v-for="option in values">{{ option.value }}</option>\n\t\t\t</select>\n\t\t</div>\n\t`};var Hi={emits:["update:modelValue"],props:{modelValue:String,placeholder:String,disabled:Boolean},data(){return{currentValue:this.modelValue}},mounted(){this.adjustTextareaHeight()},methods:{onChange(){this.$emit("update:modelValue",this.currentValue);this.adjustTextareaHeight()},adjustTextareaHeight(){const e=this.$refs.textarea;this.$nextTick((()=>{I.Dom.style(e,"height",0);let t=e.scrollHeight;if(t<120){t=120}if(t>1e3){t=1e3}t+=12;t+="px";I.Dom.style(e,"height",t);I.Dom.style(e.parentNode,"height",t)}))}},watch:{modelValue(e){this.currentValue=e;this.$nextTick((()=>{this.adjustTextareaHeight(this.$refs.textarea)}))}},template:`\n\t\t<div class="ui-ctl ui-ctl-textarea ui-ctl-w100 ui-ctl-no-resize">\n\t\t\t<textarea ref="textarea" :placeholder="placeholder" :disabled="disabled" v-model="currentValue" @input="onChange" class="ui-ctl-element"></textarea>\n\t\t</div>\n\t`};var Oi={inheritAttrs:false,components:{Input:Fi,Select:Si,Textarea:Hi},props:{id:String,title:String,errorText:String,value:String,disabled:{type:Boolean,required:false,default:false}},data(){return{currentValue:this.getInitialValue()}},computed:{className(){return["ui-ctl-container","ui-ctl-w100",this.hasError?"ui-ctl-warning":""]},hasTitle(){return Boolean(this.title)},hasError(){return Boolean(this.errorText)},componentName(){throw new Error("Must be overridden")},componentProps(){throw new Error("Must be overridden")}},watch:{value(e){this.currentValue=e}},methods:{getInitialValue(){return this.value},onChange(e){this.$Bitrix.eventEmitter.emit(vi,{event:oi.VALUE_CHANGED_EVENT,value:{id:this.id,value:e}})}},template:`\n\t\t<div :class="className">\n\t\t\t<div class="ui-ctl-top" v-if="hasTitle">\n\t\t\t\t<div class="ui-ctl-title">{{ title }}</div>\n\t\t\t</div>\n\t\t\t<component :is="componentName" v-bind="componentProps" :disabled="disabled" v-model="currentValue" @update:modelValue="onChange"></component>\n\t\t\t<div v-if="hasError" class="ui-ctl-bottom">{{ errorText }}</div>\n\t\t</div>\n\t`};const Mi=o.BitrixVue.cloneComponent(Oi,{props:{placeholder:String},computed:{componentName(){return"Input"},componentProps(){return{placeholder:this.placeholder}}}});const Ni=o.BitrixVue.cloneComponent(Oi,{props:{selectedValue:String,values:Object},computed:{componentName(){return"Select"},componentProps(){return{values:this.preparedValues}},preparedValues(){if(!I.Type.isPlainObject(this.values)){return[]}const e=[];Object.keys(this.values).forEach((t=>{e.push({id:t,value:String(this.values[t])})}));return e}},watch:{selectedValue(e){this.currentValue=e}},methods:{getInitialValue(){return`${this.selectedValue}`}}});const wi=o.BitrixVue.cloneComponent(Oi,{props:{placeholder:String},computed:{componentName(){return"Textarea"},componentProps(){return{placeholder:this.placeholder}}}});const Ai=o.BitrixVue.cloneComponent(Bi,{computed:{allowedTypes(){return[gi.text,gi.link,gi.lineOfBlocks]},containerCssClass(){return"crm-timeline-block-list"},itemCssClass(){return"crm-timeline-block-list-item"}}});class Ri{}Ri.SM="sm";Ri.MD="md";Ri.LG="lg";class Di{}Di.default="default";Di.primary="primary";Di.warning="warning";Di.danger="danger";Di.success="success";Di.withBorder="with-border";const ki=o.BitrixVue.cloneComponent(Bi,{props:{type:{type:String,required:false,default:Di.default},imageSrc:{type:String,required:false,default:""},imageSize:{type:String,required:false,default:Ri.LG}},computed:{allowedTypes(){return Object.values(gi).filter((e=>e!==gi.section))},className(){return["crm-timeline-block-section",this.typeClassname]},imageClassName(){return["crm-timeline-block-section-img",this.imageSizeClassname]},typeClassname(){var e;const t=(e=Di[this.type])!=null?e:Di.default;return t?`--type-${t}`:""},imageSizeClassname(){var e;const t=(e=Ri[this.imageSize.toUpperCase()])!=null?e:Ri.LG;return t?`--size-${t}`:""},imageUri(){if(!this.imageSrc){return null}const e=/^(http|https):\/\//;if(!e.test(this.imageSrc)){return null}return this.imageSrc}},template:`\n\t\t<div :class="className">\n\t\t\t<div v-if="imageUri" :class="imageClassName">\n\t\t\t\t<img :src="imageUri" />\n\t\t\t</div>\n\t\t<BlocksCollection\n\t\t\tref="blocks"\n\t\t\tcontainerCssClass="crm-timeline-block-section-blocks"\n\t\t\titemCssClass="crm-timeline__restapp-container_block"\n\t\t\t:blocks="blocks ?? {}"\n\t\t\t:allowedTypes="allowedTypes"\n\t\t></BlocksCollection>\n\t\t</div>`});var xi={components:{Text:fi,Link:Pi,LineOfTextBlocks:Ei,DropdownMenu:Ci,Input:Mi,Select:Ni,Textarea:wi,List:Ai,WithTitle:Ti,Section:ki},props:{containerTagName:{type:String,required:false,default:"div"},containerCssClass:{type:String,required:false,default:""},itemTagName:{type:String,required:false,default:"div"},itemCssClass:{type:String,required:false,default:""},inline:{type:Boolean,required:false,default:false},allowedTypes:{type:Array,required:false,default:Object.values(gi)},blocks:Object},data(){return{currentBlocks:this.blocks,blockRefs:{}}},beforeUpdate(){this.blockRefs={}},updated(){this.setDataIdAttribute()},mounted(){this.setDataIdAttribute()},watch:{blocks(e){this.currentBlocks=e}},methods:{saveRef(e,t){this.blockRefs[t]=e},setDataIdAttribute(){if(!this.blockRefs||this.visibleBlocks.length===0){return}this.visibleBlocks.forEach(((e,t)=>{var s;const i=e.id;const a=(s=this.blockRefs[i])==null?void 0:s.$el;if(I.Type.isElementNode(a)){a.setAttribute("data-id",i)}}))},setLayoutItemState(e,t,s){if(!Object.hasOwn(this.currentBlocks,e)){return Object.keys(this.currentBlocks).reduce(((i,a)=>{if(this.blockRefs[a]&&I.Type.isFunction(this.blockRefs[a].setLayoutItemState)){return this.blockRefs[a].setLayoutItemState(e,t,s)||i}return i}),false)}if(I.Type.isPlainObject(s)){this.currentBlocks[e].properties={...this.currentBlocks[e].properties,...s}}if(I.Type.isBoolean(t)){this.currentBlocks[e].visible=t}return true},getIdByComponentInstance(e){const t=Object.keys(this.blockRefs).find((t=>this.blockRefs[t]===e));return t||null},getItemCssClassList(e){const t=[];if(this.itemCssClass){t.push(this.itemCssClass)}if(!e.visible){t.push("--hidden")}if(e.id===this.firstVisibleBlockId){t.push("--first-visible")}if(e.id===this.lastVisibleBlockId){t.push("--last-visible")}return t}},computed:{visibleBlocks(){if(!this.currentBlocks){return[]}return Object.keys(this.currentBlocks).map((e=>{var t;const s=this.currentBlocks[e];const i=(t=gi[s.type])!=null?t:null;const a=!I.Type.isBoolean(s.visible)||s.visible;return{id:e,rendererName:i,...this.currentBlocks[e],visible:a}})).filter((e=>this.allowedTypes.includes(e.rendererName)))},firstVisibleBlockId(){const e=this.visibleBlocks.filter((e=>e.visible));if(!e.length){return null}return e[0].id},lastVisibleBlockId(){const e=this.visibleBlocks.filter((e=>e.visible));if(!e.length){return null}return e[e.length-1].id}},template:`\n\t\t<component :is="containerTagName" :class="containerCssClass">\n\t\t\t<component :is="itemTagName"\n\t\t\t\t:class="getItemCssClassList(block)"\n\t\t\t\tv-for="(block) in visibleBlocks"\n\t\t\t\t:key="block.id"\n\t\t\t>\n\t\t\t\t<component :is="block.rendererName"\n\t\t\t\t\t\t   :id="block.id"\n\t\t\t\t\t\t   v-bind="block.properties"\n\t\t\t\t\t\t   :ref="(el) => this.saveRef(el, block.id)"\n\t\t\t\t/>\n\t\t\t\t<span v-if="inline">&nbsp;</span>\n\t\t\t</component>\n\t\t</component>`};const ji="rest_placement_spotlight";const Xi="crm";const Ki="rest_placement_tour_viewed";const Ui=800;const $i=1e3;var Gi=babelHelpers.classPrivateFieldLooseKey("id");var Vi=babelHelpers.classPrivateFieldLooseKey("title");var Wi=babelHelpers.classPrivateFieldLooseKey("text");var zi=babelHelpers.classPrivateFieldLooseKey("isCanShowTour");var qi=babelHelpers.classPrivateFieldLooseKey("appContext");var Yi=babelHelpers.classPrivateFieldLooseKey("isHidden");var Ji=babelHelpers.classPrivateFieldLooseKey("currentTarget");var Zi=babelHelpers.classPrivateFieldLooseKey("guide");var Qi=babelHelpers.classPrivateFieldLooseKey("spotlight");var ea=babelHelpers.classPrivateFieldLooseKey("checkTargetChangeIntervalID");var ta=babelHelpers.classPrivateFieldLooseKey("bindEvents");var sa=babelHelpers.classPrivateFieldLooseKey("unbindEvents");var ia=babelHelpers.classPrivateFieldLooseKey("onTargetChange");var aa=babelHelpers.classPrivateFieldLooseKey("isVisible");var la=babelHelpers.classPrivateFieldLooseKey("hide");var na=babelHelpers.classPrivateFieldLooseKey("unHide");var ra=babelHelpers.classPrivateFieldLooseKey("rebindTarget");var oa=babelHelpers.classPrivateFieldLooseKey("getSpotlight");var ca=babelHelpers.classPrivateFieldLooseKey("getTarget");var da=babelHelpers.classPrivateFieldLooseKey("prepareMoreDetailsLink");var ha=babelHelpers.classPrivateFieldLooseKey("openAppPlacementSlider");class ua{constructor(e){Object.defineProperty(this,ha,{value:Ba});Object.defineProperty(this,da,{value:_a});Object.defineProperty(this,ca,{value:Pa});Object.defineProperty(this,oa,{value:fa});Object.defineProperty(this,ra,{value:La});Object.defineProperty(this,na,{value:ya});Object.defineProperty(this,la,{value:ga});Object.defineProperty(this,aa,{value:ma});Object.defineProperty(this,ia,{value:va});Object.defineProperty(this,sa,{value:ba});Object.defineProperty(this,ta,{value:pa});Object.defineProperty(this,Gi,{writable:true,value:void 0});Object.defineProperty(this,Vi,{writable:true,value:void 0});Object.defineProperty(this,Wi,{writable:true,value:void 0});Object.defineProperty(this,zi,{writable:true,value:void 0});Object.defineProperty(this,qi,{writable:true,value:void 0});Object.defineProperty(this,Yi,{writable:true,value:false});Object.defineProperty(this,Ji,{writable:true,value:null});Object.defineProperty(this,Zi,{writable:true,value:null});Object.defineProperty(this,Qi,{writable:true,value:null});Object.defineProperty(this,ea,{writable:true,value:null});babelHelpers.classPrivateFieldLooseBase(this,Gi)[Gi]=I.Type.isStringFilled(e.id)?e.id:null;babelHelpers.classPrivateFieldLooseBase(this,Vi)[Vi]=I.Type.isStringFilled(e.title)?e.title:"";babelHelpers.classPrivateFieldLooseBase(this,Wi)[Wi]=I.Type.isStringFilled(e.text)?e.text:"";babelHelpers.classPrivateFieldLooseBase(this,zi)[zi]=I.Type.isBoolean(e.isCanShowTour)?e.isCanShowTour:false;babelHelpers.classPrivateFieldLooseBase(this,qi)[qi]=I.Type.isPlainObject(e.appContext)?e.appContext:{}}show(){babelHelpers.classPrivateFieldLooseBase(this,oa)[oa]().show();this.getGuide().showNextStep();babelHelpers.classPrivateFieldLooseBase(this,da)[da]();babelHelpers.classPrivateFieldLooseBase(this,ta)[ta]()}canShow(){let e=true;const t=[babelHelpers.classPrivateFieldLooseBase(this,Gi)[Gi],babelHelpers.classPrivateFieldLooseBase(this,Vi)[Vi],babelHelpers.classPrivateFieldLooseBase(this,Wi)[Wi]];t.forEach((t=>{if(!I.Type.isStringFilled(t)){e=false}}));return babelHelpers.classPrivateFieldLooseBase(this,zi)[zi]&&e&&I.Type.isDomNode(babelHelpers.classPrivateFieldLooseBase(this,ca)[ca]())}getGuide(){if(!babelHelpers.classPrivateFieldLooseBase(this,Zi)[Zi]){babelHelpers.classPrivateFieldLooseBase(this,Zi)[Zi]=new p.Guide({onEvents:true,steps:[{target:babelHelpers.classPrivateFieldLooseBase(this,ca)[ca](),title:I.Text.encode(babelHelpers.classPrivateFieldLooseBase(this,Vi)[Vi]),text:I.Text.encode(babelHelpers.classPrivateFieldLooseBase(this,Wi)[Wi]),position:"bottom",rounded:true,link:"##",events:{onClose:()=>{BX.userOptions.save(Xi,Ki,babelHelpers.classPrivateFieldLooseBase(this,Gi)[Gi],true);babelHelpers.classPrivateFieldLooseBase(this,oa)[oa]().close();babelHelpers.classPrivateFieldLooseBase(this,sa)[sa]()}}}]})}return babelHelpers.classPrivateFieldLooseBase(this,Zi)[Zi]}}function pa(){this.currentTarget=babelHelpers.classPrivateFieldLooseBase(this,ca)[ca]();babelHelpers.classPrivateFieldLooseBase(this,ea)[ea]=setInterval(babelHelpers.classPrivateFieldLooseBase(this,ia)[ia].bind(this),$i)}function ba(){clearInterval(babelHelpers.classPrivateFieldLooseBase(this,ea)[ea])}function va(){const e=babelHelpers.classPrivateFieldLooseBase(this,ca)[ca]();const t=babelHelpers.classPrivateFieldLooseBase(this,aa)[aa](e);const s=babelHelpers.classPrivateFieldLooseBase(this,Ji)[Ji]!==e;if(t){babelHelpers.classPrivateFieldLooseBase(this,na)[na]()}else{babelHelpers.classPrivateFieldLooseBase(this,la)[la]()}if(s){babelHelpers.classPrivateFieldLooseBase(this,ra)[ra](e);babelHelpers.classPrivateFieldLooseBase(this,Ji)[Ji]=e}}function ma(e){return Boolean(e.offsetWidth||e.offsetHeight||e.getClientRects().length>0)}function ga(){if(babelHelpers.classPrivateFieldLooseBase(this,Yi)[Yi]){return}const e=this.getGuide().getPopup().getPopupContainer();I.Dom.addClass(e,"--hidden");babelHelpers.classPrivateFieldLooseBase(this,Yi)[Yi]=true}function ya(){if(!babelHelpers.classPrivateFieldLooseBase(this,Yi)[Yi]){return}const e=this.getGuide().getPopup();I.Dom.removeClass(e.popupContainer,"--hidden");e.adjustPosition();babelHelpers.classPrivateFieldLooseBase(this,Yi)[Yi]=false}function La(e){this.getGuide().getCurrentStep().setTarget(e);this.getGuide().showNextStep();babelHelpers.classPrivateFieldLooseBase(this,da)[da]();babelHelpers.classPrivateFieldLooseBase(this,oa)[oa]().setTargetElement(e)}function fa(){if(!babelHelpers.classPrivateFieldLooseBase(this,Qi)[Qi]){const e=`${ji}_${babelHelpers.classPrivateFieldLooseBase(this,Gi)[Gi]}`;babelHelpers.classPrivateFieldLooseBase(this,Qi)[Qi]=new BX.SpotLight({id:e,targetElement:babelHelpers.classPrivateFieldLooseBase(this,ca)[ca](),autoSave:"no",targetVertex:"middle-center",zIndex:200})}return babelHelpers.classPrivateFieldLooseBase(this,Qi)[Qi]}function Pa(){var e;let t=document.querySelector(`[data-id="${babelHelpers.classPrivateFieldLooseBase(this,Gi)[Gi]}"]`);if((e=t)!=null&&e.offsetTop){t=t.parentElement.nextElementSibling}return t}function _a(){const e=this.getGuide().getLink();e.removeAttribute("href");e.removeAttribute("target");I.Dom.style(e,"cursor","pointer");e.onclick=babelHelpers.classPrivateFieldLooseBase(this,ha)[ha].bind(this)}function Ba(){const{applicationId:e,placementOptions:t,additionalComponentParam:s,closeCallback:i}=babelHelpers.classPrivateFieldLooseBase(this,qi)[qi];t.newUserNotification="Y";t.bx24_width=Ui;BX.rest.AppLayout.openApplication(e,t,s,i)}class Ea extends j{showTour(){const e=new ua({id:this.getSetting("id"),title:this.getSetting("newUserNotificationTitle"),text:this.getSetting("newUserNotificationText"),isCanShowTour:this.getSetting("isCanShowTour")&&!BX.Crm.EntityEditor.getDefault().isNew(),appContext:{applicationId:this.getSetting("appId",""),placementOptions:{entityTypeId:this.getEntityTypeId(),entityId:this.getEntityId()}}});B.TourManager.getInstance().registerWithLaunch(e)}}class Ta{validate(e){return[]}}var Ia=babelHelpers.classPrivateFieldLooseKey("placementCode");var Ca=babelHelpers.classPrivateFieldLooseKey("methodsList");var Fa=babelHelpers.classPrivateFieldLooseKey("handlers");var Sa=babelHelpers.classPrivateFieldLooseKey("initializeInterface");var Ha=babelHelpers.classPrivateFieldLooseKey("interfaceCallback");class Oa{constructor(e,t){Object.defineProperty(this,Ha,{value:Na});Object.defineProperty(this,Sa,{value:Ma});Object.defineProperty(this,Ia,{writable:true,value:null});Object.defineProperty(this,Ca,{writable:true,value:[]});Object.defineProperty(this,Fa,{writable:true,value:{}});babelHelpers.classPrivateFieldLooseBase(this,Ia)[Ia]=e;babelHelpers.classPrivateFieldLooseBase(this,Ca)[Ca]=t;babelHelpers.classPrivateFieldLooseBase(this,Sa)[Sa]()}static getInstance(e,t){if(!Object.hasOwn(Oa.Instances,e)){Oa.Instances[e]=new Oa(e,t)}return Oa.Instances[e]}registerHandlers(e,t){babelHelpers.classPrivateFieldLooseBase(this,Fa)[Fa][e]=t}}function Ma(){const e=BX.rest.AppLayout.initializePlacement(babelHelpers.classPrivateFieldLooseBase(this,Ia)[Ia]);babelHelpers.classPrivateFieldLooseBase(this,Ca)[Ca].forEach((t=>{e.prototype[t]=babelHelpers.classPrivateFieldLooseBase(this,Ha)[Ha].bind(this,t)}))}function Na(){var e,t,s,i,a;const l=(e=arguments[0])!=null?e:null;const n=(t=(s=arguments[3])==null?void 0:(i=s.params)==null?void 0:i.placementId)!=null?t:null;if(!l||!n){return}const r=(a=babelHelpers.classPrivateFieldLooseBase(this,Fa)[Fa][n])!=null?a:{};if(I.Type.isFunction(r[l])){var o,c;r[l]((o=arguments[1])!=null?o:null,(c=arguments[2])!=null?c:null)}}Oa.Instances={};let wa=e=>e,Aa,Ra;const Da="LayoutEvent";const ka="PrimaryButtonClickEvent";const xa="SecondaryButtonClickEvent";const ja="ValueChangeEvent";const Xa="entityUpdateEvent";var Ka=babelHelpers.classPrivateFieldLooseKey("layoutComponent");var Ua=babelHelpers.classPrivateFieldLooseKey("layoutApp");var $a=babelHelpers.classPrivateFieldLooseKey("activated");var Ga=babelHelpers.classPrivateFieldLooseKey("eventEmitter");var Va=babelHelpers.classPrivateFieldLooseKey("initializeInterface");var Wa=babelHelpers.classPrivateFieldLooseKey("setLayout");var za=babelHelpers.classPrivateFieldLooseKey("setLayoutItemState");var qa=babelHelpers.classPrivateFieldLooseKey("setButtonState");var Ya=babelHelpers.classPrivateFieldLooseKey("bindEventCallback");var Ja=babelHelpers.classPrivateFieldLooseKey("finish");var Za=babelHelpers.classPrivateFieldLooseKey("executeEventCallback");var Qa=babelHelpers.classPrivateFieldLooseKey("onLayoutAppAction");var el=babelHelpers.classPrivateFieldLooseKey("executeCallback");var tl=babelHelpers.classPrivateFieldLooseKey("loadApp");class sl extends Ea{constructor(){super();Object.defineProperty(this,tl,{value:ul});Object.defineProperty(this,el,{value:hl});Object.defineProperty(this,Qa,{value:dl});Object.defineProperty(this,Za,{value:cl});Object.defineProperty(this,Ja,{value:ol});Object.defineProperty(this,Ya,{value:rl});Object.defineProperty(this,qa,{value:nl});Object.defineProperty(this,za,{value:ll});Object.defineProperty(this,Wa,{value:al});Object.defineProperty(this,Va,{value:il});Object.defineProperty(this,Ka,{writable:true,value:null});Object.defineProperty(this,Ua,{writable:true,value:null});Object.defineProperty(this,$a,{writable:true,value:false});Object.defineProperty(this,Ga,{writable:true,value:null});babelHelpers.classPrivateFieldLooseBase(this,Ga)[Ga]=new E.EventEmitter;babelHelpers.classPrivateFieldLooseBase(this,Ga)[Ga].setEventNamespace("RestPlacement");E.EventEmitter.subscribe("onCrmEntityUpdate",(()=>{babelHelpers.classPrivateFieldLooseBase(this,Ga)[Ga].emit(Xa,{})}))}createLayout(){return I.Tag.render(Aa||(Aa=wa`<div class="crm-entity-stream-content-new-detail --hidden"></div>`))}initializeLayout(){super.initializeLayout();babelHelpers.classPrivateFieldLooseBase(this,Ua)[Ua]=o.BitrixVue.createApp(mi,{id:String(this.getSetting("placementId","")),appId:this.getSetting("appId",""),onAction:babelHelpers.classPrivateFieldLooseBase(this,Qa)[Qa].bind(this)});babelHelpers.classPrivateFieldLooseBase(this,Ua)[Ua].component("BlocksCollection",xi);babelHelpers.classPrivateFieldLooseBase(this,Ka)[Ka]=babelHelpers.classPrivateFieldLooseBase(this,Ua)[Ua].mount(this.getContainer())}activate(){super.activate();if(!babelHelpers.classPrivateFieldLooseBase(this,$a)[$a]){babelHelpers.classPrivateFieldLooseBase(this,$a)[$a]=true;babelHelpers.classPrivateFieldLooseBase(this,Va)[Va]();babelHelpers.classPrivateFieldLooseBase(this,tl)[tl]()}}}function il(){const e=Oa.getInstance(this.getSetting("placement",""),["setLayout","setLayoutItemState","bindLayoutEventCallback","bindValueChangeCallback","setPrimaryButtonState","setSecondaryButtonState","bindPrimaryButtonClickCallback","bindSecondaryButtonClickCallback","bindEntityUpdateCallback","finish","lock","unlock"]);e.registerHandlers(this.getSetting("placementId",""),{setLayout:babelHelpers.classPrivateFieldLooseBase(this,Wa)[Wa].bind(this),setLayoutItemState:babelHelpers.classPrivateFieldLooseBase(this,za)[za].bind(this),bindLayoutEventCallback:babelHelpers.classPrivateFieldLooseBase(this,Ya)[Ya].bind(this,Da),bindValueChangeCallback:babelHelpers.classPrivateFieldLooseBase(this,Ya)[Ya].bind(this,ja),setPrimaryButtonState:babelHelpers.classPrivateFieldLooseBase(this,qa)[qa].bind(this,ni.PRIMARY),setSecondaryButtonState:babelHelpers.classPrivateFieldLooseBase(this,qa)[qa].bind(this,ni.SECONDARY),bindPrimaryButtonClickCallback:babelHelpers.classPrivateFieldLooseBase(this,Ya)[Ya].bind(this,ka),bindSecondaryButtonClickCallback:babelHelpers.classPrivateFieldLooseBase(this,Ya)[Ya].bind(this,xa),bindEntityUpdateCallback:babelHelpers.classPrivateFieldLooseBase(this,Ya)[Ya].bind(this,Xa),finish:babelHelpers.classPrivateFieldLooseBase(this,Ja)[Ja].bind(this),lock:this.setLocked.bind(this,true),unlock:this.setLocked.bind(this,false)})}function al(e,t){const s=new Ta;const i=s.validate(e);if(i.length>0){babelHelpers.classPrivateFieldLooseBase(this,el)[el](t,{result:"error",errors:i})}else{babelHelpers.classPrivateFieldLooseBase(this,Ka)[Ka].showLoader(false);babelHelpers.classPrivateFieldLooseBase(this,Ka)[Ka].setLayout(e);babelHelpers.classPrivateFieldLooseBase(this,el)[el](t,{result:"success"})}}function ll(e,t){var s,i,a;const l=(s=e.id)!=null?s:null;let n=(i=e.properties)!=null?i:null;let r=(a=e.visible)!=null?a:null;if(!I.Type.isStringFilled(l)){babelHelpers.classPrivateFieldLooseBase(this,el)[el](t,{result:"error",errors:["Wrong id"]});return}const o=I.Type.isBoolean(r);const c=I.Type.isPlainObject(n);if(!c&&!o){babelHelpers.classPrivateFieldLooseBase(this,el)[el](t,{result:"error",errors:["Wrong state"]});return}if(!o){r=null}if(!c){n=null}babelHelpers.classPrivateFieldLooseBase(this,Ka)[Ka].setLayoutItemState(l,r,n,(e=>babelHelpers.classPrivateFieldLooseBase(this,el)[el](t,e)))}function nl(e,t,s){if(!I.Type.isPlainObject(t)&&!(I.Type.isArray(t)&&t.length===0)&&!I.Type.isNull(t)){babelHelpers.classPrivateFieldLooseBase(this,el)[el](s,{result:"error",errors:["Wrong params"]});return}let i=t;if(I.Type.isArray(t)&&t.length===0){i=null}babelHelpers.classPrivateFieldLooseBase(this,Ka)[Ka].setButtonState(e,i,(e=>babelHelpers.classPrivateFieldLooseBase(this,el)[el](s,e)))}function rl(e,t,s){babelHelpers.classPrivateFieldLooseBase(this,Ga)[Ga].subscribe(e,babelHelpers.classPrivateFieldLooseBase(this,Za)[Za].bind(this,t,s))}function ol(){this.emitFinishEditEvent()}function cl(e,t,s){const i=s.getData();if(I.Type.isStringFilled(e)){var a;if(((a=i.id)!=null?a:"")===e){babelHelpers.classPrivateFieldLooseBase(this,el)[el](t,i)}return}babelHelpers.classPrivateFieldLooseBase(this,el)[el](t,i)}function dl(e){var t,s;const i=(t=e.event)!=null?t:null;const a=(s=e.value)!=null?s:null;if(i===oi.FOOTER_BUTTON_CLICK&&a===ni.PRIMARY){babelHelpers.classPrivateFieldLooseBase(this,Ga)[Ga].emit(ka,{})}if(i===oi.FOOTER_BUTTON_CLICK&&a===ni.SECONDARY){babelHelpers.classPrivateFieldLooseBase(this,Ga)[Ga].emit(xa,{})}if(i===oi.LAYOUT_EVENT){babelHelpers.classPrivateFieldLooseBase(this,Ga)[Ga].emit(Da,a)}if(i===oi.VALUE_CHANGED_EVENT){babelHelpers.classPrivateFieldLooseBase(this,Ga)[Ga].emit(ja,a)}}function hl(e,t){if(I.Type.isFunction(e)){e(t)}}function ul(){I.ajax.runComponentAction("bitrix:app.layout","getComponent",{data:{placementId:this.getSetting("placementId",""),placementOptions:{entityTypeId:this.getEntityTypeId(),entityId:this.getEntityId(),useBuiltInInterface:"Y"}}}).then((e=>{if(!(e&&e.data&&e.data.componentResult)){return}const t=e.data.componentResult;this.appSid=t.APP_SID;const s=I.Tag.render(Ra||(Ra=wa`<div style="display: none; overflow: hidden;"></div>`));I.Dom.append(s,document.body);I.Runtime.html(s,e.data.html)}))}var pl=babelHelpers.classPrivateFieldLooseKey("interfaceInitialized");var bl=babelHelpers.classPrivateFieldLooseKey("initializeInterface");class vl extends Ea{constructor(...e){super(...e);Object.defineProperty(this,bl,{value:ml});Object.defineProperty(this,pl,{writable:true,value:false})}showSlider(){if(!babelHelpers.classPrivateFieldLooseBase(this,pl)[pl]){babelHelpers.classPrivateFieldLooseBase(this,pl)[pl]=true;babelHelpers.classPrivateFieldLooseBase(this,bl)[bl]()}const e=this.getSetting("appId","");BX.rest.AppLayout.openApplication(e,{ID:this.getEntityId()},{PLACEMENT:this.getSetting("placement",""),PLACEMENT_ID:this.getSetting("placementId","")})}supportsLayout(){return false}}function ml(){var e;if((e=top.BX.rest)!=null&&e.AppLayout){const e=top.BX.rest.AppLayout.initializePlacement(this.getSetting("placement",""));if(!e.prototype.reloadData){const t=this.getEntityTypeId();const s=this.getEntityId();e.prototype.reloadData=function(e,i){BX.Crm.EntityEvent.fireUpdate(t,s,"");i()}}}}let gl=e=>e,yl,Ll,fl,Pl,_l,Bl,El,Tl,Il;const Cl=Object.freeze({loaded:"loaded",notLoaded:"notLoaded",loading:"loading"});var Fl=babelHelpers.classPrivateFieldLooseKey("layout");var Sl=babelHelpers.classPrivateFieldLooseKey("settingsModel");var Hl=babelHelpers.classPrivateFieldLooseKey("bindEvents");var Ol=babelHelpers.classPrivateFieldLooseKey("sendOpenFormAnalytics");var Ml=babelHelpers.classPrivateFieldLooseKey("renderLoader");var Nl=babelHelpers.classPrivateFieldLooseKey("render");var wl=babelHelpers.classPrivateFieldLooseKey("sendLinkAction");var Al=babelHelpers.classPrivateFieldLooseKey("sendCopyAnalytics");var Rl=babelHelpers.classPrivateFieldLooseKey("getSharingLink");class Dl extends $e{constructor(...e){super(...e);Object.defineProperty(this,Rl,{value:$l});Object.defineProperty(this,Al,{value:Ul});Object.defineProperty(this,wl,{value:Kl});Object.defineProperty(this,Nl,{value:Xl});Object.defineProperty(this,Ml,{value:jl});Object.defineProperty(this,Ol,{value:xl});Object.defineProperty(this,Hl,{value:kl});Object.defineProperty(this,Fl,{writable:true,value:void 0});Object.defineProperty(this,Sl,{writable:true,value:void 0})}initialize(e,t){babelHelpers.classPrivateFieldLooseBase(this,Fl)[Fl]={};this.dataLoadStatus=Cl.notLoaded;super.initialize(e,t);if(this.supportsLayout()){babelHelpers.classPrivateFieldLooseBase(this,Hl)[Hl]()}}activate(){if(this.supportsLayout()){super.activate();babelHelpers.classPrivateFieldLooseBase(this,Ol)[Ol]()}else{var e,t;(e=BX.UI)==null?void 0:(t=e.InfoHelper)==null?void 0:t.show("limit_crm_calendar_free_slots")}}deactivate(){var e;super.deactivate();(e=babelHelpers.classPrivateFieldLooseBase(this,Fl)[Fl].wrap)==null?void 0:e.reset();this.setLocked(false)}supportsLayout(){return this.getSetting("isAvailable")&&this.getEntityId()>0}onShow(){super.onShow();if(this.dataLoadStatus!==Cl.notLoaded){return}this.loadData().then((e=>{if(e){babelHelpers.classPrivateFieldLooseBase(this,Nl)[Nl]()}}))}async loadData(){this.dataLoadStatus=Cl.loading;const e="crm.api.timeline.calendar.sharing.getConfig";const t={entityTypeId:this.getEntityTypeId(),entityId:this.getEntityId()};return BX.ajax.runAction(e,{data:t}).then((e=>{var t;if(e!=null&&(t=e.data)!=null&&t.config){this.setConfig(e.data.config);this.dataLoadStatus=Cl.loaded;return true}return false}),(e=>{console.error(e);return false}))}setConfig(e){this.link=e.link;this.isResponsible=e.isResponsible;this.isNotificationsAvailable=e.isNotificationsAvailable;this.dealContacts=e.contacts;this.setCommunicationChannels(e.communicationChannels,e.selectedChannelId);babelHelpers.classPrivateFieldLooseBase(this,Sl)[Sl]=new c.SettingsModel({context:"crm",linkHash:this.link.hash,sharingUrl:this.link.url,userInfo:e.userInfo,rule:this.link.rule,calendarSettings:e.calendarSettings,collapsed:false})}save(){return babelHelpers.classPrivateFieldLooseBase(this,wl)[wl]()}createLayout(){babelHelpers.classPrivateFieldLooseBase(this,Fl)[Fl].menuBarItem=document.querySelector(".crm-entity-stream-section-menu [data-id=sharing]");babelHelpers.classPrivateFieldLooseBase(this,Fl)[Fl].root=I.Tag.render(yl||(yl=gl`
			<div class="crm-entity-stream-content-sharing crm-entity-stream-content-wait-detail --hidden">
				${0}
				<div class="crm-entity-stream-calendar-sharing-btn-container">
					${0}
					${0}
					${0}
				</div>
			</div>
		`),babelHelpers.classPrivateFieldLooseBase(this,Ml)[Ml](),this.renderSendButton(),this.renderCopyButton(),this.renderCancelButton());return babelHelpers.classPrivateFieldLooseBase(this,Fl)[Fl].root}createSettingsButton(){babelHelpers.classPrivateFieldLooseBase(this,Fl)[Fl].settingsButton=I.Tag.render(Ll||(Ll=gl`
			<div class="crm-entity-stream-calendar-sharing-settings-icon"></div>
		`));this.updateSettingsButton();I.Event.bind(babelHelpers.classPrivateFieldLooseBase(this,Fl)[Fl].settingsButton,"click",(()=>this.onSettingsButtonClick()));return babelHelpers.classPrivateFieldLooseBase(this,Fl)[Fl].settingsButton}updateSettingsButton(){if(this.hasContacts()){babelHelpers.classPrivateFieldLooseBase(this,Fl)[Fl].settingsButton.style.display=""}else{babelHelpers.classPrivateFieldLooseBase(this,Fl)[Fl].settingsButton.style.display="none"}}renderSendButton(){babelHelpers.classPrivateFieldLooseBase(this,Fl)[Fl].sendButton=new u.Button({text:I.Loc.getMessage("CRM_TIMELINE_CALENDAR_SHARING_SEND_BUTTON_MSGVER_2"),size:u.ButtonSize.EXTRA_SMALL,color:u.ButtonColor.PRIMARY,round:true,onclick:()=>this.onSendButtonClick()}).render();this._saveButton=babelHelpers.classPrivateFieldLooseBase(this,Fl)[Fl].sendButton;return babelHelpers.classPrivateFieldLooseBase(this,Fl)[Fl].sendButton}renderCopyButton(){return new u.Button({text:I.Loc.getMessage("CRM_TIMELINE_CALENDAR_SHARING_COPY_BUTTON"),size:u.ButtonSize.EXTRA_SMALL,color:u.ButtonColor.LIGHT_BORDER,round:true,onclick:()=>this.copyLink()}).render()}renderCancelButton(){const e=new u.Button({text:I.Loc.getMessage("CRM_TIMELINE_CANCEL_BTN"),size:u.ButtonSize.EXTRA_SMALL,color:u.ButtonColor.LINK,onclick:()=>this.onCancelButtonClick()}).render();this._cancelButton=e;return e}onSettingsButtonClick(){this.showSettingsPopup()}async onSendButtonClick(){if(!this.hasDealContacts()){this.showWarningNoContact();return}if(!this.isChannelAvailable(this.channel)&&this.hasPhoneWithoutChannels()){this.showWarningNoCommunicationChannels();return}if(!this.isChannelAvailable(this.channel)&&this.hasEmailWithoutChannels()){this.connectMailbox();return}if(this.isNotificationsAvailable&&this.isChannelBitrix24(this.channel)){const e=await this.isBitrix24Approved();if(e){this.onSaveButtonClick();return}else{this.showWarningNoCommunicationChannels();return}}this.onSaveButtonClick()}onLinkCopied(e){void babelHelpers.classPrivateFieldLooseBase(this,wl)[wl]({isActionCopy:true,linkHash:e})}onRuleUpdated(){this.onRuleUpdatedAction()}showSettingsPopup(){if(this.settingsMenu){this.settingsMenu.destroy()}this.settingsMenu=this.getSettingsMenu();this.settingsMenu.show()}isSettingsPopupShown(){var e;return(e=this.settingsMenu)==null?void 0:e.popupWindow.isShown()}getSettingsMenu(){return P.MenuManager.create({id:"crm-calendar-sharing-settings",bindElement:babelHelpers.classPrivateFieldLooseBase(this,Fl)[Fl].settingsButton,items:this.getSettingsMenuItems()})}getSettingsMenuItems(){const e=[this.getSharingReceiverItem()];if(this.hasChannels()){e.push(this.getSharingChannelsItem())}if(this.isChannelAvailable(this.channel)){e.push(this.getSharingSenderItem())}return e}getSharingReceiverItem(){return{id:"sharing_receiver",text:I.Loc.getMessage("CRM_TIMELINE_CALENDAR_SHARING_RECEIVER"),items:this.contacts.map((e=>this.getContactMenuItem(e)))}}getSharingChannelsItem(){return{id:"sharing_channels",text:I.Loc.getMessage("CRM_TIMELINE_CALENDAR_SHARING_COMMUNICATION_CHANNELS"),items:this.channels.filter((e=>e.contacts.length>0)).map((e=>this.getChannelMenuItem(e)))}}getSharingSenderItem(){return{id:"sharing_sender",text:I.Loc.getMessage("CRM_TIMELINE_CALENDAR_SHARING_SENDER"),items:this.currentFromList.map((e=>this.getFromMenuItem(e)))}}getContactMenuItem(e){const t=e.entityId===this.contact.entityId&&e.entityTypeId===this.contact.entityTypeId&&e.value===this.contact.value;const s=I.Tag.render(fl||(fl=gl`
			<div class="crm-entity-stream-calendar-sharing-settings-check">
				<div>${0}</div>
			</div>
		`),I.Text.encode(`${e.name} (${e.value})`));e.check=I.Tag.render(Pl||(Pl=gl`
			<div class="crm-entity-stream-calendar-sharing-settings-check-icon ${0}"></div>
		`),t?"--show":"");s.append(e.check);return{html:s,onclick:()=>{I.Dom.removeClass(this.contact.check,"--show");I.Dom.addClass(e.check,"--show");this.contact=e}}}getChannelMenuItem(e){const t=e.id===this.channel.id&&this.isChannelAvailable(e);const s=I.Tag.render(_l||(_l=gl`
			<div class="crm-entity-stream-calendar-sharing-settings-check">
				<div>${0}</div>
			</div>
		`),I.Text.encode(e.name));e.check=I.Tag.render(Bl||(Bl=gl`
			<div class="crm-entity-stream-calendar-sharing-settings-check-icon ${0}"></div>
		`),t?"--show":"");s.append(e.check);return{html:s,className:e.fromList.length<=0?"crm-timeline-popup-menu-item-disabled menu-popup-no-icon":"",onclick:()=>{if(e.fromList.length<=0){this.connectMailbox();return}I.Dom.removeClass(this.channel.check,"--show");I.Dom.addClass(e.check,"--show");this.setChannel(e)}}}connectMailbox(){BX.SidePanel.Instance.open("/mail/");const e=()=>{const t=BX.SidePanel.Instance.openSliders[BX.SidePanel.Instance.getOpenSlidersCount()-2];if(t.url.includes("/crm/")){this.updateChannels();top.BX.Event.EventEmitter.unsubscribe("SidePanel.Slider:onClose",e)}};top.BX.Event.EventEmitter.subscribe("SidePanel.Slider:onClose",e)}updateChannels(){const e={entityTypeId:this.getEntityTypeId(),entityId:this.getEntityId()};BX.ajax.runAction("crm.timeline.calendar.sharing.getConfig",{data:e}).then((e=>{this.setCommunicationChannels(e.data.config.communicationChannels,this.channel.id)}))}getFromMenuItem(e){const t=e.id===this.currentFrom.id;const s=I.Tag.render(El||(El=gl`
			<div class="crm-entity-stream-calendar-sharing-settings-check">
				<div>${0}</div>
			</div>
		`),I.Text.encode(e.name));e.check=I.Tag.render(Tl||(Tl=gl`
			<div class="crm-entity-stream-calendar-sharing-settings-check-icon ${0}"></div>
		`),t?"--show":"");s.append(e.check);return{html:s,onclick:()=>{I.Dom.removeClass(this.currentFrom.check,"--show");I.Dom.addClass(e.check,"--show");this.currentFrom=e}}}showWarningNoCommunicationChannels(){let e;let t;if(this.isNotificationsAvailable){e=I.Loc.getMessage("CRM_TIMELINE_CALENDAR_SHARING_NO_COMMUNICATION_CHANNELS_WARNING_TITLE");t=`\n\t\t\t\t<div>${I.Loc.getMessage("CRM_TIMELINE_CALENDAR_SHARING_NO_COMMUNICATION_CHANNELS_WARNING_TEXT_1")}</div>\n\t\t\t\t</br>\n\t\t\t\t<div>${I.Loc.getMessage("CRM_TIMELINE_CALENDAR_SHARING_NO_COMMUNICATION_CHANNELS_WARNING_TEXT_2")}</div>\n\t\t\t`}else{e=I.Loc.getMessage("CRM_TIMELINE_CALENDAR_SHARING_NO_CUSTOM_COMMUNICATION_CHANNELS_WARNING_TITLE");t=`\n\t\t\t\t<div>${I.Loc.getMessage("CRM_TIMELINE_CALENDAR_SHARING_NO_CUSTOM_COMMUNICATION_CHANNELS_WARNING_TITLE_1").replaceAll("/marketplace/",I.Loc.getMessage("MARKET_BASE_PATH"))}</div>\n\t\t\t\t</br>\n\t\t\t\t<div>${I.Loc.getMessage("CRM_TIMELINE_CALENDAR_SHARING_NO_COMMUNICATION_CHANNELS_WARNING_TEXT_2")}</div>\n\t\t\t`}const s=this.getWarningGuide(e,t);s.showNextStep();const i=s.getPopup();const a=i.getContentContainer();const l=a.querySelector("span[data-role=crm-timeline-calendar-sharing_open-configure-slots]");l.addEventListener("click",(()=>{i.close()}))}showWarningNoContact(){const e=I.Loc.getMessage("CRM_TIMELINE_CALENDAR_SHARING_NO_CONTACT_WARNING_TITLE");const t=I.Loc.getMessage("CRM_TIMELINE_CALENDAR_SHARING_NO_CONTACT_WARNING_TEXT_V2");const s=this.getWarningGuide(e,t);s.showNextStep()}async copyLink(){this.setLocked(true);const e=await babelHelpers.classPrivateFieldLooseBase(this,Rl)[Rl]();babelHelpers.classPrivateFieldLooseBase(this,Fl)[Fl].wrap.copyLink(e.url,e.hash);babelHelpers.classPrivateFieldLooseBase(this,Al)[Al]()}async saveJointLink(){const e=await BX.ajax.runAction("crm.api.timeline.calendar.sharing.generateJointSharingLink",{data:{memberIds:babelHelpers.classPrivateFieldLooseBase(this,Sl)[Sl].getMemberIds(),entityId:this.getEntityId(),entityTypeId:this.getEntityTypeId()}});return e.data}onRuleUpdatedAction(){return BX.ajax.runAction("crm.api.timeline.calendar.sharing.onRuleUpdated",{data:{linkHash:this.link.hash,ownerId:this.getEntityId(),ownerTypeId:this.getEntityTypeId()}}).then((e=>{}),(e=>{console.error(e);return false}))}onContactsChangedHandler(e){var t;const{item:s,current:i}=e.getData();const a=this.getEntityTypeId()===(s==null?void 0:s.entityTypeId)&&this.getEntityId()===(s==null?void 0:s.entityId);if(!a||!I.Type.isArray(i)||!I.Type.isArray(this.channels)){return}const l=i.map((e=>{var t;return{id:e.address.id,entityId:e.addressSource.entityId,entityTypeId:e.addressSource.entityTypeId,name:(t=e.addressSourceData)==null?void 0:t.title,value:e.address.value,valueType:e.address.valueType,typeId:e.address.typeId}}));this.dealContacts=l;const n=l.filter((e=>e.typeId==="PHONE"));const r=l.filter((e=>e.typeId==="EMAIL"));this.channels.forEach((e=>{if(e.typeId==="PHONE"){e.contacts=n}if(e.typeId==="EMAIL"){e.contacts=r}}));this.setChannel(this.chooseChannel((t=this.channel)==null?void 0:t.id));this.updateSettingsButton();if(this.isSettingsPopupShown()){this.showSettingsPopup()}}setContacts(e){var t;this.contacts=e.filter((e=>e.entityId&&e.entityTypeId&&e.value&&e.name)).sort(((e,t)=>e.entityId-t.entityId)).sort(((e,t)=>e.entityTypeId-t.entityTypeId));this.contact=(t=e.find((e=>{var t,s;return e.entityTypeId===((t=this.contact)==null?void 0:t.entityTypeId)&&e.entityId===((s=this.contact)==null?void 0:s.entityId)})))!=null?t:this.contacts[0]}setCommunicationChannels(e,t){this.channels=e||[];this.setChannel(this.chooseChannel(t))}chooseChannel(e){const t=this.channels.filter((e=>this.isChannelAvailable(e)));if(e&&I.Type.isArrayFilled(t)){var s;return(s=t.find((t=>t.id===e)))!=null?s:t[0]}const i=this.channels.filter((e=>e.contacts.length>0));return i==null?void 0:i[0]}setChannel(e){if(!e){return}this.channel=e;this.setContacts(this.channel.contacts);if(this.channel&&this.channel.fromList){this.currentFromList=this.channel.fromList;this.currentFrom=this.channel.fromList[0]}if(this.settingsMenu){for(const e of this.getSettingsMenuItems()){this.settingsMenu.removeMenuItem(e.id);this.settingsMenu.addMenuItem(e)}}}hasContacts(){return I.Type.isArrayFilled(this.contacts)}hasDealContacts(){return I.Type.isArrayFilled(this.dealContacts)}hasChannels(){return I.Type.isArrayFilled(this.channels)}hasPhoneWithoutChannels(){if(!this.channel){return true}const e=this.dealContacts.filter((e=>e.typeId==="PHONE"));const t=this.channels.filter((e=>e.typeId==="PHONE"));const s=this.channel.typeId==="PHONE"&&!this.isChannelAvailable(this.channel);return I.Type.isArrayFilled(e)&&!I.Type.isArrayFilled(t)||s}hasEmailWithoutChannels(){if(!this.channel){return true}const e=this.dealContacts.filter((e=>e.typeId==="EMAIL"));const t=this.channels.filter((e=>e.typeId==="EMAIL"));const s=this.channel.typeId==="EMAIL"&&!this.isChannelAvailable(this.channel);return I.Type.isArrayFilled(e)&&!I.Type.isArrayFilled(t)||s}isChannelAvailable(e){return I.Type.isArrayFilled(e==null?void 0:e.fromList)&&I.Type.isArrayFilled(e==null?void 0:e.contacts)}isChannelBitrix24(e){return e.id===h.Types.bitrix24}async isBitrix24Approved(){return await h.ConditionChecker.checkIsApproved({senderType:h.Types.bitrix24})}getWarningGuide(e,t){const s=new p.Guide({simpleMode:true,onEvents:true,steps:[{target:babelHelpers.classPrivateFieldLooseBase(this,Fl)[Fl].sendButton,title:e,text:t,condition:{top:false,bottom:true,color:"warning"}}]});const i=s.getPopup();I.Dom.addClass(i.popupContainer,"crm-calendar-sharing-configure-slots-popup-ui-tour-animate");i.setWidth(430);const a=i.getContentContainer().firstElementChild;const l=parseInt(getComputedStyle(i.closeIcon)["width"]);const n=parseInt(getComputedStyle(a)["paddingRight"]);i.getContentContainer().style.paddingRight=l-n+"px";i.setAutoHide(true);i.subscribe("onAfterShow",(()=>{setTimeout((()=>{const e=i.angle.element;const t=e.firstElementChild;t.style.border="2px solid var(--ui-color-text-warning, #ffa900)";if(i.getContentContainer().getBoundingClientRect().top>babelHelpers.classPrivateFieldLooseBase(this,Fl)[Fl].sendButton.getBoundingClientRect().top){const t=i.getContentContainer().querySelector(".ui-tour-popup-condition-bottom");t.className="ui-tour-popup-condition-top";e.style.top="-20px"}else{e.style.bottom="-18px"}}),0)}));return s}}function kl(){E.EventEmitter.subscribe("CalendarSharing:LinkCopied",(({data:{hash:e}})=>this.onLinkCopied(e)));E.EventEmitter.subscribe("CalendarSharing:RuleUpdated",(()=>this.onRuleUpdated()));E.EventEmitter.subscribe("BX.Crm.MessageSender.ReceiverRepository:OnReceiversChanged",this.onContactsChangedHandler.bind(this));I.Event.bind(window,"beforeunload",(()=>{var e;return(e=babelHelpers.classPrivateFieldLooseBase(this,Sl)[Sl])==null?void 0:e.save()}))}function xl(){d.Analytics.sendPopupOpened(d.Analytics.contexts.crm)}function jl(){babelHelpers.classPrivateFieldLooseBase(this,Fl)[Fl].loader=I.Tag.render(Il||(Il=gl`
			<div class="crm-entity-stream-content-sharing-loader"></div>
		`));(new b.Loader).show(babelHelpers.classPrivateFieldLooseBase(this,Fl)[Fl].loader);return babelHelpers.classPrivateFieldLooseBase(this,Fl)[Fl].loader}function Xl(){babelHelpers.classPrivateFieldLooseBase(this,Fl)[Fl].wrap=new c.Layout({readOnly:!this.isResponsible,settingsModel:babelHelpers.classPrivateFieldLooseBase(this,Sl)[Sl],externalIcon:this.createSettingsButton()});const e=babelHelpers.classPrivateFieldLooseBase(this,Fl)[Fl].wrap.render();babelHelpers.classPrivateFieldLooseBase(this,Fl)[Fl].loader.replaceWith(e);return e}async function Kl({isActionCopy:e,linkHash:t}={}){const s={ownerId:this.getEntityId(),ownerTypeId:this.getEntityTypeId(),ruleArray:babelHelpers.classPrivateFieldLooseBase(this,Sl)[Sl].getRule().toArray(),memberIds:babelHelpers.classPrivateFieldLooseBase(this,Sl)[Sl].getMemberIds()};let i;if(!e&&this.isChannelAvailable(this.channel)){i="crm.api.timeline.calendar.sharing.sendLink";s.contactId=this.contact.entityId||null;s.contactTypeId=this.contact.entityTypeId||null;s.channelId=this.channel.id||null;s.senderId=this.currentFrom.id||null}else{i="crm.api.timeline.calendar.sharing.onLinkCopied";s.linkHash=t!=null?t:this.link.hash}return BX.ajax.runAction(i,{data:s}).then((e=>{if(e.data){this.emitFinishEditEvent();return true}return false}),(e=>{console.error(e);return false}))}function Ul(){const e={peopleCount:babelHelpers.classPrivateFieldLooseBase(this,Sl)[Sl].getMemberIds().length,ruleChanges:babelHelpers.classPrivateFieldLooseBase(this,Sl)[Sl].getChanges()};const t=babelHelpers.classPrivateFieldLooseBase(this,Sl)[Sl].getMemberIds().length===1?d.Analytics.linkTypes.solo:d.Analytics.linkTypes.multiple;d.Analytics.sendLinkCopied(babelHelpers.classPrivateFieldLooseBase(this,Sl)[Sl].getContext(),t,e)}async function $l(){if(babelHelpers.classPrivateFieldLooseBase(this,Sl)[Sl].getMemberIds().length===1){return{url:babelHelpers.classPrivateFieldLooseBase(this,Sl)[Sl].getSharingUrl(),hash:babelHelpers.classPrivateFieldLooseBase(this,Sl)[Sl].getLinkHash()}}return await this.saveJointLink()}let Gl=e=>e,Vl;var Wl=babelHelpers.classPrivateFieldLooseKey("isRendered");var zl=babelHelpers.classPrivateFieldLooseKey("editor");var ql=babelHelpers.classPrivateFieldLooseKey("renderEditor");var Yl=babelHelpers.classPrivateFieldLooseKey("shouldRender");var Jl=babelHelpers.classPrivateFieldLooseKey("bindEvents");var Zl=babelHelpers.classPrivateFieldLooseKey("setState");class Ql extends j{constructor(...e){super(...e);Object.defineProperty(this,Zl,{value:an});Object.defineProperty(this,Jl,{value:sn});Object.defineProperty(this,Yl,{value:tn});Object.defineProperty(this,ql,{value:en});Object.defineProperty(this,Wl,{writable:true,value:false});Object.defineProperty(this,zl,{writable:true,value:null})}createLayout(){const e=I.Tag.render(Vl||(Vl=Gl`<div class="crm-entity-stream-content-new-detail --hidden"></div>`));if(!babelHelpers.classPrivateFieldLooseBase(this,Yl)[Yl]()){return e}const t=new BX.Crm.MessageSender.Editor.Skeleton.Skeleton({layout:this.getSetting("editor").layout});t.renderTo(e);for(const e of this.getSetting("tours",[])){if(I.Type.isStringFilled(e)){I.Runtime.html(null,e)}}return e}onShow(){super.onShow();void babelHelpers.classPrivateFieldLooseBase(this,ql)[ql]()}shouldConfirmStateChange(e){var t,s;if(!babelHelpers.classPrivateFieldLooseBase(this,Wl)[Wl]){return false}const{text:i,template:a}=e;const l=(t=(s=babelHelpers.classPrivateFieldLooseBase(this,zl)[zl])==null?void 0:s.getState())!=null?t:{};const n=I.Type.isNil(l.notificationTemplate)&&I.Type.isNil(l.template);const r=I.Type.isNil(a)&&I.Type.isStringFilled(i);if(!n&&r){return true}if(n&&r){return I.Type.isStringFilled(l.message.body.trim())&&l.message.body.trim()!==i.trim()}if(n&&!r){return I.Type.isStringFilled(l.message.body.trim())}if(!n&&!r){var o,c,d,h;const e=a==null?void 0:a.ORIGINAL_ID;const t=(o=a==null?void 0:a.FILLED_PLACEHOLDERS)!=null?o:[];const s=(c=l.template)==null?void 0:c.ORIGINAL_ID;const i=(d=(h=l.template)==null?void 0:h.FILLED_PLACEHOLDERS)!=null?d:[];return I.Type.isNumber(e)&&e>0&&I.Type.isNumber(s)&&s>0&&(e!==s||JSON.stringify(t)!==JSON.stringify(i))}throw new Error("Unexpected state in BX.Crm.Timeline.MenuBar.Item.Message.#shouldConfirmStateChange")}async tryToResend(e){var t,s;await babelHelpers.classPrivateFieldLooseBase(this,ql)[ql]();babelHelpers.classPrivateFieldLooseBase(this,Zl)[Zl](e);const i=babelHelpers.classPrivateFieldLooseBase(this,zl)[zl].getState();const a=this.getSetting("analytics",{});const{Builder:l,sendData:n}=await I.Runtime.loadExtension("crm.integration.analytics","ui.analytics");const r=l.Communication.Editor.ResendEvent.createDefault((t=i.channel)==null?void 0:t.id).setSection(a.c_section).setSubSection(a.c_sub_section).setTemplateId((s=i.template)==null?void 0:s.ORIGINAL_ID).buildData();n(r)}}async function en(){if(babelHelpers.classPrivateFieldLooseBase(this,Wl)[Wl]){return}if(!babelHelpers.classPrivateFieldLooseBase(this,Yl)[Yl]()){return}const{Editor:e}=await I.Runtime.loadExtension("crm.messagesender.editor");babelHelpers.classPrivateFieldLooseBase(this,zl)[zl]=new e({...this.getSetting("editor"),renderTo:this.getContainer()});await babelHelpers.classPrivateFieldLooseBase(this,zl)[zl].render();babelHelpers.classPrivateFieldLooseBase(this,Wl)[Wl]=true;babelHelpers.classPrivateFieldLooseBase(this,Jl)[Jl]();if(I.Type.isArrayFilled(babelHelpers.classPrivateFieldLooseBase(this,zl)[zl].getOptions().promoBanners)){E.EventEmitter.emit("BX.Crm.Timeline.MenuBar.Message:ShowNewChannelsAvailableTour",{stepId:"menubar-message-new-channels-available",target:this.getContainer().querySelector('[data-role="header-left"]')})}}function tn(){return Boolean(this.getSetting("shouldRender"))}function sn(){E.EventEmitter.subscribe("BX.Crm.MessageSender.ReceiverRepository:OnReceiversChanged",(e=>{var t;const{item:s}=e.getData();if(this.getEntityTypeId()!==(s==null?void 0:s.entityTypeId)||this.getEntityId()!==(s==null?void 0:s.entityId)){return}void((t=babelHelpers.classPrivateFieldLooseBase(this,zl)[zl])==null?void 0:t.reload())}));E.EventEmitter.subscribeOnce("BX.Crm.Tour.EntityDetailsMenubar.Message:onConnectionsSliderClose",(async()=>{var e;void((e=babelHelpers.classPrivateFieldLooseBase(this,zl)[zl])==null?void 0:e.reload());const t=this.getSetting("analytics",{});const{Builder:s,Dictionary:i,sendData:a}=await I.Runtime.loadExtension("crm.integration.analytics","ui.analytics");const l=(new s.Communication.Channel.ConnectEvent).setSection(t.c_section).setSubSection(t.c_sub_section).setElement(i.ELEMENT_AHA_MOMENT);a(l.buildData())}));const e=()=>{setTimeout((()=>this.emitFinishEditEvent()),50)};babelHelpers.classPrivateFieldLooseBase(this,zl)[zl].subscribe("onSendSuccess",e);babelHelpers.classPrivateFieldLooseBase(this,zl)[zl].subscribe("onCancel",e)}function an(e){var t;if(!babelHelpers.classPrivateFieldLooseBase(this,Wl)[Wl]){return}if(I.Type.isStringFilled(e==null?void 0:(t=e.backend)==null?void 0:t.senderCode)&&I.Type.isStringFilled(e==null?void 0:e.backend.id)){const t=babelHelpers.classPrivateFieldLooseBase(this,zl)[zl].getOptions().channels.find((t=>{const s=t.backend.senderCode===e.backend.senderCode&&t.backend.id===e.backend.id;if(I.Type.isStringFilled(e==null?void 0:e.fromId)){return s&&t.fromList.some((t=>t.id===e.fromId))}return s}));if(t){babelHelpers.classPrivateFieldLooseBase(this,zl)[zl].setChannel(t.id);if(I.Type.isStringFilled(e==null?void 0:e.fromId)){babelHelpers.classPrivateFieldLooseBase(this,zl)[zl].setFrom(e.fromId)}}}if(I.Type.isPlainObject(e==null?void 0:e.client)){const t=babelHelpers.classPrivateFieldLooseBase(this,zl)[zl].getState().channel;const s=t.toList.find((t=>t.addressSource.entityTypeId===e.client.entityTypeId&&t.addressSource.entityId===e.client.entityId&&t.address.value===e.client.value));if(s){babelHelpers.classPrivateFieldLooseBase(this,zl)[zl].setTo(s.address.id)}}if(I.Type.isStringFilled(e==null?void 0:e.text)){babelHelpers.classPrivateFieldLooseBase(this,zl)[zl].setMessageText(e.text)}if(I.Type.isPlainObject(e==null?void 0:e.template)){babelHelpers.classPrivateFieldLooseBase(this,zl)[zl].setTemplate(e.template.ORIGINAL_ID);for(const t of(s=(i=e.template)==null?void 0:i.FILLED_PLACEHOLDERS)!=null?s:[]){var s,i;babelHelpers.classPrivateFieldLooseBase(this,zl)[zl].setFilledPlaceholder(t)}}}let ln=e=>e,nn,rn,on,cn,dn,hn,un,pn,bn,vn,mn,gn,yn,Ln;var fn=babelHelpers.classPrivateFieldLooseKey("renderEditor");var Pn=babelHelpers.classPrivateFieldLooseKey("renderSetupText");var _n=babelHelpers.classPrivateFieldLooseKey("renderTemplatesContainer");var Bn=babelHelpers.classPrivateFieldLooseKey("renderFilesSelector");var En=babelHelpers.classPrivateFieldLooseKey("subscribeToReceiversChanges");var Tn=babelHelpers.classPrivateFieldLooseKey("prepareToResend");class In extends $e{constructor(...e){super(...e);Object.defineProperty(this,Tn,{value:Mn});Object.defineProperty(this,En,{value:On});Object.defineProperty(this,Bn,{value:Hn});Object.defineProperty(this,_n,{value:Sn});Object.defineProperty(this,Pn,{value:Fn});Object.defineProperty(this,fn,{value:Cn});this.isFetchedConfig=false;this.fetchConfigPromise=null}createLayout(){return I.Tag.render(nn||(nn=ln`<div class="crm-entity-stream-content-new-detail crm-entity-stream-content-sms --skeleton --hidden"></div>`))}doInitialize(){this._isRequestRunning=false;this._isLocked=false;this._senderId=null;this._from=null;this._commEntityTypeId=null;this._commEntityId=null;this._to=null;this._fromList=[];this._toList=[];this._defaults={};this._communications=[];this._menu=null;this._isMenuShown=false;this._shownMenuId=null;this._documentSelector=null;this._source=null;this._paymentId=null;this._shipmentId=null;this._compilationProductIds=[];this._templateId=null;this.templateOriginalId=null;this._templateFieldHintNode=null;this._templateSelectorNode=null;this._templateTemplateTitleNode=null;this._templatePreviewNode=null;this._templateSelectorMenuId="CrmTimelineSmsEditorTemplateSelector";this._templateFieldHintHandler=BX.delegate(this.onTemplateHintIconClick,this);this._templateSeletorClickHandler=BX.delegate(this.onTemplateSelectClick,this);this._selectTemplateHandler=BX.delegate(this.onSelectTemplate,this);this._serviceUrl=BX.util.remove_url_param(this.getSetting("serviceUrl",""),["sessid","site"]);const e=this.getSetting("smsConfig",{});this._canUse=BX.prop.getBoolean(e,"canUse",false);this._canSendMessage=BX.prop.getBoolean(e,"canSendMessage",false);this._manageUrl=BX.prop.getString(e,"manageUrl","");this._senders=BX.prop.getArray(e,"senders",[]);this._defaults=BX.prop.getObject(e,"defaults",{senderId:null,from:null});this._communications=BX.prop.getArray(e,"communications",[]);this._isSalescenterEnabled=BX.prop.getBoolean(e,"isSalescenterEnabled",false);this._isDocumentsEnabled=BX.prop.getBoolean(e,"isDocumentsEnabled",false);if(this._isDocumentsEnabled){this._documentsProvider=BX.prop.getString(e,"documentsProvider","");this._documentsValue=BX.prop.getString(e,"documentsValue","")}this._isFilesEnabled=BX.prop.getBoolean(e,"isFilesEnabled",false);if(this._isFilesEnabled){this._diskUrls=BX.prop.getObject(e,"diskUrls");this._isFilesExternalLinkEnabled=BX.prop.getBoolean(e,"isFilesExternalLinkEnabled",true)}this._senderSelectorNode=this.getContainer().querySelector('[data-role="sender-selector"]');this._fromContainerNode=this.getContainer().querySelector('[data-role="from-container"]');this._fromSelectorNode=this.getContainer().querySelector('[data-role="from-selector"]');this._clientContainerNode=this.getContainer().querySelector('[data-role="client-container"]');this._clientSelectorNode=this.getContainer().querySelector('[data-role="client-selector"]');this._toSelectorNode=this.getContainer().querySelector('[data-role="to-selector"]');this._messageLengthCounterWrapperNode=this.getContainer().querySelector('[data-role="message-length-counter-wrap"]');this._messageLengthCounterNode=this.getContainer().querySelector('[data-role="message-length-counter"]');this._salescenterStarter=this.getContainer().querySelector('[data-role="salescenter-starter"]');this._smsDetailSwitcher=this.getContainer().querySelector('[data-role="sms-detail-switcher"]');this._smsDetail=this.getContainer().querySelector('[data-role="sms-detail"]');this._documentSelectorButton=this.getContainer().querySelector('[data-role="sms-document-selector"]');this._fileSelectorButton=this.getContainer().querySelector('[data-role="sms-file-selector"]');this._fileUploadZone=this.getContainer().querySelector('[data-role="sms-file-upload-zone"]');this._fileUploadLabel=this.getContainer().querySelector('[data-role="sms-file-upload-label"]');this._fileSelectorBitrix=this.getContainer().querySelector('[data-role="sms-file-selector-bitrix"]');this._fileExternalLinkDisabledContent=this.getContainer().querySelector('[data-role="sms-file-external-link-disabled"]');if(this._templatesContainer){this._templateFieldHintNode=this._templatesContainer.querySelector('[data-role="hint"]');this._templateSelectorNode=this._templatesContainer.querySelector('[data-role="template-selector"]');this._templateTemplateTitleNode=this._templatesContainer.querySelector('[data-role="template-title"]');this._templatePreviewNode=this._templatesContainer.querySelector('[data-role="preview"]')}if(this._templateFieldHintNode){BX.bind(this._templateFieldHintNode,"click",this._templateFieldHintHandler)}if(this._templateSelectorNode){BX.bind(this._templateSelectorNode,"click",this._templateSeletorClickHandler)}if(this._canUse&&this._senders.length>0){this.initSenderSelector()}if(this._canUse&&this._canSendMessage){this.initDetailSwitcher();this.initFromSelector();this.initClientContainer();this.initClientSelector();this.initToSelector();this.initMessageLengthCounter();this.setMessageLengthCounter();if(this._isDocumentsEnabled){this.initDocumentSelector()}if(this._isFilesEnabled){this.initFileSelector()}}babelHelpers.classPrivateFieldLooseBase(this,En)[En]();if(this._isSalescenterEnabled){this.initSalescenterApplication()}}initDetailSwitcher(){BX.bind(this._smsDetailSwitcher,"click",function(){if(this._smsDetail.classList.contains("hidden")){this._smsDetail.classList.remove("hidden");this._smsDetailSwitcher.innerText=BX.message("CRM_TIMELINE_COLLAPSE")}else{this._smsDetail.classList.add("hidden");this._smsDetailSwitcher.innerText=BX.message("CRM_TIMELINE_DETAILS")}}.bind(this))}initSenderSelector(){const e=this._defaults.senderId;let t=this._senders[0].canUse?this._senders[0]:null;let s=null;const i=[];const a=this.onSenderSelectorClick.bind(this);for(let l=0;l<this._senders.length;++l){if(this._senders[l].canUse&&this._senders[l].fromList.length&&(this._senders[l].id===e||!t)){t=this._senders[l]}if(this._senders[l].id==="rest"){s=this._senders[l];continue}i.push({text:this._senders[l].name,sender:this._senders[l],onclick:a,className:!this._senders[l].canUse||!this._senders[l].fromList.length?"crm-timeline-popup-menu-item-disabled menu-popup-no-icon":""})}if(s){if(s.fromList.length>0){i.push({delimiter:true});for(let e=0;e<s.fromList.length;++e){i.push({text:s.fromList[e].name,sender:s,from:s.fromList[e],onclick:a})}}i.push({delimiter:true},{text:BX.message("CRM_TIMELINE_SMS_REST_MARKETPLACE"),href:BX.message("MARKET_BASE_PATH")+"category/crm_robot_sms/",target:"_blank"})}if(t){this.setSender(t)}BX.bind(this._senderSelectorNode,"click",this.openMenu.bind(this,"sender",this._senderSelectorNode,i))}onSenderSelectorClick(e,t){if(t.sender){if(!t.sender.canUse||!t.sender.fromList.length){const e=BX.Uri.addParam(t.sender.manageUrl,{IFRAME:"Y"});const s=BX.SidePanel.Instance.getTopSlider();const i={events:{onClose:function(){if(s){s.reload()}},onCloseComplete:function(){if(!s){document.location.reload()}}}};if(t.sender.id==="ednaru"){i.width=700}BX.SidePanel.Instance.open(e,i);return}this.setSender(t.sender,true);const e=t.from?t.from:t.sender.fromList[0];this.setFrom(e,true)}this._menu.close()}setSender(e,t){this._senderId=e.id;this._fromList=e.fromList;this._senderSelectorNode.textContent=e.shortName?e.shortName:e.name;this._templateId=null;this.templateOriginalId=null;if(e.isTemplatesBased){this.showNode(this._templatesContainer);this.hideNode(this._messageLengthCounterWrapperNode);this.hideNode(this._fileSelectorButton);this.hideNode(this._documentSelectorButton);this.hideNode(this._input);this.toggleTemplateSelectAvailability();this.toggleSaveButton();this._hideButtonsOnBlur=false;this.onFocus()}else{this.hideNode(this._templatesContainer);this.showNode(this._messageLengthCounterWrapperNode);this.showNode(this._fileSelectorButton);this.showNode(this._documentSelectorButton);this.showNode(this._input);this.setMessageLengthCounter();this._hideButtonsOnBlur=true}const s=e.id==="rest"?"hide":"show";BX[s](this._fromContainerNode);if(t){BX.userOptions.save("crm","sms_manager_editor","senderId",this._senderId)}}initFromSelector(){if(this._fromList.length>0){const e=this._defaults.from||this._fromList[0].id;let t=null;for(let s=0;s<this._fromList.length;++s){if(this._fromList[s].id===e||!t){t=this._fromList[s]}}if(t){this.setFrom(t)}}BX.bind(this._fromSelectorNode,"click",this.onFromSelectorClick.bind(this))}onFromSelectorClick(e){const t=[];const s=this.onFromSelectorItemClick.bind(this);for(let e=0;e<this._fromList.length;++e){t.push({text:this._fromList[e].name,from:this._fromList[e],onclick:s})}this.openMenu("from_"+this._senderId,this._fromSelectorNode,t,e)}onFromSelectorItemClick(e,t){if(t.from){this.setFrom(t.from,true)}this._menu.close()}setFrom(e,t){this._from=e.id;if(this._senderId==="rest"){this._senderSelectorNode.textContent=e.name}else{this._fromSelectorNode.textContent=e.name}if(t){BX.userOptions.save("crm","sms_manager_editor","from",this._from)}}initClientContainer(){if(!I.Type.isDomNode(this._clientContainerNode)){return}if(this._communications.length===0){BX.hide(this._clientContainerNode)}else{BX.show(this._clientContainerNode)}}initClientSelector(){const e=this._communications[0];if(e){this.setClient(e)}const t=this.onClientSelectorClick.bind(this);BX.bind(this._clientSelectorNode,"click",(e=>{const s=[];for(const e of this._communications){s.push({text:e.caption,client:e,onclick:t})}this.openMenu("comm",this._clientSelectorNode,s,e)}))}onClientSelectorClick(e,t){if(t.client){this.setClient(t.client)}this._menu.close()}setClient(e){var t,s;this._commEntityTypeId=e==null?void 0:e.entityTypeId;this._commEntityId=e==null?void 0:e.entityId;if(I.Type.isDomNode(this._clientSelectorNode)){var i;this._clientSelectorNode.textContent=(i=e==null?void 0:e.caption)!=null?i:""}this._toList=(t=e==null?void 0:e.phones)!=null?t:[];this.setTo((s=e==null?void 0:e.phones[0])!=null?s:{})}initToSelector(){BX.bind(this._toSelectorNode,"click",this.onToSelectorClick.bind(this))}onToSelectorClick(e){const t=[];const s=this.onToSelectorItemClick.bind(this);for(let e=0;e<this._toList.length;++e){t.push({text:this._toList[e].valueFormatted||this._toList[e].value,to:this._toList[e],onclick:s})}this.openMenu("to_"+this._commEntityTypeId+"_"+this._commEntityId,this._toSelectorNode,t,e)}onToSelectorItemClick(e,t){if(t.to){this.setTo(t.to)}this._menu.close()}setTo(e){this._to=e==null?void 0:e.value;if(I.Type.isDomNode(this._toSelectorNode)){var t;this._toSelectorNode.textContent=(t=(e==null?void 0:e.valueFormatted)||(e==null?void 0:e.value))!=null?t:""}}openMenu(e,t,s,i){if(this._shownMenuId===e){return}if(this._shownMenuId!==null&&this._menu){this._menu.close();this._shownMenuId=null}BX.PopupMenu.show(this._id+e,t,s,{cacheable:false,offsetTop:0,offsetLeft:36,angle:{position:"top",offset:0},events:{onPopupClose:BX.delegate(this.onMenuClose,this)}});this._menu=BX.PopupMenu.currentItem;i.preventDefault()}onMenuClose(){this._shownMenuId=null;this._menu=null}initMessageLengthCounter(){this._messageLengthMax=parseInt(this._messageLengthCounterNode.getAttribute("data-length-max"));BX.bind(this._input,"keyup",this.setMessageLengthCounter.bind(this));BX.bind(this._input,"cut",this.setMessageLengthCounterDelayed.bind(this));BX.bind(this._input,"paste",this.setMessageLengthCounterDelayed.bind(this))}setMessageLengthCounterDelayed(){setTimeout(this.setMessageLengthCounter.bind(this),0)}setMessageLengthCounter(){const e=this._input.value.length;this._messageLengthCounterNode.textContent=e;const t=e>=this._messageLengthMax?"addClass":"removeClass";BX[t](this._messageLengthCounterNode,"crm-entity-stream-content-sms-symbol-counter-number-overhead");this.toggleSaveButton()}toggleSaveButton(){const e=this.getSelectedSender();let t;if(!e||!e.isTemplatesBased){t=this._input.value.length>0}else{t=!!this._templateId}if(t){BX.removeClass(this._saveButton,"ui-btn-disabled")}else{BX.addClass(this._saveButton,"ui-btn-disabled")}}save(){const e=this.getSelectedSender();const{text:t,templateId:s}=this.getSendData();if(t===""){return}if(!this._communications.length){alert(BX.message("CRM_TIMELINE_SMS_ERROR_NO_COMMUNICATIONS"));return}if(this._isRequestRunning||this._isLocked){return}this._isRequestRunning=true;this._isLocked=true;return new Promise(((e,i)=>{BX.ajax({url:this.getSendUrl(),method:"POST",dataType:"json",data:{site:BX.message("SITE_ID"),sessid:BX.bitrix_sessid(),source:this._source,ACTION:"SAVE_SMS_MESSAGE",SENDER_ID:this._senderId,MESSAGE_FROM:this._from,MESSAGE_TO:this._to,MESSAGE_BODY:t,MESSAGE_TEMPLATE:s,MESSAGE_TEMPLATE_WITH_PLACEHOLDER:this.isCurrentSenderTemplateHasPlaceholders(),OWNER_TYPE_ID:this._ownerTypeId,OWNER_ID:this._ownerId,TO_ENTITY_TYPE_ID:this._commEntityTypeId,TO_ENTITY_ID:this._commEntityId,PAYMENT_ID:this._paymentId,SHIPMENT_ID:this._shipmentId,COMPILATION_PRODUCT_IDS:this._compilationProductIds},onsuccess:()=>{this.onSaveSuccess();e()},onfailure:()=>{this.onSaveFailure();i()}})}))}getSendData(){if(!this.isFetchedConfig){return{text:"",templateId:null}}let e="";let t=null;if(this.isCurrentSenderIsTemplatesBased()){const s=this.getSelectedTemplate();if(!s){return null}if(this.tplEditor){const t=this.tplEditor.getData();if(I.Type.isPlainObject(t)){e=t.body}}if(e===""){e=s.PREVIEW}t=s.ID}else{e=this._input.value}return{text:e,templateId:t}}getSendUrl(){return BX.util.add_url_param(this._serviceUrl,{action:"save_sms_message",sender:this._senderId})}getSelectedSender(){return this._senders.find((e=>e.id===this._senderId))}cancel(){this._input.value="";this.setMessageLengthCounter();this._input.style.minHeight="";this.release()}onSaveSuccess(e){this._isRequestRunning=this._isLocked=false;const t=BX.prop.getString(e,"ERROR","");if(t!==""){alert(t);return}this._input.value="";this.setMessageLengthCounter();this._input.style.minHeight="";this.emitFinishEditEvent();this.release()}onSaveFailure(){this._isRequestRunning=this._isLocked=false}initSalescenterApplication(){BX.bind(this._salescenterStarter,"click",this.startSalescenterApplication.bind(this))}startSalescenterApplication(){const e=BX.prop.getBoolean(this.getSetting("smsConfig",{}),"isSalescenterToolEnabled",false);if(!e){BX.loadExt("salescenter.tool-availability-manager").then((()=>{BX.Salescenter.ToolAvailabilityManager.openSalescenterToolDisabledSlider()}));return}BX.loadExt("salescenter.manager").then(function(){BX.Salescenter.Manager.openApplication({disableSendButton:this._canSendMessage?"":"y",context:"sms",ownerTypeId:this._ownerTypeId,ownerId:this._ownerId,mode:this._ownerTypeId===BX.CrmEntityType.enumeration.deal?"payment_delivery":"payment",st:{tool:"crm",category:"payments",event:"payment_create_click",c_section:"crm_sms",c_sub_section:"web",type:"delivery_payment"}}).then(function(e){if(e&&e.get("action")){if(e.get("action")==="sendPage"&&e.get("page")&&e.get("page").url){this._input.focus();this._input.value=this._input.value+e.get("page").name+" "+e.get("page").url;this.setMessageLengthCounter()}else if(e.get("action")==="sendPayment"&&e.get("order")){this._input.focus();this._input.value=this._input.value+e.get("order").title;this.setMessageLengthCounter();this._source="order";this._paymentId=e.get("order").paymentId;this._shipmentId=e.get("order").shipmentId}else if(e.get("action")==="sendCompilation"&&e.get("compilation")){this._input.focus();this._input.value=this._input.value+e.get("compilation").title;this.setMessageLengthCounter();this._source="deal";this._compilationProductIds=e.get("compilation").productIds}}}.bind(this))}.bind(this))}initDocumentSelector(){BX.bind(this._documentSelectorButton,"click",this.onDocumentSelectorClick.bind(this))}onDocumentSelectorClick(){if(!this._documentSelector){BX.loadExt("documentgenerator.selector").then(function(){this._documentSelector=new BX.DocumentGenerator.Selector.Menu({node:this._documentSelectorButton,moduleId:"crm",provider:this._documentsProvider,value:this._documentsValue,analyticsLabelPrefix:"crmTimelineSmsEditor"});this.selectPublicUrl()}.bind(this))}else{this.selectPublicUrl()}}selectPublicUrl(){if(!this._documentSelector){return}this._documentSelector.show().then(function(e){if(e instanceof BX.DocumentGenerator.Selector.Template){this._documentSelector.createDocument(e).then(function(e){this.pasteDocumentUrl(e)}.bind(this)).catch(function(e){console.error(e)}.bind(this))}else if(e instanceof BX.DocumentGenerator.Selector.Document){this.pasteDocumentUrl(e)}}.bind(this)).catch(function(e){console.error(e)}.bind(this))}pasteDocumentUrl(e){this._documentSelector.getDocumentPublicUrl(e).then(function(t){this._input.focus();this._input.value=this._input.value+" "+e.getTitle()+" "+t;this.setMessageLengthCounter();this._source="document"}.bind(this)).catch(function(e){console.error(e)}.bind(this))}initFileSelector(){BX.bind(this._fileSelectorButton,"click",this.onFileSelectorClick.bind(this))}closeFileSelector(){BX.PopupMenu.destroy("sms-file-selector")}onFileSelectorClick(){BX.PopupMenu.show("sms-file-selector",this._fileSelectorButton,[{text:BX.message("CRM_TIMELINE_SMS_UPLOAD_FILE"),onclick:this.uploadFile.bind(this),className:this._isFilesExternalLinkEnabled?"":"crm-entity-stream-content-sms-menu-item-with-lock"},{text:BX.message("CRM_TIMELINE_SMS_FIND_FILE"),onclick:this.findFile.bind(this),className:this._isFilesExternalLinkEnabled?"":"crm-entity-stream-content-sms-menu-item-with-lock"}])}getFileUploadInput(){return document.getElementById(this._fileUploadLabel.getAttribute("for"))}uploadFile(){this.closeFileSelector();if(this._isFilesExternalLinkEnabled){this.initDiskUF();BX.fireEvent(this.getFileUploadInput(),"click")}else{this.showFilesExternalLinkFeaturePopup()}}findFile(){this.closeFileSelector();if(this._isFilesExternalLinkEnabled){this.initDiskUF();BX.fireEvent(this._fileSelectorBitrix,"click")}else{this.showFilesExternalLinkFeaturePopup()}}getLoader(){if(!this.loader){this.loader=new BX.Loader({size:50})}return this.loader}showLoader(e){if(e&&!this.getLoader().isShown()){this.getLoader().show(e)}}hideLoader(){if(this.getLoader().isShown()){this.getLoader().hide()}}initDiskUF(){if(this.isDiskFileUploaderInited||!this._isFilesEnabled){return}this.isDiskFileUploaderInited=true;BX.addCustomEvent(this._fileUploadZone,"OnFileUploadSuccess",this.OnFileUploadSuccess.bind(this));BX.addCustomEvent(this._fileUploadZone,"DiskDLoadFormControllerInit",function(e){e._onUploadProgress=function(){this.showLoader(this._fileSelectorButton.parentNode.parentNode)}.bind(this)}.bind(this));BX.Disk.UF.add({UID:this._fileUploadZone.getAttribute("data-node-id"),controlName:this._fileUploadLabel.getAttribute("for"),hideSelectDialog:false,urlSelect:this._diskUrls.urlSelect,urlRenameFile:this._diskUrls.urlRenameFile,urlDeleteFile:this._diskUrls.urlDeleteFile,urlUpload:this._diskUrls.urlUpload});BX.onCustomEvent(this._fileUploadZone,"DiskLoadFormController",["show"])}OnFileUploadSuccess(e,t,s,i){this.hideLoader();const a=parseInt(e.element_id.replace("n",""));const l=e.element_name;this.pasteFileUrl(a,l)}pasteFileUrl(e,t){this.showLoader(this._fileSelectorButton.parentNode.parentNode);BX.ajax.runAction("disk.file.generateExternalLink",{analyticsLabel:"crmTimelineSmsEditorGetFilePublicUrl",data:{fileId:e}}).then(function(e){this.hideLoader();if(e.data.externalLink&&e.data.externalLink.link){this._input.focus();this._input.value=this._input.value+" "+t+" "+e.data.externalLink.link;this.setMessageLengthCounter();this._source="file"}}.bind(this)).catch((function(e){console.error(e.errors.pop().message)}))}getFeaturePopup(e){if(this.featurePopup!=null){return this.featurePopup}this.featurePopup=new BX.PopupWindow("bx-popup-crm-sms-editor-feature-popup",null,{zIndex:200,autoHide:true,closeByEsc:true,closeIcon:true,overlay:true,events:{onPopupDestroy:function(){this.featurePopup=null}.bind(this)},content:e,contentColor:"white"});return this.featurePopup}showFilesExternalLinkFeaturePopup(){this.getFeaturePopup(this._fileExternalLinkDisabledContent).show()}onTemplateHintIconClick(){if(this._senderId==="ednaru"){top.BX.Helper.show("redirect=detail&code=14214014")}}showTemplateSelectDropdown(e){const t=[];if(I.Type.isArray(e)){if(e.length){e.forEach((e=>{var s;t.push({templateId:(s=e.ORIGINAL_ID)!=null?s:null,value:e.ID,text:e.TITLE,onclick:this._selectTemplateHandler})}));BX.PopupMenu.show({id:this._templateSelectorMenuId,bindElement:this._templateSelectorNode,items:t,angle:false,width:this._templateSelectorNode.offsetWidth})}}else if(this._senderId){const e=this._templateSelectorMenuId+"loader";const t=this._templateSelectorMenuId+"loader";BX.PopupMenu.show({id:e,bindElement:this._templateSelectorNode,items:[{html:'<div id="'+t+'"></div>'}],angle:false,width:this._templateSelectorNode.offsetWidth,height:60,events:{onDestroy:function(){this.hideLoader()}.bind(this)}});this.showLoader(BX(t));if(!this._isRequestRunning){this._isRequestRunning=true;const t=this._senderId;BX.ajax.runAction("crm.activity.sms.getTemplates",{data:{senderId:t,context:{module:"crm",entityTypeId:this.getEntityTypeId(),entityCategoryId:this.getEntityCategoryId(),entityId:this.getEntityId()}}}).then(function(s){this._isRequestRunning=false;const i=this._senders.find(function(e){return e.id===t}.bind(this));if(i){i.templates=s.data.templates;this.toggleTemplateSelectAvailability();if(BX.PopupMenu.getMenuById(e)){BX.PopupMenu.getMenuById(e).close();if(this.isVisible()){this.showTemplateSelectDropdown(i.templates)}}}}.bind(this)).catch(function(t){this._isRequestRunning=false;if(BX.PopupMenu.getMenuById(e)){if(t&&t.errors&&t.errors[0]&&t.errors[0].message){alert(t.errors[0].message)}BX.PopupMenu.getMenuById(e).close()}}.bind(this))}}}getSelectedTemplate(){const e=this.getSelectedSender();if(!this._templateId||!e||!e.templates){return null}const t=e.templates.find((e=>e.ID===this._templateId));return t!=null?t:null}preparePlaceholdersFromTemplate(e){var t;const s=(t=e.PLACEHOLDERS)!=null?t:null;if(!I.Type.isPlainObject(s)){this.placeholders=null;this.filledPlaceholders=null;return}this.placeholders=s;if(!I.Type.isArray(e.FILLED_PLACEHOLDERS)){e.FILLED_PLACEHOLDERS=[]}this.filledPlaceholders=e.FILLED_PLACEHOLDERS}onTemplateSelectClick(){const e=this.getSelectedSender();if(e){this.showTemplateSelectDropdown(e.templates)}}onSelectTemplate(e,t){this._templateId=t.value;this.templateOriginalId=t.templateId;this.applySelectedTemplate();this.toggleSaveButton();const s=BX.PopupMenu.getMenuById(this._templateSelectorMenuId);if(s){s.close()}}toggleTemplateSelectAvailability(){const e=this.getSelectedSender();if(e&&I.Type.isArray(e.templates)&&!e.templates.length){BX.addClass(this._templateSelectorNode,"ui-ctl-disabled");this._templateTemplateTitleNode.textContent=BX.message("CRM_TIMELINE_SMS_TEMPLATES_NOT_FOUND")}else{BX.removeClass(this._templateSelectorNode,"ui-ctl-disabled");this.applySelectedTemplate()}}applySelectedTemplate(){if(!this.isCurrentSenderHasTemplates()){this.hideTemplatePreviewNodeAndClearTitle();return}const e=this.getSelectedTemplate();if(!I.Type.isPlainObject(e)){this.hideTemplatePreviewNodeAndClearTitle();return}this.preparePlaceholdersFromTemplate(e);this.setTemplateNodeTitle(e.TITLE);this.initTemplateEditor(e);this.showNode(this._templatePreviewNode)}showNode(e){I.Dom.style(e,{display:""})}isCurrentSenderTemplateHasPlaceholders(){return this.isCurrentSenderIsTemplatesBased()&&I.Type.isPlainObject(this.placeholders)}isCurrentSenderIsTemplatesBased(){const e=this.getSelectedSender();return e&&e.isTemplatesBased}isCurrentSenderHasTemplates(){const e=this.getSelectedSender();return e&&e.templates}hideTemplatePreviewNodeAndClearTitle(){this.hideNode(this._templatePreviewNode);this.setTemplateNodeTitle()}hideNode(e){I.Dom.style(e,{display:"none"})}setTemplateNodeTitle(e=""){this._templateTemplateTitleNode.textContent=e}initTemplateEditor(e){const t=I.Text.encode(e.PREVIEW).replaceAll("\n","<br>");const s={target:this._templatePreviewNode,entityId:this._ownerId,entityTypeId:this._ownerTypeId,categoryId:this._ownerCategoryId,onSelect:e=>this.createOrUpdatePlaceholder(e)};this.tplEditor=new BX.Crm.Template.Editor(s).setPlaceholders(this.placeholders).setFilledPlaceholders(this.filledPlaceholders);this.tplEditor.setBody(t)}createOrUpdatePlaceholder(e){const{id:t,value:s,entityType:i,text:a}=e;BX.ajax.runAction("crm.activity.smsplaceholder.createOrUpdatePlaceholder",{data:{placeholderId:t,fieldName:I.Type.isStringFilled(s)?s:null,entityType:I.Type.isStringFilled(i)?i:null,fieldValue:I.Type.isStringFilled(a)?a:null,...this.getCommonPlaceholderData()}})}getCommonPlaceholderData(){return{templateId:this.templateOriginalId,entityTypeId:this._ownerTypeId,entityCategoryId:this._ownerCategoryId}}activate(){super.activate();if(this.isFetchedConfig||!this.getEntityId()){return}this.isFetchedConfig=false;this.fetchConfigPromise=new Promise((e=>{I.ajax.runAction("crm.api.timeline.sms.getConfig",{json:{entityTypeId:this.getEntityTypeId(),entityId:this.getEntityId()}}).then((({data:t})=>{this.isFetchedConfig=true;this.setSettings(t);setTimeout((()=>{const t=this.getSetting("canSendMessage",false);this.setContainer(I.Tag.render(rn||(rn=ln`
						<div class="crm-entity-stream-content-new-detail --focus">
							${0}
						</div>
					`),t?babelHelpers.classPrivateFieldLooseBase(this,fn)[fn]():babelHelpers.classPrivateFieldLooseBase(this,Pn)[Pn]()));if(this.isCurrentSenderIsTemplatesBased()&&!this.getSelectedSender().templates){this.onTemplateSelectClick()}e()}),50)})).catch((()=>{this.showNotify(I.Loc.getMessage("CRM_TIMELINE_GOTOCHAT_CONFIG_ERROR"));setTimeout((()=>this.cancel()),50)}))}))}tryToResend(e,t,s,i){if(this.isFetchedConfig){babelHelpers.classPrivateFieldLooseBase(this,Tn)[Tn](e,t,s,i)}else{this.fetchConfigPromise.then((()=>babelHelpers.classPrivateFieldLooseBase(this,Tn)[Tn](e,t,s,i)))}}static create(e,t){const s=new In;s.initialize(e,t);In.items[s.getId()]=s;return s}}function Cn(){const e=this.getSetting("smsConfig",{});const t=BX.prop.getBoolean(e,"isSalescenterEnabled",false);const s=BX.prop.getBoolean(e,"isDocumentsEnabled",false);const i=this.getSetting("enableFiles",false);this._saveButton=I.Tag.render(on||(on=ln`<button onclick="${0}" class="ui-btn ui-btn-xs ui-btn-primary ui-btn-round" >${0}</button>`),this.onSaveButtonClick.bind(this),I.Loc.getMessage("CRM_TIMELINE_SEND"));this._cancelButton=I.Tag.render(cn||(cn=ln`<span onclick="${0}"  class="ui-btn ui-btn-xs ui-btn-link">${0}</span>`),this.onCancelButtonClick.bind(this),I.Loc.getMessage("CRM_TIMELINE_CANCEL_BTN"));this._input=I.Tag.render(dn||(dn=ln`<textarea class="crm-entity-stream-content-new-sms-textarea" rows='1' placeholder="${0}"></textarea>`),I.Loc.getMessage("CRM_TIMELINE_SMS_ENTER_MESSAGE"));return I.Tag.render(hn||(hn=ln`<div class="crm-entity-stream-content-sms-buttons-container">
			${0}
			${0}
			${0}
				<div class="crm-entity-stream-content-sms-detail-toggle" data-role="sms-detail-switcher">
					${0}
				</div>
			</div>
			<div class="crm-entity-stream-content-sms-conditions-container hidden" data-role="sms-detail">
				<div class="crm-entity-stream-content-sms-conditions">
					<div class="crm-entity-stream-content-sms-conditions-text">
						${0}
						<a href="#" data-role="sender-selector">sender</a><span data-role="from-container">${0}
						<a data-role="from-selector" href="#">from_number</a></span>
						<span data-role="client-container"> ${0}
						<a data-role="client-selector" href="#">client_caption</a> <a data-role="to-selector" href="#">to_number</a></span>
					</div>
				</div>
			</div>
			${0}
			${0}
			${0}

			<div class="crm-entity-stream-content-new-sms-btn-container">
				${0}
				${0}

				<div class="crm-entity-stream-content-sms-symbol-counter" data-role="message-length-counter-wrap">
					${0}
					<span class="crm-entity-stream-content-sms-symbol-counter-number" data-role="message-length-counter" data-length-max="200">0</span>
					${0}
					<span class="crm-entity-stream-content-sms-symbol-counter-number">200</span>
				</div>
			</div>
		`),t?I.Tag.render(un||(un=ln`
				<div class="crm-entity-stream-content-sms-button" data-role="salescenter-starter">
					<div class="crm-entity-stream-content-sms-salescenter-icon"></div>
					<div class="crm-entity-stream-content-sms-button-text">${0}</div>
				</div>`),I.Loc.getMessage("CRM_TIMELINE_SMS_SALESCENTER_STARTER")):null,i?I.Tag.render(pn||(pn=ln`
				<div class="crm-entity-stream-content-sms-button" data-role="sms-file-selector">
					<div class="crm-entity-stream-content-sms-file-icon"></div>
					<div class="crm-entity-stream-content-sms-button-text">${0}</div>
				</div>`),I.Loc.getMessage("CRM_TIMELINE_SMS_SEND_FILE")):null,s?I.Tag.render(bn||(bn=ln`
				<div class="crm-entity-stream-content-sms-button" data-role="sms-document-selector">
					<div class="crm-entity-stream-content-sms-document-icon"></div>
					<div class="crm-entity-stream-content-sms-button-text">${0}</div>
				</div>`),I.Loc.getMessage("CRM_TIMELINE_SMS_SEND_DOCUMENT")):null,I.Loc.getMessage("CRM_TIMELINE_DETAILS"),I.Loc.getMessage("CRM_TIMELINE_SMS_SENDER"),I.Loc.getMessage("CRM_TIMELINE_SMS_FROM"),I.Loc.getMessage("CRM_TIMELINE_SMS_TO"),this._input,babelHelpers.classPrivateFieldLooseBase(this,_n)[_n](),babelHelpers.classPrivateFieldLooseBase(this,Bn)[Bn](),this._saveButton,this._cancelButton,I.Loc.getMessage("CRM_TIMELINE_SMS_SYMBOLS"),I.Loc.getMessage("CRM_TIMELINE_SMS_SYMBOLS_FROM"))}function Fn(){const e=BX.prop.getBoolean(this.getSetting("smsConfig",{}),"isSalescenterEnabled",false);return I.Tag.render(vn||(vn=ln`<div class="crm-entity-stream-content-sms-conditions-container">
			<div class="crm-entity-stream-content-sms-conditions">
				<div class="crm-entity-stream-content-sms-conditions-text">
					<strong>${0}</strong><br>
					${0}<br>
					${0}
				</div>
			</div>
		</div>
		<div class="crm-entity-stream-content-new-sms-btn-container">
			<a href="#" data-role="sender-selector" target="_top" class="crm-entity-stream-content-new-sms-connect-link">${0}</a>
			${0}
		</div>`),I.Loc.getMessage("CRM_TIMELINE_SMS_MANAGE_TEXT_1"),I.Loc.getMessage("CRM_TIMELINE_SMS_MANAGE_TEXT_2"),I.Loc.getMessage("CRM_TIMELINE_SMS_MANAGE_TEXT_3_MSGVER_1"),I.Loc.getMessage("CRM_TIMELINE_SMS_MANAGE_URL"),e?I.Tag.render(mn||(mn=ln`<div class="crm-entity-stream-content-sms-salescenter-container-absolute" data-role="salescenter-starter">
	<div class="crm-entity-stream-content-sms-salescenter-icon"></div>
	<div class="crm-entity-stream-content-sms-button-text">${0}</div>
</div>`),I.Loc.getMessage("CRM_TIMELINE_SMS_SALESCENTER_STARTER")):null)}function Sn(){this._templatesContainer=I.Tag.render(gn||(gn=ln`<div class="crm-entity-stream-content-new-sms-templates">
				<div class="ui-ctl-label-text">
					${0}<span class="ui-hint" data-role="hint"><span class="ui-hint-icon"></span></span>
				</div>
				<div class="ui-ctl ui-ctl-after-icon ui-ctl-dropdown ui-ctl-w100" data-role="template-selector">
					<div class="ui-ctl-element" data-role="template-title"></div>
					<div class="ui-ctl-after ui-ctl-icon-angle"></div>
				</div>
				<div class="crm-entity-stream-content-new-sms-preview" data-role="preview"></div>
			</div>`),I.Loc.getMessage("CRM_TIMELINE_SMS_TEMPLATE_LIST_TITLE"));return this._templatesContainer}function Hn(){const e=this.getSetting("smsConfig",{});const t=this.getSetting("showFiles",false);const s=BX.prop.getBoolean(e,"isFilesExternalLinkEnabled",false);if(s){const e="crm-"+this.getEntityTypeId()+"-"+this.getEntityId();const t=e+"-sms-files";const s=e+"-sms-files-uploader";const i="diskuf-selectdialog-"+e;return I.Tag.render(yn||(yn=ln`<div class="crm-entity-stream-content-sms-file-uploader-zone" data-role="sms-file-upload-zone" data-node-id="${0}">
				<div id="${0}" class="diskuf-files-entity diskuf-selectdialog bx-disk">
					<div class="diskuf-files-block checklist-loader-files">
						<div class="diskuf-placeholder">
							<table class="files-list">
								<tbody class="diskuf-placeholder-tbody"></tbody>
							</table>
						</div>
					</div>
					<div class="diskuf-extended">
						<input type="hidden" name="${0}[]" value="" />
					</div>
					<div class="diskuf-extended-item">
						<label for="${0}" data-role="sms-file-upload-label"></label>
						<input class="diskuf-fileUploader" id="${0}" type="file" data-role="sms-file-upload-input" />
					</div>
					<div class="diskuf-extended-item">
						<span class="diskuf-selector-link" data-role="sms-file-selector-bitrix">
						</span>
					</div>
				</div>
			</div>`),e,i,t,s,s)}if(t){return I.Tag.render(Ln||(Ln=ln`<div class="crm-entity-stream-content-sms-file-external-link-popup" data-role="sms-file-external-link-disabled">
				<div class="crm-entity-stream-content-sms-file-external-link-popup-limit-container">
					<div class="crm-entity-stream-content-sms-file-external-link-popup-limit-inner">
						<div class="crm-entity-stream-content-sms-file-external-link-popup-limit-desc">
							<div class="crm-entity-stream-content-sms-file-external-link-popup-limit-img">
								<div class="crm-entity-stream-content-sms-file-external-link-popup-limit-img-lock"></div>
							</div>
							<div class="crm-entity-stream-content-sms-file-external-link-popup-limit-desc-text">
								${0}
							</div>
						</div>
					</div>
				</div>
			</div>`),I.Loc.getMessage("CRM_TIMELINE_SMS_FILE_EXTERNAL_LINK_FEATURE"))}return null}function On(){E.EventEmitter.subscribe("BX.Crm.MessageSender.ReceiverRepository:OnReceiversChanged",(e=>{const{item:t,current:s}=e.getData();if(this.getEntityTypeId()!==(t==null?void 0:t.entityTypeId)||this.getEntityId()!==(t==null?void 0:t.entityId)){return}if(!I.Type.isArray(s)){return}const i=s.filter((e=>e.address.typeId==="PHONE"));const a={};for(const e of i){let t=a[e.addressSource.hash];if(!t){var l;t={entityTypeId:e.addressSource.entityTypeId,entityTypeName:BX.CrmEntityType.resolveName(e.addressSource.entityTypeId),entityId:e.addressSource.entityId,caption:(l=e.addressSourceData)==null?void 0:l.title,phones:[]}}t.phones.push({type:e.address.typeId,value:e.address.value,valueFormatted:e.address.valueFormatted});a[e.addressSource.hash]=t}this._communications=Object.values(a);const n=this._communications.find((e=>e.entityTypeId===this._commEntityTypeId&&e.entityId===this._commEntityId));this.setClient(n!=null?n:this._communications[0]);this.initClientContainer()}))}function Mn(e,t,s,i){const a=this._senders.find((t=>t.id===e));if(a!=null&&a.canUse&&I.Type.isArrayFilled(a==null?void 0:a.fromList)){this.setSender(a);const e=a.fromList.find((e=>String(e.id)===t));if(e){this.setFrom(e)}else{console.warn("Unable to resend SMS with selected from")}}else{console.warn('Unable to resend SMS with sender ID "'+e+'"')}const l=this._communications.find((e=>e.entityId===s.entityId&&e.entityTypeId===s.entityTypeId));if(l){this.setClient(l);const e=l.phones.find((e=>e.value===s.value));if(e){this.setTo(e)}}else{console.warn("Unable to resend SMS with selected client")}if(I.Type.isStringFilled(i)){this._input.value=i;this.setMessageLengthCounter();setTimeout(this.resizeForm.bind(this),0)}if(this._smsDetail.classList.contains("hidden")){setTimeout((()=>this._smsDetailSwitcher.click()),50)}}In.items={};const Nn=700;function wn(e,t,s,i,a){const l={site:I.Loc.getMessage("SITE_ID"),sessid:I.Loc.getMessage("bitrix_sessid"),ACTION:"SAVE_SMS_MESSAGE",SENDER_ID:t};return new Promise(((n,r)=>{BX.ajax({url:Dn(e,t),method:"POST",dataType:"json",data:{...s,...l},onsuccess:()=>{i();n()},onfailure:()=>{a();r()}})}))}function An(e,t,s,i){const{id:a,value:l,entityType:n,text:r}=i;return I.ajax.runAction("crm.activity.smsplaceholder.createOrUpdatePlaceholder",{data:{placeholderId:a,fieldName:I.Type.isStringFilled(l)?l:null,entityType:I.Type.isStringFilled(n)?n:null,fieldValue:I.Type.isStringFilled(r)?r:null,templateId:e,entityTypeId:t,entityCategoryId:s}})}function Rn(e){if(!I.Type.isStringFilled(e)){throw new Error('"manageUrl" parameter must be specified')}if(!I.Reflection.getClass("BX.SidePanel.Instance.getTopSlider")){throw new Error('Class "SidePanel.Instance.getTopSlider" not found')}const t=I.Uri.addParam(e,{IFRAME:"Y"});const s=f.SidePanel.Instance.getTopSlider();const i={width:Nn,events:{onClose:()=>{if(s){s.reload()}},onCloseComplete:()=>{if(!s){document.location.reload()}}}};f.SidePanel.Instance.open(t,i)}function Dn(e,t){if(!I.Type.isStringFilled(e)){throw new Error('"serviceUrl" parameter must be specified')}if(!I.Type.isStringFilled(t)){throw new Error('"senderId" parameter must be specified')}return BX.util.add_url_param(e,{action:"save_sms_message",sender:t})}const kn="stub";const xn="crm-timeline-whatsapp-settings-menu";const jn="menu-popup-item-accept";const Xn="menu-popup-item-none";function Kn(){return[{id:kn}]}function Un(e,t,s){if(!I.Type.isArrayFilled(e)){return[]}const i=[];e.forEach((({id:e,name:a})=>{const l=e===t?jn:Xn;i.push({id:e,text:a,className:l,onclick:s})}));return i}function $n(e,t,s){if(!I.Type.isArrayFilled(e)){return[]}const i=[];e.forEach((e=>{if(I.Type.isArrayFilled(e.phones)){e.phones.forEach((a=>{const l=a.id===t?jn:Xn;i.push({id:a.id,text:`${e.caption} (${a.valueFormatted})`,className:l,onclick:s})}))}}));return i}function Gn(e){const t=e.filter((e=>e.address.typeId==="PHONE"));const s={};for(const e of t){let t=s[e.addressSource.hash];if(!t){var i;t={entityTypeId:e.addressSource.entityTypeId,entityTypeName:BX.CrmEntityType.resolveName(e.addressSource.entityTypeId),entityId:e.addressSource.entityId,caption:(i=e.addressSourceData)==null?void 0:i.title,phones:[]}}t.phones.push({id:e.address.id,type:e.address.typeId,value:e.address.value,valueFormatted:e.address.valueFormatted});s[e.addressSource.hash]=t}return Object.values(s)}const Vn=I.Reflection.namespace("BX.userOptions");class Wn extends ie{saveUserOption(e=null){if(![Wn.USER_OPTION_PROVIDER_OFF,Wn.USER_OPTION_TEMPLATES_READY,Wn.USER_OPTION_PROVIDER_ON].includes(e)){throw new Error(`User option with name: ${e} unsupported`)}Vn.save("crm","whatsapp",e,1)}}Wn.USER_OPTION_PROVIDER_OFF="is_tour_provider_off_viewed";Wn.USER_OPTION_TEMPLATES_READY="is_tour_templates_ready_viewed";Wn.USER_OPTION_PROVIDER_ON="is_tour_provider_on_viewed";let zn=e=>e,qn,Yn,Jn,Zn,Qn,er,tr,sr,ir,ar,lr,nr,rr,or;const cr="20526810";var dr=babelHelpers.classPrivateFieldLooseKey("serviceUrl");var hr=babelHelpers.classPrivateFieldLooseKey("provider");var ur=babelHelpers.classPrivateFieldLooseKey("communications");var pr=babelHelpers.classPrivateFieldLooseKey("sendButton");var br=babelHelpers.classPrivateFieldLooseKey("cancelButton");var vr=babelHelpers.classPrivateFieldLooseKey("selectorButton");var mr=babelHelpers.classPrivateFieldLooseKey("templatesContainer");var gr=babelHelpers.classPrivateFieldLooseKey("templatesContainerTitle");var yr=babelHelpers.classPrivateFieldLooseKey("templatesContainerContent");var Lr=babelHelpers.classPrivateFieldLooseKey("settingsMenu");var fr=babelHelpers.classPrivateFieldLooseKey("tplEditor");var Pr=babelHelpers.classPrivateFieldLooseKey("selectTplDlg");var _r=babelHelpers.classPrivateFieldLooseKey("placeholders");var Br=babelHelpers.classPrivateFieldLooseKey("filledPlaceholders");var Er=babelHelpers.classPrivateFieldLooseKey("canUse");var Tr=babelHelpers.classPrivateFieldLooseKey("isDemoTemplateSet");var Ir=babelHelpers.classPrivateFieldLooseKey("isSendRequestRunning");var Cr=babelHelpers.classPrivateFieldLooseKey("isLocked");var Fr=babelHelpers.classPrivateFieldLooseKey("isFetchedConfig");var Sr=babelHelpers.classPrivateFieldLooseKey("template");var Hr=babelHelpers.classPrivateFieldLooseKey("fromPhoneId");var Or=babelHelpers.classPrivateFieldLooseKey("toPhone");var Mr=babelHelpers.classPrivateFieldLooseKey("toEntityTypeId");var Nr=babelHelpers.classPrivateFieldLooseKey("toEntityId");var wr=babelHelpers.classPrivateFieldLooseKey("unViewedTourList");var Ar=babelHelpers.classPrivateFieldLooseKey("fetchConfigPromise");var Rr=babelHelpers.classPrivateFieldLooseKey("isHelpShown");var Dr=babelHelpers.classPrivateFieldLooseKey("isTemplateSelectorShown");var kr=babelHelpers.classPrivateFieldLooseKey("isSuggestTemplateShown");var xr=babelHelpers.classPrivateFieldLooseKey("isResendTry");var jr=babelHelpers.classPrivateFieldLooseKey("prepareParams");var Xr=babelHelpers.classPrivateFieldLooseKey("prepareToResend");var Kr=babelHelpers.classPrivateFieldLooseKey("subscribeToReceiversChanges");var Ur=babelHelpers.classPrivateFieldLooseKey("createHelpLinkContainer");var $r=babelHelpers.classPrivateFieldLooseKey("createHeaderButtons");var Gr=babelHelpers.classPrivateFieldLooseKey("createFooterButtons");var Vr=babelHelpers.classPrivateFieldLooseKey("createTemplatesContainer");var Wr=babelHelpers.classPrivateFieldLooseKey("createSettingsMenu");var zr=babelHelpers.classPrivateFieldLooseKey("showContent");var qr=babelHelpers.classPrivateFieldLooseKey("setTemplate");var Yr=babelHelpers.classPrivateFieldLooseKey("setCommunicationsParams");var Jr=babelHelpers.classPrivateFieldLooseKey("setChannelDefaultPhoneId");var Zr=babelHelpers.classPrivateFieldLooseKey("applySendButtonState");var Qr=babelHelpers.classPrivateFieldLooseKey("handleTemplateSelect");var eo=babelHelpers.classPrivateFieldLooseKey("handleSettingsMenuClick");var to=babelHelpers.classPrivateFieldLooseKey("handleHelpClick");var so=babelHelpers.classPrivateFieldLooseKey("handleShowSubMenu");var io=babelHelpers.classPrivateFieldLooseKey("handleSenderPhoneSelect");var ao=babelHelpers.classPrivateFieldLooseKey("handleCommunicationSelect");var lo=babelHelpers.classPrivateFieldLooseKey("handleApplyPlaceholder");var no=babelHelpers.classPrivateFieldLooseKey("handleSendButtonClick");var ro=babelHelpers.classPrivateFieldLooseKey("handleSendSuccess");var oo=babelHelpers.classPrivateFieldLooseKey("handleSendFailure");var co=babelHelpers.classPrivateFieldLooseKey("initTemplateEditor");var ho=babelHelpers.classPrivateFieldLooseKey("initTemplateSelectDialog");var uo=babelHelpers.classPrivateFieldLooseKey("preparePlaceholdersFromTemplate");var po=babelHelpers.classPrivateFieldLooseKey("getTemplateEditorText");var bo=babelHelpers.classPrivateFieldLooseKey("getFooterData");var vo=babelHelpers.classPrivateFieldLooseKey("isTourAvailable");var mo=babelHelpers.classPrivateFieldLooseKey("isClientPhoneNotSet");var go=babelHelpers.classPrivateFieldLooseKey("onPreviewTemplate");var yo=babelHelpers.classPrivateFieldLooseKey("submitHelpShowAnalytics");var Lo=babelHelpers.classPrivateFieldLooseKey("submitSendMessageAnalytics");var fo=babelHelpers.classPrivateFieldLooseKey("submitSuggestTemplateAnalytics");var Po=babelHelpers.classPrivateFieldLooseKey("submitTemplateSelectAnalytics");var _o=babelHelpers.classPrivateFieldLooseKey("submitCancelButtonAnalytics");var Bo=babelHelpers.classPrivateFieldLooseKey("submitPreviewTemplateAnalytics");var Eo=babelHelpers.classPrivateFieldLooseKey("submitAnalyticsData");class To extends j{constructor(...e){super(...e);Object.defineProperty(this,Eo,{value:cc});Object.defineProperty(this,Bo,{value:oc});Object.defineProperty(this,_o,{value:rc});Object.defineProperty(this,Po,{value:nc});Object.defineProperty(this,fo,{value:lc});Object.defineProperty(this,Lo,{value:ac});Object.defineProperty(this,yo,{value:ic});Object.defineProperty(this,go,{value:sc});Object.defineProperty(this,mo,{value:tc});Object.defineProperty(this,vo,{value:ec});Object.defineProperty(this,bo,{value:Qo});Object.defineProperty(this,po,{value:Zo});Object.defineProperty(this,uo,{value:Jo});Object.defineProperty(this,ho,{value:Yo});Object.defineProperty(this,co,{value:qo});Object.defineProperty(this,oo,{value:zo});Object.defineProperty(this,ro,{value:Wo});Object.defineProperty(this,no,{value:Vo});Object.defineProperty(this,lo,{value:Go});Object.defineProperty(this,ao,{value:$o});Object.defineProperty(this,io,{value:Uo});Object.defineProperty(this,so,{value:Ko});Object.defineProperty(this,to,{value:Xo});Object.defineProperty(this,eo,{value:jo});Object.defineProperty(this,Qr,{value:xo});Object.defineProperty(this,Zr,{value:ko});Object.defineProperty(this,Jr,{value:Do});Object.defineProperty(this,Yr,{value:Ro});Object.defineProperty(this,qr,{value:Ao});Object.defineProperty(this,zr,{value:wo});Object.defineProperty(this,Wr,{value:No});Object.defineProperty(this,Vr,{value:Mo});Object.defineProperty(this,Gr,{value:Oo});Object.defineProperty(this,$r,{value:Ho});Object.defineProperty(this,Ur,{value:So});Object.defineProperty(this,Kr,{value:Fo});Object.defineProperty(this,Xr,{value:Co});Object.defineProperty(this,jr,{value:Io});Object.defineProperty(this,dr,{writable:true,value:""});Object.defineProperty(this,hr,{writable:true,value:null});Object.defineProperty(this,ur,{writable:true,value:[]});Object.defineProperty(this,pr,{writable:true,value:null});Object.defineProperty(this,br,{writable:true,value:null});Object.defineProperty(this,vr,{writable:true,value:null});Object.defineProperty(this,mr,{writable:true,value:null});Object.defineProperty(this,gr,{writable:true,value:null});Object.defineProperty(this,yr,{writable:true,value:null});Object.defineProperty(this,Lr,{writable:true,value:null});Object.defineProperty(this,fr,{writable:true,value:null});Object.defineProperty(this,Pr,{writable:true,value:null});Object.defineProperty(this,_r,{writable:true,value:void 0});Object.defineProperty(this,Br,{writable:true,value:void 0});Object.defineProperty(this,Er,{writable:true,value:false});Object.defineProperty(this,Tr,{writable:true,value:false});Object.defineProperty(this,Ir,{writable:true,value:false});Object.defineProperty(this,Cr,{writable:true,value:false});Object.defineProperty(this,Fr,{writable:true,value:false});Object.defineProperty(this,Sr,{writable:true,value:null});Object.defineProperty(this,Hr,{writable:true,value:null});Object.defineProperty(this,Or,{writable:true,value:null});Object.defineProperty(this,Mr,{writable:true,value:null});Object.defineProperty(this,Nr,{writable:true,value:null});Object.defineProperty(this,wr,{writable:true,value:void 0});Object.defineProperty(this,Ar,{writable:true,value:null});Object.defineProperty(this,Rr,{writable:true,value:false});Object.defineProperty(this,Dr,{writable:true,value:false});Object.defineProperty(this,kr,{writable:true,value:false});Object.defineProperty(this,xr,{writable:true,value:false})}initializeSettings(){var e;babelHelpers.classPrivateFieldLooseBase(this,Er)[Er]=this.getSetting("canUse");babelHelpers.classPrivateFieldLooseBase(this,dr)[dr]=this.getSetting("serviceUrl");if(!babelHelpers.classPrivateFieldLooseBase(this,dr)[dr]){throw new Error("Whatsapp message sending must be used with serviceUrl")}babelHelpers.classPrivateFieldLooseBase(this,wr)[wr]=(e=this.getSetting("unViewedTourList"))!=null?e:[]}createLayout(){let e="--gray";let t=I.Loc.getMessage("CRM_TIMELINE_SMS_WHATSAPP_HEADER_TITLE_SETUP");let s=I.Loc.getMessage("CRM_TIMELINE_SMS_WHATSAPP_HEADER_DESCRIPTION_SETUP");let i="--fixed";if(babelHelpers.classPrivateFieldLooseBase(this,Er)[Er]){e="--green";t=I.Loc.getMessage("CRM_TIMELINE_SMS_WHATSAPP_HEADER_TITLE");s=I.Loc.getMessage("CRM_TIMELINE_SMS_WHATSAPP_HEADER_DESCRIPTION");i=""}return I.Tag.render(qn||(qn=zn`
			<div class="crm-entity-stream-content-whatsapp crm-entity-stream-content-wait-detail --hidden --skeleton">
				<div class="crm-entity-stream-content-whatsapp-container --hidden">
					<div class="crm-entity-stream-content-whatsapp-header">
						<div class="crm-entity-stream-content-whatsapp-header-icon ${0}"></div>
						<div class="crm-entity-stream-content-whatsapp-header-text">
							<div class="crm-entity-stream-content-whatsapp-header-title">
								${0}
							</div>
							<div class="crm-entity-stream-content-whatsapp-header-description ${0}">
								${0}
							</div>
							<div>
								${0}
							</div>
						</div>
						<div class="crm-entity-stream-content-whatsapp-header-buttons">
							${0}
						</div>
					</div>
					${0}
				</div>
				<div class="crm-entity-stream-content-whatsapp-footer --hidden">
					${0}
				</div>
			</div>
		`),e,t,i,s,babelHelpers.classPrivateFieldLooseBase(this,Ur)[Ur](),babelHelpers.classPrivateFieldLooseBase(this,$r)[$r](),babelHelpers.classPrivateFieldLooseBase(this,Vr)[Vr](),babelHelpers.classPrivateFieldLooseBase(this,Gr)[Gr]())}initializeLayout(){super.initializeLayout();babelHelpers.classPrivateFieldLooseBase(this,qr)[qr](I.Runtime.clone(this.getSetting("demoTemplate")));babelHelpers.classPrivateFieldLooseBase(this,Kr)[Kr]()}showTour(){if(!babelHelpers.classPrivateFieldLooseBase(this,vo)[vo]()){return}if(babelHelpers.classPrivateFieldLooseBase(this,wr)[wr].includes(Wn.USER_OPTION_PROVIDER_OFF)){B.TourManager.getInstance().registerWithLaunch(new Wn({itemCode:"whatsapp",title:I.Loc.getMessage("CRM_TIMELINE_SMS_WHATSAPP_GUIDE_PROVIDER_OFF_TITLE"),text:this.getEntityTypeId()===BX.CrmEntityType.enumeration.lead?I.Loc.getMessage("CRM_TIMELINE_SMS_WHATSAPP_GUIDE_PROVIDER_OFF_TEXT_LEAD"):I.Loc.getMessage("CRM_TIMELINE_SMS_WHATSAPP_GUIDE_PROVIDER_OFF_TEXT_DEAL"),articleCode:cr,userOptionName:Wn.USER_OPTION_PROVIDER_OFF}))}else if(babelHelpers.classPrivateFieldLooseBase(this,wr)[wr].includes(Wn.USER_OPTION_PROVIDER_ON)){B.TourManager.getInstance().registerWithLaunch(new Wn({itemCode:"whatsapp",title:I.Loc.getMessage("CRM_TIMELINE_SMS_WHATSAPP_GUIDE_PROVIDER_ON_TITLE"),text:this.getEntityTypeId()===BX.CrmEntityType.enumeration.lead?I.Loc.getMessage("CRM_TIMELINE_SMS_WHATSAPP_GUIDE_PROVIDER_ON_TEXT_LEAD"):I.Loc.getMessage("CRM_TIMELINE_SMS_WHATSAPP_GUIDE_PROVIDER_ON_TEXT_DEAL"),articleCode:cr,userOptionName:Wn.USER_OPTION_PROVIDER_ON}))}}activate(){super.activate();if(babelHelpers.classPrivateFieldLooseBase(this,Fr)[Fr]||!this.getEntityId()){return}babelHelpers.classPrivateFieldLooseBase(this,Fr)[Fr]=false;babelHelpers.classPrivateFieldLooseBase(this,Ar)[Ar]=new Promise((e=>{I.ajax.runAction("crm.api.timeline.whatsapp.getConfig",{json:{entityTypeId:this.getEntityTypeId(),entityId:this.getEntityId()}}).then((({data:t})=>{babelHelpers.classPrivateFieldLooseBase(this,Fr)[Fr]=true;babelHelpers.classPrivateFieldLooseBase(this,jr)[jr](t);babelHelpers.classPrivateFieldLooseBase(this,zr)[zr]();e();setTimeout((()=>{if(this.supportsLayout()&&babelHelpers.classPrivateFieldLooseBase(this,vo)[vo]()&&babelHelpers.classPrivateFieldLooseBase(this,wr)[wr].includes(Wn.USER_OPTION_TEMPLATES_READY)){B.TourManager.getInstance().registerWithLaunch(new Wn({itemCode:"whatsapp",title:I.Loc.getMessage("CRM_TIMELINE_SMS_WHATSAPP_GUIDE_TEMPLATES_READY_TITLE"),text:I.Loc.getMessage("CRM_TIMELINE_SMS_WHATSAPP_GUIDE_TEMPLATES_READY_TEXT"),articleCode:cr,userOptionName:Wn.USER_OPTION_TEMPLATES_READY,guideBindElement:babelHelpers.classPrivateFieldLooseBase(this,vr)[vr]}));babelHelpers.classPrivateFieldLooseBase(this,wr)[wr]=babelHelpers.classPrivateFieldLooseBase(this,wr)[wr].filter((e=>e!==Wn.USER_OPTION_TEMPLATES_READY))}}),300)})).catch((()=>{this.showNotify(I.Loc.getMessage("CRM_TIMELINE_GOTOCHAT_CONFIG_ERROR"));setTimeout((()=>this.emitFinishEditEvent()),50)}))}))}tryToResend(e,t,s){if(babelHelpers.classPrivateFieldLooseBase(this,Fr)[Fr]){babelHelpers.classPrivateFieldLooseBase(this,Xr)[Xr](e,t,s)}else{babelHelpers.classPrivateFieldLooseBase(this,Ar)[Ar].then((()=>babelHelpers.classPrivateFieldLooseBase(this,Xr)[Xr](e,t,s)))}babelHelpers.classPrivateFieldLooseBase(this,xr)[xr]=true}getTemplate(){return babelHelpers.classPrivateFieldLooseBase(this,Tr)[Tr]?null:babelHelpers.classPrivateFieldLooseBase(this,Sr)[Sr]}}function Io(e){const{communications:t,provider:s}=e;babelHelpers.classPrivateFieldLooseBase(this,hr)[hr]=s;babelHelpers.classPrivateFieldLooseBase(this,Er)[Er]=babelHelpers.classPrivateFieldLooseBase(this,hr)[hr].canUse;babelHelpers.classPrivateFieldLooseBase(this,ur)[ur]=t;babelHelpers.classPrivateFieldLooseBase(this,Yr)[Yr]();babelHelpers.classPrivateFieldLooseBase(this,Jr)[Jr]()}function Co(e,t,s){if(!babelHelpers.classPrivateFieldLooseBase(this,hr)[hr]){throw new Error("Whatsapp provider must be defined")}const i=babelHelpers.classPrivateFieldLooseBase(this,ur)[ur].find((e=>e.entityId===s.entityId&&e.entityTypeId===s.entityTypeId));if(I.Type.isArrayFilled(i.phones)&&I.Type.isStringFilled(s.value)){const e=i.phones.find((e=>e.value===s.value));if(e){babelHelpers.classPrivateFieldLooseBase(this,Or)[Or]=e;babelHelpers.classPrivateFieldLooseBase(this,Mr)[Mr]=i.entityTypeId;babelHelpers.classPrivateFieldLooseBase(this,Nr)[Nr]=i.entityId}}if(I.Type.isArrayFilled(babelHelpers.classPrivateFieldLooseBase(this,hr)[hr].fromList)&&I.Type.isStringFilled(t)){const e=babelHelpers.classPrivateFieldLooseBase(this,hr)[hr].fromList.find((e=>String(e.id)===t));if(e){babelHelpers.classPrivateFieldLooseBase(this,Hr)[Hr]=e.id}}if(babelHelpers.classPrivateFieldLooseBase(this,Er)[Er]&&I.Type.isPlainObject(e)){babelHelpers.classPrivateFieldLooseBase(this,ho)[ho]({preselectedItems:[["message_template",e.ORIGINAL_ID]]});babelHelpers.classPrivateFieldLooseBase(this,qr)[qr](e)}}function Fo(){E.EventEmitter.subscribe("BX.Crm.MessageSender.ReceiverRepository:OnReceiversChanged",(e=>{const{item:t,current:s}=e.getData();if(this.getEntityTypeId()!==(t==null?void 0:t.entityTypeId)||this.getEntityId()!==(t==null?void 0:t.entityId)||!I.Type.isArray(s)||!babelHelpers.classPrivateFieldLooseBase(this,Fr)[Fr]){return}babelHelpers.classPrivateFieldLooseBase(this,ur)[ur]=Gn(s);babelHelpers.classPrivateFieldLooseBase(this,Yr)[Yr]();P.MenuManager.destroy(xn);babelHelpers.classPrivateFieldLooseBase(this,Zr)[Zr]();babelHelpers.classPrivateFieldLooseBase(this,Wr)[Wr]()}))}function So(){const e=I.Tag.render(Yn||(Yn=zn`
			<a class="crm-entity-stream-content-whatsapp-header-help-link" href="#">
				${0}
			</a>
		`),I.Loc.getMessage("CRM_TIMELINE_SMS_WHATSAPP_HEADER_HELP_LINK"));I.Event.bind(e,"click",(()=>babelHelpers.classPrivateFieldLooseBase(this,to)[to](cr)));return e}function Ho(){if(babelHelpers.classPrivateFieldLooseBase(this,Er)[Er]){babelHelpers.classPrivateFieldLooseBase(this,vr)[vr]=I.Tag.render(Jn||(Jn=zn`
				<button class="crm-entity-stream-content-whatsapp-header-button-selector">
					<span class="crm-entity-stream-content-whatsapp-header-button-text">
						${0}
					</span>
				</button>
			`),I.Loc.getMessage("CRM_TIMELINE_SMS_WHATSAPP_BUTTON_SELECTOR"));I.Event.bind(babelHelpers.classPrivateFieldLooseBase(this,vr)[vr],"click",(()=>babelHelpers.classPrivateFieldLooseBase(this,Qr)[Qr]()));const e=I.Tag.render(Zn||(Zn=zn`
				<button class="ui-btn ui-btn-link ui-btn-xs ui-btn-icon-setting crm-entity-stream-content-whatsapp-header-button-settings">
				</button>
			`));I.Event.bind(e,"click",(()=>babelHelpers.classPrivateFieldLooseBase(this,eo)[eo]()));return I.Tag.render(Qn||(Qn=zn`
				${0}
				${0}
			`),babelHelpers.classPrivateFieldLooseBase(this,vr)[vr],e)}return null}function Oo(){if(babelHelpers.classPrivateFieldLooseBase(this,Er)[Er]){babelHelpers.classPrivateFieldLooseBase(this,pr)[pr]=I.Tag.render(er||(er=zn`
				<button class="ui-btn ui-btn-xs ui-btn-primary ui-btn-round ui-btn-disabled">
					${0}
				</button>
			`),I.Loc.getMessage("CRM_TIMELINE_SEND"));I.Event.bind(babelHelpers.classPrivateFieldLooseBase(this,pr)[pr],"click",(()=>babelHelpers.classPrivateFieldLooseBase(this,no)[no]()));babelHelpers.classPrivateFieldLooseBase(this,br)[br]=I.Tag.render(tr||(tr=zn`
				<button class="ui-btn ui-btn-xs ui-btn-link">
					${0}
				</button>
			`),I.Loc.getMessage("CRM_TIMELINE_CANCEL_BTN"));I.Event.bind(babelHelpers.classPrivateFieldLooseBase(this,br)[br],"click",(()=>{var e;babelHelpers.classPrivateFieldLooseBase(this,qr)[qr](I.Runtime.clone(this.getSetting("demoTemplate")));babelHelpers.classPrivateFieldLooseBase(this,Pr)[Pr]=null;this.emitFinishEditEvent();babelHelpers.classPrivateFieldLooseBase(this,_o)[_o]((e=babelHelpers.classPrivateFieldLooseBase(this,Sr)[Sr])==null?void 0:e.ORIGINAL_ID)}));return I.Tag.render(sr||(sr=zn`
				${0}
				${0}
			`),babelHelpers.classPrivateFieldLooseBase(this,pr)[pr],babelHelpers.classPrivateFieldLooseBase(this,br)[br])}const e=I.Tag.render(ir||(ir=zn`
			<button class="ui-btn ui-btn-xs ui-btn-primary ui-btn-round">
				${0}
			</button>
		`),I.Loc.getMessage("CRM_TIMELINE_CONNECT_BTN"));I.Event.bind(e,"click",(()=>Rn(babelHelpers.classPrivateFieldLooseBase(this,hr)[hr].manageUrl)));return e}function Mo(){babelHelpers.classPrivateFieldLooseBase(this,gr)[gr]=I.Tag.render(ar||(ar=zn`
			<div class="crm-entity-stream-content-new-detail-whatsapp-template-title"></div>
		`));babelHelpers.classPrivateFieldLooseBase(this,yr)[yr]=I.Tag.render(lr||(lr=zn`
			<div class="crm-entity-stream-content-new-detail-whatsapp-template-content"></div>
		`));babelHelpers.classPrivateFieldLooseBase(this,mr)[mr]=I.Tag.render(nr||(nr=zn`
			<div class="crm-entity-stream-content-new-detail-whatsapp-template --demo">
				${0}
				${0}
			</div>
		`),babelHelpers.classPrivateFieldLooseBase(this,gr)[gr],babelHelpers.classPrivateFieldLooseBase(this,yr)[yr]);return babelHelpers.classPrivateFieldLooseBase(this,mr)[mr]}function No(){const e=Kn();babelHelpers.classPrivateFieldLooseBase(this,Lr)[Lr]=P.MenuManager.create({id:xn,bindElement:document.querySelector(".crm-entity-stream-content-whatsapp-header-button-settings"),items:[{delimiter:true,text:I.Loc.getMessage("CRM_TIMELINE_MENU_SETTINGS_HEADER")},{id:"communicationsSubmenu",text:I.Loc.getMessage("CRM_TIMELINE_MENU_SETTINGS_RECEIVER"),items:e,events:{onSubMenuShow:e=>{babelHelpers.classPrivateFieldLooseBase(this,so)[so](e,$n(babelHelpers.classPrivateFieldLooseBase(this,ur)[ur],babelHelpers.classPrivateFieldLooseBase(this,Or)[Or].id,babelHelpers.classPrivateFieldLooseBase(this,ao)[ao].bind(this)))}}},{id:"sendersSubmenu",text:I.Loc.getMessage("CRM_TIMELINE_MENU_SETTINGS_SENDER"),items:e,disabled:!I.Type.isArrayFilled(babelHelpers.classPrivateFieldLooseBase(this,hr)[hr].fromList),events:{onSubMenuShow:e=>{babelHelpers.classPrivateFieldLooseBase(this,so)[so](e,Un(babelHelpers.classPrivateFieldLooseBase(this,hr)[hr].fromList,babelHelpers.classPrivateFieldLooseBase(this,Hr)[Hr],babelHelpers.classPrivateFieldLooseBase(this,io)[io].bind(this)))}}}]})}function wo(){I.Dom.removeClass(document.querySelector(".crm-entity-stream-content-whatsapp-container"),"--hidden");I.Dom.removeClass(document.querySelector(".crm-entity-stream-content-whatsapp-footer"),"--hidden");I.Dom.removeClass(document.querySelector(".crm-entity-stream-content-whatsapp"),"--skeleton")}function Ao(e){if(e.ORIGINAL_ID>0){I.Dom.removeClass(babelHelpers.classPrivateFieldLooseBase(this,mr)[mr],"--demo");babelHelpers.classPrivateFieldLooseBase(this,Tr)[Tr]=false}else{I.Dom.addClass(babelHelpers.classPrivateFieldLooseBase(this,mr)[mr],"--demo");babelHelpers.classPrivateFieldLooseBase(this,Tr)[Tr]=true}babelHelpers.classPrivateFieldLooseBase(this,uo)[uo](e);babelHelpers.classPrivateFieldLooseBase(this,gr)[gr].textContent=e.TITLE;babelHelpers.classPrivateFieldLooseBase(this,co)[co](e);babelHelpers.classPrivateFieldLooseBase(this,Sr)[Sr]=e;babelHelpers.classPrivateFieldLooseBase(this,Zr)[Zr]()}function Ro(){if(babelHelpers.classPrivateFieldLooseBase(this,mo)[mo]()){babelHelpers.classPrivateFieldLooseBase(this,Or)[Or]=null;babelHelpers.classPrivateFieldLooseBase(this,Mr)[Mr]=null;babelHelpers.classPrivateFieldLooseBase(this,Nr)[Nr]=null;return}const e=babelHelpers.classPrivateFieldLooseBase(this,ur)[ur][0];if(I.Type.isArrayFilled(e.phones)){babelHelpers.classPrivateFieldLooseBase(this,Or)[Or]=e.phones[0];babelHelpers.classPrivateFieldLooseBase(this,Mr)[Mr]=e.entityTypeId;babelHelpers.classPrivateFieldLooseBase(this,Nr)[Nr]=e.entityId}}function Do(){if(!babelHelpers.classPrivateFieldLooseBase(this,hr)[hr]||!I.Type.isArrayFilled(babelHelpers.classPrivateFieldLooseBase(this,hr)[hr].fromList)){return}const{fromList:e}=babelHelpers.classPrivateFieldLooseBase(this,hr)[hr];const t=e.find((e=>e.default));babelHelpers.classPrivateFieldLooseBase(this,Hr)[Hr]=t?t.id:e[0].id}function ko(){const e=!babelHelpers.classPrivateFieldLooseBase(this,Tr)[Tr]&&babelHelpers.classPrivateFieldLooseBase(this,ur)[ur].length>0&&babelHelpers.classPrivateFieldLooseBase(this,Or)[Or]!==null&&babelHelpers.classPrivateFieldLooseBase(this,Sr)[Sr]!==null;if(e){I.Dom.removeClass(babelHelpers.classPrivateFieldLooseBase(this,pr)[pr],"ui-btn-disabled")}else{I.Dom.addClass(babelHelpers.classPrivateFieldLooseBase(this,pr)[pr],"ui-btn-disabled")}}function xo(){if(!babelHelpers.classPrivateFieldLooseBase(this,Pr)[Pr]){babelHelpers.classPrivateFieldLooseBase(this,ho)[ho]()}babelHelpers.classPrivateFieldLooseBase(this,Pr)[Pr].show();babelHelpers.classPrivateFieldLooseBase(this,Po)[Po]()}function jo(){if(babelHelpers.classPrivateFieldLooseBase(this,Or)[Or]===null){this.showNotify(I.Loc.getMessage("CRM_TIMELINE_SMS_WHATSAPP_NO_PHONE_ERROR"));return}if(!babelHelpers.classPrivateFieldLooseBase(this,Lr)[Lr]){babelHelpers.classPrivateFieldLooseBase(this,Wr)[Wr]()}babelHelpers.classPrivateFieldLooseBase(this,Lr)[Lr].show()}function Xo(e){if(top.BX.Helper&&e>0){top.BX.Helper.show(`redirect=detail&code=${e}`)}babelHelpers.classPrivateFieldLooseBase(this,yo)[yo]()}function Ko(e,t){var s;const i=e.getTarget();for(const e of t){var a;(a=i.getSubMenu())==null?void 0:a.addMenuItem(e)}(s=i.getSubMenu())==null?void 0:s.removeMenuItem(kn)}function Uo(e,t){const{id:s}=t;babelHelpers.classPrivateFieldLooseBase(this,Hr)[Hr]=s;babelHelpers.classPrivateFieldLooseBase(this,Lr)[Lr].close()}function $o(e,t){const{id:s}=t;babelHelpers.classPrivateFieldLooseBase(this,ur)[ur].forEach((e=>{const t=e.phones.find((e=>e.id===s));if(t){babelHelpers.classPrivateFieldLooseBase(this,Or)[Or]=t;babelHelpers.classPrivateFieldLooseBase(this,Mr)[Mr]=e.entityTypeId;babelHelpers.classPrivateFieldLooseBase(this,Nr)[Nr]=e.entityId}}));babelHelpers.classPrivateFieldLooseBase(this,Lr)[Lr].close()}function Go(e){var t,s;if(babelHelpers.classPrivateFieldLooseBase(this,Tr)[Tr]){return}An((t=(s=babelHelpers.classPrivateFieldLooseBase(this,Sr)[Sr])==null?void 0:s.ORIGINAL_ID)!=null?t:null,this.getEntityTypeId(),this.getEntityCategoryId(),e).catch((e=>console.error(e)))}function Vo(){if(babelHelpers.classPrivateFieldLooseBase(this,mo)[mo]()){L.MessageBox.alert(I.Loc.getMessage("CRM_TIMELINE_SMS_ERROR_NO_COMMUNICATIONS"));return}if(!babelHelpers.classPrivateFieldLooseBase(this,Sr)[Sr]||babelHelpers.classPrivateFieldLooseBase(this,Tr)[Tr]){return}const e=babelHelpers.classPrivateFieldLooseBase(this,po)[po]();if(e===""){return}if(babelHelpers.classPrivateFieldLooseBase(this,Ir)[Ir]||babelHelpers.classPrivateFieldLooseBase(this,Cr)[Cr]){return}this.setLocked(true);babelHelpers.classPrivateFieldLooseBase(this,Ir)[Ir]=true;babelHelpers.classPrivateFieldLooseBase(this,Cr)[Cr]=true;wn(babelHelpers.classPrivateFieldLooseBase(this,dr)[dr],babelHelpers.classPrivateFieldLooseBase(this,hr)[hr].id,{MESSAGE_FROM:babelHelpers.classPrivateFieldLooseBase(this,Hr)[Hr],MESSAGE_TO:babelHelpers.classPrivateFieldLooseBase(this,Or)[Or].value,MESSAGE_BODY:e,MESSAGE_TEMPLATE:babelHelpers.classPrivateFieldLooseBase(this,Sr)[Sr].ID,MESSAGE_TEMPLATE_ORIGINAL_ID:babelHelpers.classPrivateFieldLooseBase(this,Sr)[Sr].ORIGINAL_ID,MESSAGE_TEMPLATE_WITH_PLACEHOLDER:I.Type.isPlainObject(babelHelpers.classPrivateFieldLooseBase(this,_r)[_r]),OWNER_TYPE_ID:this.getEntityTypeId(),OWNER_ID:this.getEntityId(),TO_ENTITY_TYPE_ID:babelHelpers.classPrivateFieldLooseBase(this,Mr)[Mr],TO_ENTITY_ID:babelHelpers.classPrivateFieldLooseBase(this,Nr)[Nr]},babelHelpers.classPrivateFieldLooseBase(this,ro)[ro].bind(this),babelHelpers.classPrivateFieldLooseBase(this,oo)[oo].bind(this)).then((()=>this.setLocked(false)),(()=>this.setLocked(false))).catch((()=>this.setLocked(false)));babelHelpers.classPrivateFieldLooseBase(this,Lo)[Lo](babelHelpers.classPrivateFieldLooseBase(this,Sr)[Sr].ORIGINAL_ID)}function Wo(e){babelHelpers.classPrivateFieldLooseBase(this,Ir)[Ir]=false;babelHelpers.classPrivateFieldLooseBase(this,Cr)[Cr]=false;const t=BX.prop.getString(e,"ERROR","");if(I.Type.isStringFilled(t)){L.MessageBox.alert(I.Text.encode(t));return}babelHelpers.classPrivateFieldLooseBase(this,qr)[qr](I.Runtime.clone(this.getSetting("demoTemplate")));babelHelpers.classPrivateFieldLooseBase(this,Pr)[Pr]=null;this.emitFinishEditEvent()}function zo(){babelHelpers.classPrivateFieldLooseBase(this,Ir)[Ir]=false;babelHelpers.classPrivateFieldLooseBase(this,Cr)[Cr]=false}function qo(e){const t=e==null?void 0:e.PREVIEW.replaceAll("\n","<br>");const s={target:babelHelpers.classPrivateFieldLooseBase(this,yr)[yr],entityId:this.getEntityId(),entityTypeId:this.getEntityTypeId(),categoryId:this.getEntityCategoryId(),canUsePreview:true,onSelect:e=>babelHelpers.classPrivateFieldLooseBase(this,lo)[lo](e)};babelHelpers.classPrivateFieldLooseBase(this,fr)[fr]=new m.Editor(s).setPlaceholders(babelHelpers.classPrivateFieldLooseBase(this,_r)[_r]).setFilledPlaceholders(babelHelpers.classPrivateFieldLooseBase(this,Br)[Br]);babelHelpers.classPrivateFieldLooseBase(this,fr)[fr].setBody(t);E.EventEmitter.subscribeOnce("BX.Crm.Template.Editor:shown",babelHelpers.classPrivateFieldLooseBase(this,go)[go].bind(this))}function Yo(e){const t=this.getEntityTypeId();const s=this.getEntityId();const i=this.getEntityCategoryId();const a={targetNode:babelHelpers.classPrivateFieldLooseBase(this,vr)[vr],multiple:false,showAvatars:false,dropdownMode:true,enableSearch:true,context:`SMS-TEMPLATE-SELECTOR-$entityTypeId}-${i}`,tagSelectorOptions:{textBoxWidth:"100%"},width:450,entities:[{id:"message_template",options:{senderId:babelHelpers.classPrivateFieldLooseBase(this,hr)[hr].id,entityTypeId:t,entityId:s,categoryId:i}}],events:{"Item:onSelect":e=>{const t=e.getData().item;babelHelpers.classPrivateFieldLooseBase(this,qr)[qr](t.getCustomData().get("template"))}}};const l=babelHelpers.classPrivateFieldLooseBase(this,bo)[bo]();if(I.Type.isArrayFilled(l)){a.footer=l}babelHelpers.classPrivateFieldLooseBase(this,Pr)[Pr]=new y.Dialog({...a,...e})}function Jo(e){var t;const s=(t=e.PLACEHOLDERS)!=null?t:null;if(!I.Type.isPlainObject(s)){babelHelpers.classPrivateFieldLooseBase(this,_r)[_r]=null;babelHelpers.classPrivateFieldLooseBase(this,Br)[Br]=null;return}babelHelpers.classPrivateFieldLooseBase(this,_r)[_r]=s;if(!I.Type.isArray(e.FILLED_PLACEHOLDERS)){e.FILLED_PLACEHOLDERS=[]}babelHelpers.classPrivateFieldLooseBase(this,Br)[Br]=e.FILLED_PLACEHOLDERS}function Zo(){let e="";if(babelHelpers.classPrivateFieldLooseBase(this,fr)[fr]){const t=babelHelpers.classPrivateFieldLooseBase(this,fr)[fr].getData();if(I.Type.isPlainObject(t)){e=t.body}}if(e===""&&babelHelpers.classPrivateFieldLooseBase(this,Sr)[Sr]){e=babelHelpers.classPrivateFieldLooseBase(this,Sr)[Sr].PREVIEW}return e}function Qo(){const e=()=>{BX.UI.Feedback.Form.open({id:"b24_crm_timeline_whatsapp_template_suggest_form",forms:[{zones:["ru","by","kz"],id:758,lang:"ru",sec:"jyafqa"},{zones:["en"],id:760,lang:"en",sec:"culzcq"},{zones:["de"],id:764,lang:"de",sec:"9h74xf"},{zones:["com.br"],id:766,lang:"com.br",sec:"ddkhcc"},{zones:["es"],id:762,lang:"es",sec:"6ni833"},{zones:["en"],id:760,lang:"en",sec:"culzcq"}]});babelHelpers.classPrivateFieldLooseBase(this,fo)[fo]()};return[I.Tag.render(rr||(rr=zn`<span style="width: 100%;"></span>`)),I.Tag.render(or||(or=zn`
				<span onclick="${0}" class="ui-selector-footer-link">
					${0}
				</span>
			`),e,I.Loc.getMessage("CRM_TIMELINE_SMS_WHATSAPP_SELECTOR_FOOTER_BUTTON"))]}function ec(){return I.Type.isArrayFilled(babelHelpers.classPrivateFieldLooseBase(this,wr)[wr])&&!BX.Crm.EntityEditor.getDefault().isNew()}function tc(){if(babelHelpers.classPrivateFieldLooseBase(this,ur)[ur].length===0){return true}return!I.Type.isArrayFilled(babelHelpers.classPrivateFieldLooseBase(this,ur)[ur][0].phones)}function sc(){babelHelpers.classPrivateFieldLooseBase(this,Bo)[Bo]()}function ic(){if(babelHelpers.classPrivateFieldLooseBase(this,Rr)[Rr]){return}const e=v.Builder.Communication.FormEvent.createDefault(this.getEntityTypeId()).setElement(v.Dictionary.ELEMENT_WA_HELP);babelHelpers.classPrivateFieldLooseBase(this,Rr)[Rr]=true;babelHelpers.classPrivateFieldLooseBase(this,Eo)[Eo](e)}function ac(e=null){const t=v.Builder.Communication.SendEvent.createDefault(this.getEntityTypeId()).setElement(v.Dictionary.ELEMENT_WA_SEND).setContactsCount(1);if(babelHelpers.classPrivateFieldLooseBase(this,xr)[xr]){t.setResend();babelHelpers.classPrivateFieldLooseBase(this,xr)[xr]=false}if(e){t.setTemplateId(e)}babelHelpers.classPrivateFieldLooseBase(this,Eo)[Eo](t)}function lc(){if(babelHelpers.classPrivateFieldLooseBase(this,kr)[kr]){return}const e=v.Builder.Communication.FormEvent.createDefault(this.getEntityTypeId()).setElement(v.Dictionary.ELEMENT_WA_TEMPLATE_OFFER);babelHelpers.classPrivateFieldLooseBase(this,kr)[kr]=true;babelHelpers.classPrivateFieldLooseBase(this,Eo)[Eo](e)}function nc(){if(babelHelpers.classPrivateFieldLooseBase(this,Dr)[Dr]){return}const e=v.Builder.Communication.FormEvent.createDefault(this.getEntityTypeId()).setElement(v.Dictionary.ELEMENT_WA_TEMPLATE_SELECTOR);babelHelpers.classPrivateFieldLooseBase(this,Dr)[Dr]=true;babelHelpers.classPrivateFieldLooseBase(this,Eo)[Eo](e)}function rc(e=null){const t=v.Builder.Communication.SendEvent.createDefault(this.getEntityTypeId()).setElement(v.Dictionary.ELEMENT_WA_CANCEL);if(e){t.setTemplateId(e)}babelHelpers.classPrivateFieldLooseBase(this,Eo)[Eo](t)}function oc(){const e=v.Builder.Communication.FormEvent.createDefault(this.getEntityTypeId()).setElement(v.Dictionary.ELEMENT_WA_PREVIEW);babelHelpers.classPrivateFieldLooseBase(this,Eo)[Eo](e)}function cc(e){e.setEvent(v.Dictionary.EVENT_WA_TIMELINE).setSubSection(v.Dictionary.SUB_SECTION_DETAILS);g.sendData(e.buildData())}class dc extends j{showSlider(){BX.CrmActivityEditor.getDefault().addTask({ownerType:BX.CrmEntityType.resolveName(this.getEntityTypeId()),ownerID:this.getEntityId(),fromTimeline:true})}supportsLayout(){return false}}const hc=I.Reflection.namespace("BX.userOptions");class uc extends ie{canShow(){const{guideBindElement:e}=this.getParams();const t=document.querySelector('[data-tab-id="main"]');if(!t||I.Dom.style(t,"display")==="none"){return false}const s=window.getComputedStyle(e);return document.contains(e)&&s.display!=="none"&&s.visibility!=="hidden"&&s.opacity!=="0"&&e.offsetWidth>0&&e.offsetHeight>0}saveUserOption(e=null){hc.save("crm","todo","isTimelineTourViewedInWeb",1)}}let pc=e=>e,bc,vc,mc;const gc="21064046";var yc=babelHelpers.classPrivateFieldLooseKey("toDoEditor");var Lc=babelHelpers.classPrivateFieldLooseKey("todoEditorContainer");var fc=babelHelpers.classPrivateFieldLooseKey("saveButton");var Pc=babelHelpers.classPrivateFieldLooseKey("isTourViewed");var _c=babelHelpers.classPrivateFieldLooseKey("createEditor");class Bc extends j{constructor(...e){super(...e);Object.defineProperty(this,_c,{value:Ec});Object.defineProperty(this,yc,{writable:true,value:null});Object.defineProperty(this,Lc,{writable:true,value:null});Object.defineProperty(this,fc,{writable:true,value:null});Object.defineProperty(this,Pc,{writable:true,value:false})}initialize(e,t){super.initialize(e,t)}createLayout(){babelHelpers.classPrivateFieldLooseBase(this,Lc)[Lc]=I.Tag.render(bc||(bc=pc`<div></div>`));babelHelpers.classPrivateFieldLooseBase(this,fc)[fc]=I.Tag.render(vc||(vc=pc`<button onclick="${0}" class="ui-btn ui-btn-xs ui-btn-primary ui-btn-round ui-btn-disabled" >${0}</button>`),this.onSaveButtonClick.bind(this),I.Loc.getMessage("CRM_TIMELINE_SAVE_BUTTON"));return I.Tag.render(mc||(mc=pc`
			<div class="crm-entity-stream-content-new-detail crm-entity-stream-content-new-detail-todo --hidden">
				${0}
				<div class="crm-entity-stream-content-new-comment-btn-container">
					${0}
					<span onclick="${0}"  class="ui-btn ui-btn-xs ui-btn-link">${0}</span>
				</div>
			</div>
		`),babelHelpers.classPrivateFieldLooseBase(this,Lc)[Lc],babelHelpers.classPrivateFieldLooseBase(this,fc)[fc],this.onCancelButtonClick.bind(this),I.Loc.getMessage("CRM_TIMELINE_CANCEL_BTN"))}initializeLayout(){I.Dom.removeClass(babelHelpers.classPrivateFieldLooseBase(this,fc)[fc],"ui-btn-disabled");babelHelpers.classPrivateFieldLooseBase(this,_c)[_c]()}initializeSettings(){babelHelpers.classPrivateFieldLooseBase(this,Pc)[Pc]=this.getSetting("isTourViewed")}onSaveButtonClick(){if(this.isLocked()||I.Dom.hasClass(babelHelpers.classPrivateFieldLooseBase(this,fc)[fc],"ui-btn-disabled")){return}this.setLocked(true);this.save().then((()=>this.setLocked(false)),(()=>this.setLocked(false))).catch((()=>this.setLocked(false)))}onCancelButtonClick(){this.cancel();this.emitFinishEditEvent()}save(){if(I.Dom.hasClass(babelHelpers.classPrivateFieldLooseBase(this,fc)[fc],"ui-btn-disabled")){return false}return babelHelpers.classPrivateFieldLooseBase(this,yc)[yc].save().then((e=>{if(I.Type.isArray(e.errors)&&e.errors.length>0){return false}this.cancel(false);this.emitFinishEditEvent();return true}))}cancel(e=true){babelHelpers.classPrivateFieldLooseBase(this,yc)[yc].cancel({sendAnalytics:e});this.setFocused(false)}bindInputHandlers(){}setParentActivityId(e){babelHelpers.classPrivateFieldLooseBase(this,yc)[yc].setParentActivityId(e)}setDeadLine(e){babelHelpers.classPrivateFieldLooseBase(this,yc)[yc].setDeadline(e)}setDescription(e){babelHelpers.classPrivateFieldLooseBase(this,yc)[yc].setDescription(e)}focus(){babelHelpers.classPrivateFieldLooseBase(this,yc)[yc].setFocused()}setVisible(e){super.setVisible(e);if(e){this.showTour()}}showTour(){if(!this.isVisible()){return}const e=".crm-activity__todo-show-actions-popup-button";const t=document.querySelector(e);if(t&&!babelHelpers.classPrivateFieldLooseBase(this,Pc)[Pc]&&!BX.Crm.EntityEditor.getDefault().isNew()){const e=new uc({itemCode:"todo",title:I.Loc.getMessage("CRM_TIMELINE_TODO_GUIDE_TITLE"),text:I.Loc.getMessage("CRM_TIMELINE_TODO_GUIDE_TEXT"),articleCode:gc,userOptionName:"isTimelineTourViewedInWeb",guideBindElement:t});setTimeout((()=>{B.TourManager.getInstance().registerWithLaunch(e)}))}}}function Ec(){const e={container:babelHelpers.classPrivateFieldLooseBase(this,Lc)[Lc],defaultDescription:"",ownerTypeId:this.getEntityTypeId(),ownerId:this.getEntityId(),currentUser:this.getSetting("currentUser"),pingSettings:this.getSetting("pingSettings"),copilotSettings:this.getSetting("copilotSettings"),colorSettings:this.getSetting("colorSettings"),actionMenuSettings:this.getSetting("actionMenuSettings"),events:{onCollapsingToggle:e=>{const{isOpen:t}=e.getData();this.setFocused(t)}}};e.calendarSettings=this.getSetting("calendarSettings");const t=this.getExtras();if(I.Type.isPlainObject(t.analytics)){e.analytics={section:t.analytics.c_section,subSection:t.analytics.c_sub_section}}babelHelpers.classPrivateFieldLooseBase(this,yc)[yc]=new _.TodoEditorV2(e);babelHelpers.classPrivateFieldLooseBase(this,yc)[yc].show()}class Tc extends j{showSlider(){var e;const t=(e=this.getSettings())!=null?e:{};t["OWNER_TYPE"]=BX.CrmEntityType.resolveName(this.getEntityTypeId());t["OWNER_ID"]=this.getEntityId();BX.CrmActivityVisit.create(t).showEdit()}supportsLayout(){return false}}let Ic=e=>e,Cc,Fc,Sc,Hc,Oc;class Mc{constructor(){this._popup=null;this._menuId=null;this._id="";this._settings={};this._type=jc.WaitingType.undefined;this._duration=0;this._target="";this._targetDates=[];this._container=null;this._durationInput=null;this._targetDateNode=null;this._popup=null}initialize(e,t){this._id=BX.type.isNotEmptyString(e)?e:BX.util.getRandomString(4);this._settings=t||{};this._type=BX.prop.getInteger(this._settings,"type",jc.WaitingType.after);this._duration=BX.prop.getInteger(this._settings,"duration",1);this._target=BX.prop.getString(this._settings,"target","");this._targetDates=BX.prop.getArray(this._settings,"targetDates",[]);this._menuId=`${this._id}_target_date_sel`}getId(){return this._id}getType(){return this._type}setType(e){this._type=e}getDuration(){return this._duration}setDuration(e){this._duration=e}getTarget(){return this._target}setTarget(e){this._target=e}getMessage(e){const t=Mc.messages;return Object.prototype.hasOwnProperty.call(t,e)?t[e]:e}getTargetDateCaption(){var e,t;return(e=(t=this._targetDates.find((e=>e.name===this._target)))==null?void 0:t.caption)!=null?e:""}isBeforeWaitingType(){return this.getType()===jc.WaitingType.before}open(){this._popup=new BX.PopupWindow(this._id,null,{autoHide:true,draggable:false,bindOptions:{forceBindPosition:false},closeByEsc:true,zIndex:0,content:this.renderDialogContent(),events:{onPopupShow:this.onPopupShow.bind(this),onPopupClose:this.onPopupClose.bind(this),onPopupDestroy:this.onPopupDestroy.bind(this)},buttons:[new BX.PopupWindowButton({text:I.Loc.getMessage("CRM_TIMELINE_CHOOSE"),className:"popup-window-button-accept",events:{click:this.onSaveButtonClick.bind(this)}}),new BX.PopupWindowButtonLink({text:I.Loc.getMessage("JS_CORE_WINDOW_CANCEL"),events:{click:this.onCancelButtonClick.bind(this)}})]});this._popup.show()}close(){if(this._popup){this._popup.close()}}renderDialogContent(){const e=this.getContainer();e.innerHTML="";const t=I.Tag.render(Cc||(Cc=Ic`<div class="crm-wait-popup-select-wrapper"></div>`));const s=this.getContentTextNode();this.appendDurationInput(s);this.appendTargetDateNode(s);I.Dom.append(s,t);I.Dom.append(t,e);return e}getContainer(){if(!this._container){this._container=I.Tag.render(Fc||(Fc=Ic`<div class="crm-wait-popup-select-block"></div>`))}return this._container}getContentTextNode(){const e=this.isBeforeWaitingType()?"CRM_TIMELINE_WAIT_CONFIG_DIALOG_BEFORE_CONTENT_TEXT":"CRM_TIMELINE_WAIT_CONFIG_DIALOG_AFTER_CONTENT_TEXT";const t={"#DAY_INPUT#":`<span class="crm-wait-duration-input-container" id="${this.getDurationInputContainerId()}"></span>`,"#TARGET_DATE#":this.isBeforeWaitingType()?`<span class="crm-wait-target-date-container" id="${this.getTargetDateNodeContainerId()}"></span>`:null};return I.Tag.render(Sc||(Sc=Ic`
			<span class="crm-wait-text-wrapper crm-wait-popup-settings-title">
				${0}
			</span>
		`),I.Loc.getMessagePlural(e,this.getDuration(),t))}getDurationInputContainerId(){return`crm-wait-duration-input-container-${this.getId()}`}getDurationInput(){if(!this._durationInput){this._durationInput=I.Tag.render(Hc||(Hc=Ic`
				<input type="text" class="crm-wait-popup-settings-input" value="${0}">
			`),this.getDuration());this._durationInput.onkeyup=I.Runtime.debounce(this.onDurationChange.bind(this),300)}return this._durationInput}appendDurationInput(e){const t=this.getDurationInputContainerId();const s=e.querySelector(`#${t}`);I.Dom.append(this.getDurationInput(),s)}onDurationChange(){let e=parseInt(this.getDurationInput().value,10);if(Number.isNaN(e)||e<=0){e=1}this._duration=e;this.renderDialogContent();this.getDurationInput().focus()}getTargetDateNodeContainerId(){return`crm-wait-configuration-dialog-target-date-container-${this.getId()}`}getTargetDateNode(){if(!this._targetDateNode){this._targetDateNode=I.Tag.render(Oc||(Oc=Ic`
				<span class="crm-automation-popup-settings-link">
					${0}
				</span>
			`),I.Text.encode(this.getTargetDateCaption(this._target)));this._targetDateNode.onclick=this.toggleTargetMenu.bind(this)}return this._targetDateNode}appendTargetDateNode(e){if(!this.isBeforeWaitingType()){return}const t=this.getTargetDateNodeContainerId();const s=e.querySelector(`#${t}`);I.Dom.append(this.getTargetDateNode(),s)}toggleTargetMenu(){if(this.isTargetMenuOpened()){this.closeTargetMenu()}else{this.openTargetMenu()}}isTargetMenuOpened(){return Boolean(BX.PopupMenu.getMenuById(this._menuId))}openTargetMenu(){const e=[];let t=0;const s=this._targetDates.length;for(;t<s;t++){const s=this._targetDates[t];e.push({text:s.caption,title:s.caption,value:s.name,onclick:this.onTargetSelect.bind(this)})}BX.PopupMenu.show(this._menuId,this._targetDateNode,e,{zIndex:200,autoHide:true,offsetLeft:I.Dom.getPosition(this.getTargetDateNode()).width/2,angle:{position:"top",offset:0}})}closeTargetMenu(){BX.PopupMenu.destroy(this._menuId)}onPopupShow(e,t){}onPopupClose(){if(this._popup){this._popup.destroy()}this.closeTargetMenu()}onPopupDestroy(){if(this._popup){this._popup=null}}onSaveButtonClick(e){this.onDurationChange();const t=BX.prop.getFunction(this._settings,"onSave",null);if(!t){return}t(this,{type:this.getType(),duration:this.getDuration(),target:this.isBeforeWaitingType()?this.getTarget():""})}onCancelButtonClick(e){const t=BX.prop.getFunction(this._settings,"onCancel",null);if(t){t(this)}}onTargetSelect(e,t){const s=BX.prop.getString(t,"value","");if(s!==""){this._target=s;this._targetDateNode.innerHTML=BX.util.htmlspecialchars(this.getTargetDateCaption(s))}this.closeTargetMenu();e.preventDefault?e.preventDefault():e.returnValue=false}static create(e,t){const s=new Mc;s.initialize(e,t);return s}}Mc.messages={};let Nc=e=>e,wc,Ac,Rc,Dc,kc;var xc=babelHelpers.classPrivateFieldLooseKey("waitConfigContainer");class jc extends $e{constructor(...e){super(...e);Object.defineProperty(this,xc,{writable:true,value:null})}createLayout(){babelHelpers.classPrivateFieldLooseBase(this,xc)[xc]=I.Tag.render(wc||(wc=Nc`<div class="crm-entity-stream-content-wait-conditions"></div>`));this._saveButton=I.Tag.render(Ac||(Ac=Nc`<button onclick="${0}" class="ui-btn ui-btn-xs ui-btn-primary ui-btn-round" >${0}</button>`),this.onSaveButtonClick.bind(this),I.Loc.getMessage("CRM_TIMELINE_CREATE_WAITING"));this._cancelButton=I.Tag.render(Rc||(Rc=Nc`<span onclick="${0}"  class="ui-btn ui-btn-xs ui-btn-link">${0}</span>`),this.onCancelButtonClick.bind(this),I.Loc.getMessage("CRM_TIMELINE_CANCEL_BTN"));this._input=I.Tag.render(Dc||(Dc=Nc`<textarea rows="1" class="crm-entity-stream-content-wait-comment-textarea" placeholder="${0}"></textarea>`),I.Loc.getMessage("CRM_TIMELINE_WAIT_PLACEHOLDER"));return I.Tag.render(kc||(kc=Nc`<div class="crm-entity-stream-content-wait-detail --focus --hidden">
			<div class="crm-entity-stream-content-wait-conditions-container">
				${0}
			</div>
			${0}
			<div class="crm-entity-stream-content-wait-comment-btn-container">
				${0}
				${0}
			</div>
		</div>`),babelHelpers.classPrivateFieldLooseBase(this,xc)[xc],this._input,this._saveButton,this._cancelButton)}doInitialize(){this._isRequestRunning=false;this._isLocked=false;this._hideButtonsOnBlur=false;this._type=jc.WaitingType.after;this._duration=1;this._target="";this._configSelector=null;this._isMenuShown=false;this._menu=null;this._configDialog=null;this._serviceUrl=this.getSetting("serviceUrl","");const e=this.getSetting("config",{});this._type=jc.WaitingType.resolveTypeId(BX.prop.getString(e,"type",jc.WaitingType.names.after));this._duration=BX.prop.getInteger(e,"duration",1);this._target=BX.prop.getString(e,"target","");this._targetDates=this.getSetting("targetDates",[]);this.layoutConfigurationSummary()}getDurationText(e,t){return jc.Helper.getDurationText(e,t)}getTargetDateCaption(e){let t=0;const s=this._targetDates.length;for(;t<s;t++){const s=this._targetDates[t];if(s["name"]===e){return s["caption"]}}return""}onSelectorClick(e){if(!this._isMenuShown){this.openMenu()}else{this.closeMenu()}e.preventDefault?e.preventDefault():e.returnValue=false}openMenu(){if(this._isMenuShown){return}const e=BX.delegate(this.onMenuItemClick,this);const t=[{id:"day_1",text:I.Loc.getMessage("CRM_TIMELINE_WAIT_1D"),onclick:e},{id:"day_2",text:I.Loc.getMessage("CRM_TIMELINE_WAIT_2D"),onclick:e},{id:"day_3",text:I.Loc.getMessage("CRM_TIMELINE_WAIT_3D"),onclick:e},{id:"week_1",text:I.Loc.getMessage("CRM_TIMELINE_WAIT_1W"),onclick:e},{id:"week_2",text:I.Loc.getMessage("CRM_TIMELINE_WAIT_2W"),onclick:e},{id:"week_3",text:I.Loc.getMessage("CRM_TIMELINE_WAIT_3W"),onclick:e}];const s={id:"custom",text:I.Loc.getMessage("CRM_TIMELINE_WAIT_CUSTOM"),items:[]};s["items"].push({id:"afterDays",text:I.Loc.getMessage("CRM_TIMELINE_WAIT_AFTER_CUSTOM_DAYS"),onclick:e});if(this._targetDates.length>0){s["items"].push({id:"beforeDate",text:I.Loc.getMessage("CRM_TIMELINE_WAIT_BEFORE_CUSTOM_DATE"),onclick:e})}t.push(s);BX.PopupMenu.show(this._id,this._configSelector,t,{offsetTop:0,offsetLeft:36,angle:{position:"top",offset:0},events:{onPopupShow:BX.delegate(this.onMenuShow,this),onPopupClose:BX.delegate(this.onMenuClose,this),onPopupDestroy:BX.delegate(this.onMenuDestroy,this)}});this._menu=BX.PopupMenu.currentItem}closeMenu(){if(!this._isMenuShown){return}if(this._menu){this._menu.close()}}onMenuItemClick(e,t){this.closeMenu();if(t.id==="afterDays"||t.id==="beforeDate"){this.openConfigDialog(t.id==="afterDays"?jc.WaitingType.after:jc.WaitingType.before);return}const s={type:jc.WaitingType.after};if(t.id==="day_1"){s["duration"]=1}else if(t.id==="day_2"){s["duration"]=2}else if(t.id==="day_3"){s["duration"]=3}if(t.id==="week_1"){s["duration"]=7}else if(t.id==="week_2"){s["duration"]=14}else if(t.id==="week_3"){s["duration"]=21}this.saveConfiguration(s)}openConfigDialog(e){if(!this._configDialog){this._configDialog=Mc.create("",{targetDates:this._targetDates,onSave:BX.delegate(this.onConfigDialogSave,this),onCancel:BX.delegate(this.onConfigDialogCancel,this)})}this._configDialog.setType(e);this._configDialog.setDuration(this._duration);let t=this._target;if(t===""&&this._targetDates.length>0){t=this._targetDates[0]["name"]}this._configDialog.setTarget(t);this._configDialog.open()}onConfigDialogSave(e,t){this.saveConfiguration(t);this._configDialog.close()}onConfigDialogCancel(e){this._configDialog.close()}onMenuShow(){this._isMenuShown=true}onMenuClose(){if(this._menu&&this._menu.popupWindow){this._menu.popupWindow.destroy()}}onMenuDestroy(){this._isMenuShown=false;this._menu=null;if(typeof BX.PopupMenu.Data[this._id]!=="undefined"){delete BX.PopupMenu.Data[this._id]}}saveConfiguration(e){this._type=BX.prop.getInteger(e,"type",jc.WaitingType.after);this._duration=BX.prop.getInteger(e,"duration",0);if(this._duration<=0){this._duration=1}this._target=this._type===jc.WaitingType.before?BX.prop.getString(e,"target",""):"";const t=this.getSetting("optionName");BX.userOptions.save("crm.timeline.wait",t,"type",this._type===jc.WaitingType.after?"after":"before");BX.userOptions.save("crm.timeline.wait",t,"duration",this._duration);BX.userOptions.save("crm.timeline.wait",t,"target",this._target);this.layoutConfigurationSummary()}getSummaryHtml(){if(this._type===jc.WaitingType.before){return I.Loc.getMessage("CRM_TIMELINE_WAIT_COMPLETION_TYPE_BEFORE").replace("#DURATION#",this.getDurationText(this._duration,true)).replace("#TARGET_DATE#",this.getTargetDateCaption(this._target))}return I.Loc.getMessage("CRM_TIMELINE_WAIT_COMPLETION_TYPE_AFTER").replace("#DURATION#",this.getDurationText(this._duration,true))}getSummaryText(){return BX.util.strip_tags(this.getSummaryHtml())}layoutConfigurationSummary(){babelHelpers.classPrivateFieldLooseBase(this,xc)[xc].innerHTML=this.getSummaryHtml();this._configSelector=babelHelpers.classPrivateFieldLooseBase(this,xc)[xc].querySelector("a");if(this._configSelector){BX.bind(this._configSelector,"click",this.onSelectorClick.bind(this))}}postpone(e,t,s){BX.ajax({url:this._serviceUrl,method:"POST",dataType:"json",data:{ACTION:"POSTPONE_WAIT",DATA:{ID:e,OFFSET:t}},onsuccess:s})}complete(e,t,s){BX.ajax({url:this._serviceUrl,method:"POST",dataType:"json",data:{ACTION:"COMPLETE_WAIT",DATA:{ID:e,COMPLETED:t?"Y":"N"}},onsuccess:s})}save(){if(this._isRequestRunning||this._isLocked){return}let e=this.getSummaryText();const t=BX.util.trim(this._input.value);if(t!==""){e+="\n"+t}const s={ID:0,typeId:this._type,duration:this._duration,targetFieldName:this._target,subject:"",description:e,completed:0,ownerType:BX.CrmEntityType.resolveName(this.getEntityTypeId()),ownerID:this.getEntityId()};BX.ajax({url:this._serviceUrl,method:"POST",dataType:"json",data:{ACTION:"SAVE_WAIT",DATA:s},onsuccess:BX.delegate(this.onSaveSuccess,this),onfailure:BX.delegate(this.onSaveFailure,this)});this._isRequestRunning=this._isLocked=true}cancel(){this._input.value="";this._input.style.minHeight="";this.release()}onSaveSuccess(e){this._isRequestRunning=this._isLocked=false;const t=BX.prop.getString(e,"ERROR","");if(t!==""){alert(t);return}this._input.value="";this._input.style.minHeight="";this.emitFinishEditEvent();this.release()}onSaveFailure(){this._isRequestRunning=this._isLocked=false}getMessage(e){const t=jc.messages;return t.hasOwnProperty(e)?t[e]:e}}jc.WaitingType={undefined:0,after:1,before:2,names:{after:"after",before:"before"},resolveTypeId:function(e){if(e===this.names.after){return this.after}else if(e===this.names.before){return this.before}return this.undefined}};jc.messages={};jc.Helper={getDurationText:function(e,t){t=!!t;let s="";let i="D";if(t){if(e%7===0){e=e/7;i="W"}}if(i==="W"){s=BX.Loc.getMessagePlural("CRM_TIMELINE_WAIT_WEEK",e)}else{s=BX.Loc.getMessagePlural("CRM_TIMELINE_WAIT_DAY",e)}if(t){s=e.toString()+" "+s}return s},getMessage:function(e){return jc.Helper.messages.hasOwnProperty(e)?jc.Helper.messages[e]:e},messages:{}};let Xc=e=>e,Kc;var Uc=babelHelpers.classPrivateFieldLooseKey("editor");var $c=babelHelpers.classPrivateFieldLooseKey("createEditor");var Gc=babelHelpers.classPrivateFieldLooseKey("onFinishEdit");class Vc extends j{constructor(...e){super(...e);Object.defineProperty(this,Gc,{value:zc});Object.defineProperty(this,$c,{value:Wc});Object.defineProperty(this,Uc,{writable:true,value:null})}showSlider(){if(this.getSetting("isAvailable")){BX.Crm.Zoom.onNotConnectedHandler(I.Loc.getMessage("USER_ID"))}else{BX.Crm.Zoom.onNotAvailableHandler()}}supportsLayout(){return this.getSetting("isConnected")&&this.getSetting("isAvailable")}createLayout(){return I.Tag.render(Kc||(Kc=Xc`<div class="crm-entity-stream-content-new-detail ui-timeline-zoom-editor --focus --hidden"></div>`))}onFocus(e){this.setFocused(true)}onShow(){if(!babelHelpers.classPrivateFieldLooseBase(this,Uc)[Uc]){babelHelpers.classPrivateFieldLooseBase(this,$c)[$c]()}}}function Wc(){babelHelpers.classPrivateFieldLooseBase(this,Uc)[Uc]=new C.Zoom({ownerTypeId:this.getEntityTypeId(),ownerId:this.getEntityId(),container:this.getContainer(),onFinishEdit:babelHelpers.classPrivateFieldLooseBase(this,Gc)[Gc].bind(this),onStartSave:()=>this.setLocked(true),onFinishSave:()=>this.setLocked(false)})}function zc(){this.emitFinishEditEvent()}class qc{static createItem(e,t,s){let i=null;switch(e){case"todo":i=new Bc;break;case"comment":i=new Ye;break;case"sms":i=new In;break;case"whatsapp":i=new To;break;case"message":i=new Ql;break;case"gotochat":i=new ps;break;case"call":i=new Ue;break;case"email":i=new et;break;case"meeting":i=new li;break;case"task":i=new dc;break;case"sharing":i=new Dl;break;case"wait":i=new jc;break;case"zoom":i=new Vc;break;case"delivery":i=new Je;break;case"visit":i=new Tc;break;case"activity_rest_applist":i=new ii;break;case"einvoice_app_installer":i=new Qe;break;case"booking":i=new Se;break;default:i=null}if(!i&&e.startsWith("activity_rest_")){if(I.Type.isPlainObject(s)&&I.Type.isBoolean(s.useBuiltInInterface)&&s.useBuiltInInterface){i=new sl}else{i=new vl}}if(i){i.initialize(t,s)}return i}}var Yc=babelHelpers.classPrivateFieldLooseKey("entityTypeId");var Jc=babelHelpers.classPrivateFieldLooseKey("entityId");var Zc=babelHelpers.classPrivateFieldLooseKey("entityCategoryId");var Qc=babelHelpers.classPrivateFieldLooseKey("isReadonly");var ed=babelHelpers.classPrivateFieldLooseKey("container");var td=babelHelpers.classPrivateFieldLooseKey("items");var sd=babelHelpers.classPrivateFieldLooseKey("extras");var id=babelHelpers.classPrivateFieldLooseKey("selectedItemId");var ad=babelHelpers.classPrivateFieldLooseKey("menu");var ld=babelHelpers.classPrivateFieldLooseKey("onItemFinishEdit");var nd=babelHelpers.classPrivateFieldLooseKey("defaultInstance");var rd=babelHelpers.classPrivateFieldLooseKey("selectMenuItem");class od{constructor(e,t){var s,i;Object.defineProperty(this,rd,{value:dd});Object.defineProperty(this,ld,{value:cd});Object.defineProperty(this,Yc,{writable:true,value:null});Object.defineProperty(this,Jc,{writable:true,value:null});Object.defineProperty(this,Zc,{writable:true,value:null});Object.defineProperty(this,Qc,{writable:true,value:false});Object.defineProperty(this,ed,{writable:true,value:null});Object.defineProperty(this,td,{writable:true,value:{}});Object.defineProperty(this,sd,{writable:true,value:{}});Object.defineProperty(this,id,{writable:true,value:null});Object.defineProperty(this,ad,{writable:true,value:null});babelHelpers.classPrivateFieldLooseBase(this,Yc)[Yc]=t.entityTypeId;babelHelpers.classPrivateFieldLooseBase(this,Jc)[Jc]=t.entityId;babelHelpers.classPrivateFieldLooseBase(this,Zc)[Zc]=t.entityCategoryId;babelHelpers.classPrivateFieldLooseBase(this,Qc)[Qc]=t.isReadonly;babelHelpers.classPrivateFieldLooseBase(this,sd)[sd]=(s=t.extras)!=null?s:{};babelHelpers.classPrivateFieldLooseBase(this,ed)[ed]=document.getElementById(t.containerId);const a=(i=t.menuId)!=null?i:(BX.CrmEntityType.resolveName(babelHelpers.classPrivateFieldLooseBase(this,Yc)[Yc])+"_menu").toLowerCase();babelHelpers.classPrivateFieldLooseBase(this,ad)[ad]=BX.Main.interfaceButtonsManager.getById(a);const l=new w({entityTypeId:babelHelpers.classPrivateFieldLooseBase(this,Yc)[Yc],entityId:babelHelpers.classPrivateFieldLooseBase(this,Jc)[Jc],entityCategoryId:babelHelpers.classPrivateFieldLooseBase(this,Zc)[Zc],isReadonly:babelHelpers.classPrivateFieldLooseBase(this,Qc)[Qc],menuBarContainer:babelHelpers.classPrivateFieldLooseBase(this,ed)[ed],extras:babelHelpers.classPrivateFieldLooseBase(this,sd)[sd]});t.items.forEach((e=>{var t;const s=e.id;const i=qc.createItem(s,l,(t=e.settings)!=null?t:null);if(i){i.addFinishEditListener(babelHelpers.classPrivateFieldLooseBase(this,ld)[ld].bind(this));babelHelpers.classPrivateFieldLooseBase(this,td)[td][s]=i}}));this.setActiveItemById(this.getFirstItemIdWithLayout())}getItemById(e){var t;return(t=babelHelpers.classPrivateFieldLooseBase(this,td)[td][e])!=null?t:null}getContainer(){return babelHelpers.classPrivateFieldLooseBase(this,ed)[ed]}onMenuItemClick(e){if(babelHelpers.classPrivateFieldLooseBase(this,Qc)[Qc]){return}this.setActiveItemById(e)}setActiveItemById(e){if(!e||babelHelpers.classPrivateFieldLooseBase(this,id)[id]===e){return false}const t=babelHelpers.classPrivateFieldLooseBase(this,td)[td][e];if(!t){return false}t.activate();if(!babelHelpers.classPrivateFieldLooseBase(this,Qc)[Qc]&&t.supportsLayout()){Object.keys(babelHelpers.classPrivateFieldLooseBase(this,td)[td]).forEach((t=>{if(t!==e){babelHelpers.classPrivateFieldLooseBase(this,td)[td][t].deactivate()}}));babelHelpers.classPrivateFieldLooseBase(this,rd)[rd](e);babelHelpers.classPrivateFieldLooseBase(this,id)[id]=e;return true}return false}scrollIntoView(){this.getContainer().scrollIntoView({behavior:"smooth",block:"end",inline:"nearest"})}getFirstItemIdWithLayout(){if(babelHelpers.classPrivateFieldLooseBase(this,Qc)[Qc]){return null}let e=null;babelHelpers.classPrivateFieldLooseBase(this,ad)[ad].getAllItems().forEach(function(t){if(e===null){const s=t.dataset.id;const i=babelHelpers.classPrivateFieldLooseBase(this,td)[td][s];if(i&&i.supportsLayout()){e=s}}}.bind(this));return e}static create(e,t){const s=new od(e,t);od.instances[e]=s;return s}static getDefault(){return babelHelpers.classPrivateFieldLooseBase(od,nd)[nd]}static setDefault(e){babelHelpers.classPrivateFieldLooseBase(od,nd)[nd]=e}static getById(e){return od.instances[e]||null}}function cd(){this.setActiveItemById(this.getFirstItemIdWithLayout())}function dd(e){const t=babelHelpers.classPrivateFieldLooseBase(this,ad)[ad].getItemById(babelHelpers.classPrivateFieldLooseBase(this,id)[id]);const s=babelHelpers.classPrivateFieldLooseBase(this,ad)[ad].getItemById(e);let i=false;if(s&&t!==s){i=babelHelpers.classPrivateFieldLooseBase(this,ad)[ad].isActiveInMoreMenu();I.Dom.addClass(s,babelHelpers.classPrivateFieldLooseBase(this,ad)[ad].classes.itemActive);if(babelHelpers.classPrivateFieldLooseBase(this,ad)[ad].getItemData){const e=babelHelpers.classPrivateFieldLooseBase(this,ad)[ad].getItemData(s);e["IS_ACTIVE"]=true;if(BX.type.isDomNode(t)){I.Dom.removeClass(t,babelHelpers.classPrivateFieldLooseBase(this,ad)[ad].classes.itemActive);const e=babelHelpers.classPrivateFieldLooseBase(this,ad)[ad].getItemData(t);e["IS_ACTIVE"]=false}}const e=babelHelpers.classPrivateFieldLooseBase(this,ad)[ad].isActiveInMoreMenu();if(e||i){const a=babelHelpers.classPrivateFieldLooseBase(this,ad)[ad].getSubmenu();if(a){a.getMenuItems().forEach((a=>{const l=a.getContainer();if(e&&l.title===s.title){I.Dom.addClass(l,babelHelpers.classPrivateFieldLooseBase(this,ad)[ad].classes.itemActive)}else if(i&&l.title===t.title){I.Dom.removeClass(l,babelHelpers.classPrivateFieldLooseBase(this,ad)[ad].classes.itemActive)}}))}if(e){I.Dom.addClass(babelHelpers.classPrivateFieldLooseBase(this,ad)[ad].getMoreButton(),babelHelpers.classPrivateFieldLooseBase(this,ad)[ad].classes.itemActive)}else if(i){I.Dom.removeClass(babelHelpers.classPrivateFieldLooseBase(this,ad)[ad].getMoreButton(),babelHelpers.classPrivateFieldLooseBase(this,ad)[ad].classes.itemActive)}}}babelHelpers.classPrivateFieldLooseBase(this,ad)[ad].closeSubmenu()}Object.defineProperty(od,nd,{writable:true,value:null});od.instances={};e.MenuBar=od;e.Item=j})(this.BX.Crm.Timeline=this.BX.Crm.Timeline||{},BX,BX.Crm.Integration.UI,BX,BX,BX,BX.UI.IconSet,BX.Crm,BX.Vue3,BX.Calendar.Sharing,BX.Calendar.Sharing,BX.Crm.MessageSender,BX.UI,BX.UI.Tour,BX,BX.Crm.Integration.Analytics,BX.Crm.Template,BX.UI.Analytics,BX.UI.EntitySelector,BX.UI.Dialogs,BX,BX.Main,BX.Crm.Activity,BX.Crm,BX.Event,BX,BX,BX.Crm);
//# sourceMappingURL=toolbar.bundle.map.js