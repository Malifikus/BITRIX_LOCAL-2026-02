{"version":3,"file":"messagesender.bundle.js","sources":["../src/condition-checker/common/consent-approver.js","../src/condition-checker/common/utilites.js","../src/condition-checker/scenarios/base.js","../src/condition-checker/scenarios/ru-whatsapp.js","../src/condition-checker/scenarios/telegram.js","../src/condition-checker/scenarios/whatsapp.js","../src/condition-checker/factory.js","../src/condition-checker/checker.js","../src/internal/validation.js","../src/receiver.js","../src/internal/extract-receivers.js","../src/receiver-repository.js"],"sourcesContent":["import { ajax, Loc } from 'main.core';\n\nexport const Types: Readonly<string, string> = Object.freeze({\n\tbitrix24: 'bitrix24',\n\tsms: 'sms_provider',\n});\n\nexport type SenderType = Types.sms | Types.bitrix24;\n\nexport class ConsentApprover\n{\n\t#senderType: ?string = null;\n\n\tconstructor(senderType: ?string = null)\n\t{\n\t\tthis.#senderType = senderType;\n\t}\n\n\tasync checkAndApprove(): Promise<boolean>\n\t{\n\t\tif (this.#senderType !== Types.bitrix24)\n\t\t{\n\t\t\treturn Promise.resolve(true);\n\t\t}\n\n\t\treturn new Promise((resolve) => {\n\t\t\tajax.runAction('notifications.consent.Agreement.get')\n\t\t\t\t.then(({ data }) => {\n\t\t\t\t\tif (!data || !data.html)\n\t\t\t\t\t{\n\t\t\t\t\t\tresolve(true);\n\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.#showConsentAgreementBox(data, resolve);\n\t\t\t\t})\n\t\t\t\t.catch(() => {\n\t\t\t\t\tthis.#showErrorNotify();\n\n\t\t\t\t\tresolve(false);\n\t\t\t\t})\n\t\t\t;\n\t\t});\n\t}\n\n\t#showConsentAgreementBox({ title, html: message }, resolve: Function): void\n\t{\n\t\tBX.UI.Dialogs.MessageBox.show({\n\t\t\tmodal: true,\n\t\t\tmessage,\n\t\t\tbuttons: this.#getButtons(resolve),\n\t\t\tpopupOptions: {\n\t\t\t\tclassName: 'crm-agreement-terms-popup',\n\t\t\t},\n\t\t});\n\t}\n\n\t#getButtons(resolve: Function): BX.UI.Button[]\n\t{\n\t\treturn [\n\t\t\tnew BX.UI.Button({\n\t\t\t\tclassName: 'ui-btn-round',\n\t\t\t\tcolor: BX.UI.Button.Color.SUCCESS,\n\t\t\t\ttext: Loc.getMessage('CRM_MESSAGESENDER_B24_CONSENT_ACCEPT'),\n\t\t\t\tonclick: (button) => {\n\t\t\t\t\tthis\n\t\t\t\t\t\t.#approveConsent()\n\t\t\t\t\t\t.then((isApprovedConsent) => {\n\t\t\t\t\t\t\tif (isApprovedConsent)\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tthis.#showNotify(Loc.getMessage('CRM_MESSAGESENDER_B24_AGREEMENT_ACCEPT'));\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\tthis.#closeAgreementBox(button);\n\t\t\t\t\t\t\tresolve(true);\n\t\t\t\t\t\t})\n\t\t\t\t\t\t.catch(() => {\n\t\t\t\t\t\t\tthis.#showErrorNotify();\n\t\t\t\t\t\t\tresolve(false);\n\t\t\t\t\t\t})\n\t\t\t\t\t;\n\t\t\t\t},\n\t\t\t}),\n\t\t\tnew BX.UI.Button({\n\t\t\t\tclassName: 'ui-btn-round',\n\t\t\t\tcolor: BX.UI.Button.Color.LIGHT_BORDER,\n\t\t\t\ttext: Loc.getMessage('CRM_MESSAGESENDER_B24_CONSENT_REJECT'),\n\t\t\t\tonclick: (button) => {\n\t\t\t\t\tthis.#closeAgreementBox(button);\n\n\t\t\t\t\tresolve(false);\n\t\t\t\t},\n\t\t\t}),\n\t\t];\n\t}\n\n\t#approveConsent(): Promise<boolean>\n\t{\n\t\treturn new Promise((resolve) => {\n\t\t\tajax\n\t\t\t\t.runAction('notifications.consent.Agreement.approve')\n\t\t\t\t.then((response) => {\n\t\t\t\t\tif (response?.status === 'success' && response?.data)\n\t\t\t\t\t{\n\t\t\t\t\t\tresolve(true);\n\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tresolve(false);\n\t\t\t\t})\n\t\t\t\t.catch(() => {\n\t\t\t\t\tresolve(false);\n\t\t\t\t})\n\t\t\t;\n\t\t});\n\t}\n\n\t#closeAgreementBox({ context }): void\n\t{\n\t\tcontext.close();\n\t}\n\n\t#showErrorNotify(): void\n\t{\n\t\tthis.#showNotify(Loc.getMessage('CRM_MESSAGESENDER_B24_CONSENT_AGREEMENT_VALIDATION_ERROR'));\n\t}\n\n\t#showNotify(content: string): void\n\t{\n\t\tBX.UI.Notification.Center.notify({ content });\n\t}\n}\n","export const showNotify = (content: string): void => {\n\tBX.UI.Notification.Center.notify({ content });\n}","import { Router } from 'crm.router';\nimport { ajax, Loc, Type } from 'main.core';\nimport type { SenderType } from '../common/consent-approver';\nimport { showNotify } from '../common/utilites';\nimport type { Scenario } from '../scenario';\n\ntype OpenLineItems = {\n\t[key: string]: OpenLineItem;\n}\n\ntype OpenLineItem = {\n\tname: string;\n\tselected: boolean;\n\turl: string;\n}\n\nexport type Settings = {\n\tmarketUrl: string;\n\tcanUseNotifications: boolean;\n}\n\nexport class Base implements Scenario\n{\n\topenLineItems: OpenLineItems = null;\n\tsenderType: SenderType = null;\n\tentityTypeId: number = null;\n\n\tconstructor(params: Object)\n\t{\n\t\tif (Type.isPlainObject(params?.openLineItems))\n\t\t{\n\t\t\tthis.openLineItems = params.openLineItems ?? null;\n\t\t\tthis.senderType = params.senderType ?? null;\n\t\t}\n\n\t\tif (Type.isNumber(params?.entityTypeId))\n\t\t{\n\t\t\tthis.entityTypeId = params.entityTypeId;\n\t\t}\n\t}\n\n\tgetOpenLineCode(): string\n\t{\n\t\tthrow new Error('Must be implement in child class');\n\t}\n\n\tasync checkAndGetLineId(): Promise<number | null>\n\t{\n\t\tawait this.#showConnectAlertMessage();\n\n\t\treturn Promise.resolve(null);\n\t}\n\n\tasync isOpenLineItemSelected(force: boolean = false): Promise<boolean>\n\t{\n\t\tconst item = await this.getOpenLineItem(force);\n\n\t\tif (!item)\n\t\t{\n\t\t\tthrow new ReferenceError(`OpenLine item with code: ${this.getOpenLineCode()} not found`);\n\t\t}\n\n\t\treturn item.selected;\n\t}\n\n\tasync getOpenLineItem(force: boolean = false, openLineCode: string = null): ?OpenLineItem\n\t{\n\t\tif (this.openLineItems === null || force)\n\t\t{\n\t\t\tthis.openLineItems = await this.fetchOpenLineItems();\n\t\t}\n\n\t\treturn this.openLineItems[openLineCode ?? this.getOpenLineCode()];\n\t}\n\n\tasync fetchOpenLineItems(): Promise<OpenLineItems>\n\t{\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tajax.runAction('crm.controller.integration.openlines.getItems')\n\t\t\t\t.then(({ status, data, errors }) => {\n\t\t\t\t\tif (status === 'success')\n\t\t\t\t\t{\n\t\t\t\t\t\tresolve(data);\n\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\treject(errors);\n\t\t\t\t})\n\t\t\t\t.catch((data) => {\n\t\t\t\t\treject(data);\n\t\t\t\t})\n\t\t\t;\n\t\t});\n\t}\n\n\tasync getLineId(): Promise<number | null>\n\t{\n\t\treturn new Promise((resolve) => {\n\t\t\tconst connectorId = this.getOpenLineCode();\n\t\t\tconst ajaxParameters = {\n\t\t\t\tconnectorId: this.getOpenLineCode(),\n\t\t\t\twithConnector: true,\n\t\t\t};\n\n\t\t\tajax.runAction('imconnector.Openlines.list', { data: ajaxParameters })\n\t\t\t\t.then(({ data }) => {\n\t\t\t\t\tif (Type.isArrayFilled(data))\n\t\t\t\t\t{\n\t\t\t\t\t\tlet lineId = data[data.length - 1].lineId;\n\n\t\t\t\t\t\tconst openLineItemsList = this.openLineItems[connectorId]?.list ?? null;\n\t\t\t\t\t\tif (openLineItemsList)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tconst selectedItem = openLineItemsList.find((item) => item.selected) ?? null;\n\t\t\t\t\t\t\tif (selectedItem)\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tlineId = selectedItem.id;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tresolve(lineId);\n\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tresolve(null);\n\t\t\t\t})\n\t\t\t\t.catch(() => {\n\t\t\t\t\tshowNotify(Loc.getMessage('CRM_MESSAGESENDER_B24_OPENLINE_LINEID_ERROR'));\n\t\t\t\t})\n\t\t\t;\n\t\t});\n\t}\n\n\tasync canEditConnector(): Promise<boolean>\n\t{\n\t\treturn new Promise((resolve) => {\n\t\t\tajax.runAction('imconnector.Openlines.hasAccess')\n\t\t\t\t.then(({ data }) => {\n\t\t\t\t\tif (data.canEditConnector)\n\t\t\t\t\t{\n\t\t\t\t\t\tresolve(true);\n\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tresolve(false);\n\t\t\t\t})\n\t\t\t\t.catch(() => this.#showConnectAlertMessage())\n\t\t\t;\n\t\t});\n\t}\n\n\tasync #showConnectAlertMessage(): Promise<void>\n\t{\n\t\tconst item = await this.getOpenLineItem();\n\n\t\tconst message = Loc.getMessage(\n\t\t\t'CRM_MESSAGESENDER_B24_CONNECT_ACCESS_DENIED',\n\t\t\t{\n\t\t\t\t'#SERVICE_NAME#': item.name,\n\t\t\t},\n\t\t);\n\n\t\tshowNotify(message);\n\t}\n\n\tasync openConnectSidePanel(url: string, onCloseCallback: Function): Promise\n\t{\n\t\treturn new Promise((resolve) => {\n\t\t\tif (Type.isStringFilled(url))\n\t\t\t{\n\t\t\t\tvoid Router.openSlider(\n\t\t\t\t\turl,\n\t\t\t\t\t{\n\t\t\t\t\t\twidth: 700,\n\t\t\t\t\t\tcacheable: false,\n\t\t\t\t\t},\n\t\t\t\t).then(() => {\n\t\t\t\t\tonCloseCallback(resolve);\n\t\t\t\t});\n\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tshowNotify(Loc.getMessage('CRM_MESSAGESENDER_B24_OPENLINE_LINEID_ERROR'));\n\t\t\tresolve(null);\n\t\t});\n\t}\n}\n","import { ajax, Loc, Reflection, Type } from 'main.core';\nimport { showNotify } from '../common/utilites';\nimport { Base } from './base';\n\nexport class RuWhatsApp extends Base\n{\n\tasync checkAndGetLineId(): Promise<number | null>\n\t{\n\t\tconst isWhatsAppAvailable = await this.#checkVirtualWhatsAppAvailable();\n\t\tif (!isWhatsAppAvailable)\n\t\t{\n\t\t\treturn null;\n\t\t}\n\n\t\tconst isSelected = await this.isOpenLineItemSelected();\n\n\t\tif (isSelected)\n\t\t{\n\t\t\tif (await this.#isVirtualWhatsAppConnected())\n\t\t\t{\n\t\t\t\treturn this.getLineId();\n\t\t\t}\n\n\t\t\tconst canEditConnector = await this.canEditConnector();\n\t\t\tif (canEditConnector)\n\t\t\t{\n\t\t\t\tconst url = this.openLineItems?.virtual_whatsapp?.url;\n\n\t\t\t\treturn this.openConnectSidePanel(url, this.onConnectVirtualWhatsApp.bind(this));\n\t\t\t}\n\n\t\t\treturn super.checkAndGetLineId();\n\t\t}\n\n\t\tconst canEditConnector = await this.canEditConnector();\n\t\tif (canEditConnector)\n\t\t{\n\t\t\tconst item = await this.getOpenLineItem();\n\n\t\t\treturn this.openConnectSidePanel(item.url, this.onConnect.bind(this));\n\t\t}\n\n\t\treturn super.checkAndGetLineId();\n\t}\n\n\tasync #checkVirtualWhatsAppAvailable(): Promise<boolean>\n\t{\n\t\tconst config = await this.#fetchVirtualWhatsAppConfig();\n\n\t\tif (Type.isStringFilled(config.infoHelperCode))\n\t\t{\n\t\t\tif (Reflection.getClass('BX.UI.InfoHelper.show'))\n\t\t\t{\n\t\t\t\tBX.UI.InfoHelper.show(config.infoHelperCode);\n\t\t\t}\n\n\t\t\treturn false;\n\t\t}\n\n\t\treturn true;\n\t}\n\n\t#fetchVirtualWhatsAppConfig(): Promise<Object>\n\t{\n\t\tconst { entityTypeId } = this;\n\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tajax\n\t\t\t\t.runAction(\n\t\t\t\t\t'crm.controller.messagesender.conditionchecker.getVirtualWhatsAppConfig',\n\t\t\t\t\t{\n\t\t\t\t\t\tdata: {\n\t\t\t\t\t\t\tentityTypeId,\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t)\n\t\t\t\t.then(({ status, data, errors }) => {\n\t\t\t\t\tif (status === 'success')\n\t\t\t\t\t{\n\t\t\t\t\t\tresolve(data);\n\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\treject(errors);\n\t\t\t\t})\n\t\t\t\t.catch((data) => reject(data))\n\t\t\t;\n\t\t});\n\t}\n\n\tasync onConnectVirtualWhatsApp(resolve: Function): Promise<number | null>\n\t{\n\t\tif (await this.#isVirtualWhatsAppConnected())\n\t\t{\n\t\t\treturn resolve(this.getLineId());\n\t\t}\n\n\t\tshowNotify(Loc.getMessage('CRM_MESSAGESENDER_B24_OPENLINE_LINEID_ERROR'));\n\n\t\treturn resolve(null);\n\t}\n\n\tasync #isVirtualWhatsAppConnected(): Promise<boolean>\n\t{\n\t\tconst virtualWhatsAppItem = await this.getOpenLineItem(true, 'virtual_whatsapp');\n\n\t\treturn virtualWhatsAppItem?.selected;\n\t}\n\n\tasync onConnect(resolve: Function): Promise<number | null>\n\t{\n\t\tconst isSelected = await this.isOpenLineItemSelected(true);\n\n\t\tif (isSelected)\n\t\t{\n\t\t\treturn resolve(this.checkAndGetLineId());\n\t\t}\n\n\t\tshowNotify(Loc.getMessage('CRM_MESSAGESENDER_B24_OPENLINE_LINEID_ERROR'));\n\n\t\treturn resolve(null);\n\t}\n\n\tgetOpenLineCode(): string\n\t{\n\t\treturn 'notifications';\n\t}\n}\n","import { Loc } from 'main.core';\nimport { ConsentApprover } from '../common/consent-approver';\nimport { showNotify } from '../common/utilites';\nimport { Base } from './base';\n\nexport class Telegram extends Base\n{\n\tasync checkAndGetLineId(): Promise<number | null>\n\t{\n\t\tconst isSelected = await this.isOpenLineItemSelected();\n\n\t\tif (isSelected)\n\t\t{\n\t\t\tconst isApproved = await this.#checkConsentApproved();\n\t\t\tif (isApproved)\n\t\t\t{\n\t\t\t\tconst lineId: number = await this.getLineId();\n\t\t\t\tif (!lineId)\n\t\t\t\t{\n\t\t\t\t\tconst item = await this.getOpenLineItem();\n\n\t\t\t\t\treturn this.openConnectSidePanel(item.url, this.onConnect.bind(this));\n\t\t\t\t}\n\n\t\t\t\treturn Promise.resolve(lineId);\n\t\t\t}\n\n\t\t\tshowNotify(Loc.getMessage('CRM_MESSAGESENDER_B24_AGREEMENT_NOTIFY'));\n\n\t\t\treturn Promise.resolve(null);\n\t\t}\n\n\t\tconst canEditConnector = await this.canEditConnector();\n\t\tif (canEditConnector)\n\t\t{\n\t\t\tconst item = await this.getOpenLineItem();\n\n\t\t\treturn this.openConnectSidePanel(item.url, this.onConnect.bind(this));\n\t\t}\n\n\t\treturn super.checkAndGetLineId();\n\t}\n\n\tasync onConnect(resolve: Function): Promise<number | null>\n\t{\n\t\tconst lineId = await this.getLineId();\n\n\t\tif (lineId === null)\n\t\t{\n\t\t\tshowNotify(Loc.getMessage('CRM_MESSAGESENDER_B24_OPENLINE_LINEID_ERROR'));\n\n\t\t\treturn resolve(null);\n\t\t}\n\n\t\tconst item = await this.getOpenLineItem(true);\n\t\tshowNotify(Loc.getMessage('CRM_MESSAGESENDER_B24_CONNECT_SUCCESS', {\n\t\t\t'#LINE_NAME#': item.name,\n\t\t}));\n\n\t\tconst isApproved = await this.#checkConsentApproved();\n\t\tif (isApproved)\n\t\t{\n\t\t\treturn resolve(lineId);\n\t\t}\n\n\t\tshowNotify(Loc.getMessage('CRM_MESSAGESENDER_B24_AGREEMENT_NOTIFY'));\n\n\t\treturn resolve(null);\n\t}\n\n\tasync #checkConsentApproved(): Promise<boolean>\n\t{\n\t\treturn (new ConsentApprover(this.senderType)).checkAndApprove();\n\t}\n\n\tgetOpenLineCode(): string\n\t{\n\t\treturn 'telegrambot';\n\t}\n}\n","import { ajax, Extension, Loc, Reflection, Type } from 'main.core';\nimport { MessageBox, MessageBoxButtons } from 'ui.dialogs.messagebox';\nimport { showNotify } from '../common/utilites';\nimport type { Settings } from './base';\nimport { Base } from './base';\n\nexport class WhatsApp extends Base\n{\n\tasync checkAndGetLineId(): Promise<number | null>\n\t{\n\t\tconst isWhatsAppAvailable = await this.#checkVirtualWhatsAppAvailable();\n\t\tif (!isWhatsAppAvailable)\n\t\t{\n\t\t\treturn null;\n\t\t}\n\n\t\tif (await this.#isVirtualWhatsAppConnected())\n\t\t{\n\t\t\tconst hasAvailableProvider = await this.#hasAvailableSmsProvider();\n\n\t\t\tif (hasAvailableProvider)\n\t\t\t{\n\t\t\t\t// notification connector does not take into account the open line number when generating the link\n\t\t\t\treturn Promise.resolve(0);\n\t\t\t}\n\n\t\t\tconst canEditConnector = await this.canEditConnector();\n\t\t\tif (canEditConnector)\n\t\t\t{\n\t\t\t\treturn this.#showMarketplaceDialog();\n\t\t\t}\n\n\t\t\treturn super.checkAndGetLineId();\n\t\t}\n\n\t\tconst canEditConnector = await this.canEditConnector();\n\t\tif (canEditConnector)\n\t\t{\n\t\t\tconst url = this.openLineItems?.virtual_whatsapp?.url;\n\n\t\t\treturn this.openConnectSidePanel(url, this.onConnectVirtualWhatsApp.bind(this));\n\t\t}\n\n\t\treturn super.checkAndGetLineId();\n\t}\n\n\tasync #checkVirtualWhatsAppAvailable(): Promise<boolean>\n\t{\n\t\tconst config = await this.#fetchVirtualWhatsAppConfig();\n\n\t\tif (Type.isStringFilled(config.infoHelperCode))\n\t\t{\n\t\t\tif (Reflection.getClass('BX.UI.InfoHelper.show'))\n\t\t\t{\n\t\t\t\tBX.UI.InfoHelper.show(config.infoHelperCode);\n\t\t\t}\n\n\t\t\treturn false;\n\t\t}\n\n\t\treturn true;\n\t}\n\n\t#fetchVirtualWhatsAppConfig(): Promise<Object>\n\t{\n\t\tconst { entityTypeId } = this;\n\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tajax\n\t\t\t\t.runAction(\n\t\t\t\t\t'crm.controller.messagesender.conditionchecker.getVirtualWhatsAppConfig',\n\t\t\t\t\t{\n\t\t\t\t\t\tdata: {\n\t\t\t\t\t\t\tentityTypeId,\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t)\n\t\t\t\t.then(({ status, data, errors }) => {\n\t\t\t\t\tif (status === 'success')\n\t\t\t\t\t{\n\t\t\t\t\t\tresolve(data);\n\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\treject(errors);\n\t\t\t\t})\n\t\t\t\t.catch((data) => reject(data))\n\t\t\t;\n\t\t});\n\t}\n\n\tasync onConnectVirtualWhatsApp(resolve: Function): Promise<number | null>\n\t{\n\t\tif (await this.#isVirtualWhatsAppConnected())\n\t\t{\n\t\t\treturn resolve(this.checkAndGetLineId());\n\t\t}\n\n\t\tshowNotify(Loc.getMessage('CRM_MESSAGESENDER_B24_OPENLINE_LINEID_ERROR'));\n\n\t\treturn resolve(null);\n\t}\n\n\tasync #isVirtualWhatsAppConnected(): Promise<boolean>\n\t{\n\t\tconst virtualWhatsAppItem = await this.getOpenLineItem(true, 'virtual_whatsapp');\n\n\t\treturn virtualWhatsAppItem?.selected;\n\t}\n\n\tgetOpenLineCode(): string\n\t{\n\t\treturn 'notifications';\n\t}\n\n\tasync #hasAvailableSmsProvider(): Promise<boolean>\n\t{\n\t\tconst smsSenders = await this.#getSmsSenders();\n\n\t\treturn Promise.resolve(smsSenders.some((provider) => provider.canUse && !provider.isTemplatesBased));\n\t}\n\n\tasync #getSmsSenders(): Promise<Object[]>\n\t{\n\t\tconst { entityTypeId } = this;\n\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tajax\n\t\t\t\t.runAction(\n\t\t\t\t\t'crm.controller.messagesender.conditionchecker.getSmsSenders',\n\t\t\t\t\t{\n\t\t\t\t\t\tdata: {\n\t\t\t\t\t\t\tentityTypeId,\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t)\n\t\t\t\t.then(({ status, data, errors }) => {\n\t\t\t\t\tif (status === 'success')\n\t\t\t\t\t{\n\t\t\t\t\t\tresolve(data);\n\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\treject(errors);\n\t\t\t\t})\n\t\t\t\t.catch((data) => reject(data))\n\t\t\t;\n\t\t});\n\t}\n\n\t#showMarketplaceDialog(): Promise<number | null>\n\t{\n\t\treturn new Promise((resolve) => {\n\t\t\tMessageBox.show({\n\t\t\t\tmessage: Loc.getMessage('CRM_MESSAGESENDER_B24_CONDITION_CHECKER_MARKET_MESSAGE'),\n\t\t\t\tmodal: true,\n\t\t\t\tbuttons: MessageBoxButtons.OK_CANCEL,\n\t\t\t\tokCaption: Loc.getMessage('CRM_MESSAGESENDER_B24_CONDITION_CHECKER_OK_BTN_TEXT'),\n\t\t\t\tonOk: (messageBox) => {\n\t\t\t\t\tvoid this.#openMarketplace(resolve);\n\t\t\t\t\tmessageBox.close();\n\t\t\t\t},\n\t\t\t});\n\t\t});\n\t}\n\n\t#openMarketplace(resolve): Promise\n\t{\n\t\tconst marketUrl = this.#getSettings().marketUrl;\n\n\t\tBX.SidePanel.Instance.open(\n\t\t\tmarketUrl,\n\t\t\t{\n\t\t\t\tcacheable: false,\n\t\t\t\tevents: {\n\t\t\t\t\tonClose: () => {\n\t\t\t\t\t\tvoid this.#onCloseMarketplace(resolve);\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t},\n\t\t);\n\t}\n\n\tasync #onCloseMarketplace(resolve): Promise<void>\n\t{\n\t\tconst hasAvailableSmsProvider = await this.#hasAvailableSmsProvider();\n\n\t\tif (hasAvailableSmsProvider)\n\t\t{\n\t\t\tresolve(0);\n\n\t\t\treturn;\n\t\t}\n\n\t\tshowNotify(Loc.getMessage('CRM_MESSAGESENDER_B24_OPENLINE_LINEID_ERROR'));\n\n\t\tresolve(null);\n\t}\n\n\t#getSettings(): Settings\n\t{\n\t\treturn Extension.getSettings('crm.messagesender');\n\t}\n}\n","import type { Scenario } from './scenario';\nimport { RuWhatsApp } from './scenarios/ru-whatsapp';\nimport { Telegram } from './scenarios/telegram';\nimport { WhatsApp } from './scenarios/whatsapp';\n\nexport class Factory\n{\n\tstatic getScenarioInstance(name: string, params: Object): Scenario\n\t{\n\t\tif (name === 'telegrambot')\n\t\t{\n\t\t\treturn new Telegram(params);\n\t\t}\n\n\t\tif (name === 'ru-whatsapp') // for RU region\n\t\t{\n\t\t\treturn new RuWhatsApp(params);\n\t\t}\n\n\t\tif (name === 'whatsapp') // for not RU region\n\t\t{\n\t\t\treturn new WhatsApp(params);\n\t\t}\n\n\t\tthrow new RangeError(`Unknown scenario name: ${name}`);\n\t}\n}\n","import { Type } from 'main.core';\nimport type { SenderType } from './common/consent-approver';\nimport { ConsentApprover } from './common/consent-approver';\nimport { Factory } from './factory';\n\ntype OpenLineItems = {\n\t[key: string]: OpenLineItem;\n}\n\ntype OpenLineItem = {\n\tname: string;\n\tselected: boolean;\n\turl: string;\n}\n\nexport class ConditionChecker\n{\n\t#openLineItems: ?OpenLineItems = null;\n\t#senderType: SenderType;\n\t#serviceId: string;\n\t#entityTypeId: number;\n\n\t/**\n\t * @param {SenderType} senderType\n\t * @param {OpenLineItems | null} openLineItems\n\t * @param {string | null} serviceId\n\t * @param {number | null} entityTypeId\n\t * @returns {Promise<number|null>}\n\t */\n\tstatic async checkAndGetLine({\n\t\tsenderType,\n\t\topenLineItems = null,\n\t\tserviceId = null,\n\t\tentityTypeId = null,\n\t}): Promise<number | null>\n\t{\n\t\tconst instance = new ConditionChecker({\n\t\t\tsenderType,\n\t\t});\n\n\t\tif (Type.isObjectLike(openLineItems))\n\t\t{\n\t\t\tinstance.setOpenLineItems(openLineItems);\n\t\t}\n\n\t\tif (Type.isStringFilled(serviceId))\n\t\t{\n\t\t\tinstance.setServiceId(serviceId);\n\t\t}\n\t\telse\n\t\t{\n\t\t\tthrow new TypeError('ServiceId is required');\n\t\t}\n\n\t\tif (BX.CrmEntityType.isDefined(entityTypeId))\n\t\t{\n\t\t\tinstance.setEntityTypeId(entityTypeId);\n\t\t}\n\t\telse\n\t\t{\n\t\t\tthrow new TypeError('EntityTypeId is not specified or incorrect');\n\t\t}\n\n\t\treturn instance.check();\n\t}\n\n\tstatic async checkIsApproved({ senderType }): Promise<boolean>\n\t{\n\t\tconst instance = new ConditionChecker({\n\t\t\tsenderType,\n\t\t});\n\n\t\treturn instance.checkApproveConsent();\n\t}\n\n\t/**\n\t * @param {string} openLineCode\n\t * @param {string} senderType\n\t */\n\tconstructor({ senderType })\n\t{\n\t\tthis.#senderType = senderType;\n\t}\n\n\tsetOpenLineItems(items: OpenLineItems): ConditionChecker\n\t{\n\t\tthis.#openLineItems = items;\n\n\t\treturn this;\n\t}\n\n\tsetServiceId(serviceId: ?string): ConditionChecker\n\t{\n\t\tthis.#serviceId = serviceId;\n\n\t\treturn this;\n\t}\n\n\tsetEntityTypeId(entityTypeId: ?number): ConditionChecker\n\t{\n\t\tthis.#entityTypeId = entityTypeId;\n\n\t\treturn this;\n\t}\n\n\tasync check(): Promise<number | null>\n\t{\n\t\tconst scenario = Factory.getScenarioInstance(this.#serviceId, {\n\t\t\tsenderType: this.#senderType,\n\t\t\topenLineItems: this.#openLineItems,\n\t\t\tentityTypeId: this.#entityTypeId,\n\t\t});\n\n\t\treturn scenario.checkAndGetLineId();\n\t}\n\n\tasync checkApproveConsent(): Promise<boolean | null>\n\t{\n\t\tconst isApproved = await (new ConsentApprover(this.#senderType)).checkAndApprove();\n\t\tif (isApproved)\n\t\t{\n\t\t\treturn Promise.resolve(true);\n\t\t}\n\n\t\treturn Promise.resolve(null);\n\t}\n}\n","import { ItemIdentifier } from 'crm.data-structures';\nimport { Type } from 'main.core';\nimport { Receiver } from '../receiver';\n\nexport function ensureIsItemIdentifier(candidate: any): void\n{\n\tif (candidate instanceof ItemIdentifier)\n\t{\n\t\treturn;\n\t}\n\n\tthrow new Error('Argument should be an instance of ItemIdentifier');\n}\n\nexport function ensureIsReceiver(candidate: any): void\n{\n\tif (candidate instanceof Receiver)\n\t{\n\t\treturn;\n\t}\n\n\tthrow new Error('Argument should be an instance of Receiver');\n}\n\nexport function ensureIsValidMultifieldValue(candidate: any): void\n{\n\t// noinspection OverlyComplexBooleanExpressionJS\n\tconst isValidValue = (\n\t\tType.isPlainObject(candidate)\n\t\t&& (Type.isNil(candidate.id) || Type.isInteger(candidate.id))\n\t\t&& Type.isStringFilled(candidate.typeId)\n\t\t&& (Type.isNil(candidate.typeCaption) || Type.isStringFilled(candidate.typeCaption))\n\t\t&& Type.isStringFilled(candidate.valueType)\n\t\t&& (Type.isNil(candidate.valueTypeCaption) || Type.isStringFilled(candidate.valueTypeCaption))\n\t\t&& Type.isStringFilled(candidate.value)\n\t\t&& (Type.isNil(candidate.valueFormatted) || Type.isStringFilled(candidate.valueFormatted))\n\t);\n\n\tif (isValidValue)\n\t{\n\t\treturn;\n\t}\n\n\tthrow new Error('Argument should be an object of valid MultifieldValue structure');\n}\n\nexport function ensureIsValidSourceData(candidate: any): void\n{\n\tconst isValid = (\n\t\tType.isPlainObject(candidate)\n\t\t&& Type.isStringFilled(candidate.title)\n\t);\n\n\tif (isValid)\n\t{\n\t\treturn;\n\t}\n\n\tthrow new Error('Argument should be an object of valid SourceData structure')\n}\n","import { ItemIdentifier } from 'crm.data-structures';\n\nimport type { JsonObject } from 'main.core';\nimport { ensureIsItemIdentifier, ensureIsValidMultifieldValue, ensureIsValidSourceData } from './internal/validation';\n\nexport type MultifieldValue = {\n\tid: ?number,\n\ttypeId: string,\n\tvalueType: string,\n\tvalueTypeCaption: string,\n\tvalue: string,\n\tvalueFormatted: string,\n\tcomplexId: ?string,\n};\n\nexport type SourceData = {\n\ttitle: string,\n};\n\nexport class Receiver\n{\n\t#rootSource: ItemIdentifier;\n\t#addressSource: ItemIdentifier;\n\t#addressSourceData: ?SourceData = null;\n\t#address: MultifieldValue;\n\n\tconstructor(\n\t\trootSource: ItemIdentifier,\n\t\taddressSource: ItemIdentifier,\n\t\taddress: MultifieldValue,\n\t\taddressSourceData: ?SourceData = null,\n\t)\n\t{\n\t\tensureIsItemIdentifier(rootSource);\n\t\tthis.#rootSource = rootSource;\n\n\t\tensureIsItemIdentifier(addressSource);\n\t\tthis.#addressSource = addressSource;\n\n\t\tensureIsValidMultifieldValue(address);\n\t\tthis.#address = Object.freeze({\n\t\t\tid: address.id,\n\t\t\ttypeId: address.typeId,\n\t\t\tvalueType: address.valueType,\n\t\t\tvalueTypeCaption: address.valueTypeCaption,\n\t\t\tcomplexId: address.complexId,\n\t\t\tvalue: address.value,\n\t\t\tvalueFormatted: address.valueFormatted,\n\t\t});\n\n\t\tif (addressSourceData)\n\t\t{\n\t\t\tensureIsValidSourceData(addressSourceData);\n\t\t\tthis.#addressSourceData = Object.freeze({\n\t\t\t\ttitle: addressSourceData.title,\n\t\t\t});\n\t\t}\n\t}\n\n\tstatic fromJSON(data: Object): ?Receiver\n\t{\n\t\tconst rootSource = ItemIdentifier.fromJSON(data?.rootSource);\n\t\tif (!rootSource)\n\t\t{\n\t\t\treturn null;\n\t\t}\n\n\t\tconst addressSource = ItemIdentifier.fromJSON(data?.addressSource);\n\t\tif (!addressSource)\n\t\t{\n\t\t\treturn null;\n\t\t}\n\n\t\ttry\n\t\t{\n\t\t\treturn new Receiver(rootSource, addressSource, data?.address, data?.addressSourceData);\n\t\t}\n\t\tcatch (e)\n\t\t{\n\t\t\treturn null;\n\t\t}\n\t}\n\n\tget rootSource(): ItemIdentifier\n\t{\n\t\treturn this.#rootSource;\n\t}\n\n\tget addressSource(): ItemIdentifier\n\t{\n\t\treturn this.#addressSource;\n\t}\n\n\tget addressSourceData(): ?SourceData\n\t{\n\t\treturn this.#addressSourceData;\n\t}\n\n\tget address(): MultifieldValue\n\t{\n\t\treturn this.#address;\n\t}\n\n\tisEqualTo(another: Receiver): boolean\n\t{\n\t\tif (!(another instanceof Receiver))\n\t\t{\n\t\t\treturn false;\n\t\t}\n\n\t\t// noinspection OverlyComplexBooleanExpressionJS\n\t\treturn (\n\t\t\tthis.rootSource.isEqualTo(another.rootSource)\n\t\t\t&& this.addressSource.isEqualTo(another.addressSource)\n\t\t\t&& String(this.address.typeId) === String(another.address.typeId)\n\t\t\t&& String(this.address.valueType) === String(another.address.valueType)\n\t\t\t&& String(this.address.value) === String(another.address.value)\n\t\t);\n\t}\n\n\ttoJSON(): JsonObject\n\t{\n\t\treturn {\n\t\t\trootSource: this.rootSource,\n\t\t\taddressSource: this.addressSource,\n\t\t\taddressSourceData: this.addressSourceData,\n\t\t\taddress: this.address,\n\t\t};\n\t}\n}\n","import { ItemIdentifier } from 'crm.data-structures';\nimport { Text, Type } from 'main.core';\nimport { Receiver } from '../receiver';\n\nexport function extractReceivers(item: ItemIdentifier, entityData: ?Object): Receiver[]\n{\n\tconst receivers = [];\n\tif (entityData?.hasOwnProperty('MULTIFIELD_DATA'))\n\t{\n\t\treceivers.push(...extractReceiversFromMultifieldData(item, entityData));\n\t}\n\tif (entityData?.hasOwnProperty('CLIENT_INFO'))\n\t{\n\t\treceivers.push(...extractReceiversFromClientInfo(item, entityData.CLIENT_INFO));\n\t}\n\n\treturn unique(receivers);\n}\n\nfunction extractReceiversFromMultifieldData(item: ItemIdentifier, entityData: Object): Receiver[]\n{\n\tconst receivers: Receiver[] = [];\n\n\tconst multifields = entityData.MULTIFIELD_DATA;\n\tfor (const multifieldTypeId in multifields)\n\t{\n\t\tif (!multifields.hasOwnProperty(multifieldTypeId) || !Type.isPlainObject(multifields[multifieldTypeId]))\n\t\t{\n\t\t\tcontinue;\n\t\t}\n\n\t\tfor (const itemSlug in multifields[multifieldTypeId])\n\t\t{\n\t\t\tif (\n\t\t\t\t!multifields[multifieldTypeId].hasOwnProperty(itemSlug)\n\t\t\t\t|| !Type.isArrayFilled(multifields[multifieldTypeId][itemSlug])\n\t\t\t)\n\t\t\t{\n\t\t\t\tcontinue;\n\t\t\t}\n\n\t\t\tconst [entityTypeId, entityId] = itemSlug.split('_');\n\t\t\tlet addressSource: ItemIdentifier;\n\t\t\ttry\n\t\t\t{\n\t\t\t\taddressSource = new ItemIdentifier(Text.toInteger(entityTypeId), Text.toInteger(entityId));\n\t\t\t}\n\t\t\tcatch (e)\n\t\t\t{\n\t\t\t\tcontinue;\n\t\t\t}\n\n\t\t\tconst addressSourceTitle = getAddressSourceTitle(item, addressSource, entityData);\n\n\t\t\tfor (const singleMultifield of multifields[multifieldTypeId][itemSlug])\n\t\t\t{\n\t\t\t\ttry\n\t\t\t\t{\n\t\t\t\t\treceivers.push(new Receiver(\n\t\t\t\t\t\titem,\n\t\t\t\t\t\taddressSource,\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tid: Text.toInteger(singleMultifield.ID),\n\t\t\t\t\t\t\ttypeId: String(multifieldTypeId),\n\t\t\t\t\t\t\tvalueType: stringOrUndefined(singleMultifield.VALUE_TYPE),\n\t\t\t\t\t\t\tvalue: stringOrUndefined(singleMultifield.VALUE),\n\t\t\t\t\t\t\tvalueFormatted: stringOrUndefined(singleMultifield.VALUE_FORMATTED),\n\t\t\t\t\t\t\tcomplexId: stringOrUndefined(singleMultifield.COMPLEX_ID),\n\t\t\t\t\t\t\tvalueTypeCaption: stringOrUndefined(singleMultifield.COMPLEX_NAME),\n\t\t\t\t\t\t},\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\ttitle: addressSourceTitle,\n\t\t\t\t\t\t},\n\t\t\t\t\t));\n\t\t\t\t}\n\t\t\t\tcatch (e)\n\t\t\t\t{\n\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\treturn receivers;\n}\n\nfunction getAddressSourceTitle(rootSource: ItemIdentifier, addressSource: ItemIdentifier, entityData: ?Object): string\n{\n\tif (rootSource.isEqualTo(addressSource))\n\t{\n\t\treturn entityData?.TITLE ?? entityData.FORMATTED_NAME ?? '';\n\t}\n\n\tconst clientDataKey = `${BX.CrmEntityType.resolveName(addressSource.entityTypeId)}_DATA`;\n\tif (Type.isArrayFilled(entityData?.CLIENT_INFO?.[clientDataKey]))\n\t{\n\t\tconst client = entityData.CLIENT_INFO[clientDataKey].find(clientInfo => {\n\t\t\treturn Text.toInteger(clientInfo.id) === addressSource.entityId;\n\t\t});\n\n\t\tif (Type.isString(client?.title))\n\t\t{\n\t\t\treturn client.title;\n\t\t}\n\t}\n\n\treturn '';\n}\n\nfunction extractReceiversFromClientInfo(item: ItemIdentifier, clientInfo: Object): Receiver[]\n{\n\tconst receivers = [];\n\n\tfor (const clientsOfSameType of Object.values(clientInfo))\n\t{\n\t\tif (!Type.isArrayFilled(clientsOfSameType))\n\t\t{\n\t\t\tcontinue;\n\t\t}\n\n\t\tfor (const singleClient of clientsOfSameType)\n\t\t{\n\t\t\tif (!Type.isPlainObject(singleClient))\n\t\t\t{\n\t\t\t\tcontinue;\n\t\t\t}\n\n\t\t\tlet addressSource: ItemIdentifier;\n\t\t\ttry\n\t\t\t{\n\t\t\t\taddressSource = new ItemIdentifier(BX.CrmEntityType.resolveId(singleClient.typeName), singleClient.id);\n\t\t\t}\n\t\t\tcatch (e)\n\t\t\t{\n\t\t\t\tcontinue;\n\t\t\t}\n\n\t\t\tconst multifields = singleClient.advancedInfo?.multiFields;\n\t\t\tif (!Type.isArrayFilled(multifields))\n\t\t\t{\n\t\t\t\tcontinue;\n\t\t\t}\n\n\t\t\tfor (const singleMultifield of multifields)\n\t\t\t{\n\t\t\t\ttry\n\t\t\t\t{\n\t\t\t\t\treceivers.push(new Receiver(\n\t\t\t\t\t\titem,\n\t\t\t\t\t\taddressSource,\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tid: Text.toInteger(singleMultifield.ID),\n\t\t\t\t\t\t\ttypeId: stringOrUndefined(singleMultifield.TYPE_ID),\n\t\t\t\t\t\t\tvalueType: stringOrUndefined(singleMultifield.VALUE_TYPE),\n\t\t\t\t\t\t\tvalue: stringOrUndefined(singleMultifield.VALUE),\n\t\t\t\t\t\t\tvalueFormatted: stringOrUndefined(singleMultifield.VALUE_FORMATTED),\n\t\t\t\t\t\t},\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\ttitle: stringOrUndefined(singleClient.title),\n\t\t\t\t\t\t},\n\t\t\t\t\t));\n\t\t\t\t}\n\t\t\t\tcatch (e)\n\t\t\t\t{\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\treturn receivers;\n}\n\nfunction stringOrUndefined(value: ?string): string | undefined\n{\n\treturn Type.isNil(value) ? undefined : String(value);\n}\n\nfunction unique(receivers: Receiver[]): Receiver[]\n{\n\treturn receivers.filter((receiver, index) => {\n\t\tconst anotherIndex = receivers.findIndex(anotherReceiver => receiver.isEqualTo(anotherReceiver));\n\n\t\treturn anotherIndex === index;\n\t});\n}\n","import { ItemIdentifier } from 'crm.data-structures';\nimport { Type } from 'main.core';\nimport { BaseEvent, EventEmitter } from 'main.core.events';\nimport { extractReceivers } from './internal/extract-receivers';\nimport { ensureIsItemIdentifier, ensureIsReceiver } from './internal/validation';\nimport { Receiver } from './receiver';\n\nconst OBSERVED_EVENTS = new Set([\n\t'onCrmEntityCreate',\n\t'onCrmEntityUpdate',\n\t'onCrmEntityDelete',\n]);\n\n/**\n * @memberOf BX.Crm.MessageSender\n * @mixes EventEmitter\n *\n * @emits BX.Crm.MessageSender.ReceiverRepository:OnReceiversChanged\n * @emits BX.Crm.MessageSender.ReceiverRepository:OnItemDeleted\n *\n * Currently, this class is supposed to work only in the context of entity details tab.\n * In the future, it can be extended to work on any page. (see todos)\n */\nexport class ReceiverRepository\n{\n\tstatic #instance: ?ReceiverRepository;\n\n\t#onDetailsTabChangeEventHandler: (BaseEvent) => void;\n\n\t#storage: {[itemHash: string]: Receiver[]} = {};\n\n\t#observedItems: {[entityTypeId: number]: Set<number>} = {};\n\n\tstatic get Instance(): ReceiverRepository\n\t{\n\t\tif (!ReceiverRepository.#instance)\n\t\t{\n\t\t\tReceiverRepository.#instance = new ReceiverRepository();\n\t\t}\n\n\t\treturn ReceiverRepository.#instance;\n\t}\n\n\t/**\n\t * @internal This class is a singleton. Use Instance getter instead of constructing a new instance\n\t */\n\tconstructor()\n\t{\n\t\tif (ReceiverRepository.#instance)\n\t\t{\n\t\t\tthrow new Error('Attempt to make a new instance of a singleton');\n\t\t}\n\n\t\tthis.#init();\n\t}\n\n\t#init(): void\n\t{\n\t\tEventEmitter.makeObservable(this, 'BX.Crm.MessageSender.ReceiverRepository');\n\n\t\tthis.#onDetailsTabChangeEventHandler = (event: BaseEvent) => {\n\t\t\tif (!(event instanceof BaseEvent))\n\t\t\t{\n\t\t\t\tconsole.error('unexpected event type', event);\n\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif (!Type.isArrayFilled(event.getData()) || !Type.isPlainObject(event.getData()[0]))\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tthis.#onCrmEntityChange(event.getType(), event.getData()[0]);\n\t\t};\n\t\tthis.#onDetailsTabChangeEventHandler = this.#onDetailsTabChangeEventHandler.bind(this);\n\n\t\tfor (const eventName of OBSERVED_EVENTS)\n\t\t{\n\t\t\t// todo use BX.Crm.EntityEvent.subscribe instead, we will get data from all tabs/sliders\n\t\t\tEventEmitter.subscribe(eventName, this.#onDetailsTabChangeEventHandler);\n\t\t}\n\n\t\tif (BX.SidePanel?.Instance?.isOpen())\n\t\t{\n\t\t\t// we are on entity details slider\n\t\t\tEventEmitter.subscribe('SidePanel.Slider:onDestroy', this.#destroy.bind(this));\n\t\t}\n\t}\n\n\t#destroy(): void\n\t{\n\t\tfor (const eventName of OBSERVED_EVENTS)\n\t\t{\n\t\t\tEventEmitter.unsubscribe(eventName, this.#onDetailsTabChangeEventHandler);\n\t\t}\n\t\tReceiverRepository.#instance = null;\n\t}\n\n\t#onCrmEntityChange(eventType: string, { entityTypeId, entityId, entityData }): void\n\t{\n\t\tif (!this.#observedItems[entityTypeId]?.has(entityId))\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tconst item = new ItemIdentifier(entityTypeId, entityId);\n\n\t\tif (\n\t\t\teventType.toLowerCase() === 'onCrmEntityCreate'.toLowerCase()\n\t\t\t|| eventType.toLowerCase() === 'onCrmEntityUpdate'.toLowerCase()\n\t\t)\n\t\t{\n\t\t\tconst oldReceivers = this.#storage[item.hash] ?? [];\n\t\t\tconst newReceivers = extractReceivers(item, entityData);\n\n\t\t\tthis.#storage[item.hash] = newReceivers;\n\n\t\t\tconst added = newReceivers.filter((newReceiver) => {\n\t\t\t\treturn Type.isNil(oldReceivers.find((oldReceiver) => oldReceiver.isEqualTo(newReceiver)));\n\t\t\t});\n\t\t\tconst deleted = oldReceivers.filter((oldReceiver) => {\n\t\t\t\treturn Type.isNil(newReceivers.find((newReceiver) => newReceiver.isEqualTo(oldReceiver)));\n\t\t\t});\n\n\t\t\tif (added.length > 0 || deleted.length > 0)\n\t\t\t{\n\t\t\t\tthis.emit('OnReceiversChanged', { item, previous: oldReceivers, current: newReceivers, added, deleted });\n\t\t\t}\n\t\t}\n\t\telse if (eventType.toLowerCase() === 'onCrmEntityDelete'.toLowerCase())\n\t\t{\n\t\t\tdelete this.#storage[item.hash];\n\t\t\tthis.#observedItems[item.entityTypeId].delete(item.entityId);\n\t\t\tthis.emit('OnItemDeleted', { item });\n\t\t}\n\t\telse\n\t\t{\n\t\t\tconsole.error('unknown event type', eventType);\n\t\t}\n\t}\n\n\t/**\n\t * @internal\n\t */\n\tstatic onDetailsLoad(entityTypeId: number, entityId: number, receiversJSONString: string): void\n\t{\n\t\tlet item: ItemIdentifier = null;\n\t\ttry\n\t\t{\n\t\t\titem = new ItemIdentifier(entityTypeId, entityId);\n\t\t}\n\t\tcatch\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tconst instance = ReceiverRepository.Instance;\n\t\t// todo notify instances of this class on other tabs/sliders\n\t\tinstance.#startObservingItem(item);\n\n\t\tconst receiversJSON = JSON.parse(receiversJSONString);\n\t\tif (Type.isArrayFilled(receiversJSON))\n\t\t{\n\t\t\tconst receivers = [];\n\t\t\tfor (const singleReceiverJSON of receiversJSON)\n\t\t\t{\n\t\t\t\tconst receiver = Receiver.fromJSON(singleReceiverJSON);\n\t\t\t\tif (!Type.isNil(receiver))\n\t\t\t\t{\n\t\t\t\t\treceivers.push(receiver);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (Type.isArrayFilled(receivers))\n\t\t\t{\n\t\t\t\t// todo add receivers to instances of this class on other tabs/sliders\n\t\t\t\tinstance.#addReceivers(item, receivers);\n\t\t\t}\n\t\t}\n\t}\n\n\t#addReceivers(item: ItemIdentifier, receivers: Receiver[]): void\n\t{\n\t\tensureIsItemIdentifier(item);\n\n\t\tthis.#storage[item.hash] = [];\n\t\tfor (const receiver of receivers)\n\t\t{\n\t\t\tensureIsReceiver(receiver);\n\n\t\t\tthis.#storage[item.hash].push(receiver);\n\t\t}\n\n\t\tthis.#startObservingItem(item);\n\t}\n\n\t#startObservingItem(item: ItemIdentifier): void\n\t{\n\t\tensureIsItemIdentifier(item);\n\n\t\tconst observedItemsOfThisType = this.#observedItems[item.entityTypeId] ?? new Set();\n\t\tobservedItemsOfThisType.add(item.entityId);\n\t\tthis.#observedItems[item.entityTypeId] = observedItemsOfThisType;\n\t}\n\n\tgetReceivers(entityTypeId: number, entityId: number): Receiver[]\n\t{\n\t\ttry\n\t\t{\n\t\t\treturn this.getReceiversByIdentifier(new ItemIdentifier(entityTypeId, entityId));\n\t\t}\n\t\tcatch\n\t\t{\n\t\t\treturn [];\n\t\t}\n\t}\n\n\tgetReceiversByIdentifier(item: ItemIdentifier): Receiver[]\n\t{\n\t\tensureIsItemIdentifier(item);\n\n\t\treturn this.#storage[item.hash] ?? [];\n\t}\n}\n"],"names":["Types","Object","freeze","bitrix24","sms","ConsentApprover","constructor","senderType","checkAndApprove","Promise","resolve","ajax","runAction","then","data","html","catch","title","message","BX","UI","Dialogs","MessageBox","show","modal","buttons","popupOptions","className","Button","color","Color","SUCCESS","text","Loc","getMessage","onclick","button","isApprovedConsent","LIGHT_BORDER","response","status","context","close","content","Notification","Center","notify","showNotify","Base","params","openLineItems","entityTypeId","Type","isPlainObject","isNumber","getOpenLineCode","Error","checkAndGetLineId","isOpenLineItemSelected","force","item","getOpenLineItem","ReferenceError","selected","openLineCode","fetchOpenLineItems","reject","errors","getLineId","connectorId","ajaxParameters","withConnector","isArrayFilled","lineId","length","openLineItemsList","list","selectedItem","find","id","canEditConnector","openConnectSidePanel","url","onCloseCallback","isStringFilled","Router","openSlider","width","cacheable","name","RuWhatsApp","isWhatsAppAvailable","isSelected","virtual_whatsapp","onConnectVirtualWhatsApp","bind","onConnect","config","infoHelperCode","Reflection","getClass","InfoHelper","virtualWhatsAppItem","Telegram","isApproved","WhatsApp","hasAvailableProvider","smsSenders","some","provider","canUse","isTemplatesBased","MessageBoxButtons","OK_CANCEL","okCaption","onOk","messageBox","marketUrl","SidePanel","Instance","open","events","onClose","hasAvailableSmsProvider","Extension","getSettings","Factory","getScenarioInstance","RangeError","ConditionChecker","checkAndGetLine","serviceId","instance","isObjectLike","setOpenLineItems","setServiceId","TypeError","CrmEntityType","isDefined","setEntityTypeId","check","checkIsApproved","checkApproveConsent","items","scenario","ensureIsItemIdentifier","candidate","ItemIdentifier","ensureIsReceiver","Receiver","ensureIsValidMultifieldValue","isValidValue","isNil","isInteger","typeId","typeCaption","valueType","valueTypeCaption","value","valueFormatted","ensureIsValidSourceData","isValid","rootSource","addressSource","address","addressSourceData","complexId","fromJSON","e","isEqualTo","another","String","toJSON","extractReceivers","entityData","receivers","hasOwnProperty","push","extractReceiversFromMultifieldData","extractReceiversFromClientInfo","CLIENT_INFO","unique","multifields","MULTIFIELD_DATA","multifieldTypeId","itemSlug","entityId","split","Text","toInteger","addressSourceTitle","getAddressSourceTitle","singleMultifield","ID","stringOrUndefined","VALUE_TYPE","VALUE","VALUE_FORMATTED","COMPLEX_ID","COMPLEX_NAME","TITLE","FORMATTED_NAME","clientDataKey","resolveName","client","clientInfo","isString","clientsOfSameType","values","singleClient","resolveId","typeName","advancedInfo","multiFields","TYPE_ID","undefined","filter","receiver","index","anotherIndex","findIndex","anotherReceiver","OBSERVED_EVENTS","Set","ReceiverRepository","onDetailsLoad","receiversJSONString","receiversJSON","JSON","parse","singleReceiverJSON","getReceivers","getReceiversByIdentifier","hash","EventEmitter","makeObservable","event","BaseEvent","console","error","getData","getType","eventName","subscribe","isOpen","unsubscribe","eventType","has","toLowerCase","oldReceivers","newReceivers","added","newReceiver","oldReceiver","deleted","emit","previous","current","delete","observedItemsOfThisType","add"],"mappings":"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"}