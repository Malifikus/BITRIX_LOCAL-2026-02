this.BX=this.BX||{};this.BX.Crm=this.BX.Crm||{};(function(e,t,s,a,i,l,r,o,n,c,d,p,h,b,u,v,m,g,P,L){"use strict";const y={name:"LengthCounter",components:{BText:o.Text},computed:{...m.mapState({message:e=>e.message.text}),messageLengthCounter(){const e=this.isOverflow?'<span style="color: #d0011b;">':"<span>";const t="</span>";return L.Loc.getMessage("CRM_MESSAGESENDER_EDITOR_COUNTER",{"[color]":e,"#COUNT#":L.Text.toInteger(this.message.length),"[/color]":t,"#MAX#":this.recommendedMaxMessageLength})},isOverflow(){return this.message.length>this.recommendedMaxMessageLength},recommendedMaxMessageLength(){return L.Text.toInteger(L.Extension.getSettings("crm.messagesender.editor").get("recommendedMaxMessageLength"))}},template:`\n\t\t<BText \n\t\t\tsize="sm"\n\t\t\ttag="div"\n\t\t\tclassName="crm-messagesender-editor__content__footer__text"\n\t\t><span v-html="messageLengthCounter"></span></BText>\n\t`};const B={name:"ContentBody",props:{bgColor:{type:String,default:null},borderColor:{type:String,default:"var(--ui-color-divider-accent)"},padding:{type:String,default:"var(--ui-space-inset-md)"}},template:`\n\t\t<div\n\t\t\tclass="crm-messagesender-editor__content__body"\n\t\t\t:style="{\n\t\t\t\tbackgroundColor: bgColor,\n\t\t\t\tborder: 'var(--ui-border-width-thin) var(--ui-text-decoration-style-solid) ' + borderColor,\n\t\t\t\tpadding: padding,\n\t\t\t}"\n\t\t>\n\t\t\t<slot/>\n\t\t</div>\n\t`};const F={name:"ContentFooter",template:`\n\t\t<div class="crm-messagesender-editor__content__footer">\n\t\t\t<slot/>\n\t\t</div>\n\t`};const f={name:"MessagePreview",components:{BText:o.Text},placeholdersPreviewer:null,computed:{...m.mapGetters({isProgress:"application/isProgress",messageBody:"message/body",currentChannel:"channels/current"}),...m.mapState({context:e=>e.application.context})},beforeUnmount(){var e;(e=this.placeholdersPreviewer)==null?void 0:e.destroy()},methods:{togglePreviewer(){var e,t;if(this.isProgress||this.messageBody.trim().length===0){return}(e=this.placeholdersPreviewer)!=null?e:this.placeholdersPreviewer=new v.Previewer({...this.context,bindElement:this.$refs.preview.$el,isDisplayFormat:!((t=this.currentChannel)!=null&&t.isTemplatesBased)});if(this.placeholdersPreviewer.isShown()){this.placeholdersPreviewer.close()}else{this.$Bitrix.Data.get("locator").getAnalyticsService().onPreviewShow();this.placeholdersPreviewer.preview(this.messageBody)}}},template:`\n\t\t<BText\n\t\t\tref="preview"\n\t\t\tsize="sm"\n\t\t\ttag="div"\n\t\t\t:className="{\n\t\t\t\t'crm-messagesender-editor__content__footer__text': true, \n\t\t\t\t'--pointer': !isProgress && messageBody.trim().length > 0,\n\t\t\t\t'--disabled': isProgress || messageBody.trim().length <= 0,\n\t\t\t}"\n\t\t\tdata-test-role="preview"\n\t\t\t@click="togglePreviewer"\n\t\t>{{ $Bitrix.Loc.getMessage('CRM_MESSAGESENDER_EDITOR_PREVIEW') }}</BText>\n\t`};const S=150;const H={name:"CustomMessageContent",components:{BButton:n.Button,BText:o.Text,BMenu:i.BitrixVue.defineAsyncComponent("ui.system.menu.vue","BMenu"),Popup:i.BitrixVue.defineAsyncComponent("ui.vue3.components.popup","Popup"),Smiles:i.BitrixVue.defineAsyncComponent("ui.vue3.components.smiles","Smiles"),MessagePreview:f,ContentBody:B,ContentFooter:F,LengthCounter:y},setup(){return{AirButtonStyle:n.AirButtonStyle,Outline:b.Outline}},placeholdersDialog:null,data(){return{isAddMenuShown:false,isSmilesShown:false,textAreaHeight:"auto"}},computed:{...m.mapGetters({isProgress:"application/isProgress"}),...m.mapState({contentProviders:e=>e.application.contentProviders,layout:e=>e.application.layout,context:e=>e.application.context}),message:{get(){return this.$store.state.message.text},set(e){this.$store.dispatch("message/setText",{text:e})}},isShowActionsButton(){return this.layout.isContentProvidersShown&&this.menuItems.length>0},isShowCopilot(){var e;return this.layout.isContentProvidersShown&&((e=this.contentProviders.copilot)==null?void 0:e.isShown)},menuOptions(){return{bindElement:this.$refs.actions,sections:[{code:"crmValues"}],items:this.menuItems}},menuItems(){var e,t,s,a;const i=[];if((e=this.contentProviders.files)!=null&&e.isShown){const e={title:this.$Bitrix.Loc.getMessage("CRM_MESSAGESENDER_EDITOR_ADD_FILE"),icon:b.Outline.ATTACH,isLocked:this.contentProviders.files.isLocked};if(this.contentProviders.files.isEnabled&&!this.contentProviders.files.isLocked){e.subMenu={};e.subMenu.items=[{title:this.$Bitrix.Loc.getMessage("CRM_MESSAGESENDER_EDITOR_ADD_FILE_UPLOAD"),onClick:()=>{if(this.isProgress){return}this.getFileService().uploadNewFile(this.processFileResult)}},{title:this.$Bitrix.Loc.getMessage("CRM_MESSAGESENDER_EDITOR_ADD_FILE_DISK"),onClick:()=>{if(this.isProgress){return}this.getFileService().pickFromDisk(this.processFileResult)}}]}else if(this.contentProviders.files.isLocked){e.onClick=()=>{void this.showLimitSlider(this.contentProviders.files.sliderCode)}}i.push(e)}if((t=this.contentProviders.salescenter)!=null&&t.isShown){i.push({title:this.$Bitrix.Loc.getMessage("CRM_MESSAGESENDER_EDITOR_ADD_PAYMENT"),icon:b.Outline.MONEY,isLocked:this.contentProviders.salescenter.isLocked,onClick:async()=>{if(this.isProgress){return}if(this.contentProviders.salescenter.isLocked){this.getSalescenterService().showSalescenterDisabledSlider();return}if(!this.contentProviders.salescenter.isEnabled){this.$Bitrix.Data.get("locator").getLogger().warn("salescenter is not enabled");return}const e=await this.getSalescenterService().openApplication();this.processSalescenterResult(e)}})}if((s=this.contentProviders.documents)!=null&&s.isEnabled){i.push({title:this.$Bitrix.Loc.getMessage("CRM_MESSAGESENDER_EDITOR_ADD_DOCUMENT"),icon:b.Outline.FILE,onClick:async()=>{if(this.isProgress){return}const e=await this.getDocumentService().selectOrCreateDocument(this.$refs.actions);if(!L.Type.isNil(e)){this.processDocumentResult(e)}}})}if((a=this.contentProviders.crmValues)!=null&&a.isEnabled){i.push({title:this.$Bitrix.Loc.getMessage("CRM_MESSAGESENDER_EDITOR_ADD_CRM"),sectionCode:"crmValues",icon:b.Outline.PROMPT_VAR,onClick:()=>{if(this.isProgress){return}this.openPlaceholdersDialog()}})}return i},bgColor(){return this.layout.isMessageTextReadOnly?"var(--ui-color-accent-soft-blue-3)":undefined}},watch:{"message.length":function(){this.textAreaHeight="auto";void this.$nextTick((()=>{const e=Math.min(this.$refs.textarea.scrollHeight,S);this.textAreaHeight=`${e}px`}))}},beforeUnmount(){var e;(e=this.placeholdersDialog)==null?void 0:e.destroy()},methods:{getFileService(){return this.$Bitrix.Data.get("locator").getFileService()},getSalescenterService(){return this.$Bitrix.Data.get("locator").getSalescenterService()},getDocumentService(){return this.$Bitrix.Data.get("locator").getDocumentService()},getAnalyticsService(){return this.$Bitrix.Data.get("locator").getAnalyticsService()},processFileResult(e){this.$store.dispatch("message/setSource",{source:"file"});this.insertText(`${e.name} ${e.externalLink}`);this.getAnalyticsService().onAddFile()},processDocumentResult(e){this.$store.dispatch("message/setSource",{source:"document"});this.insertText(`${e.title} ${e.publicUrl}`);this.getAnalyticsService().onAddDocument()},processSalescenterResult(e){if(L.Type.isStringFilled(e.source)){this.$store.dispatch("message/setSource",{source:e.source})}if(L.Type.isPlainObject(e.page)){this.insertText(`${e.page.name} ${e.page.url}`);this.getAnalyticsService().onAddSalescenterPage()}else if(L.Type.isPlainObject(e.payment)){this.insertText(e.payment.name);if(!L.Type.isNil(e.payment.paymentId)){this.$store.dispatch("message/setPaymentId",{paymentId:e.payment.paymentId})}if(!L.Type.isNil(e.payment.shipmentId)){this.$store.dispatch("message/setShipmentId",{shipmentId:e.payment.shipmentId})}this.getAnalyticsService().onAddSalescenterPayment()}else if(L.Type.isPlainObject(e.compilation)){this.insertText(e.compilation.name);if(L.Type.isArray(e.compilation.productIds)){this.$store.dispatch("message/setCompilationProductIds",{compilationProductIds:e.compilation.productIds})}this.getAnalyticsService().onAddSalescenterCompilation()}},openPlaceholdersDialog(){var e;(e=this.placeholdersDialog)!=null?e:this.placeholdersDialog=new h.Dialog({targetNode:this.$refs.actions,multiple:false,showAvatars:false,dropdownMode:true,compactView:true,enableSearch:true,entities:[{id:"placeholder",dynamicLoad:true,dynamicSearch:false,searchable:true,options:this.context}],events:{"Item:onSelect":e=>{const{item:t}=e.getData();this.insertText(`{${t.getCustomData().get("text")}}`);this.getAnalyticsService().onAddCrmValue();t.deselect()}}});this.placeholdersDialog.show()},async showCopilot(){var e,t;if(this.isProgress){return}if((e=this.contentProviders.copilot)!=null&&e.isLocked){void this.showLimitSlider(this.contentProviders.copilot.sliderCode);return}if(!((t=this.contentProviders.copilot)!=null&&t.isEnabled)){this.$Bitrix.Data.get("locator").getLogger().warn("copilot is not enabled");return}const s=await this.$Bitrix.Data.get("locator").getCopilotService().showCopilot(this.$refs.textarea,"",this.message);if(L.Type.isStringFilled(s.textReplace)){this.message=s.textReplace;this.getAnalyticsService().onAddCopilot()}else if(L.Type.isStringFilled(s.textBelow)){this.message=`${this.message}\n${s.textBelow}`;this.getAnalyticsService().onAddCopilot()}},async showLimitSlider(e){try{const{FeaturePromotersRegistry:t}=await L.Runtime.loadExtension("ui.info-helper");t.getPromoter({code:e}).show()}catch(e){this.$Bitrix.Data.get("locator").getLogger().error("failed to show ui.info-helper",e)}},toggleSmiles(){if(this.isProgress){return}this.isSmilesShown=!this.isSmilesShown},insertText(e){const t=this.$refs.textarea.selectionStart;const s=this.$refs.textarea.selectionEnd;const a=this.message.slice(0,t);const i=this.message.slice(s);let l=e;if(a.length>0&&!a.endsWith(" ")&&!l.startsWith(" ")){l=` ${l}`}if(i.length>0&&!i.startsWith(" ")&&!l.endsWith(" ")){l=`${l} `}this.message=a+l+i;void this.$nextTick((()=>{const e=t+l.length;this.$refs.textarea.selectionStart=e;this.$refs.textarea.selectionEnd=e;this.$refs.textarea.focus()}))}},template:`\n\t\t<ContentBody\n\t\t\tpadding="0 0 var(--ui-space-inset-xs) 0"\n\t\t\t:bgColor="bgColor"\n\t\t\t:borderColor="bgColor"\n\t\t>\n\t\t\t\t<div class="crm-messagesender-editor__content__body__textarea-container">\n\t\t\t\t\t<textarea\n\t\t\t\t\t\tref="textarea"\n\t\t\t\t\t\tv-model="message"\n\t\t\t\t\t\tclass="crm-messagesender-editor__content__body__textarea"\n\t\t\t\t\t\t:placeholder="$Bitrix.Loc.getMessage('CRM_MESSAGESENDER_EDITOR_PLACEHOLDER')"\n\t\t\t\t\t\t:disabled="isProgress || layout.isMessageTextReadOnly"\n\t\t\t\t\t\t:style="{ \n\t\t\t\t\t\t\theight: textAreaHeight,\n\t\t\t\t\t\t\tbackgroundColor: bgColor, \n\t\t\t\t\t\t}"\n\t\t\t\t\t\tdata-test-role="message-text-input"\n\t\t\t\t\t></textarea>\n\t\t\t\t</div>\n\t\t\t<div ref="actions" v-if="isShowActionsButton || isShowCopilot || layout.isEmojiButtonShown" class="crm-messagesender-editor__content__body__actions">\n\t\t\t\t<div class="crm-messagesender-editor__content__body__actions__left">\n\t\t\t\t\t<BButton\n\t\t\t\t\t\tv-if="isShowActionsButton"\n\t\t\t\t\t\t:text="$Bitrix.Loc.getMessage('CRM_MESSAGESENDER_EDITOR_BUTTON_ADD')"\n\t\t\t\t\t\t:style="AirButtonStyle.PLAIN"\n\t\t\t\t\t\t:leftIcon="Outline.PLUS_M"\n\t\t\t\t\t\t:disabled="isProgress || layout.isMessageTextReadOnly"\n\t\t\t\t\t\t@click="isAddMenuShown = true"\n\t\t\t\t\t/>\n\t\t\t\t\t<BMenu v-if="isAddMenuShown && !isProgress" :options="menuOptions" @close="isAddMenuShown = false"/>\n\t\t\t\t\t<BButton\n\t\t\t\t\t\tv-if="isShowCopilot"\n\t\t\t\t\t\t@click="showCopilot"\n\t\t\t\t\t\t:style="AirButtonStyle.PLAIN"\n\t\t\t\t\t\t:leftIcon="Outline.COPILOT"\n\t\t\t\t\t\t:disabled="isProgress || layout.isMessageTextReadOnly"\n\t\t\t\t\t\tclass="crm-messagesender-editor__content__body__actions__copilot"\n\t\t\t\t\t/>\n\t\t\t\t</div>\n\t\t\t\t<div ref="buttons-right">\n\t\t\t\t\t<BButton\n\t\t\t\t\t\tv-if="layout.isEmojiButtonShown"\n\t\t\t\t\t\t:style="AirButtonStyle.PLAIN"\n\t\t\t\t\t\t:leftIcon="Outline.SMILE"\n\t\t\t\t\t\t@click="toggleSmiles"\n\t\t\t\t\t\t:disabled="isProgress || layout.isMessageTextReadOnly"\n\t\t\t\t\t/>\n\t\t\t\t\t<Popup\n\t\t\t\t\t\tv-if="isSmilesShown && !isProgress"\n\t\t\t\t\t\t:options="{ \n\t\t\t\t\t\t\t\tbindElement: $refs['buttons-right'],\n\t\t\t\t\t\t\t\twidth: 300,\n\t\t\t\t\t\t\t\theight: 300,\n\t\t\t\t\t\t\t\toffsetLeft: -133,\n\t\t\t\t\t\t\t}"\n\t\t\t\t\t\t@close="isSmilesShown = false"\n\t\t\t\t\t>\n\t\t\t\t\t\t<Smiles :isOnlyEmoji="true" @selectSmile="insertText($event.text)"/>\n\t\t\t\t\t</Popup>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</ContentBody>\n\t\t<ContentFooter>\n\t\t\t<MessagePreview v-if="layout.isMessagePreviewShown"/>\n\t\t\t<div v-else></div>\n\t\t\t<LengthCounter/>\n\t\t</ContentFooter>\n\t`};const E={name:"ContentContainer",template:`\n\t\t<div class="crm-messagesender-editor__content" data-role="content-container">\n\t\t\t<slot/>\n\t\t</div>\n\t`};const T={name:"NotificationMessageContent",components:{BText:o.Text,ContentBody:B},directives:{hint:l.hint},editor:null,computed:{...m.mapState({notificationTemplate:e=>e.application.notificationTemplate}),title(){var e,t;return((e=this.notificationTemplate)==null?void 0:(t=e.translation)==null?void 0:t.TITLE)||""},placeholders(){var e,t;return(e=(t=this.notificationTemplate)==null?void 0:t.placeholders)!=null?e:[]},previewPlaceholders(){return this.placeholders.map((e=>this.makeTranslationPlaceholderName(e.name)))},filledPlaceholders(){return this.placeholders.map((e=>{var t,s;return{PLACEHOLDER_ID:this.makeTranslationPlaceholderName(e.name),FIELD_VALUE:(t=(s=e.value)!=null?s:e.caption)!=null?t:""}}))},hasNotFilledPlaceholders(){return this.placeholders.some((e=>L.Type.isNil(e.value)))},hint(){if(!this.hasNotFilledPlaceholders){return null}return{text:this.$Bitrix.Loc.getMessage("CRM_MESSAGESENDER_EDITOR_PLACEHOLDER_FILLED_LATER_HINT"),position:"top"}}},mounted(){var e,t;this.editor=new v.Editor({...this.context,target:this.$refs.body,canUsePreview:false,isReadOnly:true});this.editor.setPlaceholders({PREVIEW:this.previewPlaceholders}).setFilledPlaceholders(this.filledPlaceholders).setBody(((e=this.notificationTemplate)==null?void 0:(t=e.translation)==null?void 0:t.TEXT)||this.$Bitrix.Loc.getMessage("CRM_MESSAGESENDER_EDITOR_TEMPLATE_MESSAGE"))},beforeUnmount(){var e;(e=this.editor)==null?void 0:e.destroy()},methods:{makeTranslationPlaceholderName(e){return`#${e}#`}},template:`\n\t\t<ContentBody bgColor="var(--ui-color-accent-soft-blue-3)" borderColor="var(--ui-color-accent-soft-blue-3)">\n\t\t\t<BText\n\t\t\t\tv-if="title"\n\t\t\t\ttag="div"\n\t\t\t\tsize="md"\n\t\t\t\tstyle="\n\t\t\t\t\tcolor: var(--ui-color-base-4);\n\t\t\t\t\tmargin-bottom: 8px;\n\t\t\t\t"\n\t\t\t>{{ title }}</BText>\n\t\t\t<div\n\t\t\t\tref="body"\n\t\t\t\tv-hint="hint"\n\t\t\t></div>\n\t\t</ContentBody>\n\t`};const C={name:"TemplateMessageContent",components:{BText:o.Text,ContentBody:B,ContentFooter:F,MessagePreview:f},editor:null,computed:{...m.mapGetters({currentChannel:"channels/current",template:"templates/current"}),...m.mapState({context:e=>e.application.context,isMessagePreviewShown:e=>e.application.layout.isMessagePreviewShown}),templateTitle(){var e;if(L.Type.isNil(this.template)){return this.$Bitrix.Loc.getMessage("CRM_MESSAGESENDER_EDITOR_NO_TEMPLATE_TITLE")}return(e=this.template.TITLE)!=null?e:""},templateBody(){var e;if(L.Type.isNil(this.template)){return this.$Bitrix.Loc.getMessage("CRM_MESSAGESENDER_EDITOR_NO_TEMPLATE_BODY")}return(e=this.template.PREVIEW.replaceAll("\n","<br>"))!=null?e:""}},watch:{"currentChannel.id":function(){this.ensureTemplatesLoaded()},template(){this.adjustEditor()}},created(){this.ensureTemplatesLoaded()},mounted(){this.editor=new v.Editor({...this.context,target:this.$refs.body,canUsePreview:false,canUseFieldsDialog:true,canUseFieldValueInput:true,onSelect:e=>{this.createOrUpdatePlaceholder(e);this.$store.dispatch("templates/setFilledPlaceholder",{filledPlaceholder:{PLACEHOLDER_ID:e.id,FIELD_NAME:e.value,FIELD_VALUE:e.text,PARENT_TITLE:e.parentTitle,TITLE:e.title}})}});this.adjustEditor()},beforeUnmount(){var e;(e=this.editor)==null?void 0:e.destroy()},methods:{ensureTemplatesLoaded(){this.$Bitrix.Data.get("locator").getTemplateService().loadTemplates()},createOrUpdatePlaceholder(e){this.$Bitrix.Data.get("locator").getTemplateService().createOrUpdatePlaceholder(e)},adjustEditor(){var e,t,s,a;this.editor.setPlaceholders(L.Runtime.clone((e=(t=this.template)==null?void 0:t.PLACEHOLDERS)!=null?e:[])).setFilledPlaceholders(L.Runtime.clone((s=(a=this.template)==null?void 0:a.FILLED_PLACEHOLDERS)!=null?s:[])).setBody(this.templateBody)}},template:`\n\t\t<ContentBody bgColor="var(--ui-color-accent-soft-blue-3)" borderColor="var(--ui-color-accent-soft-blue-3)">\n\t\t\t<BText\n\t\t\t\ttag="div"\n\t\t\t\tsize="md"\n\t\t\t\tstyle="\n\t\t\t\t\t\tcolor: var(--ui-color-base-4);\n\t\t\t\t\t\tmargin-bottom: 8px;\n\t\t\t\t\t"\n\t\t\t>{{ templateTitle }}</BText>\n\t\t\t<div ref="body"></div>\n\t\t</ContentBody>\n\t\t<ContentFooter>\n\t\t\t<MessagePreview v-if="isMessagePreviewShown"/>\n\t\t</ContentFooter>\n\t`};const I={name:"EditorAlert",alertInstance:null,data(){return{isAlertRendered:false}},computed:{...m.mapState({alert:e=>e.application.alert}),isAlertShown(){var e;return L.Type.isStringFilled((e=this.alert)==null?void 0:e.error)}},watch:{alert(e,t){if(!L.Type.isStringFilled(e==null?void 0:e.error)){var s;(s=this.alertInstance)==null?void 0:s.hide();this.isAlertRendered=false;return}if(!this.alertInstance){this.alertInstance=new r.Alert({color:r.AlertColor.DANGER,icon:r.AlertIcon.DANGER,animated:false})}if(e.error!==t.error){this.alertInstance.setText(L.Text.encode(e.error))}if(!this.isAlertRendered){this.alertInstance.show();this.alertInstance.renderTo(this.$el);this.isAlertRendered=true}}},beforeUnmount(){var e;(e=this.alertInstance)==null?void 0:e.destroy()},template:`\n\t\t<div class="crm-messagesender-editor__alert" data-test-role="alert" :style="{\n\t\t\tmarginTop: isAlertShown ? 'var(--ui-space-stack-xs2)' : null,\n\t\t}"></div>\n\t`};const w="crm-from";const _={name:"EditorFooter",components:{BButton:n.Button,BIcon:b.BIcon,BText:o.Text},setup(){return{AirButtonStyle:n.AirButtonStyle,Outline:b.Outline}},dialog:null,computed:{...m.mapGetters({channel:"channels/current",from:"channels/from",receiver:"channels/receiver",isReadyToSend:"message/isReadyToSend",isProgress:"application/isProgress"}),...m.mapState({isSending:e=>e.application.progress.isSending,layout:e=>e.application.layout}),fromText(){return this.$Bitrix.Loc.getMessage("CRM_MESSAGESENDER_EDITOR_FROM",{"#FROM#":this.from.name||""})},isSelectable(){return this.fromList.length>1},fromList(){var e,t;return(e=(t=this.channel)==null?void 0:t.fromList)!=null?e:[]},dialogItems(){return this.fromList.map((e=>({id:e.id,entityId:w,title:e.name,subtitle:e.description,selected:e.id===this.from.id,tabs:["recents"]})))}},methods:{toggleDialog(){if(!this.isSelectable){return}if(this.dialog){this.dialog.hide();this.dialog=null;return}this.dialog=new h.Dialog({targetNode:this.$refs.from,entities:[{id:w,searchable:true}],items:this.dialogItems,width:400,height:300,enableSearch:true,hideOnSelect:true,autoHide:true,dropdownMode:true,showAvatars:false,multiple:false,cacheable:false,events:{"Item:onSelect":e=>{this.$store.dispatch("channels/setFrom",{fromId:e.getData().item.id})},onDestroy:()=>{this.dialog=null}}});this.dialog.show()},send(){if(this.isProgress){return}this.$Bitrix.Data.get("locator").getSendService().sendMessage().catch((e=>{var t,s;this.$Bitrix.Data.get("locator").getAlertService().showError(e==null?void 0:(t=e.errors)==null?void 0:(s=t[0])==null?void 0:s.message)}))},cancel(){if(this.isProgress){return}this.$Bitrix.Data.get("locator").getAnalyticsService().onCancel();this.$Bitrix.Data.get("locator").getMessageModel().clearState();this.$store.dispatch("application/resetAlert");this.$Bitrix.eventEmitter.emit("crm:messagesender:editor:onCancel")}},template:`\n\t\t<div class="crm-messagesender-editor__footer">\n\t\t\t<div class="crm-messagesender-editor__footer__buttons">\n\t\t\t\t<BButton\n\t\t\t\t\tv-if="layout.isSendButtonShown"\n\t\t\t\t\t:text="$Bitrix.Loc.getMessage('CRM_MESSAGESENDER_EDITOR_BUTTON_SEND')"\n\t\t\t\t\t@click="send"\n\t\t\t\t\t:disabled="!isReadyToSend || (isProgress && !isSending)" \n\t\t\t\t\t:loading="isSending"\n\t\t\t\t/>\n\t\t\t\t<BButton\n\t\t\t\t\tv-if="layout.isCancelButtonShown"\n\t\t\t\t\t:text="$Bitrix.Loc.getMessage('CRM_MESSAGESENDER_EDITOR_BUTTON_CANCEL')"\n\t\t\t\t\t@click="cancel"\n\t\t\t\t\t:style="AirButtonStyle.PLAIN"\n\t\t\t\t\t:disabled="isProgress"\n\t\t\t\t/>\n\t\t\t</div>\n\t\t\t<div v-if="from" ref="from" class="crm-messagesender-editor__footer__from" data-test-role="from-selector" @click="toggleDialog" :style="{\n\t\t\t\tcursor: isSelectable ? 'pointer' : 'default',\n\t\t\t}">\n\t\t\t\t<BText \n\t\t\t\t\ttag="div"\n\t\t\t\t\tsize="xs"\n\t\t\t\t\talign="right"\n\t\t\t\t\tclassName="crm-messagesender-editor__footer__from__text"\n\t\t\t\t>{{ fromText }}</BText>\n\t\t\t\t<BIcon v-if="isSelectable" :name="Outline.CHEVRON_DOWN_S"/>\n\t\t\t</div>\n\t\t</div>\n\t`};const O={name:"ChannelSelector",components:{Chip:u.Chip},selector:null,computed:{...m.mapGetters({currentChannel:"channels/current",itemsSort:"preferences/channelsSortOrDefault"}),...m.mapState({allChannels:e=>e.channels.collection,promoBanners:e=>e.application.promoBanners}),selectorItems(){return this.allChannels.map((e=>({id:e.id,appearance:e.appearance,onclick:e=>{var t;this.$store.dispatch("channels/setChannel",{channelId:e.id});this.$Bitrix.Data.get("locator").getAnalyticsService().onSelectChannel();(t=this.selector)==null?void 0:t.close()}})))}},watch:{allChannels(){this.destroySelector()},promoBanners(){this.destroySelector()}},beforeUnmount(){this.destroySelector()},methods:{toggleSelector(){var e,t;if((e=this.selector)!=null&&e.isShown()){this.selector.close();return}(t=this.selector)!=null?t:this.selector=new c.Selector({bindElement:this.$el,items:L.Runtime.clone(this.selectorItems),banners:L.Runtime.clone(this.promoBanners),itemsSort:L.Runtime.clone(this.itemsSort),analytics:L.Runtime.clone(this.$store.state.analytics.analytics),events:{onSave:e=>{const{itemsSort:t}=e.getData();if(this.isSortChanged(t)){this.$Bitrix.Data.get("locator").getAnalyticsService().onSaveChannelsSort()}this.getPreferencesService().saveChannelsSort(t)},onConnectionsSliderClose:()=>{this.$Bitrix.Data.get("locator").getAnalyticsService().onAddChannelClick();this.$Bitrix.eventEmitter.emit("crm:messagesender:editor:onConnectionsSliderClose")},onPromoBannerSliderClose:e=>{const{bannerId:t,connectStatus:s}=e.getData();this.$Bitrix.Data.get("locator").getAnalyticsService().onBannerConnectClick(t,s);this.$Bitrix.eventEmitter.emit("crm:messagesender:editor:onPromoBannerSliderClose")},onDestroy:()=>{this.selector=null}}});this.selector.show()},isSortChanged(e){if(e.length!==this.itemsSort.length){return true}return!this.itemsSort.every(((t,s)=>t===e[s]))},destroySelector(){var e;(e=this.selector)==null?void 0:e.destroy();this.selector=null},getPreferencesService(){return this.$Bitrix.Data.get("locator").getPreferencesService()}},template:`\n\t\t<Chip\n\t\t\t:icon="currentChannel.appearance.icon.title"\n\t\t\t:iconColor="currentChannel.appearance.icon.color"\n\t\t\t:iconBackground="currentChannel.appearance.icon.background"\n\t\t\t:dropdown="true"\n\t\t\t:text="currentChannel.appearance.title"\n\t\t\t:trimmable="true"\n\t\t\tdata-test-role="channel-selector"\n\t\t\t@click="toggleSelector"\n\t\t/>\n\t`};const D="crm-receiver";const x={name:"ReceiverSelector",components:{Chip:u.Chip},setup(){return{Outline:b.Outline,ChipDesign:u.ChipDesign}},dialog:null,computed:{...m.mapGetters({channel:"channels/current",receiver:"channels/receiver"}),hasReceivers(){var e;return L.Type.isArrayFilled((e=this.channel)==null?void 0:e.toList)},chipText(){if(!this.hasReceivers){return this.$Bitrix.Loc.getMessage("CRM_MESSAGESENDER_EDITOR_NO_RECEIVER")}return`${this.receiver.addressSourceData.title} ${this.receiver.address.valueFormatted}`},dialogItems(){return this.channel.toList.map((e=>{var t;return{id:e.address.id,entityId:D,title:e.addressSourceData.title,subtitle:this.$Bitrix.Loc.getMessage("CRM_MESSAGESENDER_EDITOR_RECEIVER_SUBTITLE_TEMPLATE",{"#ADDRESS#":e.address.valueFormatted,"#TYPE#":e.address.valueTypeCaption}),avatar:`/bitrix/js/crm/messagesender/editor/images/${e.addressSource.entityTypeName.toLowerCase()}.svg`,selected:((t=this.receiver)==null?void 0:t.address.id)===e.address.id,tabs:["recents"]}}))}},methods:{toggleDialog(){if(!this.hasReceivers){return}if(this.dialog){this.dialog.hide();this.dialog=null;return}this.dialog=new h.Dialog({targetNode:this.$el,entities:[{id:D,searchable:true}],items:this.dialogItems,width:400,height:300,enableSearch:true,hideOnSelect:true,autoHide:true,dropdownMode:true,multiple:false,cacheable:false,events:{"Item:onSelect":e=>{this.$store.dispatch("channels/setReceiver",{receiverAddressId:e.getData().item.id})},onDestroy:()=>{this.dialog=null}}});this.dialog.show()}},template:`\n\t\t<Chip \n\t\t\t:icon="Outline.PERSON" \n\t\t\ticonColor="var(--ui-color-accent-main-primary-alt)"\n\t\t\ticonBackground="var(--ui-color-accent-soft-blue-3)"\n\t\t\t:design="hasReceivers ? ChipDesign.Outline : ChipDesign.ShadowDisabled"\n\t\t\t:dropdown="true"\n\t\t\t:trimmable="true"\n\t\t\t:text="chipText"\n\t\t\tdata-test-role="receiver-selector"\n\t\t\t@click="toggleDialog"\n\t\t/>\n\t`};let A=e=>e,M,R;const N="crm-hsm";const j={name:"TemplateSelector",components:{Chip:u.Chip},setup(){return{Outline:b.Outline}},dialog:null,computed:{...m.mapGetters({templates:"templates/listForChannel",current:"templates/current"}),dialogItems(){return this.templates.map((e=>{var t;return{id:e.ORIGINAL_ID,entityId:N,title:e.TITLE,subtitle:e.PREVIEW,avatar:"/bitrix/js/crm/messagesender/editor/images/template.svg",avatarOptions:{bgColor:"var(--ui-color-accent-soft-blue-3)"},selected:((t=this.current)==null?void 0:t.ORIGINAL_ID)===e.ORIGINAL_ID,tabs:["recents"]}}))},dialogFooter(){return[L.Tag.render(M||(M=A`<span style="width: 100%;"></span>`)),L.Tag.render(R||(R=A`
					<span onclick="${0}" class="ui-selector-footer-link">${0}</span>
				`),this.showFeedbackForm,this.$Bitrix.Loc.getMessage("CRM_MESSAGESENDER_EDITOR_SUGGEST_TEMPLATE"))]}},methods:{toggleDialog(){if(this.dialog){this.dialog.hide();this.dialog=null;return}this.dialog=new h.Dialog({targetNode:this.$el,entities:[{id:N,searchable:true}],items:this.dialogItems,width:400,height:350,enableSearch:true,hideOnSelect:true,autoHide:true,dropdownMode:true,multiple:false,cacheable:false,footer:this.dialogFooter,events:{"Item:onSelect":e=>{this.$store.dispatch("templates/setTemplate",{templateOriginalId:e.getData().item.id});this.$Bitrix.Data.get("locator").getAnalyticsService().onSelectTemplate()},onDestroy:()=>{this.dialog=null}}});this.dialog.show()},async showFeedbackForm(){this.$Bitrix.Data.get("locator").getAnalyticsService().onSuggestTemplate();const{Form:e}=await L.Runtime.loadExtension("ui.feedback.form");e.open({id:"b24_crm_timeline_whatsapp_template_suggest_form",forms:[{zones:["ru","by","kz"],id:758,lang:"ru",sec:"jyafqa"},{zones:["en"],id:760,lang:"en",sec:"culzcq"},{zones:["de"],id:764,lang:"de",sec:"9h74xf"},{zones:["com.br"],id:766,lang:"com.br",sec:"ddkhcc"},{zones:["es"],id:762,lang:"es",sec:"6ni833"},{zones:["en"],id:760,lang:"en",sec:"culzcq"}]})}},template:`\n\t\t<Chip \n\t\t\t:icon="Outline.TEXT_FORMAT_BOTTOM"\n\t\t\t:dropdown="true"\n\t\t\t:text="$Bitrix.Loc.getMessage('CRM_MESSAGESENDER_EDITOR_TEMPLATES')"\n\t\t\tdata-test-role="template-selector"\n\t\t\t@click="toggleDialog"\n\t\t/>\n\t`};const $={name:"EditorHeader",components:{BButton:n.Button,ChannelSelector:O,ReceiverSelector:x,TemplateSelector:j},setup(){return{AirButtonStyle:n.AirButtonStyle,Outline:b.Outline}},computed:{...m.mapGetters({currentChannel:"channels/current"}),hasChannels(){return!L.Type.isNil(this.currentChannel)},isTemplatesSelectorShown(){var e;return Boolean((e=this.currentChannel)==null?void 0:e.isTemplatesBased)}},methods:{async openConnectionsSlider(){const{Router:e}=await L.Runtime.loadExtension("crm.router");await e.Instance.openMessageSenderConnectionsSlider(this.$store.state.analytics.analytics);this.$Bitrix.Data.get("locator").getAnalyticsService().onNoChannelsButtonClick();this.$Bitrix.eventEmitter.emit("crm:messagesender:editor:onConnectionsSliderClose")}},template:`\n\t\t<div class="crm-messagesender-editor__header">\n\t\t\t<div class="crm-messagesender-editor__header-left" data-role="header-left">\n\t\t\t\t<ChannelSelector v-if="hasChannels"/>\n\t\t\t\t<BButton\n\t\t\t\t\tv-else\n\t\t\t\t\t:style="AirButtonStyle.FILLED"\n\t\t\t\t\t:leftIcon="Outline.MESSAGES"\n\t\t\t\t\t:shimmer="true"\n\t\t\t\t\t:text="$Bitrix.Loc.getMessage('CRM_MESSAGESENDER_EDITOR_BUTTON_NO_CHANNELS')"\n\t\t\t\t\t@click="openConnectionsSlider"\n\t\t\t\t/>\n\t\t\t\t<ReceiverSelector v-if="hasChannels"/>\n\t\t\t</div>\n\t\t\t<div class="crm-messagesender-editor__header-right">\n\t\t\t\t<TemplateSelector v-if="isTemplatesSelectorShown"/>\n\t\t\t</div>\n\t\t</div>\n\t`};const K={name:"MessageEditor",components:{EditorHeader:$,ContentContainer:E,CustomMessageContent:H,TemplateMessageContent:C,NotificationMessageContent:T,EditorFooter:_,EditorAlert:I},computed:{...m.mapGetters({currentChannel:"channels/current"}),...m.mapState({layout:e=>e.application.layout}),contentComponent(){var e,t;if(((e=this.currentChannel)==null?void 0:e.backend.senderCode)==="bitrix24"){return"NotificationMessageContent"}if((t=this.currentChannel)!=null&&t.isTemplatesBased){return"TemplateMessageContent"}return"CustomMessageContent"},paddingStyle(){var e,t,s,a;return{paddingTop:(e=this.layout.paddingTop)!=null?e:this.layout.padding,paddingBottom:(t=this.layout.paddingBottom)!=null?t:this.layout.padding,paddingLeft:(s=this.layout.paddingLeft)!=null?s:this.layout.padding,paddingRight:(a=this.layout.paddingRight)!=null?a:this.layout.padding}}},template:`\n\t\t<div class="crm-messagesender-editor" data-test-role="crm-messagesender-editor" :style="paddingStyle">\n\t\t\t<EditorHeader v-if="layout.isHeaderShown"/>\n\t\t\t<ContentContainer>\n\t\t\t\t<component :is="contentComponent"/>\n\t\t\t</ContentContainer>\n\t\t\t<EditorFooter v-if="layout.isFooterShown"/>\n\t\t\t<EditorAlert/>\n\t\t</div>\n\t`};var k=babelHelpers.classPrivateFieldLooseKey("logger");class G extends m.BuilderModel{constructor(...e){super(...e);Object.defineProperty(this,k,{writable:true,value:void 0})}getName(){return"analytics"}setLogger(e){babelHelpers.classPrivateFieldLooseBase(this,k)[k]=e;return this}getState(){return{analytics:{c_section:this.getVariable("analytics.c_section",null),c_sub_section:this.getVariable("analytics.c_sub_section",null)}}}}function V(e){return U(L.Runtime.clone(e))}function U(e){if(L.Type.isObject(e)){Object.values(e).forEach((e=>{U(e)}));return Object.freeze(e)}return e}var X=babelHelpers.classPrivateFieldLooseKey("logger");class z extends m.BuilderModel{constructor(...e){super(...e);Object.defineProperty(this,X,{writable:true,value:void 0})}getName(){return"application"}setLogger(e){babelHelpers.classPrivateFieldLooseBase(this,X)[X]=e;return this}getState(){return{context:V(this.getVariable("context",{})),contentProviders:V(this.getVariable("contentProviders",{})),notificationTemplate:V(this.getVariable("notificationTemplate",null)),promoBanners:V(this.getVariable("promoBanners",null)),layout:V(this.getVariable("layout",{isHeaderShown:true,isFooterShown:true,isSendButtonShown:true,isCancelButtonShown:true,isMessagePreviewShown:true,isContentProvidersShown:true,isEmojiButtonShown:true,isMessageTextReadOnly:false,padding:"var(--ui-space-inset-lg)"})),scene:V(this.getVariable("scene",{id:""})),progress:{isSending:false,isLoading:false},alert:{error:""}}}getGetters(){return{isProgress:e=>{for(const t of Object.values(e.progress)){if(t){return true}}return false}}}getActions(){return{actualizeState:(e,t)=>{e.commit("actualizeState",V(t))},setProgress:(e,t)=>{const s=new Set(["isSending","isLoading"]);const a={};for(const e of Object.keys(t)){if(s.has(e)){a[e]=t[e]}}for(const[e,s]of Object.entries(a)){if(!L.Type.isBoolean(s)){babelHelpers.classPrivateFieldLooseBase(this,X)[X].warn(`setProgress: ${e} should be boolean`,{payload:t});return}}e.commit("updateProgress",{progress:a})},setAlert:(e,t)=>{if(!L.Type.isString(t.error)){babelHelpers.classPrivateFieldLooseBase(this,X)[X].warn("setError: error should be string",{payload:t});return}e.commit("actualizeState",{alert:{error:t.error}})},resetAlert:e=>{e.commit("actualizeState",{alert:{error:""}})}}}getMutations(){return{actualizeState:(e,t)=>{for(const[s,a]of Object.entries(t)){if(s in e){e[s]=a}}},updateProgress:(e,t)=>{e.progress={...e.progress,...t.progress}}}}}var W=babelHelpers.classPrivateFieldLooseKey("logger");class q extends m.BuilderModel{constructor(...e){super(...e);Object.defineProperty(this,W,{writable:true,value:void 0})}getName(){return"channels"}setLogger(e){babelHelpers.classPrivateFieldLooseBase(this,W)[W]=e;return this}getState(){var e,t,s,a;const i=this.getVariable("collection",[]);U(i);return{collection:i,selected:{channelId:this.getVariable("selected.channelId"),fromId:this.getVariable("selected.fromId",(e=i[0])==null?void 0:(t=e.fromList[0])==null?void 0:t.id),receiverAddressId:this.getVariable("selected.receiverAddressId",(s=i[0])==null?void 0:(a=s.toList[0])==null?void 0:a.address.id)}}}getGetters(){return{canSendMessage:e=>e.collection.some((e=>e.isConnected)),current:(e,t,s,a)=>{const i=e.collection.find((t=>t.id===e.selected.channelId));if(i){return i}const l=a["preferences/firstVisibleChannelId"];return e.collection.find((e=>e.id===l))||e.collection[0]},from:(e,t)=>{const s=t.current;if(!s){return null}return s.fromList.find((t=>t.id===e.selected.fromId))||s.fromList[0]},receiver:(e,t)=>{const s=t.current;if(!s){return null}const a=s.toList.find((t=>t.address.id===e.selected.receiverAddressId));if(a){return a}return s.toList[0]}}}getActions(){return{actualizeState:(e,t)=>{e.commit("actualizeState",U(t))},setChannel:(e,t)=>{const{channelId:s}=t;if(!L.Type.isStringFilled(s)){babelHelpers.classPrivateFieldLooseBase(this,W)[W].warn("setChannel: channelId should be a string",{payload:t});return}const a=e.state.collection.find((e=>e.id===s));if(!a){babelHelpers.classPrivateFieldLooseBase(this,W)[W].warn("setChannel: channel not found",{payload:t});return}e.commit("updateSelected",{selected:{channelId:s}})},setFrom:(e,t)=>{const{fromId:s}=t;if(!L.Type.isStringFilled(s)){babelHelpers.classPrivateFieldLooseBase(this,W)[W].warn("setFrom: fromId should be a string",{payload:t});return}const a=e.getters.current;const i=a.fromList.find((e=>e.id===s));if(!i){babelHelpers.classPrivateFieldLooseBase(this,W)[W].warn("setFrom: from not found",{payload:t});return}e.commit("updateSelected",{selected:{fromId:s}})},setReceiver:(e,t)=>{const{receiverAddressId:s}=t;if(!L.Type.isInteger(s)){babelHelpers.classPrivateFieldLooseBase(this,W)[W].warn("setReceiver: receiverAddressId should be an integer",{payload:t});return}const a=e.getters.current;const i=a.toList.find((e=>e.address.id===s));if(!i){babelHelpers.classPrivateFieldLooseBase(this,W)[W].warn("setReceiver: receiver not found",{payload:t});return}e.commit("updateSelected",{selected:{receiverAddressId:s}})}}}getMutations(){return{actualizeState:(e,t)=>{for(const[s,a]of Object.entries(t)){if(s in e){e[s]=a}}},updateSelected:(e,t)=>{e.selected={...e.selected,...t.selected}}}}}var Y=babelHelpers.classPrivateFieldLooseKey("logger");var J=babelHelpers.classPrivateFieldLooseKey("compileNotificationBody");var Q=babelHelpers.classPrivateFieldLooseKey("compileTemplateBody");class Z extends m.BuilderModel{constructor(...e){super(...e);Object.defineProperty(this,Q,{value:te});Object.defineProperty(this,J,{value:ee});Object.defineProperty(this,Y,{writable:true,value:void 0})}getName(){return"message"}setLogger(e){babelHelpers.classPrivateFieldLooseBase(this,Y)[Y]=e;return this}getState(){var e;return{text:String((e=this.getVariable("text",""))!=null?e:""),source:null,paymentId:null,shipmentId:null,compilationProductIds:null}}getGetters(){return{body:(e,t,s,a)=>{const i=a["channels/current"];if((i==null?void 0:i.backend.senderCode)==="bitrix24"){const e=s.application.notificationTemplate;if(L.Type.isNil(e)){return""}return babelHelpers.classPrivateFieldLooseBase(this,J)[J](e)}if(!(i!=null&&i.isTemplatesBased)){return e.text.trim()}const l=a["templates/current"];if(L.Type.isNil(l)){return""}return babelHelpers.classPrivateFieldLooseBase(this,Q)[Q](l)},isReadyToSend:(e,t,s,a)=>{if(L.Type.isNil(a["channels/current"])||L.Type.isNil(a["channels/from"])||L.Type.isNil(a["channels/receiver"])){return false}const i=a["channels/current"];if(i.backend.senderCode==="bitrix24"){var l;return L.Type.isStringFilled((l=s.application.notificationTemplate)==null?void 0:l.code)}return L.Type.isStringFilled(t.body)}}}getActions(){return{setText:(e,t)=>{const{text:s}=t;if(!L.Type.isString(s)){babelHelpers.classPrivateFieldLooseBase(this,Y)[Y].warn("setText: text should be a string",{payload:t});return}e.commit("setText",{text:s})},setSource:(e,t)=>{const{source:s}=t;if(!L.Type.isStringFilled(s)){babelHelpers.classPrivateFieldLooseBase(this,Y)[Y].warn("setSource: source should be a string",{payload:t});return}e.commit("setSource",{source:s})},setPaymentId:(e,t)=>{const{paymentId:s}=t;if(!L.Type.isInteger(s)){babelHelpers.classPrivateFieldLooseBase(this,Y)[Y].warn("setPaymentId: paymentId should be an int",{payload:t});return}e.commit("setPaymentId",{paymentId:s})},setShipmentId:(e,t)=>{const{shipmentId:s}=t;if(!L.Type.isInteger(s)){babelHelpers.classPrivateFieldLooseBase(this,Y)[Y].warn("setShipmentId: shipmentId should be an int",{payload:t});return}e.commit("setShipmentId",{shipmentId:s})},setCompilationProductIds:(e,t)=>{const{compilationProductIds:s}=t;if(!L.Type.isArray(s)){babelHelpers.classPrivateFieldLooseBase(this,Y)[Y].warn("setCompilationProductIds: compilationProductIds should be an array",{payload:t});return}if(s.some((e=>!L.Type.isInteger(e)))){babelHelpers.classPrivateFieldLooseBase(this,Y)[Y].warn("setCompilationProductIds: compilationProductIds should contain only integers",{payload:t});return}e.commit("setCompilationProductIds",{compilationProductIds:s})}}}getMutations(){return{setText:(e,t)=>{e.text=t.text},setSource:(e,t)=>{e.source=t.source},setPaymentId:(e,t)=>{e.paymentId=t.paymentId},setShipmentId:(e,t)=>{e.shipmentId=t.shipmentId},setCompilationProductIds:(e,t)=>{e.compilationProductIds=t.compilationProductIds}}}}function ee(e){var t;let s=((t=e.translation)==null?void 0:t.TEXT)||"";for(const t of e.placeholders||[]){if(!L.Type.isNil(t.value)){s=s.replace(`#${t.name}#`,t.value)}else if(!L.Type.isNil(t.caption)){s=s.replace(`#${t.name}#`,t.caption)}}return s}function te(e){var t,s,a;return v.getPlainText(e.PREVIEW,(t=(s=e.PLACEHOLDERS)==null?void 0:s.PREVIEW)!=null?t:[],(a=e.FILLED_PLACEHOLDERS)!=null?a:[])}var se=babelHelpers.classPrivateFieldLooseKey("logger");class ae extends m.BuilderModel{constructor(...e){super(...e);Object.defineProperty(this,se,{writable:true,value:void 0})}getName(){return"preferences"}setLogger(e){babelHelpers.classPrivateFieldLooseBase(this,se)[se]=e;return this}getState(){return{channelsSort:L.Runtime.clone(this.getVariable("channelsSort",null))}}getGetters(){return{channelsSortOrDefault:(e,t,s)=>{var a;const i=L.Runtime.clone((a=e.channelsSort)!=null?a:[]);for(const e of s.channels.collection){if(!i.some((t=>t.channelId===e.id))){i.unshift({channelId:e.id,isHidden:false})}}return i},firstVisibleChannelId:(e,t)=>{const s=t.channelsSortOrDefault;const a=s.filter((e=>!e.isHidden));if(L.Type.isArrayFilled(a)){return a[0].channelId}return null}}}getActions(){return{actualizeState:(e,t)=>{e.commit("actualizeState",L.Runtime.clone(t))},setChannelsSort:(e,t)=>{const{channelsSort:s}=t;if(!L.Type.isArray(s)){babelHelpers.classPrivateFieldLooseBase(this,se)[se].warn("setChannelsSort: channelsSort should be an array",{payload:t});return}const a=s.filter((e=>L.Type.isPlainObject(e))).map((e=>L.Runtime.clone(e)));if(!L.Type.isArrayFilled(a)){babelHelpers.classPrivateFieldLooseBase(this,se)[se].warn("setChannelsSort: channelsSort should contain at least one position",{payload:t});return}e.commit("setChannelsSort",{channelsSort:a})}}}getMutations(){return{actualizeState:(e,t)=>{for(const[s,a]of Object.entries(t)){if(s in e){e[s]=a}}},setChannelsSort:(e,{channelsSort:t})=>{e.channelsSort=t}}}}const ie="PREVIEW";const le=100;var re=babelHelpers.classPrivateFieldLooseKey("logger");class oe extends m.BuilderModel{constructor(...e){super(...e);Object.defineProperty(this,re,{writable:true,value:void 0})}getName(){return"templates"}setLogger(e){babelHelpers.classPrivateFieldLooseBase(this,re)[re]=e;return this}getState(){return{collection:{},selected:{}}}getGetters(){return{listForChannel:(e,t,s,a)=>{var i;const l=a["channels/current"];if(!(l!=null&&l.isTemplatesBased)){return[]}return(i=e.collection[t.cacheContextId])!=null?i:[]},current:(e,t,s,a)=>{var i;const l=t.listForChannel;const r=e.selected[(i=a["channels/current"])==null?void 0:i.id];if(L.Type.isNil(r)){return l[0]}return l.find((e=>e.ORIGINAL_ID===r))||l[0]},cacheContextId:(e,t,s,a)=>{const i=a["channels/current"];if(L.Type.isNil(i)){return""}const l=s.application.context;const r=[i.backend.senderCode,i.backend.id,l.entityTypeId,l.entityId,l.categoryId];return r.filter((e=>!L.Type.isNil(e))).join("_")}}}getActions(){return{addTemplates:(e,t)=>{const{templates:s}=t;if(!L.Type.isArray(s)){babelHelpers.classPrivateFieldLooseBase(this,re)[re].warn("addTemplates: templates should be a empty array",{payload:t});return}if(Object.keys(e.state.collection).length>=le){e.commit("clearCollection")}e.commit("addTemplates",{contextId:e.getters.cacheContextId,templates:L.Runtime.clone(s)});this.saveState(e.state)},setTemplate:(e,t)=>{const{templateOriginalId:s}=t;if(!L.Type.isInteger(s)||s<=0){babelHelpers.classPrivateFieldLooseBase(this,re)[re].warn("setTemplate: templateOriginalId should be a positive int",{payload:t});return}const a=e.rootGetters["channels/current"];if(L.Type.isNil(a)){babelHelpers.classPrivateFieldLooseBase(this,re)[re].warn("setTemplate: no current channel");return}if(!a.isTemplatesBased){babelHelpers.classPrivateFieldLooseBase(this,re)[re].warn("setTemplate: channel is not templates based",{payload:t});return}e.commit("select",{channelId:a.id,templateOriginalId:s});this.saveState(e.state)},setFilledPlaceholder:(e,t)=>{const{filledPlaceholder:s}=t;if(!L.Type.isPlainObject(s)){babelHelpers.classPrivateFieldLooseBase(this,re)[re].warn("setFilledPlaceholder: filledPlaceholder should be a valid object",{payload:t});return}const a=e.getters.current;if(!a){babelHelpers.classPrivateFieldLooseBase(this,re)[re].warn("setFilledPlaceholder: current template is not set",{payload:t});return}const i=a.PLACEHOLDERS[ie].includes(s.PLACEHOLDER_ID);if(!i){babelHelpers.classPrivateFieldLooseBase(this,re)[re].warn("setFilledPlaceholder: filledPlaceholder.PLACEHOLDER_ID references non-existent placeholder",{payload:t});return}e.commit("upsertFilledPlaceholder",{contextId:e.getters.cacheContextId,templateOriginalId:a.ORIGINAL_ID,filledPlaceholder:V(s)});this.saveState(e.state)}}}getMutations(){return{addTemplates:(e,{contextId:t,templates:s})=>{e.collection[t]=s},clearCollection:e=>{e.collection={}},select:(e,{channelId:t,templateOriginalId:s})=>{e.selected[t]=s},upsertFilledPlaceholder:(e,{contextId:t,templateOriginalId:s,filledPlaceholder:a})=>{var i;const l=e.collection[t];const r=l.find((e=>e.ORIGINAL_ID===s));(i=r.FILLED_PLACEHOLDERS)!=null?i:r.FILLED_PLACEHOLDERS=[];r.FILLED_PLACEHOLDERS=r.FILLED_PLACEHOLDERS.filter((e=>e.PLACEHOLDER_ID!==a.PLACEHOLDER_ID));r.FILLED_PLACEHOLDERS.push(a)}}}}var ne=babelHelpers.classPrivateFieldLooseKey("store");class ce{constructor(e){Object.defineProperty(this,ne,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,ne)[ne]=e.store}showError(e=null){void babelHelpers.classPrivateFieldLooseBase(this,ne)[ne].dispatch("application/setAlert",{error:e||L.Loc.getMessage("CRM_MESSAGESENDER_EDITOR_GENERIC_ERROR")})}}var de=babelHelpers.classPrivateFieldLooseKey("store");var pe=babelHelpers.classPrivateFieldLooseKey("sendChannelConnect");var he=babelHelpers.classPrivateFieldLooseKey("sendEditorInteraction");class be{constructor(e){Object.defineProperty(this,he,{value:ve});Object.defineProperty(this,pe,{value:ue});Object.defineProperty(this,de,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,de)[de]=e.store}onRender(){const e=new g.Builder.Communication.Editor.ViewEvent;e.setSection(babelHelpers.classPrivateFieldLooseBase(this,de)[de].state.analytics.analytics.c_section).setSubSection(babelHelpers.classPrivateFieldLooseBase(this,de)[de].state.analytics.analytics.c_sub_section);P.sendData(e.buildData())}onAddChannelClick(){babelHelpers.classPrivateFieldLooseBase(this,pe)[pe](g.Dictionary.ELEMENT_MENU_BUTTON)}onBannerConnectClick(e,t){babelHelpers.classPrivateFieldLooseBase(this,pe)[pe](g.Dictionary.ELEMENT_BANNER_BUTTON,e,t)}onNoChannelsButtonClick(){babelHelpers.classPrivateFieldLooseBase(this,pe)[pe](g.Dictionary.ELEMENT_NO_CONNECTION_BUTTON)}onPreviewShow(){babelHelpers.classPrivateFieldLooseBase(this,he)[he](g.Dictionary.ELEMENT_PREVIEW)}onSelectTemplate(){babelHelpers.classPrivateFieldLooseBase(this,he)[he](g.Dictionary.ELEMENT_TEMPLATE_SELECTOR)}onSuggestTemplate(){babelHelpers.classPrivateFieldLooseBase(this,he)[he](g.Dictionary.ELEMENT_TEMPLATE_OFFER)}onSelectChannel(){babelHelpers.classPrivateFieldLooseBase(this,he)[he](g.Dictionary.ELEMENT_CHANNEL_SELECTOR)}onSaveChannelsSort(){babelHelpers.classPrivateFieldLooseBase(this,he)[he](g.Dictionary.ELEMENT_CHANNEL_LIST_CHANGE)}onAddFile(){babelHelpers.classPrivateFieldLooseBase(this,he)[he](g.Dictionary.ELEMENT_ELEMENT_ADD,"file")}onAddDocument(){babelHelpers.classPrivateFieldLooseBase(this,he)[he](g.Dictionary.ELEMENT_ELEMENT_ADD,"document")}onAddSalescenterPage(){babelHelpers.classPrivateFieldLooseBase(this,he)[he](g.Dictionary.ELEMENT_ELEMENT_ADD,"salescenterPage")}onAddSalescenterPayment(){babelHelpers.classPrivateFieldLooseBase(this,he)[he](g.Dictionary.ELEMENT_ELEMENT_ADD,"salescenterPayment")}onAddSalescenterCompilation(){babelHelpers.classPrivateFieldLooseBase(this,he)[he](g.Dictionary.ELEMENT_ELEMENT_ADD,"salescenterCompilation")}onAddCrmValue(){babelHelpers.classPrivateFieldLooseBase(this,he)[he](g.Dictionary.ELEMENT_ELEMENT_ADD,"crmValue")}onAddCopilot(){const e=new g.Builder.Communication.Editor.CopilotEvent;e.setSection(babelHelpers.classPrivateFieldLooseBase(this,de)[de].state.analytics.analytics.c_section).setSubSection(babelHelpers.classPrivateFieldLooseBase(this,de)[de].state.analytics.analytics.c_sub_section);P.sendData(e.buildData())}onSend(){var e,t;const s=g.Builder.Communication.Editor.SendEvent.createDefault((e=babelHelpers.classPrivateFieldLooseBase(this,de)[de].getters["channels/current"])==null?void 0:e.id);s.setSection(babelHelpers.classPrivateFieldLooseBase(this,de)[de].state.analytics.analytics.c_section).setSubSection(babelHelpers.classPrivateFieldLooseBase(this,de)[de].state.analytics.analytics.c_sub_section);if((t=babelHelpers.classPrivateFieldLooseBase(this,de)[de].getters["channels/current"])!=null&&t.isTemplatesBased){var a;s.setTemplateId((a=babelHelpers.classPrivateFieldLooseBase(this,de)[de].getters["templates/current"])==null?void 0:a.ORIGINAL_ID)}P.sendData(s.buildData())}onCancel(){const e=new g.Builder.Communication.Editor.CancelEvent;e.setSection(babelHelpers.classPrivateFieldLooseBase(this,de)[de].state.analytics.analytics.c_section).setSubSection(babelHelpers.classPrivateFieldLooseBase(this,de)[de].state.analytics.analytics.c_sub_section);P.sendData(e.buildData())}}function ue(e,t,s){const a=new g.Builder.Communication.Channel.ConnectEvent;a.setSection(babelHelpers.classPrivateFieldLooseBase(this,de)[de].state.analytics.analytics.c_section).setSubSection(babelHelpers.classPrivateFieldLooseBase(this,de)[de].state.analytics.analytics.c_sub_section).setElement(e).setChannelId(t).setConnectStatus(s);P.sendData(a.buildData())}function ve(e,t){var s;const a=g.Builder.Communication.Editor.InteractionEvent.createDefault((s=babelHelpers.classPrivateFieldLooseBase(this,de)[de].getters["channels/current"])==null?void 0:s.id);a.setSection(babelHelpers.classPrivateFieldLooseBase(this,de)[de].state.analytics.analytics.c_section).setSubSection(babelHelpers.classPrivateFieldLooseBase(this,de)[de].state.analytics.analytics.c_sub_section).setElement(e).setAddedElement(t);P.sendData(a.buildData())}var me=babelHelpers.classPrivateFieldLooseKey("logger");var ge=babelHelpers.classPrivateFieldLooseKey("store");var Pe=babelHelpers.classPrivateFieldLooseKey("copilot");var Le=babelHelpers.classPrivateFieldLooseKey("copilotEvents");var ye=babelHelpers.classPrivateFieldLooseKey("getCopilot");var Be=babelHelpers.classPrivateFieldLooseKey("loadExtension");var Fe=babelHelpers.classPrivateFieldLooseKey("getHandlers");class fe{constructor(e){Object.defineProperty(this,Fe,{value:Ee});Object.defineProperty(this,Be,{value:He});Object.defineProperty(this,ye,{value:Se});Object.defineProperty(this,me,{writable:true,value:void 0});Object.defineProperty(this,ge,{writable:true,value:void 0});Object.defineProperty(this,Pe,{writable:true,value:null});Object.defineProperty(this,Le,{writable:true,value:null});babelHelpers.classPrivateFieldLooseBase(this,me)[me]=e.logger;babelHelpers.classPrivateFieldLooseBase(this,ge)[ge]=e.store}showCopilot(e,t,s){return new Promise(((a,i)=>{babelHelpers.classPrivateFieldLooseBase(this,ye)[ye]().then((i=>{const l=babelHelpers.classPrivateFieldLooseBase(this,Fe)[Fe]();for(const[e,t]of Object.entries(l)){l[e]=t.bind(this,i,a)}for(const[e,t]of Object.entries(l)){i.subscribeOnce(e,t)}if(L.Type.isStringFilled(t.trim())){i.setSelectedText(t.trim())}else if(L.Type.isStringFilled(s.trim())){i.setContext(s.trim())}i.show({bindElement:e})})).catch((e=>{babelHelpers.classPrivateFieldLooseBase(this,me)[me].error("CopilotService: Failed to show AI Copilot",e);i(e)}))}))}}function Se(){if(babelHelpers.classPrivateFieldLooseBase(this,Pe)[Pe]){return Promise.resolve(babelHelpers.classPrivateFieldLooseBase(this,Pe)[Pe])}return new Promise(((e,t)=>{babelHelpers.classPrivateFieldLooseBase(this,Be)[Be]().then((s=>{var a;babelHelpers.classPrivateFieldLooseBase(this,Le)[Le]=s.CopilotEvents;babelHelpers.classPrivateFieldLooseBase(this,Pe)[Pe]=new s.Copilot({moduleId:"crm",contextId:"crm.messagesender.editor",category:(a=babelHelpers.classPrivateFieldLooseBase(this,ge)[ge].state.application.contentProviders.copilot)==null?void 0:a.category,mode:s.CopilotMode.TEXT,autoHide:true,showResultInCopilot:true});babelHelpers.classPrivateFieldLooseBase(this,Pe)[Pe].subscribeOnce(babelHelpers.classPrivateFieldLooseBase(this,Le)[Le].START_INIT,(()=>{void babelHelpers.classPrivateFieldLooseBase(this,ge)[ge].dispatch("application/setProgress",{isLoading:true})}));babelHelpers.classPrivateFieldLooseBase(this,Pe)[Pe].subscribeOnce(babelHelpers.classPrivateFieldLooseBase(this,Le)[Le].FINISH_INIT,(()=>{void babelHelpers.classPrivateFieldLooseBase(this,ge)[ge].dispatch("application/setProgress",{isLoading:false});e(babelHelpers.classPrivateFieldLooseBase(this,Pe)[Pe])}));babelHelpers.classPrivateFieldLooseBase(this,Pe)[Pe].subscribeOnce(babelHelpers.classPrivateFieldLooseBase(this,Le)[Le].FAILED_INIT,(()=>{void babelHelpers.classPrivateFieldLooseBase(this,ge)[ge].dispatch("application/setProgress",{isLoading:false});t(babelHelpers.classPrivateFieldLooseBase(this,Pe)[Pe])}));babelHelpers.classPrivateFieldLooseBase(this,Pe)[Pe].init()})).catch((e=>{babelHelpers.classPrivateFieldLooseBase(this,me)[me].error("CopilotService: Failed to initialize AI Copilot",e);t(e)}))}))}function He(){return L.Runtime.loadExtension("ai.copilot").catch((e=>{babelHelpers.classPrivateFieldLooseBase(this,me)[me].error("CopilotService: Failed to load AI Copilot extension",e);throw e}))}function Ee(){const e={[babelHelpers.classPrivateFieldLooseBase(this,Le)[Le].TEXT_SAVE]:(e,s,a)=>{const{result:i}=a.getData();t(e);s({textReplace:i});e.hide()},[babelHelpers.classPrivateFieldLooseBase(this,Le)[Le].TEXT_PLACE_BELOW]:(e,s,a)=>{const{result:i}=a.getData();t(e);s({textBelow:i});e.hide()},[babelHelpers.classPrivateFieldLooseBase(this,Le)[Le].HIDE]:(e,s)=>{t(e);s({})}};const t=t=>{for(const[s,a]of Object.entries(e)){t.unsubscribe(s,a)}};return e}var Te=babelHelpers.classPrivateFieldLooseKey("logger");var Ce=babelHelpers.classPrivateFieldLooseKey("store");var Ie=babelHelpers.classPrivateFieldLooseKey("menu");var we=babelHelpers.classPrivateFieldLooseKey("getMenu");var _e=babelHelpers.classPrivateFieldLooseKey("getPublicUrl");var Oe=babelHelpers.classPrivateFieldLooseKey("isDocument");var De=babelHelpers.classPrivateFieldLooseKey("isTemplate");var xe=babelHelpers.classPrivateFieldLooseKey("loadExtension");class Ae{constructor(e){Object.defineProperty(this,xe,{value:$e});Object.defineProperty(this,De,{value:je});Object.defineProperty(this,Oe,{value:Ne});Object.defineProperty(this,_e,{value:Re});Object.defineProperty(this,we,{value:Me});Object.defineProperty(this,Te,{writable:true,value:void 0});Object.defineProperty(this,Ce,{writable:true,value:void 0});Object.defineProperty(this,Ie,{writable:true,value:null});babelHelpers.classPrivateFieldLooseBase(this,Te)[Te]=e.logger;babelHelpers.classPrivateFieldLooseBase(this,Ce)[Ce]=e.store}async selectOrCreateDocument(e){void babelHelpers.classPrivateFieldLooseBase(this,Ce)[Ce].dispatch("application/setProgress",{isLoading:true});try{const t=await babelHelpers.classPrivateFieldLooseBase(this,we)[we]();const s=await t.show(e);if(await babelHelpers.classPrivateFieldLooseBase(this,Oe)[Oe](s)){return{title:s.getTitle(),publicUrl:await babelHelpers.classPrivateFieldLooseBase(this,_e)[_e](s)}}if(await babelHelpers.classPrivateFieldLooseBase(this,De)[De](s)){let e=null;try{e=await t.createDocument(s)}catch(e){babelHelpers.classPrivateFieldLooseBase(this,Te)[Te].error("Failed to create document from template",{template:s,error:e});throw e}if(L.Type.isNil(e)){return null}return{title:e.getTitle(),publicUrl:await babelHelpers.classPrivateFieldLooseBase(this,_e)[_e](e)}}return null}finally{void babelHelpers.classPrivateFieldLooseBase(this,Ce)[Ce].dispatch("application/setProgress",{isLoading:false})}}}async function Me(){if(babelHelpers.classPrivateFieldLooseBase(this,Ie)[Ie]){return babelHelpers.classPrivateFieldLooseBase(this,Ie)[Ie]}const e=await babelHelpers.classPrivateFieldLooseBase(this,xe)[xe]();babelHelpers.classPrivateFieldLooseBase(this,Ie)[Ie]=new e.Selector.Menu({moduleId:"crm",provider:babelHelpers.classPrivateFieldLooseBase(this,Ce)[Ce].state.application.contentProviders.documents.provider,value:babelHelpers.classPrivateFieldLooseBase(this,Ce)[Ce].state.application.context.entityId,analyticsLabelPrefix:"crmTimelineSmsEditor"});return babelHelpers.classPrivateFieldLooseBase(this,Ie)[Ie]}function Re(e){return babelHelpers.classPrivateFieldLooseBase(this,we)[we]().then((t=>t.getDocumentPublicUrl(e))).catch((t=>{babelHelpers.classPrivateFieldLooseBase(this,Te)[Te].error("Failed to get document public URL",{document:e,error:t});throw t}))}async function Ne(e){const t=await babelHelpers.classPrivateFieldLooseBase(this,xe)[xe]();return e instanceof t.Selector.Document}async function je(e){const t=await babelHelpers.classPrivateFieldLooseBase(this,xe)[xe]();return e instanceof t.Selector.Template}function $e(){return L.Runtime.loadExtension("documentgenerator.selector").catch((e=>{babelHelpers.classPrivateFieldLooseBase(this,Te)[Te].error("Failed to load documentgenerator.selector",e);throw e}))}var Ke=babelHelpers.classPrivateFieldLooseKey("logger");var ke=babelHelpers.classPrivateFieldLooseKey("store");var Ge=babelHelpers.classPrivateFieldLooseKey("uploader");var Ve=babelHelpers.classPrivateFieldLooseKey("browseElement");var Ue=babelHelpers.classPrivateFieldLooseKey("fileWatcher");var Xe=babelHelpers.classPrivateFieldLooseKey("openFileBrowser");var ze=babelHelpers.classPrivateFieldLooseKey("openDiskFileDialog");var We=babelHelpers.classPrivateFieldLooseKey("getUploader");var qe=babelHelpers.classPrivateFieldLooseKey("isUploaderBusy");var Ye=babelHelpers.classPrivateFieldLooseKey("getExternalLink");class Je{constructor(e){Object.defineProperty(this,Ye,{value:st});Object.defineProperty(this,qe,{value:tt});Object.defineProperty(this,We,{value:et});Object.defineProperty(this,ze,{value:Ze});Object.defineProperty(this,Xe,{value:Qe});Object.defineProperty(this,Ke,{writable:true,value:void 0});Object.defineProperty(this,ke,{writable:true,value:void 0});Object.defineProperty(this,Ge,{writable:true,value:null});Object.defineProperty(this,Ve,{writable:true,value:null});Object.defineProperty(this,Ue,{writable:true,value:null});babelHelpers.classPrivateFieldLooseBase(this,Ke)[Ke]=e.logger;babelHelpers.classPrivateFieldLooseBase(this,ke)[ke]=e.store}uploadNewFile(e){if(babelHelpers.classPrivateFieldLooseBase(this,ke)[ke].getters["application/isProgress"]){babelHelpers.classPrivateFieldLooseBase(this,Ke)[Ke].warn("Cannot upload file while in progress");return}babelHelpers.classPrivateFieldLooseBase(this,Ue)[Ue]=e;void babelHelpers.classPrivateFieldLooseBase(this,Xe)[Xe]()}pickFromDisk(e){if(babelHelpers.classPrivateFieldLooseBase(this,ke)[ke].getters["application/isProgress"]){babelHelpers.classPrivateFieldLooseBase(this,Ke)[Ke].warn("Cannot pick file from disk while in progress");return}babelHelpers.classPrivateFieldLooseBase(this,Ue)[Ue]=e;void babelHelpers.classPrivateFieldLooseBase(this,ze)[ze]()}}async function Qe(){if(babelHelpers.classPrivateFieldLooseBase(this,Ve)[Ve]){babelHelpers.classPrivateFieldLooseBase(this,Ve)[Ve].click();return}const e=await babelHelpers.classPrivateFieldLooseBase(this,We)[We]();babelHelpers.classPrivateFieldLooseBase(this,Ve)[Ve]=document.createElement("div");e.assignBrowse(babelHelpers.classPrivateFieldLooseBase(this,Ve)[Ve]);babelHelpers.classPrivateFieldLooseBase(this,Ve)[Ve].click()}async function Ze(){const e=await babelHelpers.classPrivateFieldLooseBase(this,We)[We]();const{openDiskFileDialog:t}=await L.Runtime.loadExtension("disk.uploader.user-field-widget");t({dialogId:"crm-messagesender-editor",uploader:e})}function et(){if(babelHelpers.classPrivateFieldLooseBase(this,Ge)[Ge]){return Promise.resolve(babelHelpers.classPrivateFieldLooseBase(this,Ge)[Ge])}return L.Runtime.loadExtension("ui.uploader.core").then((e=>{let t=0;babelHelpers.classPrivateFieldLooseBase(this,Ge)[Ge]=new e.Uploader({controller:"disk.uf.integration.diskUploaderController",multiple:true,events:{[e.UploaderEvent.FILE_ADD_START]:()=>{void babelHelpers.classPrivateFieldLooseBase(this,ke)[ke].dispatch("application/setProgress",{isLoading:true})},[e.UploaderEvent.FILE_ERROR]:e=>{babelHelpers.classPrivateFieldLooseBase(this,Ke)[Ke].error("Failed to upload file",e.getData());if(t<=0&&!babelHelpers.classPrivateFieldLooseBase(this,qe)[qe](babelHelpers.classPrivateFieldLooseBase(this,Ge)[Ge])){void babelHelpers.classPrivateFieldLooseBase(this,ke)[ke].dispatch("application/setProgress",{isLoading:false})}},[e.UploaderEvent.FILE_COMPLETE]:e=>{const s=e.getData().file;t++;void babelHelpers.classPrivateFieldLooseBase(this,Ye)[Ye](s.getCustomData("fileId")).then((e=>{var t,a;(t=(a=babelHelpers.classPrivateFieldLooseBase(this,Ue))[Ue])==null?void 0:t.call(a,{name:s.getName(),externalLink:e})})).finally((()=>{t--;if(t<=0&&!babelHelpers.classPrivateFieldLooseBase(this,qe)[qe](babelHelpers.classPrivateFieldLooseBase(this,Ge)[Ge])){void babelHelpers.classPrivateFieldLooseBase(this,ke)[ke].dispatch("application/setProgress",{isLoading:false})}}))}}});return babelHelpers.classPrivateFieldLooseBase(this,Ge)[Ge]})).catch((e=>{babelHelpers.classPrivateFieldLooseBase(this,Ke)[Ke].error("Failed to load ui.uploader.core",e);throw e}))}function tt(e){if(!L.Type.isFunction(e.getUploadingFileCount)){return false}if(e.getUploadingFileCount()>0){return true}if(e.getPendingFileCount()>0){return true}return e.getFiles().some((e=>e.isLoading()))}function st(e){return new Promise(((t,s)=>{L.ajax.runAction("disk.file.generateExternalLink",{analyticsLabel:"crmTimelineSmsEditorGetFilePublicUrl",data:{fileId:e}}).then((e=>{var a,i;if(L.Type.isStringFilled(e==null?void 0:(a=e.data)==null?void 0:(i=a.externalLink)==null?void 0:i.link)){t(e.data.externalLink.link)}else{s(new Error("No external link in response"))}})).catch((e=>{babelHelpers.classPrivateFieldLooseBase(this,Ke)[Ke].error("Failed to get external link",e);s(e)}))}))}var at=babelHelpers.classPrivateFieldLooseKey("prefix");var it=babelHelpers.classPrivateFieldLooseKey("prepareArgs");class lt{constructor(e={}){Object.defineProperty(this,it,{value:rt});Object.defineProperty(this,at,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,at)[at]=e.prefix||""}error(...e){babelHelpers.classPrivateFieldLooseBase(this,it)[it](e);console.error(...e)}warn(...e){babelHelpers.classPrivateFieldLooseBase(this,it)[it](e);console.warn(...e)}}function rt(e){const[t]=e;if(L.Type.isString(t)){e[0]=`${babelHelpers.classPrivateFieldLooseBase(this,at)[at]}${t}`}else{e.unshift(babelHelpers.classPrivateFieldLooseBase(this,at)[at])}}const ot=new lt({prefix:"crm.messagesender.editor: "});const nt="crm";const ct="crm.messagesender.editor";var dt=babelHelpers.classPrivateFieldLooseKey("store");var pt=babelHelpers.classPrivateFieldLooseKey("savePreferences");class ht{constructor(e){Object.defineProperty(this,pt,{value:bt});Object.defineProperty(this,dt,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,dt)[dt]=e.store}saveChannelsSort(e){void babelHelpers.classPrivateFieldLooseBase(this,dt)[dt].dispatch("preferences/setChannelsSort",{channelsSort:e});babelHelpers.classPrivateFieldLooseBase(this,pt)[pt]()}}function bt(){const e=babelHelpers.classPrivateFieldLooseBase(this,dt)[dt].state.application.scene;BX.userOptions.save(nt,ct,e.id,JSON.stringify(babelHelpers.classPrivateFieldLooseBase(this,dt)[dt].state.preferences))}var ut=babelHelpers.classPrivateFieldLooseKey("logger");var vt=babelHelpers.classPrivateFieldLooseKey("store");class mt{constructor(e){Object.defineProperty(this,ut,{writable:true,value:void 0});Object.defineProperty(this,vt,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,ut)[ut]=e.logger;babelHelpers.classPrivateFieldLooseBase(this,vt)[vt]=e.store}showSalescenterDisabledSlider(){L.Runtime.loadExtension("salescenter.tool-availability-manager").then((({ToolAvailabilityManager:e})=>{e.openSalescenterToolDisabledSlider()})).catch((e=>{babelHelpers.classPrivateFieldLooseBase(this,ut)[ut].error("Failed to load salescenter.tool-availability-manager",e)}))}openApplication(){return L.Runtime.loadExtension("salescenter.manager").then((({Manager:e})=>e.openApplication({disableSendButton:babelHelpers.classPrivateFieldLooseBase(this,vt)[vt].getters["channels/canSendMessage"]?"":"y",context:"sms",ownerTypeId:babelHelpers.classPrivateFieldLooseBase(this,vt)[vt].state.application.context.entityTypeId,ownerId:babelHelpers.classPrivateFieldLooseBase(this,vt)[vt].state.application.context.entityId,mode:babelHelpers.classPrivateFieldLooseBase(this,vt)[vt].state.application.contentProviders.salescenter.mode,st:{tool:"crm",category:"payments",event:"payment_create_click",c_section:"crm_sms",c_sub_section:"web",type:"delivery_payment"}}))).then((e=>{var t;if(e.get("action")==="sendPage"&&L.Type.isStringFilled((t=e.get("page"))==null?void 0:t.url)){return{page:{name:String(e.get("page").name),url:String(e.get("page").url)}}}if(e.get("action")==="sendPayment"&&L.Type.isObject(e.get("order"))){const t=e.get("order");return{source:"order",payment:{name:String(t.title),paymentId:L.Type.isNil(t.paymentId)?null:L.Text.toInteger(t.paymentId),shipmentId:L.Type.isNil(t.shipmentId)?null:L.Text.toInteger(t.shipmentId)}}}if(e.get("action")==="sendCompilation"&&L.Type.isObject(e.get("compilation"))){const t=e.get("compilation");let s=null;if(L.Type.isArray(t.productIds)){s=t.productIds.map((e=>L.Text.toInteger(e)))}return{source:"deal",compilation:{name:String(t.title),productIds:s}}}return{}})).catch((e=>{babelHelpers.classPrivateFieldLooseBase(this,ut)[ut].error("Failed to open salescenter application",e);throw e}))}}var gt=babelHelpers.classPrivateFieldLooseKey("logger");var Pt=babelHelpers.classPrivateFieldLooseKey("store");var Lt=babelHelpers.classPrivateFieldLooseKey("messageModel");var yt=babelHelpers.classPrivateFieldLooseKey("emitter");var Bt=babelHelpers.classPrivateFieldLooseKey("analyticsService");var Ft=babelHelpers.classPrivateFieldLooseKey("prepareParams");var ft=babelHelpers.classPrivateFieldLooseKey("prepareNotificationParams");var St=babelHelpers.classPrivateFieldLooseKey("prepareTemplateParams");var Ht=babelHelpers.classPrivateFieldLooseKey("prepareCustomTextParams");var Et=babelHelpers.classPrivateFieldLooseKey("prepareCommonParams");class Tt{constructor(e){Object.defineProperty(this,Et,{value:Ot});Object.defineProperty(this,Ht,{value:_t});Object.defineProperty(this,St,{value:wt});Object.defineProperty(this,ft,{value:It});Object.defineProperty(this,Ft,{value:Ct});Object.defineProperty(this,gt,{writable:true,value:void 0});Object.defineProperty(this,Pt,{writable:true,value:void 0});Object.defineProperty(this,Lt,{writable:true,value:void 0});Object.defineProperty(this,yt,{writable:true,value:void 0});Object.defineProperty(this,Bt,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,gt)[gt]=e.logger;babelHelpers.classPrivateFieldLooseBase(this,Pt)[Pt]=e.store;babelHelpers.classPrivateFieldLooseBase(this,Lt)[Lt]=e.messageModel;babelHelpers.classPrivateFieldLooseBase(this,yt)[yt]=e.eventEmitter;babelHelpers.classPrivateFieldLooseBase(this,Bt)[Bt]=e.analyticsService}sendMessage(){if(babelHelpers.classPrivateFieldLooseBase(this,Pt)[Pt].getters["application/isProgress"]){babelHelpers.classPrivateFieldLooseBase(this,gt)[gt].warn("sendMessage: already in progress");return Promise.resolve()}void babelHelpers.classPrivateFieldLooseBase(this,Pt)[Pt].dispatch("application/setProgress",{isSending:true});const e=babelHelpers.classPrivateFieldLooseBase(this,Pt)[Pt].getters["channels/current"];const t=babelHelpers.classPrivateFieldLooseBase(this,Pt)[Pt].getters["channels/from"];const s=babelHelpers.classPrivateFieldLooseBase(this,Pt)[Pt].getters["channels/receiver"];const a=babelHelpers.classPrivateFieldLooseBase(this,Ft)[Ft](e,t,s);return new Promise(((e,t)=>{L.ajax.runAction("crm.activity.sms.send",{data:{ownerTypeId:babelHelpers.classPrivateFieldLooseBase(this,Pt)[Pt].state.application.context.entityTypeId,ownerId:babelHelpers.classPrivateFieldLooseBase(this,Pt)[Pt].state.application.context.entityId,params:a}}).then(e).catch(t)})).then((()=>{babelHelpers.classPrivateFieldLooseBase(this,Bt)[Bt].onSend();babelHelpers.classPrivateFieldLooseBase(this,Lt)[Lt].clearState();void babelHelpers.classPrivateFieldLooseBase(this,Pt)[Pt].dispatch("application/resetAlert");babelHelpers.classPrivateFieldLooseBase(this,yt)[yt].emit("crm:messagesender:editor:onSendSuccess")})).catch((e=>{babelHelpers.classPrivateFieldLooseBase(this,gt)[gt].error("sendMessage: error",{response:e});throw e})).finally((()=>{void babelHelpers.classPrivateFieldLooseBase(this,Pt)[Pt].dispatch("application/setProgress",{isSending:false})}))}}function Ct(e,t,s){if(e.backend.senderCode==="bitrix24"){return babelHelpers.classPrivateFieldLooseBase(this,ft)[ft](e,t,s)}if(e.isTemplatesBased){return babelHelpers.classPrivateFieldLooseBase(this,St)[St](e,t,s)}return babelHelpers.classPrivateFieldLooseBase(this,Ht)[Ht](e,t,s)}function It(e,t,s){return{...babelHelpers.classPrivateFieldLooseBase(this,Et)[Et](e,t,s),signedTemplate:babelHelpers.classPrivateFieldLooseBase(this,Pt)[Pt].state.application.notificationTemplate.signed}}function wt(e,t,s){const a=babelHelpers.classPrivateFieldLooseBase(this,Pt)[Pt].getters["templates/current"];return{...babelHelpers.classPrivateFieldLooseBase(this,Et)[Et](e,t,s),body:babelHelpers.classPrivateFieldLooseBase(this,Pt)[Pt].getters["message/body"],template:a.ID,templateOriginalId:a.ORIGINAL_ID,isTemplateWithPlaceholders:L.Type.isPlainObject(a.PLACEHOLDERS),isReplacePlaceholders:true,isPlaceholdersInDisplayFormat:false}}function _t(e,t,s){return{...babelHelpers.classPrivateFieldLooseBase(this,Et)[Et](e,t,s),body:babelHelpers.classPrivateFieldLooseBase(this,Pt)[Pt].getters["message/body"],paymentId:babelHelpers.classPrivateFieldLooseBase(this,Pt)[Pt].state.message.paymentId,shipmentId:babelHelpers.classPrivateFieldLooseBase(this,Pt)[Pt].state.message.shipmentId,source:babelHelpers.classPrivateFieldLooseBase(this,Pt)[Pt].state.message.source,compilationProductIds:babelHelpers.classPrivateFieldLooseBase(this,Pt)[Pt].state.message.compilationProductIds,isReplacePlaceholders:true,isPlaceholdersInDisplayFormat:true}}function Ot(e,t,s){return{senderId:e.backend.id,from:t.id,to:s.address.value,entityTypeId:s.addressSource.entityTypeId,entityId:s.addressSource.entityId}}var Dt=babelHelpers.classPrivateFieldLooseKey("sessionCache");var xt=babelHelpers.classPrivateFieldLooseKey("logger");var At=babelHelpers.classPrivateFieldLooseKey("store");var Mt=babelHelpers.classPrivateFieldLooseKey("doOnce");var Rt=babelHelpers.classPrivateFieldLooseKey("getCurrentChannel");var Nt=babelHelpers.classPrivateFieldLooseKey("getCurrentTemplate");var jt=babelHelpers.classPrivateFieldLooseKey("getContext");var $t=babelHelpers.classPrivateFieldLooseKey("cacheTemplates");class Kt{constructor(e){Object.defineProperty(this,$t,{value:Xt});Object.defineProperty(this,jt,{value:Ut});Object.defineProperty(this,Nt,{value:Vt});Object.defineProperty(this,Rt,{value:Gt});Object.defineProperty(this,Mt,{value:kt});Object.defineProperty(this,Dt,{writable:true,value:new L.Cache.MemoryCache});Object.defineProperty(this,xt,{writable:true,value:void 0});Object.defineProperty(this,At,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,xt)[xt]=e.logger;babelHelpers.classPrivateFieldLooseBase(this,At)[At]=e.store}loadTemplates(){babelHelpers.classPrivateFieldLooseBase(this,Mt)[Mt]((()=>{const e=babelHelpers.classPrivateFieldLooseBase(this,Rt)[Rt]();if(!e||!e.isTemplatesBased||!e.backend.senderCode==="sms_provider"){return}L.ajax.runAction("crm.activity.sms.getTemplates",{data:{senderId:e.backend.id,context:{entityTypeId:babelHelpers.classPrivateFieldLooseBase(this,jt)[jt]().entityTypeId,entityId:babelHelpers.classPrivateFieldLooseBase(this,jt)[jt]().entityId,entityCategoryId:babelHelpers.classPrivateFieldLooseBase(this,jt)[jt]().categoryId}}}).then((e=>{babelHelpers.classPrivateFieldLooseBase(this,$t)[$t](e.data.templates)})).catch((e=>{babelHelpers.classPrivateFieldLooseBase(this,xt)[xt].error("Error while loading templates",e);throw e}))}))}createOrUpdatePlaceholder(e){const t=babelHelpers.classPrivateFieldLooseBase(this,Nt)[Nt]();if(!t){return}const s=babelHelpers.classPrivateFieldLooseBase(this,jt)[jt]();if(L.Type.isNil(s.entityTypeId)){return}const{id:a,value:i,entityType:l,text:r}=e;L.ajax.runAction("crm.activity.smsplaceholder.createOrUpdatePlaceholder",{data:{placeholderId:a,fieldName:L.Type.isStringFilled(i)?i:null,entityType:L.Type.isStringFilled(l)?l:null,fieldValue:L.Type.isStringFilled(r)?r:null,templateId:t.ORIGINAL_ID,entityTypeId:s.entityTypeId,entityCategoryId:s.categoryId}}).catch((e=>{babelHelpers.classPrivateFieldLooseBase(this,xt)[xt].warn("Error while remembering placeholder",e)}))}}function kt(e){babelHelpers.classPrivateFieldLooseBase(this,Dt)[Dt].remember(babelHelpers.classPrivateFieldLooseBase(this,At)[At].getters["templates/cacheContextId"],e)}function Gt(){return babelHelpers.classPrivateFieldLooseBase(this,At)[At].getters["channels/current"]}function Vt(){return babelHelpers.classPrivateFieldLooseBase(this,At)[At].getters["templates/current"]}function Ut(){return babelHelpers.classPrivateFieldLooseBase(this,At)[At].state.application.context}function Xt(e){void babelHelpers.classPrivateFieldLooseBase(this,At)[At].dispatch("templates/addTemplates",{templates:e})}var zt=babelHelpers.classPrivateFieldLooseKey("services");var Wt=babelHelpers.classPrivateFieldLooseKey("store");var qt=babelHelpers.classPrivateFieldLooseKey("messageModel");var Yt=babelHelpers.classPrivateFieldLooseKey("emitter");class Jt{constructor(){Object.defineProperty(this,zt,{writable:true,value:new L.Cache.MemoryCache});Object.defineProperty(this,Wt,{writable:true,value:null});Object.defineProperty(this,qt,{writable:true,value:null});Object.defineProperty(this,Yt,{writable:true,value:null})}setStore(e){babelHelpers.classPrivateFieldLooseBase(this,Wt)[Wt]=e;return this}setMessageModel(e){babelHelpers.classPrivateFieldLooseBase(this,qt)[qt]=e;return this}getMessageModel(){return babelHelpers.classPrivateFieldLooseBase(this,qt)[qt]}setEventEmitter(e){babelHelpers.classPrivateFieldLooseBase(this,Yt)[Yt]=e;return this}getLogger(){return ot}getSendService(){return babelHelpers.classPrivateFieldLooseBase(this,zt)[zt].remember("sendService",(()=>new Tt({logger:this.getLogger(),store:babelHelpers.classPrivateFieldLooseBase(this,Wt)[Wt],messageModel:this.getMessageModel(),eventEmitter:babelHelpers.classPrivateFieldLooseBase(this,Yt)[Yt],analyticsService:this.getAnalyticsService()})))}getAlertService(){return babelHelpers.classPrivateFieldLooseBase(this,zt)[zt].remember("alertService",(()=>new ce({store:babelHelpers.classPrivateFieldLooseBase(this,Wt)[Wt]})))}getFileService(){return babelHelpers.classPrivateFieldLooseBase(this,zt)[zt].remember("fileService",(()=>new Je({logger:this.getLogger(),store:babelHelpers.classPrivateFieldLooseBase(this,Wt)[Wt]})))}getSalescenterService(){return babelHelpers.classPrivateFieldLooseBase(this,zt)[zt].remember("salescenterService",(()=>new mt({logger:this.getLogger(),store:babelHelpers.classPrivateFieldLooseBase(this,Wt)[Wt]})))}getDocumentService(){return babelHelpers.classPrivateFieldLooseBase(this,zt)[zt].remember("documentService",(()=>new Ae({logger:this.getLogger(),store:babelHelpers.classPrivateFieldLooseBase(this,Wt)[Wt]})))}getCopilotService(){return babelHelpers.classPrivateFieldLooseBase(this,zt)[zt].remember("copilotService",(()=>new fe({logger:this.getLogger(),store:babelHelpers.classPrivateFieldLooseBase(this,Wt)[Wt]})))}getTemplateService(){return babelHelpers.classPrivateFieldLooseBase(this,zt)[zt].remember("templateService",(()=>new Kt({logger:this.getLogger(),store:babelHelpers.classPrivateFieldLooseBase(this,Wt)[Wt]})))}getPreferencesService(){return babelHelpers.classPrivateFieldLooseBase(this,zt)[zt].remember("preferencesService",(()=>new ht({store:babelHelpers.classPrivateFieldLooseBase(this,Wt)[Wt]})))}getAnalyticsService(){return babelHelpers.classPrivateFieldLooseBase(this,zt)[zt].remember("analyticsService",(()=>new be({store:babelHelpers.classPrivateFieldLooseBase(this,Wt)[Wt]})))}}var Qt=babelHelpers.classPrivateFieldLooseKey("store");var Zt=babelHelpers.classPrivateFieldLooseKey("emitter");var es=babelHelpers.classPrivateFieldLooseKey("unwatches");var ts=babelHelpers.classPrivateFieldLooseKey("emitStateChangeDebounced");var ss=babelHelpers.classPrivateFieldLooseKey("bindEvents");var as=babelHelpers.classPrivateFieldLooseKey("watchChannel");var is=babelHelpers.classPrivateFieldLooseKey("watchFrom");var ls=babelHelpers.classPrivateFieldLooseKey("watchReceiver");var rs=babelHelpers.classPrivateFieldLooseKey("watchMessageBody");var os=babelHelpers.classPrivateFieldLooseKey("watchTemplate");var ns=babelHelpers.classPrivateFieldLooseKey("emitOnStateChange");var cs=babelHelpers.classPrivateFieldLooseKey("emit");class ds{constructor({store:e,eventEmitter:t}){Object.defineProperty(this,cs,{value:Ps});Object.defineProperty(this,ns,{value:gs});Object.defineProperty(this,os,{value:ms});Object.defineProperty(this,rs,{value:vs});Object.defineProperty(this,ls,{value:us});Object.defineProperty(this,is,{value:bs});Object.defineProperty(this,as,{value:hs});Object.defineProperty(this,ss,{value:ps});Object.defineProperty(this,Qt,{writable:true,value:void 0});Object.defineProperty(this,Zt,{writable:true,value:void 0});Object.defineProperty(this,es,{writable:true,value:[]});Object.defineProperty(this,ts,{writable:true,value:null});babelHelpers.classPrivateFieldLooseBase(this,Qt)[Qt]=e;babelHelpers.classPrivateFieldLooseBase(this,Zt)[Zt]=t;babelHelpers.classPrivateFieldLooseBase(this,ss)[ss]()}destroy(){babelHelpers.classPrivateFieldLooseBase(this,es)[es].forEach((e=>e()));babelHelpers.classPrivateFieldLooseBase(this,es)[es]=null;babelHelpers.classPrivateFieldLooseBase(this,Zt)[Zt]=null;L.Runtime.destroy(this)}getState(){const e={channel:babelHelpers.classPrivateFieldLooseBase(this,Qt)[Qt].getters["channels/current"],from:babelHelpers.classPrivateFieldLooseBase(this,Qt)[Qt].getters["channels/from"],to:babelHelpers.classPrivateFieldLooseBase(this,Qt)[Qt].getters["channels/receiver"],message:{body:babelHelpers.classPrivateFieldLooseBase(this,Qt)[Qt].getters["message/body"]}};const t=babelHelpers.classPrivateFieldLooseBase(this,Qt)[Qt].getters["channels/current"];if((t==null?void 0:t.backend.senderCode)==="bitrix24"){e.notificationTemplate=babelHelpers.classPrivateFieldLooseBase(this,Qt)[Qt].state.application.notificationTemplate}else if(t!=null&&t.isTemplatesBased){e.template=L.Runtime.clone(babelHelpers.classPrivateFieldLooseBase(this,Qt)[Qt].getters["templates/current"])}return e}}function ps(){babelHelpers.classPrivateFieldLooseBase(this,as)[as]();babelHelpers.classPrivateFieldLooseBase(this,is)[is]();babelHelpers.classPrivateFieldLooseBase(this,ls)[ls]();babelHelpers.classPrivateFieldLooseBase(this,rs)[rs]();babelHelpers.classPrivateFieldLooseBase(this,os)[os]()}function hs(){babelHelpers.classPrivateFieldLooseBase(this,es)[es].push(babelHelpers.classPrivateFieldLooseBase(this,Qt)[Qt].watch(((e,t)=>t["channels/current"]),((e,t)=>{if((e==null?void 0:e.id)!==(t==null?void 0:t.id)){babelHelpers.classPrivateFieldLooseBase(this,ns)[ns]();babelHelpers.classPrivateFieldLooseBase(this,cs)[cs]("onChannelChange",{channel:e,oldChannel:t})}})))}function bs(){babelHelpers.classPrivateFieldLooseBase(this,es)[es].push(babelHelpers.classPrivateFieldLooseBase(this,Qt)[Qt].watch(((e,t)=>t["channels/from"]),((e,t)=>{if((e==null?void 0:e.id)!==(t==null?void 0:t.id)){babelHelpers.classPrivateFieldLooseBase(this,ns)[ns]();babelHelpers.classPrivateFieldLooseBase(this,cs)[cs]("onFromChange",{from:e,oldFrom:t})}})))}function us(){const e=(e,t)=>{babelHelpers.classPrivateFieldLooseBase(this,ns)[ns]();babelHelpers.classPrivateFieldLooseBase(this,cs)[cs]("onToChange",{to:e,oldTo:t})};babelHelpers.classPrivateFieldLooseBase(this,es)[es].push(babelHelpers.classPrivateFieldLooseBase(this,Qt)[Qt].watch(((e,t)=>t["channels/receiver"]),((t,s)=>{if(!t&&s){e(t,s)}if(t&&!s){e(t,s)}if(t&&s&&!t.isEqualTo(s)){e(t,s)}})))}function vs(){let e=null;let t=null;const s=L.Runtime.throttle((()=>{if(e!==t){babelHelpers.classPrivateFieldLooseBase(this,ns)[ns]();babelHelpers.classPrivateFieldLooseBase(this,cs)[cs]("onMessageBodyChange",{body:e,oldBody:t})}}),200);babelHelpers.classPrivateFieldLooseBase(this,es)[es].push(babelHelpers.classPrivateFieldLooseBase(this,Qt)[Qt].watch(((e,t)=>t["message/body"]),((a,i)=>{e=a;t=i;s()})))}function ms(){babelHelpers.classPrivateFieldLooseBase(this,es)[es].push(babelHelpers.classPrivateFieldLooseBase(this,Qt)[Qt].watch(((e,t)=>t["templates/current"]),((e,t)=>{if((e==null?void 0:e.ORIGINAL_ID)!==(t==null?void 0:t.ORIGINAL_ID)){babelHelpers.classPrivateFieldLooseBase(this,ns)[ns]();babelHelpers.classPrivateFieldLooseBase(this,cs)[cs]("onTemplateChange",{template:L.Runtime.clone(e),oldTemplate:L.Runtime.clone(t)})}})))}function gs(){var e,t;(t=(e=babelHelpers.classPrivateFieldLooseBase(this,ts))[ts])!=null?t:e[ts]=L.Runtime.debounce((()=>{babelHelpers.classPrivateFieldLooseBase(this,cs)[cs]("onStateChange")}),25);babelHelpers.classPrivateFieldLooseBase(this,ts)[ts]()}function Ps(e,t={}){babelHelpers.classPrivateFieldLooseBase(this,Zt)[Zt].emit(e,t)}const Ls=200;var ys=babelHelpers.classPrivateFieldLooseKey("options");var Bs=babelHelpers.classPrivateFieldLooseKey("skeleton");var Fs=babelHelpers.classPrivateFieldLooseKey("locator");var fs=babelHelpers.classPrivateFieldLooseKey("store");var Ss=babelHelpers.classPrivateFieldLooseKey("app");var Hs=babelHelpers.classPrivateFieldLooseKey("rootComponent");var Es=babelHelpers.classPrivateFieldLooseKey("stateExporter");var Ts=babelHelpers.classPrivateFieldLooseKey("normalizeOptions");var Cs=babelHelpers.classPrivateFieldLooseKey("mergeOptions");var Is=babelHelpers.classPrivateFieldLooseKey("buildStore");var ws=babelHelpers.classPrivateFieldLooseKey("load");var _s=babelHelpers.classPrivateFieldLooseKey("actualizeOptions");var Os=babelHelpers.classPrivateFieldLooseKey("loadOptions");var Ds=babelHelpers.classPrivateFieldLooseKey("bindEvents");class xs extends a.EventEmitter{constructor(e){super();Object.defineProperty(this,Ds,{value:Ks});Object.defineProperty(this,Os,{value:$s});Object.defineProperty(this,_s,{value:js});Object.defineProperty(this,ws,{value:Ns});Object.defineProperty(this,Is,{value:Rs});Object.defineProperty(this,Cs,{value:Ms});Object.defineProperty(this,Ts,{value:As});Object.defineProperty(this,ys,{writable:true,value:void 0});Object.defineProperty(this,Bs,{writable:true,value:null});Object.defineProperty(this,Fs,{writable:true,value:null});Object.defineProperty(this,fs,{writable:true,value:null});Object.defineProperty(this,Ss,{writable:true,value:null});Object.defineProperty(this,Hs,{writable:true,value:null});Object.defineProperty(this,Es,{writable:true,value:null});this.setEventNamespace("BX.Crm.MessageSender.Editor");babelHelpers.classPrivateFieldLooseBase(this,ys)[ys]=e;babelHelpers.classPrivateFieldLooseBase(this,Ts)[Ts](babelHelpers.classPrivateFieldLooseBase(this,ys)[ys])}getOptions(){return babelHelpers.classPrivateFieldLooseBase(this,ys)[ys]}getState(){var e,t;return(e=(t=babelHelpers.classPrivateFieldLooseBase(this,Es)[Es])==null?void 0:t.getState())!=null?e:null}getContainer(){var e,t;return(e=(t=babelHelpers.classPrivateFieldLooseBase(this,Hs)[Hs])==null?void 0:t.$el)!=null?e:null}getContentContainer(){var e,t;return(e=(t=this.getContainer())==null?void 0:t.querySelector('[data-role="content-container"]'))!=null?e:null}setChannel(e){var t;void((t=babelHelpers.classPrivateFieldLooseBase(this,fs)[fs])==null?void 0:t.dispatch("channels/setChannel",{channelId:e}));return this}setFrom(e){var t;void((t=babelHelpers.classPrivateFieldLooseBase(this,fs)[fs])==null?void 0:t.dispatch("channels/setFrom",{fromId:e}));return this}setTo(e){var t;void((t=babelHelpers.classPrivateFieldLooseBase(this,fs)[fs])==null?void 0:t.dispatch("channels/setReceiver",{receiverAddressId:e}));return this}setMessageText(e){var t;void((t=babelHelpers.classPrivateFieldLooseBase(this,fs)[fs])==null?void 0:t.dispatch("message/setText",{text:e}));return this}setTemplate(e){var t;void((t=babelHelpers.classPrivateFieldLooseBase(this,fs)[fs])==null?void 0:t.dispatch("templates/setTemplate",{templateOriginalId:e}));return this}setFilledPlaceholder(e){var t;void((t=babelHelpers.classPrivateFieldLooseBase(this,fs)[fs])==null?void 0:t.dispatch("templates/setFilledPlaceholder",{filledPlaceholder:e}));return this}setError(e){var t;void((t=babelHelpers.classPrivateFieldLooseBase(this,fs)[fs])==null?void 0:t.dispatch("application/setAlert",{error:e}));return this}resetAlert(){var e;void((e=babelHelpers.classPrivateFieldLooseBase(this,fs)[fs])==null?void 0:e.dispatch("application/resetAlert"));return this}async render(){const e=L.Type.isElementNode(babelHelpers.classPrivateFieldLooseBase(this,ys)[ys].renderTo)?babelHelpers.classPrivateFieldLooseBase(this,ys)[ys].renderTo:document.querySelector(babelHelpers.classPrivateFieldLooseBase(this,ys)[ys].renderTo);if(L.Type.isNil(e)){throw new TypeError(`Render container "${babelHelpers.classPrivateFieldLooseBase(this,ys)[ys].renderTo}" not found`)}const t=setTimeout((()=>{var t,a;L.Dom.clean(e);(a=(t=babelHelpers.classPrivateFieldLooseBase(this,Bs))[Bs])!=null?a:t[Bs]=new s.Skeleton({layout:babelHelpers.classPrivateFieldLooseBase(this,ys)[ys].layout});babelHelpers.classPrivateFieldLooseBase(this,Bs)[Bs].renderTo(e)}),Ls);await babelHelpers.classPrivateFieldLooseBase(this,ws)[ws]();babelHelpers.classPrivateFieldLooseBase(this,Fs)[Fs]=new Jt;const a=babelHelpers.classPrivateFieldLooseBase(this,Fs)[Fs];babelHelpers.classPrivateFieldLooseBase(this,Ss)[Ss]=i.BitrixVue.createApp({name:"CrmMessageSenderEditor",components:{MessageEditor:K},beforeCreate(){this.$bitrix.Data.set("locator",a)},template:"<MessageEditor/>"});const{store:l,models:{messageModel:r}}=await babelHelpers.classPrivateFieldLooseBase(this,Is)[Is]();babelHelpers.classPrivateFieldLooseBase(this,fs)[fs]=l;babelHelpers.classPrivateFieldLooseBase(this,Fs)[Fs].setStore(l);babelHelpers.classPrivateFieldLooseBase(this,Fs)[Fs].setMessageModel(r);babelHelpers.classPrivateFieldLooseBase(this,Ss)[Ss].use(l);clearTimeout(t);L.Dom.clean(e);babelHelpers.classPrivateFieldLooseBase(this,Hs)[Hs]=babelHelpers.classPrivateFieldLooseBase(this,Ss)[Ss].mount(e);babelHelpers.classPrivateFieldLooseBase(this,Fs)[Fs].setEventEmitter(babelHelpers.classPrivateFieldLooseBase(this,Hs)[Hs].$Bitrix.eventEmitter);babelHelpers.classPrivateFieldLooseBase(this,Es)[Es]=new ds({store:l,eventEmitter:this});babelHelpers.classPrivateFieldLooseBase(this,Ds)[Ds]();babelHelpers.classPrivateFieldLooseBase(this,Fs)[Fs].getAnalyticsService().onRender()}reload(){var e;const t=new a.BaseEvent;this.emit("onBeforeReload",t);if(t.isDefaultPrevented()){return Promise.resolve()}void((e=babelHelpers.classPrivateFieldLooseBase(this,fs)[fs])==null?void 0:e.dispatch("application/setProgress",{isLoading:true}));return babelHelpers.classPrivateFieldLooseBase(this,_s)[_s]().then((()=>{var e,t,s,a;void((e=babelHelpers.classPrivateFieldLooseBase(this,fs)[fs])==null?void 0:e.dispatch("application/actualizeState",{context:babelHelpers.classPrivateFieldLooseBase(this,ys)[ys].context,contentProviders:babelHelpers.classPrivateFieldLooseBase(this,ys)[ys].contentProviders,notificationTemplate:babelHelpers.classPrivateFieldLooseBase(this,ys)[ys].notificationTemplate,promoBanners:babelHelpers.classPrivateFieldLooseBase(this,ys)[ys].promoBanners,layout:babelHelpers.classPrivateFieldLooseBase(this,ys)[ys].layout,scene:babelHelpers.classPrivateFieldLooseBase(this,ys)[ys].scene}));void((t=babelHelpers.classPrivateFieldLooseBase(this,fs)[fs])==null?void 0:t.dispatch("channels/actualizeState",{collection:babelHelpers.classPrivateFieldLooseBase(this,ys)[ys].channels}));void((s=babelHelpers.classPrivateFieldLooseBase(this,fs)[fs])==null?void 0:s.dispatch("preferences/actualizeState",{channelsSort:(a=babelHelpers.classPrivateFieldLooseBase(this,ys)[ys].preferences)==null?void 0:a.channelsSort}))})).finally((()=>{var e;void((e=babelHelpers.classPrivateFieldLooseBase(this,fs)[fs])==null?void 0:e.dispatch("application/setProgress",{isLoading:false}))}))}destroy(){var e,t;(e=babelHelpers.classPrivateFieldLooseBase(this,Ss)[Ss])==null?void 0:e.unmount();babelHelpers.classPrivateFieldLooseBase(this,Ss)[Ss]=null;babelHelpers.classPrivateFieldLooseBase(this,Hs)[Hs].$Bitrix.eventEmitter.unsubscribeAll();babelHelpers.classPrivateFieldLooseBase(this,Hs)[Hs]=null;(t=babelHelpers.classPrivateFieldLooseBase(this,Es)[Es])==null?void 0:t.destroy();babelHelpers.classPrivateFieldLooseBase(this,Es)[Es]=null;this.unsubscribeAll();babelHelpers.classPrivateFieldLooseBase(this,fs)[fs]=null;babelHelpers.classPrivateFieldLooseBase(this,Fs)[Fs]=null;L.Runtime.destroy(this)}}function As(e){if(!L.Type.isArray(e.channels)){e.channels=[]}for(const s of e.channels){if(!L.Type.isArray(s.toList)){s.toList=[]}s.toList=s.toList.map((e=>{if(L.Type.isPlainObject(e)){return t.Receiver.fromJSON(e)}return e}))}}function Ms(e,t){const s=new Set(["channels","promoBanners","dynamicLoad","contentProviders","preferences"]);const a={...t};for(const[t,i]of Object.entries(e)){if(s.has(t)){a[t]=i}}return a}async function Rs(){var e;const t=Z.create().useDatabase(false).setLogger(babelHelpers.classPrivateFieldLooseBase(this,Fs)[Fs].getLogger()).setVariables({text:babelHelpers.classPrivateFieldLooseBase(this,ys)[ys].message.text});const{store:s}=await m.Builder.init().addModel(z.create().useDatabase(false).setLogger(babelHelpers.classPrivateFieldLooseBase(this,Fs)[Fs].getLogger()).setVariables({context:babelHelpers.classPrivateFieldLooseBase(this,ys)[ys].context,contentProviders:babelHelpers.classPrivateFieldLooseBase(this,ys)[ys].contentProviders,notificationTemplate:babelHelpers.classPrivateFieldLooseBase(this,ys)[ys].notificationTemplate,promoBanners:babelHelpers.classPrivateFieldLooseBase(this,ys)[ys].promoBanners,layout:babelHelpers.classPrivateFieldLooseBase(this,ys)[ys].layout,scene:babelHelpers.classPrivateFieldLooseBase(this,ys)[ys].scene})).addModel(q.create().useDatabase(false).setLogger(babelHelpers.classPrivateFieldLooseBase(this,Fs)[Fs].getLogger()).setVariables({collection:babelHelpers.classPrivateFieldLooseBase(this,ys)[ys].channels})).addModel(t).addModel(oe.create().useDatabase(true).setLogger(babelHelpers.classPrivateFieldLooseBase(this,Fs)[Fs].getLogger())).addModel(ae.create().useDatabase(false).setLogger(babelHelpers.classPrivateFieldLooseBase(this,Fs)[Fs].getLogger()).setVariables({channelsSort:(e=babelHelpers.classPrivateFieldLooseBase(this,ys)[ys].preferences)==null?void 0:e.channelsSort})).addModel(G.create().useDatabase(false).setLogger(babelHelpers.classPrivateFieldLooseBase(this,Fs)[Fs].getLogger()).setVariables({analytics:babelHelpers.classPrivateFieldLooseBase(this,ys)[ys].analytics})).setDatabaseConfig({name:"crm-messagesender-editor",type:m.BuilderDatabaseType.indexedDb,siteId:L.Loc.getMessage("SITE_ID"),userId:L.Loc.getMessage("USER_ID")}).build();return{store:s,models:{messageModel:t}}}function Ns(){if(!babelHelpers.classPrivateFieldLooseBase(this,ys)[ys].dynamicLoad){return Promise.resolve()}return babelHelpers.classPrivateFieldLooseBase(this,_s)[_s]().then((()=>{babelHelpers.classPrivateFieldLooseBase(this,ys)[ys].dynamicLoad=false}))}function js(){return babelHelpers.classPrivateFieldLooseBase(this,Os)[Os]().then((e=>{babelHelpers.classPrivateFieldLooseBase(this,ys)[ys]=babelHelpers.classPrivateFieldLooseBase(this,Cs)[Cs](e,babelHelpers.classPrivateFieldLooseBase(this,ys)[ys])}))}function $s(){return new Promise(((e,t)=>{var s;L.ajax.runAction("crm.messagesender.editor.load",{json:{sceneId:(s=babelHelpers.classPrivateFieldLooseBase(this,ys)[ys].scene)==null?void 0:s.id,entityTypeId:babelHelpers.classPrivateFieldLooseBase(this,ys)[ys].context.entityTypeId,entityId:babelHelpers.classPrivateFieldLooseBase(this,ys)[ys].context.entityId,categoryId:babelHelpers.classPrivateFieldLooseBase(this,ys)[ys].context.categoryId}}).then((t=>{const s=t.data.editor;babelHelpers.classPrivateFieldLooseBase(this,Ts)[Ts](s);e(s)})).catch(t)}))}function Ks(){babelHelpers.classPrivateFieldLooseBase(this,Hs)[Hs].$Bitrix.eventEmitter.subscribe("crm:messagesender:editor:onConnectionsSliderClose",this.reload.bind(this));babelHelpers.classPrivateFieldLooseBase(this,Hs)[Hs].$Bitrix.eventEmitter.subscribe("crm:messagesender:editor:onPromoBannerSliderClose",this.reload.bind(this));babelHelpers.classPrivateFieldLooseBase(this,Hs)[Hs].$Bitrix.eventEmitter.subscribe("crm:messagesender:editor:onSendSuccess",(()=>{this.emit("onSendSuccess")}));babelHelpers.classPrivateFieldLooseBase(this,Hs)[Hs].$Bitrix.eventEmitter.subscribe("crm:messagesender:editor:onCancel",(()=>{this.emit("onCancel")}))}e.Editor=xs})(this.BX.Crm.MessageSender=this.BX.Crm.MessageSender||{},BX.Crm.MessageSender,BX.Crm.MessageSender.Editor.Skeleton,BX.Event,BX.Vue3,BX.Vue3.Directives,BX.UI,BX.UI.System.Typography.Vue,BX.Vue3.Components,BX.Crm.MessageSender.ChannelSelector,BX,BX,BX.UI.EntitySelector,BX.UI.IconSet,BX.UI.System.Chip.Vue,BX.Crm.Template,BX.Vue3.Vuex,BX.Crm.Integration.Analytics,BX.UI.Analytics,BX);
//# sourceMappingURL=editor.bundle.map.js