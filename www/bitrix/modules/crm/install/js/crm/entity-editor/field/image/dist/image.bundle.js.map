{"version":3,"file":"image.bundle.js","sources":["../src/image.js"],"sourcesContent":["import {EventEmitter, BaseEvent} from \"main.core.events\";\nimport {Runtime, ajax as Ajax} from \"main.core\";\n\nexport class EntityEditorImage extends BX.UI.EntityEditorImage\n{\n\tloadInput()\n\t{\n\t\tconst context = {};\n\t\tif (this._schemeElement)\n\t\t{\n\t\t\tcontext.ownerEntityTypeId = this._schemeElement.getDataIntegerParam('ownerEntityTypeId', null);\n\t\t\tcontext.ownerEntityId = this._schemeElement.getDataIntegerParam('ownerEntityId', null);\n\t\t\tcontext.ownerEntityCategoryId = this._schemeElement.getDataIntegerParam('ownerEntityCategoryId', null);\n\t\t\tcontext.permissionToken = this._schemeElement.getDataStringParam('permissionToken', null);\n\t\t}\n\t\tAjax.runAction(\n\t\t\t'crm.entity.renderImageInput',\n\t\t\t{\n\t\t\t\tdata: {\n\t\t\t\t\tentityTypeName: this._editor.getEntityTypeName(),\n\t\t\t\t\tentityId: this._editor.getEntityId(),\n\t\t\t\t\tfieldName: this.getDataKey(),\n\t\t\t\t\tfieldValue: this.getValue(),\n\t\t\t\t\tcontext,\n\t\t\t\t}\n\t\t\t}\n\t\t).then((result) => {\n\t\t\tconst assets = result.data.assets;\n\t\t\tconst assetsToLoad = [\n\t\t\t\t...assets.hasOwnProperty('css')\n\t\t\t\t\t? assets.css\n\t\t\t\t\t: [],\n\t\t\t\t...assets.hasOwnProperty('js')\n\t\t\t\t\t? assets.js\n\t\t\t\t\t: [],\n\t\t\t];\n\t\t\tBX.load(assetsToLoad, () => {\n\t\t\t\tif (assets.hasOwnProperty('string'))\n\t\t\t\t{\n\t\t\t\t\tPromise\n\t\t\t\t\t\t.all(assets.string.map((stringValue) => Runtime.html(null, stringValue)))\n\t\t\t\t\t\t.then(() => {\n\t\t\t\t\t\t\tthis.onEditorHtmlLoad(result.data.html);\n\t\t\t\t\t\t})\n\t\t\t\t\t;\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\tthis.onEditorHtmlLoad(result.data.html);\n\t\t\t\t}\n\t\t\t});\n\t\t}, (result) => {\n\t\t\tthis.onEditorHtmlLoad(result.errors[0].message);\n\t\t});\n\t}\n\tonEditorHtmlLoad(html)\n\t{\n\t\tif(this._mode === BX.UI.EntityEditorMode.edit && this._innerWrapper)\n\t\t{\n\t\t\tRuntime.html(this._innerWrapper, html);\n\n\t\t\tBX.addCustomEvent(window, \"onAfterPopupShow\", this._dialogShowHandler);\n\t\t\tBX.addCustomEvent(window, \"onPopupClose\", this._dialogCloseHandler);\n\n\t\t\tsetTimeout(() => {\n\t\t\t\tthis.bindFileEvents();\n\t\t\t}, 500);\n\t\t}\n\t}\n\n\tstatic create(id, settings)\n\t{\n\t\tconst self = new BX.Crm.EntityEditorImage();\n\t\tself.initialize(id, settings);\n\t\treturn self;\n\t}\n}\n\n// crm implementation of image field for ui version of entity editor\nEventEmitter.subscribe('BX.UI.EntityEditorControlFactory:onInitialize', (event: BaseEvent) => {\n\tconst data = event.getData();\n\tif (data[0])\n\t{\n\t\tdata[0].methods['crm_image'] = (type, controlId, settings) => {\n\t\t\tif (type === 'crm_image')\n\t\t\t{\n\t\t\t\treturn BX.Crm.EntityEditorImage.create(controlId, settings);\n\t\t\t}\n\t\t\treturn null;\n\t\t};\n\t}\n\tevent.setData(data);\n});\n"],"names":["EntityEditorImage","context","_schemeElement","ownerEntityTypeId","getDataIntegerParam","ownerEntityId","ownerEntityCategoryId","permissionToken","getDataStringParam","Ajax","runAction","data","entityTypeName","_editor","getEntityTypeName","entityId","getEntityId","fieldName","getDataKey","fieldValue","getValue","then","result","assets","assetsToLoad","hasOwnProperty","css","js","BX","load","Promise","all","string","map","stringValue","Runtime","html","onEditorHtmlLoad","errors","message","_mode","UI","EntityEditorMode","edit","_innerWrapper","addCustomEvent","window","_dialogShowHandler","_dialogCloseHandler","setTimeout","bindFileEvents","id","settings","self","Crm","initialize","EventEmitter","subscribe","event","getData","methods","type","controlId","create","setData"],"mappings":"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"}