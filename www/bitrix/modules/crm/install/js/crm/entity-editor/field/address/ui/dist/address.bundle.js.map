{"version":3,"file":"address.bundle.js","sources":["../src/address.js"],"sourcesContent":["import {EntityEditorBaseAddressField} from \"crm.entity-editor.field.address.base\";\nimport {Tag, Dom, Type} from \"main.core\";\nimport {EventEmitter} from \"main.core.events\";\n\nexport class EntityEditorUiAddressField extends BX.UI.EntityEditorField\n{\n\tconstructor()\n\t{\n\t\tsuper();\n\t\tthis._field = null;\n\t\tthis._autocompleteEnabled = false;\n\t\tthis._restrictionsCallback = null;\n\t}\n\n\tinitialize(id, settings)\n\t{\n\t\tsuper.initialize(id, settings);\n\t\tlet params = this._schemeElement.getData();\n\n\t\tthis._autocompleteEnabled = BX.prop.getBoolean(params, \"autocompleteEnabled\", false);\n\t\tif (!this._autocompleteEnabled)\n\t\t{\n\t\t\tthis._restrictionsCallback = BX.prop.getString(params, \"featureRestrictionCallback\", '');\n\t\t}\n\t\tsettings.enableAutocomplete = this._autocompleteEnabled;\n\t\tsettings.hideDefaultAddressType = true;\n\t\tsettings.addressZoneConfig = BX.prop.getObject(params, \"addressZoneConfig\", {});\n\t\tsettings.defaultAddressTypeByCategory = BX.prop.getInteger(params, \"defaultAddressTypeByCategory\", 0);\n\t\tthis._field = EntityEditorBaseAddressField.create(id, settings);\n\t\tthis._field.setMultiple(true);\n\t\tthis._field.setTypesList(BX.prop.getObject(params, \"types\", {}));\n\t\tEventEmitter.subscribe(this._field, 'onUpdate', this.onAddressListUpdate.bind(this));\n\t\tEventEmitter.subscribe(this._field, 'onStartLoadAddress', this.onStartLoadAddress.bind(this));\n\t\tEventEmitter.subscribe(this._field, 'onAddressLoaded', this.onAddressLoaded.bind(this));\n\t\tEventEmitter.subscribe(this._field, 'onError', this.onError.bind(this));\n\t\tthis._valueNode = null;\n\t\tthis._modelTypes = [];\n\n\t\tthis.initializeFromModel();\n\t}\n\n\tinitializeFromModel()\n\t{\n\t\tlet value = this.prepareValue(this.getValue());\n\t\tthis._modelTypes = Object.keys(value);\n\t\tthis._field.setValue(value);\n\t}\n\n\tprepareValue(value)\n\t{\n\t\treturn Type.isPlainObject(value) ? value : {};\n\t}\n\n\tonBeforeSubmit()\n\t{\n\n\t\tif (!Type.isDomNode(this._valueNode))\n\t\t{\n\t\t\treturn;\n\t\t}\n\t\tDom.clean(this._valueNode);\n\n\t\tlet values = {};\n\t\tfor (let type of this._modelTypes)\n\t\t{\n\t\t\tvalues[type] = \"\";\n\t\t}\n\t\tfor (let address of this._field.getValue())\n\t\t{\n\t\t\tif (address.value.length)\n\t\t\t{\n\t\t\t\tvalues[address.type] = address.value;\n\t\t\t}\n\t\t}\n\n\t\tlet fieldNamePrefix = this.getName();\n\t\tfor (let type in values)\n\t\t{\n\t\t\tif (!values.hasOwnProperty(type))\n\t\t\t{\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t\tlet value = values[type];\n\t\t\tlet name ='';\n\t\t\tif (Type.isStringFilled(value))\n\t\t\t{\n\t\t\t\tname = `${fieldNamePrefix}[${type}]`;\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tname = `${fieldNamePrefix}[${type}][DELETED]`;\n\t\t\t\tvalue = 'Y';\n\t\t\t}\n\n\t\t\tlet node = Tag.render`<input type=\"hidden\">`;\n\t\t\tnode.name = name;\n\t\t\tnode.value = value;\n\t\t\tDom.append(node, this._valueNode);\n\t\t}\n\t}\n\n\trefreshLayout(options)\n\t{\n\t\tthis.initializeFromModel();\n\t\tsuper.refreshLayout(options);\n\t}\n\n\tlayout(options)\n\t{\n\t\tif (this._hasLayout)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tthis.ensureWrapperCreated({classNames: [\"ui-entity-editor-content-block-field-address crm-entity-widget-content-block\"]});\n\t\tthis.adjustWrapper();\n\n\t\tif (!this.isNeedToDisplay())\n\t\t{\n\t\t\tthis.registerLayout(options);\n\t\t\tthis._hasLayout = true;\n\t\t\treturn;\n\t\t}\n\n\t\tif (this.isDragEnabled())\n\t\t{\n\t\t\tDom.append(this.createDragButton(), this._wrapper);\n\t\t}\n\n\t\tDom.append(this.createTitleNode(this.getTitle()), this._wrapper);\n\n\t\tlet fieldContainer = this._field.layout(this._mode === BX.UI.EntityEditorMode.edit);\n\t\tfieldContainer.classList.add('ui-entity-editor-content-block');\n\t\tthis._wrapper.appendChild(fieldContainer);\n\n\t\tthis._valueNode = Tag.render`<span></span>`;\n\t\tthis._wrapper.appendChild(this._valueNode);\n\n\t\tif (this.isContextMenuEnabled())\n\t\t{\n\t\t\tthis._wrapper.appendChild(this.createContextMenuButton());\n\t\t}\n\n\t\tif (this.isDragEnabled())\n\t\t{\n\t\t\tthis.initializeDragDropAbilities();\n\t\t}\n\n\t\tthis.registerLayout(options);\n\t\tthis._hasLayout = true;\n\t}\n\n\tcreateTitleMarker()\n\t{\n\t\tif(this._mode === BX.UI.EntityEditorMode.view)\n\t\t{\n\t\t\treturn null;\n\t\t}\n\n\t\tif (this._restrictionsCallback && this._restrictionsCallback.length)\n\t\t{\n\t\t\tlet lockIcon = Tag.render` <span class=\"tariff-lock\"></span>`;\n\t\t\tlockIcon.setAttribute('onclick', this._restrictionsCallback);\n\t\t\treturn lockIcon;\n\t\t}\n\n\t\treturn super.createTitleMarker();\n\t}\n\n\tonAddressListUpdate()\n\t{\n\t\tthis.markAsChanged();\n\t}\n\n\tonStartLoadAddress()\n\t{\n\t\tlet toolPanel = this.getEditor()._toolPanel;\n\t\tif (toolPanel)\n\t\t{\n\t\t\ttoolPanel.setLocked(true);\n\t\t}\n\t}\n\n\tonAddressLoaded()\n\t{\n\t\tlet toolPanel = this.getEditor()._toolPanel;\n\t\tif (toolPanel)\n\t\t{\n\t\t\ttoolPanel.setLocked(false);\n\t\t}\n\t}\n\n\tonError(event)\n\t{\n\t\tconst data = event.getData();\n\t\tthis.showError(data.error);\n\n\t\tconst toolPanel = this.getEditor()._toolPanel;\n\t\tif (toolPanel)\n\t\t{\n\t\t\ttoolPanel.setLocked(false);\n\t\t}\n\t}\n\n\tstatic onInitializeEditorControlFactory(event)\n\t{\n\t\tlet data = event.getData();\n\t\tif (data[0])\n\t\t{\n\t\t\tdata[0].methods[\"crm_address\"] = (type, controlId, settings) =>\n\t\t\t{\n\t\t\t\tif (type === \"crm_address\")\n\t\t\t\t{\n\t\t\t\t\treturn EntityEditorUiAddressField.create(controlId, settings);\n\t\t\t\t}\n\t\t\t\treturn null;\n\t\t\t};\n\t\t}\n\t\tevent.setData(data);\n\t}\n\n\tstatic create(id, settings)\n\t{\n\t\tlet self = new this(id, settings);\n\t\tself.initialize(id, settings);\n\t\treturn self;\n\t}\n}\n\nEventEmitter.subscribe('BX.UI.EntityEditorControlFactory:onInitialize', EntityEditorUiAddressField.onInitializeEditorControlFactory);"],"names":["EntityEditorUiAddressField","_field","_autocompleteEnabled","_restrictionsCallback","id","settings","params","_schemeElement","getData","BX","prop","getBoolean","getString","enableAutocomplete","hideDefaultAddressType","addressZoneConfig","getObject","defaultAddressTypeByCategory","getInteger","EntityEditorBaseAddressField","create","setMultiple","setTypesList","EventEmitter","subscribe","onAddressListUpdate","bind","onStartLoadAddress","onAddressLoaded","onError","_valueNode","_modelTypes","initializeFromModel","value","prepareValue","getValue","Object","keys","setValue","Type","isPlainObject","isDomNode","Dom","clean","values","type","address","length","fieldNamePrefix","getName","hasOwnProperty","name","isStringFilled","node","Tag","render","append","options","_hasLayout","ensureWrapperCreated","classNames","adjustWrapper","isNeedToDisplay","registerLayout","isDragEnabled","createDragButton","_wrapper","createTitleNode","getTitle","fieldContainer","layout","_mode","UI","EntityEditorMode","edit","classList","add","appendChild","isContextMenuEnabled","createContextMenuButton","initializeDragDropAbilities","view","lockIcon","setAttribute","markAsChanged","toolPanel","getEditor","_toolPanel","setLocked","event","data","showError","error","methods","controlId","setData","self","initialize","EntityEditorField","onInitializeEditorControlFactory"],"mappings":";;;;;;;;;AAAA,KAIaA,0BAA0B;GAAA;GAEtC,sCACA;KAAA;KAAA;KACC;KACA,MAAKC,MAAM,GAAG,IAAI;KAClB,MAAKC,oBAAoB,GAAG,KAAK;KACjC,MAAKC,qBAAqB,GAAG,IAAI;KAAC;;GAClC;KAAA;KAAA,2BAEUC,EAAE,EAAEC,QAAQ,EACvB;OACC,mHAAiBD,EAAE,EAAEC,QAAQ;OAC7B,IAAIC,MAAM,GAAG,IAAI,CAACC,cAAc,CAACC,OAAO,EAAE;OAE1C,IAAI,CAACN,oBAAoB,GAAGO,EAAE,CAACC,IAAI,CAACC,UAAU,CAACL,MAAM,EAAE,qBAAqB,EAAE,KAAK,CAAC;OACpF,IAAI,CAAC,IAAI,CAACJ,oBAAoB,EAC9B;SACC,IAAI,CAACC,qBAAqB,GAAGM,EAAE,CAACC,IAAI,CAACE,SAAS,CAACN,MAAM,EAAE,4BAA4B,EAAE,EAAE,CAAC;;OAEzFD,QAAQ,CAACQ,kBAAkB,GAAG,IAAI,CAACX,oBAAoB;OACvDG,QAAQ,CAACS,sBAAsB,GAAG,IAAI;OACtCT,QAAQ,CAACU,iBAAiB,GAAGN,EAAE,CAACC,IAAI,CAACM,SAAS,CAACV,MAAM,EAAE,mBAAmB,EAAE,EAAE,CAAC;OAC/ED,QAAQ,CAACY,4BAA4B,GAAGR,EAAE,CAACC,IAAI,CAACQ,UAAU,CAACZ,MAAM,EAAE,8BAA8B,EAAE,CAAC,CAAC;OACrG,IAAI,CAACL,MAAM,GAAGkB,gEAA4B,CAACC,MAAM,CAAChB,EAAE,EAAEC,QAAQ,CAAC;OAC/D,IAAI,CAACJ,MAAM,CAACoB,WAAW,CAAC,IAAI,CAAC;OAC7B,IAAI,CAACpB,MAAM,CAACqB,YAAY,CAACb,EAAE,CAACC,IAAI,CAACM,SAAS,CAACV,MAAM,EAAE,OAAO,EAAE,EAAE,CAAC,CAAC;OAChEiB,6BAAY,CAACC,SAAS,CAAC,IAAI,CAACvB,MAAM,EAAE,UAAU,EAAE,IAAI,CAACwB,mBAAmB,CAACC,IAAI,CAAC,IAAI,CAAC,CAAC;OACpFH,6BAAY,CAACC,SAAS,CAAC,IAAI,CAACvB,MAAM,EAAE,oBAAoB,EAAE,IAAI,CAAC0B,kBAAkB,CAACD,IAAI,CAAC,IAAI,CAAC,CAAC;OAC7FH,6BAAY,CAACC,SAAS,CAAC,IAAI,CAACvB,MAAM,EAAE,iBAAiB,EAAE,IAAI,CAAC2B,eAAe,CAACF,IAAI,CAAC,IAAI,CAAC,CAAC;OACvFH,6BAAY,CAACC,SAAS,CAAC,IAAI,CAACvB,MAAM,EAAE,SAAS,EAAE,IAAI,CAAC4B,OAAO,CAACH,IAAI,CAAC,IAAI,CAAC,CAAC;OACvE,IAAI,CAACI,UAAU,GAAG,IAAI;OACtB,IAAI,CAACC,WAAW,GAAG,EAAE;OAErB,IAAI,CAACC,mBAAmB,EAAE;;;KAC1B;KAAA,sCAGD;OACC,IAAIC,KAAK,GAAG,IAAI,CAACC,YAAY,CAAC,IAAI,CAACC,QAAQ,EAAE,CAAC;OAC9C,IAAI,CAACJ,WAAW,GAAGK,MAAM,CAACC,IAAI,CAACJ,KAAK,CAAC;OACrC,IAAI,CAAChC,MAAM,CAACqC,QAAQ,CAACL,KAAK,CAAC;;;KAC3B;KAAA,6BAEYA,KAAK,EAClB;OACC,OAAOM,cAAI,CAACC,aAAa,CAACP,KAAK,CAAC,GAAGA,KAAK,GAAG,EAAE;;;KAC7C;KAAA,iCAGD;OAEC,IAAI,CAACM,cAAI,CAACE,SAAS,CAAC,IAAI,CAACX,UAAU,CAAC,EACpC;SACC;;OAEDY,aAAG,CAACC,KAAK,CAAC,IAAI,CAACb,UAAU,CAAC;OAE1B,IAAIc,MAAM,GAAG,EAAE;OAAC,2CACC,IAAI,CAACb,WAAW;SAAA;OAAA;SAAjC,oDACA;WAAA,IADSc,KAAI;WAEZD,MAAM,CAACC,KAAI,CAAC,GAAG,EAAE;;;SACjB;;SAAA;;OAAA,4CACmB,IAAI,CAAC5C,MAAM,CAACkC,QAAQ,EAAE;SAAA;OAAA;SAA1C,uDACA;WAAA,IADSW,OAAO;WAEf,IAAIA,OAAO,CAACb,KAAK,CAACc,MAAM,EACxB;aACCH,MAAM,CAACE,OAAO,CAACD,IAAI,CAAC,GAAGC,OAAO,CAACb,KAAK;;;;SAErC;;SAAA;;OAED,IAAIe,eAAe,GAAG,IAAI,CAACC,OAAO,EAAE;OACpC,KAAK,IAAIJ,IAAI,IAAID,MAAM,EACvB;SACC,IAAI,CAACA,MAAM,CAACM,cAAc,CAACL,IAAI,CAAC,EAChC;WACC;;SAED,IAAIZ,KAAK,GAAGW,MAAM,CAACC,IAAI,CAAC;SACxB,IAAIM,IAAI,GAAE,EAAE;SACZ,IAAIZ,cAAI,CAACa,cAAc,CAACnB,KAAK,CAAC,EAC9B;WACCkB,IAAI,aAAMH,eAAe,cAAIH,IAAI,MAAG;UACpC,MAED;WACCM,IAAI,aAAMH,eAAe,cAAIH,IAAI,eAAY;WAC7CZ,KAAK,GAAG,GAAG;;SAGZ,IAAIoB,IAAI,GAAGC,aAAG,CAACC,MAAM,wGAAuB;SAC5CF,IAAI,CAACF,IAAI,GAAGA,IAAI;SAChBE,IAAI,CAACpB,KAAK,GAAGA,KAAK;SAClBS,aAAG,CAACc,MAAM,CAACH,IAAI,EAAE,IAAI,CAACvB,UAAU,CAAC;;;;KAElC;KAAA,8BAEa2B,OAAO,EACrB;OACC,IAAI,CAACzB,mBAAmB,EAAE;OAC1B,sHAAoByB,OAAO;;;KAC3B;KAAA,uBAEMA,OAAO,EACd;OACC,IAAI,IAAI,CAACC,UAAU,EACnB;SACC;;OAGD,IAAI,CAACC,oBAAoB,CAAC;SAACC,UAAU,EAAE,CAAC,8EAA8E;QAAE,CAAC;OACzH,IAAI,CAACC,aAAa,EAAE;OAEpB,IAAI,CAAC,IAAI,CAACC,eAAe,EAAE,EAC3B;SACC,IAAI,CAACC,cAAc,CAACN,OAAO,CAAC;SAC5B,IAAI,CAACC,UAAU,GAAG,IAAI;SACtB;;OAGD,IAAI,IAAI,CAACM,aAAa,EAAE,EACxB;SACCtB,aAAG,CAACc,MAAM,CAAC,IAAI,CAACS,gBAAgB,EAAE,EAAE,IAAI,CAACC,QAAQ,CAAC;;OAGnDxB,aAAG,CAACc,MAAM,CAAC,IAAI,CAACW,eAAe,CAAC,IAAI,CAACC,QAAQ,EAAE,CAAC,EAAE,IAAI,CAACF,QAAQ,CAAC;OAEhE,IAAIG,cAAc,GAAG,IAAI,CAACpE,MAAM,CAACqE,MAAM,CAAC,IAAI,CAACC,KAAK,KAAK9D,EAAE,CAAC+D,EAAE,CAACC,gBAAgB,CAACC,IAAI,CAAC;OACnFL,cAAc,CAACM,SAAS,CAACC,GAAG,CAAC,gCAAgC,CAAC;OAC9D,IAAI,CAACV,QAAQ,CAACW,WAAW,CAACR,cAAc,CAAC;OAEzC,IAAI,CAACvC,UAAU,GAAGwB,aAAG,CAACC,MAAM,gGAAe;OAC3C,IAAI,CAACW,QAAQ,CAACW,WAAW,CAAC,IAAI,CAAC/C,UAAU,CAAC;OAE1C,IAAI,IAAI,CAACgD,oBAAoB,EAAE,EAC/B;SACC,IAAI,CAACZ,QAAQ,CAACW,WAAW,CAAC,IAAI,CAACE,uBAAuB,EAAE,CAAC;;OAG1D,IAAI,IAAI,CAACf,aAAa,EAAE,EACxB;SACC,IAAI,CAACgB,2BAA2B,EAAE;;OAGnC,IAAI,CAACjB,cAAc,CAACN,OAAO,CAAC;OAC5B,IAAI,CAACC,UAAU,GAAG,IAAI;;;KACtB;KAAA,oCAGD;OACC,IAAG,IAAI,CAACa,KAAK,KAAK9D,EAAE,CAAC+D,EAAE,CAACC,gBAAgB,CAACQ,IAAI,EAC7C;SACC,OAAO,IAAI;;OAGZ,IAAI,IAAI,CAAC9E,qBAAqB,IAAI,IAAI,CAACA,qBAAqB,CAAC4C,MAAM,EACnE;SACC,IAAImC,QAAQ,GAAG5B,aAAG,CAACC,MAAM,uHAAoC;SAC7D2B,QAAQ,CAACC,YAAY,CAAC,SAAS,EAAE,IAAI,CAAChF,qBAAqB,CAAC;SAC5D,OAAO+E,QAAQ;;OAGhB;;;KACA;KAAA,sCAGD;OACC,IAAI,CAACE,aAAa,EAAE;;;KACpB;KAAA,qCAGD;OACC,IAAIC,SAAS,GAAG,IAAI,CAACC,SAAS,EAAE,CAACC,UAAU;OAC3C,IAAIF,SAAS,EACb;SACCA,SAAS,CAACG,SAAS,CAAC,IAAI,CAAC;;;;KAE1B;KAAA,kCAGD;OACC,IAAIH,SAAS,GAAG,IAAI,CAACC,SAAS,EAAE,CAACC,UAAU;OAC3C,IAAIF,SAAS,EACb;SACCA,SAAS,CAACG,SAAS,CAAC,KAAK,CAAC;;;;KAE3B;KAAA,wBAEOC,KAAK,EACb;OACC,IAAMC,IAAI,GAAGD,KAAK,CAACjF,OAAO,EAAE;OAC5B,IAAI,CAACmF,SAAS,CAACD,IAAI,CAACE,KAAK,CAAC;OAE1B,IAAMP,SAAS,GAAG,IAAI,CAACC,SAAS,EAAE,CAACC,UAAU;OAC7C,IAAIF,SAAS,EACb;SACCA,SAAS,CAACG,SAAS,CAAC,KAAK,CAAC;;;;KAE3B;KAAA,iDAEuCC,KAAK,EAC7C;OACC,IAAIC,IAAI,GAAGD,KAAK,CAACjF,OAAO,EAAE;OAC1B,IAAIkF,IAAI,CAAC,CAAC,CAAC,EACX;SACCA,IAAI,CAAC,CAAC,CAAC,CAACG,OAAO,CAAC,aAAa,CAAC,GAAG,UAAChD,IAAI,EAAEiD,SAAS,EAAEzF,QAAQ,EAC3D;WACC,IAAIwC,IAAI,KAAK,aAAa,EAC1B;aACC,OAAO7C,0BAA0B,CAACoB,MAAM,CAAC0E,SAAS,EAAEzF,QAAQ,CAAC;;WAE9D,OAAO,IAAI;UACX;;OAEFoF,KAAK,CAACM,OAAO,CAACL,IAAI,CAAC;;;KACnB;KAAA,uBAEatF,EAAE,EAAEC,QAAQ,EAC1B;OACC,IAAI2F,IAAI,GAAG,IAAI,IAAI,CAAC5F,EAAE,EAAEC,QAAQ,CAAC;OACjC2F,IAAI,CAACC,UAAU,CAAC7F,EAAE,EAAEC,QAAQ,CAAC;OAC7B,OAAO2F,IAAI;;;GACX;CAAA,EA9N8CvF,EAAE,CAAC+D,EAAE,CAAC0B,iBAAiB;AAiOvE3E,8BAAY,CAACC,SAAS,CAAC,+CAA+C,EAAExB,0BAA0B,CAACmG,gCAAgC,CAAC;;;;;;;;"}