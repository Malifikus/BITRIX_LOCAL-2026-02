this.BX=this.BX||{};this.BX.Crm=this.BX.Crm||{};(function(t,e,i,n,a,s,l,r,c,o,d,u){"use strict";const h=Object.freeze({none:{value:"N",title:u.Loc.getMessage("CRM_EE_RECURRING_MODE_ITEM_NONE")},multiple:{value:"2",title:u.Loc.getMessage("CRM_EE_RECURRING_MODE_ITEM_MULTIPLE")},single:{value:"1",title:u.Loc.getMessage("CRM_EE_RECURRING_MODE_ITEM_SINGLE")}});function m(t){var e;return(e=Object.values(h).find((e=>e.value===t)))!=null?e:null}const E=Object.freeze({no:{value:"N",title:u.Loc.getMessage("CRM_EE_RECURRING_MULTIPLE_LIMIT_ITEM_NO")},date:{value:"D",title:u.Loc.getMessage("CRM_EE_RECURRING_MULTIPLE_LIMIT_ITEM_DATE")},times:{value:"T",title:u.Loc.getMessage("CRM_EE_RECURRING_MULTIPLE_LIMIT_ITEM_TIMES")}});function p(t){var e;return(e=Object.values(E).find((e=>e.value===t)))!=null?e:null}const g=Object.freeze({day:{value:1,title:u.Loc.getMessage("CRM_EE_RECURRING_MULTIPLE_TYPE_ITEM_DAY")},week:{value:2,title:u.Loc.getMessage("CRM_EE_RECURRING_MULTIPLE_TYPE_ITEM_WEEK")},month:{value:3,title:u.Loc.getMessage("CRM_EE_RECURRING_MULTIPLE_TYPE_ITEM_MONTH")},year:{value:4,title:u.Loc.getMessage("CRM_EE_RECURRING_MULTIPLE_TYPE_ITEM_YEAR")},custom:{value:5,title:u.Loc.getMessage("CRM_EE_RECURRING_MULTIPLE_TYPE_ITEM_CUSTOM")}});function I(t){var e;return(e=Object.values(g).find((e=>e.value===t)))!=null?e:null}const T=Object.freeze({set:0,calculated:1});const f=Object.freeze({day:{value:1,title:u.Loc.getMessage("CRM_EE_RECURRING_PERIOD_ITEM_DAY"),titleGenitive:u.Loc.getMessage("CRM_EE_RECURRING_MODE_SINGLE_FIELDS_PERIOD_DAY"),extended:false},week:{value:2,title:u.Loc.getMessage("CRM_EE_RECURRING_PERIOD_ITEM_WEEK"),titleGenitive:u.Loc.getMessage("CRM_EE_RECURRING_MODE_SINGLE_FIELDS_PERIOD_WEEK"),extended:false},month:{value:3,title:u.Loc.getMessage("CRM_EE_RECURRING_PERIOD_ITEM_MONTH"),titleGenitive:u.Loc.getMessage("CRM_EE_RECURRING_MODE_SINGLE_FIELDS_PERIOD_MONTH"),extended:false},year:{value:4,title:u.Loc.getMessage("CRM_EE_RECURRING_PERIOD_ITEM_YEAR"),extended:true}});function _(t=false){if(t){return f}const e={};Object.keys(f).forEach((t=>{if(f[t].extended===false){e[t]=f[t]}}));return Object.freeze(e)}function R(t){var e;return(e=Object.values(f).find((e=>e.value===t)))!=null?e:null}function v(t,e,i){a.PopupMenu.show(t,e,i,{angle:false,width:e.offsetWidth+"px"});a.PopupMenu.currentItem.popupWindow.setWidth(BX.pos(e).width)}function y(t){a.PopupMenu.destroy(t)}function C(t,e){return new s.DatePicker({selectedDates:[new Date(t)],events:{onSelectChange:t=>{e(t)}}})}function D(t){return n.DateTimeFormat.format(i.DatetimeConverter.getSiteDateFormat(),t)}function b(t){if(BX.CrmEntityType.isDynamicTypeByTypeId(t)){return"DYNAMIC"}return t===BX.CrmEntityType.enumeration.dealrecurring?BX.CrmEntityType.names.deal:BX.CrmEntityType.resolveName(t)}const M={props:{title:{type:String,required:true}},template:`\n\t\t<div class="ui-entity-editor-block-title ui-entity-widget-content-block-title-edit">\n\t\t\t<label class="ui-entity-editor-block-title-text">{{title}}</label>\n\t\t</div>\n\t`};const L={props:{name:{type:String,required:true},value:{type:[String,Number],required:true},changeCallback:{type:Function,default:()=>{}}},watch:{value(){void this.$nextTick((()=>{this.changeCallback(this.$refs.input)}))}},template:`\n\t\t<input ref="input" :name="name" :value="value" type="hidden">\n\t`};const S="xs";const N="BULLET";const w={mounted(){this.loader=new l.Loader({target:this.$refs.loader,type:N,size:S});this.loader.render();this.loader.show()},beforeUnmount(){this.loader.hide();this.loader=null},template:`\n\t\t<div class="crm-entity-widget-content-block-recurring-loader" ref="loader"></div>\n\t`};let k=t=>t,U;const B="default";const P={props:{documentId:{type:Number,required:true},documents:{type:Array,required:true},documentUrl:{type:String,required:true}},components:{FieldTitle:M},data(){return{currentDocumentId:this.documentId}},methods:{showDocumentDialog(t){const e=this.getDocumentDialog();e.setTargetNode(t.target);e.show()},getDocumentDialog(){if(!this.documentDialog){const t=this.getItems();this.documentDialog=new d.Dialog({multiple:false,dropdownMode:true,showAvatars:true,enableSearch:t.length>8,width:500,height:300,zIndex:2500,items:t,tabs:this.getTabs(),footer:this.getFooter(),events:{"Item:onSelect":this.onSelectDocument,"Item:onDeselect":this.onDeselectDocument}})}return this.documentDialog},onSelectDocument(t){const{item:{id:e}}=t.getData();this.currentDocumentId=e;this.emitChanges()},onDeselectDocument(){this.currentDocumentId=null;this.emitChanges()},emitChanges(){void this.$nextTick((()=>{this.$emit("onChange",this.currentDocumentId)}))},getCurrentDocument(){const t=this.documents.find((t=>t.id===this.currentDocumentId));return u.Type.isObject(t)?t:null},getTabs(){return[{id:B,title:this.$Bitrix.Loc.getMessage("CRM_EE_RECURRING_EMAIL_DOCUMENT_TAB_TITLE_SMART_INVOICE"),stub:true,stubOptions:{title:this.$Bitrix.Loc.getMessage("CRM_EE_RECURRING_EMAIL_EMPTY_STATE_DOCUMENT_TITLE_SMART_INVOICE"),subtitle:this.$Bitrix.Loc.getMessage("CRM_EE_RECURRING_EMAIL_EMPTY_STATE_DOCUMENT_SUBTITLE_SMART_INVOICE"),arrow:true}}]},getItems(){const t=[];this.documents.forEach((e=>{t.push(this.createDialogItem(e))}));return t},createDialogItem(t){return{id:t.id,title:t.title,entityId:B,tabs:B}},getFooter(){return u.Tag.render(U||(U=k`
				<div class="crm-entity-editor-recurring-template-selector-footer">
					<span class="ui-selector-footer-link ui-selector-footer-link-add" onclick="${0}">
						${0}
					</span>
				</div>
			`),this.createNewDocumentHandler,this.$Bitrix.Loc.getMessage("CRM_EE_RECURRING_EMAIL_DOCUMENT_ADD"))},createNewDocumentHandler(){this.showDocumentsSidePanel(this.documentUrl)},showDocumentsSidePanel(t){c.SidePanel.Instance.open(t,{cacheable:false,width:1080,events:{onClose:async()=>{this.$emit("onReInit")}}})}},watch:{documentId(t){if(Number(this.documentId)!==Number(this.currentDocumentId)){this.currentDocumentId=Number(t)}},documents:{handler(){const t=this.getDocumentDialog();t.removeItems();this.documents.forEach((e=>{t.addItem(this.createDialogItem(e))}))},deep:true}},computed:{documentTitle(){return this.$Bitrix.Loc.getMessage("CRM_EE_RECURRING_EMAIL_DOCUMENT_FIELD_SMART_INVOICE")},documentName(){const t=this.getCurrentDocument();return t?t.title:null},placeholder(){return this.$Bitrix.Loc.getMessage("CRM_EE_RECURRING_EMAIL_DOCUMENT_FIELD_PLACEHOLDER")}},template:`\n\t\t<div class="ui-entity-editor-content-block">\n\t\t\t<div class="ui-entity-editor-block-title ui-entity-widget-content-block-title-edit">\n\t\t\t\t<label for="" class="ui-entity-editor-block-title-text">\n\t\t\t\t\t{{documentTitle}}\n\t\t\t\t</label>\n\t\t\t</div>\n\t\t\t<div\n\t\t\t\tclass="ui-ctl ui-ctl-after-icon ui-ctl-dropdown ui-ctl-w100"\n\t\t\t\t@click="showDocumentDialog"\n\t\t\t>\n\t\t\t\t<div v-if="documentName" class="ui-ctl-element">{{documentName}}</div>\n\t\t\t\t<div v-else class="ui-ctl-element placeholder" :data-placeholder="placeholder"></div>\n\t\t\t\t<div class="ui-ctl-after ui-ctl-icon-angle"></div>\n\t\t\t</div>\n\t\t</div>\n\t`};let O=t=>t,A;const G="default";const F={props:{senderId:{type:Number,required:true},senders:{type:Array,required:true}},components:{FieldTitle:M},data(){return{currentSenderId:this.senderId}},methods:{showSenderDialog(t){const e=this.getSenderDialog();e.setTargetNode(t.target);e.show()},getSenderDialog(){if(!this.senderDialog){const t=this.getItems();this.senderDialog=new d.Dialog({multiple:false,dropdownMode:true,showAvatars:true,enableSearch:t.length>8,width:500,height:300,zIndex:2500,tabs:this.getTabs(),items:t,selectedItems:this.getSelectedItems(),footer:this.getFooter(),events:{"Item:onSelect":this.onSelectSender,"Item:onDeselect":this.onDeselectSender}})}return this.senderDialog},getTabs(){return[{id:G,title:this.$Bitrix.Loc.getMessage("CRM_EE_RECURRING_EMAIL_EMPTY_STATE_SENDER_TITLE"),stub:true,stubOptions:{title:this.$Bitrix.Loc.getMessage("CRM_EE_RECURRING_EMAIL_EMPTY_STATE_SENDER_TITLE"),subtitle:this.$Bitrix.Loc.getMessage("CRM_EE_RECURRING_EMAIL_EMPTY_STATE_SENDER_SUBTITLE_SMART_INVOICE"),arrow:true}}]},getItems(){const t=[];this.senders.forEach((e=>{t.push(this.createDialogItem(e))}));return t},getSelectedItems(){const t=[];this.senders.forEach((e=>{if(Number(this.senderId)===Number(e.id)){t.push(this.createDialogItem(e))}}));return t},createDialogItem(t){return{id:t.id,title:t.email,subtitle:t.name,entityId:G,tabs:G}},getFooter(){return u.Tag.render(A||(A=O`
				<div class="crm-entity-editor-recurring-template-selector-footer">
					<span class="ui-selector-footer-link ui-selector-footer-link-add" onclick="${0}">
						${0}
					</span>
				</div>
			`),this.createNewSenderHandler,this.$Bitrix.Loc.getMessage("CRM_EE_RECURRING_EMAIL_NEW_SENDER"))},createNewSenderHandler(){r.ProviderShowcase.openSlider({setSenderCallback:(t,e,i)=>{this.$emit("onReInit")}})},onSelectSender(t){const{item:{id:e}}=t.getData();this.currentSenderId=e;this.emitChanges()},onDeselectSender(){this.currentSenderId=null;this.emitChanges()},emitChanges(){this.$emit("onChange",this.currentSenderId)},getCurrentSender(){const t=this.senders.find((t=>Number(t.id)===Number(this.senderId)));return u.Type.isObject(t)?t:null}},watch:{senderId(t){if(Number(this.senderId)!==Number(this.currentSenderId)){this.currentSenderId=Number(t)}},senders:{handler(){const t=this.getSenderDialog();t.removeItems();this.senders.forEach((e=>{t.addItem(this.createDialogItem(e))}))},deep:true}},computed:{senderTitle(){return this.$Bitrix.Loc.getMessage("CRM_EE_RECURRING_EMAIL_SENDER_FIELD")},senderName(){const t=this.getCurrentSender();return t?t.email:null},placeholder(){return this.$Bitrix.Loc.getMessage("CRM_EE_RECURRING_EMAIL_SENDER_FIELD_PLACEHOLDER")}},template:`\n\t\t<div class="ui-entity-editor-content-block">\n\t\t\t<div class="ui-entity-editor-block-title ui-entity-widget-content-block-title-edit">\n\t\t\t\t<label for="" class="ui-entity-editor-block-title-text">\n\t\t\t\t\t{{senderTitle}}\n\t\t\t\t</label>\n\t\t\t</div>\n\t\t\t<div\n\t\t\t\tclass="ui-ctl ui-ctl-after-icon ui-ctl-dropdown ui-ctl-w100"\n\t\t\t\t@click="showSenderDialog"\n\t\t\t>\n\t\t\t\t<div v-if="senderName" class="ui-ctl-element">{{senderName}}</div>\n\t\t\t\t<div v-else class="ui-ctl-element placeholder" :data-placeholder="placeholder"></div>\n\t\t\t\t<div class="ui-ctl-after ui-ctl-icon-angle"></div>\n\t\t\t</div>\n\t\t</div>\n\t`};let x=t=>t,$;const H="default";const V={props:{entityTypeId:{type:Number,required:true},templateId:{type:Number,required:true},templates:{type:Array,required:true}},components:{FieldTitle:M},data(){return{currentTemplateId:this.templateId}},methods:{showTemplateDialog(t){const e=this.getTemplateDialog();e.setTargetNode(t.target);e.show()},getTemplateDialog(){if(!this.templateDialog){const t=this.getItems();this.templateDialog=new d.Dialog({multiple:false,dropdownMode:true,showAvatars:true,enableSearch:t.length>8,width:500,height:300,zIndex:2500,tabs:this.getTabs(),items:t,selectedItems:this.getSelectedItems(),footer:this.getFooter(),events:{"Item:onSelect":this.onSelectTemplate,"Item:onDeselect":this.onDeselectTemplate}})}return this.templateDialog},getTabs(){return[{id:H,title:this.$Bitrix.Loc.getMessage("CRM_EE_RECURRING_EMAIL_EMPTY_STATE_TEMPLATE_TITLE"),stub:true,stubOptions:{title:this.$Bitrix.Loc.getMessage("CRM_EE_RECURRING_EMAIL_EMPTY_STATE_TEMPLATE_TITLE"),subtitle:this.$Bitrix.Loc.getMessage("CRM_EE_RECURRING_EMAIL_EMPTY_STATE_TEMPLATE_SUBTITLE_SMART_INVOICE"),arrow:true}}]},getItems(){const t=[];this.templates.forEach((e=>{t.push(this.createDialogItem(e))}));return t},getSelectedItems(){const t=[];this.templates.forEach((e=>{if(Number(this.templateId)===Number(e.id)){t.push(this.createDialogItem(e))}}));return t},createDialogItem(t){return{id:t.id,title:t.title,entityId:H,tabs:H}},getFooter(){return u.Tag.render($||($=x`
				<div class="crm-entity-editor-recurring-template-selector-footer">
					<span class="ui-selector-footer-link ui-selector-footer-link-add" onclick="${0}">
						${0}
					</span>
					<span class="ui-selector-footer-link" onclick="${0}">
						${0}
					</span>
				</div>
			`),this.createNewEmailTemplateHandler,this.$Bitrix.Loc.getMessage("CRM_EE_RECURRING_EMAIL_NEW_TEMPLATE"),this.showEmailTemplatesList,this.$Bitrix.Loc.getMessage("CRM_EE_RECURRING_EMAIL_SHOW_TEMPLATES_LIST"))},createNewEmailTemplateHandler(){let t="/crm/configs/mailtemplate/add/";const e={ENTITY_TYPE_ID:this.entityTypeId};t=BX.util.add_url_param(t,e);this.showEmailTemplatesSidePanel(t,true)},showEmailTemplatesList(){const t="/crm/configs/mailtemplate/";this.showEmailTemplatesSidePanel(t,false)},showEmailTemplatesSidePanel(t,e){c.SidePanel.Instance.open(t,{cacheable:false,width:1080,events:{onClose:async()=>{if(e){this.$emit("onReInit")}}}})},onSelectTemplate(t){const{item:{id:e}}=t.getData();this.currentTemplateId=e;this.emitChanges()},onDeselectTemplate(){this.currentTemplateId=null;this.emitChanges()},emitChanges(){void this.$nextTick((()=>{this.$emit("onChange",this.currentTemplateId)}))},getCurrentTemplate(){const t=this.templates.find((t=>Number(t.id)===Number(this.currentTemplateId)));return u.Type.isObject(t)?t:null}},watch:{templateId(t){if(Number(this.templateId)!==Number(this.currentTemplateId)){this.currentTemplateId=Number(t)}},templates:{handler(){const t=this.getTemplateDialog();t.removeItems();this.templates.forEach((e=>{t.addItem(this.createDialogItem(e))}))},deep:true}},computed:{templateTitle(){return this.$Bitrix.Loc.getMessage("CRM_EE_RECURRING_EMAIL_TEMPLATE_FIELD")},templateName(){const t=this.getCurrentTemplate();return t?t.title:null},placeholder(){return this.$Bitrix.Loc.getMessage("CRM_EE_RECURRING_EMAIL_TEMPLATE_FIELD_PLACEHOLDER")}},template:`\n\t\t<div class="ui-entity-editor-content-block">\n\t\t\t<div class="ui-entity-editor-block-title ui-entity-widget-content-block-title-edit">\n\t\t\t\t<label class="ui-entity-editor-block-title-text">\n\t\t\t\t\t{{templateTitle}}\n\t\t\t\t</label>\n\t\t\t</div>\n\t\t\t<div\n\t\t\t\tclass="ui-ctl ui-ctl-after-icon ui-ctl-dropdown ui-ctl-w100"\n\t\t\t\t@click="showTemplateDialog"\n\t\t\t>\n\t\t\t\t<div v-if="templateName" class="ui-ctl-element">{{templateName}}</div>\n\t\t\t\t<div v-else class="ui-ctl-element placeholder" :data-placeholder="placeholder"></div>\n\t\t\t\t<div class="ui-ctl-after ui-ctl-icon-angle"></div>\n\t\t\t</div>\n\t\t</div>\n\t`};let Y=t=>t,q;const j="default";const X={props:{entityId:{type:Number,required:true},entityTypeId:{type:Number,required:true},communications:{type:Array,required:true,default:[]},emailIds:{type:Array,required:true}},components:{FieldTitle:M},data(){const t=this.emailIds.filter((t=>t>0)).map((t=>Number(t)));return{currentEmailIds:new Set(t),currentCommunications:this.communications}},mounted(){this.initToEmailTagSelector()},methods:{initToEmailTagSelector(){if(!this.toEmailTagSelector){const t={multiple:true,dialogOptions:{width:400,height:300,multiple:false,dropdownMode:true,showAvatars:true,compactView:false,tabs:this.getTabs(),items:this.getItems(),selectedItems:this.getSelectedItems(),footer:this.entityId>0?this.getFooter():null,events:{"Item:onSelect":this.onSelectEmail,"Item:onDeselect":this.onDeselectEmail}}};this.toEmailTagSelector=new d.TagSelector(t);this.toEmailTagSelector.renderTo(this.$refs.toEmailContainer)}},getTabs(){let t="CRM_EE_RECURRING_EMAIL_EMPTY_STATE_TO_EMAIL_SUBTITLE_SMART_INVOICE";if(this.entityId<=0){t=`${t}_NEW`}return[{id:j,title:this.$Bitrix.Loc.getMessage("CRM_EE_RECURRING_EMAIL_TO_EMAIL_TAB_TITLE"),stubOptions:{title:this.$Bitrix.Loc.getMessage("CRM_EE_RECURRING_EMAIL_EMPTY_STATE_TO_EMAIL_TITLE"),subtitle:this.$Bitrix.Loc.getMessage(t),arrow:true}}]},getItems(){const t=[];this.currentCommunications.forEach((e=>{e.emails.forEach((i=>{t.push(this.createDialogItem(i,e))}))}));return t},getSelectedItems(){const t=[];this.currentEmailIds.forEach((e=>{const i=this.getEmailById(e);if(i){t.push(this.createDialogItem(i))}}));return t},getEmailById(t){const e=this.currentCommunications.flatMap((t=>t.emails.map((e=>({...e,caption:t.caption})))));const i=e.find((e=>Number(e.id)===Number(t)));return i!=null?i:null},createDialogItem(t,e=null){return{id:t.id,title:t.value,subtitle:e?this.getEmailSubtitle(e,t):"",entityId:j,tabs:j}},getEmailSubtitle(t,e){return`${t.caption} (${e.typeLabel})`},getFooter(){return u.Tag.render(q||(q=Y`
				<div class="crm-entity-editor-recurring-template-selector-footer">
					<span class="ui-selector-footer-link ui-selector-footer-link-add" onclick="${0}">
						${0}
					</span>
				</div>
			`),this.addClientHandler.bind(this),this.$Bitrix.Loc.getMessage("CRM_EE_RECURRING_EMAIL_BIND_CLIENT"))},onSelectEmail(t){const{item:{id:e}}=t.getData();this.currentEmailIds.add(e);this.emitChanges()},onDeselectEmail(t){const{item:{id:e}}=t.getData();this.currentEmailIds.delete(e);this.emitChanges()},emitChanges(){void this.$nextTick((()=>{this.$emit("onChange",[...this.currentEmailIds.values()])}))},addClientHandler(t){const e="client-selector-dialog";const i=this.entityTypeId;const n=`CRM_RECURRING-${i}`;if(!this.userSelectorDialog){this.userSelectorDialog=new d.Dialog({id:e,context:n,targetNode:t.target,multiple:false,dropdownMode:false,showAvatars:true,enableSearch:true,width:450,zIndex:2500,entities:this.getClientSelectorEntities(),events:{"Item:onSelect":this.onSelectClient}})}if(this.userSelectorDialog.isOpen()){this.userSelectorDialog.hide()}else{this.userSelectorDialog.show()}},getClientSelectorEntities(){const t={id:"contact",dynamicLoad:true,dynamicSearch:true,options:{showTab:true,showPhones:true,showMails:true}};const e={id:"company",dynamicLoad:true,dynamicSearch:true,options:{excludeMyCompany:true,showTab:true,showPhones:true,showMails:true}};return[t,e]},async onSelectClient(t){const{item:e}=t.getData();this.selectedClient={entityId:e.id,entityTypeId:BX.CrmEntityType.resolveId(e.entityId)};const i=await this.bindClient();if(i){var n,a;BX.Crm.EntityEditor.getDefault().reload();const t=(n=this.currentCommunications[0])==null?void 0:(a=n.emails[0])==null?void 0:a.id;if(t){this.currentEmailIds.add(t);this.emitChanges()}}},async bindClient(){const{entityId:t,entityTypeId:e}=this.selectedClient;const i={entityId:this.entityId,entityTypeId:this.entityTypeId,clientId:t,clientTypeId:e};return new Promise((t=>{u.ajax.runAction("crm.recurring.mail.bindClient",{data:i}).then((({data:e})=>{if(!e){t(false)}const{communications:i}=e;this.currentCommunications=i;this.currentCommunications.forEach((t=>{t.emails.forEach((e=>{this.toEmailTagSelector.addTag(this.createDialogItem(e,t))}))}));this.$emit("onReInit");this.emitChanges();t(true)})).catch((t=>{this.showNotify(this.$Bitrix.Loc.getMessage("CRM_EE_RECURRING_EMAIL_ERROR"))}))}))},showNotify(t){BX.UI.Notification.Center.notify({content:t})}},watch:{emailIds(t){this.currentEmailIds=new Set(t!=null?t:[])},communications:{handler(t){this.currentCommunications=t;this.toEmailTagSelector=null;u.Dom.clean(this.$refs.toEmailContainer);this.initToEmailTagSelector()},deep:true}},computed:{communicationsTitle(){return this.$Bitrix.Loc.getMessage("CRM_EE_RECURRING_EMAIL_COMMUNICATIONS_FIELD")}},template:`\n\t\t<div class="ui-entity-editor-content-block">\n\t\t\t<div class="ui-entity-editor-block-title ui-entity-widget-content-block-title-edit">\n\t\t\t\t<label for="" class="ui-entity-editor-block-title-text">\n\t\t\t\t\t{{communicationsTitle}}\n\t\t\t\t</label>\n\t\t\t</div>\n\t\t\t<div ref="toEmailContainer"></div>\n\t\t</div>\n\t`};const W={props:{entityTypeId:{type:Number,required:true},entityId:{type:Number,required:true},data:{type:Object,default:{}},changeCallback:{type:Function,required:true}},components:{FieldTitle:M,HiddenInput:L,Loader:w,TemplateSelector:V,DocumentSelector:P,SenderSelector:F,ToEmailSelector:X},data(){var t,e,i,n,a;return{isFetchedConfig:false,templateId:(t=this.data.templateId)!=null?t:null,documentId:(e=this.data.documentId)!=null?e:null,senderId:(i=this.data.senderId)!=null?i:null,isEnabled:(n=this.data.isEnabled)!=null?n:false,emailIds:(a=this.data.emailIds)!=null?a:[],config:null}},mounted(){if(this.isEnabled&&!this.isFetchedConfig){this.updateConfig()}},methods:{async setTemplateId(t){if(this.templateId!==t){this.templateId=t}},async setDocumentId(t){if(this.documentId!==t){this.documentId=t}},async setSenderId(t){if(this.senderId!==t){this.senderId=t}},async setEmailIds(t){const e=(t,e)=>{if(t.length!==e.length){return false}const i=[...t].sort();const n=[...e].sort();return i.every(((t,e)=>t===n[e]))};if(!e([...this.emailIds],t)){this.emailIds=t;this.changeCallback({name:"RECURRING[EMAIL_IDS]",value:[...this.emailIds]})}},async updateConfig(){this.config=await this.fetchConfig()},async fetchConfig(){const t={entityTypeId:this.entityTypeId,entityId:this.entityId};return new Promise((e=>{u.ajax.runAction("crm.recurring.mail.getConfig",{data:t}).then((t=>{this.isFetchedConfig=true;const i=t.data;if(this.templateId===null){var n,a;this.templateId=(n=(a=i.templates[0])==null?void 0:a.id)!=null?n:null}e(t.data)})).catch((()=>{this.showNotify(this.$Bitrix.Loc.getMessage("CRM_EE_RECURRING_EMAIL_ERROR"));this.isFetchedConfig=true}))}))},showNotify(t){BX.UI.Notification.Center.notify({content:t})},focus(){this.$refs.isEnabledTemplate.focus()},getData(){var t;const e=(t=this.toEmailTagSelector)==null?void 0:t.getTags();const i=e?e.map((t=>t.id)):[];return{isEnabled:this.isEnabled,templateId:this.templateId,documentId:this.documentId,senderId:this.senderId,emailIds:i}}},watch:{async isEnabled(t){if(!this.isFetchedConfig&&t){this.config=await this.fetchConfig()}}},computed:{title(){return this.$Bitrix.Loc.getMessage("CRM_EE_RECURRING_EMAIL_TITLE_SMART_INVOICE")},containerClassList(){return["crm-entity-widget-content-block-inner","crm-entity-widget-content-block-colums-input","crm-entity-widget-content-block-recurring-email-section-container"]},fieldsBlockClassList(){return{"crm-recurring-mail-fields-container":true,"--disabled":!this.isEnabled}},checkboxLabelClassList(){return{"ui-ctl":true,"ui-ctl-w100":true,"ui-ctl-checkbox":true,"--checked":this.isEnabled}},isEnabledTitle(){return this.$Bitrix.Loc.getMessage("CRM_EE_RECURRING_EMAIL_SECTION_IS_ENABLED")},formattedIsEnabled(){return this.isEnabled?"Y":"N"}},template:`\n\t\t<div class="ui-entity-editor-content-block">\n\t\t\t<FieldTitle :title="title" />\n\t\t\t<div :class="containerClassList">\n\t\t\t\t<label :class="checkboxLabelClassList">\n\t\t\t\t\t<input\n\t\t\t\t\t\ttype="checkbox"\n\t\t\t\t\t\tclass="ui-ctl-element"\n\t\t\t\t\t\tv-model="isEnabled"\n\t\t\t\t\t\tref="isEnabledTemplate"\n\t\t\t\t\t\tvalue="Y"\n\t\t\t\t\t>\n\t\t\t\t\t<span class="ui-ctl-label-text">{{isEnabledTitle}}</span>\n\t\t\t\t</label>\n\n\t\t\t\t<Loader v-if="isEnabled && !isFetchedConfig" />\n\t\t\t\t\n\t\t\t\t<div v-if="isEnabled && isFetchedConfig" :class="fieldsBlockClassList">\n\t\t\t\t\t\n\t\t\t\t\t<TemplateSelector\n\t\t\t\t\t\tv-if="config"\n\t\t\t\t\t\t:entityTypeId="entityTypeId"\n\t\t\t\t\t\t:templateId="Number(templateId)"\n\t\t\t\t\t\t:templates="config.templates"\n\t\t\t\t\t\t@onChange="setTemplateId"\n\t\t\t\t\t\t@onReInit="updateConfig"\n\t\t\t\t\t/>\n\t\t\t\t\t\n\t\t\t\t\t<DocumentSelector\n\t\t\t\t\t\tv-if="config"\n\t\t\t\t\t\t:documentId="Number(documentId)"\n\t\t\t\t\t\t:documents="config.documents"\n\t\t\t\t\t\t:documentUrl="config.documentUrl"\n\t\t\t\t\t\t@onChange="setDocumentId"\n\t\t\t\t\t\t@onReInit="updateConfig"\n\t\t\t\t\t/>\n\n\t\t\t\t\t<SenderSelector\n\t\t\t\t\t\tv-if="config"\n\t\t\t\t\t\t:senderId="Number(senderId)"\n\t\t\t\t\t\t:senders="config.senders"\n\t\t\t\t\t\t@onChange="setSenderId"\n\t\t\t\t\t\t@onReInit="updateConfig"\n\t\t\t\t\t/>\n\t\t\t\t\t\n\t\t\t\t\t<ToEmailSelector\n\t\t\t\t\t\tv-if="config"\n\t\t\t\t\t\t:entityId="entityId"\n\t\t\t\t\t\t:entityTypeId="entityTypeId"\n\t\t\t\t\t\t:communications="config.communications"\n\t\t\t\t\t\t:emailIds="emailIds"\n\t\t\t\t\t\t@onChange="setEmailIds"\n\t\t\t\t\t\t@onReInit="updateConfig"\n\t\t\t\t\t/>\n\n\t\t\t\t\t<HiddenInput :value="templateId" name="RECURRING[EMAIL_TEMPLATE_ID]" :change-callback="changeCallback" />\n\t\t\t\t\t<HiddenInput :value="documentId" name="RECURRING[EMAIL_DOCUMENT_ID]" :change-callback="changeCallback" />\n\t\t\t\t\t<HiddenInput :value="senderId" name="RECURRING[SENDER_ID]" :change-callback="changeCallback" />\n\t\t\t\t\t<HiddenInput v-for="emailId in emailIds" :key="emailId" :value="emailId" name="RECURRING[EMAIL_IDS][]" />\n\t\t\t\t</div>\n\t\t\t\t<HiddenInput :value="formattedIsEnabled" name="RECURRING[IS_SEND_EMAIL]" :change-callback="changeCallback" />\n\t\t\t</div>\n\t\t</div>\t\n\t`};const z=t=>({created(){this.popupMenuId=t},beforeUnmount(){if(u.Type.isArray(this.popupMenuId)){this.popupMenuId.forEach((t=>y(t)))}else if(u.Type.isStringFilled(this.popupMenuId)){y(this.popupMenuId)}}});const K={components:{FieldTitle:M},mixins:[z("crm-recurring-category-selector")],props:{categoryId:{type:Number,required:true},categories:{type:Array,required:true}},computed:{categoryTitle(){return this.$Bitrix.Loc.getMessage("CRM_EE_RECURRING_CATEGORY_TITLE")},currentCategoryTitle(){const t=this.categories.find((t=>Number(t.VALUE)===Number(this.categoryId)));return t?t.NAME:this.$Bitrix.Loc.getMessage("CRM_EE_RECURRING_CATEGORY_TITLE_WITHOUT_PERMISSIONS")}},methods:{showCategorySelector(){const t=[];this.categories.forEach((e=>{t.push({value:Number(e.VALUE),text:e.NAME,onclick:this.onChangeCategory.bind(this)})}));v(this.popupMenuId,this.$refs.categorySelector,t)},onChangeCategory(t,e){this.$emit("onChange",e.value);e.getMenuWindow().close()}},template:`\n\t\t<div>\n\t\t\t<FieldTitle :title="categoryTitle" />\n\t\t\n\t\t\t<div class="ui-entity-editor-content-block">\n\t\t\t\t<div class="ui-ctl ui-ctl-after-icon ui-ctl-dropdown ui-ctl-w100">\n\t\t\t\t\t<div\n\t\t\t\t\t\tref="categorySelector"\n\t\t\t\t\t\tclass="ui-ctl-element"\n\t\t\t\t\t\t@click="showCategorySelector"\n\t\t\t\t\t>\n\t\t\t\t\t\t{{currentCategoryTitle}}\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="ui-ctl-after ui-ctl-icon-angle"></div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</div>\n\t`};const J={components:{FieldTitle:M},mixins:[z(["crm-recurring-dates-section-selector-beginDate","crm-recurring-dates-section-selector-closeDate"])],props:{entityTypeId:{type:Number,required:true},isEditableDateStartField:{type:Boolean,default:true},dateStart:{type:Number,required:true},offsetBeginDateValue:{type:Number,required:true},offsetBeginDateType:{type:Number,required:true},offsetCloseDateValue:{type:Number,required:true},offsetCloseDateType:{type:Number,required:true}},data(){return{isShowOffsetBeginDate:this.offsetBeginDateValue>0,formData:{currentDateStart:this.dateStart,currentOffsetBeginDateValue:this.offsetBeginDateValue,currentOffsetBeginDateType:this.offsetBeginDateType,currentOffsetCloseDateValue:this.offsetCloseDateValue,currentOffsetCloseDateType:this.offsetCloseDateType},isEmitting:false}},computed:{title(){const t=this.getEntityTypeName();return this.$Bitrix.Loc.getMessage(`CRM_EE_RECURRING_DATE_FIELDS_TITLE_${t}`)},startDateTitle(){const t=this.getEntityTypeName();return this.$Bitrix.Loc.getMessage(`CRM_EE_RECURRING_DATES_SECTION_FIELD_DATE_CREATE_${t}`)},formattedStartDate(){return D(this.formData.currentDateStart)},beginDateTitle(){return this.$Bitrix.Loc.getMessage("CRM_EE_RECURRING_BEGINDATE_TYPE_TITLE")},closeDateTitle(){const t=this.getEntityTypeName();return this.$Bitrix.Loc.getMessage(`CRM_EE_RECURRING_CLOSEDATE_TYPE_TITLE_${t}`)},offsetBeginDateTypeTitle(){return R(this.formData.currentOffsetBeginDateType).title},offsetCloseDateTypeTitle(){return R(this.formData.currentOffsetCloseDateType).title},offsetDateBeginTitle(){const t=this.getEntityTypeName();return this.$Bitrix.Loc.getMessage(`CRM_EE_RECURRING_OFFSET_DATE_BEGIN_TITLE_${t}`)}},watch:{formData:{handler(){if(!this.isEmitting){void this.$nextTick((()=>{this.emitChange()}))}},deep:true},isShowOffsetBeginDate:{handler(){if(!this.isEmitting){void this.$nextTick((()=>{this.emitChange()}))}}},dateStart:{handler(t){const e=Math.round(this.formData.currentDateStart);const i=Math.round(t);if(e!==i){this.formData.currentDateStart=t}}},offsetBeginDateValue:{handler(t){this.isShowOffsetBeginDate=t>0}}},created(){this.datePicker=C(this.dateStart*1e3,(t=>{this.formData.currentDateStart=t.getTarget().getSelectedDate().getTime()/1e3}))},beforeUnmount(){this.datePicker.destroy()},methods:{showDateStartCalendar(){if(!this.isEditableDateStartField){return}this.datePicker.setTargetNode(this.$refs.dateStart);this.datePicker.show()},showPeriodSelector(t,e){const i=[];Object.values(_()).forEach((t=>{i.push({text:t.title,value:t.value,onclick:this.onSelectPeriodItem.bind(this,e)})}));const n=`crm-recurring-dates-section-selector-${e}`;v(n,t,i)},onSelectPeriodItem(t,e,i){const n=i.value;if(t==="beginDate"){this.formData.currentOffsetBeginDateType=n}else if(t==="closeDate"){this.formData.currentOffsetCloseDateType=n}i.getMenuWindow().close()},emitChange(){if(this.isEmitting){return}this.isEmitting=true;this.$emit("onChange",{dateStart:this.formData.currentDateStart,offsetBeginDateValue:this.formData.currentOffsetBeginDateValue,offsetBeginDateType:this.formData.currentOffsetBeginDateType,offsetCloseDateValue:this.formData.currentOffsetCloseDateValue,offsetCloseDateType:this.formData.currentOffsetCloseDateType,isShowOffsetBeginDate:this.isShowOffsetBeginDate});void this.$nextTick((()=>{this.isEmitting=false}))},getEntityTypeName(){return b(this.entityTypeId)}},template:`\n\t\t<div class="ui-entity-editor-content-block">\n\t\t\t<FieldTitle :title="title" />\n\t\t\t\n\t\t\t<div class="crm-entity-widget-content-block-inner crm-entity-widget-content-block-colums-input crm-entity-widget-content-block-recurring-inside-section-container">\n\t\t\t\t<FieldTitle :title="startDateTitle" />\n\t\t\t\t\n\t\t\t\t<div class="crm-entity-widget-content-block-inner crm-entity-widget-content-block-colums-input">\n\t\t\t\t\t<div class="ui-ctl ui-ctl-after-icon ui-ctl-datetime ui-ctl-w50">\n\t\t\t\t\t\t<div class="ui-ctl-after ui-ctl-icon-calendar"></div>\n\t\t\t\t\t\t<input\n\t\t\t\t\t\t\tref="dateStart"\n\t\t\t\t\t\t\t:readonly="!isEditableDateStartField"\n\t\t\t\t\t\t\t:disabled="!isEditableDateStartField"\n\t\t\t\t\t\t\tclass="ui-ctl-element"\n\t\t\t\t\t\t\ttype="text"\n\t\t\t\t\t\t\t:value="formattedStartDate"\n\t\t\t\t\t\t\t@click="showDateStartCalendar"\n\t\t\t\t\t\t>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\t\n\t\t\t\t\n\t\t\t\t<label class="ui-ctl ui-ctl-w100 ui-ctl-checkbox">\n\t\t\t\t\t<input\n\t\t\t\t\t\ttype="checkbox"\n\t\t\t\t\t\tclass="ui-ctl-element"\n\t\t\t\t\t\tv-model="isShowOffsetBeginDate"\n\t\t\t\t\t\tvalue="Y"\n\t\t\t\t\t>\n\t\t\t\t\t<span class="ui-ctl-label-text">{{offsetDateBeginTitle}}</span>\n\t\t\t\t</label>\n\n\t\t\t\t<FieldTitle v-if="isShowOffsetBeginDate" :title="beginDateTitle" />\n\t\t\t\t\n\t\t\t\t<div\n\t\t\t\t\tv-if="isShowOffsetBeginDate"\n\t\t\t\t\tclass="crm-entity-widget-content-block-inner crm-entity-widget-content-block-colums-input"\n\t\t\t\t>\n\t\t\t\t\t<div class="crm-entity-widget-content-block-input-wrapper">\n\t\t\t\t\t\t<input\n\t\t\t\t\t\t\tclass="crm-entity-widget-content-input"\n\t\t\t\t\t\t\ttype="number"\n\t\t\t\t\t\t\tv-model="formData.currentOffsetBeginDateValue"\n\t\t\t\t\t\t>\n\t\t\t\t\t\t<div class="crm-entity-widget-content-block-select">\n\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\tclass="crm-entity-widget-content-select"\n\t\t\t\t\t\t\t\t@click="(event) => showPeriodSelector(event.target, 'beginDate')"\n\t\t\t\t\t\t\t>{{offsetBeginDateTypeTitle}}</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t\n\t\t\t\t<FieldTitle :title="closeDateTitle" />\n\t\t\t\t\n\t\t\t\t<div class="crm-entity-widget-content-block-inner crm-entity-widget-content-block-colums-input">\n\t\t\t\t\t<div class="crm-entity-widget-content-block-input-wrapper">\n\t\t\t\t\t\t<input\n\t\t\t\t\t\t\tclass="crm-entity-widget-content-input"\n\t\t\t\t\t\t\ttype="number"\n\t\t\t\t\t\t\tv-model="formData.currentOffsetCloseDateValue"\n\t\t\t\t\t\t>\n\t\t\t\t\t\t<div class="crm-entity-widget-content-block-select">\n\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\tclass="crm-entity-widget-content-select"\n\t\t\t\t\t\t\t\t@click="(event) => showPeriodSelector(event.target, 'closeDate')"\n\t\t\t\t\t\t\t>{{offsetCloseDateTypeTitle}}</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</div>\n\t`};const Q={components:{FieldTitle:M},mixins:[z("crm-recurring-mode-selector")],props:{entityTypeId:{type:Number,required:true},mode:{type:String,required:true}},computed:{modeTitle(){const t=b(this.entityTypeId);return this.$Bitrix.Loc.getMessage(`CRM_EE_RECURRING_MODE_TITLE_${t}`)},currentModeTitle(){return m(this.mode).title}},methods:{showModeSelector(){const t=[];Object.values(h).forEach((({value:e,title:i})=>{t.push({value:e,text:i,onclick:this.onChangeMode.bind(this)})}));v(this.popupMenuId,this.$refs.modeSelector,t)},onChangeMode(t,e){this.$emit("onChange",e.value);e.getMenuWindow().close()}},template:`\n\t\t<div>\n\t\t\t<FieldTitle :title="modeTitle" />\n\t\t\n\t\t\t<div class="ui-entity-editor-content-block">\n\t\t\t\t<div class="ui-ctl ui-ctl-after-icon ui-ctl-dropdown ui-ctl-w100">\n\t\t\t\t\t<div\n\t\t\t\t\t\tref="modeSelector"\n\t\t\t\t\t\tclass="ui-ctl-element"\n\t\t\t\t\t\t@click="showModeSelector"\n\t\t\t\t\t>\n\t\t\t\t\t\t{{currentModeTitle}}\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="ui-ctl-after ui-ctl-icon-angle"></div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</div>\n\t`};const Z={components:{FieldTitle:M},mixins:[z("crm-recurring-multiple-limit-selector")],props:{entityTypeId:{type:Number,required:true},type:{type:String,required:true},date:{type:Number,required:true},times:{type:Number,required:true}},data(){return{currentType:this.type,currentDate:this.date,currentTimes:this.times}},computed:{title(){const t=b(this.entityTypeId);return this.$Bitrix.Loc.getMessage(`CRM_EE_RECURRING_MULTIPLE_LIMIT_TITLE_${t}`)},dateTitle(){return this.$Bitrix.Loc.getMessage("CRM_EE_RECURRING_MULTIPLE_LIMIT_ITEM_DATE_FIELD_TITLE")},timesTitle(){return this.$Bitrix.Loc.getMessage("CRM_EE_RECURRING_MULTIPLE_LIMIT_ITEM_TIMES_FIELD_TITLE")},currentMultipleLimitTitle(){return p(this.currentType).title},formattedDate(){return D(this.currentDate)},isDateLimit(){return this.currentType===E.date.value},isTimesLimit(){return this.currentType===E.times.value}},watch:{currentType(){this.emitChange()},currentDate(){this.emitChange()},currentTimes(){this.emitChange()}},created(){this.datePicker=C(this.date*1e3,(t=>{this.currentDate=t.getTarget().getSelectedDate().getTime()/1e3}))},beforeUnmount(){this.datePicker.destroy()},methods:{showSelector(){const t=[];Object.values(E).forEach((({value:e,title:i})=>{t.push({value:e,text:i,onclick:this.onChange.bind(this)})}));v(this.popupMenuId,this.$refs.selector,t)},onChange(t,e){this.currentType=e.value;e.getMenuWindow().close()},emitChange(){void this.$nextTick((()=>{this.$emit("onChange",{type:this.currentType,date:this.currentDate,times:this.currentTimes})}))},showDatePicker(){this.datePicker.setTargetNode(this.$refs.date);this.datePicker.show()}},template:`\n\t\t<div class="ui-entity-editor-content-block">\n\t\t\t<FieldTitle :title="title" />\n\t\t\t\n\t\t\t<div class="ui-entity-editor-content-block">\n\t\t\t\t<div class="ui-ctl ui-ctl-after-icon ui-ctl-dropdown ui-ctl-w100">\n\t\t\t\t\t<div\n\t\t\t\t\t\tref="selector"\n\t\t\t\t\t\tclass="ui-ctl-element"\n\t\t\t\t\t\t@click="showSelector"\n\t\t\t\t\t>\n\t\t\t\t\t\t{{currentMultipleLimitTitle}}\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="ui-ctl-after ui-ctl-icon-angle"></div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t\n\t\t\t<FieldTitle\n\t\t\t\tv-if="isDateLimit"\n\t\t\t\t:title="dateTitle"\n\t\t\t/>\n\t\t\t<div\n\t\t\t\tv-if="isDateLimit"\n\t\t\t\tclass="ui-entity-editor-content-block"\n\t\t\t>\n\t\t\t\t<div class="ui-ctl ui-ctl-after-icon ui-ctl-datetime ui-ctl-w50">\n\t\t\t\t\t<div class="ui-ctl-after ui-ctl-icon-calendar"></div>\n\t\t\t\t\t<input\n\t\t\t\t\t\tref="date"\n\t\t\t\t\t\tclass="ui-ctl-element"\n\t\t\t\t\t\ttype="text"\n\t\t\t\t\t\t:value="formattedDate"\n\t\t\t\t\t\t@click="showDatePicker"\n\t\t\t\t\t>\n\t\t\t\t</div>\n\t\t\t</div>\n\n\t\t\t<FieldTitle\n\t\t\t\tv-if="isTimesLimit"\n\t\t\t\t:title="timesTitle"\n\t\t\t/>\n\t\t\t<div\n\t\t\t\tv-if="isTimesLimit"\n\t\t\t\tclass="ui-entity-editor-content-block"\n\t\t\t>\n\t\t\t\t<div class="ui-ctl ui-ctl-textbox">\n\t\t\t\t\t<input\n\t\t\t\t\t\tclass="ui-ctl-element"\n\t\t\t\t\t\ttype="number"\n\t\t\t\t\t\tmin="1"\n\t\t\t\t\t\tv-model="currentTimes"\n\t\t\t\t\t>\n\t\t\t\t</div>\n\t\t\t</div>\n\n\t\t</div>\n\t`};const tt={components:{FieldTitle:M},mixins:[z("crm-recurring-multiple-repeat-selector")],props:{interval:{type:Number,required:true},type:{type:Number,required:true}},data(){return{currentInterval:this.interval,currentType:this.type}},computed:{title(){return this.$Bitrix.Loc.getMessage("CRM_EE_RECURRING_MULTIPLE_TYPE_CUSTOM_TITLE")},currentItemTitle(){return R(this.currentType).title}},watch:{currentType(){this.emitChange()},currentInterval(){this.emitChange()}},methods:{showSelector(){const t=[];Object.values(_(true)).forEach((({value:e,title:i})=>{t.push({value:e,text:i,onclick:this.onChange.bind(this)})}));v(this.popupMenuId,this.$refs.selector,t)},onChange(t,e){this.currentType=e.value;e.getMenuWindow().close()},emitChange(){void this.$nextTick((()=>{this.$emit("onChange",{type:this.currentType,value:this.currentInterval})}))}},template:`\n\t\t<div class="ui-entity-editor-content-block">\n\t\t\t<FieldTitle :title="title" />\n\t\t\t<div class="crm-entity-widget-content-block-inner crm-entity-widget-content-block-colums-input">\n\t\t\t\t<div class="crm-entity-widget-content-block-input-wrapper">\n\t\t\t\t\t<input\n\t\t\t\t\t\tclass="crm-entity-widget-content-input"\n\t\t\t\t\t\ttype="number"\n\t\t\t\t\t\tv-model="currentInterval"\n\t\t\t\t\t>\n\t\t\t\t\t<div class="crm-entity-widget-content-block-select">\n\t\t\t\t\t\t<div\n\t\t\t\t\t\t\tref="selector"\n\t\t\t\t\t\t\tclass="crm-entity-widget-content-select"\n\t\t\t\t\t\t\t@click="showSelector"\n\t\t\t\t\t\t>{{currentItemTitle}}</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</div>\n\t`};const et={components:{FieldTitle:M},props:{type:{type:Number,required:true}},data(){return{currentType:this.type}},computed:{title(){return this.$Bitrix.Loc.getMessage("CRM_EE_RECURRING_MULTIPLE_TYPE_TITLE")},currentMultipleTypeTitle(){return I(this.currentType).title}},watch:{currentType(){this.emitChange()}},methods:{showSelector(){const t=[];Object.values(g).forEach((({value:e,title:i})=>{t.push({value:e,text:i,onclick:this.onChange.bind(this)})}));const e=this.$refs.selector;const i="crm-recurring-multiple-type-selector";v(i,e,t)},onChange(t,e){this.currentType=e.value;e.getMenuWindow().close()},emitChange(){void this.$nextTick((()=>{this.$emit("onChange",{type:this.currentType})}))}},template:`\n\t\t<div class="ui-entity-editor-content-block">\n\t\t\t<FieldTitle :title="title"/>\n\n\t\t\t<div class="ui-entity-editor-content-block">\n\t\t\t\t<div class="ui-ctl ui-ctl-after-icon ui-ctl-dropdown ui-ctl-w100">\n\t\t\t\t\t<div\n\t\t\t\t\t\tref="selector"\n\t\t\t\t\t\tclass="ui-ctl-element"\n\t\t\t\t\t\t@click="showSelector"\n\t\t\t\t\t>\n\t\t\t\t\t\t{{currentMultipleTypeTitle}}\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="ui-ctl-after ui-ctl-icon-angle"></div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</div>\n\t`};const it={components:{FieldTitle:M,HiddenInput:L},mixins:[z("crm-recurring-period-selector")],props:{interval:{type:Number,required:true},type:{type:Number,required:true},date:{type:Number,required:true}},data(){return{currentInterval:this.interval,currentType:this.type,currentDate:this.date}},computed:{prefixTitle(){return this.$Bitrix.Loc.getMessage("CRM_EE_RECURRING_MODE_SINGLE_FIELDS_PREFIX")},datePrefixTitle(){return this.$Bitrix.Loc.getMessage("CRM_EE_RECURRING_MODE_SINGLE_FIELDS_DATE_PREFIX")},currentModeTitle(){return R(this.type).titleGenitive},formattedDate(){return D(this.currentDate)}},watch:{currentInterval(){this.emitChange()},currentType(){this.emitChange()},currentDate(){this.emitChange()}},created(){this.datePicker=C(this.date*1e3,(t=>{this.currentDate=t.getTarget().getSelectedDate().getTime()/1e3}))},beforeUnmount(){this.datePicker.destroy()},methods:{emitChange(){void this.$nextTick((()=>{this.$emit("onChange",{value:this.currentInterval,type:this.currentType,date:this.currentDate})}))},showPeriodSelector(){const t=[];Object.values(_()).forEach((({value:e,titleGenitive:i})=>{t.push({value:e,text:i,onclick:this.onChangePeriod.bind(this)})}));v(this.popupMenuId,this.$refs.periodSelector,t)},onChangePeriod(t,e){this.currentType=e.value;e.getMenuWindow().close()},showDatePicker(){this.datePicker.setTargetNode(this.$refs.date);this.datePicker.show()}},template:`\n\t\t<div class="crm-entity-widget-content-block-field-recurring-single">\n\t\t\t<div class="crm-entity-widget-content-block-inner crm-entity-widget-content-block-colums-input">\n\t\t\t\t<div class="crm-entity-widget-content-block-input-wrapper">\n\t\t\t\t\t<span>{{prefixTitle}} </span>\n\t\t\t\t\t<input\n\t\t\t\t\t\tclass="crm-entity-widget-content-input"\n\t\t\t\t\t\ttype="number"\n\t\t\t\t\t\tv-model="currentInterval"\n\t\t\t\t\t>\n\t\t\t\t\t\n\t\t\t\t\t<div class="ui-ctl ui-ctl-after-icon ui-ctl-dropdown">\n\t\t\t\t\t\t<div\n\t\t\t\t\t\t\tref="periodSelector"\n\t\t\t\t\t\t\tclass="ui-ctl-element"\n\t\t\t\t\t\t\t@click="showPeriodSelector"\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t{{currentModeTitle}}\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div class="ui-ctl-after ui-ctl-icon-angle"></div>\n\t\t\t\t\t</div>\n\t\t\t\t\t\n\t\t\t\t\t<span> {{datePrefixTitle}} </span>\n\t\t\t\t\t<div class="ui-ctl ui-ctl-after-icon ui-ctl-datetime ui-ctl-w50">\n\t\t\t\t\t\t<div class="ui-ctl-after ui-ctl-icon-calendar"></div>\n\t\t\t\t\t\t<input \n\t\t\t\t\t\t\tref="date"\n\t\t\t\t\t\t\tclass="ui-ctl-element"\n\t\t\t\t\t\t\ttype="text"\n\t\t\t\t\t\t\t:value="formattedDate"\n\t\t\t\t\t\t\t@click="showDatePicker"\n\t\t\t\t\t\t>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</div>\n\t`};const nt={components:{FieldTitle:M,HiddenInput:L,ModeSelector:Q,SingleFields:it,DateFields:J,EmailFields:W,MultipleLimitSelector:Z,MultipleRepeatSelector:tt,MultipleTypeSelector:et,CategorySelector:K},props:{entityId:{type:Number,required:true},entityTypeId:{type:Number,required:true},data:{type:Object,required:true},params:{type:Object,required:true},changeCallback:{type:Function,required:true}},data(){var t,e,i,n,a,s,l,r,c,o,d,u,m,p;const I=new Date;const T=this.getDefaultOffsetType();const f=Number((t=this.data["RECURRING[OFFSET_BEGINDATE_VALUE]"])!=null?t:0);const _=Number((e=this.data["RECURRING[OFFSET_CLOSEDATE_VALUE]"])!=null?e:0);return{mode:(i=this.data["RECURRING[MODE]"])!=null?i:h.none.value,singleInterval:Number((n=this.data["RECURRING[SINGLE_INTERVAL_VALUE]"])!=null?n:0),singleType:Number((a=this.data["RECURRING[SINGLE_TYPE]"])!=null?a:T),singleDateBefore:this.initDateInSeconds("RECURRING[SINGLE_DATE_BEFORE]"),multipleCustomIntervalValue:Number((s=this.data["RECURRING[MULTIPLE_CUSTOM_INTERVAL_VALUE]"])!=null?s:0),multipleCustomType:Number((l=this.data["RECURRING[MULTIPLE_CUSTOM_TYPE]"])!=null?l:g.day.value),multipleDateStart:this.initDateInSeconds("RECURRING[MULTIPLE_DATE_START]"),multipleTypeLimit:(r=this.data["RECURRING[MULTIPLE_TYPE_LIMIT]"])!=null?r:E.no.value,multipleDateLimit:this.initDateInSeconds("RECURRING[MULTIPLE_DATE_LIMIT]"),multipleTimesLimit:Number((c=this.data["RECURRING[MULTIPLE_TIMES_LIMIT]"])!=null?c:1),dateStart:I,offsetBeginDateType:Number((o=this.data["RECURRING[OFFSET_BEGINDATE_TYPE]"])!=null?o:T),offsetBeginDateValue:f,offsetCloseDateType:Number((d=this.data["RECURRING[OFFSET_CLOSEDATE_TYPE]"])!=null?d:T),offsetCloseDateValue:_,isShowOffsetBeginDate:false,multipleType:Number((u=this.data["RECURRING[MULTIPLE_TYPE]"])!=null?u:g.day.value),multipleLimit:(m=this.data["RECURRING[MULTIPLE_TYPE_LIMIT]"])!=null?m:E.no.value,categoryId:Number((p=this.data["RECURRING[CATEGORY_ID]"])!=null?p:0)}},computed:{isMultipleMode(){return this.mode===h.multiple.value},isSingleMode(){return this.mode===h.single.value},mustShowMultipleRepeatSelector(){return this.isMultipleMode&&this.multipleType===g.custom.value},formattedMultipleDateLimit(){return D(this.multipleDateLimit)},formattedDateStart(){return D(this.multipleDateStart)},formattedSingleDateBefore(){return D(this.singleDateBefore)},dateForDateFieldsComponent(){if(this.mode===h.multiple.value){return this.multipleDateStart}let t=new Date(this.singleDateBefore*1e3);switch(this.singleType){case f.day.value:t=t.setDate(t.getDate()-this.singleInterval);break;case f.week.value:t=t.setDate(t.getDate()-this.singleInterval*7);break;case f.month.value:t=t.setMonth(t.getMonth()-this.singleInterval);break;default:}return t/1e3},emailData(){var t,e,i,n,a;return{senderId:(t=this.data["RECURRING[SENDER_ID]"])!=null?t:null,documentId:(e=this.data["RECURRING[EMAIL_DOCUMENT_ID]"])!=null?e:null,templateId:(i=this.data["RECURRING[EMAIL_TEMPLATE_ID]"])!=null?i:null,isEnabled:(n=this.data["RECURRING[IS_SEND_EMAIL]"])!=null?n:false,emailIds:(a=this.data["RECURRING[EMAIL_IDS]"])!=null?a:[]}},isCategoriesEnabled(){var t;return(t=this.params.isCategoriesEnabled)!=null?t:false},isEmailEnabled(){return this.entityTypeId===BX.CrmEntityType.enumeration.smartinvoice},beginDateType(){const t=this.isShowOffsetBeginDate&&this.offsetBeginDateValue>0;return t?T.calculated:T.set},closeDateType(){return this.offsetCloseDateValue>0?T.calculated:T.set}},methods:{initDateInSeconds(t){const e=this.data[t];const i=n.DateTimeFormat.parse(e);const a=(i!=null?i:new Date).getTime();return a/1e3},setMode(t){this.mode=t},setMultipleTypeData({type:t}){this.multipleType=t},setMultipleRepeatData({type:t,value:e}){this.multipleCustomType=t;this.multipleCustomIntervalValue=e},setMultipleLimits({type:t,date:e,times:i}){this.multipleTypeLimit=t;this.multipleDateLimit=e;this.multipleTimesLimit=i},setSingleFields({value:t,type:e,date:i}){this.singleInterval=t;this.singleType=e;this.singleDateBefore=i},setDateFields({dateStart:t,offsetBeginDateValue:e,offsetBeginDateType:i,offsetCloseDateValue:n,offsetCloseDateType:a,isShowOffsetBeginDate:s}){if(this.mode===h.multiple.value){this.multipleDateStart=t}else{this.dateStart=new Date(t*1e3)}this.offsetBeginDateValue=e;this.offsetBeginDateType=i;this.offsetCloseDateValue=n;this.offsetCloseDateType=a;this.isShowOffsetBeginDate=s},setCategoryId(t){this.categoryId=t},getDefaultOffsetType(){return f.day.value}},template:`\n\t\t<div>\n\t\t\t<ModeSelector \n\t\t\t\t:entity-type-id="entityTypeId"\n\t\t\t\t:mode="mode"\n\t\t\t\t@onChange="setMode"\n\t\t\t/>\n\n\t\t\t\x3c!-- region mode --\x3e\n\t\t\t\t<HiddenInput :value="mode" name="RECURRING[MODE]" :change-callback="changeCallback" />\n\t\t\t\x3c!-- endregion --\x3e\n\t\t\n\t\t\t<div v-if="isMultipleMode || isSingleMode">\n\t\t\t\t<SingleFields\n\t\t\t\t\tv-if="isSingleMode"\n\t\t\t\t\t:interval="singleInterval"\n\t\t\t\t\t:type="singleType"\n\t\t\t\t\t:date="singleDateBefore"\n\t\t\t\t\t@onChange="setSingleFields"\n\t\t\t\t/>\n\n\t\t\t\t<MultipleTypeSelector\n\t\t\t\t\tv-if="isMultipleMode"\n\t\t\t\t\t:type="multipleType"\n\t\t\t\t\t@onChange="setMultipleTypeData"\n\t\t\t\t/>\n\t\t\t\t\n\t\t\t\t<MultipleRepeatSelector\n\t\t\t\t\tv-if="mustShowMultipleRepeatSelector"\n\t\t\t\t\t:interval="multipleCustomIntervalValue"\n\t\t\t\t\t:type="multipleCustomType"\n\t\t\t\t\t@onChange="setMultipleRepeatData"\n\t\t\t\t/>\n\t\t\t\n\t\t\t\t<MultipleLimitSelector\n\t\t\t\t\tv-if="isMultipleMode"\n\t\t\t\t\t:entity-type-id="entityTypeId"\n\t\t\t\t\t:type="multipleTypeLimit"\n\t\t\t\t\t:date="multipleDateLimit"\n\t\t\t\t\t:times="multipleTimesLimit"\n\t\t\t\t\t@onChange="setMultipleLimits"\n\t\t\t\t/>\n\t\t\t\n\t\t\t\t<DateFields\n\t\t\t\t\t:entity-type-id="entityTypeId"\n\t\t\t\t\t:isEditableDateStartField="isMultipleMode"\n\t\t\t\t\t:dateStart="dateForDateFieldsComponent"\n\t\t\t\t\t:offsetBeginDateValue="offsetBeginDateValue"\n\t\t\t\t\t:offsetBeginDateType="offsetBeginDateType"\n\t\t\t\t\t:offsetCloseDateValue="offsetCloseDateValue"\n\t\t\t\t\t:offsetCloseDateType="offsetCloseDateType"\n\t\t\t\t\t@onChange="setDateFields"\n\t\t\t\t/>\n\t\t\t\t\n\t\t\t\t<CategorySelector\n\t\t\t\t\tv-if="isCategoriesEnabled"\n\t\t\t\t\t:categories="params.categories"\n\t\t\t\t\t:categoryId="categoryId"\n\t\t\t\t\t@onChange="setCategoryId"\n\t\t\t\t/>\n\t\t\t\t\n\t\t\t\t<EmailFields\n\t\t\t\t\tv-if="isEmailEnabled"\n\t\t\t\t\t:entity-id="entityId"\n\t\t\t\t\t:entity-type-id="entityTypeId"\n\t\t\t\t\t:data="emailData"\n\t\t\t\t\t:change-callback="changeCallback"\n\t\t\t\t/>\n\n\t\t\t\t\x3c!-- region multiple type --\x3e\n\t\t\t\t<HiddenInput :value="multipleType" name="RECURRING[MULTIPLE_TYPE]" :change-callback="changeCallback" />\n\t\t\t\t\x3c!-- endregion --\x3e\n\t\t\t\t\n\t\t\t\t\x3c!-- region MultipleRepeatSelector fields --\x3e\n\t\t\t\t<HiddenInput :value="multipleCustomIntervalValue" name="RECURRING[MULTIPLE_CUSTOM_INTERVAL_VALUE]" :change-callback="changeCallback" />\n\t\t\t\t<HiddenInput :value="multipleCustomType" name="RECURRING[MULTIPLE_CUSTOM_TYPE]" :change-callback="changeCallback" />\n\t\t\t\t\x3c!-- endregion --\x3e\n\n\t\t\t\t\x3c!-- region MultipleLimitSelector fields --\x3e\n\t\t\t\t<HiddenInput :value="multipleTypeLimit" name="RECURRING[MULTIPLE_TYPE_LIMIT]" :change-callback="changeCallback" />\n\t\t\t\t<HiddenInput :value="formattedMultipleDateLimit" name="RECURRING[MULTIPLE_DATE_LIMIT]" :change-callback="changeCallback" />\n\t\t\t\t<HiddenInput :value="multipleTimesLimit" name="RECURRING[MULTIPLE_TIMES_LIMIT]" :change-callback="changeCallback" />\n\t\t\t\t\x3c!-- endregion --\x3e\n\n\t\t\t\t\x3c!-- region Date fields --\x3e\n\t\t\t\t<HiddenInput :value="formattedDateStart" name="RECURRING[MULTIPLE_DATE_START]" :change-callback="changeCallback" />\n\t\t\t\t<HiddenInput :value="beginDateType" name="RECURRING[BEGINDATE_TYPE]" :change-callback="changeCallback" />\n\t\t\t\t<HiddenInput :value="closeDateType" name="RECURRING[CLOSEDATE_TYPE]" />\n\t\t\t\t<HiddenInput v-if="isShowOffsetBeginDate" :value="offsetBeginDateValue" name="RECURRING[OFFSET_BEGINDATE_VALUE]" :change-callback="changeCallback" />\n\t\t\t\t<HiddenInput v-else value="" name="RECURRING[OFFSET_BEGINDATE_VALUE]" :change-callback="changeCallback" />\n\t\t\t\t<HiddenInput v-if="isShowOffsetBeginDate" :value="offsetBeginDateType" name="RECURRING[OFFSET_BEGINDATE_TYPE]" :change-callback="changeCallback" />\n\t\t\t\t<HiddenInput v-else value="" name="RECURRING[OFFSET_BEGINDATE_TYPE]" :change-callback="changeCallback" />\n\t\t\t\t<HiddenInput :value="offsetCloseDateValue" name="RECURRING[OFFSET_CLOSEDATE_VALUE]" :change-callback="changeCallback" />\n\t\t\t\t<HiddenInput :value="offsetCloseDateType" name="RECURRING[OFFSET_CLOSEDATE_TYPE]" :change-callback="changeCallback" />\n\t\t\t\t\x3c!-- endregion --\x3e\n\n\t\t\t\t\x3c!-- region Single fields --\x3e\n\t\t\t\t<HiddenInput :value="singleType" name="RECURRING[SINGLE_TYPE]" :change-callback="changeCallback" />\n\t\t\t\t<HiddenInput :value="singleInterval" name="RECURRING[SINGLE_INTERVAL_VALUE]" :change-callback="changeCallback" />\n\t\t\t\t<HiddenInput :value="formattedSingleDateBefore" name="RECURRING[SINGLE_DATE_BEFORE]" :change-callback="changeCallback" />\n\t\t\t\t\x3c!-- endregion --\x3e\n\n\t\t\t\t\x3c!-- region Other fields --\x3e\n\t\t\t\t<HiddenInput v-if="isCategoriesEnabled" :value="categoryId" name="RECURRING[CATEGORY_ID]" :change-callback="changeCallback" />\n\t\t\t\t\x3c!-- endregion --\x3e\n\t\t\t</div>\n\t\t</div>\n\t`};let at=t=>t,st;var lt=babelHelpers.classPrivateFieldLooseKey("entityTypeId");var rt=babelHelpers.classPrivateFieldLooseKey("entityId");var ct=babelHelpers.classPrivateFieldLooseKey("data");var ot=babelHelpers.classPrivateFieldLooseKey("params");var dt=babelHelpers.classPrivateFieldLooseKey("changeCallback");var ut=babelHelpers.classPrivateFieldLooseKey("layoutComponent");var ht=babelHelpers.classPrivateFieldLooseKey("app");class mt{static create(t,e,i,n={}){return new mt(t,e,i,n)}constructor(t,e,i,n={}){Object.defineProperty(this,lt,{writable:true,value:void 0});Object.defineProperty(this,rt,{writable:true,value:void 0});Object.defineProperty(this,ct,{writable:true,value:{}});Object.defineProperty(this,ot,{writable:true,value:{}});Object.defineProperty(this,dt,{writable:true,value:void 0});Object.defineProperty(this,ut,{writable:true,value:null});Object.defineProperty(this,ht,{writable:true,value:null});babelHelpers.classPrivateFieldLooseBase(this,lt)[lt]=t;babelHelpers.classPrivateFieldLooseBase(this,rt)[rt]=e;babelHelpers.classPrivateFieldLooseBase(this,dt)[dt]=i;babelHelpers.classPrivateFieldLooseBase(this,ot)[ot]=n}setData(t){babelHelpers.classPrivateFieldLooseBase(this,ct)[ct]=t}getLayout(){if(babelHelpers.classPrivateFieldLooseBase(this,ht)[ht]){this.clean()}const t={entityTypeId:babelHelpers.classPrivateFieldLooseBase(this,lt)[lt],entityId:babelHelpers.classPrivateFieldLooseBase(this,rt)[rt],data:babelHelpers.classPrivateFieldLooseBase(this,ct)[ct],params:babelHelpers.classPrivateFieldLooseBase(this,ot)[ot],changeCallback:babelHelpers.classPrivateFieldLooseBase(this,dt)[dt]};babelHelpers.classPrivateFieldLooseBase(this,ht)[ht]=e.BitrixVue.createApp(nt,t);const i=u.Tag.render(st||(st=at`<div></div>`));babelHelpers.classPrivateFieldLooseBase(this,ut)[ut]=babelHelpers.classPrivateFieldLooseBase(this,ht)[ht].mount(i);return i}clean(){var t;(t=babelHelpers.classPrivateFieldLooseBase(this,ht)[ht])==null?void 0:t.unmount();babelHelpers.classPrivateFieldLooseBase(this,ht)[ht]=null}focus(){babelHelpers.classPrivateFieldLooseBase(this,ut)[ut].focus()}}t.Recurring=mt})(this.BX.Crm.Field=this.BX.Crm.Field||{},BX.Vue3,BX.Crm.Timeline,BX.Main,BX.Main,BX.UI.DatePicker,BX.UI,BX.UI.Mail,BX,BX.Event,BX.UI.EntitySelector,BX);
//# sourceMappingURL=recurring.bundle.map.js