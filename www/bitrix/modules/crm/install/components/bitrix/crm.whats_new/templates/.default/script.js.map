{"version":3,"file":"script.js","sources":["script.es6.js"],"sourcesContent":["import { BannerDispatcher } from 'crm.integration.ui.banner-dispatcher';\nimport { ajax as Ajax, clone, Dom, Reflection, Runtime, Tag, Type } from 'main.core';\nimport { BaseEvent, EventEmitter } from 'main.core.events';\nimport { Popup, PopupManager } from 'main.popup';\nimport { Button } from 'ui.buttons';\nimport { Guide as UIGuide } from 'ui.tour';\n\nconst namespaceCrmWhatsNew = Reflection.namespace('BX.Crm.WhatsNew');\n\ntype SlideConfig = {\n\ttitle: string,\n\tinnerImage: string,\n\tinnerTitle: string,\n\tinnerDescription: string,\n\tbuttons: Array<SlideButtonConfig>,\n};\n\ntype SlideButtonConfig = {\n\ttext: string,\n\tclassName: string,\n\tonClickClose: ?boolean,\n\thelpDeskCode: ?string,\n}\n\ntype Slide = {\n\ttitle: string,\n\tclassName: ?string,\n\thtml: string,\n}\n\ntype StepPosition = 'left' | 'right'; // it's bottom by default\n\ntype Highlighter = {\n\ttarget: string;\n\tradius?: number;\n}\n\ntype ScrollBehavior = 'auto' | 'smooth';\ntype ScrollPosition = 'top' | 'center' | 'bottom' | 'nearest';\ntype Autoscroll = {\n\tbehavior?: ScrollBehavior,\n\tposition: ScrollPosition, // top|center|bottom|nearest,\n}\n\ntype StepConfig = {\n\tid: string,\n\ttitle: string,\n\ttext: string,\n\tposition: ?StepPosition,\n\ttarget: ?string,\n\treserveTargets: ?string[],\n\tuseDynamicTarget: ?boolean,\n\teventName: ?string,\n\tarticle: ?number,\n\tarticleAnchor?: string,\n\tinfoHelperCode: ?string,\n\tignoreIfTargetNotFound: ?boolean,\n\tbuttons: ?Array<StepButtonConfig>,\n\thighlighter?: Highlighter,\n\tautoscroll?: Autoscroll,\n\ticonSrc?: string,\n}\n\ntype StepButtonConfig = {\n\ttext: string,\n\tonclick: {\n\t\tcode: ?string,\n\t\tcloseAfterClick: ?boolean,\n\t},\n};\n\ntype Step = {\n\tid: string,\n\ttitle: string,\n\ttext: string,\n\tposition: ?StepPosition,\n\ttarget: ?string,\n\thighlighter?: Highlighter,\n\tautoscroll?: Autoscroll,\n}\n\ntype Option = {\n\tshowOverlayFromFirstStep?: boolean,\n\tskipShownPopupCheck?: boolean,\n\thideTourOnMissClick?: boolean,\n\tnumberOfViewsLimit:\tnumber,\n\tisNumberOfViewsExceeded?: boolean,\n\tdisableBannerDispatcher?: boolean,\n\tadditionalTourIdsForDisable?: Array<string>,\n\tcanShowWithoutTarget?: boolean,\n\t...\n}\n\nclass ActionViewMode\n{\n\t#slides: Array<Slide>;\n\t#steps: Array<Step>;\n\t#options: Option;\n\n\t#popup: ?Popup;\n\t#bannerDispatcher: ?BannerDispatcher = null;\n\n\t#closeOptionName: string;\n\t#closeOptionCategory: string;\n\n\t#isViewHappened: boolean = false;\n\t#autoscroll: ?Autoscroll = null;\n\n\tconstructor({ slides, steps, options, closeOptionCategory, closeOptionName })\n\t{\n\t\tthis.#slides = [];\n\t\tthis.#steps = [];\n\n\t\tthis.#options = options;\n\t\tthis.#popup = null;\n\t\tthis.slideClassName = 'crm-whats-new-slides-wrapper';\n\t\tthis.#closeOptionCategory = Type.isString(closeOptionCategory) ? closeOptionCategory : '';\n\t\tthis.#closeOptionName = Type.isString(closeOptionName) ? closeOptionName : '';\n\t\tthis.onClickClose = this.onClickCloseHandler.bind(this);\n\n\t\tthis.whatNewPromise = null;\n\t\tthis.tourPromise = null;\n\n\t\tthis.#prepareSlides(slides);\n\t\tthis.#prepareSteps(steps);\n\t}\n\n\tshow(): void\n\t{\n\t\tif (this.#options.isNumberOfViewsExceeded)\n\t\t{\n\t\t\t// eslint-disable-next-line no-console\n\t\t\tconsole.warn('Number of views exceeded');\n\n\t\t\treturn;\n\t\t}\n\n\t\tif (this.#slides.length > 0)\n\t\t{\n\t\t\tthis.#executeWhatsNew();\n\t\t}\n\t\telse if (this.#steps.length > 0)\n\t\t{\n\t\t\tthis.#executeGuide();\n\t\t}\n\t}\n\n\t#prepareSlides(slideConfigs: Array<SlideConfig>): void\n\t{\n\t\tif (slideConfigs.length > 0)\n\t\t{\n\t\t\tthis.whatNewPromise = Runtime.loadExtension('ui.dialogs.whats-new');\n\t\t}\n\n\t\tthis.#slides = slideConfigs.map((slideConfig: SlideConfig) => {\n\t\t\treturn {\n\t\t\t\tclassName: this.slideClassName,\n\t\t\t\ttitle: slideConfig.title,\n\t\t\t\thtml: this.#getPreparedSlideHtml(slideConfig),\n\t\t\t};\n\t\t});\n\t}\n\n\t#getPreparedSlideHtml(slideConfig: SlideConfig): HTMLElement\n\t{\n\t\tconst slide = Tag.render`\n\t\t\t<div class=\"crm-whats-new-slide\">\n\t\t\t\t<img src=\"${slideConfig.innerImage}\" alt=\"\">\n\t\t\t\t<div class=\"crm-whats-new-slide-inner-title\"> ${slideConfig.innerTitle} </div>\n\t\t\t\t<p>${slideConfig.innerDescription}</p>\n\t\t\t</div>\n\t\t`;\n\n\t\tconst buttons = this.#getPrepareSlideButtons(slideConfig);\n\t\tif (buttons.length > 0)\n\t\t{\n\t\t\tconst buttonsContainer = Tag.render`<div class=\"crm-whats-new-slide-buttons\"></div>`;\n\t\t\tDom.append(buttonsContainer, slide);\n\n\t\t\tbuttons.forEach((button) => {\n\t\t\t\tDom.append(button.getContainer(), buttonsContainer);\n\t\t\t});\n\t\t}\n\n\t\treturn slide;\n\t}\n\n\tasync #getBannerDispatcher(): Promise<BannerDispatcher>\n\t{\n\t\tif (this.#bannerDispatcher)\n\t\t{\n\t\t\treturn this.#bannerDispatcher;\n\t\t}\n\n\t\tconst { BannerDispatcher: Dispatcher } = await Runtime.loadExtension('crm.integration.ui.banner-dispatcher');\n\t\tthis.#bannerDispatcher = new Dispatcher();\n\n\t\treturn this.#bannerDispatcher;\n\t}\n\n\t#getPrepareSlideButtons(slideConfig: SlideConfig): Button[]\n\t{\n\t\tlet buttons = [];\n\t\tif (slideConfig.buttons)\n\t\t{\n\t\t\tconst className = 'ui-btn ui-btn-primary ui-btn-hover ui-btn-round ';\n\n\t\t\tbuttons = slideConfig.buttons.map((buttonConfig) => {\n\t\t\t\tconst config = {\n\t\t\t\t\tclassName: className + (buttonConfig.className ?? ''),\n\t\t\t\t\ttext: buttonConfig.text,\n\t\t\t\t};\n\n\t\t\t\tif (buttonConfig.onClickClose)\n\t\t\t\t{\n\t\t\t\t\tconfig.onclick = () => this.onClickClose();\n\t\t\t\t}\n\t\t\t\telse if (buttonConfig.helpDeskCode)\n\t\t\t\t{\n\t\t\t\t\tconfig.onclick = () => this.#showHelpDesk(buttonConfig.helpDeskCode);\n\t\t\t\t}\n\n\t\t\t\treturn new Button(config);\n\t\t\t});\n\t\t}\n\n\t\treturn buttons;\n\t}\n\n\t#prepareSteps(stepsConfig): void\n\t{\n\t\tthis.#steps = stepsConfig.map((stepConfig: StepConfig) => {\n\t\t\tconst step = {\n\t\t\t\tid: stepConfig.id,\n\t\t\t\ttitle: stepConfig.title,\n\t\t\t\ttext: stepConfig.text,\n\t\t\t\tposition: stepConfig.position,\n\t\t\t\tarticle: stepConfig.article,\n\t\t\t\tarticleAnchor: stepConfig.articleAnchor ?? null,\n\t\t\t\tinfoHelperCode: stepConfig.infoHelperCode,\n\t\t\t\tbuttons: stepConfig.buttons,\n\t\t\t\thighlighter: stepConfig.highlighter ?? null,\n\t\t\t\tautoscroll: stepConfig.autoscroll ?? null,\n\t\t\t\ticonSrc: stepConfig.iconSrc ?? null,\n\t\t\t};\n\n\t\t\tif (stepConfig.useDynamicTarget)\n\t\t\t{\n\t\t\t\tconst eventName = (stepConfig.eventName ?? this.#getDefaultStepEventName(step.id));\n\t\t\t\tEventEmitter.subscribeOnce(eventName, this.#showStepByEvent.bind(this));\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tconst target = this.#getAvailableTarget(stepConfig.target);\n\t\t\t\tif (target && Dom.style(target, 'display') !== 'none')\n\t\t\t\t{\n\t\t\t\t\tstep.target = stepConfig.target;\n\t\t\t\t}\n\t\t\t\telse if (Type.isArrayFilled(stepConfig.reserveTargets))\n\t\t\t\t{\n\t\t\t\t\tconst isFound = stepConfig.reserveTargets.some((reserveTarget) => {\n\t\t\t\t\t\tconst reserveTargetElement = this.#getAvailableTarget(reserveTarget);\n\t\t\t\t\t\tif (reserveTargetElement && Dom.style(reserveTargetElement, 'display') !== 'none')\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tstep.target = reserveTarget;\n\n\t\t\t\t\t\t\treturn true;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\treturn false;\n\t\t\t\t\t});\n\n\t\t\t\t\tif (!isFound && stepConfig.ignoreIfTargetNotFound)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn null;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telse if (stepConfig.ignoreIfTargetNotFound)\n\t\t\t\t{\n\t\t\t\t\treturn null;\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\tstep.target = stepConfig.target;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\treturn step;\n\t\t});\n\n\t\tthis.#steps = this.#steps.filter((step: ?Object) => step !== null);\n\t\tif (this.#steps.length > 0)\n\t\t{\n\t\t\tthis.tourPromise = Runtime.loadExtension('ui.tour');\n\t\t}\n\t}\n\n\t#showStepByEvent(event: BaseEvent): void\n\t{\n\t\tconst { disableBannerDispatcher = false } = this.#options;\n\n\t\tvoid this.tourPromise.then((exports) => {\n\t\t\tconst { stepId, target } = event.data;\n\t\t\t// eslint-disable-next-line no-shadow\n\t\t\tconst step = this.#steps.find((step) => step.id === stepId);\n\t\t\tif (!step)\n\t\t\t{\n\t\t\t\tconsole.error('step not found');\n\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tstep.target = target;\n\t\t\tconst { Guide } = exports;\n\t\t\tconst guide = this.createGuideInstance(Guide, [step], true);\n\n\t\t\tthis.setStepPopupOptions(guide.getPopup());\n\n\t\t\tif (disableBannerDispatcher === false)\n\t\t\t{\n\t\t\t\tthis.#runGuideWithBannerDispatcher(guide);\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tthis.#runGuide(guide);\n\t\t\t}\n\t\t});\n\t}\n\n\t#runGuideWithBannerDispatcher(guide: Object): void\n\t{\n\t\tvoid this.#getBannerDispatcher().then((dispatcher: BannerDispatcher) => {\n\t\t\tdispatcher.toQueue((onDone: Function) => {\n\t\t\t\tthis.#runGuide(guide, onDone);\n\t\t\t});\n\t\t});\n\t}\n\n\t#onGuideFinish(guide: Object, onDone: Function = null): void\n\t{\n\t\tguide.subscribe('UI.Tour.Guide:onFinish', () => {\n\t\t\tthis.save();\n\t\t\tif (onDone)\n\t\t\t{\n\t\t\t\tonDone();\n\t\t\t}\n\t\t});\n\t}\n\n\t#runGuide(guide: Object, onDone: Function = null): void\n\t{\n\t\tlet canShowGuide = !this.#isAnyPopupShown();\n\t\tconst { target } = guide.steps[0];\n\n\t\tif (canShowGuide && Type.isStringFilled(target))\n\t\t{\n\t\t\tcanShowGuide = this.#getAvailableTarget(target) !== null;\n\t\t}\n\n\t\tif (canShowGuide)\n\t\t{\n\t\t\tthis.#onGuideFinish(guide, onDone);\n\n\t\t\tvoid this.#onBeforeShow(guide)\n\t\t\t\t.then(() => {\n\t\t\t\t\tguide.showNextStep();\n\t\t\t\t})\n\t\t\t;\n\t\t}\n\t\telse\n\t\t{\n\t\t\tonDone();\n\t\t}\n\t}\n\n\t#getAvailableTarget(target: ?string): HTMLElement\n\t{\n\t\tif (!Type.isStringFilled(target))\n\t\t{\n\t\t\treturn null;\n\t\t}\n\n\t\tconst targetNode = document.querySelector(target);\n\n\t\treturn Type.isDomNode(targetNode) ? targetNode : null;\n\t}\n\n\t#getDefaultStepEventName(stepId: string): string\n\t{\n\t\treturn `Crm.WhatsNew::onTargetSetted::${stepId}`;\n\t}\n\n\t#isMultipleViewsAllowed(): boolean\n\t{\n\t\treturn this.#options.numberOfViewsLimit > 1;\n\t}\n\n\tonClickCloseHandler(): void\n\t{\n\t\tconst lastPosition = this.#popup.getLastPosition();\n\t\tconst currentPosition = this.#popup.getPositionBySlide(this.#popup.getCurrentSlide());\n\t\tif (currentPosition >= lastPosition)\n\t\t{\n\t\t\tthis.#popup.destroy();\n\t\t}\n\t\telse\n\t\t{\n\t\t\tthis.#popup.selectNextSlide();\n\t\t}\n\t}\n\n\t#showHelpDesk(code: string): void\n\t{\n\t\tif (top.BX.Helper)\n\t\t{\n\t\t\ttop.BX.Helper.show(`redirect=detail&code=${code}`);\n\t\t\tevent.preventDefault();\n\t\t}\n\t}\n\n\t#executeWhatsNew(): void\n\t{\n\t\tconst { disableBannerDispatcher = false } = this.#options;\n\n\t\tif (this.#isAnyPopupShown())\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tvoid this.whatNewPromise.then((exports) => {\n\t\t\tconst { WhatsNew } = exports;\n\t\t\tthis.#popup = new WhatsNew({\n\t\t\t\tslides: this.#slides,\n\t\t\t\tpopupOptions: {\n\t\t\t\t\theight: 440,\n\t\t\t\t},\n\t\t\t\tevents: {\n\t\t\t\t\tonDestroy: () => {\n\t\t\t\t\t\tthis.save();\n\t\t\t\t\t\tthis.#executeGuide(false);\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t});\n\n\t\t\tif (disableBannerDispatcher === false)\n\t\t\t{\n\t\t\t\t// eslint-disable-next-line promise/no-nesting\n\t\t\t\tvoid this.#getBannerDispatcher().then((dispatcher: BannerDispatcher) => {\n\t\t\t\t\tdispatcher.toQueue((onDone: Function) => {\n\t\t\t\t\t\tthis.#popup.subscribe('onDestroy', onDone);\n\t\t\t\t\t\tthis.#popup.show();\n\t\t\t\t\t});\n\t\t\t\t});\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tthis.#popup.show();\n\t\t\t}\n\n\t\t\tActionViewMode.whatsNewInstances.push(this.#popup);\n\t\t}, this);\n\t}\n\n\t#executeGuide(isAddToQueue: boolean = true): void\n\t{\n\t\tconst { disableBannerDispatcher = false } = this.#options;\n\t\tlet steps = clone(this.#steps);\n\n\t\tsteps = steps.filter((step) => Boolean(step.target));\n\n\t\tif (steps.length === 0)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tvoid this.tourPromise.then((exports) => {\n\t\t\tif (ActionViewMode.tourInstances.some((existedGuide) => existedGuide.getPopup()?.isShown()))\n\t\t\t{\n\t\t\t\treturn; // do not allow many guides at the same time\n\t\t\t}\n\n\t\t\tif (this.#isAnyPopupShown())\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst { Guide } = exports;\n\t\t\tconst guide = this.createGuideInstance(Guide, steps, (this.#steps.length <= 1));\n\t\t\tActionViewMode.tourInstances.push(guide);\n\n\t\t\tthis.setStepPopupOptions(guide.getPopup());\n\n\t\t\tif (isAddToQueue)\n\t\t\t{\n\t\t\t\tif (disableBannerDispatcher === false)\n\t\t\t\t{\n\t\t\t\t\tthis.#runGuideWithBannerDispatcher(guide);\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\tthis.#runGuide(guide);\n\t\t\t\t}\n\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tthis.#showGuide(guide);\n\t\t});\n\t}\n\n\t#isAnyPopupShown(): boolean\n\t{\n\t\treturn PopupManager?.isAnyPopupShown();\n\t}\n\n\t#showGuide(guide: UIGuide): void\n\t{\n\t\tif (guide.steps.length > 1 || this.#options.showOverlayFromFirstStep)\n\t\t{\n\t\t\tguide.start();\n\t\t}\n\t\telse\n\t\t{\n\t\t\tguide.showNextStep();\n\t\t}\n\t}\n\n\tcreateGuideInstance(Guide, steps: Array<Step>, onEvents: boolean): Object\n\t{\n\t\tconst guide = new Guide({\n\t\t\tonEvents,\n\t\t\tcanShowWithoutTarget: this.#options.canShowWithoutTarget ?? false,\n\t\t\tsteps: steps.map((step) => {\n\t\t\t\tlet highlighter = null;\n\t\t\t\tif (Type.isPlainObject(step.highlighter))\n\t\t\t\t{\n\t\t\t\t\thighlighter = step.highlighter;\n\t\t\t\t\t// eslint-disable-next-line no-param-reassign\n\t\t\t\t\tdelete step.highlighter;\n\t\t\t\t}\n\n\t\t\t\tif (Type.isPlainObject(step.autoscroll))\n\t\t\t\t{\n\t\t\t\t\tthis.#autoscroll = step.autoscroll;\n\t\t\t\t\t// eslint-disable-next-line no-param-reassign\n\t\t\t\t\tdelete step.autoscroll;\n\t\t\t\t}\n\n\t\t\t\treturn {\n\t\t\t\t\t...step,\n\t\t\t\t\t// why here and not in prepareSteps?\n\t\t\t\t\t// we need a guide instance reference\n\t\t\t\t\tbuttons: step.buttons?.map((button) => {\n\t\t\t\t\t\treturn {\n\t\t\t\t\t\t\ttext: button.text,\n\t\t\t\t\t\t\tevent: () => {\n\t\t\t\t\t\t\t\tif (Type.isStringFilled(button.onclick?.code))\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t// eslint-disable-next-line no-eval\n\t\t\t\t\t\t\t\t\teval(button.onclick.code);\n\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\tif (button.onclick?.closeAfterClick)\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\tguide.close();\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t};\n\t\t\t\t\t}),\n\t\t\t\t\tevents: {\n\t\t\t\t\t\tonShow: (event) => {\n\t\t\t\t\t\t\tconst { data } = event;\n\t\t\t\t\t\t\tif (!data)\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t// custom air design for single step tours. Remove after ui implemented\n\t\t\t\t\t\t\tif (data.guide.steps.length === 1)\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tlet airClassList = 'crm-whats-new-slide-air';\n\t\t\t\t\t\t\t\tif (Type.isArrayFilled(data.guide.steps[0].buttons))\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\tairClassList += ' --with-buttons';\n\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\tif (Type.isStringFilled(data.guide.steps[0].iconSrc))\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\tairClassList += ' --with-icon';\n\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\tDom.addClass(data.guide.getPopup().getPopupContainer(), airClassList);\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\tif (!highlighter)\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\tvoid BX.Runtime.loadExtension('ui.system.highlighter').then(() => {\n\t\t\t\t\t\t\t\tdocument.querySelectorAll(highlighter.target).forEach((item) => {\n\t\t\t\t\t\t\t\t\tconst element = Tag.render`<span class=\"ui-highlighter\"></span>`;\n\n\t\t\t\t\t\t\t\t\tif (Type.isNumber(highlighter.radius))\n\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\tDom.style(element, '--ui-highlighter-radius', `${highlighter.radius}px`);\n\t\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\t\tDom.append(element, item);\n\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t},\n\t\t\t\t\t\tonClose: () => {\n\t\t\t\t\t\t\tif (!highlighter)\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\tdocument.querySelectorAll(highlighter.target).forEach((item) => {\n\t\t\t\t\t\t\t\tDom.remove(item.querySelector('.ui-highlighter'));\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t};\n\t\t\t}),\n\t\t\tevents: {\n\t\t\t\tonFinish: () => {\n\t\t\t\t\tif (this.#slides.length === 0)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.save();\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t},\n\t\t});\n\n\t\treturn guide;\n\t}\n\n\t#onBeforeShow(guide: UIGuide): Promise<void>\n\t{\n\t\tif (!Type.isPlainObject(this.#autoscroll))\n\t\t{\n\t\t\treturn Promise.resolve();\n\t\t}\n\n\t\tconst step = guide.steps[0];\n\t\tconst targetNode = this.#getAvailableTarget(step.target);\n\t\tif (targetNode === null || this.#isVisibleTargetNode(targetNode))\n\t\t{\n\t\t\treturn Promise.resolve();\n\t\t}\n\n\t\tlet parentScrolledContainer = window;\n\t\tlet parent = targetNode.parentElement;\n\n\t\twhile (parent)\n\t\t{\n\t\t\tconst style = window.getComputedStyle(parent);\n\t\t\tconst overflowY = style.overflowY;\n\n\t\t\tif (\n\t\t\t\t(overflowY === 'auto' || overflowY === 'scroll')\n\t\t\t\t&& parent.scrollHeight >= parent.clientHeight\n\t\t\t)\n\t\t\t{\n\t\t\t\tparentScrolledContainer = parent;\n\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\tparent = parent.parentElement;\n\t\t}\n\n\t\treturn new Promise((resolve) => {\n\t\t\tconst scrollTop = this.#getTargetNodeScrollTop(targetNode, parentScrolledContainer);\n\n\t\t\tif (this.#autoscroll.behavior === 'smooth' && 'scrollTo' in parentScrolledContainer)\n\t\t\t{\n\t\t\t\tvoid this\n\t\t\t\t\t.#scrollToWithPromise(parentScrolledContainer, { top: scrollTop, behavior: 'smooth' })\n\t\t\t\t\t.then(() => {\n\t\t\t\t\t\tresolve();\n\t\t\t\t\t})\n\t\t\t\t;\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tparent.scrollTop = scrollTop;\n\t\t\t\tguide.getPopup().adjustPosition({ forceBindPosition: true });\n\t\t\t\tresolve();\n\t\t\t}\n\t\t});\n\t}\n\n\t#isVisibleTargetNode(targetNode: HTMLElement): boolean\n\t{\n\t\tconst rect = targetNode.getBoundingClientRect();\n\n\t\treturn rect.top >= 0\n\t\t\t&& rect.left >= 0\n\t\t\t&& rect.bottom >= 0\n\t\t\t&& rect.bottom <= ((window.innerHeight || document.documentElement.clientHeight) - 200)\n\t\t\t&& rect.right <= ((window.innerWidth || document.documentElement.clientWidth) - 200)\n\t\t;\n\t}\n\n\t#getTargetNodeScrollTop(targetNode: HTMLElement, parentScrolledContainer: HTMLElement): number\n\t{\n\t\tconst elementTop = targetNode.offsetTop;\n\t\tconst elementHeight = targetNode.offsetHeight;\n\t\tconst containerHeight = parentScrolledContainer.clientHeight;\n\n\t\tconst block = this.#autoscroll.position ?? 'auto';\n\n\t\tconst getMaxScrollTop = (scrollTop: number) => {\n\t\t\treturn Math.max(0, Math.min(scrollTop, parentScrolledContainer.scrollHeight - containerHeight));\n\t\t};\n\n\t\tlet scrollTop = parentScrolledContainer.scrollTop;\n\n\t\tif (block === 'start')\n\t\t{\n\t\t\treturn getMaxScrollTop(elementTop);\n\t\t}\n\n\t\tif (block === 'center')\n\t\t{\n\t\t\treturn getMaxScrollTop(elementTop + elementHeight / 2 - containerHeight / 2);\n\t\t}\n\n\t\tif (block === 'end')\n\t\t{\n\t\t\treturn getMaxScrollTop(elementTop + elementHeight - containerHeight);\n\t\t}\n\n\t\tconst currentViewTop = parentScrolledContainer.scrollTop;\n\t\tconst currentViewBottom = currentViewTop + containerHeight;\n\n\t\tif (elementTop < currentViewTop)\n\t\t{\n\t\t\tscrollTop = elementTop;\n\t\t}\n\t\telse if (elementTop + elementHeight > currentViewBottom)\n\t\t{\n\t\t\tscrollTop = elementTop + elementHeight - containerHeight;\n\t\t}\n\n\t\treturn getMaxScrollTop(scrollTop);\n\t}\n\n\t#scrollToWithPromise(element: HTMLElement, options: Object): Promise<void>\n\t{\n\t\treturn new Promise((resolve) => {\n\t\t\tconst targetTop = options.top ?? element.scrollTop;\n\t\t\tconst targetLeft = options.left ?? element.scrollLeft;\n\t\t\tconst behavior = options.behavior ?? 'auto';\n\t\t\tconst tolerance = 1;\n\n\t\t\tif (behavior === 'auto')\n\t\t\t{\n\t\t\t\telement.scrollTo(options);\n\t\t\t\tresolve();\n\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tlet lastTop = element.scrollTop;\n\t\t\tlet lastLeft = element.scrollLeft;\n\t\t\tlet stationaryFrames = 0;\n\n\t\t\tconst isClose = (a: number, b: number): boolean => Math.abs(a - b) <= tolerance;\n\n\t\t\tconst checkScrollEnd = () => {\n\t\t\t\tconst currentTop = element.scrollTop;\n\t\t\t\tconst currentLeft = element.scrollLeft;\n\n\t\t\t\tconst reachedTarget = isClose(currentTop, targetTop) && isClose(currentLeft, targetLeft);\n\t\t\t\tconst stoppedMoving = isClose(currentTop, lastTop) && isClose(currentLeft, lastLeft);\n\n\t\t\t\tif (reachedTarget && stoppedMoving)\n\t\t\t\t{\n\t\t\t\t\tstationaryFrames++;\n\t\t\t\t\tif (stationaryFrames >= 2)\n\t\t\t\t\t{\n\t\t\t\t\t\tresolve();\n\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\tstationaryFrames = 0;\n\t\t\t\t}\n\n\t\t\t\tlastTop = currentTop;\n\t\t\t\tlastLeft = currentLeft;\n\n\t\t\t\trequestAnimationFrame(checkScrollEnd);\n\t\t\t};\n\n\t\t\telement.scrollTo(options);\n\n\t\t\trequestAnimationFrame(checkScrollEnd);\n\t\t});\n\t}\n\n\tsetStepPopupOptions(popup: Popup): void\n\t{\n\t\tconst { steps, hideTourOnMissClick = false } = this.#options;\n\n\t\tpopup.setAutoHide(hideTourOnMissClick);\n\n\t\tif (steps?.popup?.width)\n\t\t{\n\t\t\tpopup.setWidth(steps.popup.width);\n\t\t}\n\t}\n\n\tsave(): void\n\t{\n\t\tAjax.runAction('crm.settings.tour.updateOption', {\n\t\t\tjson: {\n\t\t\t\tcategory: this.#closeOptionCategory,\n\t\t\t\tname: this.#closeOptionName,\n\t\t\t\toptions: {\n\t\t\t\t\tisMultipleViewsAllowed: !this.#isViewHappened && this.#isMultipleViewsAllowed(),\n\t\t\t\t\tnumberOfViewsLimit: this.#options.numberOfViewsLimit ?? 1,\n\t\t\t\t\tadditionalTourIdsForDisable: this.#options.additionalTourIdsForDisable ?? null,\n\t\t\t\t},\n\t\t\t},\n\t\t}).then(({ data }) => {\n\t\t\tthis.#options.isNumberOfViewsExceeded = data.isNumberOfViewsExceeded;\n\t\t\tthis.#isViewHappened = true;\n\t\t}).catch((errors) => {\n\t\t\tconsole.error('Could not save tour settings', errors);\n\t\t});\n\t}\n\n\tstatic tourInstances = [];\n\tstatic whatsNewInstances = [];\n}\n\nnamespaceCrmWhatsNew.ActionViewMode = ActionViewMode;\n"],"names":["namespaceCrmWhatsNew","Reflection","namespace","ActionViewMode","slides","steps","options","closeOptionCategory","closeOptionName","slideClassName","Type","isString","onClickClose","onClickCloseHandler","bind","whatNewPromise","tourPromise","isNumberOfViewsExceeded","console","warn","length","lastPosition","getLastPosition","currentPosition","getPositionBySlide","getCurrentSlide","destroy","selectNextSlide","Guide","onEvents","guide","canShowWithoutTarget","map","step","highlighter","isPlainObject","autoscroll","buttons","button","text","event","isStringFilled","onclick","code","eval","closeAfterClick","close","events","onShow","data","airClassList","isArrayFilled","iconSrc","Dom","addClass","getPopup","getPopupContainer","BX","Runtime","loadExtension","then","document","querySelectorAll","target","forEach","item","element","Tag","render","isNumber","radius","style","append","onClose","remove","querySelector","onFinish","save","popup","hideTourOnMissClick","setAutoHide","width","setWidth","Ajax","runAction","json","category","name","isMultipleViewsAllowed","numberOfViewsLimit","additionalTourIdsForDisable","errors","error","slideConfigs","slideConfig","className","title","html","slide","innerImage","innerTitle","innerDescription","buttonsContainer","getContainer","Dispatcher","BannerDispatcher","buttonConfig","config","helpDeskCode","Button","stepsConfig","stepConfig","id","position","article","articleAnchor","infoHelperCode","useDynamicTarget","eventName","EventEmitter","subscribeOnce","reserveTargets","isFound","some","reserveTarget","reserveTargetElement","ignoreIfTargetNotFound","filter","disableBannerDispatcher","exports","stepId","find","createGuideInstance","setStepPopupOptions","dispatcher","toQueue","onDone","subscribe","canShowGuide","showNextStep","targetNode","isDomNode","top","Helper","show","preventDefault","WhatsNew","popupOptions","height","onDestroy","whatsNewInstances","push","isAddToQueue","clone","Boolean","tourInstances","existedGuide","isShown","PopupManager","isAnyPopupShown","showOverlayFromFirstStep","start","Promise","resolve","parentScrolledContainer","window","parent","parentElement","getComputedStyle","overflowY","scrollHeight","clientHeight","scrollTop","behavior","adjustPosition","forceBindPosition","rect","getBoundingClientRect","left","bottom","innerHeight","documentElement","right","innerWidth","clientWidth","elementTop","offsetTop","elementHeight","offsetHeight","containerHeight","block","getMaxScrollTop","Math","max","min","currentViewTop","currentViewBottom","targetTop","targetLeft","scrollLeft","tolerance","scrollTo","lastTop","lastLeft","stationaryFrames","isClose","a","b","abs","checkScrollEnd","currentTop","currentLeft","reachedTarget","stoppedMoving","requestAnimationFrame"],"mappings":"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"}