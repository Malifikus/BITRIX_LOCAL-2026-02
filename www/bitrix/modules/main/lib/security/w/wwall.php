<? namespace Bitrix\Main\Security\W;$GLOBALS['____1103511213']= array(base64_decode('dGltZQ='.'='),base64_decode(''.'dGltZQ'.'=='),base64_decode(''.'a'.'nNvbl'.'9kZWNvZG'.'U'.'='),base64_decode('YXJ'.'yYXlfbWVy'.'Z2U='),base64_decode('a'.'m9pb'.'g=='),base64_decode('am9p'.'bg='.'='),base64_decode(''.'a'.'m9pbg=='),base64_decode('Y'.'XJyYXlfcG9w'),base64_decode('YXJy'.'YXlfc2hpZn'.'Q='),base64_decode(''.'YXJyYXlfc2'.'hpZnQ='),base64_decode('YXJyYXlfc'.'2h'.'pZnQ='),base64_decode('YXJyYXlf'.'c2'.'hp'.'Zn'.'Q='),base64_decode('YXJy'.'YX'.'l'.'fbW'.'VyZ2U='),base64_decode('aX'.'NfY'.'X'.'JyYXk'.'='),base64_decode('YX'.'Jy'.'Y'.'X'.'lfbWVyZ2U='),base64_decode(''.'aW5'.'fYXJyYXk='),base64_decode('a'.'W5f'.'YXJyYXk='),base64_decode('aW5fYXJy'.'YXk='),base64_decode('a'.'W'.'5'.'fYXJ'.'yYX'.'k='),base64_decode('aW'.'5fYXJ'.'yY'.'Xk='),base64_decode('dGlt'.'ZQ=='),base64_decode('dGltZQ=='),base64_decode('YXJ'.'yYXl'.'fbW'.'Fw'),base64_decode('Z2V'.'0X2'.'xvYWR'.'lZF9leHRl'.'bnNpb2'.'5z'),base64_decode(''.'anNv'.'bl9l'.'bm'.'NvZG'.'U='),base64_decode('an'.'N'.'vbl9lbmNvZG'.'U'.'='),base64_decode('cG'.'hwdmV'.'yc2lvb'.'g=='),base64_decode(''.'an'.'Nvbl9lbmNvZ'.'GU='),base64_decode('am9pbg=='));if(!function_exists(__NAMESPACE__.'\\___495261851')){function ___495261851($_746331998){static $_725899232= false; if($_725899232 == false) $_725899232=array(''.'V1dBTEx'.'fTE9DS'.'w==','c2VjdX'.'JpdHk=','REFUQQ==','eyI=',''.'V1d'.'BTEx'.'fTE9DSw==','c2VjdXJp'.'dHk=','U'.'0VDVV'.'JJVFlfV'.'1dBT'.'Ex'.'f'.'RVh'.'DRVBUS'.'U9'.'O','RkF'.'JTF'.'9D'.'SEVDS0l'.'ORw'.'==','Q2F'.'uIG5vd'.'CBleG'.'VjdXRlI'.'Hd'.'3'.'YWxsIHJ1'.'bG'.'VzOiA=','IFRyY'.'WNlOiA=','UkVRVUVTVF'.'9'.'VUkk=','a2V5cw==','d'.'mFsdWV'.'z','U0VDVV'.'JJ'.'VFlfV'.'1'.'dBTExf'.'TU9'.'ES'.'UZZ',''.'Lg==','U0VDVVJJV'.'FlfV1dB'.'TExfV'.'U5T'.'RV'.'Q=',''.'Lg'.'==',''.'U0'.'V'.'DV'.'VJJVF'.'lfV1dBTExf'.'RV'.'h'.'J'.'VA==','Lg==',''.'Z2x'.'vY'.'m'.'Fs','a2V'.'5'.'cw'.'==','dmF'.'s'.'dWVz','Z2V'.'0','Z'.'2V0','cG9zd'.'A='.'=','cG9zd'.'A==','Y'.'29va2'.'ll','Y29va2ll',''.'cm'.'Vxd'.'W'.'VzdA='.'=','cmVx'.'dW'.'VzdA'.'==','Z2xvYmFs','Z'.'2xv'.'YmFs','bWF'.'pbl9z'.'ZW'.'M=','V1dBTExfQ'.'U'.'NUVU'.'FM'.'S'.'VpFX1JVTEVT','d'.'g'.'==','dmVyc2l'.'vbg==','a'.'Q='.'=','aX'.'NJbnN0'.'YWx'.'sZWQ=','dg='.'=','aW5'.'p','b'.'W9kdWxlcw==',''.'b'.'GljZW5'.'zZQ='.'=','cGhw',''.'dg='.'=','ZX'.'h0','c2'.'VjdX'.'Jpd'.'Hk=',''.'Z'.'GI'.'=','dHlwZQ='.'=',''.'ZGI=','dmV'.'y'.'c2lvbg==','ZGI=','dH'.'lw'.'ZQ==','ZG'.'I=',''.'d'.'HlwZQ'.'==','dmVyc2l'.'vbg'.'==',''.'Z'.'GI'.'=','dm'.'V'.'yc2'.'lvbg==',''.'ZW'.'52'.'a'.'XJvbm1lbnQ'.'=',''.'dm1fd'.'mVyc2lvb'.'g==','dm0=','dg==','ZW5'.'2aXJv'.'bm1l'.'bnQ=','dm'.'1fdmVyc2'.'lvbg==','c'.'2'.'9'.'ja'.'2V0VGltZW'.'91dA'.'='.'=','c'.'3'.'RyZWFtVG'.'l'.'tZW91dA='.'=','KCc=','ZGF0'.'YQ'.'='.'=','Jy'.'wgJw==','bW9kdW'.'xl','Jy'.'wgJw==','bW'.'9kdWxlX3ZlcnNpb24=','Jyk=','L'.'CA=','U0VD'.'VVJJ'.'VFlfV'.'1dBTExfRVhDRVBUSU'.'9O','bWF'.'pbg='.'=','RkFJTF9SR'.'UZ'.'SRV'.'NIS'.'U5H','Q2FuI'.'G5vdCBy'.'ZWZyZXNoIHd3YWxsI'.'HJ'.'1bG'.'VzO'.'i'.'A'.'=','IFRyYWN'.'lOiA=','ZGF0Y'.'Q'.'==','eyI=','LS0tLS1CRUdJTi'.'BQ'.'VUJM'.'SUMg'.'S0VZL'.'S0'.'tLS0'.'=','C'.'k1J'.'SUJ'.'J'.'akFOQmdr'.'cWhraUc5'.'d'.'zBC'.'QV'.'FFR'.'k'.'FBT0NBU'.'ThBT'.'UlJQkNnS0NBUU'.'V'.'BcT'.'h'.'R'.'R'.'TBIam1'.'I'.'SlVTd'.'F'.'d'.'WNm4wemE'.'KU'.'l'.'Z'.'vTHgwMkt'.'6Ym'.'ZyYlMv'.'UDZzV2F'.'4VHp3'.'O'.'FNl'.'R1R'.'0YlRDT3'.'JwSG'.'k1UUY2T'.'1'.'J'.'5'.'alovWHh6'.'L0tMVTF'.'HYm9m'.'OUNaMw'.'o0ej'.'dTa3'.'FV'.'dDY2aWJYd'.'k'.'9'.'GQ'.'ng0ZncvQ'.'V'.'BQU'.'kdE'.'cX'.'RtMG5EM'.'2ZnR3'.'N'.'1M1JlUGd3MjlpOC'.'t2bTdtdEJ'.'LSlVZbD'.'RyClZwYjZzZ'.'l'.'p'.'FV'.'DlLRWI'.'2VDFIRFltRXZj'.'M'.'Wh'.'xL2lpdXl4THJaWmk1'.'UT'.'ZVZmY0'.'VU'.'V2VEk'.'rNjhzc'.'0ZSa1Er'.'b3dUU'.'nkKZU'.'9JT'.'WJ'.'G'.'aE0vVVRtZ'.'lZ'.'ZY'.'lRS'.'Rn'.'kyb1VROFdNemEybko1U2FoemkxVUtPMWpB'.'al'.'hUUF'.'JyemM3'.'QWp1NjM5aj'.'FPMApwcHFmbTV4Z1dsRkFK'.'a0hRVG'.'diZ'.'GQ1QVdxRE'.'ZRa3Q5SEt'.'r'.'WStUbmZCTEdWTXZ'.'We'.'VB3V'.'Eh'.'OV1'.'F'.'Z'.'QXc0eHBnL'.'3dBClp3SURB'.'UUF'.'CCi'.'0t'.'L'.'S0t'.'RU5EIFB'.'VQk'.'xJ'.'QyBL'.'RVktLS0'.'tLQ==');return base64_decode($_725899232[$_746331998]);}}; use Bitrix\Main\Application; use Bitrix\Main\Config\Option; use Bitrix\Main\Data\Cache; use Bitrix\Main\Loader; use Bitrix\Main\ModuleManager; use Bitrix\Main\Security\PublicKeyCipher; use Bitrix\Main\SystemException; use Bitrix\Main\Web\HttpClient; use Bitrix\Main\Web\Json; use Bitrix\Main\Security\W\Rules\Rule; use Bitrix\Main\Security\W\Rules\Results\RuleAction; use Bitrix\Main\Security\W\Rules\Results\RuleResult; use Bitrix\Main\Security\W\Rules\Results\CheckResult; use Bitrix\Main\Security\W\Rules\Results\ModifyResult; use Bitrix\Main\Type\ArrayHelper; use Bitrix\Main\Security\W\Rules\RuleRecordTable; use Bitrix\Main\License\UrlProvider; use CSecuritySystemInformation; use ReflectionExtension; class WWall{ const CACHE_RULES_TTL= 10800; protected $_1591697145= true; public function handle(){ try{  $_592768965= RuleRecordTable::getList([ 'cache' =>['ttl' => 3600* 24* 7]])->fetchAll(); if(empty($_592768965)){ return;}  $_215316790= Cache::createInstance(); $_1938578146= false; if($_215316790->initCache(static::CACHE_RULES_TTL, 'WWALL_LOCK', 'security')){ $_1210995862= $_215316790->getVars(); if($GLOBALS['____1103511213'][0]()- $_1210995862> round(0+5+5+5+5)){  $_1889188860= Application::getConnection(); $_810101414= RuleRecordTable::getTableName(); $_1889188860->truncateTable($_810101414); RuleRecordTable::cleanCache(); $_215316790->clean(___495261851(0), ___495261851(1));}} elseif($_215316790->startDataCache()){  $_215316790->endDataCache($GLOBALS['____1103511213'][1]()); $_1938578146= true;} foreach($_592768965 as $_1420113117){ $_276356673= new PublicKeyCipher; $_2147144626= $_276356673->decrypt($_1420113117[___495261851(2)], static::__1092667207()); if(!str_starts_with($_2147144626, ___495261851(3))){ continue;} $_99029353= $GLOBALS['____1103511213'][2]($_2147144626, true); if(!empty($_99029353)){ $_2068919229= Rule::make($_99029353); $_1101636655= $this->handleRule($_2068919229); $this->applyHandlingResults($_1101636655);}}  if($_1938578146){ $_215316790->clean(___495261851(4), ___495261851(5));}} catch(\Throwable $_385201980){ $this->logEvent( ___495261851(6), ___495261851(7), ___495261851(8). $_385201980->getMessage(). ___495261851(9). $_385201980->getTraceAsString());}}  public function handleRule(Rule $_2068919229): array{ $_1101636655=[]; if($_2068919229->matchPath($_SERVER[___495261851(10)])){  $_521536180= $this->getContextElements($_2068919229->getContext()); foreach($_521536180 as $_1069148407 => &$_1307198482){ $_1101636655= $GLOBALS['____1103511213'][3]($_1101636655, $this->recursiveContextKeyHandle($_1069148407, $_1307198482,[], $_2068919229));}} return $_1101636655;}  public function applyHandlingResults(array $_1101636655){ $_521536180= $this->getContextElements([ 'get', 'post', 'cookie', 'request', 'global']); foreach($_1101636655 as $_709864052){ $_1307198482=& $_521536180[$_709864052->getContextName()]; $_1856431510= $_709864052->getRuleResult(); $_2068919229= $_709864052->getRule(); if($_1856431510 instanceof ModifyResult){ if($_2068919229->getProcess() === ___495261851(11)){  static::rewriteContextKey( $_709864052->getContextName(), $_1307198482, $_709864052->getContextKey(), $_1856431510->getCleanValue());} elseif($_2068919229->getProcess() === ___495261851(12)){ static::rewriteContextValue( $_709864052->getContextName(), $_1307198482, $_709864052->getContextKey(), $_1856431510->getCleanValue());} $this->logEvent( ___495261851(13), $_709864052->getContextName(), $GLOBALS['____1103511213'][4](___495261851(14), $_709864052->getContextKey()));} elseif($_1856431510 instanceof CheckResult &&!$_1856431510->isSuccess()){ if($_1856431510->getAction() === RuleAction::UNSET){ static::unsetContextValue( $_709864052->getContextName(), $_1307198482, $_709864052->getContextKey(),); $this->logEvent( ___495261851(15), $_709864052->getContextName(), $GLOBALS['____1103511213'][5](___495261851(16), $_709864052->getContextKey()));} elseif($_1856431510->getAction() === RuleAction::EXIT){ $this->logEvent( ___495261851(17), $_709864052->getContextName(), $GLOBALS['____1103511213'][6](___495261851(18), $_709864052->getContextKey())); exit;}}}} public function disableEventLogging(){ $this->_1591697145= false;} protected function rewriteContextKey($_1069148407, &$_1307198482, $_1648101142, $_22511702){ $_246658662= $_1648101142;  $GLOBALS['____1103511213'][7]($_246658662); $_246658662[]= $_22511702; if($_1069148407 === ___495261851(19)){ $_1000216802= $GLOBALS['____1103511213'][8]($_1648101142); $GLOBALS['____1103511213'][9]($_246658662); if(empty($_1648101142)){ $GLOBALS[$_22511702]= $GLOBALS[$_1000216802]; unset($GLOBALS[$_1000216802]);} else{ $_1307198482=& $GLOBALS[$_1000216802]; $_1510621371= ArrayHelper::getByNestedKey($_1307198482, $_1648101142);  ArrayHelper::setByNestedKey($_1307198482, $_246658662, $_1510621371);  ArrayHelper::unsetByNestedKey($_1307198482, $_1648101142);}} else{ $_1510621371= ArrayHelper::getByNestedKey($_1307198482, $_1648101142);  ArrayHelper::setByNestedKey($_1307198482, $_246658662, $_1510621371);  ArrayHelper::unsetByNestedKey($_1307198482, $_1648101142);}} protected function rewriteContextValue($_1069148407, &$_1307198482, $_199686973, $_1510621371){ if($_1069148407 === 'global'){ $_1000216802= $GLOBALS['____1103511213'][10]($_199686973); if(empty($_199686973)){ $GLOBALS[$_1000216802]= $_1510621371;} else{ $_1307198482=& $GLOBALS[$_1000216802]; ArrayHelper::setByNestedKey($_1307198482, $_199686973, $_1510621371);}} else{  ArrayHelper::setByNestedKey($_1307198482, $_199686973, $_1510621371);}} protected function unsetContextValue($_1069148407, &$_1307198482, $_199686973){ if($_1069148407 === 'global'){ $_1000216802= $GLOBALS['____1103511213'][11]($_199686973); if(empty($_199686973)){ unset($GLOBALS[$_1000216802]);} else{ $_1307198482=& $GLOBALS[$_1000216802]; ArrayHelper::unsetByNestedKey($_1307198482, $_199686973);}} else{ ArrayHelper::unsetByNestedKey($_1307198482, $_199686973);}}  protected function recursiveContextKeyHandle(string $_1069148407, array &$_1307198482, array $_509437534, Rule $_2068919229): array{  $_1101636655=[]; foreach($_1307198482 as $_1297543703 => $_1510621371){ $_199686973= $GLOBALS['____1103511213'][12]($_509437534,[$_1297543703]); if($_2068919229->matchKey($_199686973)){  if($_2068919229->getProcess() === ___495261851(20)){ $_1856431510= $_2068919229->evaluate($_1297543703);} elseif($_2068919229->getProcess() === ___495261851(21)){ $_1856431510= $_2068919229->evaluateValue($_1510621371);}  if(!empty($_1856431510) && $_1856431510 instanceof RuleResult){ $_1101636655[]= new HandlingResult($_1069148407, $_199686973, $_1856431510, $_2068919229);}}  if($GLOBALS['____1103511213'][13]($_1510621371)){ $_1101636655= $GLOBALS['____1103511213'][14]($_1101636655, $this->recursiveContextKeyHandle( $_1069148407, $_1307198482[$_1297543703], $_199686973, $_2068919229));}} return $_1101636655;} protected function getContextElements(array $_1672502505){ $_2113418376=[]; if($GLOBALS['____1103511213'][15](___495261851(22), $_1672502505, true)){ $_2113418376[___495261851(23)]= &$_GET;} if($GLOBALS['____1103511213'][16](___495261851(24), $_1672502505, true)){ $_2113418376[___495261851(25)]= &$_POST;} if($GLOBALS['____1103511213'][17](___495261851(26), $_1672502505, true)){ $_2113418376[___495261851(27)]= &$_COOKIE;} if($GLOBALS['____1103511213'][18](___495261851(28), $_1672502505, true)){ $_2113418376[___495261851(29)]= &$_REQUEST;} if($GLOBALS['____1103511213'][19](___495261851(30), $_1672502505, true)){ $_2113418376[___495261851(31)]= $GLOBALS;} return $_2113418376;} public static function refreshRules(){ try{ $_429823878= Option::get('main_sec', 'WWALL_ACTUALIZE_RULES', 0); if(($GLOBALS['____1103511213'][20]()- $_429823878)< static::CACHE_RULES_TTL){ return;} Option::set(___495261851(32), ___495261851(33), $GLOBALS['____1103511213'][21]()); $_1145636859= null;  $_567033740= $GLOBALS['____1103511213'][22](function($_1673983744){ return[___495261851(34) => $_1673983744[___495261851(35)], ___495261851(36) => (int) $_1673983744[___495261851(37)]];}, ModuleManager::getModulesFromDisk());  $_383098122=[]; foreach($GLOBALS['____1103511213'][23]() as $_1503946836){ $_793560419= new ReflectionExtension($_1503946836); $_383098122[$_1503946836]=[ ___495261851(38) => $_793560419->getVersion(), ___495261851(39) => $_793560419->getINIEntries()];} $_1308034230=[ ___495261851(40) => $GLOBALS['____1103511213'][24]($_567033740), ___495261851(41) => Application::getInstance()->getLicense()->getHashLicenseKey(), ___495261851(42) => $GLOBALS['____1103511213'][25]([ ___495261851(43) => $GLOBALS['____1103511213'][26](), ___495261851(44) => $_383098122])]; if(Loader::includeModule(___495261851(45))){ $_20689407= CSecuritySystemInformation::getSystemInformation(); if(isset($_20689407[___495261851(46)][___495261851(47)]) && isset($_20689407[___495261851(48)][___495261851(49)])){ $_1308034230[___495261851(50)]=[ ___495261851(51) => $_20689407[___495261851(52)][___495261851(53)], ___495261851(54) => $_20689407[___495261851(55)][___495261851(56)]];} if(isset($_20689407[___495261851(57)][___495261851(58)])){ $_1308034230[___495261851(59)]=[___495261851(60) => $_20689407[___495261851(61)][___495261851(62)]];}}  $_515266263= new HttpClient([ ___495261851(63) => round(0+5), ___495261851(64) => round(0+5)]); $_94623634=(new UrlProvider())->getTechDomain(); $_2072823490="https://wwall.{$_94623634}/rules.php"; $_648186535= $_515266263->post($_2072823490, $_1308034230); if($_515266263->getStatus() == round(0+200) &&!empty($_648186535)){ $_1145636859= Json::decode($_648186535);}  if($_1145636859 !== null){ $_1889188860= Application::getConnection(); $_810101414= RuleRecordTable::getTableName(); if(!empty($_1145636859)){ foreach($_1145636859 as $_2118963497){ if(!static::checkRuleSign($_2118963497)){ throw new SystemException('Invalid sign for rule '.$GLOBALS['____1103511213'][27]($_2118963497));}}}  $_1889188860->truncateTable($_810101414);  if(!empty($_1145636859)){ $_1478212374=[]; foreach($_1145636859 as $_2118963497){ $_1478212374[]= ___495261851(65). $_1889188860->getSqlHelper()->forSql($_2118963497[___495261851(66)]). ___495261851(67). $_1889188860->getSqlHelper()->forSql($_2118963497[___495261851(68)]). ___495261851(69). $_1889188860->getSqlHelper()->forSql($_2118963497[___495261851(70)]). ___495261851(71);} $_1545985646= $GLOBALS['____1103511213'][28](___495261851(72), $_1478212374);  $_1889188860->query("INSERT INTO {$_810101414} (DATA, MODULE, MODULE_VERSION) VALUES {$_1545985646}");  RuleRecordTable::cleanCache();}}} catch(\Throwable $_385201980){ \CEventLog::log( \CEventLog::SEVERITY_SECURITY, ___495261851(73), ___495261851(74), ___495261851(75), ___495261851(76). $_385201980->getMessage(). ___495261851(77). $_385201980->getTraceAsString());}} protected static function checkRuleSign($_2068919229){ $_276356673= new PublicKeyCipher; $_99029353= $_276356673->decrypt($_2068919229[___495261851(78)], static::__1092667207()); return str_starts_with($_99029353, ___495261851(79));} private static function __1092667207(){ $_2106589928= ''; $_2106589928 .= ___495261851(80); $_2106589928 .= ___495261851(81); return $_2106589928;} protected function logEvent($_1992956192, $_1368503344, $_669463261){ if($this->_1591697145){ \CEventLog::log( \CEventLog::SEVERITY_SECURITY, $_1992956192, 'main', $_1368503344, $_669463261);}}}?>