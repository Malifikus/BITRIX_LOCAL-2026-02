jn.define("call/callList/searchController",((e,t,s)=>{const{CallListSearchView:a}=e("call/callList/searchView");const{restCall:r,searchUsers:i}=e("call/callList/utils");const c=40;class h{constructor(e){this.component=e;this.searchView=null;this.searchTimer=null}setupSearch(){BX.onViewLoaded((()=>{const e=this.component.layout||layout;if(!e){return}if(typeof e.setRightButtons==="function"){e.setRightButtons([{type:"search",id:"search",callback:()=>this.openSearch(e)}])}}))}openSearch(e){const t=e&&e.search?e.search:layout&&layout.search?layout.search:null;if(!t){return}this.searchView=new a({onItemClick:e=>this.component.startCall(e)});t.mode="layout";t.show(this.searchView);t.on("textChanged",(({text:e})=>this.onSearchTextChanged(e)));t.on("cancel",(()=>this.onSearchCancel()));t.on("hide",(()=>this.onSearchHide()))}onSearchTextChanged(e){const t=String(e||"");const s=Number(BX.componentParameters.get("SEARCH_MIN_SIZE",3));const a=t.trim().length>=s;this.component.setState({searchQuery:t,isSearchMode:a});if(this.searchTimer){clearTimeout(this.searchTimer)}if(!a){this.applySearchResults(null);this.setLoading(false);return}this.searchTimer=setTimeout((()=>this.performSearch(t)),350)}async performSearch(e){this.setLoading(true);let t=[];let s=[];try{t=await this.searchCalls(e)}catch(e){console.error("[CallList][search][calls][error]",e)}try{const a=this.getExistingUserIds(t);s=await i(e,{limit:10,excludeUserIds:a})}catch(e){console.error("[CallList][search][users][error]",e)}this.applySearchResults([...t,...s]);this.setLoading(false)}async searchCalls(e){const t=await r("call.CallLog.list",{filter:{SEARCH:e},lastId:0,count:c});return t.calls.map((e=>this.component.normalizeCallData(e)))}getExistingUserIds(e){const t=new Set;e.forEach((e=>{if(e.chatType==="private"&&e.dialogId){t.add(e.dialogId)}}));return t}onSearchCancel(){this.component.setState({searchQuery:"",isSearchMode:false,searchItems:null});this.setLoading(false)}onSearchHide(){this.component.setState({searchQuery:"",isSearchMode:false,searchItems:null});if(this.searchView&&typeof this.searchView.setItems==="function"){this.searchView.setItems(null)}this.setLoading(false)}setLoading(e){if(this.searchView?.setLoading){this.searchView.setLoading(e)}}applySearchResults(e){const t=e?Array.isArray(e)?e:[]:null;this.component.setState({searchItems:t});try{if(this.searchView&&typeof this.searchView.setItems==="function"){this.searchView.setItems(t)}}catch(e){console.error("[CallList][search][apply][error]",e)}}cleanup(){if(this.searchTimer){clearTimeout(this.searchTimer);this.searchTimer=null}}}s.exports={SearchController:h}}));
//# sourceMappingURL=extension.map.js