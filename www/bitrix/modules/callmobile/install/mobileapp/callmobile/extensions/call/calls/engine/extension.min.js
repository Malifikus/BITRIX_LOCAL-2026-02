jn.define("call/calls/engine",((e,t,l)=>{const{EntityReady:a}=e("entity-ready");const{EventType:n}=e("call/const");const{CallSettingsManager:s}=e("call/settings-manager");const{BitrixCallJwt:i}=e("call/calls/bitrix-jwt");const{BitrixCallDev:o}=e("call/calls/bitrix-dev");const{BitrixCall:r}=e("call/calls/bitrix");const{PlainCallJwt:c}=e("call/calls/plain-jwt");const{PlainCall:d}=e("call/calls/plain");const{VoximplantCall:u}=e("call/calls/voximplant");const C="/bitrix/js/im/images/blank.gif";const h={createCall:"im.call.create",createChildCall:"im.call.createChildCall",getPublicChannels:"pull.channel.public.list",getCall:"im.call.get",startTrack:"call.Track.start",stopTrack:"call.Track.stop"};const g=10;const v=45;BX.Call={};BX.Call.State={Incoming:"Incoming"};BX.Call.UserState={Idle:"Idle",Busy:"Busy",Calling:"Calling",Unavailable:"Unavailable",Declined:"Declined",Ready:"Ready",Connecting:"Connecting",Connected:"Connected",Failed:"Failed"};BX.Call.JoinStatus={None:"none",Local:"local",Remote:"remote"};BX.Call.Type={Instant:1,Permanent:2};BX.Call.Provider={Plain:"Plain",Voximplant:"Voximplant",Bitrix:"Bitrix"};BX.Call.RoomType={Small:1,Conference:2,Large:3,Personal:4};BX.Call.RecorderStatus={None:0,Ready:1,Enabled:2,Disabled:3,Paused:4,Destroyed:5};BX.Call.ErrorPreventingReconnection={CanNotCreateRoom:1,InputError:2,AccessDenied:3,RoomNotFound:5,MalfunctioningSignaling:7};BX.Call.CallError={SecurityKeyChanged:"SECURITY_KEY_CHANGED",RoomClosed:"ROOM_CLOSED",EmptySignalingUrl:"EMPTY_SIGNALING_URL",EmptyCallToken:"EMPTY_CALL_TOKEN",MediaServerMissingParams:"MEDIA_SERVER_MISSING_PARAMS",MediaServerUnreachable:"MEDIA_SERVER_UNREACHABLE",CallNotFound:"CALL_NOT_FOUND"};BX.Call.StreamTag={Main:"main",Screen:"screen"};BX.Call.Direction={Incoming:"Incoming",Outgoing:"Outgoing"};BX.Call.Quality={VeryHigh:"very_high",High:"high",Medium:"medium",Low:"low",VeryLow:"very_low"};BX.Call.UserMnemonic={all:"all",none:"none"};BX.Call.Event={onUserInvited:"onUserInvited",onUserJoined:"onUserJoined",onUserStateChanged:"onUserStateChanged",onUserMicrophoneState:"onUserMicrophoneState",onUserCameraState:"onUserCameraState",onUserScreenState:"onUserScreenState",onUsersLimitExceeded:"onUsersLimitExceeded",onUserVoiceStarted:"onUserVoiceStarted",onUserVoiceStopped:"onUserVoiceStopped",onUserFloorRequest:"onUserFloorRequest",onUserEmotion:"onUserEmotion",onLocalMediaReceived:"onLocalMediaReceived",onLocalMediaStopped:"onLocalMediaStopped",onDeviceListUpdated:"onDeviceListUpdated",onRTCStatsReceived:"onRTCStatsReceived",onCallFailure:"onCallFailure",onStreamReceived:"onStreamReceived",onStreamRemoved:"onStreamRemoved",onJoin:"onJoin",onLeave:"onLeave",onActive:"onActive",onInactive:"onInactive",onDestroy:"onDestroy",onHangup:"onHangup",onPullEventUserInviteTimeout:"onPullEventUserInviteTimeout",onReconnected:"onReconnected",onSwitchTrackRecordStatus:"onSwitchTrackRecordStatus",onRecorderStatusChanged:"onRecorderStatusChanged",onCallTokenRequest:"onCallTokenRequest",onAllParticipantsVideoMuted:"onAllParticipantsVideoMuted",onAllParticipantsAudioMuted:"onAllParticipantsAudioMuted",onAllParticipantsScreenshareMuted:"onAllParticipantsScreenshareMuted",onRecordState:"onRecordState",onParticipantAudioMuted:"onParticipantAudioMuted",onParticipantVideoMuted:"onParticipantVideoMuted",onParticipantScreenshareMuted:"onParticipantScreenshareMuted",onSwitchConnectionType:"switchConnectionType",onRoomSettingsChanged:"onRoomSettingsChanged",onUserPermissionsChanged:"onUserPermissionsChanged",onCallConnected:"onCallConnected",onActiveCallNotificationSwitchMicrophoneStatusPress:"onActiveCallNotificationSwitchMicrophoneStatusPress",onActiveCallNotificationHangupButtonPress:"onActiveCallNotificationHangupButtonPress",onRemoteTrackAdded:"onRemoteTrackAdded"};BX.Call.Scheme={classic:1,jwt:2};class m{constructor(){this.legacyCalls={};this.jwtCalls={};this.unknownCalls={};this.callsToProcessAfterMessengerReady={legacy:new Map,jwt:new Map};this.debugFlag=false;this.isMessengerReady=false;this.pullStatus="";this._onPullEventHandler=this._onPullEvent.bind(this);this._onPullClientEventHandler=this._onPullClientEvent.bind(this);BX.addCustomEvent("onPullEvent-im",this._onPullEventHandler);BX.addCustomEvent("onPullClientEvent-im",this._onPullClientEventHandler);BX.addCustomEvent("onPullEvent-call",this._onPullEventHandler);BX.addCustomEvent("onAppActive",this.onAppActive.bind(this));BX.addCustomEvent(n.imMobile.updateCallToken,this._onCallTokenUpdate.bind(this,true));BX.addCustomEvent("onPullStatus",(e=>{this.pullStatus=e.status;console.log(`[${CallUtil.getTimeForLog()}]: pull status: ${this.pullStatus}`)}));BX.addCustomEvent(n.imMobile.activeCallsReceived,this.onActiveCallsReceived.bind(this));this._onCallJoinHandler=this._onCallJoin.bind(this);this._onCallLeaveHandler=this._onCallLeave.bind(this);this._onCallDestroyHandler=this._onCallDestroy.bind(this);this._onCallInactiveHandler=this._onCallInactive.bind(this);this._onCallActiveHandler=this._onCallActive.bind(this);this._onNativeIncomingCallHandler=this._onNativeIncomingCall.bind(this);if("callservice"in window){callservice.on("incoming",this._onNativeIncomingCallHandler);if(callservice.currentCall()){setTimeout((()=>this._onNativeIncomingCall(callservice.currentCall())),0)}}this.timeOfLastPushNotificationWithAutoAnswer;this.isInitializingCallFromPush=false;setTimeout((()=>{BX.postComponentEvent("onPullGetStatus",[],"communication");this.startWithPush()}),100);a.wait("chat").then((()=>this._onMessengerReady())).catch((e=>console.error(e)))}onAppActive(){for(const e in this.jwtCalls){if(this.jwtCalls.hasOwnProperty(e)&&this.jwtCalls[e]instanceof d&&!this.jwtCalls[e].ready&&!this.isNativeCall(e)&&Date.now()-this.jwtCalls[e].created>3e4){console.warn(`Destroying stale call ${e}`);this.jwtCalls[e].destroy()}}for(const e in this.legacyCalls){if(this.legacyCalls.hasOwnProperty(e)&&this.legacyCalls[e]instanceof d&&!this.legacyCalls[e].ready&&!this.isNativeCall(e)&&Date.now()-this.legacyCalls[e].created>3e4){console.warn(`Destroying stale call ${e}`);this.legacyCalls[e].destroy()}}this.startWithPush()}onActiveCallsReceived(e){const t={...e};const l=e=>{if(!BX.type.isFunction(e.off)){return}e.off(BX.Call.Event.onDestroy,this._onCallDestroyHandler);e.off(BX.Call.Event.onJoin,this._onCallJoinHandler);e.off(BX.Call.Event.onLeave,this._onCallLeaveHandler);e.off(BX.Call.Event.onInactive,this._onCallInactiveHandler);e.off(BX.Call.Event.onActive,this._onCallActiveHandler)};const a=e=>{if(!e){return}if(e.id in t||e.createdFromPush){delete t[e.id];return}const a=CallUtil.isLegacyCall(e.provider,e.scheme);if(a){this._onCallInactive({callId:e.id});delete this.legacyCalls[e.id]}else{this._onCallInactive({callUuid:e.uuid});delete this.jwtCalls[e.uuid]}l(e)};Object.keys(this.legacyCalls).forEach((e=>{const t=this.legacyCalls[e];a(t)}));Object.keys(this.jwtCalls).forEach((e=>{const t=this.jwtCalls[e];a(t)}));Object.values(t).forEach((e=>{const t=this._instantiateCall(e,e.CONNECTION_DATA,e.USERS,e.LOG_TOKEN,e.USER_DATA);const l=CallUtil.isLegacyCall(e.PROVIDER,e.SCHEME);if(l){this.legacyCalls[e.ID]=t}else{this.jwtCalls[e.UUID]=t}}))}_onMessengerReady(){this.isMessengerReady=true;for(const e of this.callsToProcessAfterMessengerReady.legacy.values()){this._onCallActive(e)}this.callsToProcessAfterMessengerReady.legacy.clear();for(const e of this.callsToProcessAfterMessengerReady.jwt.values()){this._onCallActive(e)}this.callsToProcessAfterMessengerReady.jwt.clear()}startWithPush(){const e=Application.getLastNotification();if(!e.id||!e.id.startsWith("IM_CALL_")){return}this.isInitializingCallFromPush=true;let t;try{t=JSON.parse(e.params)}catch{navigator.notification.alert(BX.message("MOBILE_CALL_INTERNAL_ERROR").replace("#ERROR_CODE#","E005"));this.isInitializingCallFromPush=false}if(!t.ACTION||!t.ACTION.startsWith("IMINV_")||!t.PARAMS||!t.PARAMS.call){this.isInitializingCallFromPush=false;return}console.log("Starting with PUSH:",e);const l=t.PARAMS.call;const a=t.PARAMS.video;const n=l.ID||l.id;const s=l.UUID||l.uuid;const i=t.PARAMS.ts;const o=Date.now()/1e3-i;const r=l.PROVIDER||l.provider;const c=l.SCHEME||l.scheme;if(CallUtil.isLegacyCall(r,c)){this._onUnknownCallPing(n,o,v,true).then((e=>{if(e&&this.legacyCalls[n]){BX.postComponentEvent("CallEvents::incomingCall",[{callId:n,callUuid:s,video:a,autoAnswer:true,ignoreCallTimeout:true,provider:r}],"calls")}})).catch((e=>console.error(e)))}else{const e=this._instantiateCall(t.PARAMS.call,null,null,null,null,true);this.jwtCalls[s]=e;if(!tokenManager.getTokenCached(e.associatedEntity.chatId)){tokenManager.getToken(e.associatedEntity.chatId)}BX.postComponentEvent("CallEvents::incomingCall",[{callId:n,callUuid:s,video:a,autoAnswer:true,ignoreCallTimeout:true,provider:r}],"calls")}}shouldCallBeAutoAnswered(e){if(Application.getPlatform()!=="android"){return false}const t=Application.getLastNotification();if(!t.id||!t.id.startsWith("IM_CALL_")){return false}if(!t.extra||!t.extra.server_time_unix||t.extra.server_time_unix==this.timeOfLastPushNotificationWithAutoAnswer){return false}try{const l=JSON.parse(t.params);if(!l.ACTION||!l.ACTION.startsWith("IMINV_")||!l.PARAMS||!l.PARAMS.call){return false}const a=l.PARAMS.call;const n=a.UUID||a.uuid;const s=e==n;if(s){this.timeOfLastPushNotificationWithAutoAnswer=t.extra.server_time_unix}return s}catch{return false}}_onNativeIncomingCall(e){console.log("_onNativeIncomingCall",e);if(e.params.type!=="internal"){return}const t=e.params.video;const l=e.params.call.ID;const a=e.params.call.uuid;const n=e.params.ts;const s=Date.now()/1e3-n;const i=e.params.call.PROVIDER||e.params.call.provider;if(s>15){console.error("Call originated too long time ago")}this._instantiateCall(e.params.call,e.params.connectionData,e.params.users,e.params.logToken,e.params.userData,true);BX.postComponentEvent("CallEvents::incomingCall",[{callId:l,callUuid:a,video:t,ignoreCallTimeout:true,provider:i}],"calls")}createJwtCall(e){return new Promise((async(t,l)=>{const a=e.type||BX.Call.Type.Instant;const n=e.provider||"Plain";if(e.joinExisting){for(const a in this.jwtCalls){if(this.jwtCalls.hasOwnProperty(a)){const n=this.jwtCalls[a];if(n.provider==e.provider&&n.associatedEntity.type==e.entityType&&n.associatedEntity.id==e.entityId){this.log(a,"Found existing call, attaching to it");if(!n.hasConnectionData){try{await this.updateConnectionData(n)}catch(e){return l(e)}}return t({call:n,isNew:false})}}}}let s;const i=e.chatInfo.chatId;const o=this.getUuidv4();const r=await tokenManager.getToken(i);if(!r){return l({code:BX.Call.CallError.EmptyCallToken})}try{s=await CallUtil.getCallConnectionData({callToken:r,callType:a,instanceId:o,provider:n,isVideo:e.videoEnabled},i)}catch(e){return l(e)}const d=this.jwtCalls[s.result.roomId];if(d){const e=this.jwtCalls[s.result.roomId];if(e instanceof P){d.destroy()}else if(d instanceof c){console.warn(`Call ${s.result.roomId} already exists`);d.destroy()}delete this.jwtCalls[s.result.roomId]}const u=this._getCallFactory(n,BX.Call.Scheme.jwt);const C=u.createCall({uuid:s.result.roomId,instanceId:o,direction:BX.Call.Direction.Outgoing,userData:CallUtil.getCurrentUserName(),videoEnabled:e.videoEnabled===true,enableMicAutoParameters:e.enableMicAutoParameters!==false,associatedEntity:e.chatInfo,events:{[BX.Call.Event.onDestroy]:this._onCallDestroyHandler,[BX.Call.Event.onJoin]:this._onCallJoinHandler,[BX.Call.Event.onLeave]:this._onCallLeaveHandler,[BX.Call.Event.onInactive]:this._onCallInactiveHandler,[BX.Call.Event.onActive]:this._onCallActiveHandler},connectionData:{mediaServerUrl:s.result.mediaServerUrl,roomData:s.result.roomData,roomType:s.result.roomType},debug:e.debug===true,scheme:BX.Call.Scheme.jwt});this.jwtCalls[C.uuid]=C;if(s.result.isNew){this.log(C.uuid,"Creating new call")}else{this.log(C.uuid,"Server returned existing call, attaching to it")}this._onCallActive({callUuid:C.uuid});t({call:C,isNew:s.result.isNew})}))}createLegacyCall(e){return new Promise(((t,l)=>{const a=e.type||BX.Call.Type.Instant;const n=e.provider||"Plain";if(e.joinExisting){for(const l in this.legacyCalls){if(this.legacyCalls.hasOwnProperty(l)){const a=this.legacyCalls[l];if(a.provider==e.provider&&a.associatedEntity.type==e.entityType&&a.associatedEntity.id==e.entityId){this.log(l,"Found existing call, attaching to it");return t({call:a,isNew:false})}}}}const s={type:a,provider:n,entityType:e.entityType,entityId:e.entityId,joinExisting:!!e.joinExisting,userIds:BX.type.isArray(e.userIds)?e.userIds:[]};console.log(`CallEngine.createCall.rest.callMethod - '${h.createCall}', callParameters:`,s);this.getRestClient().callMethod(h.createCall,s).then((a=>{console.log(`CallEngine.createCall.rest.callMethod - '${h.createCall}', verbose response:`,a);if(a.error()){const e=a.error().getError();return l({code:e.error,message:e.error_description})}const n=a.data();if(n.userData){}if(n.publicChannels){BX.PULL.setPublicIds(Object.values(n.publicChannels))}const s=n.call;if(this.legacyCalls[s.ID]){if(this.legacyCalls[s.ID]instanceof P){this.legacyCalls[s.ID].destroy()}else{console.warn(`Call ${s.ID} already exists`);return t({call:this.legacyCalls[s.ID],isNew:false})}}CallUtil.setUserData(n.userData);const i=this._getCallFactory(s.PROVIDER,BX.Call.Scheme.classic);const o=i.createCall({id:parseInt(s.ID,10),uuid:s.UUID,instanceId:this.getUuidv4(),direction:BX.Call.Direction.Outgoing,users:n.users,userData:CallUtil.getCurrentUserName(),videoEnabled:e.videoEnabled===true,enableMicAutoParameters:e.enableMicAutoParameters!==false,associatedEntity:s.ASSOCIATED_ENTITY,events:{[BX.Call.Event.onDestroy]:this._onCallDestroyHandler,[BX.Call.Event.onJoin]:this._onCallJoinHandler,[BX.Call.Event.onLeave]:this._onCallLeaveHandler,[BX.Call.Event.onInactive]:this._onCallInactiveHandler,[BX.Call.Event.onActive]:this._onCallActiveHandler},debug:e.debug===true,logToken:n.logToken,connectionData:n.connectionData,isCopilotActive:s.RECORD_AUDIO,scheme:BX.Call.Scheme.classic});this.legacyCalls[s.ID]=o;if(n.isNew){this.log(o.id,"Creating new call")}else{this.log(o.id,"Server returned existing call, attaching to it")}this._onCallActive({callId:o.id,callUuid:o.uuid});t({call:o,isNew:n.isNew})})).catch((e=>{console.warn(`CallEngine.createCall.rest.callMethod.catch - '${h.createCall}', verbose error:`,e);const t=e.answer||e;l({code:t.error||0,message:t.error_description||t})}))}))}getJwtCallWithId(e,t){return new Promise(((l,a)=>{const n=this.jwtCalls[e];if(t){this.createJwtCall(t).then((e=>{l(e)})).catch((e=>{a(e)}))}else if(n){if(n.hasConnectionData){l({call:n,isNew:false})}else{this.updateConnectionData(n).then((()=>{l({call:n,isNew:false})})).catch((e=>{a(e)}))}}else{const e={code:BX.Call.CallError.CallNotFound};a(e)}}))}getLegacyCallWithId(e,t=false){return new Promise(((l,a)=>{if(this.legacyCalls[e]){return l({call:this.legacyCalls[e],isNew:false})}this.getRestClient().callMethod(h.getCall,{callId:e}).then((e=>{const n=e.data();if(n.call.END_DATE){const e={id:n.call.ID,uuid:n.call.UUID,provider:n.call.PROVIDER,associatedEntity:n.call.ASSOCIATED_ENTITY};BX.postComponentEvent("CallEvents::inactive",[e],"im.recent");BX.postComponentEvent("CallEvents::inactive",[e],"im.messenger");return a({code:"ALREADY_FINISHED"})}l({call:this._instantiateCall(n.call,n.connectionData,n.users,n.logToken,n.userData,t),isNew:false})})).catch((e=>{if(typeof e.error==="function"){e=e.error().getError()}a({code:e.error,message:e.error_description})}))}))}getCallWithDialogId(e){const t=Object.values(this.jwtCalls);const l=Object.values(this.legacyCalls);const a=t=>t.find((t=>t.associatedEntity?.id==e));return a(t)||a(l)}updateConnectionData(e){return new Promise(((t,l)=>{const a=e.associatedEntity.chatId;tokenManager.getToken(a).then((t=>{if(!t){return l({code:BX.Call.CallError.EmptyCallToken})}const n={callToken:t,callType:e.type,provider:e.provider,instanceId:e.instanceId};return CallUtil.getCallConnectionData(n,a,false)})).then((l=>{e.setConnectionData({mediaServerUrl:l.result.mediaServerUrl,roomData:l.result.roomData,roomType:l.result.roomType});return t()})).catch((e=>{l(e)}))}))}getUuidv4(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(e=>{const t=Math.random()*16|0;const l=e=="x"?t:t&3|8;return l.toString(16)}))}debug(e){if(typeof e!=="boolean"){e=!this.debugFlag}this.debugFlag=e;console.warn(`Debug ${this.debugFlag?"enabled":"disabled"}`)}log(e,...t){const l=this.legacyCalls[e]||this.jwtCalls[e];if(l){l.log(...t)}else{console.log.apply(console,arguments)}}getRestClient(){return BX.rest}getLogService(){return BX.componentParameters.get("callLogService","")}isCallServerAllowed(){return BX.componentParameters.get("sfuServerEnabled")}isBitrixCallServerEnabled(){return BX.componentParameters.get("bitrixCallsEnabled")}isCallBetaIosEnabled(){return BX.componentParameters.get("callBetaIosEnabled",false)}isNativeCall(e){if(!("callservice"in window)){return false}const t=callservice.currentCall();return t&&t.params.call.ID==e}_isCallSupported(e){return e instanceof d||e instanceof c||e instanceof u||e instanceof i&&callEngine.isBitrixCallServerEnabled()||e instanceof o&&callEngine.isBitrixCallServerEnabled()}_onPullEvent(e,t,l){const a=t?.call?.SCHEME||t?.call?.scheme;const n=a!==BX.Call.Scheme.jwt;const s=t.call?.ID||t.call?.id||t.callId;const i=t.call?.UUID||t.call?.uuid;const o=n?this.legacyCalls[s]:this.jwtCalls[i];const r={chatUserAdd:this.#e.bind(this),chatUserLeave:this.#e.bind(this),"Call::incoming":this._onPullIncomingCall.bind(this),"Call::callTokenUpdate":this._onCallTokenUpdate.bind(this,false),"Call::clearCallTokens":this._onCallTokenClear.bind(this),"Call::callV2AvailabilityChanged":this._onCallV2AvailabilityChanged.bind(this)};if(e.startsWith("Call::")){if(o&&s&&!o.id){o.id=s}if(t.publicIds){BX.PULL.setPublicIds(Object.values(t.publicIds));console.warn("CallEngine._onPullEvent",e,t,l)}}if(r[e]){r[e].call(this,t,l)}else if(e.startsWith("Call::")&&(t.call||t.callId)){if(o){o._onPullEvent(e,t,l)}else if(e==="Call::ping"){this._onUnknownCallPing(t.callId,l.server_time_ago,g).then((a=>{if(a&&this.legacyCalls[s]){this.legacyCalls[s]._onPullEvent(e,t,l)}}))}}}_onPullClientEvent(e,t,l){if(e&&e.startsWith("Call::")&&t.callId){const a=t.callId;if(this.legacyCalls[a]){this.legacyCalls[a]._onPullEvent(e,t,l)}else if(e==="Call::ping"){this._onUnknownCallPing(t.callId,l.server_time_ago,g).then((n=>{if(n&&this.legacyCalls[a]){this.legacyCalls[a]._onPullEvent(e,t,l)}}))}}}_onCallTokenUpdate(e,t){if(e&&tokenManager.getTokenCached(t.chatId)){return}tokenManager.setToken(t.chatId,t.token)}_onCallTokenClear(){tokenManager.clearTokenList()}_onCallV2AvailabilityChanged(e){s.jwtCallsEnabled=e.isJwtEnabled;s.plainCallsUseJwt=e.isPlainUseJwt;if(e?.callBalancerUrl){s.callBalancerUrl=e.callBalancerUrl}}#e(e){BX.postComponentEvent(n.callMobile.chatUserChanged,[{dialogId:e.dialogId,userCount:e.userCount}],"calls")}_onPullIncomingCall(e,t){if(t.server_time_ago>30){console.error("Call was started too long time ago");return}const l=e.call;const a=parseInt(l.ID,10);const n=l.uuid;let s=this.legacyCalls[a]||this.jwtCalls[n];if(e.userData){}const i=l.PROVIDER||l.provider;const o=l.SCHEME||l.scheme;const r=CallUtil.isLegacyCall(i,o);if(!s&&!this.isInitializingCallFromPush){CallUtil.setUserData(e.userData);const t=this._getCallFactory(i,o);if(r){s=t.createCall({id:a,uuid:l.UUID,instanceId:this.getUuidv4(),parentId:l.PARENT_ID||null,callFromMobile:e.isLegacyMobile===true,direction:BX.Call.Direction.Incoming,users:e.users,userData:CallUtil.getCurrentUserName(),initiatorId:e.senderId||parseInt(l.INITIATOR_ID,10),associatedEntity:{userCounter:e.users?.length||0,...l.ASSOCIATED_ENTITY},type:l.TYPE,startDate:l.START_DATE,logToken:e.logToken,events:{[BX.Call.Event.onDestroy]:this._onCallDestroyHandler,[BX.Call.Event.onJoin]:this._onCallJoinHandler,[BX.Call.Event.onLeave]:this._onCallLeaveHandler,[BX.Call.Event.onInactive]:this._onCallInactiveHandler,[BX.Call.Event.onActive]:this._onCallActiveHandler},connectionData:e.connectionData,isCopilotActive:l.RECORD_AUDIO,scheme:l.SCHEME});this.legacyCalls[a]=s;this._onCallActive({callId:a,callUuid:n})}else{s=t.createCall({id:parseInt(e.callId,10),uuid:l.uuid,instanceId:this.getUuidv4(),parentUuid:l.parentUuid||null,callFromMobile:e.isLegacyMobile===true,direction:BX.Call.Direction.Incoming,users:e.users,userData:CallUtil.getCurrentUserName(),initiatorId:e.senderId||parseInt(l.initiatorId,10),associatedEntity:{userCounter:l.userCounter||0,...l.associatedEntity},type:l.type,startDate:l.startDate,logToken:l.logToken,events:{[BX.Call.Event.onDestroy]:this._onCallDestroyHandler,[BX.Call.Event.onJoin]:this._onCallJoinHandler,[BX.Call.Event.onLeave]:this._onCallLeaveHandler,[BX.Call.Event.onInactive]:this._onCallInactiveHandler,[BX.Call.Event.onActive]:this._onCallActiveHandler},scheme:l.scheme});this.jwtCalls[n]=s;this._onCallActive({callUuid:n})}}if(s&&!s.createdFromPush&&!(s instanceof P)){if(r){if(e.invitedUsers){s.addInvitedUsers(e.invitedUsers)}}else if(!tokenManager.getTokenCached(s.associatedEntity.chatId)){tokenManager.getToken(s.associatedEntity.chatId)}BX.postComponentEvent("CallEvents::incomingCall",[{callId:s.id,callUuid:s.uuid,video:e.video===true,isLegacyMobile:e.isLegacyMobile===true,userData:e.userData||null,autoAnswer:this.shouldCallBeAutoAnswered(s.uuid),ignoreCallTimeout:false,provider:i}],"calls");s.log(`Incoming call ${s.uuid}`)}}_onUnknownCallPing(e,t,l,a=false){return new Promise(((n,s)=>{e=parseInt(e,10);if(t>l){this.log(e,"Error: Ping was sent too long time ago");return n(false)}if(this.unknownCalls[e]){return n(false)}this.unknownCalls[e]=true;this.getLegacyCallWithId(e,a).then((t=>{this.unknownCalls[e]=false;n(true)})).catch((t=>{this.unknownCalls[e]=false;this.log(e,"Error: Could not instantiate call",t);n(false)}))}))}_instantiateCall(e,t,l,a,n,s=false){const i=e.ID||e.id;const o=e.UUID||e.uuid;const r=e.INITIATOR_ID||e.initiatorId;let c=this.legacyCalls[i]||this.jwtCalls[o];if(c){console.warn(`Call ${i} already exists`);return c}CallUtil.setUserData(n);let d=e.PROVIDER||e.provider;let u=e.SCHEME||e.scheme;const C=this._getCallFactory(d,u);const h=CallUtil.isLegacyCall(d,u);c=C.createCall({id:i?parseInt(i,10):null,uuid:o,instanceId:this.getUuidv4(),initiatorId:parseInt(r,10),parentId:e.PARENT_ID||e.parentId,parentUuid:e.PARENT_UUID||e.parentUuid,direction:r==env.userId?BX.Call.Direction.Outgoing:BX.Call.Direction.Incoming,users:l,userData:CallUtil.getCurrentUserName(),associatedEntity:{userCounter:l?.length||0,...e.ASSOCIATED_ENTITY||e.associatedEntity},type:e.TYPE||e.type,startDate:e.START_DATE||e.startDate,logToken:a,events:{[BX.Call.Event.onDestroy]:this._onCallDestroyHandler,[BX.Call.Event.onJoin]:this._onCallJoinHandler,[BX.Call.Event.onLeave]:this._onCallLeaveHandler,[BX.Call.Event.onInactive]:this._onCallInactiveHandler,[BX.Call.Event.onActive]:this._onCallActiveHandler},connectionData:this._getValidConnectionData(t,h),isCopilotActive:e.RECORD_AUDIO||e.recordAudio,scheme:e.SCHEME||e.scheme,createdFromPush:s});if(h){this.legacyCalls[i]=c;this._onCallActive({callId:i,callUuid:o})}else{this.jwtCalls[o]=c;this._onCallActive({callUuid:o})}return c}_getCallFields(e){return{id:e.id,uuid:e.uuid,provider:e.provider,associatedEntity:e.associatedEntity}}_getValidConnectionData(e,t){if(!e||!t)return{};const l=t&&e?.endpoint&&e.jwt;const a=!t&&e.mediaServerUrl&&e.roomData;if(l||a){return e}return{}}_getCallFactory(e,t=null){if(e==BX.Call.Provider.Plain){const e=t===BX.Call.Scheme.jwt||!t&&s.isJwtInPlainCallsEnabled();return e?p:f}if(e==BX.Call.Provider.Voximplant){return E}if(e===BX.Call.Provider.Bitrix){const e=t===BX.Call.Scheme.jwt||!t&&s.isJwtCallsEnabled();return e?I:_}throw new Error(`Unknown call provider type ${e}`)}_onCallJoin(e){console.warn("CallEngine.CallEvents::join",e);this._onCallActive(e)}_onCallLeave(e){console.warn("CallEngine.CallEvents::leave",e);this._onCallActive(e)}_onCallInactive(e){console.warn("CallEngine.CallEvents::inactive",e);this.isInitializingCallFromPush=false;const t=this.legacyCalls[e.callId]||this.jwtCalls[e.callUuid];if(!t){return}if(!this.isMessengerReady){if(e.callId){this.callsToProcessAfterMessengerReady.legacy.delete(e.callId)}else{this.callsToProcessAfterMessengerReady.jwt.delete(e.callUuid)}return}BX.postComponentEvent("CallEvents::inactive",[this._getCallFields(t)],"im.recent");BX.postComponentEvent("CallEvents::inactive",[this._getCallFields(t)],"im.messenger")}_onCallActive(e){console.warn("CallEngine.CallEvents::active",e);this.isInitializingCallFromPush=false;const t=this.legacyCalls[e.callId]||this.jwtCalls[e.callUuid];if(t&&!(t instanceof P)&&callEngine._isCallSupported(t)){if(!this.isMessengerReady){if(e.callId){this.callsToProcessAfterMessengerReady.legacy.set(e.callId,e)}else{this.callsToProcessAfterMessengerReady.jwt.set(e.callUuid,e)}return}BX.postComponentEvent("CallEvents::active",[this._getCallFields(t),t.joinStatus],"im.recent");BX.postComponentEvent("CallEvents::active",[this._getCallFields(t),t.joinStatus],"im.messenger")}}_onCallDestroy(e){const t=!!e.callId;const l=t?this.legacyCalls[e.callId]:this.jwtCalls[e.callUuid];const a=t?e.callId:e.callUuid;if(l){l.off(BX.Call.Event.onJoin,this._onCallJoinHandler).off(BX.Call.Event.onLeave,this._onCallLeaveHandler).off(BX.Call.Event.onDestroy,this._onCallDestroyHandler).off(BX.Call.Event.onInactive,this._onCallInactiveHandler).off(BX.Call.Event.onActive,this._onCallActiveHandler);if(this.isMessengerReady){console.warn("CallEvents::inactive",[e.callUuid]);BX.postComponentEvent("CallEvents::inactive",[this._getCallFields(l)],"im.recent");BX.postComponentEvent("CallEvents::inactive",[this._getCallFields(l)],"im.messenger")}else if(t){this.callsToProcessAfterMessengerReady.legacy.delete(a)}else{this.callsToProcessAfterMessengerReady.jwt.delete(a)}}const n=new P({callId:a,onDelete:()=>{if(t&&this.legacyCalls[a]){delete this.legacyCalls[a]}else if(this.jwtCalls[a]){delete this.jwtCalls[a]}}});if(t){this.legacyCalls[a]=n}else{this.jwtCalls[a]=n}}destroy(){BX.removeCustomEvent("onPullEvent-im",this._onPullEventHandler);BX.removeCustomEvent("onPullClientEvent-im",this._onPullClientEventHandler);BX.removeCustomEvent("onPullEvent-call",this._onPullCallEventHandler)}}let p={createCall(e){return new c(e)}};let f={createCall(e){return new d(e)}};let E={createCall(e){return new u(e)}};let y={createCall(e){return new r(e)}};let I={createCall(e){return new i(e)}};let _={createCall(e){return new o(e)}};class P{constructor(e){this.callId=e.callId;this.lifetime=e.lifetime||120;this.callbacks={onDelete:BX.type.isFunction(e.onDelete)?e.onDelete:function(){}};this.deleteTimeout=setTimeout((()=>{this.callbacks.onDelete({callId:this.callId})}),this.lifetime*1e3)}_onPullEvent(e,t,l){}isAnyoneParticipating(){return false}addEventListener(){return false}removeEventListener(){return false}destroy(){clearTimeout(this.deleteTimeout);this.callbacks.onDelete=function(){}}}class A{constructor(){this.userData={};this.usersInProcess={};this.roomPermissions={AudioEnabled:false,VideoEnabled:false,ScreenShareEnabled:false};this.userPermissions={ask:false,audio:true,can_approve:false,change_role:false,change_settings:false,end_call:false,give_permissions:false,invite:false,join_call:false,kick_user:false,mute:true,mute_others:false,record_call:false,screen_share:true,update:false,video:true,view_users:false};const e={ADMIN:"ADMIN",MANAGER:"MANAGER",USER:"USER"};this.regularUserRoles=[e.USER];this.currentUserRole=e.USER}setCurrentUserRole(e){if(e){this.currentUserRole=e.toUpperCase()}}setRoomPermissions(e){if(!BX.type.isPlainObject(e)){return}this.roomPermissions=e}setUserPermissionsByRoomPermissions(e){if(this.isRegularUser(this.getCurrentUserRole())){let t=this.getUserPermissions();for(let l in e){if(e.hasOwnProperty(l)){switch(l){case"AudioEnabled":t.audio=e[l];break;case"VideoEnabled":t.video=e[l];break;case"ScreenShareEnabled":t.screen_share=e[l];break}}}this.setUserPermissions(t)}}updateUserPermissionByNewRoomPermission(e,t){if(this.isRegularUser(this.getCurrentUserRole())){let l=this.getUserPermissions();switch(e){case"audio":l.audio=t;break;case"video":l.video=t;break;case"screen_share":l.screen_share=t;break}this.setUserPermissions(l)}}isRegularUser(e){return this.regularUserRoles.includes(e)}getRoomPermissions(){return this.roomPermissions}setUserPermissions(e){if(BX.type.isPlainObject(e)){for(let t in e){if(this.userPermissions.hasOwnProperty(t)){this.userPermissions[t]=e[t]}}}}getUserPermissions(){return this.userPermissions}getCurrentUserRole(){return this.currentUserRole}havePermissionToBroadcast(e){let t=false;switch(e){case"mic":t=this.userPermissions.audio;break;case"cam":t=this.userPermissions.video;break;case"screenshare":t=this.userPermissions.screen_share;break}return t}canControlChangeSettings(){return!!this.userPermissions.change_settings}canControlGiveSpeakPermission(){return!!this.userPermissions.give_permissions}getUserRoleByUserId(e){if(this.userData.hasOwnProperty(e)){return this.userData[e].role}}updateUserData(e,t){const l=[];for(const e of t){if(this.userData.hasOwnProperty(e)){continue}l.push(e)}const a=new Promise(((a,n)=>{if(l.length===0){return a()}BX.rest.callMethod("im.call.getUsers",{callId:e,userIds:l}).then((e=>{const l=BX.type.isPlainObject(e.answer.result)?e.answer.result:{};t.forEach((e=>{if(l[e]){this.userData[e]=l[e]}delete this.usersInProcess[e]}));a()})).catch((e=>{n(e.answer)}))}));for(const e of l){this.usersInProcess[e]=a}return a}getUser(e,t){return new Promise(((l,a)=>{if(this.userData.hasOwnProperty(t)){return l(this.userData[t])}else if(this.usersInProcess.hasOwnProperty(t)){this.usersInProcess[t].then((()=>l(this.userData[t])))}else{this.updateUserData(e,[t]).then((()=>l(this.userData[t])))}}))}getUsers(e,t){return new Promise(((l,a)=>{this.updateUserData(e,t).then((()=>{const e={};t.forEach((t=>e[t]=this.userData[t]||{}));return l(e)})).catch((e=>a(e)))}))}setUserData(e){for(const t in e){this.userData[t]=e[t];if(!this.userData[t].color){this.userData[t].color=this.getAvatarBackground()}}}getCurrentUserName(){return this.userData[env.userId]?.name||env?.userId||""}getDateForLog(){const e=new Date;return`${e.getFullYear()}-${this.lpad(e.getMonth()+1,2,"0")}-${this.lpad(e.getDate(),2,"0")} ${this.lpad(e.getHours(),2,"0")}:${this.lpad(e.getMinutes(),2,"0")}:${this.lpad(e.getSeconds(),2,"0")}.${e.getMilliseconds()}`}getTimeForLog(){const e=new Date;return`${this.lpad(e.getHours(),2,"0")}:${this.lpad(e.getMinutes(),2,"0")}:${this.lpad(e.getSeconds(),2,"0")}.${e.getMilliseconds()}`}log(){console.log(this.getLogMessage.apply(this,arguments))}warn(){console.warn(this.getLogMessage.apply(this,arguments))}error(){console.error(this.getLogMessage.apply(this,arguments))}formatSeconds(e){e=Math.floor(e);const t=e%60;const l=(e-t)/60;return`${this.lpad(l,2,"0")}:${this.lpad(t,2,"0")}`}getTimeText(e){if(!e){return""}const t=new Date;let l=new Date(e);if(l.getTime()<t.getDate()){l=t}let a=t-l;if(a<=0){a=0}let n=Math.floor(a/1e3);let s=Math.floor(n/60/60);if(s>0){n-=s*60*60}const i=Math.floor(n/60);if(i>0){n-=i*60}return(s>0?s+":":"")+(s>0?i.toString().padStart(2,"0")+":":i+":")+n.toString().padStart(2,"0")}getTimeInSeconds(e){if(!e){return""}const t=new Date;let l=new Date(e);if(l.getTime()<t.getDate()){l=t}let a=t-l;if(a<=0){a=0}return Math.floor(a/1e3)}lpad(e,t,l){e=e.toString();l=l||" ";if(e.length>t){return e}let a="";for(let n=0;n<t-e.length;n++){a+=l}return a+e}isAvatarBlank(e){return typeof e!=="string"||e==""||e.endsWith(C)}getAvatarBackground(){const e=["#006484","#00A2E8","#559BE6","#688800","#7FA800","#11A9D9","#0B66C3","#004F69","#00789E","#506900","#828B95"];return e[Math.floor(Math.random()*e.length)]}makeAbsolute(e){let t;if(typeof e!=="string"){return e}if(e.startsWith("http")){t=e}else{t=e.startsWith("/")?currentDomain+e:`${currentDomain}/${e}`}return t}convertKeysToUpper(e){var t=JSON.parse(JSON.stringify(e));for(let e in t){const l=e.toUpperCase();if(l!=e){t[l]=t[e];delete t[e]}}return t}getCustomMessage(e,t){let l;if(!BX.type.isPlainObject(t)){t={}}if(t.gender&&BX.message.hasOwnProperty(`${e}_${t.gender}`)){l=BX.message(`${e}_${t.gender}`)}else{l=BX.message(e)}t=this.convertKeysToUpper(t);return l.replace(/#.+?#/gm,(e=>{const l=e.slice(1,1+e.length-2);return t.hasOwnProperty(l)?t[l]:e}))}isCallServerAllowed(){return BX.message("call_server_enabled")==="Y"}getUserLimit(){if(this.isCallServerAllowed()){return parseInt(BX.message("call_server_max_users"))}return parseInt(BX.message("turn_server_max_users"))}getLogMessage(){let e=this.getDateForLog();for(const t of arguments){if(t instanceof Error){e=`${t.message}\n${t.stack}`}else{try{e=`${e} | ${typeof t==="object"?this.printObject(t):t}`}catch{e+=" | (circular structure)"}}}return e}printObject(e){let t="[";for(const l in e){if(e.hasOwnProperty(l)){const a=e[l];switch(typeof a){case"object":t+=l+(a===null?": null; ":": (object); ");break;case"string":case"number":case"boolean":t+=`${l}: ${a.toString()}; `;break;default:t+=`${l}: (${typeof a}); `}}}return`${t}]`}getUuidv4(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(e=>{const t=Math.random()*16|0;const l=e=="x"?t:t&3|8;return l.toString(16)}))}debounce(e,t,l){let a=0;return function(){clearTimeout(a);a=setTimeout((()=>e.apply(l,arguments)),t)}}array_flip(e){const t={};for(const l in e){t[e[l]]=l}return t}isDeviceSupported(){return Application.getApiVersion()>=36}forceBackgroundConnectPull(e=10){return new Promise(((t,l)=>{if(callEngine&&callEngine.pullStatus==="online"){t();return}const a=function(){console.error("Timeout while waiting for p&p to connect");BX.removeCustomEvent("onPullStatus",s);l("connect timeout")};const n=setTimeout(a,e*1e3);var s=({status:e,additional:a})=>{if(!a){a={}}if(e==="online"){BX.removeCustomEvent("onPullStatus",s);clearTimeout(n);t()}if(e==="offline"&&a.isError){BX.removeCustomEvent("onPullStatus",s);clearTimeout(n);l("connect error")}};BX.addCustomEvent("onPullStatus",s);BX.postComponentEvent("onPullForceBackgroundConnect",[],"communication")}))}showDeviceAccessConfirm(e,t=()=>{},l=()=>{}){return new Promise((a=>{navigator.notification.confirm(e?BX.message("MOBILE_CALL_MICROPHONE_CAMERA_REQUIRED"):BX.message("MOBILE_CALL_MICROPHONE_REQUIRED"),(e=>e==1?t():l()),e?BX.message("MOBILE_CALL_NO_MICROPHONE_CAMERA_ACCESS"):BX.message("MOBILE_CALL_NO_MICROPHONE_ACCESS"),[BX.message("MOBILE_CALL_MICROPHONE_SETTINGS"),BX.message("MOBILE_CALL_MICROPHONE_CANCEL")])}))}getSdkAudioManager(){if(BX.componentParameters.get("bitrixCallsEnabled")){return JNBXAudioManager}return JNVIAudioManager}isAIServiceEnabled(e=false){const{serviceEnabled:t,settingsEnabled:l,tariffAvailable:a}=BX.componentParameters.get("ai");return t&&l&&a&&!e}isLegacyCall(e,t=null){if(t){return t===BX.Call.Scheme.classic}const l=e===BX.Call.Provider.Plain&&!s.isJwtInPlainCallsEnabled();const a=e===BX.Call.Provider.Bitrix&&!s.isJwtCallsEnabled();return l||a}isJwtCallsSupported(){return s.isJwtCallsSupported()}getApiVersion(){return s.isJwtCallsSupported()?"2.0.0":"1.0.0"}async getLegacyCallConnectionData(e){return new Promise(((t,l)=>{let a=`${e.endpoint}/join`;a+=`?token=${e.jwt}`;a+=`&clientVersion=${this.getApiVersion()}`;a+=`&clientPlatform=${Application.getPlatform()}`;BX.ajax({url:a,method:"GET",dataType:"json",prepareData:false,skipAuthCheck:true,timeout:60}).then((e=>{if(e.result?.mediaServerUrl&&e.result?.roomData){t(`${e.result.mediaServerUrl}?roomData=${e.result.roomData}`)}l({name:"MEDIASERVER_MISSING_PARAMS",message:`Incorrect signaling response`})})).catch((e=>{l(e)}))}))}getCallConnectionData(e,t,l=true){if(!BX.type.isPlainObject(e)){e={}}return new Promise((async(a,n)=>{const i=BX.Call.RoomType.Small;const o=e.provider===BX.Call.Provider.Plain;const r=CallUtil.getApiVersion();const c=Application.getPlatform();const d=`${s.callBalancerUrl}/v2/join?mustCreate=${Boolean(l)}`;const u=await tokenManager.getUserToken(t);const C=JSON.stringify({userToken:u,roomType:i,isOneToOne:o,clientVersion:r,clientPlatform:c,...e});BX.ajax({url:d,data:C,method:"POST",prepareData:false,dataType:"json",skipAuthCheck:true,timeout:60}).then((e=>{if(e.result?.mediaServerUrl&&e.result?.roomData){a(e)}const t={code:BX.Call.CallError.MediaServerMissingParams};n(t)})).catch((e=>{let t=e;if(e.xhr?.responseText){try{const l=JSON.parse(e.xhr.responseText);if(l.error.message){t={code:l.error.message,errorCode:l.error.code}}}catch{t={code:BX.Call.CallError.MediaServerUnreachable}}}n(t)}))}))}async getCallConnectionDataById(e){const t=callEngine.jwtCalls[e];if(!t){const e={code:BX.Call.CallError.CallNotFound};return Promise.reject(e)}return this.getCallConnectionData({callType:t.type,instanceId:t.instanceId,provider:t.provider,callToken:tokenManager.getTokenCached(t.associatedEntity.chatId)},t.associatedEntity.chatId,false)}abortGetCallConnectionData(){this.abortableRequest?.abort()}stringifyObjectValues(e){return Object.fromEntries(Object.entries(e).map((([e,t])=>[e,typeof t==="object"&&t!==null?JSON.stringify(t):String(t)])))}deepParseJSON(e,t=0){if(t>3){return e}if(typeof e==="string"){try{const l=JSON.parse(e);return typeof l==="object"?this.deepParseJSON(l,t+1):l}catch{return e}}if(Array.isArray(e)){return e.map((e=>this.deepParseJSON(e,t+1)))}if(e&&typeof e==="object"){return Object.fromEntries(Object.entries(e).map((([e,l])=>[e,this.deepParseJSON(l,t+1)])))}return e}isIos(){return device.platform==="iOS"}}class D extends Error{constructor(e){super("Media access denied");this.name="DeviceAccessError";this.justDenied=e}}class w extends Error{constructor(){super("Call joined elsewhere");this.name="CallJoinedElseWhereError"}}l.exports={DeviceAccessError:D,CallJoinedElseWhereError:w,CallEngine:m,CCallUtil:A,CallStub:P}}));
//# sourceMappingURL=extension.map.js