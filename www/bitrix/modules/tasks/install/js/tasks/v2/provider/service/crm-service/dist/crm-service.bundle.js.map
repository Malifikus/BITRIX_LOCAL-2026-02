{"version":3,"file":"crm-service.bundle.js","sources":["../src/mappers.js","../src/crm-service.js","../src/index.js"],"sourcesContent":["import { EntitySelectorEntity } from 'tasks.v2.const';\nimport type { CrmItemModel } from 'tasks.v2.model.crm-items';\nimport type { CrmItemDto } from './types';\n\nconst entityPrefixMap = {\n\t[EntitySelectorEntity.Deal]: 'D',\n\t[EntitySelectorEntity.Contact]: 'C',\n\t[EntitySelectorEntity.Company]: 'CO',\n\t[EntitySelectorEntity.Lead]: 'L',\n\t[EntitySelectorEntity.SmartInvoice]: 'SI',\n};\n\nconst prefixSortMap = Object.fromEntries(Object.values(entityPrefixMap).map((it, index) => [it, index]));\n\nconst prefixEntityMap = Object.fromEntries(Object.entries(entityPrefixMap).map((it) => it.reverse()));\n\nconst entityTypeIdMap = {\n\t[EntitySelectorEntity.Deal]: 2,\n\t[EntitySelectorEntity.Contact]: 3,\n\t[EntitySelectorEntity.Company]: 4,\n\t[EntitySelectorEntity.Lead]: 1,\n\t[EntitySelectorEntity.SmartInvoice]: 31,\n};\n\nexport function mapDtoToModel(crmItemDto: CrmItemDto): CrmItemModel\n{\n\treturn {\n\t\tid: crmItemDto.id,\n\t\tentityId: crmItemDto.entityId,\n\t\ttype: crmItemDto.type,\n\t\ttypeName: crmItemDto.typeName,\n\t\ttitle: crmItemDto.title,\n\t\tlink: crmItemDto.link,\n\t};\n}\n\nexport function mapId(entityId: string, id: number): string\n{\n\tif (!entityPrefixMap[entityId])\n\t{\n\t\tconst [typeId, itemId] = id.split(':');\n\n\t\treturn `T${Number(typeId).toString(16)}_${itemId}`;\n\t}\n\n\treturn `${entityPrefixMap[entityId]}_${id}`;\n}\n\nexport function splitId(id: string): string\n{\n\tconst [prefix, entityId] = id.split('_');\n\tif (!prefixEntityMap[prefix])\n\t{\n\t\treturn [EntitySelectorEntity.DynamicMultiple, `${getEntityTypeId(id)}:${entityId}`];\n\t}\n\n\treturn [prefixEntityMap[prefix], Number(entityId)];\n}\n\nexport function compareIds(idA: string, idB: string): number\n{\n\tconst [prefixA, entityIdA] = idA.split('_');\n\tconst [prefixB, entityIdB] = idB.split('_');\n\n\tconst sortA = prefixSortMap[prefixA] ?? getEntityTypeId(idA);\n\tconst sortB = prefixSortMap[prefixB] ?? getEntityTypeId(idB);\n\n\tif (sortA === sortB)\n\t{\n\t\treturn entityIdA - entityIdB;\n\t}\n\n\treturn sortA - sortB;\n}\n\nexport function getEntityTypeId(id: string): number\n{\n\tconst [prefix] = id.split('_');\n\tif (!prefixEntityMap[prefix])\n\t{\n\t\treturn parseInt(prefix.slice(1), 16);\n\t}\n\n\treturn entityTypeIdMap[prefixEntityMap[prefix]];\n}\n","import { Core } from 'tasks.v2.core';\nimport { Model, Endpoint } from 'tasks.v2.const';\nimport { apiClient } from 'tasks.v2.lib.api-client';\nimport { idUtils } from 'tasks.v2.lib.id-utils';\nimport type { CrmItemModel } from 'tasks.v2.model.crm-items';\n\nimport { mapDtoToModel } from './mappers';\nimport type { CrmItemDto } from './types';\n\nexport const crmService = new class\n{\n\tasync list(id: number | string, ids: string[]): Promise<void>\n\t{\n\t\tconst data = await (idUtils.isTemplate(id) ? this.#listTemplate(id, ids) : this.#listTask(id, ids));\n\n\t\tconst crmItems = data.map((dto: CrmItemDto): CrmItemModel => mapDtoToModel(dto));\n\n\t\tawait Core.getStore().dispatch(`${Model.CrmItems}/upsertMany`, crmItems);\n\t}\n\n\t#listTask(id: number, crmItemIds: string[]): Promise<CrmItemDto[]>\n\t{\n\t\treturn apiClient.post(Endpoint.TaskCrmItemList, { task: { id, crmItemIds } });\n\t}\n\n\t#listTemplate(id: number, crmItemIds: string[]): Promise<CrmItemDto[]>\n\t{\n\t\treturn apiClient.post('Template.CRM.Item.list', { template: { id: idUtils.unbox(id), crmItemIds } });\n\t}\n}();\n","import { mapId, splitId, compareIds, getEntityTypeId } from './mappers';\n\nexport { crmService } from './crm-service';\nexport const CrmMappers = { mapId, splitId, compareIds, getEntityTypeId };\nexport type { CrmItemDto } from './types';\n"],"names":["entityPrefixMap","EntitySelectorEntity","Deal","Contact","Company","Lead","SmartInvoice","prefixSortMap","Object","fromEntries","values","map","it","index","prefixEntityMap","entries","reverse","entityTypeIdMap","mapDtoToModel","crmItemDto","id","entityId","type","typeName","title","link","mapId","typeId","itemId","split","Number","toString","splitId","prefix","DynamicMultiple","getEntityTypeId","compareIds","idA","idB","prefixA","entityIdA","prefixB","entityIdB","sortA","sortB","parseInt","slice","crmService","list","ids","data","idUtils","isTemplate","crmItems","dto","Core","getStore","dispatch","Model","CrmItems","crmItemIds","apiClient","post","Endpoint","TaskCrmItemList","task","template","unbox","CrmMappers"],"mappings":"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"}