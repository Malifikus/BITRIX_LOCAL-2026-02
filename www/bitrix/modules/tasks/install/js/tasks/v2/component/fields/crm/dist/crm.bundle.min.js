this.BX=this.BX||{};this.BX.Tasks=this.BX.Tasks||{};this.BX.Tasks.V2=this.BX.Tasks.V2||{};this.BX.Tasks.V2.Component=this.BX.Tasks.V2.Component||{};(function(t,e,s,i,a,n,l,r,o,d,c,m,h,p,u,k,I,v,b,C){"use strict";const y={components:{HoverPill:r.HoverPill,TextMd:n.TextMd,RichLoc:a.RichLoc,BMenu:l.BMenu},inject:{task:{},taskId:{},isEdit:{}},props:{item:{type:Object,required:true}},emits:["edit","clear"],setup(){},data(){return{isMenuShown:false}},computed:{isLocked(){return!v.Core.getParams().restrictions.crmIntegration.available},readonly(){return!this.task.rights.edit},menuOptions(){return{id:`tasks-crm-menu-${this.item.id}`,bindElement:this.$refs.pill.$el,offsetTop:8,items:this.menuItems,targetContainer:document.body}},menuItems(){return[{title:this.loc("TASKS_V2_CRM_OPEN"),icon:k.Outline.GO_TO_L,dataset:{id:"tasks-crm-menu-open"},onClick:()=>BX.SidePanel.Instance.emulateAnchorClick(this.item.link)},{title:this.loc("TASKS_V2_CRM_EDIT"),icon:k.Outline.EDIT_L,dataset:{id:"tasks-crm-menu-edit"},isLocked:this.isLocked,onClick:()=>this.$emit("edit")},{title:this.loc("TASKS_V2_CRM_UNLINK"),icon:k.Outline.CROSS_L,dataset:{id:"tasks-crm-menu-unlink"},onClick:this.clear}]}},async mounted(){const{EntityMiniCard:t}=await o.Runtime.loadExtension("crm.mini-card");const e=new t({bindElement:this.$refs.pill.$el,entityTypeId:m.CrmMappers.getEntityTypeId(this.item.id),entityId:this.item.entityId});const s=document.querySelector(`[data-task-card-scroll="${this.taskId}"]`);e.getMiniCard().popup().setTargetContainer(s)},methods:{prepareTitle(t){return this.loc("TASKS_V2_CRM_ENTITY_TITLE",{"#TYPE_NAME#":t.typeName,"#TITLE#":t.title})},handleClick(){if(!this.isEdit||this.readonly){BX.SidePanel.Instance.emulateAnchorClick(this.item.link);return}this.isMenuShown=true},clear(){this.$emit("clear",this.item.id)}},template:`\n\t\t<div class="tasks-field-crm-item-container">\n\t\t\t<HoverPill\n\t\t\t\tclass="tasks-field-crm-item"\n\t\t\t\t:withClear="!isEdit || !readonly"\n\t\t\t\ttextOnly\n\t\t\t\t:active="isMenuShown"\n\t\t\t\tref="pill"\n\t\t\t\t@click.stop="handleClick"\n\t\t\t\t@clear="clear"\n\t\t\t>\n\t\t\t\t<TextMd class="tasks-field-crm-item-text">\n\t\t\t\t\t<RichLoc tag="span" :text="prepareTitle(item)" placeholder="[a]">\n\t\t\t\t\t\t<template #a="{ text }">\n\t\t\t\t\t\t\t<a @click.prevent>{{ text }}</a>\n\t\t\t\t\t\t</template>\n\t\t\t\t\t</RichLoc>\n\t\t\t\t</TextMd>\n\t\t\t</HoverPill>\n\t\t</div>\n\t\t<BMenu v-if="isMenuShown" :options="menuOptions" @close="isMenuShown = false"/>\n\t`};const g=Object.freeze({id:d.TaskField.Crm,title:o.Loc.getMessage("TASKS_V2_CRM_TITLE")});var S,T,L,f,B,P,E;const M={};const F=new(S=babelHelpers.classPrivateFieldLooseKey("taskId"),T=babelHelpers.classPrivateFieldLooseKey("onClose"),L=babelHelpers.classPrivateFieldLooseKey("dialog"),f=babelHelpers.classPrivateFieldLooseKey("createDialog"),B=babelHelpers.classPrivateFieldLooseKey("fillStore"),P=babelHelpers.classPrivateFieldLooseKey("mapItemToModel"),E=babelHelpers.classPrivateFieldLooseKey("items"),class{constructor(){Object.defineProperty(this,E,{get:V,set:void 0});Object.defineProperty(this,P,{value:w});Object.defineProperty(this,f,{value:_});Object.defineProperty(this,L,{get:H,set:void 0});Object.defineProperty(this,S,{writable:true,value:void 0});Object.defineProperty(this,T,{writable:true,value:void 0});Object.defineProperty(this,B,{writable:true,value:()=>{const t=babelHelpers.classPrivateFieldLooseBase(this,L)[L].getSelectedItems().map((t=>babelHelpers.classPrivateFieldLooseBase(this,P)[P](t)));void v.Core.getStore().dispatch(`${d.Model.CrmItems}/upsertMany`,t);return t}})}init(t){babelHelpers.classPrivateFieldLooseBase(this,S)[S]=t;babelHelpers.classPrivateFieldLooseBase(this,L)[L]}show(t){babelHelpers.classPrivateFieldLooseBase(this,S)[S]=t.taskId;babelHelpers.classPrivateFieldLooseBase(this,T)[T]=t.onClose;babelHelpers.classPrivateFieldLooseBase(this,L)[L].selectItemsByIds(babelHelpers.classPrivateFieldLooseBase(this,E)[E]);babelHelpers.classPrivateFieldLooseBase(this,L)[L].showTo(t.targetNode)}});function H(){var t,e;(e=M[t=babelHelpers.classPrivateFieldLooseBase(this,S)[S]])!=null?e:M[t]=babelHelpers.classPrivateFieldLooseBase(this,f)[f]();return M[babelHelpers.classPrivateFieldLooseBase(this,S)[S]]}function _(){const{crmIntegration:t}=o.Extension.getSettings("tasks.v2.component.fields.crm");const e=c.idUtils.isTemplate(babelHelpers.classPrivateFieldLooseBase(this,S)[S])?t==null?void 0:t.template:t==null?void 0:t.task;const s=Object.entries(e!=null?e:{}).filter((([t,e])=>e==="Y"&&t.startsWith("DYNAMIC_"))).map((([t])=>Number(t.slice(8))));return new p.EntitySelectorDialog({context:"tasks-card",enableSearch:true,entities:[d.EntitySelectorEntity.Deal,d.EntitySelectorEntity.Contact,d.EntitySelectorEntity.Company,d.EntitySelectorEntity.Lead,d.EntitySelectorEntity.SmartInvoice,d.EntitySelectorEntity.DynamicMultiple].map((t=>({id:t,dynamicLoad:true,dynamicSearch:true,options:{dynamicTypeIds:s,showTab:true,allowAllCategories:true},dynamicSearchMatchMode:"all"}))),preselectedItems:babelHelpers.classPrivateFieldLooseBase(this,E)[E],events:{onLoad:babelHelpers.classPrivateFieldLooseBase(this,B)[B]},popupOptions:{events:{onClose:()=>{var t,e;const s=babelHelpers.classPrivateFieldLooseBase(this,B)[B]();const i=s.map((({id:t})=>t));void h.taskService.update(babelHelpers.classPrivateFieldLooseBase(this,S)[S],{crmItemIds:i});(t=(e=babelHelpers.classPrivateFieldLooseBase(this,T))[T])==null?void 0:t.call(e)}}}})}function w(t){const e=t.getCustomData().get("entityInfo");const s=t.getId();return{id:m.CrmMappers.mapId(e.type,t.getId()),entityId:Number.isInteger(s)?s:Number(s.split(":")[1]),type:t.getEntityId(),typeName:e.typeNameTitle,title:t.getTitle(),link:e.url}}function V(){var t,e;return(t=(e=h.taskService.getStoreTask(babelHelpers.classPrivateFieldLooseBase(this,S)[S]).crmItemIds)==null?void 0:e.map((t=>m.CrmMappers.splitId(t))))!=null?t:[]}const X=7;const O={components:{AddButton:s.AddButton,TextSm:n.TextSm,BLine:e.BLine,FieldAdd:i.FieldAdd,CrmItem:y},inject:{task:{},taskId:{},isEdit:{}},setup(){return{Outline:k.Outline,crmMeta:g,maxCount:X}},data(){return{isDialogShown:false,isExpanded:false,isHovered:false}},computed:{crmItems(){const t=this.$store.getters[`${d.Model.CrmItems}/getByIds`](this.task.crmItemIds);return t.sort(((t,e)=>m.CrmMappers.compareIds(t.id,e.id)))},visibleItems(){return this.crmItems.slice(0,X)},collapsedItems(){return this.crmItems.slice(X)},isLoading(){var t;return!this.isEmpty&&!((t=this.crmItems)!=null&&t.length)},isEmpty(){var t;return!((t=this.task.crmItemIds)!=null&&t.length)},readonly(){return!this.task.rights.edit},expandButtonText(){if(this.isExpanded){return this.loc("TASKS_V2_CRM_COLLAPSE")}return this.loc("TASKS_V2_CRM_AND_COUNT",{"#COUNT#":this.collapsedItems.length})},isAddActive(){return!this.readonly&&!this.isEmpty},isAddVisible(){return this.isDialogShown||this.isHovered},isLocked(){return!v.Core.getParams().restrictions.crmIntegration.available}},mounted(){if(this.isEdit){void m.crmService.list(this.taskId,this.task.crmItemIds)}else{F.init(this.taskId)}},methods:{handleClick(){if(!this.readonly){this.showDialog()}},showDialog(){if(this.isLocked){void C.showLimit({featureId:v.Core.getParams().restrictions.crmIntegration.featureId});return}F.show({targetNode:this.$refs.anchor,taskId:this.taskId,onClose:this.handleClose});this.isDialogShown=true},handleClose(){this.isDialogShown=false},handleClear(t){const e=this.task.crmItemIds.filter((e=>e!==t));void h.taskService.update(this.taskId,{crmItemIds:e})}},template:`\n\t\t<div\n\t\t\t@mouseenter="isHovered = true"\n\t\t\t@mouseleave="isHovered = false"\n\t\t>\n\t\t\t<AddButton \n\t\t\t\tv-if="isAddActive"\n\t\t\t\t:isVisible="isAddVisible"\n\t\t\t\t:isLocked\n\t\t\t\t@click="handleClick"\n\t\t\t/>\n\t\t\t<div\n\t\t\t\tclass="tasks-field-crm"\n\t\t\t\t:data-task-id="taskId"\n\t\t\t\t:data-task-field-id="crmMeta.id"\n\t\t\t\t:data-task-crm-item-ids="task.crmItemIds?.join(',')"\n\t\t\t>\n\t\t\t\t<FieldAdd \n\t\t\t\t\tv-if="isEmpty"\n\t\t\t\t\t:icon="Outline.CRM"\n\t\t\t\t\t:isLocked\n\t\t\t\t\t@click="showDialog"\n\t\t\t\t/>\n\t\t\t\t<div v-if="isLoading" class="tasks-field-crm-skeleton">\n\t\t\t\t\t<template v-for="key in task.crmItemIds.slice(0, maxCount)" :key>\n\t\t\t\t\t\t<BLine :height="20"/>\n\t\t\t\t\t</template>\n\t\t\t\t</div>\n\t\t\t\t<template v-for="item in visibleItems" :key="item.id">\n\t\t\t\t\t<CrmItem :item @edit="showDialog" @clear="handleClear(item.id)"/>\n\t\t\t\t</template>\n\t\t\t\t<template v-if="isExpanded" v-for="item in collapsedItems" :key="item.id">\n\t\t\t\t\t<CrmItem :item @edit="showDialog" @clear="handleClear(item.id)"/>\n\t\t\t\t</template>\n\t\t\t\t<TextSm\n\t\t\t\t\tv-if="collapsedItems.length > 0"\n\t\t\t\t\tclass="tasks-field-crm-expand"\n\t\t\t\t\t@click.capture.stop="isExpanded = !isExpanded"\n\t\t\t\t>\n\t\t\t\t\t{{ expandButtonText }}\n\t\t\t\t</TextSm>\n\t\t\t</div>\n\t\t\t<div class="tasks-field-crm-anchor" ref="anchor"/>\n\t\t</div>\n\t`};const x={components:{Chip:u.Chip},inject:{task:{},taskId:{}},setup(){return{Outline:k.Outline,crmMeta:g}},computed:{design(){return this.isSelected?u.ChipDesign.ShadowAccent:u.ChipDesign.ShadowNoAccent},isSelected(){return this.task.filledFields[g.id]},isLocked(){return!v.Core.getParams().restrictions.crmIntegration.available}},methods:{handleClick(){if(this.isSelected){this.highlightField();return}if(this.isLocked){void C.showLimit({featureId:v.Core.getParams().restrictions.crmIntegration.featureId});return}F.show({targetNode:this.$el,taskId:this.taskId,onClose:this.highlightField})},highlightField(){void b.fieldHighlighter.setContainer(this.$root.$el).highlight(g.id)}},template:`\n\t\t<Chip\n\t\t\tv-if="task.rights.edit || isSelected"\n\t\t\t:design\n\t\t\t:icon="Outline.CRM"\n\t\t\t:lock="isLocked"\n\t\t\t:text="loc('TASKS_V2_CRM_TITLE_CHIP')"\n\t\t\t:data-task-id="taskId"\n\t\t\t:data-task-chip-id="crmMeta.id"\n\t\t\t:data-task-crm-item-ids="task.crmItemIds?.join(',')"\n\t\t\t@click="handleClick"\n\t\t/>\n\t`};t.Crm=O;t.CrmChip=x;t.crmMeta=g})(this.BX.Tasks.V2.Component.Fields=this.BX.Tasks.V2.Component.Fields||{},BX.UI.System.Skeleton.Vue,BX.Tasks.V2.Component.Elements,BX.Tasks.V2.Component.Elements,BX.UI.Vue3.Components,BX.UI.System.Typography.Vue,BX.UI.System.Menu,BX.Tasks.V2.Component.Elements,BX,BX.Tasks.V2.Const,BX.Tasks.V2.Lib,BX.Tasks.V2.Provider.Service,BX.Tasks.V2.Provider.Service,BX.Tasks.V2.Lib,BX.UI.System.Chip.Vue,BX.UI.IconSet,BX,BX.Tasks.V2,BX.Tasks.V2.Lib,BX.Tasks.V2.Lib);
//# sourceMappingURL=crm.bundle.map.js