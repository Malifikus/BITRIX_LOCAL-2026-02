this.BX=this.BX||{};this.BX.Tasks=this.BX.Tasks||{};this.BX.Tasks.V2=this.BX.Tasks.V2||{};(function(e,s,t,a,l,i,r,o,n,c){"use strict";var d=babelHelpers.classPrivateFieldLooseKey("cacheContent");var b=babelHelpers.classPrivateFieldLooseKey("cacheRequest");var p=babelHelpers.classPrivateFieldLooseKey("currentParams");var u=babelHelpers.classPrivateFieldLooseKey("getContent");var v=babelHelpers.classPrivateFieldLooseKey("getTasksContent");var h=babelHelpers.classPrivateFieldLooseKey("getTemplateContent");var P=babelHelpers.classPrivateFieldLooseKey("openSlider");var F=babelHelpers.classPrivateFieldLooseKey("handleSliderClose");var L=babelHelpers.classPrivateFieldLooseKey("render");var f=babelHelpers.classPrivateFieldLooseKey("renderContent");var y=babelHelpers.classPrivateFieldLooseKey("renderTitle");var B=babelHelpers.classPrivateFieldLooseKey("renderFooter");var H=babelHelpers.classPrivateFieldLooseKey("renderConfirmButton");var m=babelHelpers.classPrivateFieldLooseKey("renderCancelButton");var T=babelHelpers.classPrivateFieldLooseKey("convertToArray");var k=babelHelpers.classPrivateFieldLooseKey("collectUserFieldsData");var S=babelHelpers.classPrivateFieldLooseKey("buildSchemeEntry");var g=babelHelpers.classPrivateFieldLooseKey("getEntityId");var K=babelHelpers.classPrivateFieldLooseKey("prepareValue");var E=babelHelpers.classPrivateFieldLooseKey("showError");var j=babelHelpers.classPrivateFieldLooseKey("currentTaskId");var C=babelHelpers.classPrivateFieldLooseKey("currentIsTemplate");var I=babelHelpers.classPrivateFieldLooseKey("currentTemplateId");var O=babelHelpers.classPrivateFieldLooseKey("currentCopiedFromId");class _{constructor(){Object.defineProperty(this,O,{get:se,set:void 0});Object.defineProperty(this,I,{get:ee,set:void 0});Object.defineProperty(this,C,{get:Z,set:void 0});Object.defineProperty(this,j,{get:Y,set:void 0});Object.defineProperty(this,E,{value:W});Object.defineProperty(this,K,{value:Q});Object.defineProperty(this,g,{value:J});Object.defineProperty(this,S,{value:z});Object.defineProperty(this,k,{value:G});Object.defineProperty(this,T,{value:q});Object.defineProperty(this,m,{value:N});Object.defineProperty(this,H,{value:D});Object.defineProperty(this,B,{value:M});Object.defineProperty(this,y,{value:x});Object.defineProperty(this,f,{value:R});Object.defineProperty(this,L,{value:$});Object.defineProperty(this,F,{value:V});Object.defineProperty(this,P,{value:A});Object.defineProperty(this,h,{value:w});Object.defineProperty(this,v,{value:X});Object.defineProperty(this,u,{value:U});Object.defineProperty(this,d,{writable:true,value:void 0});Object.defineProperty(this,b,{writable:true,value:void 0});Object.defineProperty(this,p,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,d)[d]=new Map;babelHelpers.classPrivateFieldLooseBase(this,b)[b]=new Map;babelHelpers.classPrivateFieldLooseBase(this,p)[p]={}}async open(e){babelHelpers.classPrivateFieldLooseBase(this,p)[p]=e;if(babelHelpers.classPrivateFieldLooseBase(this,d)[d].has(babelHelpers.classPrivateFieldLooseBase(this,j)[j])){const e=babelHelpers.classPrivateFieldLooseBase(this,d)[d].get(babelHelpers.classPrivateFieldLooseBase(this,j)[j]);if(e){babelHelpers.classPrivateFieldLooseBase(this,P)[P](e)}return}const s=await babelHelpers.classPrivateFieldLooseBase(this,u)[u]();const t=document.createElement("div");BX.Runtime.html(t,s,{useAdjacentHTML:true});babelHelpers.classPrivateFieldLooseBase(this,d)[d].set(babelHelpers.classPrivateFieldLooseBase(this,j)[j],t);babelHelpers.classPrivateFieldLooseBase(this,P)[P](t)}async handleConfirm(){const e=document.getElementById("user-fields-slider-content");if(!e){return}const{userFields:s,scheme:t}=babelHelpers.classPrivateFieldLooseBase(this,k)[k](e);if(babelHelpers.classPrivateFieldLooseBase(this,C)[C]){await this.$store.dispatch(`${l.Model.Interface}/updateTemplateUserFieldScheme`,t);void this.updateTemplateUserFields(s)}else{await this.$store.dispatch(`${l.Model.Interface}/updateTaskUserFieldScheme`,t);void this.updateTaskUserFields(s)}BX.SidePanel.Instance.close()}async updateTaskUserFields(e){var s;const t=await o.taskService.update(babelHelpers.classPrivateFieldLooseBase(this,j)[j],{userFields:e});if((s=t[l.Endpoint.TaskUpdate])!=null&&s.length){const e=t[l.Endpoint.TaskUpdate][0];babelHelpers.classPrivateFieldLooseBase(this,E)[E](e)}}async updateTemplateUserFields(e){var s;const t=await n.templateService.update(babelHelpers.classPrivateFieldLooseBase(this,j)[j],{userFields:e});if((s=t[l.Endpoint.TemplateUpdate])!=null&&s.length){const e=t[l.Endpoint.TemplateUpdate][0];babelHelpers.classPrivateFieldLooseBase(this,E)[E](e)}}get $store(){return i.Core.getStore()}}async function U(){if(babelHelpers.classPrivateFieldLooseBase(this,b)[b].has(babelHelpers.classPrivateFieldLooseBase(this,j)[j])){return babelHelpers.classPrivateFieldLooseBase(this,b)[b].get(babelHelpers.classPrivateFieldLooseBase(this,j)[j])}try{let t="";if(babelHelpers.classPrivateFieldLooseBase(this,O)[O]){if(babelHelpers.classPrivateFieldLooseBase(this,C)[C]){const e=a.idUtils.unbox(babelHelpers.classPrivateFieldLooseBase(this,O)[O]);t=await babelHelpers.classPrivateFieldLooseBase(this,h)[h](e)}else{const e=s.Type.isNumber(babelHelpers.classPrivateFieldLooseBase(this,O)[O])?babelHelpers.classPrivateFieldLooseBase(this,O)[O]:0;t=await babelHelpers.classPrivateFieldLooseBase(this,v)[v](e)}}else if(babelHelpers.classPrivateFieldLooseBase(this,C)[C]){const e=a.idUtils.unbox(babelHelpers.classPrivateFieldLooseBase(this,j)[j]);t=await babelHelpers.classPrivateFieldLooseBase(this,h)[h](e)}else if(babelHelpers.classPrivateFieldLooseBase(this,I)[I]){var e;const s=(e=babelHelpers.classPrivateFieldLooseBase(this,I)[I])!=null?e:0;t=await babelHelpers.classPrivateFieldLooseBase(this,h)[h](s)}else{const e=s.Type.isNumber(babelHelpers.classPrivateFieldLooseBase(this,j)[j])?babelHelpers.classPrivateFieldLooseBase(this,j)[j]:0;t=await babelHelpers.classPrivateFieldLooseBase(this,v)[v](e)}const l=babelHelpers.classPrivateFieldLooseBase(this,L)[L](t);babelHelpers.classPrivateFieldLooseBase(this,b)[b].set(babelHelpers.classPrivateFieldLooseBase(this,j)[j],l);return l}catch(e){console.error("UserFieldsSlider.#getContent error",e);return""}}async function X(e){var s;const t=await r.apiClient.post(l.Endpoint.LegacyUserFieldGetTask,{task:{id:e}});return(s=t==null?void 0:t.html)!=null?s:""}async function w(e){var s;const t=await r.apiClient.post(l.Endpoint.LegacyUserFieldGetTemplate,{template:{id:e}});return(s=t==null?void 0:t.html)!=null?s:""}function A(e){const t=`tasks-task-legacy-user-fields-${s.Text.getRandom()}`;const a=800;BX.SidePanel.Instance.open(t,{customLeftBoundary:0,width:a,cacheable:false,customRightBoundary:0,contentCallback:()=>e,events:{onCloseComplete:()=>babelHelpers.classPrivateFieldLooseBase(this,F)[F]()}})}function V(){var e;const s=(e=BX.calendar)==null?void 0:e.get();if(!s){return}if(s.popup){s.popup.destroy();s.popup=null;s._layers={};s._current_layer=null}if(s.popup_month){s.popup_month.destroy();s.popup_month=null}if(s.popup_year){s.popup_year.destroy();s.popup_year=null}}function $(e){return`\n\t\t\t<div class="tasks-task-full-card-user-fields">\n\t\t\t\t${babelHelpers.classPrivateFieldLooseBase(this,y)[y]()}\n\t\t\t\t${babelHelpers.classPrivateFieldLooseBase(this,f)[f](e)}\n\t\t\t\t${babelHelpers.classPrivateFieldLooseBase(this,B)[B]()}\n\t\t\t</div>\n\t\t`}function R(e){return`\n\t\t\t<div class="tasks-task-full-card-user-fields-content" id="user-fields-slider-content">\n\t\t\t\t${e}\n\t\t\t</div>\n\t\t`}function x(){return`\n\t\t\t<div class="tasks-task-full-card-user-fields-title">\n\t\t\t\t${c.userFieldsMeta.title}\n\t\t\t</div>\n\t\t`}function M(){return`\n\t\t\t<div class="tasks-task-full-card-user-fields-footer">\n\t\t\t\t${babelHelpers.classPrivateFieldLooseBase(this,H)[H]()}\n\t\t\t\t${babelHelpers.classPrivateFieldLooseBase(this,m)[m]()}\n\t\t\t</div>\n\t\t`}function D(){return`\n\t\t\t<button class="ui-btn --air ui-btn-lg --style-filled ui-btn-no-caps" onclick="top.BX.Tasks.V2.Component.userFieldsSlider.handleConfirm();">\n\t\t\t\t<span class="ui-btn-text">\n\t\t\t\t\t<span class="ui-btn-text-inner">\n\t\t\t\t\t\t${s.Loc.getMessage("TASKS_V2_USER_FIELDS_SLIDER_CONFIRM")}\n\t\t\t\t\t</span>\n\t\t\t\t</span>\n\t\t\t</button>\n\t\t`}function N(){return`\n\t\t\t<button class="ui-btn --air ui-btn-lg --style-plain ui-btn-no-caps" onclick="top.BX.SidePanel.Instance.close();">\n\t\t\t\t<span class="ui-btn-text">\n\t\t\t\t\t<span class="ui-btn-text-inner">\n\t\t\t\t\t\t${s.Loc.getMessage("TASKS_V2_USER_FIELDS_SLIDER_CANCEL")}\n\t\t\t\t\t</span>\n\t\t\t\t</span>\n\t\t\t</button>\n\t\t`}function q(e){return Object.keys(e).map((s=>({key:s,value:babelHelpers.classPrivateFieldLooseBase(this,K)[K](e[s])})))}function G(e){const s={};const t=[];const a=e.querySelectorAll('input[name^="USER_FIELDS["], select[name^="USER_FIELDS["], textarea[name^="USER_FIELDS["]');a.forEach((e=>{const a=e.getAttribute("name");if(!a){return}const l=a.match(/USER_FIELDS\[([^\]]+)](\[])?/);if(!l){return}const i=l[1];const r=Boolean(l[2]);const o=e.closest(".js-id-item-set-item");if(o&&!t.some((e=>e.fieldName===i))){t.push(babelHelpers.classPrivateFieldLooseBase(this,S)[S](o,i))}let n=null;if(e.type==="checkbox"){if(e.checked){n=e.value}else{return}}else{n=e.value}if(r){var c;(c=s[i])!=null?c:s[i]=[];s[i].push(n)}else{s[i]=n}}));return{scheme:t,userFields:babelHelpers.classPrivateFieldLooseBase(this,T)[T](s)}}function z(e,t){const a=Number(e.getAttribute("data-item-value"));const l=e.getAttribute("data-type")||"string";const i=e.getAttribute("data-multiple")==="1";const r=s.Dom.hasClass(e,"required");const o=e.querySelector(".js-id-item-set-item-label");const n=o?o.textContent.trim():t;return{id:a,mandatory:r,editFormLabel:n,userTypeId:l,multiple:i,fieldName:t,entityId:babelHelpers.classPrivateFieldLooseBase(this,g)[g]()}}function J(){return babelHelpers.classPrivateFieldLooseBase(this,C)[C]?"TASKS_TASK_TEMPLATE":"TASKS_TASK"}function Q(e){if(e===""){return null}if(s.Type.isArray(e)&&e.every((e=>e===""))){return[""]}return e}function W(e){t.Notifier.notifyViaBrowserProvider({id:"tasks-user-fields-update-error",text:e==null?void 0:e.message})}function Y(){return babelHelpers.classPrivateFieldLooseBase(this,p)[p].taskId}function Z(){return babelHelpers.classPrivateFieldLooseBase(this,p)[p].isTemplate}function ee(){return babelHelpers.classPrivateFieldLooseBase(this,p)[p].templateId}function se(){return babelHelpers.classPrivateFieldLooseBase(this,p)[p].copiedFromId}const te=new _;e.userFieldsSlider=te})(this.BX.Tasks.V2.Component=this.BX.Tasks.V2.Component||{},BX,BX.UI.NotificationManager,BX.Tasks.V2.Lib,BX.Tasks.V2.Const,BX.Tasks.V2,BX.Tasks.V2.Lib,BX.Tasks.V2.Provider.Service,BX.Tasks.V2.Provider.Service,BX.Tasks.V2.Component.Fields);
//# sourceMappingURL=user-fields-slider.bundle.map.js