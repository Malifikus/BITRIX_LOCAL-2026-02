{"version":3,"file":"task-card.bundle.js","sources":["../src/task-card.js"],"sourcesContent":["import { Extension, Tag, Uri } from 'main.core';\nimport { Popup, PopupManager } from 'main.popup';\nimport type { Slider, LinkOptions, SliderEvent } from 'main.sidepanel';\n\nimport { renderSkeleton } from 'ui.system.skeleton';\nimport type { BitrixVueComponentProps } from 'ui.vue3';\n\nimport { idUtils } from 'tasks.v2.lib.id-utils';\nimport type { TaskModel } from 'tasks.v2.model.tasks';\n\nexport type Params = TaskModel & {\n\ttaskId?: number,\n\tanalytics: AnalyticsParams,\n\turl?: string,\n\tlink?: LinkOptions,\n\tcloseCompleteUrl?: string,\n};\n\nexport type AnalyticsParams = {\n\tcontext: string,\n\tadditionalContext: string,\n\telement: string,\n};\n\nexport type AppField = {\n\ttitle: string,\n\tcomponent: BitrixVueComponentProps,\n\tprops: { [prop: string]: any },\n\tchip: AppChip,\n};\n\nexport type AppChip = {\n\tcomponent: BitrixVueComponentProps,\n\tprops: { [prop: string]: any },\n\tevents: { [event: string]: Function },\n\tcollapsed: boolean,\n\tisEnabled: boolean,\n};\n\ntype TaskCardSettings = {\n\tuserId: number,\n\tformV2Enabled: boolean,\n\tuserTaskPath: string,\n\tgroupTaskPath: string,\n\ttemplatePath: string,\n\tuserDetailUrlTemplate: string,\n\thasMandatoryTaskUserFields: boolean,\n\thasMandatoryTemplateUserFields: boolean,\n};\n\nconst settings: TaskCardSettings = Extension.getSettings('tasks.v2.application.task-card');\nconst load = top.BX.Runtime.loadExtension;\n\nexport class TaskCard\n{\n\tstatic showCompactCard(params: Params = {}): void\n\t{\n\t\tif (window !== top)\n\t\t{\n\t\t\tvoid load('tasks.v2.application.task-card').then((exports) => exports.TaskCard.showCompactCard(params));\n\n\t\t\treturn;\n\t\t}\n\n\t\tconst hasMandatoryUserFields = idUtils.isTemplate(params.taskId ?? 0)\n\t\t\t? settings.hasMandatoryTemplateUserFields\n\t\t\t: settings.hasMandatoryTaskUserFields\n\t\t;\n\n\t\tif (hasMandatoryUserFields && settings.formV2Enabled)\n\t\t{\n\t\t\tthis.showFullCard(params);\n\n\t\t\treturn;\n\t\t}\n\n\t\tconst id = `tasks-compact-card-${params.taskId}`;\n\t\tif (PopupManager.getPopupById(id))\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tconst content = Tag.render`<div/>`;\n\t\tvoid renderSkeleton(\n\t\t\t'/bitrix/js/tasks/v2/application/task-card/src/skeleton.html?v=1',\n\t\t\tcontent,\n\t\t);\n\n\t\tlet card = null;\n\t\tconst popup = new Popup({\n\t\t\tid,\n\t\t\tclassName: 'tasks-compact-card-popup',\n\t\t\twidth: 580,\n\t\t\tminHeight: 324,\n\t\t\tborderRadius: '16px',\n\t\t\tnoAllPaddings: true,\n\t\t\tcontent,\n\t\t\tcacheable: false,\n\t\t\tevents: {\n\t\t\t\tonAfterClose: (): void => card.unmount(),\n\t\t\t},\n\t\t\toverlay: {\n\t\t\t\topacity: 100,\n\t\t\t\tbackgroundColor: '#0363',\n\t\t\t\tblur: 'blur(2px)',\n\t\t\t},\n\t\t});\n\n\t\tvoid load('tasks.v2.application.task-compact-card').then((exports) => {\n\t\t\tcard = new exports.TaskCompactCard(params);\n\t\t\tcard.mount(popup);\n\t\t});\n\n\t\tpopup.show();\n\t}\n\n\tstatic showFullCard(params: Params = {}): void\n\t{\n\t\tlet card = null;\n\t\tconst options = {\n\t\t\tcontentCallback: async (slider: Slider): Promise<HTMLElement> => {\n\t\t\t\tconst exports = await load('tasks.v2.application.task-full-card');\n\n\t\t\t\tcard = new exports.TaskFullCard(params);\n\n\t\t\t\treturn card.mount(slider);\n\t\t\t},\n\t\t\tevents: {\n\t\t\t\tonClose: (event: SliderEvent): void => card?.onClose(event),\n\t\t\t\tonCloseComplete: (): void => {\n\t\t\t\t\tif (card)\n\t\t\t\t\t{\n\t\t\t\t\t\tcard.onCloseComplete();\n\t\t\t\t\t}\n\t\t\t\t\telse if (params.closeCompleteUrl)\n\t\t\t\t\t{\n\t\t\t\t\t\tlocation.href = params.closeCompleteUrl;\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t},\n\t\t};\n\n\t\tBX.SidePanel.Instance.open(params.url ?? this.getUrl(params.taskId), options);\n\t}\n\n\tstatic getUrl(entityId: number | string, groupId: number): string\n\t{\n\t\tconst template = String(entityId).split('template')[1];\n\t\tconst id = Number(template) || template || entityId;\n\t\tconst isReal = Number.isInteger(id);\n\n\t\tconst path = (entityId?.startsWith?.('template') ? settings.templatePath : (groupId ? settings.groupTaskPath : settings.userTaskPath))\n\t\t\t.replace('#user_id#', settings.userId)\n\t\t\t.replace('#group_id#', groupId)\n\t\t\t.replace('#task_id#', isReal ? id : 0)\n\t\t\t.replace('#template_id#', isReal ? id : 0)\n\t\t\t.replace('#action#', isReal ? 'view' : 'edit')\n\t\t;\n\n\t\tif (isReal)\n\t\t{\n\t\t\treturn path;\n\t\t}\n\n\t\treturn new Uri(path).setQueryParam('id', id).toString();\n\t}\n}\n"],"names":["settings","Extension","getSettings","load","top","BX","Runtime","loadExtension","TaskCard","showCompactCard","params","window","then","exports","hasMandatoryUserFields","idUtils","isTemplate","taskId","hasMandatoryTemplateUserFields","hasMandatoryTaskUserFields","formV2Enabled","showFullCard","id","PopupManager","getPopupById","content","Tag","render","renderSkeleton","card","popup","Popup","className","width","minHeight","borderRadius","noAllPaddings","cacheable","events","onAfterClose","unmount","overlay","opacity","backgroundColor","blur","TaskCompactCard","mount","show","options","contentCallback","slider","TaskFullCard","onClose","event","onCloseComplete","closeCompleteUrl","location","href","SidePanel","Instance","open","url","getUrl","entityId","groupId","template","String","split","Number","isReal","isInteger","path","startsWith","templatePath","groupTaskPath","userTaskPath","replace","userId","Uri","setQueryParam","toString"],"mappings":"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"}