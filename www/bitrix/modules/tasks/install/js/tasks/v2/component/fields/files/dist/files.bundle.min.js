this.BX=this.BX||{};this.BX.Tasks=this.BX.Tasks||{};this.BX.Tasks.V2=this.BX.Tasks.V2||{};this.BX.Tasks.V2.Component=this.BX.Tasks.V2.Component||{};(function(t,e,i,s,n,l,o,a,r,d,h,u,c,p,f,S,m,k,v,A){"use strict";const C=Object.freeze({id:u.TaskField.Files,title:s.Loc.getMessage("TASKS_V2_FILES_TITLE")});const F={components:{UiButton:S.Button},inject:{taskId:{}},setup(){return{ButtonSize:S.ButtonSize,AirButtonStyle:S.AirButtonStyle,Outline:m.Outline}},methods:{handleClick(){v.fileService.get(this.taskId).browse({bindElement:this.$el})}},template:`\n\t\t<span data-task-files-upload>\n\t\t\t<UiButton\n\t\t\t\t:text="loc('TASKS_V2_FILES_UPLOAD')"\n\t\t\t\t:size="ButtonSize.MEDIUM"\n\t\t\t\t:style="AirButtonStyle.SELECTION"\n\t\t\t\t:leftIcon="Outline.ATTACH"\n\t\t\t\t@click="handleClick"\n\t\t\t/>\n\t\t</span>\n\t`};const B={components:{UiButton:S.Button},inject:{task:{},taskId:{}},props:{files:{type:Array,required:true}},setup(){return{ButtonSize:S.ButtonSize,AirButtonStyle:S.AirButtonStyle,ButtonCounterColor:S.ButtonCounterColor,ButtonState:S.ButtonState,Outline:m.Outline}},data(){return{loading:false}},computed:{archiveLink(){return this.task.archiveLink},filesSize(){return this.files.reduce(((t,e)=>t+e.size),0)},formattedFilesSize(){return r.formatFileSize(this.filesSize)}},methods:{async downloadArchive(){if(v.fileService.get(this.taskId).hasPendingRequests()){this.loading=true;await v.fileService.get(this.taskId).handleSave();this.loading=false}o.SidePanel.Instance.emulateAnchorClick(this.archiveLink)}},template:`\n\t\t<div data-task-files-download-archive @click="downloadArchive">\n\t\t\t<UiButton\n\t\t\t\t:text="loc('TASKS_V2_FILES_DOWNLOAD_ARCHIVE', { '#FILES_SIZE#': formattedFilesSize })"\n\t\t\t\t:size="ButtonSize.MEDIUM"\n\t\t\t\t:style="AirButtonStyle.PLAIN_NO_ACCENT"\n\t\t\t\t:state="loading ? ButtonState.WAITING : null"\n\t\t\t/>\n\t\t</div>\n\t`};const g={name:"TaskFilesSheet",components:{UploadButton:F,DownloadArchiveButton:B,BottomSheet:n.BottomSheet,BIcon:m.BIcon,DropZone:l.DropZone,UserFieldWidgetComponent:A.DiskUserFieldWidgetComponent},inject:{task:{},isEdit:{}},props:{taskId:{type:[Number,String],required:true},sheetBindProps:{type:Object,required:true}},emits:["close"],setup(t){return{Outline:m.Outline,EntityTypes:v.EntityTypes,fileService:v.fileService.get(t.taskId),uploaderAdapter:v.fileService.get(t.taskId).getAdapter()}},data(){return{uniqueKey:s.Text.getRandom(),files:this.fileService.getFiles()}},computed:{canAttachFiles(){return this.task.rights.attachFile||this.task.rights.edit},filesCount(){return this.files.length},archiveLink(){return this.task.archiveLink},widgetOptions(){return{isEmbedded:true,withControlPanel:false,canCreateDocuments:false,tileWidgetOptions:{compact:true,autoCollapse:false,readonly:!this.canAttachFiles,enableDropzone:false,hideDropArea:true,removeFromServer:!this.isEdit,forceDisableSelection:true}}},showFooter(){return this.filesCount>1||this.canAttachFiles},canDownloadArchive(){return this.filesCount>1&&this.archiveLink},bottomSheetContainer(){return document.getElementById(`b24-bottom-sheet-${this.uniqueKey}`)||null}},template:`\n\t\t<BottomSheet\n\t\t\t:sheetBindProps\n\t\t\t:padding="0"\n\t\t\t:uniqueKey\n\t\t\t@close="$emit('close')"\n\t\t>\n\t\t\t<div class="tasks-field-files-sheet" :data-task-id="taskId" ref="content">\n\t\t\t\t<div class="tasks-field-files-header">\n\t\t\t\t\t<div class="tasks-field-files-title">{{ loc('TASKS_V2_FILES_TITLE') }}</div>\n\t\t\t\t\t<BIcon\n\t\t\t\t\t\tdata-task-files-close\n\t\t\t\t\t\tclass="tasks-field-files-close"\n\t\t\t\t\t\thoverable\n\t\t\t\t\t\t:name="Outline.CROSS_L"\n\t\t\t\t\t\t@click="$emit('close')"\n\t\t\t\t\t/>\n\t\t\t\t</div>\n\t\t\t\t<div class="tasks-field-files-list">\n\t\t\t\t\t<UserFieldWidgetComponent :uploaderAdapter :widgetOptions/>\n\t\t\t\t</div>\n\t\t\t\t<div\n\t\t\t\t\tv-if="showFooter"\n\t\t\t\t\tclass="tasks-field-files-footer"\n\t\t\t\t\t:class="{ '--with-archive': canDownloadArchive }"\n\t\t\t\t>\n\t\t\t\t\t<DownloadArchiveButton v-if="canDownloadArchive" :files/>\n\t\t\t\t\t<UploadButton v-if="canAttachFiles"/>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t<DropZone\n\t\t\t\tv-if="canAttachFiles"\n\t\t\t\t:container="bottomSheetContainer || {}"\n\t\t\t\t:entityId="taskId"\n\t\t\t\t:entityType="EntityTypes.Task"\n\t\t\t/>\n\t\t</BottomSheet>\n\t`};const I={name:"TaskFiles",components:{BIcon:m.BIcon,UserFieldWidgetComponent:A.DiskUserFieldWidgetComponent,FilesSheet:g},directives:{hint:e.hint},inject:{task:{},isEdit:{}},props:{isSheetShown:{type:Boolean,required:true},taskId:{type:[Number,String],required:true},sheetBindProps:{type:Object,required:true}},emits:["update:isSheetShown"],setup(t){return{Animated:m.Animated,Outline:m.Outline,filesMeta:C,fileService:v.fileService.get(t.taskId),uploaderAdapter:v.fileService.get(t.taskId).getAdapter()}},data(){return{files:this.fileService.getFiles(),isFilesScrollable:false,showPreview:false}},computed:{filesCount(){return this.files.length},textFormatted(){if(this.filesCount>0){return this.loc("TASKS_V2_FILES_COUNT",{"#COUNT#":this.filesCount})}return this.loc("TASKS_V2_FILES_TITLE")},isUploading(){return this.files.some((({status:t})=>[r.FileStatus.UPLOADING,r.FileStatus.LOADING].includes(t)))},canAttachFiles(){return this.task.rights.attachFile||this.task.rights.edit},widgetOptions(){return{isEmbedded:true,withControlPanel:false,canCreateDocuments:false,tileWidgetOptions:{compact:true,hideDropArea:true,enableDropzone:false,readonly:!this.canAttachFiles,autoCollapse:false,removeFromServer:!this.isEdit,forceDisableSelection:true}}},tooltip(){return()=>i.tooltip({text:this.loc("TASKS_V2_FILES_ADD"),popupOptions:{offsetLeft:this.$refs.add.$el.offsetWidth/2}})}},watch:{files:{handler(t){if(t.length>0&&this.fileService.isFileBrowserClosed()){this.showPreview=true;this.fileService.resetFileBrowserClosedState()}this.handleFilesScrollable()},deep:true}},mounted(){this.showPreview=this.isEdit;this.fileService.subscribe("onFileAdd",this.handleFilesScrollable);this.fileService.subscribe("onFileRemove",this.handleFilesScrollable)},beforeUnmount(){this.fileService.unsubscribe("onFileAdd",this.handleFilesScrollable);this.fileService.unsubscribe("onFileRemove",this.handleFilesScrollable)},methods:{handleAddClick(){this.fileService.browse({bindElement:this.$refs.add.$el,onHideCallback:this.onFileBrowserClose})},handleOpenClick(){if(this.filesCount===0){this.fileService.browse({bindElement:this.$refs.title,onHideCallback:this.onFileBrowserClose})}else{this.setSheetShown(true)}},async handleFilesScrollable(){await this.$nextTick();this.checkFilesScrollable()},checkFilesScrollable(){if(this.$refs.files){this.isFilesScrollable=this.$refs.files.scrollHeight>this.$refs.files.clientHeight}},onFileBrowserClose(){this.fileService.setFileBrowserClosed(true)},setSheetShown(t){this.$emit("update:isSheetShown",t)}},template:`\n\t\t<div\n\t\t\tclass="tasks-field-files"\n\t\t\t:data-task-id="taskId"\n\t\t\t:data-task-field-id="filesMeta.id"\n\t\t\t:data-task-files-count="filesCount"\n\t\t>\n\t\t\t<div class="tasks-field-files-title">\n\t\t\t\t<div\n\t\t\t\t\tclass="tasks-field-files-main"\n\t\t\t\t\tdata-task-files-open\n\t\t\t\t\t@click="handleOpenClick"\n\t\t\t\t\tref="title"\n\t\t\t\t>\n\t\t\t\t\t<template v-if="isUploading">\n\t\t\t\t\t\t<BIcon class="tasks-field-files-icon" :name="Animated.LOADER_WAIT"/>\n\t\t\t\t\t\t<div class="tasks-field-files-text">{{ loc('TASKS_V2_FILES_LOADING') }}</div>\n\t\t\t\t\t</template>\n\t\t\t\t\t<template v-else>\n\t\t\t\t\t\t<BIcon class="tasks-field-files-icon" :name="Outline.ATTACH"/>\n\t\t\t\t\t\t<div class="tasks-field-files-text">{{ textFormatted }}</div>\n\t\t\t\t\t</template>\n\t\t\t\t</div>\n\t\t\t\t<div v-if="canAttachFiles" class="tasks-field-files-add-container" v-hint="tooltip">\n\t\t\t\t\t<BIcon\n\t\t\t\t\t\tclass="tasks-field-files-add"\n\t\t\t\t\t\t:name="Outline.PLUS_L"\n\t\t\t\t\t\thoverable\n\t\t\t\t\t\tdata-task-files-plus\n\t\t\t\t\t\t@click="handleAddClick"\n\t\t\t\t\t\tref="add"\n\t\t\t\t\t/>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t<div\n\t\t\t\tv-if="showPreview && filesCount > 0"\n\t\t\t\tclass="tasks-field-files-list --card"\n\t\t\t\tref="files"\n\t\t\t>\n\t\t\t\t<UserFieldWidgetComponent :uploaderAdapter :widgetOptions/>\n\t\t\t</div>\n\t\t\t<template v-if="isFilesScrollable">\n\t\t\t\t<div class="tasks-field-files-shadow">\n\t\t\t\t\t<div class="tasks-field-files-shadow-white"/>\n\t\t\t\t</div>\n\t\t\t\t<div\n\t\t\t\t\tclass="tasks-field-files-more-button"\n\t\t\t\t\t@click="setSheetShown(true)"\n\t\t\t\t>\n\t\t\t\t\t<div class="tasks-field-files-more-button-text">{{ loc('TASKS_V2_FILES_MORE') }}</div>\n\t\t\t\t</div>\n\t\t\t</template>\n\t\t</div>\n\t\t<FilesSheet\n\t\t\tv-if="isSheetShown"\n\t\t\t:taskId\n\t\t\t:sheetBindProps\n\t\t\t@close="setSheetShown(false)"\n\t\t/>\n\t`};const b={components:{Popup:f.Popup,UiButton:S.Button,UserFieldWidgetComponent:A.DiskUserFieldWidgetComponent},props:{taskId:{type:[Number,String],required:true},getBindElement:{type:Function,required:true}},emits:["upload","close"],setup(t){return{ButtonSize:S.ButtonSize,AirButtonStyle:S.AirButtonStyle,ButtonIcon:S.ButtonIcon,Outline:m.Outline,uploaderAdapter:v.fileService.get(t.taskId).getAdapter()}},data(){return{files:v.fileService.get(this.taskId).getFiles()}},computed:{bindElement(){return this.getBindElement()},options(){return{id:"tasks-field-files-popup",bindElement:this.bindElement,minWidth:380,maxHeight:320,padding:18,bindOptions:{forceBindPosition:true,forceTop:true,position:"top"},closeByEsc:true,autoHideHandler:t=>{var e;const i=this.files.some((({isMenuShown:t})=>t));return((e=this.$refs.popup)==null?void 0:e.autoHideHandler(t))&&!i}}},widgetOptions(){return{isEmbedded:true,withControlPanel:false,canCreateDocuments:false,tileWidgetOptions:{hideDropArea:true,enableDropzone:false,compact:true,autoCollapse:false}}},filesCount(){return this.files.length}},watch:{filesCount(){if(this.filesCount===0){this.closePopup()}}},methods:{handleClearClick(){v.fileService.get(this.taskId).getAdapter().getUploader().removeFiles();this.closePopup()},handleUploadClick(){v.fileService.get(this.taskId).browseFiles()},handleMyDriveClick(){v.fileService.get(this.taskId).browseMyDrive()},closePopup(){this.$emit("close")}},template:`\n\t\t<Popup :options ref="popup" @close="closePopup">\n\t\t\t<div class="tasks-field-files-popup">\n\t\t\t\t<div class="tasks-field-files-popup-files">\n\t\t\t\t\t<UserFieldWidgetComponent :uploaderAdapter :widgetOptions/>\n\t\t\t\t</div>\n\t\t\t\t<div class="tasks-field-files-popup-footer">\n\t\t\t\t\t<div class="tasks-field-files-popup-add-buttons">\n\t\t\t\t\t\t<UiButton\n\t\t\t\t\t\t\t:text="loc('TASKS_V2_FILES_UPLOAD_BUTTON')"\n\t\t\t\t\t\t\t:size="ButtonSize.SMALL"\n\t\t\t\t\t\t\t:style="AirButtonStyle.TINTED"\n\t\t\t\t\t\t\t:leftIcon="Outline.DOWNLOAD"\n\t\t\t\t\t\t\t@click="handleUploadClick"\n\t\t\t\t\t\t/>\n\t\t\t\t\t\t<UiButton\n\t\t\t\t\t\t\t:text="loc('TASKS_V2_FILES_MY_DRIVE')"\n\t\t\t\t\t\t\t:size="ButtonSize.SMALL"\n\t\t\t\t\t\t\t:style="AirButtonStyle.TINTED"\n\t\t\t\t\t\t\t:leftIcon="Outline.UPLOAD"\n\t\t\t\t\t\t\t@click="handleMyDriveClick"\n\t\t\t\t\t\t/>\n\t\t\t\t\t</div>\n\t\t\t\t\t<UiButton\n\t\t\t\t\t\t:text="loc('TASKS_V2_FILES_CLEAR')"\n\t\t\t\t\t\t:size="ButtonSize.SMALL"\n\t\t\t\t\t\t:style="AirButtonStyle.PLAIN_NO_ACCENT"\n\t\t\t\t\t\t:leftIcon="Outline.TRASHCAN"\n\t\t\t\t\t\t@click="handleClearClick"\n\t\t\t\t\t/>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</Popup>\n\t`};const w={components:{Chip:d.Chip,FilesPopup:b},inject:{analytics:{},cardType:{},task:{}},props:{taskId:{type:[Number,String],required:true},isAutonomous:{type:Boolean,default:false}},setup(t){return{filesMeta:C,fileService:v.fileService.get(t.taskId)}},data(){return{files:this.fileService.getFiles(),isPopupShown:false,isPopupShownWithFiles:false}},computed:{group(){return this.$store.getters[`${u.Model.Groups}/getById`](this.task.groupId)},filesCount(){return this.files.length},design(){return{[!this.isAutonomous&&!this.isSelected]:d.ChipDesign.ShadowNoAccent,[!this.isAutonomous&&this.isSelected]:d.ChipDesign.ShadowAccent,[this.isAutonomous&&!this.isSelected]:d.ChipDesign.OutlineNoAccent,[this.isAutonomous&&this.isSelected]:d.ChipDesign.OutlineAccent,[this.hasError]:d.ChipDesign.OutlineAlert}.true},isSelected(){if(this.isAutonomous){return this.files.length>0}return this.task.filledFields[C.id]||this.files.length>0},icon(){if(this.isAutonomous&&this.isUploading){return m.Animated.LOADER_WAIT}return m.Outline.ATTACH},text(){if(this.isAutonomous&&this.filesCount>0){return this.loc("TASKS_V2_FILES_COUNT",{"#COUNT#":this.filesCount})}return C.title},isUploading(){return this.fileService.isUploading()},hasError(){return this.files.some((({status:t})=>[r.FileStatus.UPLOAD_FAILED,r.FileStatus.LOAD_FAILED].includes(t)))},canAttachFiles(){return this.task.rights.attachFile||this.task.rights.edit},popupHasAlreadyBeenShown(){return this.filesCount>0&&this.isPopupShownWithFiles}},mounted(){this.fileService.subscribe("onFileAdd",this.handleFileAdd);this.fileService.subscribe("onFileComplete",this.handleFileComplete)},beforeUnmount(){this.fileService.unsubscribe("onFileAdd",this.handleFileAdd);this.fileService.unsubscribe("onFileComplete",this.handleFileComplete)},methods:{handleFileAdd(){if(this.isAutonomous&&this.popupHasAlreadyBeenShown){this.showPopup()}},handleFileComplete(t){this.sendAnalytics(t.getData())},sendAnalytics(t){var e;p.analytics.sendAttachFile(this.analytics,{cardType:this.cardType,collabId:((e=this.group)==null?void 0:e.type)===u.GroupType.Collab?this.group.id:null,fileOrigin:t.origin,fileSize:t.size,fileExtension:t.extension,filesCount:this.filesCount})},handleClick(){if(!this.isAutonomous&&this.isSelected){this.highlightField();return}if(this.files.length>0){this.isPopupShownWithFiles=true;this.showPopup()}else{this.browseFiles()}},showPopup(){this.isPopupShown=true},closePopup(){this.isPopupShown=false;if(!this.filesCount){this.isPopupShownWithFiles=false}},browseFiles(){this.fileService.browse({bindElement:this.$refs.chip.$el,onHideCallback:this.onFileBrowserClose,compact:this.cardType===u.CardType.Compact})},highlightField(){void c.fieldHighlighter.setContainer(this.$root.$el).highlight(C.id)},onFileBrowserClose(){var t;(t=this.$refs.chip)==null?void 0:t.$el.focus();this.fileService.setFileBrowserClosed(true)}},template:`\n\t\t<Chip\n\t\t\tv-if="isSelected || canAttachFiles"\n\t\t\t:design\n\t\t\t:icon\n\t\t\t:text\n\t\t\t:data-task-id="taskId"\n\t\t\t:data-task-chip-id="filesMeta.id"\n\t\t\tref="chip"\n\t\t\t@click="handleClick"\n\t\t/>\n\t\t<FilesPopup\n\t\t\tv-if="isPopupShown"\n\t\t\t:taskId\n\t\t\t:getBindElement="() => $refs.chip.$el"\n\t\t\t@upload="browseFiles"\n\t\t\t@close="closePopup"\n\t\t/>\n\t`};t.Files=I;t.FilesSheet=g;t.FilesChip=w;t.filesMeta=C})(this.BX.Tasks.V2.Component.Fields=this.BX.Tasks.V2.Component.Fields||{},BX.Vue3.Directives,BX.Tasks.V2.Component.Elements,BX,BX.Tasks.V2.Component.Elements,BX.Tasks.V2.Component,BX.SidePanel,BX.Tasks.V2.Component.Fields,BX.UI.Uploader,BX.UI.System.Chip.Vue,BX,BX.Tasks.V2.Const,BX.Tasks.V2.Lib,BX.Tasks.V2.Lib,BX.UI.Vue3.Components,BX.Vue3.Components,BX.UI.IconSet,BX,BX.Tasks.V2.Provider.Service,BX.Tasks.V2.Component.Elements);
//# sourceMappingURL=files.bundle.map.js