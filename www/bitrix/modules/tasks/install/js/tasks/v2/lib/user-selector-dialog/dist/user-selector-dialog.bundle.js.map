{"version":3,"file":"user-selector-dialog.bundle.js","sources":["../src/user-selector-dialog.js"],"sourcesContent":["import { Popup } from 'main.popup';\nimport type { BaseEvent } from 'main.core.events';\n\nimport { Core } from 'tasks.v2.core';\nimport { EntitySelectorEntity, Model } from 'tasks.v2.const';\nimport { EntitySelectorDialog, type ItemId, type Item } from 'tasks.v2.lib.entity-selector-dialog';\nimport type { UserModel } from 'tasks.v2.model.users';\n\ntype Params = {\n\ttargetNode: HTMLElement,\n\tids: number[],\n\tselectableIds: Set<number>,\n\tonClose: Function,\n\tisMultiple: boolean,\n\twithAngle: boolean,\n};\n\nlet dialog: EntitySelectorDialog = null;\n\nexport const usersDialog = new class\n{\n\t#ids: number[];\n\t#selectableIds: ?Set<number>;\n\t#onClose: ?Function;\n\t#withAngle: ?boolean;\n\t#isMultiple: boolean = true;\n\n\t#hidePromise: Resolvable;\n\n\tasync show(params: Params): Promise<void>\n\t{\n\t\tif (dialog?.isOpen() && dialog.getTargetNode() !== params.targetNode)\n\t\t{\n\t\t\tthis.#hidePromise = new Resolvable();\n\n\t\t\tawait this.#hidePromise;\n\t\t}\n\n\t\tthis.#ids = params.ids;\n\t\tthis.#selectableIds = params.selectableIds;\n\t\tthis.#onClose = params.onClose;\n\t\tthis.#withAngle = params.withAngle;\n\t\tthis.#isMultiple = params.isMultiple ?? true;\n\n\t\tdialog ??= this.#createDialog();\n\t\tthis.#fillDialog(this.#ids);\n\t\tdialog.selectItemsByIds(this.#items);\n\t\tthis.#setSelectableByIds();\n\t\tdialog.showTo(params.targetNode);\n\t}\n\n\tgetDialog(): EntitySelectorDialog\n\t{\n\t\treturn dialog;\n\t}\n\n\t#createDialog(): EntitySelectorDialog\n\t{\n\t\tconst restrictions = Core.getParams().restrictions;\n\n\t\treturn new EntitySelectorDialog({\n\t\t\tcontext: 'tasks-card',\n\t\t\tenableSearch: true,\n\t\t\tentities: [\n\t\t\t\t{\n\t\t\t\t\tid: EntitySelectorEntity.User,\n\t\t\t\t\toptions: {\n\t\t\t\t\t\temailUsers: true,\n\t\t\t\t\t\tinviteGuestLink: true,\n\t\t\t\t\t\tanalyticsSource: 'tasks',\n\t\t\t\t\t\tlockGuestLink: !restrictions.mailUserIntegration.available,\n\t\t\t\t\t\tlockGuestLinkFeatureId: restrictions.mailUserIntegration.featureId,\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\tid: EntitySelectorEntity.Department,\n\t\t\t\t},\n\t\t\t],\n\t\t\tpreselectedItems: this.#items,\n\t\t\tevents: {\n\t\t\t\t'Item:onSelect': (event: BaseEvent): void => {\n\t\t\t\t\tif (this.#isMultiple)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tconst { item } = event.getData();\n\n\t\t\t\t\tdialog.selectItemsByIds(this.#mapIdsToItemIds([item.getId()]));\n\n\t\t\t\t\tdialog.hide();\n\t\t\t\t},\n\t\t\t\tonLoad: (): void => {\n\t\t\t\t\tthis.#fillStore();\n\t\t\t\t\tthis.#setSelectableByIds();\n\t\t\t\t},\n\t\t\t\tonHide: (): void => this.#hidePromise?.resolve(),\n\t\t\t},\n\t\t\tpopupOptions: {\n\t\t\t\tevents: {\n\t\t\t\t\tonShow: (baseEvent: BaseEvent): void => {\n\t\t\t\t\t\tconst popup = baseEvent.getTarget();\n\t\t\t\t\t\tif (!this.#withAngle)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tpopup.setAngle(false);\n\t\t\t\t\t\t\tpopup.setOffset({ offsetLeft: 0 });\n\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tconst popupWidth = popup.getPopupContainer().offsetWidth;\n\t\t\t\t\t\tconst targetNodeWidth = 10;\n\n\t\t\t\t\t\tconst offsetLeft = targetNodeWidth - (popupWidth / 2);\n\t\t\t\t\t\tconst angleShift = Popup.getOption('angleLeftOffset') - Popup.getOption('angleMinTop');\n\n\t\t\t\t\t\tpopup.setAngle({ offset: popupWidth / 2 - angleShift });\n\t\t\t\t\t\tpopup.setOffset({ offsetLeft: offsetLeft + Popup.getOption('angleLeftOffset') });\n\t\t\t\t\t},\n\t\t\t\t\tonClose: (): void => {\n\t\t\t\t\t\tthis.#fillStore();\n\t\t\t\t\t\tconst ids = dialog.getSelectedItems().map((item: Item) => item.getId());\n\t\t\t\t\t\tthis.#onClose?.(ids);\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t},\n\t\t});\n\t}\n\n\t#fillDialog(ids: number[]): void\n\t{\n\t\tif (!dialog || !dialog.isLoaded())\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tconst itemIds = new Set(dialog.getItems().map((it) => it.getId()));\n\t\tids.filter((id) => !itemIds.has(id)).forEach((id: number) => {\n\t\t\tconst user: UserModel = Core.getStore().getters[`${Model.Users}/getById`](id);\n\t\t\tdialog.addItem({\n\t\t\t\tid,\n\t\t\t\tentityId: EntitySelectorEntity.User,\n\t\t\t\tentityType: user.type,\n\t\t\t\ttitle: user.name,\n\t\t\t\tavatar: user.image,\n\t\t\t\ttabs: ['recents'],\n\t\t\t});\n\t\t});\n\t}\n\n\t#fillStore(): void\n\t{\n\t\tconst users = dialog.getSelectedItems().map((item: Item): UserModel => ({\n\t\t\tid: item.getId(),\n\t\t\tname: item.getTitle(),\n\t\t\timage: item.getAvatar(),\n\t\t\ttype: item.getEntityType(),\n\t\t}));\n\n\t\tvoid Core.getStore().dispatch(`${Model.Users}/upsertMany`, users);\n\t}\n\n\t#setSelectableByIds(): void\n\t{\n\t\tconst selectableIds = dialog.getItems().map((item: Item) => item.getId());\n\t\tconst unselectableIds = this.#ids.filter((id) => this.#selectableIds && !this.#selectableIds?.has(id));\n\n\t\tdialog.setSelectableByIds({\n\t\t\tselectable: this.#mapIdsToItemIds(selectableIds),\n\t\t\tunselectable: this.#mapIdsToItemIds(unselectableIds),\n\t\t});\n\t}\n\n\tget #items(): ItemId[]\n\t{\n\t\treturn this.#mapIdsToItemIds(this.#ids);\n\t}\n\n\t#mapIdsToItemIds(ids: number[]): ItemId[]\n\t{\n\t\treturn ids.map((id: number) => [EntitySelectorEntity.User, id]);\n\t}\n}();\n\nfunction Resolvable(): Promise\n{\n\tlet resolve = null;\n\tconst promise = new Promise((res) => {\n\t\tresolve = res;\n\t});\n\n\tpromise.resolve = resolve;\n\n\treturn promise;\n}\n"],"names":["dialog","usersDialog","show","params","isOpen","getTargetNode","targetNode","Resolvable","ids","selectableIds","onClose","withAngle","isMultiple","selectItemsByIds","showTo","getDialog","restrictions","Core","getParams","EntitySelectorDialog","context","enableSearch","entities","id","EntitySelectorEntity","User","options","emailUsers","inviteGuestLink","analyticsSource","lockGuestLink","mailUserIntegration","available","lockGuestLinkFeatureId","featureId","Department","preselectedItems","events","event","item","getData","getId","hide","onLoad","onHide","resolve","popupOptions","onShow","baseEvent","popup","getTarget","setAngle","setOffset","offsetLeft","popupWidth","getPopupContainer","offsetWidth","targetNodeWidth","angleShift","Popup","getOption","offset","getSelectedItems","map","isLoaded","itemIds","Set","getItems","it","filter","has","forEach","user","getStore","getters","Model","Users","addItem","entityId","entityType","type","title","name","avatar","image","tabs","users","getTitle","getAvatar","getEntityType","dispatch","unselectableIds","setSelectableByIds","selectable","unselectable","promise","Promise","res"],"mappings":"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"}