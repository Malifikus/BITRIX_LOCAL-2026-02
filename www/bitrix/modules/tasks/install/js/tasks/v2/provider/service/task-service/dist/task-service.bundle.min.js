this.BX=this.BX||{};this.BX.Tasks=this.BX.Tasks||{};this.BX.Tasks.V2=this.BX.Tasks.V2||{};this.BX.Tasks.V2.Provider=this.BX.Tasks.V2.Provider||{};(function(e,t,s,a,i,r,l,n,o,d,c,u,p,T,m,h,k,v){"use strict";function b(e){var t,a,r,n,o,d;const u=T.Core.getParams().currentUser;const p=e.parentId;const m=e.responsibleIds;return{id:e.id,title:e.title,description:S(e.description,I(e.description)),descriptionChecksum:e.descriptionChecksum,creator:S(e.creatorId,{id:e.creatorId}),createdTs:S(e.createdTs,Math.floor(e.createdTs/1e3)),responsible:S(m,(m==null?void 0:m.length)<2?{id:(t=m==null?void 0:m[0])!=null?t:0}:u),responsibleCollection:S(m,m==null?void 0:m.map((e=>({id:e})))),deadlineTs:S(e.deadlineTs,Math.floor(e.deadlineTs/1e3)),deadlineAfter:S(e.deadlineAfter,Math.floor(e.deadlineAfter/1e3)),needsControl:T.Core.getParams().restrictions.control.available?e.needsControl:false,startPlanTs:S(e.startPlanTs,Math.floor(e.startPlanTs/1e3)),endPlanTs:S(e.endPlanTs,Math.floor(e.endPlanTs/1e3)),startDatePlanAfter:S(e.startDatePlanAfter,Math.floor(e.startDatePlanAfter/1e3)),endDatePlanAfter:S(e.endDatePlanAfter,Math.floor(e.endDatePlanAfter/1e3)),fileIds:e.fileIds,checklist:e.checklist,parent:S(p,i.idUtils.isTemplate(p)?null:{id:p}),base:S(p,i.idUtils.isTemplate(p)?{id:i.idUtils.unbox(p)}:null),dependsOn:e.relatedTaskIds,ganttLinks:S(e.ganttTaskIds,P(e.id,e.ganttTaskIds)),group:S(e.groupId,{id:e.groupId}),stage:S(e.stageId,{id:e.stageId}),epicId:e.epicId,storyPoints:e.storyPoints,flow:S(e.flowId,{id:e.flowId}),priority:S(e.isImportant,e.isImportant?"high":"low"),status:e.status,statusChangedTs:S(e.statusChangedTs,Math.floor(e.statusChangedTs/1e3)),accomplices:S(e.accomplicesIds,(a=e.accomplicesIds)==null?void 0:a.map((e=>({id:e})))),auditors:S(e.auditorsIds,(r=e.auditorsIds)==null?void 0:r.map((e=>({id:e})))),tags:S(e.tags,(n=e.tags)==null?void 0:n.map((e=>({name:e})))),chatId:e.chatId,crmItemIds:e.crmItemIds,email:e.email,allowsChangeDeadline:e.allowsChangeDeadline,allowsChangeDatePlan:e.allowsChangeDatePlan,allowsTimeTracking:e.allowsTimeTracking,estimatedTime:e.estimatedTime,matchesWorkTime:T.Core.getParams().restrictions.skipWeekends.available?e.matchesWorkTime:false,matchesSubTasksTime:T.Core.getParams().restrictions.relatedSubtaskDeadlines.available?e.matchesSubTasksTime:false,autocompleteSubTasks:T.Core.getParams().restrictions.relatedSubtaskDeadlines.available?e.autocompleteSubTasks:false,source:e.source,templateId:e.templateId,requireResult:e.requireResult,reminders:S(e.reminders,(o=e.reminders)==null?void 0:o.map((e=>c.RemindersMappers.mapModelToDto(e)))),maxDeadlineChangeDate:e.maxDeadlineChangeDate,maxDeadlineChanges:e.maxDeadlineChanges,requireDeadlineChangeReason:e.requireDeadlineChangeReason,deadlineChangeReason:e.deadlineChangeReason,containsSubTasks:e.containsSubTasks,userFields:e.userFields,type:S(e.isForNewUser,e.isForNewUser?v.TemplateType.NewUsers:v.TemplateType.Usual),permissions:S(e.permissions,(d=e.permissions)==null?void 0:d.map((e=>l.TemplateMappers.mapPermissionModelToDto(e)))),mark:e.mark,replicate:e.replicate&&s.Type.isObject(e.replicateParams),replicateParams:w(e)}}function y(e){var t,a,r,n,o,d,c,u,p,m,h,k,b,y,g;const f=new Set(["maxDeadlineChangeDate","maxDeadlineChanges"]);const I={id:e.id,title:e.title,isImportant:S(e.priority,e.priority==="high"),description:S(e.description,s.Text.decode(e.description)),descriptionChecksum:e.descriptionChecksum,creatorId:(t=e.creator)==null?void 0:t.id,createdTs:S(e.createdTs,e.createdTs*1e3),responsibleIds:M(e),deadlineTs:S(e.deadlineTs,e.deadlineTs*1e3),deadlineAfter:S(e.deadlineAfter,e.deadlineAfter*1e3),needsControl:e.needsControl,startPlanTs:S(e.startPlanTs,e.startPlanTs*1e3),endPlanTs:S(e.endPlanTs,e.endPlanTs*1e3),startDatePlanAfter:S(e.startDatePlanAfter,e.startDatePlanAfter*1e3),endDatePlanAfter:S(e.endDatePlanAfter,e.endDatePlanAfter*1e3),fileIds:e.fileIds,checklist:e.checklist,containsChecklist:e.containsChecklist,parentId:(a=(r=e.parent)==null?void 0:r.id)!=null?a:S(e.base,i.idUtils.boxTemplate((n=e.base)==null?void 0:n.id)),containsSubTasks:(o=e.containsSubTasks)!=null?o:e.containsSubTemplates,containsRelatedTasks:e.containsRelatedTasks,containsGanttLinks:e.containsGanttLinks,containsPlacements:e.containsPlacements,containsCommentFiles:e.containsCommentFiles,requireResult:e.requireResult,containsResults:e.containsResults,numberOfReminders:e.numberOfReminders,groupId:(d=e.group)==null?void 0:d.id,stageId:(c=e.stage)==null?void 0:c.id,flowId:(u=e.flow)==null?void 0:u.id,status:e.status,statusChangedTs:S(e.statusChangedTs,e.statusChangedTs*1e3),accomplicesIds:S(e.accomplices,(p=e.accomplices)==null?void 0:p.map((({id:e})=>e))),auditorsIds:S(e.auditors,(m=e.auditors)==null?void 0:m.map((({id:e})=>e))),chatId:e.chatId,crmItemIds:e.crmItemIds,allowsChangeDeadline:e.allowsChangeDeadline,allowsChangeDatePlan:e.allowsChangeDatePlan,allowsTimeTracking:e.allowsTimeTracking,timers:e.timers,timeSpent:e.timeSpent,estimatedTime:e.estimatedTime,numberOfElapsedTimes:e.numberOfElapsedTimes,matchesWorkTime:e.matchesWorkTime,matchesSubTasksTime:e.matchesSubTasksTime,autocompleteSubTasks:e.autocompleteSubTasks,templateId:e.templateId,rights:e.rights,tags:S(e.tags,(h=e.tags)==null?void 0:h.map((({name:e})=>e))),isFavorite:S(e.inFavorite,(k=e.inFavorite)==null?void 0:k.includes(T.Core.getParams().currentUser.id)),isMuted:S(e.inMute,(b=e.inMute)==null?void 0:b.includes(T.Core.getParams().currentUser.id)),archiveLink:e.archiveLink,maxDeadlineChangeDate:e.maxDeadlineChangeDate,maxDeadlineChanges:e.maxDeadlineChanges,requireDeadlineChangeReason:e.requireDeadlineChangeReason,deadlineChangeReason:e.deadlineChangeReason,email:S(e.email,e.email?{...e.email,dateTs:e.email.dateTs*1e3}:null),userFields:S(e.userFields,D(e.id,(y=e.userFields)!=null?y:[])),isForNewUser:S(e.type,e.type===v.TemplateType.NewUsers),permissions:S(e.permissions,(g=e.permissions)==null?void 0:g.map((e=>l.TemplateMappers.mapPermissionDtoToModel(e)))),replicate:e.replicate,mark:e.mark,replicateParams:F(e)};return Object.fromEntries(Object.entries(I).filter((([e,t])=>{if(f.has(e)){return!s.Type.isUndefined(t)}return!s.Type.isNil(t)})))}function g(e,t){var a;const i=d.CheckListMappers.getUserIdsFromChecklists(t,"accomplices");const r=d.CheckListMappers.getUserIdsFromChecklists(t,"auditors");const l={TITLE:e.title,DESCRIPTION:S(e.description,I(e.description)),RESPONSIBLE_ID:e.responsibleIds[0],GROUP_ID:e.groupId,DEADLINE_TS:S(e.deadlineTs,Math.floor(e.deadlineTs/1e3)),IS_IMPORTANT:S(e.isImportant,e.isImportant?"Y":null),FILE_IDS:S(e.fileIds,((a=e.fileIds)==null?void 0:a.length)>0?e.fileIds:null),CHECKLIST:d.CheckListMappers.mapModelToSliderData(t),ACCOMPLICES:S(i,i.length>0?i:null),AUDITORS:S(r,r.length>0?r:null)};return Object.fromEntries(Object.entries(l).filter((([,e])=>!s.Type.isNil(e))))}function f(e){const t={title:e.TITLE?decodeURIComponent(e.TITLE):null,description:s.Text.decode(e.DESCRIPTION),fileIds:e.UF_TASK_WEBDAV_FILES,parentId:Number(e.PARENT_ID)||S(e.BASE_TEMPLATE,i.idUtils.boxTemplate(e.BASE_TEMPLATE)),crmItemIds:e.UF_CRM_TASK?e.UF_CRM_TASK.split(";").filter((e=>e.trim())):undefined,email:e.UF_MAIL_MESSAGE?C(e):undefined,tags:e.TAGS?e.TAGS.split(",").map((e=>e.trim())):undefined,groupId:Number(e.GROUP_ID)||undefined,flowId:Number(e.FLOW_ID)||undefined,templateId:Number(e.TEMPLATE)||undefined,copiedFromId:Number(e.COPY)||undefined,source:S(e.IM_MESSAGE_ID,{type:"chat",entityId:Number(e.IM_CHAT_ID),subEntityId:Number(e.IM_MESSAGE_ID)})};return Object.fromEntries(Object.entries(t).filter((([,e])=>!s.Type.isNil(e))))}function S(e,t){return s.Type.isNil(e)?e:t}function I(e){return e==null?void 0:e.replaceAll(/\[p]\n|\[p]\[\/p]|\[\/p]/gi,"").trim()}function P(e,t){if(!t){return null}return Object.fromEntries(t.map((t=>[t,T.Core.getStore().getters[`${v.Model.GanttLinks}/getLink`]({taskId:e,dependentId:t}).type])))}function C(e){const t=Number(e.UF_MAIL_MESSAGE);const s=decodeURIComponent(e.MAIL_SUBJECT);const a=decodeURIComponent(e.MAIL_FROM);const i=e.MAIL_DATE?parseInt(e.MAIL_DATE,10)*1e3:null;return{id:t,title:s,from:a,dateTs:i,link:`/mail/message/${t}`}}function D(e,t){if(s.Type.isArrayFilled(t)){return t}const a=T.Core.getStore().getters[`${v.Model.Tasks}/getById`](e);return a&&s.Type.isArray(a.userFields)?a.userFields:[]}function M(e){var t;const a=new Set;if(s.Type.isArray(e.responsibleCollection)){e.responsibleCollection.forEach((({id:e})=>a.add(e)))}if(s.Type.isArray(e.multiResponsibles)){e.multiResponsibles.forEach((({id:e})=>a.add(e)))}if(s.Type.isNumber((t=e.responsible)==null?void 0:t.id)){a.add(e.responsible.id)}if(a.size>0){return[...a]}return undefined}function F({replicateParams:e}){if(!s.Type.isObject(e)){return null}const a=t.DateStringConverter.parseServerDate(e.startDate);const i=t.TimeStringConverter.parseServerTime(e.time);const r=t.DateStringConverter.convertServerDateToTs(a,i);let l=null;if(!s.Type.isNil(e.endDate)){const s=t.DateStringConverter.parseServerDate(e.endDate);l=t.DateStringConverter.convertServerDateToTs(s)}return{...e,startTs:r,endTs:l,yearlyMonth1:S(e.yearlyMonth1,e.yearlyMonth1+1),yearlyMonth2:S(e.yearlyMonth2,e.yearlyMonth2+1),yearlyWeekDay:S(e.yearlyWeekDay,e.yearlyWeekDay+1)}}function w({replicateParams:e}){if(!s.Type.isObject(e)){return undefined}const a=t.DateStringConverter.convertTsToServerDateString(e.startTs);const i=t.TimeStringConverter.convertTsToServerTimeString(e.startTs);const r=s.Type.isNil(e.endTs)?null:t.DateStringConverter.convertTsToServerDateString(e.endTs);return{...e,startDate:a,time:i,endDate:r,yearlyMonth1:S(e.yearlyMonth1,e.yearlyMonth1-1),yearlyMonth2:S(e.yearlyMonth2,e.yearlyMonth2-1),yearlyWeekDay:S(e.yearlyWeekDay,e.yearlyWeekDay-1)}}var E,L;const R=new(E=babelHelpers.classPrivateFieldLooseKey("add"),L=babelHelpers.classPrivateFieldLooseKey("delete"),class{constructor(){Object.defineProperty(this,L,{value:A});Object.defineProperty(this,E,{value:B})}async update(e,t){const s=e.auditorsIds.filter((e=>!t.auditorsIds.includes(e)));const a=t.auditorsIds.filter((t=>!e.auditorsIds.includes(t)));const i=await babelHelpers.classPrivateFieldLooseBase(this,E)[E](s,t);const r=await babelHelpers.classPrivateFieldLooseBase(this,L)[L](a,t);return{...i,...r}}});function B(e,t){if(e.length===0){return{}}const s=e.length===1&&e[0]===T.Core.getParams().currentUser.id;const a=s?"Task.Audit.watch":"Task.Stakeholder.Auditor.add";return J.requestUpdate(a,{auditorsIds:e},t)}function A(e,t){if(e.length===0){return{}}const s=e.length===1&&e[0]===T.Core.getParams().currentUser.id;const a=s?"Task.Audit.unwatch":"Task.Stakeholder.Auditor.delete";return J.requestUpdate(a,{auditorsIds:e},t)}const U=new class{update(e,t){const s=T.Core.getParams().currentUser.id;const a=T.Core.getParams().rights.user.admin;const i={creatorId:e.creatorId,responsibleIds:a?t.responsibleIds:[s]};return J.requestUpdate("Task.Stakeholder.Creator.update",i,t)}};const O=new class{async update(e,t){const s=e.forceUpdateDescription?v.Endpoint.TaskDescriptionForceUpdate:v.Endpoint.TaskDescriptionUpdate;const a={description:e.description,descriptionChecksum:e.descriptionChecksum};return J.requestUpdate(s,a,t)}};var H=babelHelpers.classPrivateFieldLooseKey("data");class N{constructor(e){Object.defineProperty(this,H,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,H)[H]=e}getTask(){return y(babelHelpers.classPrivateFieldLooseBase(this,H)[H])}getFlow(){return babelHelpers.classPrivateFieldLooseBase(this,H)[H].flow?h.FlowMappers.mapDtoToModel(babelHelpers.classPrivateFieldLooseBase(this,H)[H].flow):null}getGroup(){var e;return(e=babelHelpers.classPrivateFieldLooseBase(this,H)[H].group)!=null&&e.id?m.GroupMappers.mapDtoToModel(babelHelpers.classPrivateFieldLooseBase(this,H)[H].group):null}getStages(){return babelHelpers.classPrivateFieldLooseBase(this,H)[H].stage?[m.GroupMappers.mapStageDtoToModel(babelHelpers.classPrivateFieldLooseBase(this,H)[H].stage)]:[]}getUsers(){var e,t,s,a,i,r,l,n,o;return[(e=babelHelpers.classPrivateFieldLooseBase(this,H)[H].creator)!=null?e:[],(t=babelHelpers.classPrivateFieldLooseBase(this,H)[H].responsible)!=null?t:[],...(s=(a=babelHelpers.classPrivateFieldLooseBase(this,H)[H])==null?void 0:a.responsibleCollection)!=null?s:[],...(i=babelHelpers.classPrivateFieldLooseBase(this,H)[H].multiResponsibles)!=null?i:[],...(r=(l=babelHelpers.classPrivateFieldLooseBase(this,H)[H])==null?void 0:l.accomplices)!=null?r:[],...(n=(o=babelHelpers.classPrivateFieldLooseBase(this,H)[H])==null?void 0:o.auditors)!=null?n:[]].map((e=>k.UserMappers.mapDtoToModel(e)))}}var $,j,_,X,x,W,G,V,q,K;const Y=[{fields:new Set(["storyPoints","epicId"]),endpoint:v.Endpoint.ScrumUpdateTask},{fields:new Set(["requireResult"]),endpoint:"Task.Result.require"},{fields:new Set(["deadlineTs","deadlineChangeReason"]),endpoint:v.Endpoint.TaskDeadlineUpdate},{fields:new Set(["startPlanTs","endPlanTs","matchesWorkTime","matchesSubTasksTime"]),endpoint:v.Endpoint.TaskPlanUpdate},{fields:new Set(["responsibleIds"]),endpoint:v.Endpoint.TaskStakeholderResponsibleDelegate},{fields:new Set(["crmItemIds"]),endpoint:v.Endpoint.TaskCrmItemSet},{fields:new Set(["accomplicesIds"]),endpoint:"Task.Stakeholder.Accomplice.set"},{fields:new Set(["creatorId"]),service:U},{fields:new Set(["auditorsIds"]),service:R},{fields:new Set(["description","forceUpdateDescription"]),service:O}];const J=new($=babelHelpers.classPrivateFieldLooseKey("updateFields"),j=babelHelpers.classPrivateFieldLooseKey("updateTaskBefore"),_=babelHelpers.classPrivateFieldLooseKey("updatePromises"),X=babelHelpers.classPrivateFieldLooseKey("updateServerTaskDebounced"),x=babelHelpers.classPrivateFieldLooseKey("updateTaskDebounced"),W=babelHelpers.classPrivateFieldLooseKey("updateTask"),G=babelHelpers.classPrivateFieldLooseKey("updateTaskFields"),V=babelHelpers.classPrivateFieldLooseKey("updateSeparateFields"),q=babelHelpers.classPrivateFieldLooseKey("getTaskFields"),K=babelHelpers.classPrivateFieldLooseKey("getFilteredFields"),class{constructor(){Object.defineProperty(this,K,{value:se});Object.defineProperty(this,q,{value:te});Object.defineProperty(this,V,{value:ee});Object.defineProperty(this,G,{value:Z});Object.defineProperty(this,W,{value:Q});Object.defineProperty(this,x,{value:z});Object.defineProperty(this,$,{writable:true,value:{}});Object.defineProperty(this,j,{writable:true,value:{}});Object.defineProperty(this,_,{writable:true,value:{}});Object.defineProperty(this,X,{writable:true,value:{}});s.Event.bind(window,"beforeunload",(()=>{setTimeout((()=>{const e=Object.keys(babelHelpers.classPrivateFieldLooseBase(this,_)[_]);e.forEach((e=>babelHelpers.classPrivateFieldLooseBase(this,W)[W](e)))}))}))}async get(e,t,s=false){if(i.idUtils.isTemplate(e)){await l.templateService.get(e);await this.$store.dispatch(`${v.Model.Tasks}/removePartiallyLoaded`,e);return this.getStoreTask(e)}try{const a=await r.apiClient.post(v.Endpoint.TaskGet,{task:{id:e},taskSelect:t});this.extractTask(a,s);await this.$store.dispatch(`${v.Model.Tasks}/removePartiallyLoaded`,e)}catch(e){console.error(v.Endpoint.TaskGet,e)}return this.getStoreTask(e)}async getCopy(e,t){var a;if(i.idUtils.isTemplate(t)){await l.templateService.getCopy(i.idUtils.boxTemplate(e),t);return}const r=await this.get(e);if(((a=r.checklist)==null?void 0:a.length)>0){await d.checkListService.load(e,t)}const n={title:r.title,description:r.description,creatorId:T.Core.getParams().currentUser.id,responsibleIds:r.responsibleIds,deadlineTs:r.deadlineTs,needsControl:r.needsControl,startPlanTs:r.startPlanTs,endPlanTs:r.endPlanTs,fileIds:r.fileIds,containsSubTasks:r.containsSubTasks,groupId:r.groupId,flowId:r.flowId,isImportant:r.isImportant,accomplicesIds:r.accomplicesIds,auditorsIds:r.auditorsIds,parentId:r.parentId,allowsChangeDeadline:r.allowsChangeDeadline,matchesWorkTime:r.matchesWorkTime,tags:r.tags,crmItemIds:r.crmItemIds,requireResult:r.requireResult,containsRelatedTasks:r.containsRelatedTasks,relatedTaskIds:r.relatedTaskIds,reminders:r.reminders,numberOfReminders:r.numberOfReminders,allowsTimeTracking:r.allowsTimeTracking,estimatedTime:r.estimatedTime,userFields:r.userFields};if(s.Type.isArrayFilled(n.userFields)){n.userFields=p.userFieldsManager.prepareUserFieldsForTaskFromTemplate(n.userFields,T.Core.getParams().taskUserFieldScheme)}this.updateStoreTask(t,n)}async getRights(e){try{var t;const{rights:s}=await r.apiClient.post(v.Endpoint.TaskAccessGet,{task:{id:e}});this.updateStoreTask(e,{rights:{...(t=this.getStoreTask(e))==null?void 0:t.rights,...s}})}catch(e){console.error(v.Endpoint.TaskAccessGet,e)}}async add(e){if(i.idUtils.isTemplate(e.id)){return l.templateService.add(e)}try{const t=await r.apiClient.post(v.Endpoint.TaskAdd,{task:b(e)});await this.onAfterTaskAdded(e,t);return[t.id,null]}catch(e){var t,s;console.error(v.Endpoint.TaskAdd,e);return[0,new Error((t=e.errors)==null?void 0:(s=t[0])==null?void 0:s.message)]}}async onAfterTaskAdded(e,t){var s,i;this.insertStoreTask({...e,id:t.id});this.extractTask(t);if(((s=e.checklist)==null?void 0:s.length)>0){await d.checkListService.save(t.id,this.$store.getters[`${v.Model.CheckList}/getByIds`](e.checklist),true)}const r=this.$store.getters[`${v.Model.Reminders}/getIds`](e.id,T.Core.getParams().currentUser.id);if(r.length>0){await c.remindersService.set(t.id,r.map((e=>this.$store.getters[`${v.Model.Reminders}/getById`](e))))}if(e.responsibleIds.length>1){const s=await this.addMultiTask(t.id,e.responsibleIds);o.subTasksService.addStore(e.id,s.map((e=>`userTask${e}`)))}if(((i=e.results)==null?void 0:i.length)>0){await u.resultService.save(t.id,this.$store.getters[`${v.Model.Results}/getByIds`](e.results),true)}if(e.relatedToTaskId){void o.relatedTasksService.add(e.relatedToTaskId,[t.id])}a.EventEmitter.emit(v.EventName.TaskAdded,{task:this.getStoreTask(t.id),initialTask:e});e=this.getStoreTask(e.id);const l=e.subTaskIds;const n=e.relatedTaskIds;const p=e.ganttTaskIds;l.forEach((e=>{if(/^tmp\..+/.test(e)){this.deleteStore(e)}}));if(e.containsSubTasks){o.subTasksService.addStore(t.id,l);void o.subTasksService.list(t.id,true)}if(e.containsRelatedTasks){o.relatedTasksService.addStore(t.id,n);void o.relatedTasksService.list(t.id,true)}if(e.containsGanttLinks){o.ganttService.addStore(t.id,p);void o.ganttService.list(t.id,true)}if(e.parentId){o.subTasksService.addStore(e.parentId,[t.id])}this.deleteStore(e.id)}async copy(e,t){if(i.idUtils.isTemplate(e.id)){return l.templateService.copy(e)}try{const s=this.$store.getters[`${v.Model.CheckList}/getByIds`](e.checklist);const i=await r.apiClient.post(v.Endpoint.TaskCopy,{task:b({...e,id:e.copiedFromId,checklist:s}),withSubTasks:t});if(e.responsibleIds.length>1){const t=await this.addMultiTask(i.id,e.responsibleIds);o.subTasksService.addStore(e.id,t.map((e=>`userTask${e}`)))}this.updateStoreTask(e.id,{id:i.id});this.extractTask(i);a.EventEmitter.emit(v.EventName.TaskAdded,{task:this.getStoreTask(i.id),initialTask:e});if(e.checklist.length>0){void d.checkListService.load(i.id)}return[i.id,null]}catch(e){var s,n;console.error(v.Endpoint.TaskCopy,e);return[0,new Error((s=e.errors)==null?void 0:(n=s[0])==null?void 0:n.message)]}}async addMultiTask(e,t){try{const s=t.filter((e=>e!==T.Core.getParams().currentUser.id));await r.apiClient.post(v.Endpoint.TaskMultiTaskAdd,{taskId:e,userIds:s});return s}catch(e){console.error(v.Endpoint.TaskMultiTaskAdd,e);return[]}}async update(e,t){if(i.idUtils.isTemplate(e)){return l.templateService.update(e,t)}const s=this.getStoreTask(e);this.updateStoreTask(e,t);if(!i.idUtils.isReal(e)){return{}}if(this.hasChanges(s,t)){a.EventEmitter.emit(v.EventName.TaskBeforeUpdate,{task:this.getStoreTask(e),fields:{id:e,...t}})}const r=await babelHelpers.classPrivateFieldLooseBase(this,x)[x](e,t,s);a.EventEmitter.emit(v.EventName.TaskAfterUpdate,{task:this.getStoreTask(e)});return r}async setFavorite(e,t){this.updateStoreTask(e,{isFavorite:t});const s=t?v.Endpoint.TaskFavoriteAdd:v.Endpoint.TaskFavoriteDelete;try{await r.apiClient.post(s,{taskId:e});return true}catch(a){this.updateStoreTask(e,{isFavorite:!t});console.error(s,a);return false}}async setStage(e,t){this.updateStoreTask(e,{stageId:t});try{await r.apiClient.postComponent("bitrix:tasks.task","moveStage",{taskId:e,stageId:t});return true}catch(e){console.error("bitrix:tasks.task.moveStage",e);return false}}async setMark(e,t){this.updateStoreTask(e,{mark:t});try{await r.apiClient.post(v.Endpoint.TaskMarkSet,{task:{id:e,mark:t}});return true}catch(e){console.error(v.Endpoint.TaskMarkSet,e);return false}}async setMute(e,t){this.updateStoreTask(e,{isMuted:t});const s=t?v.Endpoint.TaskAttentionMute:v.Endpoint.TaskAttentionUnmute;try{await r.apiClient.post(s,{taskId:e});return true}catch(a){this.updateStoreTask(e,{isMuted:!t});console.error(s,a);return false}}async delete(e){const t=this.getStoreTask(e);this.deleteStore(e);if(!i.idUtils.isReal(e)){return}try{await r.apiClient.post(v.Endpoint.TaskDelete,{task:{id:e}});a.EventEmitter.emit(v.EventName.TaskDeleted,{id:e})}catch(e){void this.insertStoreTask(t);console.error(v.Endpoint.TaskDelete,e)}}extractTask(e,t=true){var s,a;if(!e){return}if((e==null?void 0:(s=e.rights)==null?void 0:s.read)===false){this.deleteStore(e.id);return}const i=new N(e);const r=i.getTask();r.rights={...(a=this.getStoreTask(r.id))==null?void 0:a.rights,...r.rights};if(t){["containsSubTasks","containsRelatedTasks","containsGanttLinks","containsPlacements"].forEach((e=>delete r[e]))}void Promise.all([this.$store.dispatch(`${v.Model.Tasks}/upsert`,r),this.$store.dispatch(`${v.Model.Flows}/upsert`,i.getFlow()),this.$store.dispatch(`${v.Model.Groups}/insert`,i.getGroup()),this.$store.dispatch(`${v.Model.Stages}/upsertMany`,i.getStages()),this.$store.dispatch(`${v.Model.Users}/upsertMany`,i.getUsers())]);void n.fileService.get(e.id).sync(e.fileIds)}deleteStore(e){o.subTasksService.unlinkStore(e);o.relatedTasksService.unlinkStore(e);o.ganttService.unlinkStore(e);void this.$store.dispatch(`${v.Model.Tasks}/delete`,e)}async requestUpdate(e,t,s){const a=s.id;const i=b({id:a,...t});if(JSON.stringify(i)===JSON.stringify({id:a})){return{}}try{const t=await r.apiClient.post(e,{task:i});this.extractTask(t);return{}}catch(t){this.updateStoreTask(a,s);console.error(e,t);return{[e]:t.errors}}}hasChanges(e,t){return Object.entries(t).some((([t,s])=>JSON.stringify(e[t])!==JSON.stringify(s)))}async insertStoreTask(e){if(i.idUtils.isTemplate(e.id)){await l.templateService.insertStoreTask(e);return}await this.$store.dispatch(`${v.Model.Tasks}/insert`,e)}updateStoreTask(e,t){if(this.hasStoreTask(e)){void this.$store.dispatch(`${v.Model.Tasks}/update`,{id:e,fields:t})}}hasStoreTask(e,t=true){const s=this.$store.getters[`${v.Model.Tasks}/isPartiallyLoaded`](e);return this.getStoreTask(e)!==null&&(t||!s)}getStoreTask(e){const t=this.$store.getters[`${v.Model.Tasks}/getById`](e);return t?{...t}:null}get $store(){return T.Core.getStore()}});function z(e,t,a){var i,r,l,n,o,d;babelHelpers.classPrivateFieldLooseBase(this,$)[$][e]={...babelHelpers.classPrivateFieldLooseBase(this,$)[$][e],...t};(r=(i=babelHelpers.classPrivateFieldLooseBase(this,j)[j])[e])!=null?r:i[e]=a;(n=(l=babelHelpers.classPrivateFieldLooseBase(this,_)[_])[e])!=null?n:l[e]=new ae;(d=(o=babelHelpers.classPrivateFieldLooseBase(this,X)[X])[e])!=null?d:o[e]=s.Runtime.debounce(babelHelpers.classPrivateFieldLooseBase(this,W)[W],500,this);babelHelpers.classPrivateFieldLooseBase(this,X)[X][e](e);return babelHelpers.classPrivateFieldLooseBase(this,_)[_][e]}async function Q(e){const t=babelHelpers.classPrivateFieldLooseBase(this,$)[$][e];delete babelHelpers.classPrivateFieldLooseBase(this,$)[$][e];const s=babelHelpers.classPrivateFieldLooseBase(this,j)[j][e];delete babelHelpers.classPrivateFieldLooseBase(this,j)[j][e];const a=babelHelpers.classPrivateFieldLooseBase(this,_)[_][e];delete babelHelpers.classPrivateFieldLooseBase(this,_)[_][e];const i={id:e,...t};const r=await babelHelpers.classPrivateFieldLooseBase(this,G)[G](i,s);const l=await Promise.all(Y.map((e=>babelHelpers.classPrivateFieldLooseBase(this,V)[V](i,s,e))));a.resolve({...r,...Object.assign({},...l)})}function Z(e,t){const s=babelHelpers.classPrivateFieldLooseBase(this,q)[q](e);if(!this.hasChanges(t,s)){return{}}return this.requestUpdate(v.Endpoint.TaskUpdate,s,t)}function ee(e,t,s){const a=babelHelpers.classPrivateFieldLooseBase(this,K)[K](e,s.fields);if(!this.hasChanges(t,a)){return{}}if(s.service){return s.service.update(e,t)}return this.requestUpdate(s.endpoint,a,t)}function te(e){return Object.fromEntries(Object.entries(e).filter((([e])=>Object.values(Y).every((({fields:t})=>!t.has(e))))))}function se(e,t){return Object.fromEntries(Object.entries(e).filter((([e])=>t.has(e))))}function ae(){const e=new Promise((e=>{this.resolve=e}));e.resolve=this.resolve;return e}class ie{static createEmptyReplicateParams(){return{period:v.ReplicationPeriod.Daily,time:null,startDate:null,repeatTill:v.ReplicationRepeatTill.Endless,endDate:null,times:null,nextExecutionTime:null,deadlineOffset:null,...ie.createReplicateParamsDaily(),...ie.createReplicateParamsWeekly(),...ie.createReplicateParamsMonthly(),...ie.createReplicateParamsYearly()}}static createReplicateParamsDaily(e={}){return{dailyMonthInterval:null,...e}}static createDefaultReplicationParamsDaily(){return ie.createReplicateParamsDaily({})}static createReplicateParamsWeekly(e={}){return{everyWeek:null,weekDays:[],...e}}static createDefaultReplicationParamsWeekly(){return ie.createReplicateParamsWeekly({})}static createReplicateParamsMonthly(e={}){return{monthlyData:null,monthlyDataNum:null,monthlyMonthNum1:null,monthlyMonthNum2:null,monthlyWeekDay:null,monthlyWeekDayNum:null,...e}}static createDefaultReplicationParamsMonthly(){return ie.createReplicateParamsMonthly({monthlyType:v.ReplicationMonthlyType.Absolute,monthlyDayNum:1})}static createReplicateParamsYearly(e={}){return{yearlyData:null,yearlyDayNum:null,yearlyMonth1:null,yearlyMonth2:null,yearlyWeekDay:null,yearlyWeekDayNum:null,...e}}static createDefaultReplicationParamsYearly(){return ie.createReplicateParamsYearly({yearlyType:v.ReplicationYearlyType.Absolute,yearlyDayNum:1,yearlyMonth1:1})}}const re={mapModelToDto:b,mapDtoToModel:y,mapModelToSliderData:g,mapSliderDataToModel:f};e.TaskMappers=re;e.taskService=J;e.ReplicateCreator=ie})(this.BX.Tasks.V2.Provider.Service=this.BX.Tasks.V2.Provider.Service||{},BX.Tasks.V2.Component.Fields,BX,BX.Event,BX.Tasks.V2.Lib,BX.Tasks.V2.Lib,BX.Tasks.V2.Provider.Service,BX.Tasks.V2.Provider.Service,BX.Tasks.V2.Provider.Service,BX.Tasks.V2.Provider.Service,BX.Tasks.V2.Provider.Service,BX.Tasks.V2.Provider.Service,BX.Tasks.V2.Component.Fields,BX.Tasks.V2,BX.Tasks.V2.Provider.Service,BX.Tasks.V2.Provider.Service,BX.Tasks.V2.Provider.Service,BX.Tasks.V2.Const);
//# sourceMappingURL=task-service.bundle.map.js