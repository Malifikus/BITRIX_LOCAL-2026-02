this.BX=this.BX||{};this.BX.Tasks=this.BX.Tasks||{};this.BX.Tasks.V2=this.BX.Tasks.V2||{};this.BX.Tasks.V2.Component=this.BX.Tasks.V2.Component||{};(function(t,e,s,a,n,i,l,r,o,d,h,c,T,u,m,p,k,S,P,f,D,_,A,E,g,v){"use strict";const B=Object.freeze({id:c.TaskField.DatePlan,title:n.Loc.getMessage("TASKS_V2_DATE_PLAN_TITLE")});const C={components:{HoverPill:s.HoverPill},props:{dateTs:{type:Number,required:true},readonly:{type:Boolean,default:false}},setup(){return{calendar:m.calendar}},template:`\n\t\t<div>\n\t\t\t<HoverPill textOnly :readonly>\n\t\t\t\t<div>{{ calendar.formatDateTime(dateTs, { forceYear: true }) }}</div>\n\t\t\t</HoverPill>\n\t\t</div>\n\t`};const I={components:{HoverPill:s.HoverPill},props:{dateTs:{type:Number,required:true},matchWorkTime:{type:Boolean,default:false},readonly:{type:Boolean,default:false}},setup(){return{calendar:m.calendar}},template:`\n\t\t<div>\n\t\t\t<HoverPill textOnly :readonly>\n\t\t\t\t<div>{{ calendar.formatDuration(dateTs, matchWorkTime) }}</div>\n\t\t\t</HoverPill>\n\t\t</div>\n\t`};const L={components:{HoverPill:s.HoverPill,FieldAdd:a.FieldAdd,QuestionMark:_.QuestionMark},inject:{task:{}},setup(){return{Outline:E.Outline}},template:`\n\t\t<HoverPill v-if="task.matchesSubTasksTime" textOnly readonly>\n\t\t\t<div class="tasks-field-date-plan-content">\n\t\t\t\t<div>{{ loc('TASKS_V2_DATE_PLAN_MATCH_SUBTASKS_TIME_STATE') }}</div>\n\t\t\t\t<QuestionMark :hintText="loc('TASKS_V2_DATE_PLAN_NO_SUBTASKS_HINT')"/>\n\t\t\t</div>\n\t\t</HoverPill>\n\t\t<FieldAdd v-else :icon="Outline.PLANNING"/>\n\t`};const w={components:{TextSm:P.TextSm,Switcher:D.Switcher,QuestionMark:_.QuestionMark,BIcon:E.BIcon},props:{modelValue:{type:Boolean,required:true},text:{type:String,required:true},hint:{type:String,default:""},lock:{type:Boolean,default:false}},setup(){return{Outline:E.Outline}},computed:{options(){return{size:f.SwitcherSize.extraSmall,useAirDesign:true}}},template:`\n\t\t<div class="tasks-field-date-plan-switcher" @click="$emit('update:modelValue', !modelValue)">\n\t\t\t<Switcher :isChecked="modelValue" :options/>\n\t\t\t<TextSm>{{ text }}</TextSm>\n\t\t\t<QuestionMark v-if="hint" :hintText="hint" @click.stop/>\n\t\t\t<BIcon v-if="lock" :name="Outline.LOCK_M" class="tasks-field-date-plan-switcher-lock"/>\n\t\t</div>\n\t`};const N=2**31;const V={components:{BottomSheet:T.BottomSheet,BIcon:E.BIcon,UiButton:r.Button,HeadlineMd:P.HeadlineMd,TextSm:P.TextSm,BInput:o.BInput,BMenu:d.BMenu,DatePlanSwitcher:w,Duration:u.Duration},inject:{task:{},taskId:{},isTemplate:{}},props:{sheetBindProps:{type:Object,required:true}},emits:["close"],setup(){return{Outline:E.Outline,InputDesign:o.InputDesign,ButtonSize:r.ButtonSize,ButtonColor:r.ButtonColor,wasEmpty:false}},data(){return{isEndPicker:false,isEndDuration:false,isPickerShown:false,durationTs:0,startTs:null,endTs:null,startDatePlanAfter:null,templateDuration:null,matchesWorkTimeTemp:null,matchesSubTasksTimeTemp:null}},computed:{wasFilled(){return this.task.filledFields[B.id]},duration:{get(){return this.durationTs},set(t){if(t===this.durationTs){return}this.durationTs=t;this.updateRangeFromDuration()}},matchesWorkTime:{get(){var t,e;return this.isMatchesWorkTimeLocked?false:(t=(e=this.matchesWorkTimeTemp)!=null?e:this.task.matchesWorkTime)!=null?t:false},set(t){if(this.isMatchesWorkTimeLocked){void S.showLimit({featureId:h.Core.getParams().restrictions.skipWeekends.featureId});return}if(t===this.matchesWorkTimeTemp){return}this.matchesWorkTimeTemp=t;this.update()}},matchesSubTasksTime:{get(){var t,e;return this.isMatchesSubTasksTimeLocked?false:(t=(e=this.matchesSubTasksTimeTemp)!=null?e:this.task.matchesSubTasksTime)!=null?t:false},set(t){if(this.isMatchesSubTasksTimeLocked){void S.showLimit({featureId:h.Core.getParams().restrictions.relatedSubtaskDeadlines.featureId});return}this.matchesSubTasksTimeTemp=t}},allowsChangeDatePlan:{get(){var t;if(this.isTemplate){var e;return(e=this.task.allowsChangeDeadline)!=null?e:false}return(t=this.task.allowsChangeDatePlan)!=null?t:false},set(t){if(this.isTemplate){void k.taskService.update(this.taskId,{allowsChangeDeadline:t});return}void k.taskService.update(this.taskId,{allowsChangeDatePlan:t})}},maxDurationReached(){return this.endTs&&this.startTs&&Math.floor((this.endTs-this.startTs)/1e3)>=N},inputDesign(){return this.matchesSubTasksTime?o.InputDesign.Disabled:o.InputDesign.Grey},isMatchesWorkTimeLocked(){return!h.Core.getParams().restrictions.skipWeekends.available},isMatchesSubTasksTimeLocked(){return!h.Core.getParams().restrictions.relatedSubtaskDeadlines.available},description(){if(this.isTemplate){return this.loc("TASKS_V2_DATE_PLAN_DESCRIPTION_TEMPLATE")}return this.loc("TASKS_V2_DATE_PLAN_DESCRIPTION")},allowChangeText(){if(this.isTemplate){return this.loc("TASKS_V2_DATE_PLAN_ALLOW_CHANGE_TEMPLATE")}return this.loc("TASKS_V2_DATE_PLAN_ALLOW_CHANGE")},matchWorkTimeHint(){if(this.isTemplate){return this.loc("TASKS_V2_DATE_PLAN_MATCH_WORK_TIME_HINT_TEMPLATE")}return this.loc("TASKS_V2_DATE_PLAN_MATCH_WORK_TIME_HINT")}},created(){this.wasEmpty=!this.wasFilled;this.updateDuration(this.task.startPlanTs,this.task.endPlanTs);this.startDatePlanAfter=this.task.startDatePlanAfter;this.templateDuration=this.task.endDatePlanAfter-this.task.startDatePlanAfter;this.showErrorDebounced=n.Runtime.debounce(this.showError,300,this)},methods:{clearStart(){this.duration=0;this.updatePlan(null,this.endTs)},clearEnd(){this.duration=0;this.updatePlan(this.startTs,null)},handleDateClick({currentTarget:t},{isEnd:e}){this.updateDuration(this.startTs,this.endTs);this.isEndPicker=e;const s=this.getDatePicker();s.setTargetNode(t);s.show();if(this.isEndPicker&&this.endTs){s.setFocusDate(this.endTs+p.timezone.getOffset(this.endTs))}},getDatePicker(){var t,e;(t=this.handlePickerChangedDebounced)!=null?t:this.handlePickerChangedDebounced=n.Runtime.debounce(this.handlePickerChanged,10,this);(e=this.datePicker)!=null?e:this.datePicker=new i.DatePicker({enableTime:true,selectionMode:"range",defaultTime:m.calendar.dayEndTime,events:{[i.DatePickerEvent.SELECT]:this.handlePickerChangedDebounced,[i.DatePickerEvent.DESELECT]:this.handlePickerChangedDebounced,onShow:()=>{this.isPickerShown=true},onHide:()=>{this.isPickerShown=false}},popupOptions:{animation:"fading",targetContainer:this.sheetBindProps.getTargetContainer()}});return this.datePicker},handlePickerChanged(){let t=this.preparePickerTimestamp(this.datePicker.getRangeStart());let e=this.preparePickerTimestamp(this.datePicker.getRangeEnd());if(this.isEndPicker&&!e&&!this.startTs){[t,e]=[null,t]}if(t&&!this.startTs){t=m.calendar.setHours(t,m.calendar.workdayStart.H,m.calendar.workdayStart.M)}this.updateDuration(t,e)},updateDuration(t,e){const[s,a]=this.prepareRange(t,e);if(!s||!a){this.duration=0;this.updatePlan(s,a);return}this.duration=this.matchesWorkTime?m.calendar.calculateDuration(s,a):a-s;this.updatePlan(s,a)},update(){const[t,e]=this.prepareRange(this.startTs,this.endTs);if(t&&e){this.updateRangeFromDuration()}else{this.updatePlan(t,e)}},updateRangeFromDuration(){let[t,e]=this.prepareRange(this.startTs,this.endTs);if(!t&&!e){return}if(this.isEndDuration){t=null}if(this.matchesWorkTime){t=m.calendar.calculateStartTs(t,e,this.duration);e=m.calendar.calculateEndTs(t,e,this.duration)}else{var s;(s=t)!=null?s:t=e-this.duration;e=t+this.duration}this.updatePlan(t,e)},updatePlan(t,e){this.startTs=t;this.endTs=e;if(this.maxDurationReached){return}const s=this.getDatePicker();const a={emitEvents:false};if(t||e){const n=t+p.timezone.getOffset(t);const i=e?e+p.timezone.getOffset(e):null;if(t){s.selectRange(n,i,a)}else{s.selectRange(i,null,a)}}else{s.deselectAll(a)}},prepareRange(t,e){if(this.matchesWorkTime){return[m.calendar.clampWorkDateTime(t),m.calendar.clampWorkDateTime(e)]}return[t,e]},preparePickerTimestamp(t){if(!t){return null}const e=m.calendar.createDateFromUtc(t).getTime();return e-p.timezone.getOffset(e)},formatDate(t){return m.calendar.formatDateTime(t,{forceYear:true})},close(){if(this.isTemplate){this.handleTemplateUpdate()}else if(!this.maxDurationReached){void this.handleTaskUpdate()}if(this.wasEmpty&&this.wasFilled){void v.fieldHighlighter.setContainer(this.$root.$el).highlight(B.id)}this.$emit("close")},handleTemplateUpdate(){void k.taskService.update(this.taskId,{startDatePlanAfter:Number(this.startDatePlanAfter),endDatePlanAfter:Number(this.startDatePlanAfter+this.templateDuration),matchesWorkTime:this.matchesWorkTime})},async handleTaskUpdate(){var t;const e=await k.taskService.update(this.taskId,Object.fromEntries(Object.entries({startPlanTs:this.matchesSubTasksTime?undefined:Number(this.startTs),endPlanTs:this.matchesSubTasksTime?undefined:Number(this.endTs),matchesWorkTime:this.matchesWorkTime,matchesSubTasksTime:this.matchesSubTasksTime}).filter((([,t])=>!n.Type.isUndefined(t)))));if((t=e[c.Endpoint.TaskPlanUpdate])!=null&&t.length){const t=e[c.Endpoint.TaskPlanUpdate][0];this.showErrorDebounced(t)}},showError(t){l.Notifier.notifyViaBrowserProvider({id:"tasks-date-plan-update-error",text:t==null?void 0:t.message})}},template:`\n\t\t<BottomSheet :sheetBindProps @close="close">\n\t\t\t<div class="tasks-field-date-plan-sheet">\n\t\t\t\t<div class="tasks-field-date-plan-header">\n\t\t\t\t\t<HeadlineMd>{{ loc('TASKS_V2_DATE_PLAN_TITLE_SHEET') }}</HeadlineMd>\n\t\t\t\t\t<BIcon class="tasks-field-date-plan-close" :name="Outline.CROSS_L" hoverable @click="close"/>\n\t\t\t\t</div>\n\t\t\t\t<TextSm class="tasks-field-date-plan-description">{{ description }}</TextSm>\n\t\t\t\t<div class="tasks-field-date-plan-fields">\n\t\t\t\t\t<template v-if="isTemplate">\n\t\t\t\t\t\t<Duration\n\t\t\t\t\t\t\tv-model="startDatePlanAfter"\n\t\t\t\t\t\t\t:matchesWorkTime\n\t\t\t\t\t\t\t:label="loc('TASKS_V2_DATE_PLAN_START_AFTER')"\n\t\t\t\t\t\t\t:design="inputDesign"\n\t\t\t\t\t\t/>\n\t\t\t\t\t\t<Duration\n\t\t\t\t\t\t\tv-model="templateDuration"\n\t\t\t\t\t\t\t:matchesWorkTime\n\t\t\t\t\t\t\t:label="loc('TASKS_V2_DATE_PLAN_DURATION')"\n\t\t\t\t\t\t\t:design="inputDesign"\n\t\t\t\t\t\t/>\n\t\t\t\t\t</template>\n\t\t\t\t\t<template v-else>\n\t\t\t\t\t\t<BInput\n\t\t\t\t\t\t\t:modelValue="formatDate(startTs)"\n\t\t\t\t\t\t\t:label="loc('TASKS_V2_DATE_PLAN_START')"\n\t\t\t\t\t\t\t:design="inputDesign"\n\t\t\t\t\t\t\t:icon="Outline.CALENDAR_WITH_SLOTS"\n\t\t\t\t\t\t\t:withClear="Boolean(startTs)"\n\t\t\t\t\t\t\tclickable\n\t\t\t\t\t\t\t:active="isPickerShown && !isEndPicker"\n\t\t\t\t\t\t\t:data-task-plan-start="startTs"\n\t\t\t\t\t\t\t@clear="clearStart"\n\t\t\t\t\t\t\t@click="handleDateClick($event, { isEnd: false })"\n\t\t\t\t\t\t/>\n\t\t\t\t\t\t<BInput\n\t\t\t\t\t\t\t:modelValue="formatDate(endTs)"\n\t\t\t\t\t\t\t:label="loc('TASKS_V2_DATE_PLAN_END')"\n\t\t\t\t\t\t\t:design="inputDesign"\n\t\t\t\t\t\t\t:icon="Outline.CALENDAR_WITH_SLOTS"\n\t\t\t\t\t\t\t:withClear="Boolean(endTs)"\n\t\t\t\t\t\t\tclickable\n\t\t\t\t\t\t\t:active="isPickerShown && isEndPicker"\n\t\t\t\t\t\t\t:data-task-plan-end="endTs"\n\t\t\t\t\t\t\t@clear="clearEnd"\n\t\t\t\t\t\t\t@click="handleDateClick($event, { isEnd: true })"\n\t\t\t\t\t\t/>\n\t\t\t\t\t\t<Duration\n\t\t\t\t\t\t\tv-model="duration"\n\t\t\t\t\t\t\t:matchesWorkTime\n\t\t\t\t\t\t\t:label="loc('TASKS_V2_DATE_PLAN_DURATION')"\n\t\t\t\t\t\t\t:design="inputDesign"\n\t\t\t\t\t\t\t:error="maxDurationReached ? ' ' : null"\n\t\t\t\t\t\t\t:maxValue="Infinity"\n\t\t\t\t\t\t\t@focus="isEndDuration = !startTs"\n\t\t\t\t\t\t\t@blur="isEndDuration = false"\n\t\t\t\t\t\t/>\n\t\t\t\t\t</template>\n\t\t\t\t</div>\n\t\t\t\t<div class="tasks-field-date-plan-switchers">\n\t\t\t\t\t<DatePlanSwitcher\n\t\t\t\t\t\tv-if="task.rights.edit"\n\t\t\t\t\t\tv-model="allowsChangeDatePlan"\n\t\t\t\t\t\t:text="allowChangeText"\n\t\t\t\t\t/>\n\t\t\t\t\t<DatePlanSwitcher\n\t\t\t\t\t\tv-model="matchesWorkTime"\n\t\t\t\t\t\t:text="loc('TASKS_V2_DATE_PLAN_MATCH_WORK_TIME')"\n\t\t\t\t\t\t:hint="matchWorkTimeHint"\n\t\t\t\t\t\t:lock="isMatchesWorkTimeLocked"\n\t\t\t\t\t/>\n\t\t\t\t\t<DatePlanSwitcher\n\t\t\t\t\t\tv-if="!isTemplate"\n\t\t\t\t\t\tv-model="matchesSubTasksTime"\n\t\t\t\t\t\t:text="loc('TASKS_V2_DATE_PLAN_MATCH_SUBTASKS_TIME')"\n\t\t\t\t\t\t:hint="loc('TASKS_V2_DATE_PLAN_MATCH_SUBTASKS_TIME_HINT')"\n\t\t\t\t\t\t:lock="isMatchesSubTasksTimeLocked"\n\t\t\t\t\t/>\n\t\t\t\t</div>\n\t\t\t\t<div class="tasks-field-date-plan-footer">\n\t\t\t\t\t<UiButton\n\t\t\t\t\t\t:text="loc('TASKS_V2_DATE_PLAN_BUTTON_SAVE')"\n\t\t\t\t\t\t:size="ButtonSize.MEDIUM"\n\t\t\t\t\t\t:color="ButtonColor.PRIMARY"\n\t\t\t\t\t\t@click="close"\n\t\t\t\t\t/>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</BottomSheet>\n\t`};const b={components:{FieldList:e.FieldList,DatePlanSheet:V},inject:{task:{},taskId:{},isTemplate:{}},props:{isSheetShown:{type:Boolean,required:true},sheetBindProps:{type:Object,required:true}},emits:["update:isSheetShown"],setup(){return{datePlanMeta:B}},computed:{fields(){if(this.isTemplate){const t=!this.task.startDatePlanAfter&&!this.task.endDatePlanAfter;if(t){return[{title:B.title,component:L}]}return[{title:this.loc("TASKS_V2_DATE_PLAN_START_AFTER"),component:I,props:{dateTs:this.task.startDatePlanAfter,matchWorkTime:this.task.matchesWorkTime,readonly:this.readonly}},{title:this.loc("TASKS_V2_DATE_PLAN_DURATION"),component:I,props:{dateTs:this.task.endDatePlanAfter-this.task.startDatePlanAfter,matchWorkTime:this.task.matchesWorkTime,readonly:this.readonly}}].filter((({props:{dateTs:t}})=>t))}const t=!this.task.startPlanTs&&!this.task.endPlanTs;if(t&&(this.task.filledFields[B.id]||this.task.matchesSubTasksTime)){return[{title:B.title,component:L}]}return[{title:this.loc("TASKS_V2_DATE_PLAN_FIELD_START"),component:C,props:{dateTs:this.task.startPlanTs,readonly:this.readonly}},{title:this.loc("TASKS_V2_DATE_PLAN_FIELD_END"),component:C,props:{dateTs:this.task.endPlanTs,readonly:this.readonly}}].filter((({props:{dateTs:t}})=>t))},readonly(){return!this.task.rights.datePlan}},methods:{handleClick(){if(!this.readonly){this.setSheetShown(true)}},setSheetShown(t){this.$emit("update:isSheetShown",t)}},template:`\n\t\t<div\n\t\t\tclass="tasks-field-date-plan"\n\t\t\t:class="{ '--readonly': readonly }"\n\t\t\t:data-task-id="taskId"\n\t\t\t:data-task-field-id="datePlanMeta.id"\n\t\t\t:data-task-plan-start="task.startPlanTs"\n\t\t\t:data-task-plan-end="task.endPlanTs"\n\t\t\t@click="handleClick"\n\t\t>\n\t\t\t<FieldList :fields/>\n\t\t</div>\n\t\t<DatePlanSheet v-if="isSheetShown" :sheetBindProps @close="setSheetShown(false)"/>\n\t`};const y={components:{Chip:A.Chip,DatePlanSheet:V},inject:{task:{},taskId:{}},props:{isSheetShown:{type:Boolean,required:true},sheetBindProps:{type:Object,required:true}},emits:["update:isSheetShown"],setup(){return{Outline:E.Outline,datePlanMeta:B}},computed:{design(){return this.isSelected?A.ChipDesign.ShadowAccent:A.ChipDesign.ShadowNoAccent},isSelected(){return this.task.filledFields[B.id]}},methods:{handleClick(){if(this.isSelected){this.highlightField();return}this.setSheetShown(true)},highlightField(){void v.fieldHighlighter.setContainer(this.$root.$el).highlight(B.id)},setSheetShown(t){this.$emit("update:isSheetShown",t)}},template:`\n\t\t<Chip\n\t\t\tv-if="task.rights.edit || isSelected"\n\t\t\t:design\n\t\t\t:icon="Outline.PLANNING"\n\t\t\t:text="loc('TASKS_V2_DATE_PLAN_TITLE_CHIP')"\n\t\t\t:data-task-id="taskId"\n\t\t\t:data-task-chip-id="datePlanMeta.id"\n\t\t\t:data-task-plan-start="task.startPlanTs"\n\t\t\t:data-task-plan-end="task.endPlanTs"\n\t\t\t@click="handleClick"\n\t\t/>\n\t\t<DatePlanSheet v-if="isSheetShown" :sheetBindProps @close="setSheetShown(false)"/>\n\t`};t.DatePlan=b;t.DatePlanChip=y;t.DatePlanSheet=V;t.datePlanMeta=B})(this.BX.Tasks.V2.Component.Fields=this.BX.Tasks.V2.Component.Fields||{},BX.Tasks.V2.Component.Elements,BX.Tasks.V2.Component.Elements,BX.Tasks.V2.Component.Elements,BX,BX.UI.DatePicker,BX.UI.NotificationManager,BX.Vue3.Components,BX.UI.System.Input.Vue,BX.UI.System.Menu,BX.Tasks.V2,BX.Tasks.V2.Const,BX.Tasks.V2.Component.Elements,BX.Tasks.V2.Component.Elements,BX.Tasks.V2.Lib,BX.Tasks.V2.Lib,BX.Tasks.V2.Provider.Service,BX.Tasks.V2.Lib,BX.UI.System.Typography.Vue,BX.UI,BX.UI.Vue3.Components,BX.Tasks.V2.Component.Elements,BX.UI.System.Chip.Vue,BX.UI.IconSet,BX,BX.Tasks.V2.Lib);
//# sourceMappingURL=date-plan.bundle.map.js