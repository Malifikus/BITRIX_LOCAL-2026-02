this.BX=this.BX||{};this.BX.Tasks=this.BX.Tasks||{};this.BX.Tasks.V2=this.BX.Tasks.V2||{};(function(t,e,s,r,i,n,a,o,l,d,m,p,g){"use strict";const c={1:"TASKS_V2_TEMPLATE_HISTORY_GRID_TYPE_NOTICE",2:"TASKS_V2_TEMPLATE_HISTORY_GRID_TYPE_WARNING",3:"TASKS_V2_TEMPLATE_HISTORY_GRID_TYPE_ERROR"};const h={props:{getGrid:{type:Function,required:true}},setup(){return{typeLocalizationMap:c}},data(){return{systemLogTypeRef:[],systemLogType:[]}},methods:{async update(){const t=this.getGrid().querySelectorAll("[data-system-log-type]");this.systemLogType=[...t].map((t=>this.getSystemLogType(t)));await this.$nextTick();t.forEach((t=>{const e=this.getSystemLogType(t);t.append(this.systemLogTypeRef[e.rowId])}))},getSystemLogType(t){const e=Number(t.closest("[data-id]").dataset.id);const s=t.dataset.systemLogType;return{rowId:e,type:s}},setRef(t,e){var s;(s=this.systemLogTypeRef)!=null?s:this.systemLogTypeRef={};this.systemLogTypeRef[e]=t}},template:`\n\t\t<template v-for="(type, id) in systemLogType" :key="id">\n\t\t\t<div :ref="(el) => setRef(el, type.rowId)">\n\t\t\t\t{{ loc(typeLocalizationMap[type.type] ?? Object.values(typeLocalizationMap)[0]) }}\n\t\t\t</div>\n\t\t</template>\n\t`};const u={props:{getGrid:{type:Function,required:true}},data(){return{systemLogTimeRef:[],systemLogTime:[]}},methods:{async update(){const t=this.getGrid().querySelectorAll("[data-system-log-time]");this.systemLogTime=[...t].map((t=>this.getSystemLogTime(t)));await this.$nextTick();t.forEach((t=>{const e=this.getSystemLogTime(t);t.append(this.systemLogTimeRef[e.rowId])}))},getSystemLogTime(t){const e=Number(t.closest("[data-id]").dataset.id);const s=this.getOffsetTimestamp(t.dataset.systemLogTime);return{rowId:e,offsetTimestamp:s}},getOffsetTimestamp(t){const e=Number(t)*1e3;const s=d.timezone.getOffset(e);const r=(e+s)/1e3;return l.DateTimeFormat.format(l.DateTimeFormat.getFormat("FORMAT_DATETIME"),r)},setRef(t,e){var s;(s=this.systemLogTimeRef)!=null?s:this.systemLogTimeRef={};this.systemLogTimeRef[e]=t}},template:`\n\t\t<template v-for="(time, id) in systemLogTime" :key="id">\n\t\t\t<div :ref="(el) => setRef(el, time.rowId)">{{ time.offsetTimestamp }}</div>\n\t\t</template>\n\t`};const y=/\(#(\d+)\)(?![\S\s]*\(#\d+\))/;const f={components:{BIcon:m.BIcon,Hint:p.Hint},props:{message:{type:Object,required:true},activeHintRowId:{type:Number,default:null}},emits:["hintOpen","hintClose"],setup(){return{Outline:m.Outline}},data(){return{showHint:false}},computed:{formattedMessage(){var t;return(t=this.message.message)==null?void 0:t.replace(y,"").trim()},linkText(){var t,e;return(t=(e=this.message.message)==null?void 0:e.match(y)[0])!=null?t:null},errorMessage(){return this.message.errors[0].MESSAGE},errorLink(){return this.message.errors[0].LINK},popupOptions(){return{offsetLeft:this.$refs.errorIcon.$el.offsetWidth/2,maxWidth:494}}},methods:{openHint(){if(this.activeHintRowId!==null&&this.activeHintRowId!==this.message.rowId){return}if(!this.showHint){this.showHint=true;this.$emit("hintOpen",this.message.rowId)}},closeHint(){if(this.showHint){this.showHint=false;this.$emit("hintClose",this.message.rowId)}}},template:`\n\t\t<div class="tasks-field-replication-message">\n\t\t\t<div v-if="message.link">{{ formattedMessage }}<a :href="message.link">{{ linkText }}</a></div>\n\t\t\t<span v-else>{{ message.message }}</span>\n\t\t\t\t<BIcon\n\t\t\t\t\tv-if="message.errors?.length > 0"\n\t\t\t\t\tref="errorIcon"\n\t\t\t\t\tclass="tasks-field-replication-error-icon"\n\t\t\t\t\t@mouseenter="openHint"\n\t\t\t\t\t:name="Outline.ALERT"\n\t\t\t\t/>\n\t\t\t\t<Hint\n\t\t\t\t\tv-if="showHint"\n\t\t\t\t\t:bindElement="$refs.errorIcon.$el"\n\t\t\t\t\t:options="popupOptions"\n\t\t\t\t\t@close="closeHint"\n\t\t\t\t>\n\t\t\t\t\t<div class="tasks-field-replication-sheet__error-hint-container">\n\t\t\t\t\t\t<div class="tasks-field-replication-sheet__error-hint__error-message">\n\t\t\t\t\t\t\t{{ errorMessage.replace('#LINK#', '') }}\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div\n\t\t\t\t\t\t\tv-if="errorLink"\n\t\t\t\t\t\t\tclass="tasks-field-replication-sheet__error-hint__error-link-container"\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<a\n\t\t\t\t\t\t\t\t:href="errorLink"\n\t\t\t\t\t\t\t\tclass="tasks-field-replication-sheet__error-hint__error-link"\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t{{ loc('TASKS_V2_TEMPLATE_HISTORY_GRID_ACCESS_RIGHTS_MORE_LINK') }}\n\t\t\t\t\t\t\t</a>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</Hint>\n\t\t</div>\n\t`};const T={components:{MessageField:f},props:{getGrid:{type:Function,required:true}},data(){return{systemLogMessageRef:[],systemLogMessage:[],activeHintRowId:null}},methods:{async update(){const t=this.getGrid().querySelectorAll("[data-system-log-message]");this.systemLogMessage=[...t].map((t=>this.getSystemLogMessage(t)));await this.$nextTick();t.forEach((t=>{const e=this.getSystemLogMessage(t);t.append(this.systemLogMessageRef[e.rowId])}))},getSystemLogMessage(t){const e=Number(t.closest("[data-id]").dataset.id);const s=JSON.parse(t.dataset.systemLogMessage);return{rowId:e,message:s.message,link:s.link,errors:s.errors}},setRef(t,e){var s;(s=this.systemLogMessageRef)!=null?s:this.systemLogMessageRef={};this.systemLogMessageRef[e]=t},onHintOpen(t){this.activeHintRowId=t},onHintClose(t){if(this.activeHintRowId===t){this.activeHintRowId=null}}},template:`\n\t\t<template v-for="(message, id) in systemLogMessage" :key="id">\n\t\t\t<MessageField\n\t\t\t\t:ref="(el) => setRef(el?.$el, message.rowId)"\n\t\t\t\t:message="message"\n\t\t\t\t:activeHintRowId\n\t\t\t\t@hintOpen="onHintOpen"\n\t\t\t\t@hintClose="onHintClose"\n\t\t\t/>\n\t\t</template>\n\t`};const v={props:{errors:{type:String,required:true}},computed:{parsedErrors(){return JSON.parse(this.errors)},isEmpty(){return g.Type.isNil(this.parsedErrors)||this.parsedErrors.length===0}},template:`\n\t\t<ul v-if="!isEmpty">\n\t\t\t<li v-for="(error, errorIndex) in parsedErrors" :key="errorIndex">\n\t\t\t\t{{ (error.MESSAGE ?? '').replace('#LINK#', '') }}\n\t\t\t\t<a\n\t\t\t\t\tv-if="error.LINK"\n\t\t\t\t\t:href="error.LINK"\n\t\t\t\t>\n\t\t\t\t\t{{ loc('TASKS_V2_TEMPLATE_HISTORY_GRID_ACCESS_RIGHTS_MORE_LINK') }}\n\t\t\t\t</a>\n\t\t\t</li>\n\t\t</ul>\n\t\t<span v-else>{{ loc('TASKS_V2_TEMPLATE_HISTORY_GRID_NO_ERRORS_PLACEHOLDER') }}</span>\n\t`};const L={components:{ErrorsList:v},props:{getGrid:{type:Function,required:true}},data(){return{systemLogErrorsRef:[],systemLogErrors:[]}},methods:{async update(){const t=this.getGrid().querySelectorAll("[data-system-log-errors]");this.systemLogErrors=[...t].map((t=>this.getSystemLogErrors(t)));await this.$nextTick();t.forEach((t=>{const e=this.getSystemLogErrors(t);t.append(this.systemLogErrorsRef[e.rowId])}))},getSystemLogErrors(t){const e=Number(t.closest("[data-id]").dataset.id);const s=t.dataset.systemLogErrors;return{rowId:e,errors:s}},setRef(t,e){var s;(s=this.systemLogErrorsRef)!=null?s:this.systemLogErrorsRef={};this.systemLogErrorsRef[e]=t}},template:`\n\t\t<template v-for="(systemErrors, id) in systemLogErrors" :key="id">\n\t\t\t<ErrorsList\n\t\t\t\t:ref="(el) => setRef(el?.$el, systemErrors.rowId)"\n\t\t\t\t:errors="systemErrors.errors"\n\t\t\t/>\n\t\t</template>\n\t`};const E={template:`\n\t\t<div class="tasks-template-history-grid-loader-spinner"/>\n\t`};const R="tasks-template-history-grid";const I={name:"TemplateHistoryGrid",components:{HeadlineXl:n.HeadlineXl,TimeFields:u,TypeFields:h,MessageFields:T,ErrorsFields:L,GridLoader:E},props:{templateId:{type:[Number,String],required:true}},mounted(){r.EventEmitter.subscribe("Grid::beforeRequest",this.handleBeforeGridRequest);r.EventEmitter.subscribe("Grid::updated",this.update);void this.getData()},beforeUnmount(){var t,e,s;r.EventEmitter.unsubscribe("Grid::beforeRequest",this.handleBeforeGridRequest);r.EventEmitter.unsubscribe("Grid::updated",this.update);(t=BX.Main)==null?void 0:(e=t.gridManager)==null?void 0:e.destroy(R);(s=i.PopupManager.getPopupById(`${R}-grid-settings-window`))==null?void 0:s.destroy()},methods:{async getData(){const{html:t}=await a.apiClient.post(o.Endpoint.TemplateHistoryGetGrid,{templateId:this.templateId});await g.Runtime.html(this.$refs.grid,t);this.update()},handleBeforeGridRequest(t){const[,e]=t.getData();if(e.url){var s;this.nav=new g.Uri((s=e.url)!=null?s:"").getQueryParams().nav}e.url=`/bitrix/services/main/ajax.php?action=tasks.V2.Template.History.getGridData&nav=${this.nav}`;e.method="POST";e.data={templateId:this.templateId}},update(){void this.$refs.timeFields.update();void this.$refs.typeFields.update();void this.$refs.messageFields.update();void this.$refs.errorsFields.update()}},template:`\n\t\t<div class="tasks-template-history-grid-container">\n\t\t\t<div class="tasks-template-history-grid-header">\n\t\t\t\t<HeadlineXl>{{ loc('TASKS_V2_TEMPLATE_HISTORY_GRID_LOG_HEADER') }}</HeadlineXl>\n\t\t\t</div>\n\t\t\t<div ref="grid" class="tasks-template-history-grid-main-content"><GridLoader/></div>\n\t\t\t<TimeFields ref="timeFields" :getGrid="() => this.$refs.grid"/>\n\t\t\t<TypeFields ref="typeFields" :getGrid="() => this.$refs.grid"/>\n\t\t\t<MessageFields ref="messageFields" :getGrid="() => this.$refs.grid"/>\n\t\t\t<ErrorsFields ref="errorsFields" :getGrid="() => this.$refs.grid"/>\n\t\t</div>\n\t`};var _=babelHelpers.classPrivateFieldLooseKey("application");var S=babelHelpers.classPrivateFieldLooseKey("params");var H=babelHelpers.classPrivateFieldLooseKey("mountApplication");var b=babelHelpers.classPrivateFieldLooseKey("unmountApplication");class M{constructor(t={}){Object.defineProperty(this,b,{value:w});Object.defineProperty(this,H,{value:k});Object.defineProperty(this,_,{writable:true,value:void 0});Object.defineProperty(this,S,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,S)[S]=t}async mount(t){babelHelpers.classPrivateFieldLooseBase(this,_)[_]=await babelHelpers.classPrivateFieldLooseBase(this,H)[H](t.getContentContainer())}unmount(){babelHelpers.classPrivateFieldLooseBase(this,b)[b]()}}async function k(t){const r=e.BitrixVue.createApp(I,babelHelpers.classPrivateFieldLooseBase(this,S)[S]);r.mixin(s.locMixin);r.mount(t);return r}function w(){var t;(t=babelHelpers.classPrivateFieldLooseBase(this,_)[_])==null?void 0:t.unmount()}t.TemplateHistoryGrid=M})(this.BX.Tasks.V2.Application=this.BX.Tasks.V2.Application||{},BX.Vue3,BX.Vue3.Mixins,BX.Event,BX.Main,BX.UI.System.Typography.Vue,BX.Tasks.V2.Lib,BX.Tasks.V2.Const,BX.Main,BX.Tasks.V2.Lib,BX.UI.IconSet,BX.Tasks.V2.Component.Elements,BX);
//# sourceMappingURL=template-history-grid.bundle.map.js