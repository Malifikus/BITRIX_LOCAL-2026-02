this.BX=this.BX||{};this.BX.Tasks=this.BX.Tasks||{};this.BX.Tasks.V2=this.BX.Tasks.V2||{};this.BX.Tasks.V2.Provider=this.BX.Tasks.V2.Provider||{};(function(e,t,s,a,i,r,l,d){"use strict";const o=d.Limit.RelationList;var n=babelHelpers.classPrivateFieldLooseKey("meta");var c=babelHelpers.classPrivateFieldLooseKey("updatePromises");var u=babelHelpers.classPrivateFieldLooseKey("safePromise");var p=babelHelpers.classPrivateFieldLooseKey("getTitle");var T=babelHelpers.classPrivateFieldLooseKey("updateStoreRelationTasks");class h{constructor(e){Object.defineProperty(this,T,{value:S});Object.defineProperty(this,p,{value:k});Object.defineProperty(this,u,{value:v});Object.defineProperty(this,n,{writable:true,value:void 0});Object.defineProperty(this,c,{writable:true,value:[]});babelHelpers.classPrivateFieldLooseBase(this,n)[n]=e}async list(e,t=false){const s=babelHelpers.classPrivateFieldLooseBase(this,c)[c].length>0;await Promise.all(babelHelpers.classPrivateFieldLooseBase(this,c)[c]);const{tasks:a,ids:r}=await this.requestTasks(e,t);if(t){if(!s&&r.length===0){void this.$store.dispatch(`${d.Model.Tasks}/setFieldFilled`,{id:e,fieldName:babelHelpers.classPrivateFieldLooseBase(this,n)[n].id,isFilled:false})}babelHelpers.classPrivateFieldLooseBase(this,T)[T](e,r)}a.forEach((t=>{if(!i.taskService.hasStoreTask(t.id,false)){void this.$store.dispatch(`${d.Model.Tasks}/addPartiallyLoaded`,t.id)}i.taskService.extractTask({...t,[babelHelpers.classPrivateFieldLooseBase(this,n)[n].relationToField]:e})}));return a}async setParent(e,t){return this.add(t,[e])}async add(e,t,s=false){const a=Object.fromEntries(t.map((e=>{var t,s;return[e,(t=(s=i.taskService.getStoreTask(e))==null?void 0:s[babelHelpers.classPrivateFieldLooseBase(this,n)[n].relationToField])!=null?t:0]})));this.addStore(e,t);if(!r.idUtils.isReal(e)||t.length===0){return null}const l=await this.requestAdd(e,t,s);if(l){var d,o;const t=Object.entries(l.data).filter((([,e])=>!e)).map((([e])=>Number(e)));this.deleteStore(e,t);t.forEach((e=>this.addStore(a[e],[e])));console.error(`${babelHelpers.classPrivateFieldLooseBase(this,n)[n].controller}.add error`,l);const s=l.errors.filter((({code:e})=>e==="Access denied"));if(s.length===1){return babelHelpers.classPrivateFieldLooseBase(this,n)[n].addError}if(s.length>1){return babelHelpers.classPrivateFieldLooseBase(this,n)[n].addErrorMany}const i=l.errors.filter((({code:e})=>e==="No override parentId"));if(i.length===1){return babelHelpers.classPrivateFieldLooseBase(this,n)[n].overrideError}if(i.length>1){return babelHelpers.classPrivateFieldLooseBase(this,n)[n].overrideErrorMany}return(d=l.errors)==null?void 0:(o=d[0])==null?void 0:o.message}return null}addStore(e,t){const s=babelHelpers.classPrivateFieldLooseBase(this,n)[n];const a=i.taskService.getStoreTask(e);babelHelpers.classPrivateFieldLooseBase(this,T)[T](e,[...(a==null?void 0:a[s.idsField])||[],...t]);t.forEach((t=>i.taskService.updateStoreTask(t,{[s.relationToField]:e})))}async delete(e,t){this.deleteStore(e,t);if(!r.idUtils.isReal(e)||t.length===0){return}const s=await this.requestDelete(e,t);if(s){this.addStore(e,t);console.error(`${babelHelpers.classPrivateFieldLooseBase(this,n)[n].controller}.delete error`,s)}}unlinkStore(e){const t=this.$store.getters[`${d.Model.Tasks}/getAll`].filter((t=>t[babelHelpers.classPrivateFieldLooseBase(this,n)[n].relationToField]===e)).map((({id:e})=>e));const s=this.$store.getters[`${d.Model.Tasks}/getAll`].filter((t=>{var s;return(s=t[babelHelpers.classPrivateFieldLooseBase(this,n)[n].idsField])==null?void 0:s.includes(e)})).map((({id:e})=>e));this.deleteStore(e,t);s.forEach((t=>this.deleteStore(t,[e])))}deleteStore(e,t){const s=babelHelpers.classPrivateFieldLooseBase(this,n)[n];const a=i.taskService.getStoreTask(e);babelHelpers.classPrivateFieldLooseBase(this,T)[T](e,a==null?void 0:a[s.idsField].filter((e=>!t.includes(e))));t.forEach((e=>i.taskService.updateStoreTask(e,{[s.relationToField]:0})))}areIdsLoaded(e){const t=babelHelpers.classPrivateFieldLooseBase(this,n)[n];const s=i.taskService.getStoreTask(e);if(!s){return false}return!s[t.containsField]||s[t.idsField].length>0}hasUnloadedIds(e){const t=i.taskService.getStoreTask(e)[babelHelpers.classPrivateFieldLooseBase(this,n)[n].idsField];return this.getVisibleIds(t).some((e=>!this.hasStoreTask(e)))}hasStoreTask(e){var t,s;const a=(t=(s=i.taskService.getStoreTask(e))==null?void 0:s.rights)!=null?t:{};return babelHelpers.classPrivateFieldLooseBase(this,n)[n].uniqueRight in a}async requestTasks(e,t=false){if(!r.idUtils.isReal(e)){const t=i.taskService.getStoreTask(e)[babelHelpers.classPrivateFieldLooseBase(this,n)[n].idsField];const{tasks:s}=await a.apiClient.post(`${babelHelpers.classPrivateFieldLooseBase(this,n)[n].controller}.listByIds`,{taskIds:this.getVisibleIds(t)});return{tasks:s,ids:t}}const{tasks:s,ids:l}=await a.apiClient.post(`${babelHelpers.classPrivateFieldLooseBase(this,n)[n].controller}.list`,{taskId:e,withIds:t,navigation:{size:o}});return{tasks:s,ids:l}}requestAdd(e,t,s=false){return this.requestUpdate(`${babelHelpers.classPrivateFieldLooseBase(this,n)[n].controller}.add`,{taskId:e,taskIds:t,noOverride:s})}requestDelete(e,t){return this.requestUpdate(`${babelHelpers.classPrivateFieldLooseBase(this,n)[n].controller}.delete`,{taskId:e,taskIds:t})}async requestUpdate(e,t){const s=babelHelpers.classPrivateFieldLooseBase(this,u)[u](a.apiClient.post(e,t));babelHelpers.classPrivateFieldLooseBase(this,c)[c].push(s);const i=await s;babelHelpers.classPrivateFieldLooseBase(this,c)[c]=babelHelpers.classPrivateFieldLooseBase(this,c)[c].filter((e=>e!==s));return i}getVisibleIds(e){return this.getSortedIds(e).slice(0,o)}getSortedIds(e){return e.sort(((e,t)=>babelHelpers.classPrivateFieldLooseBase(this,p)[p](e).localeCompare(babelHelpers.classPrivateFieldLooseBase(this,p)[p](t))))}get $store(){return s.Core.getStore()}}async function v(e){try{await e}catch(e){return e}return null}function k(e){var t,s,a;return(t=(s=(a=i.taskService.getStoreTask(e))==null?void 0:a.title)!=null?s:this.$store.getters[`${d.Model.Tasks}/getTitle`](e))!=null?t:"\uffff"}function S(e,t){const s=babelHelpers.classPrivateFieldLooseBase(this,n)[n];const a=[...new Set(t)];const r=a.length>0;if(i.taskService.hasStoreTask(e,false)){void i.taskService.updateStoreTask(e,{[s.idsField]:a,[s.containsField]:r})}}const b=d.Limit.RelationList;var f=babelHelpers.classPrivateFieldLooseKey("requestParent");class g extends h{constructor(...e){super(...e);Object.defineProperty(this,f,{value:L})}async getParent(e,t){if(i.taskService.hasStoreTask(t)){return}const s=await babelHelpers.classPrivateFieldLooseBase(this,f)[f](t);if(!s){void i.taskService.updateStoreTask(e,{parentId:0});void this.$store.dispatch(`${d.Model.Tasks}/setFieldFilled`,{id:e,fieldName:d.TaskField.Parent,isFilled:false});return}i.taskService.extractTask(s);void this.$store.dispatch(`${d.Model.Tasks}/addPartiallyLoaded`,t)}async setParent(e,s){var a;const d=i.taskService.getStoreTask(e).parentId;if(d===s){return null}if(s===0&&r.idUtils.isReal(e)){if(r.idUtils.isTemplate(e)){await t.templateService.update(e,{parentId:s});return null}return this.delete(d,[e])}if(s===e){return l.Loc.getMessage("TASKS_V2_RELATION_PARENT_CANNOT_BE_PARENT")}if((a=i.taskService.getStoreTask(e))!=null&&a.subTaskIds.includes(s)){return l.Loc.getMessage("TASKS_V2_RELATION_SUB_TASK_CANNOT_BE_PARENT")}if(!r.idUtils.isReal(e)){return this.addStore(s,[e])}if(r.idUtils.isTemplate(e)&&!r.idUtils.isTemplate(s)){await t.templateService.update(e,{parentId:s});return null}const o=await this.add(s,[e],false);if(o){this.addStore(d,[e])}return o}async add(e,t,s=true){var a,r,d;let o=null;if(t.includes(e)){var n;(n=o)!=null?n:o=l.Loc.getMessage("TASKS_V2_RELATION_SELF_CANNOT_BE_SUB_TASK")}const c=(a=i.taskService.getStoreTask(e))==null?void 0:a.parentId;if(t.includes(c)){var u;(u=o)!=null?u:o=l.Loc.getMessage("TASKS_V2_RELATION_PARENT_CANNOT_BE_SUB_TASK")}const p=t.filter((t=>t!==e&&t!==c));const T=await super.add(e,p,s);(r=o)!=null?r:o=T;if((d=i.taskService.getStoreTask(e))!=null&&d.matchesSubTasksTime){void i.taskService.get(e,{},true)}return o}async delete(e,t){var s;await super.delete(e,t);if((s=i.taskService.getStoreTask(e))!=null&&s.matchesSubTasksTime){void i.taskService.get(e,{},true)}}addStore(e,t){t.forEach((e=>{var t;return this.deleteStore((t=i.taskService.getStoreTask(e))==null?void 0:t.parentId,[e])}));super.addStore(e,t)}async requestTasks(e,s=false){var l;const d=i.taskService.getStoreTask(e);if(s&&!((l=d.subTaskIds)!=null&&l.length)&&d.templateId){const{templates:e,ids:i}=await a.apiClient.post("Template.Relation.Child.list",{templateId:d.templateId,withIds:s,navigation:{size:b}});const r=i.reduce(((e,t)=>e.set(t,`tmp.${t}`)),new Map);const l=e.map((e=>({...t.TemplateMappers.mapDtoToTaskDto(e),id:r.get(e.id),rights:{read:true,delegate:false,changeResponsible:false,detachParent:false}})));return{tasks:l,ids:[...r.values()]}}if(!r.idUtils.isTemplate(e)){return super.requestTasks(e,s)}if(!r.idUtils.isReal(e)){const t=i.taskService.getStoreTask(e).subTaskIds;const{templates:s}=await a.apiClient.post("Template.Relation.Child.listByIds",{templateIds:this.getVisibleIds(t).map((e=>r.idUtils.unbox(e)))});const l=s.map((e=>({...e,id:r.idUtils.boxTemplate(e.id)})));return{tasks:l,ids:t}}const{templates:o,ids:n}=await a.apiClient.post("Template.Relation.Child.list",{templateId:r.idUtils.unbox(e),withIds:s,navigation:{size:b}});const c=o.map((e=>({...e,id:r.idUtils.boxTemplate(e.id)})));return{tasks:c,ids:n==null?void 0:n.map((e=>r.idUtils.boxTemplate(e)))}}requestAdd(e,t,s=false){if(!r.idUtils.isTemplate(e)){return super.requestAdd(e,t,s)}return this.requestUpdate("Template.Relation.Child.add",{templateId:r.idUtils.unbox(e),templateIds:t.map((e=>r.idUtils.unbox(e))),noOverride:s})}requestDelete(e,t){if(!r.idUtils.isTemplate(e)){return super.requestDelete(e,t)}return this.requestUpdate("Template.Relation.Child.delete",{templateId:r.idUtils.unbox(e),templateIds:t.map((e=>r.idUtils.unbox(e)))})}}async function L(e){if(r.idUtils.isTemplate(e)){const{templates:t}=await a.apiClient.post("Template.Relation.Child.listByIds",{templateIds:[r.idUtils.unbox(e)]});const s=t[0];if(s){s.id=r.idUtils.boxTemplate(s.id)}return s}const{tasks:t}=await a.apiClient.post(d.Endpoint.TaskRelationChildListByIds,{taskIds:[e]});return t[0]}const m=d.Limit.RelationList;class I extends h{async add(e,t,s=false){var a;let i=null;if(t.includes(e)){var r;(r=i)!=null?r:i=l.Loc.getMessage("TASKS_V2_RELATION_SELF_CANNOT_BE_RELATED_TASK")}const d=t.filter((t=>t!==e));const o=await super.add(e,d,s);(a=i)!=null?a:i=o;return i}async requestTasks(e,t=false){var s;const l=i.taskService.getStoreTask(e);if(t&&!((s=l.relatedTaskIds)!=null&&s.length)&&l.templateId){const{tasks:e,ids:s}=await a.apiClient.post("Template.Relation.Related.list",{templateId:l.templateId,withIds:t,navigation:{size:m}});return{tasks:e,ids:s}}if(!r.idUtils.isTemplate(e)||!r.idUtils.isReal(e)){return super.requestTasks(e,t)}const{tasks:d,ids:o}=await a.apiClient.post("Template.Relation.Related.list",{templateId:r.idUtils.unbox(e),withIds:t,navigation:{size:m}});return{tasks:d,ids:o}}requestAdd(e,t,s=false){if(!r.idUtils.isTemplate(e)){return super.requestAdd(e,t,s)}return this.requestUpdate("Template.Relation.Related.add",{templateId:r.idUtils.unbox(e),taskIds:t,noOverride:s})}requestDelete(e,t){if(!r.idUtils.isTemplate(e)){return super.requestDelete(e,t)}return this.requestUpdate("Template.Relation.Related.delete",{templateId:r.idUtils.unbox(e),taskIds:t})}}function F(e,t){if(!t){return[]}return Object.entries(t).map((([t,s])=>({taskId:t,dependentId:e,type:s})))}class R extends h{async list(e,t=false){const s=await super.list(e,t);s.forEach((e=>{const t=F(e.id,e.ganttLinks);void this.$store.dispatch(`${d.Model.GanttLinks}/upsertMany`,t)}))}async checkDependence(e){if(!r.idUtils.isReal(e.taskId)){return null}const t=await this.requestUpdate("Task.Relation.Gantt.Dependence.check",{ganttLink:e});if(t){var s,a;return(s=t.errors)==null?void 0:(a=s[0])==null?void 0:a.message}return null}async addDependence(e){const{taskId:t,dependentId:s}=e;this.addStore(t,[s]);void this.$store.dispatch(`${d.Model.GanttLinks}/upsert`,e);if(!r.idUtils.isReal(t)){return null}const a=await this.requestUpdate("Task.Relation.Gantt.Dependence.add",{ganttLink:e});if(a){var i,l;this.deleteStore(t,[s]);console.error("Task.Relation.Gantt.Dependence.add error",a);return(i=a.errors)==null?void 0:(l=i[0])==null?void 0:l.message}return null}async updateDependence(e){void this.$store.dispatch(`${d.Model.GanttLinks}/upsert`,e);if(!r.idUtils.isReal(e.taskId)){return null}const t=await this.requestUpdate("Task.Relation.Gantt.Dependence.update",{ganttLink:e});if(t){var s,a;console.error("Task.Relation.Gantt.Dependence.update error",t);return(s=t.errors)==null?void 0:(a=s[0])==null?void 0:a.message}return null}async delete(e,t){const s={taskId:e,dependentId:t[0]};this.deleteStore(e,t);if(!r.idUtils.isReal(e)){return}const a=await this.requestUpdate("Task.Relation.Gantt.Dependence.delete",{ganttLink:s});if(a){this.addStore(e,t);console.error("Task.Relation.Gantt.Dependence.delete error",a)}}}const P=Object.freeze({id:d.TaskField.SubTasks,idsField:"subTaskIds",containsField:"containsSubTasks",relationToField:"parentId",controller:"Task.Relation.Child",uniqueRight:"detachParent",addError:l.Loc.getMessage("TASKS_V2_RELATION_SUBTASKS_NO_ACCESS"),addErrorMany:l.Loc.getMessage("TASKS_V2_RELATION_SUBTASKS_NO_ACCESS_MANY"),overrideError:l.Loc.getMessage("TASKS_V2_RELATION_CANNOT_OVERRIDE_PARENT"),overrideErrorMany:l.Loc.getMessage("TASKS_V2_RELATION_CANNOT_OVERRIDE_PARENT_MANY")});const _=Object.freeze({id:d.TaskField.RelatedTasks,idsField:"relatedTaskIds",containsField:"containsRelatedTasks",relationToField:"relatedToTaskId",controller:"Task.Relation.Related",uniqueRight:"detachRelated",addError:l.Loc.getMessage("TASKS_V2_RELATION_RELATED_TASKS_NO_ACCESS"),addErrorMany:l.Loc.getMessage("TASKS_V2_RELATION_RELATED_TASKS_NO_ACCESS_MANY")});const B=Object.freeze({id:d.TaskField.Gantt,idsField:"ganttTaskIds",containsField:"containsGanttLinks",relationToField:"ganttParentId",controller:"Task.Relation.Gantt.Dependence",uniqueRight:"changeDependence"});const A=new g(P);const E=new I(_);const U=new R(B);e.subTasksService=A;e.relatedTasksService=E;e.ganttService=U})(this.BX.Tasks.V2.Provider.Service=this.BX.Tasks.V2.Provider.Service||{},BX.Tasks.V2.Provider.Service,BX.Tasks.V2,BX.Tasks.V2.Lib,BX.Tasks.V2.Provider.Service,BX.Tasks.V2.Lib,BX,BX.Tasks.V2.Const);
//# sourceMappingURL=relation-service.bundle.map.js