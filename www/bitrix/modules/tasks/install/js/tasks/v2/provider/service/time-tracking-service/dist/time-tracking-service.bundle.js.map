{"version":3,"file":"time-tracking-service.bundle.js","sources":["../src/mappers.js","../src/time-tracking-service.js","../src/index.js"],"sourcesContent":["import type { ElapsedTimeModel } from 'tasks.v2.model.elapsed-times';\nimport type { ElapsedTimeDto } from './types';\n\nexport function mapModelToDto(elapsedTime: ElapsedTimeModel): ElapsedTimeDto\n{\n\treturn {\n\t\tid: elapsedTime.id,\n\t\ttaskId: elapsedTime.taskId,\n\t\tuserId: elapsedTime.userId,\n\t\tseconds: elapsedTime.seconds,\n\t\tsource: elapsedTime.source,\n\t\ttext: elapsedTime.text,\n\t\tcreatedAtTs: elapsedTime.createdAtTs,\n\t\tstartTs: elapsedTime.startTs,\n\t\tstopTs: elapsedTime.stopTs,\n\t\trights: elapsedTime.rights,\n\t};\n}\n\nexport function mapDtoToModel(elapsedTimeDto: ElapsedTimeDto): ElapsedTimeModel\n{\n\treturn {\n\t\tid: elapsedTimeDto.id,\n\t\ttaskId: elapsedTimeDto.taskId,\n\t\tuserId: elapsedTimeDto.userId,\n\t\tseconds: elapsedTimeDto.seconds,\n\t\tsource: elapsedTimeDto.source,\n\t\ttext: elapsedTimeDto.text,\n\t\tcreatedAtTs: elapsedTimeDto.createdAtTs,\n\t\tstartTs: elapsedTimeDto.startTs,\n\t\tstopTs: elapsedTimeDto.stopTs,\n\t\trights: elapsedTimeDto.rights,\n\t};\n}\n","import type { Store } from 'ui.vue3.vuex';\n\nimport { Model, Endpoint } from 'tasks.v2.const';\nimport { Core } from 'tasks.v2.core';\nimport { apiClient } from 'tasks.v2.lib.api-client';\nimport { taskService } from 'tasks.v2.provider.service.task-service';\nimport { UserMappers } from 'tasks.v2.provider.service.user-service';\nimport type { ElapsedTimeModel } from 'tasks.v2.model.elapsed-times';\nimport type { UserModel } from 'tasks.v2.model.users';\nimport type { UserDto } from 'tasks.v2.provider.service.user-service';\n\nimport { mapDtoToModel, mapModelToDto } from './mappers';\n\nexport class TimeTrackingService\n{\n\t#state: { [taskId: number]: { page: number, size: number, isLoading: boolean, hasMore: boolean } } = {};\n\n\tasync list(taskId: number, options: { reset?: boolean, size?: number } = {}): Promise<void>\n\t{\n\t\tif (!Number.isInteger(taskId))\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tconst requestedSize = Number.isInteger(options.size) ? Number(options.size) : undefined;\n\n\t\tif (!this.#state[taskId] || options.reset)\n\t\t{\n\t\t\tthis.#state[taskId] = { page: 0, size: requestedSize ?? 20, isLoading: false, hasMore: true };\n\t\t}\n\n\t\tconst state = this.#state[taskId];\n\n\t\tif (state.isLoading || !state.hasMore)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tconst nextPage = state.page + 1;\n\t\tconst pageSize = requestedSize ?? state.size;\n\n\t\tstate.isLoading = true;\n\n\t\ttry\n\t\t{\n\t\t\tconst data = await apiClient.post(Endpoint.TaskTimeTrackingList, {\n\t\t\t\ttaskId,\n\t\t\t\tnavigation: {\n\t\t\t\t\tpage: nextPage,\n\t\t\t\t\tsize: pageSize,\n\t\t\t\t},\n\t\t\t});\n\n\t\t\tawait this.$store.dispatch(`${Model.ElapsedTimes}/upsertMany`, data.map((it) => mapDtoToModel(it)));\n\n\t\t\tstate.page = nextPage;\n\t\t\tstate.size = pageSize;\n\t\t\tstate.hasMore = Array.isArray(data) ? data.length === pageSize : false;\n\t\t}\n\t\tcatch (error)\n\t\t{\n\t\t\tconsole.error('ElapsedTime.list', error);\n\t\t}\n\t\tfinally\n\t\t{\n\t\t\tthis.#state[taskId].isLoading = false;\n\t\t}\n\t}\n\n\tisLoading(taskId: number): boolean\n\t{\n\t\tconst state = this.#state[taskId];\n\n\t\treturn state && state.isLoading;\n\t}\n\n\tasync listParticipants(taskId: number): Promise<[UserModel[], []]>\n\t{\n\t\ttry\n\t\t{\n\t\t\tconst data = await apiClient.post(Endpoint.TaskTimeTrackingListParticipants, { taskId });\n\n\t\t\tconst users = data.users.map((user: UserDto) => UserMappers.mapDtoToModel(user));\n\n\t\t\tawait this.$store.dispatch(`${Model.Users}/upsertMany`, users);\n\n\t\t\treturn [users, data.contribution];\n\t\t}\n\t\tcatch (error)\n\t\t{\n\t\t\tconsole.error('ElapsedTime.listParticipants', error);\n\n\t\t\treturn [];\n\t\t}\n\t}\n\n\tasync add(taskId: number, elapsedTime: ElapsedTimeModel): Promise<?number>\n\t{\n\t\ttry\n\t\t{\n\t\t\tconst task = taskService.getStoreTask(taskId);\n\t\t\tvoid taskService.updateStoreTask(taskId, {\n\t\t\t\tnumberOfElapsedTimes: task.numberOfElapsedTimes + 1,\n\t\t\t\ttimeSpent: task.timeSpent + elapsedTime.seconds,\n\t\t\t});\n\n\t\t\tvoid this.$store.dispatch(`${Model.ElapsedTimes}/insert`, elapsedTime);\n\n\t\t\tconst savedElapsedTime = await apiClient.post(Endpoint.TaskTimeTrackingAdd, {\n\t\t\t\ttask: {\n\t\t\t\t\tid: taskId,\n\t\t\t\t\telapsedTime: mapModelToDto(elapsedTime),\n\t\t\t\t},\n\t\t\t});\n\n\t\t\tvoid this.$store.dispatch(`${Model.ElapsedTimes}/update`, {\n\t\t\t\tid: elapsedTime.id,\n\t\t\t\tfields: mapDtoToModel(savedElapsedTime),\n\t\t\t});\n\n\t\t\treturn savedElapsedTime.id;\n\t\t}\n\t\tcatch (error)\n\t\t{\n\t\t\tconsole.error('ElapsedTime.add', error);\n\n\t\t\treturn null;\n\t\t}\n\t}\n\n\tasync update(taskId: number, elapsedTime: ElapsedTimeModel): Promise<void>\n\t{\n\t\ttry\n\t\t{\n\t\t\tconst currentElapsedTime = this.$store.getters[`${Model.ElapsedTimes}/getById`](elapsedTime.id);\n\t\t\tconst timeSpentDifference = elapsedTime.seconds - currentElapsedTime.seconds;\n\n\t\t\tconst task = taskService.getStoreTask(taskId);\n\t\t\tvoid taskService.updateStoreTask(taskId, {\n\t\t\t\ttimeSpent: task.timeSpent + timeSpentDifference,\n\t\t\t});\n\n\t\t\tvoid this.$store.dispatch(`${Model.ElapsedTimes}/update`, {\n\t\t\t\tid: elapsedTime.id,\n\t\t\t\tfields: elapsedTime,\n\t\t\t});\n\n\t\t\tawait apiClient.post(Endpoint.TaskTimeTrackingUpdate, {\n\t\t\t\telapsedTime: mapModelToDto(elapsedTime),\n\t\t\t});\n\t\t}\n\t\tcatch (error)\n\t\t{\n\t\t\tconsole.error('ElapsedTime.update', error);\n\t\t}\n\t}\n\n\tasync delete(taskId: number, elapsedTime: ElapsedTimeModel): Promise<void>\n\t{\n\t\ttry\n\t\t{\n\t\t\tconst task = taskService.getStoreTask(taskId);\n\t\t\tvoid taskService.updateStoreTask(taskId, {\n\t\t\t\tnumberOfElapsedTimes: task.numberOfElapsedTimes - 1,\n\t\t\t\ttimeSpent: task.timeSpent - elapsedTime.seconds,\n\t\t\t});\n\n\t\t\tvoid this.$store.dispatch(`${Model.ElapsedTimes}/delete`, elapsedTime.id);\n\n\t\t\tawait apiClient.post(Endpoint.TaskTimeTrackingDelete, {\n\t\t\t\telapsedTimeId: elapsedTime.id,\n\t\t\t});\n\t\t}\n\t\tcatch (error)\n\t\t{\n\t\t\tconsole.error('ElapsedTime.delete', error);\n\t\t}\n\t}\n\n\tget $store(): Store\n\t{\n\t\treturn Core.getStore();\n\t}\n}\n","import { mapModelToDto, mapDtoToModel } from './mappers';\nimport { TimeTrackingService } from './time-tracking-service';\n\nexport const timeTrackingService = new TimeTrackingService();\nexport const TimeTrackingMappers = { mapModelToDto, mapDtoToModel };\n"],"names":["mapModelToDto","elapsedTime","id","taskId","userId","seconds","source","text","createdAtTs","startTs","stopTs","rights","mapDtoToModel","elapsedTimeDto","TimeTrackingService","list","options","Number","isInteger","requestedSize","size","undefined","reset","page","isLoading","hasMore","state","nextPage","pageSize","data","apiClient","post","Endpoint","TaskTimeTrackingList","navigation","$store","dispatch","Model","ElapsedTimes","map","it","Array","isArray","length","error","console","listParticipants","TaskTimeTrackingListParticipants","users","user","UserMappers","Users","contribution","add","task","taskService","getStoreTask","updateStoreTask","numberOfElapsedTimes","timeSpent","savedElapsedTime","TaskTimeTrackingAdd","fields","update","currentElapsedTime","getters","timeSpentDifference","TaskTimeTrackingUpdate","delete","TaskTimeTrackingDelete","elapsedTimeId","Core","getStore","timeTrackingService","TimeTrackingMappers"],"mappings":"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"}