{"version":3,"file":"script.js","sources":["src/user-manager.js","src/base-command-handler.js","src/client-command-handler.js","src/server-command-handler.js","src/custom-error-controls.js","src/onlyoffice.js","src/waiting.js"],"sourcesContent":["import type {Context, User, UserManagerOptions} from \"./types\";\nimport {PULL} from \"pull.client\";\nimport {ajax as Ajax} from \"main.core\";\nimport {Users} from \"disk.users\";\nimport {BaseEvent, EventEmitter} from \"main.core.events\";\n\nconst ALLOWED_ATTEMPTS_TO_GET_USER_INFO = 3;\nconst SECONDS_TO_ACTUALIZE_ONLINE = 25;\n\nexport default class UserManager\n{\n\tuserBoxNode: HTMLElement = null;\n\tcontext: Context = null\n\tusers: Users;\n\tbadAttempts: Map<number>;\n\talreadySaidHi: boolean = false;\n\n\tconstructor(options: UserManagerOptions)\n\t{\n\t\tthis.users = new BX.Disk.Users([]);\n\t\tthis.badAttempts = new Map();\n\t\tthis.context = options.context;\n\t\tthis.userBoxNode = options.userBoxNode;\n\t\tthis.alreadySaidHi = false;\n\t\tthis.add(this.context.currentUser);\n\n\t\tthis.bindEvents();\n\t}\n\n\tbindEvents(): void\n\t{\n\t\tEventEmitter.subscribe('onPullStatus', (event: BaseEvent) => {\n\t\t\tif (event.getData()[0] === 'online')\n\t\t\t{\n\t\t\t\tthis.handleWhenPullConnected();\n\t\t\t}\n\t\t});\n\t}\n\n\thandleWhenPullConnected(): void\n\t{\n\t\tif (!this.sentGreetings())\n\t\t{\n\t\t\tthis.sendHiToUsers();\n\t\t\tsetInterval(this.actualizeOnline.bind(this), 1000*SECONDS_TO_ACTUALIZE_ONLINE);\n\t\t}\n\t}\n\n\tactualizeOnline(): void\n\t{\n\t\tthis.refineUsersByOnline();\n\t\tif (!this.sentGreetings())\n\t\t{\n\t\t\tthis.sendHiToUsers();\n\t\t}\n\t\telse\n\t\t{\n\t\t\tthis.sendPingToUsers();\n\t\t}\n\t}\n\n\tsentGreetings(): boolean\n\t{\n\t\treturn this.alreadySaidHi;\n\t}\n\n\tsendHiToUsers(): void\n\t{\n\t\tif (!PULL.isConnected())\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tPULL.sendMessageToChannels([this.context.object.publicChannel], 'disk', 'hiToDocument', {\n\t\t\tuser: {\n\t\t\t\tid: this.context.currentUser.id,\n\t\t\t\tname: this.context.currentUser.name,\n\t\t\t\tavatar: this.#makeLinkAbsolute(this.context.currentUser.avatar),\n\t\t\t},\n\t\t});\n\n\t\tthis.alreadySaidHi = true;\n\t}\n\n\t#makeLinkAbsolute(link: string): string\n\t{\n\t\tif (link.includes('http://') || link.includes('https://'))\n\t\t{\n\t\t\treturn link;\n\t\t}\n\n\t\treturn document.location.origin + link;\n\t}\n\n\tsendWelcomeToUser(): void\n\t{\n\t\tif (!PULL.isConnected())\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tPULL.sendMessageToChannels([this.context.object.publicChannel], 'disk', 'welcomeToDocument', {\n\t\t\tuser: {\n\t\t\t\tid: this.context.currentUser.id,\n\t\t\t\tname: this.context.currentUser.name,\n\t\t\t\tavatar: this.#makeLinkAbsolute(this.context.currentUser.avatar),\n\t\t\t},\n\t\t});\n\t}\n\n\tsendPingToUsers(): void\n\t{\n\t\tif (!PULL.isConnected())\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tPULL.sendMessageToChannels([this.context.object.publicChannel], 'disk', 'pingDocument', {\n\t\t\tfromUserId: this.context.currentUser.id,\n\t\t\tinfoToken: this.context.currentUser.infoToken,\n\t\t});\n\t}\n\n\tadd(user: User): void\n\t{\n\t\tif (!this.users.hasUser(user.id))\n\t\t{\n\t\t\tthis.users.addUser(user);\n\n\t\t\tconsole.log('Hi new user!', user.id);\n\t\t}\n\n\t\tthis.updateOnline(user.id);\n\t\tthis.renderBox();\n\t}\n\n\tupdateOnline(userId: number): void\n\t{\n\t\tif (this.users.hasUser(userId))\n\t\t{\n\t\t\tthis.users.getUser(userId).onlineAt = Date.now();\n\t\t}\n\t}\n\n\tgetUserInfo(userId: number, infoToken: string): Promise\n\t{\n\t\tif (this.badAttempts.get(userId) >= ALLOWED_ATTEMPTS_TO_GET_USER_INFO)\n\t\t{\n\t\t\treturn new Promise((resolve, reject) => {\n\t\t\t\treject({\n\t\t\t\t\tstatus: 'blocked',\n\t\t\t\t})\n\t\t\t});\n\t\t}\n\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tAjax.runComponentAction('bitrix:disk.file.editor-onlyoffice', 'getUserInfo', {\n\t\t\t\tmode: 'ajax',\n\t\t\t\tjson: {\n\t\t\t\t\tdocumentSessionId: this.context.documentSession.id,\n\t\t\t\t\tdocumentSessionHash: this.context.documentSession.hash,\n\t\t\t\t\tuserId: userId,\n\t\t\t\t\tinfoToken: infoToken,\n\t\t\t\t}\n\t\t\t}).then((response) => {\n\t\t\t\tif (response.status === 'success')\n\t\t\t\t{\n\t\t\t\t\tthis.badAttempts.delete(userId);\n\t\t\t\t\tresolve(response.data.user);\n\t\t\t\t}\n\t\t\t}, (response) => {\n\t\t\t\tconst attempts = this.badAttempts.get(userId) || 0;\n\t\t\t\tthis.badAttempts.set(userId, attempts + 1);\n\t\t\t\tconsole.log(this.badAttempts)\n\n\t\t\t\treject(response);\n\t\t\t});\n\t\t});\n\t}\n\n\thas(userId: number): boolean\n\t{\n\t\treturn this.users.hasUser(userId);\n\t}\n\n\tremove(userId: number): void\n\t{\n\t\tif (userId === this.context.currentUser.id)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tthis.users.deleteUser(userId);\n\t\tthis.renderBox();\n\t}\n\n\trefineUsersByOnline(): void\n\t{\n\t\tconst secondsToOffline = 1000*(SECONDS_TO_ACTUALIZE_ONLINE+1)*2;\n\t\tconst now = Date.now();\n\n\t\tthis.users.forEach((user: User) => {\n\t\t\tif (now - user.onlineAt > secondsToOffline)\n\t\t\t{\n\t\t\t\tthis.remove(user.id);\n\t\t\t}\n\t\t})\n\t}\n\n\trenderBox(): void\n\t{\n\t\tif (!this.userBoxNode.childElementCount)\n\t\t{\n\t\t\tthis.userBoxNode.appendChild(this.users.getContainer());\n\t\t}\n\t}\n};","import {PullClient} from \"pull.client\";\nimport type {CommandOptions} from \"./types\";\nimport UserManager from \"./user-manager\";\nimport OnlyOffice from \"./onlyoffice\";\n\nexport default class BaseCommandHandler\n{\n\toptions: CommandOptions = null;\n\tonlyOffice: OnlyOffice = null;\n\tuserManager: UserManager = null;\n\n\tconstructor(commandOptions: CommandOptions)\n\t{\n\t\tthis.options = commandOptions;\n\t\tthis.userManager = commandOptions.userManager;\n\t\tthis.context = commandOptions.context;\n\t\tthis.onlyOffice = commandOptions.onlyOffice;\n\t}\n\n\tgetModuleId(): string\n\t{\n\t\treturn 'disk';\n\t}\n\n\tgetSubscriptionType(): string\n\t{\n\t\treturn PullClient.SubscriptionType.Server;\n\t}\n\n\tfilterCurrentObject(handler: Function): any\n\t{\n\t\treturn (data) => {\n\t\t\tif (this.context.object.id !== data.object.id)\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\treturn handler(data);\n\t\t};\n\t}\n\n\tisCurrentUser(userId: number): boolean\n\t{\n\t\treturn this.context.currentUser.id === userId;\n\t}\n}","import BaseCommandHandler from \"./base-command-handler\";\nimport {PullClient} from \"pull.client\";\nimport type {ExitDocumentMessage, HiDocumentMessage, PingDocumentMessage, WelcomeDocumentMessage} from \"./types\";\n\nexport default class ClientCommandHandler extends BaseCommandHandler\n{\n\tgetSubscriptionType(): string\n\t{\n\t\treturn PullClient.SubscriptionType.Client;\n\t}\n\n\tgetMap(): Object\n\t{\n\t\treturn {\n\t\t\texitDocument: this.handleExitDocument.bind(this),\n\t\t\tpingDocument: this.handlePingDocument.bind(this),\n\t\t\thiToDocument: this.handleHiToDocument.bind(this),\n\t\t\twelcomeToDocument: this.handleWelcomeToDocument.bind(this),\n\t\t};\n\t}\n\n\thandleExitDocument(data: ExitDocumentMessage): void\n\t{\n\t\tconsole.log('exitDocument', data);\n\n\t\tconst fromUserId = data.fromUserId;\n\t\tif (!this.isCurrentUser(fromUserId))\n\t\t{\n\t\t\tthis.userManager.remove(fromUserId);\n\t\t}\n\t}\n\n\thandleWelcomeToDocument(data: WelcomeDocumentMessage): void\n\t{\n\t\tconsole.log('handleWelcomeToDocument', data);\n\n\t\tthis.processNewbieInDocument(data);\n\t}\n\n\thandleHiToDocument(data: HiDocumentMessage): void\n\t{\n\t\tconsole.log('handleHiToDocument', data);\n\n\t\tconst newbieAdded = this.processNewbieInDocument(data);\n\t\tif (newbieAdded)\n\t\t{\n\t\t\t//immediately send welcome to add actual online information for new user.\n\t\t\tthis.userManager.sendWelcomeToUser();\n\t\t}\n\t}\n\n\tprocessNewbieInDocument(data: HiDocumentMessage|WelcomeDocumentMessage): boolean\n\t{\n\t\tconst fromUserId = data.user.id;\n\t\tif (this.isCurrentUser(fromUserId))\n\t\t{\n\t\t\treturn false;\n\t\t}\n\n\t\tif (this.userManager.has(fromUserId))\n\t\t{\n\t\t\tthis.userManager.updateOnline(fromUserId);\n\n\t\t\treturn false;\n\t\t}\n\n\t\tthis.userManager.add(data.user);\n\n\t\treturn true;\n\t}\n\n\thandlePingDocument(data: PingDocumentMessage): void\n\t{\n\t\tconsole.log('handlePingDocument', data);\n\n\t\tconst fromUserId = data.fromUserId;\n\t\tif (this.isCurrentUser(fromUserId))\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tif (this.userManager.has(fromUserId))\n\t\t{\n\t\t\tthis.userManager.updateOnline(fromUserId);\n\t\t}\n\t\telse\n\t\t{\n\t\t\tif (this.userManager.sentGreetings())\n\t\t\t{\n\t\t\t\tthis.userManager.getUserInfo(data.fromUserId, data.infoToken).then(userData => {\n\t\t\t\t\tthis.userManager.add(userData);\n\t\t\t\t}, () => {});\n\t\t\t}\n\t\t}\n\t}\n}","import BaseCommandHandler from \"./base-command-handler\";\nimport type {DocumentSavedMessage} from \"./types\";\nimport {ContentUpdatedMessage} from \"./types\";\nimport {Loc, Tag, Text} from \"main.core\";\n\nexport default class ServerCommandHandler extends BaseCommandHandler\n{\n\tgetMap(): Object\n\t{\n\t\treturn {\n\t\t\tonlyoffice: this.filterCurrentObject(this.handleSavedDocument.bind(this)),\n\t\t\tcontentUpdated: this.filterCurrentObject(this.handleContentUpdated.bind(this)),\n\t\t};\n\t}\n\n\thandleSavedDocument(data: DocumentSavedMessage): void\n\t{\n\t\tconsole.log('handleSavedDocument', data);\n\n\t\tif (data.documentSessionInfo.wasFinallySaved)\n\t\t{\n\t\t\tBX.UI.Notification.Center.notify({\n\t\t\t\tautoHide: false,\n\t\t\t\tcontent: Loc.getMessage('DISK_FILE_EDITOR_ONLYOFFICE_SAVED_AFTER_IDLE'),\n\t\t\t});\n\t\t}\n\t}\n\n\thandleContentUpdated(data: ContentUpdatedMessage): void\n\t{\n\t\tconsole.log('handleContentUpdated', data);\n\n\t\tif (!data.object.updatedBy || this.isCurrentUser(data.object.updatedBy))\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tif (this.onlyOffice.wasDocumentChanged())\n\t\t{\n\t\t\tthis.userManager.getUserInfo(data.object.updatedBy, data.updatedBy.infoToken).then(userData => {\n\t\t\t\tBX.UI.Notification.Center.notify({\n\t\t\t\t\tcontent: Loc.getMessage('DISK_FILE_EDITOR_ONLYOFFICE_SAVED_WHILE_EDITING', {\n\t\t\t\t\t\t'#NAME#': Text.encode(data.object.name),\n\t\t\t\t\t\t'#USER_NAME#': Text.encode(userData.name),\n\t\t\t\t\t}),\n\t\t\t\t});\n\t\t\t}, () => {});\n\t\t}\n\t\telse if (this.onlyOffice.isViewMode())\n\t\t{\n\t\t\tthis.userManager.getUserInfo(data.object.updatedBy, data.updatedBy.infoToken).then(userData => {\n\t\t\t\tlet content = Loc.getMessage('DISK_FILE_EDITOR_ONLYOFFICE_VIEW_NON_ACTUAL_VERSION', {\n\t\t\t\t\t'#NAME#': Text.encode(data.object.name),\n\t\t\t\t\t'#USER_NAME#': Text.encode(userData.name),\n\t\t\t\t});\n\t\t\t\tcontent = Tag.render`<span>${content}</span>`;\n\n\t\t\t\tconst refreshButton = content.querySelector('[data-refresh-btn]');\n\t\t\t\tif (refreshButton)\n\t\t\t\t{\n\t\t\t\t\tTag.style(refreshButton)`\n\t\t\t\t\t\tcursor: pointer;\n\t\t\t\t\t`;\n\t\t\t\t\trefreshButton.addEventListener('click', this.#handleClickToRefreshEditor.bind(this));\n\t\t\t\t}\n\n\t\t\t\tBX.UI.Notification.Center.notify({\n\t\t\t\t\tcontent: content,\n\t\t\t\t});\n\t\t\t}, () => {});\n\t\t}\n\t}\n\n\t#handleClickToRefreshEditor(): void\n\t{\n\t\tthis.onlyOffice.reloadView();\n\t}\n}","import {Dom, Loc, Tag, Text} from \"main.core\";\nimport { Button, ButtonSize, ButtonIcon, AirButtonStyle } from \"ui.buttons\";\nimport type {CommonWarningOptions} from \"./types\";\nimport 'ui.icon-set.outline';\n\nexport default class CustomErrorControl\n{\n\tshowWhenTooLarge(fileName: string, container: HTMLElement, targetNode: HTMLElement, linkToDownload: string, downloadSizeValue: string): void\n\t{\n\t\tthis.showCommonWarning({\n\t\t\tcontainer: container,\n\t\t\ttargetNode: targetNode,\n\t\t\ttitle: Loc.getMessage('DISK_FILE_EDITOR_ONLYOFFICE_CUSTOM_ERROR_LARGE_FILE_TITLE'),\n\t\t\tdescription: Loc.getMessage('DISK_FILE_EDITOR_ONLYOFFICE_CUSTOM_ERROR_LARGE_FILE_DESCR'),\n\t\t\tfileName: fileName,\n\t\t\tlinkToDownload: linkToDownload,\n\t\t\tdownloadSizeValue: downloadSizeValue,\n\t\t});\n\t}\n\n\tshowWhenNotFound(container: HTMLElement, targetNode: HTMLElement): void\n\t{\n\t\tthis.showCommonWarning({\n\t\t\tcontainer: container,\n\t\t\ttargetNode: targetNode,\n\t\t\ttitle: Loc.getMessage('DISK_FILE_EDITOR_ONLYOFFICE_CUSTOM_ERROR_FILE_TITLE'),\n\t\t\tdescription: Loc.getMessage('DISK_FILE_EDITOR_ONLYOFFICE_CUSTOM_ERROR_RIGHTS_OR_NOT_FOUND_DESCR'),\n\t\t});\n\t}\n\n\tshowCommonWarning(options: CommonWarningOptions): void\n\t{\n\t\tconst containerClass = 'disk-fe-office-warning--popup';\n\n\t\tlet fileNameNode = '';\n\t\tif (options.fileName)\n\t\t{\n\t\t\tfileNameNode = Tag.render`<div class=\"disk-fe-office-warning-file-name\">${Text.encode(options.fileName)}</div>`;\n\t\t}\n\n\t\tlet downloadButtonNode = '';\n\t\tif (options.linkToDownload)\n\t\t{\n\t\t\tlet downloadSize = '';\n\t\t\tif (options.downloadSizeValue)\n\t\t\t{\n\t\t\t\tdownloadSize = options.downloadSizeValue;\n\t\t\t}\n\n\t\t\tconst downloadButton = new Button({\n\t\t\t\ttext: Loc.getMessage('DISK_FILE_EDITOR_ONLYOFFICE_HEADER_BTN_DOWNLOAD'),\n\t\t\t\tround: true,\n\t\t\t\tnoCaps: true,\n\t\t\t\ttag: Button.Tag.LINK,\n\t\t\t\tlink: options.linkToDownload,\n\t\t\t\tcolor: AirButtonStyle.FILLED,\n\t\t\t\tclassName: '--air disk-fe-office-warning-btn',\n\t\t\t\ticon: ButtonIcon.DOWNLOAD,\n\t\t\t\ticonPosition: 'left',\n\t\t\t\tsize: ButtonSize.LARGE,\n\t\t\t\tprops: {\n\t\t\t\t\ttarget: '_blank',\n\t\t\t\t},\n\t\t\t});\n\t\t\tdownloadButtonNode = downloadButton.render();\n\t\t\tdownloadButton.setText(\n\t\t\t\t`${Loc.getMessage('DISK_FILE_EDITOR_ONLYOFFICE_HEADER_BTN_DOWNLOAD')} ${downloadSize}`,\n\t\t\t);\n\t\t}\n\n\t\tconst errorControl = Tag.render`\n\t\t\t<div class=\"disk-fe-office-warning-wrap\">\n\t\t\t\t<div class=\"disk-fe-office-warning-overlay\"></div>\n\t\t\t\t<div class=\"disk-fe-office-warning-box\">\n\t\t\t\t\t<div class=\"disk-fe-office-warning-icon\"></div>\n\t\t\t\t\t<div class=\"disk-fe-office-warning-title\">${options.title}</div>\t\t\t\t\n\t\t\t\t\t<div class=\"disk-fe-office-warning-desc\">${options.description}</div>\n\t\t\t\t\t${fileNameNode}\n\t\t\t\t\t${downloadButtonNode}\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t`;\n\n\t\tDom.addClass(options.container, containerClass);\n\t\tDom.prepend(errorControl, options.targetNode);\n\t}\n}\n","import { ajax as Ajax, Runtime, Type, userOptions } from 'main.core';\nimport { BaseEvent, EventEmitter } from 'main.core.events';\nimport { MenuItem } from 'main.popup';\nimport { PULL, PullClient } from 'pull.client';\nimport type { EditorOptions, DocumentSession, Context, SessionBoostOptions } from './types';\nimport { ButtonManager, Button, SplitButton } from 'ui.buttons';\nimport ClientCommandHandler from './client-command-handler';\nimport ServerCommandHandler from './server-command-handler';\nimport UserManager from './user-manager';\nimport { LegacyPopup, SharingControlType } from 'disk.sharing-legacy-popup';\nimport { ExternalLink, ExternalLinkForUnifiedLink } from 'disk.external-link';\nimport CustomErrorControl from './custom-error-controls';\nimport { Factory as PromoBoostFactory, Checker as PromoBoostChecker } from 'disk.promo-boost';\nimport { OnlyOfficePromoActions } from 'disk.onlyoffice-promo-actions';\nimport { MessageBox, MessageBoxButtons } from 'ui.dialogs.messagebox';\n\nconst SECONDS_TO_MARK_AS_STILL_WORKING = 60;\n\nimport { LocalStorageCache } from 'main.core.cache';\nconst cache = new LocalStorageCache();\n\nexport default class OnlyOffice\n{\n\teditor: any = null;\n\teditorJson: any = null;\n\tuserBoxNode: HTMLElement = null;\n\teditorNode: HTMLElement = null;\n\teditorWrapperNode: HTMLElement = null;\n\ttargetNode: HTMLElement = null;\n\tdocumentSession: DocumentSession = null;\n\tlinkToEdit: string = null;\n\tlinkToView: string = null;\n\tlinkToDownload: string = null;\n\tdownloadSizeValue: string = null;\n\tpullConfig: any = null;\n\tpullUserConfig: any = null;\n\teditButton: SplitButton = null;\n\tsetupSharingButton: Button = null;\n\tdocumentWasChanged: boolean = false;\n\tdontEndCurrentDocumentSession: boolean = false;\n\tcontext: Context = null;\n\tusersInDocument: UserManager = null;\n\tsharingControlType: ?SharingControlType = null;\n\tbrokenDocumentOpened: boolean = false;\n\tsessionBoostOptions: ?SessionBoostOptions = null;\n\tunifiedLinkAccessOnly: boolean = false;\n\tpromoShowImmediately: boolean = false;\n\tonlyOfficePromoActions: ?OnlyOfficePromoActions = null;\n\trealtimeForceReloadTag: ?string = null;\n\trealtimeForceReloadCommand: ?string = null;\n\tautoForceReloadAfter: int = null;\n\ttexts: any = null;\n\tuserPullClient: any = null;\n\n\tconstructor(editorOptions: EditorOptions)\n\t{\n\t\tconst options = Type.isPlainObject(editorOptions) ? editorOptions : {};\n\n\t\tthis.pullConfig = options.pullConfig;\n\t\tthis.pullUserConfig = options.pullUserConfig;\n\t\tthis.documentSession = options.documentSession;\n\t\tthis.linkToEdit = options.linkToEdit;\n\t\tthis.linkToView = options.linkToView;\n\t\tthis.linkToDownload = options.linkToDownload;\n\t\tthis.downloadSizeValue = options.downloadSizeValue;\n\t\tthis.targetNode = options.targetNode;\n\t\tthis.userBoxNode = options.userBoxNode;\n\t\tthis.editorNode = options.editorNode;\n\t\tthis.editorWrapperNode = options.editorWrapperNode;\n\t\tthis.editButton = ButtonManager.createByUniqId(editorOptions.panelButtonUniqIds.edit);\n\t\tthis.setupSharingButton = ButtonManager.createByUniqId(editorOptions.panelButtonUniqIds.setupSharing);\n\t\tthis.sharingControlType = editorOptions.sharingControlType;\n\t\tthis.context = {\n\t\t\tcurrentUser: options.currentUser,\n\t\t\tdocumentSession: this.documentSession,\n\t\t\tobject: options.object,\n\t\t\tattachedObject: options.attachedObject,\n\t\t};\n\t\tthis.context.object.publicChannel = options.publicChannel;\n\t\tthis.usersInDocument = new UserManager({\n\t\t\tcontext: this.context,\n\t\t\tuserBoxNode: this.userBoxNode,\n\t\t});\n\t\tthis.sessionBoostButton = PromoBoostFactory.getSessionBoostButton(editorOptions.sessionBoostButtonContainerId);\n\t\tthis.sessionBoostOptions = options.sessionBoostOptions;\n\t\tthis.unifiedLinkAccessOnly = options.unifiedLinkAccessOnly;\n\t\tthis.promoShowImmediately = options.promoShowImmediately;\n\t\tthis.onlyOfficePromoActions = new OnlyOfficePromoActions();\n\t\tthis.realtimeForceReloadTag = options.realtimeForceReloadTag;\n\t\tthis.realtimeForceReloadCommand = options.realtimeForceReloadCommand;\n\t\tthis.autoForceReloadAfter = options.autoForceReloadAfter || 300_000; // default is 5 minutes in ms\n\t\tthis.texts = options.texts || {};\n\n\t\tthis.initializeEditor(options.editorJson);\n\n\t\tconst currentSlider = BX.SidePanel.Instance.getSliderByWindow(window);\n\t\tif (currentSlider)\n\t\t{\n\t\t\tcurrentSlider.getData().set('documentSession', this.documentSession);\n\t\t}\n\n\t\tthis.loadDiskExtensionInTopWindow();\n\n\t\tthis.initPull();\n\t\tthis.bindEvents();\n\t\tif (this.isEditMode())\n\t\t{\n\t\t\tthis.registerTimerToTrackWork();\n\t\t}\n\n\t\tif (this.promoShowImmediately && this.onlyOfficePromoActions.shouldShow())\n\t\t{\n\t\t\tthis.onlyOfficePromoActions.show(this.editButton.getMainButton().button, true);\n\t\t}\n\n\t\tif (PromoBoostChecker.isSessionBoostAvailable())\n\t\t{\n\t\t\tthis.sessionBoostButton.init();\n\t\t\tthis.sessionBoostButton.setOverlayToWidget();\n\n\t\t\tif (this.isEditMode() && this.sessionBoostOptions?.shouldShowButtonWidgetInstantly)\n\t\t\t{\n\t\t\t\tthis.showSessionBoostWidgetOnBoostButton();\n\t\t\t\tthis.saveWidgetOnBoostButtonView();\n\t\t\t}\n\t\t}\n\t}\n\n\tregisterTimerToTrackWork(): void\n\t{\n\t\tsetInterval(this.#trackWork.bind(this), SECONDS_TO_MARK_AS_STILL_WORKING * 1000);\n\t}\n\n\t#trackWork(): void\n\t{\n\t\tAjax.runComponentAction('bitrix:disk.file.editor-onlyoffice', 'markAsStillWorkingSession', {\n\t\t\tmode: 'ajax',\n\t\t\tjson: {\n\t\t\t\tdocumentSessionId: this.context.documentSession.id,\n\t\t\t\tdocumentSessionHash: this.context.documentSession.hash,\n\t\t\t},\n\t\t}).then(responce => {});\n\t}\n\n\tinitPull(): void\n\t{\n\t\tif (this.pullConfig)\n\t\t{\n\t\t\tBX.PULL = new PullClient({\n\t\t\t\tskipStorageInit: true,\n\t\t\t});\n\t\t\tBX.PULL.start(this.pullConfig);\n\t\t}\n\n\t\tif (this.pullUserConfig)\n\t\t{\n\t\t\tthis.userPullClient = new PullClient();\n\n\t\t\tthis.userPullClient.start(this.pullUserConfig);\n\t\t}\n\t}\n\n\tbindEvents(): void\n\t{\n\t\tEventEmitter.subscribe('SidePanel.Slider:onClose', this.handleSliderClose.bind(this));\n\t\tEventEmitter.subscribe(window, 'beforeunload', this.handleClose.bind(this));\n\n\t\tif (window.top !== window)\n\t\t{\n\t\t\tEventEmitter.subscribe(window, 'message', (event: MessageEvent) => {\n\t\t\t\tif (event.data === 'closeIframe')\n\t\t\t\t{\n\t\t\t\t\tthis.handleClose();\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\n\t\tif (this.editorJson.document.permissions.edit === true && this.editButton)\n\t\t{\n\t\t\tif (Object.prototype.hasOwnProperty.call(this.editButton, 'mainButton'))\n\t\t\t{\n\t\t\t\tthis.editButton.getMainButton().bindEvent('click', this.handleClickEditButton.bind(this));\n\n\t\t\t\tconst menuWindow = this.editButton.getMenuWindow();\n\t\t\t\tconst menuItems = Runtime.clone(menuWindow.getMenuItems());\n\n\t\t\t\tmenuItems.forEach((menuItem) => {\n\t\t\t\t\tconst menuItemOptions = Runtime.clone(menuItem.options);\n\t\t\t\t\tmenuItemOptions.onclick = this.handleClickEditSubItems.bind(this);\n\n\t\t\t\t\tmenuWindow.removeMenuItem(menuItem.getId());\n\t\t\t\t\tmenuWindow.addMenuItem(menuItemOptions);\n\t\t\t\t});\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tthis.editButton.bindEvent('click', this.handleClickEditButton.bind(this));\n\t\t\t}\n\t\t}\n\n\t\tif (this.setupSharingButton)\n\t\t{\n\t\t\tconst menuWindow = this.setupSharingButton.getMenuWindow();\n\t\t\tconst extLinkOptions = menuWindow.getMenuItem('ext-link').options;\n\t\t\textLinkOptions.onclick = this.handleClickSharingByExternalLink.bind(this);\n\n\t\t\tmenuWindow.removeMenuItem('ext-link');\n\t\t\tmenuWindow.addMenuItem(extLinkOptions);\n\n\t\t\tconst sharingOptions = menuWindow.getMenuItem('sharing').options;\n\t\t\tsharingOptions.onclick = this.handleClickSharing.bind(this);\n\n\t\t\tmenuWindow.removeMenuItem('sharing');\n\t\t\tmenuWindow.addMenuItem(sharingOptions);\n\t\t}\n\n\t\tPULL.subscribe(new ClientCommandHandler({\n\t\t\tonlyOffice: this,\n\t\t\tcontext: this.context,\n\t\t\tuserManager: this.usersInDocument,\n\t\t}));\n\t\tPULL.subscribe(new ServerCommandHandler({\n\t\t\tonlyOffice: this,\n\t\t\tcontext: this.context,\n\t\t\tuserManager: this.usersInDocument,\n\t\t}));\n\n\t\tif (this.userPullClient && this.realtimeForceReloadTag)\n\t\t{\n\t\t\tthis.userPullClient.extendWatch(this.realtimeForceReloadTag);\n\n\t\t\tthis.userPullClient.subscribe({\n\t\t\t\ttype: BX.PullClient.SubscriptionType.Server,\n\t\t\t\tmoduleId: 'disk',\n\t\t\t\tcommand: this.realtimeForceReloadCommand,\n\t\t\t\tcallback: data => {\n\t\t\t\t\tconst message = {\n\t\t\t\t\t\tregular: this.texts.forceReloadRegularServer,\n\t\t\t\t\t\tbooster: this.texts.forceReloadBoosterServer,\n\t\t\t\t\t}[data.newServersType] || this.texts.forceReloadUndefinedServer;\n\n\t\t\t\t\tconst mb = new MessageBox({\n\t\t\t\t\t\tmessage,\n\t\t\t\t\t\tmodal: true,\n\t\t\t\t\t\tonOk: () => location.reload(),\n\t\t\t\t\t\tokCaption: this.texts.forceReloadPopupOkButton,\n\t\t\t\t\t\tbuttons: MessageBoxButtons.OK,\n\t\t\t\t\t});\n\n\t\t\t\t\tmb.show();\n\n\t\t\t\t\tsetTimeout(() => {\n\t\t\t\t\t\tlocation.reload();\n\t\t\t\t\t}, this.autoForceReloadAfter);\n\t\t\t\t},\n\t\t\t});\n\t\t}\n\t}\n\n\tinitializeEditor(options: any): void\n\t{\n\t\tif (!options)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\toptions.events = {\n\t\t\t...options.events,\n\t\t\tonDocumentStateChange: this.handleDocumentStateChange.bind(this),\n\t\t\tonDocumentReady: this.handleDocumentReady.bind(this),\n\t\t\tonMetaChange: this.handleMetaChange.bind(this),\n\t\t\tonInfo: this.handleInfo.bind(this),\n\t\t\tonWarning: this.handleWarning.bind(this),\n\t\t\tonError: this.handleError.bind(this),\n\t\t\tonRequestClose: this.handleRequestClose.bind(this),\n\t\t};\n\n\t\tif (options.document?.permissions?.rename)\n\t\t{\n\t\t\toptions.events.onRequestRename = this.handleRequestRename.bind(this);\n\t\t}\n\n\t\tthis.editorJson = options;\n\t\tthis.editor = new DocsAPI.DocEditor(this.editorNode.id, options);\n\t}\n\n\tloadDiskExtensionInTopWindow(): void\n\t{\n\t\tif (window.top !== window && !BX.getClass('window.top.BX.Disk.endEditSession'))\n\t\t{\n\t\t\ttop.BX.loadExt('disk');\n\t\t}\n\t}\n\n\temitEventOnSaved(): void\n\t{\n\t\tconst sliderByWindow = BX.SidePanel.Instance.getSliderByWindow(window);\n\t\tif (sliderByWindow)\n\t\t{\n\t\t\tBX.SidePanel.Instance.postMessageAll(window, 'Disk.OnlyOffice:onSaved', {\n\t\t\t\tdocumentSession: this.documentSession,\n\t\t\t\tobject: this.context.object,\n\t\t\t});\n\t\t}\n\n\t\tEventEmitter.emit('Disk.OnlyOffice:onSaved', {\n\t\t\tdocumentSession: this.documentSession,\n\t\t\tobject: this.context.object,\n\t\t});\n\t}\n\n\temitEventOnClosed(): void\n\t{\n\t\tconst sliderByWindow = BX.SidePanel.Instance.getSliderByWindow(window);\n\t\tlet process = 'edit';\n\t\tif (sliderByWindow)\n\t\t{\n\t\t\tprocess = sliderByWindow.getData().get('process') || 'edit';\n\n\t\t\tBX.SidePanel.Instance.postMessageAll(window, 'Disk.OnlyOffice:onClosed', {\n\t\t\t\tdocumentSession: this.documentSession,\n\t\t\t\tobject: this.context.object,\n\t\t\t\tprocess: process,\n\t\t\t});\n\t\t}\n\n\t\tEventEmitter.emit('Disk.OnlyOffice:onClosed', {\n\t\t\tdocumentSession: this.documentSession,\n\t\t\tobject: this.context.object,\n\t\t\tprocess: process,\n\t\t});\n\t}\n\n\thandleClickEditButton(): void\n\t{\n\t\tif (this.onlyOfficePromoActions.shouldShow())\n\t\t{\n\t\t\tthis.onlyOfficePromoActions.show(this.editButton.getMainButton().button, true);\n\n\t\t\treturn;\n\t\t}\n\n\t\tthis.handleRequestEditRights();\n\t}\n\n\tshowSessionBoostWidgetOnBoostButton(): void\n\t{\n\t\tthis.sessionBoostButton.showWidget();\n\t}\n\n\tsaveWidgetOnBoostButtonView(): void\n\t{\n\t\tif (this.sessionBoostOptions !== null)\n\t\t{\n\t\t\tconst { category, name } = this.sessionBoostOptions.optionParamsToControlButtonWidgetDisplay;\n\t\t\tuserOptions.save(category, name, null, Math.floor(Date.now() / 1000));\n\t\t\tuserOptions.send(null);\n\t\t}\n\t}\n\n\thandleClickSharing(): void\n\t{\n\t\tswitch (this.sharingControlType)\n\t\t{\n\t\t\tcase SharingControlType.WITH_CHANGE_RIGHTS:\n\t\t\t\t(new LegacyPopup()).showSharingDetailWithChangeRights({\n\t\t\t\t\tobject: this.context.object,\n\t\t\t\t});\n\t\t\t\tbreak;\n\t\t\tcase SharingControlType.WITH_SHARING:\n\t\t\t\t(new LegacyPopup()).showSharingDetailWithChangeRights({\n\t\t\t\t\tobject: this.context.object,\n\t\t\t\t});\n\t\t\t\tbreak;\n\t\t\tcase SharingControlType.WITHOUT_EDIT:\n\t\t\t\t(new LegacyPopup()).showSharingDetailWithoutEdit({\n\t\t\t\t\tobject: this.context.object,\n\t\t\t\t});\n\t\t\t\tbreak;\n\t\t\tcase SharingControlType.BLOCKED_BY_FEATURE:\n\t\t\t\tBX.UI.InfoHelper.show('limit_office_files_access_permissions');\n\t\t\t\tbreak;\n\t\t\tdefault:\n\t\t\t\tconsole.warn('Unknown sharingControlType', this.sharingControlType);\n\t\t}\n\t}\n\n\thandleClickSharingByExternalLink(event, menuItem: MenuItem): void\n\t{\n\t\tif (menuItem.dataset.shouldBlockExternalLinkFeature)\n\t\t{\n\t\t\teval(menuItem.dataset.blockerExternalLinkFeature);\n\n\t\t\treturn;\n\t\t}\n\n\t\tif (this.unifiedLinkAccessOnly)\n\t\t{\n\t\t\tExternalLinkForUnifiedLink.showPopup(this.context.object.uniqueCode);\n\t\t}\n\t\telse\n\t\t{\n\t\t\tExternalLink.showPopup(this.context.object.id);\n\t\t}\n\t}\n\n\thandleClickEditSubItems(event, menuItem: MenuItem): void\n\t{\n\t\tconst serviceCode = menuItem.getId();\n\n\t\tif(serviceCode === 'onlyoffice')\n\t\t{\n\t\t\tthis.handleClickEditButton();\n\n\t\t\treturn;\n\t\t}\n\n\t\tBX.Disk.Viewer.Actions.runActionEdit({\n\t\t\tname: this.context.object.name,\n\t\t\tobjectId: this.context.object.id,\n\t\t\tattachedObjectId: this.context.attachedObject.id,\n\t\t\tserviceCode: serviceCode,\n\t\t});\n\t}\n\n\thandleSaveButtonClick(): void\n\t{\n\t\tPULL.subscribe({\n\t\t\tmoduleId: 'disk',\n\t\t\tcommand: 'onlyoffice',\n\t\t\tcallback: (data) => {\n\t\t\t\tif (data.hash === this.documentSession.hash)\n\t\t\t\t{\n\t\t\t\t\tthis.emitEventOnSaved();\n\n\t\t\t\t\twindow.BX.Disk.showModalWithStatusAction();\n\t\t\t\t\tBX.SidePanel.Instance.close();\n\t\t\t\t}\n\t\t\t},\n\t\t});\n\t}\n\n\thandleRequestClose(): void\n\t{\n\t\tconst currentSlider = BX.SidePanel.Instance.getSliderByWindow(window);\n\t\tif (!currentSlider)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tcurrentSlider.getData().set('dontInvokeRequestClose', true);\n\t\tthis.handleClose();\n\t\tcurrentSlider.close();\n\t}\n\n\tisDocumentReadyToEdit(): boolean\n\t{\n\t\tif (this.brokenDocumentOpened)\n\t\t{\n\t\t\treturn false;\n\t\t}\n\n\t\tif (!this.caughtDocumentReady)\n\t\t{\n\t\t\treturn false;\n\t\t}\n\n\t\treturn true;\n\t}\n\n\thandleSliderClose(event: BaseEvent): void\n\t{\n\t\tconst currentSlider = BX.SidePanel.Instance.getSliderByWindow(window);\n\t\tif (!currentSlider)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tconst currentSliderData = currentSlider.getData();\n\t\tconst uid = currentSliderData.get('uid');\n\n\t\t/** @type {BX.SidePanel.Event} */\n\t\tconst [sliderEvent] = event.getData();\n\t\tif (sliderEvent.getSlider().getData().get('uid') !== uid)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tif (this.isViewMode() || !this.isDocumentReadyToEdit())\n\t\t{\n\t\t\tthis.handleClose();\n\n\t\t\treturn;\n\t\t}\n\n\t\tif (this.editor.hasOwnProperty('requestClose'))\n\t\t{\n\t\t\tif (currentSliderData.get('dontInvokeRequestClose'))\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tthis.editor.requestClose();\n\t\t\tsliderEvent.denyAction();\n\t\t}\n\t\telse\n\t\t{\n\t\t\tthis.handleClose();\n\t\t}\n\t}\n\n\thandleClose(): void\n\t{\n\t\tPULL.sendMessageToChannels([this.context.object.publicChannel], 'disk', 'exitDocument', {\n\t\t\tfromUserId: this.context.currentUser.id,\n\t\t});\n\n\t\tthis.emitEventOnClosed();\n\n\t\tif (this.dontEndCurrentDocumentSession)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\ttop.BX.Disk.endEditSession({\n\t\t\tid: this.documentSession.id,\n\t\t\thash: this.documentSession.hash,\n\t\t\tdocumentWasChanged: this.documentWasChanged,\n\t\t});\n\t}\n\n\thandleDocumentStateChange(event): void\n\t{\n\t\tif (!this.caughtDocumentReady || !this.caughtInfoEvent)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tif (Date.now() - Math.max(this.caughtDocumentReady, this.caughtInfoEvent) < 500)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tthis.documentWasChanged = true;\n\t}\n\n\twasDocumentChanged(): boolean\n\t{\n\t\treturn this.documentWasChanged;\n\t}\n\n\tisEditMode(): boolean\n\t{\n\t\treturn this.editorJson.editorConfig.mode === 'edit';\n\t}\n\n\tisViewMode(): boolean\n\t{\n\t\treturn !this.isEditMode();\n\t}\n\n\treloadView(): void\n\t{\n\t\tif (this.isViewMode())\n\t\t{\n\t\t\tdocument.location = this.linkToView;\n\t\t}\n\t}\n\n\thandleInfo(): void\n\t{\n\t\tthis.caughtInfoEvent = Date.now();\n\t}\n\n\thandleWarning(d): void\n\t{\n\t\tconsole.log('onlyoffice warning:', d.data);\n\t}\n\n\thandleError(d): void\n\t{\n\t\tconsole.log('onlyoffice error:', d.data);\n\n\t\tif (d.data.errorCode === -82)\n\t\t{\n\t\t\tthis.brokenDocumentOpened = true;\n\t\t\tthis.processBrokenDocument();\n\t\t}\n\t\telse if (d.data.errorCode === -84)\n\t\t{\n\t\t\tsetTimeout(() => {\n\t\t\t\t(new CustomErrorControl()).showWhenTooLarge(\n\t\t\t\t\tthis.context.object.name,\n\t\t\t\t\tthis.getEditorWrapperNode(),\n\t\t\t\t\tthis.getContainer(),\n\t\t\t\t\tthis.linkToDownload,\n\t\t\t\t\tthis.downloadSizeValue,\n\t\t\t\t);\n\t\t\t}, 100);\n\t\t}\n\t}\n\n\tprocessBrokenDocument(): void\n\t{\n\t\tif (!this.context.documentSession.id || !this.brokenDocumentOpened)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tconst key = `oo_broken_doc_${this.context.documentSession.id}`;\n\t\tconst lastTime = cache.get(key);\n\t\tif (lastTime && Date.now() - lastTime < 1000 * 60)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tAjax.runAction('disk.api.onlyoffice.recoverSessionWithBrokenFile', {\n\t\t\tmode: 'ajax',\n\t\t\tjson: {\n\t\t\t\tforce: true,\n\t\t\t\tsessionId: this.documentSession.id,\n\t\t\t\tdocumentSessionHash: this.documentSession.hash,\n\t\t\t},\n\t\t}).then((response) => {\n\t\t\tif (response.status === 'success')\n\t\t\t{\n\t\t\t\tdocument.location.href = response.data.link;\n\t\t\t}\n\t\t});\n\n\t\tcache.set(key, Date.now());\n\t}\n\n\thandleRequestRename(event): void\n\t{\n\t\tconst newName = event.data;\n\t\tAjax.runAction('disk.api.onlyoffice.renameDocument', {\n\t\t\tmode: 'ajax',\n\t\t\tjson: {\n\t\t\t\tdocumentSessionId: this.context.documentSession.id,\n\t\t\t\tdocumentSessionHash: this.context.documentSession.hash,\n\t\t\t\tnewName: newName,\n\t\t\t},\n\t\t});\n\t}\n\n\thandleMetaChange(event): void\n\t{}\n\n\thandleDocumentReady(): void\n\t{\n\t\tthis.caughtDocumentReady = Date.now();\n\t}\n\n\thandleRequestEditRights(): void\n\t{\n\t\tthis.dontEndCurrentDocumentSession = true;\n\n\t\tlet linkToEdit = BX.util.add_url_param(\n\t\t\t'/bitrix/services/main/ajax.php',\n\t\t\t{\n\t\t\t\taction: 'disk.api.documentService.goToEdit',\n\t\t\t\tserviceCode: 'onlyoffice',\n\t\t\t\tdocumentSessionId: this.documentSession.id,\n\t\t\t\tdocumentSessionHash: this.documentSession.hash,\n\t\t\t},\n\t\t);\n\n\t\tif (this.linkToEdit)\n\t\t{\n\t\t\tlinkToEdit = this.linkToEdit;\n\t\t}\n\n\t\tconst currentSlider = BX.SidePanel.Instance.getSliderByWindow(window);\n\t\tif (!currentSlider)\n\t\t{\n\t\t\twindow.location = linkToEdit;\n\n\t\t\treturn;\n\t\t}\n\n\t\tlet customLeftBoundary = currentSlider.getCustomLeftBoundary();\n\t\tcurrentSlider.close();\n\n\t\tBX.SidePanel.Instance.open(\n\t\t\tlinkToEdit, {\n\t\t\t\twidth: '100%',\n\t\t\t\tcustomLeftBoundary: customLeftBoundary,\n\t\t\t\tcacheable: false,\n\t\t\t\tallowChangeHistory: false,\n\t\t\t\tdata: {\n\t\t\t\t\tdocumentEditor: true,\n\t\t\t\t},\n\t\t\t});\n\t}\n\n\tgetEditor()\n\t{\n\t\treturn this.editor;\n\t}\n\n\tgetEditorNode(): HTMLElement\n\t{\n\t\treturn this.editorNode;\n\t}\n\n\tgetEditorWrapperNode(): HTMLElement\n\t{\n\t\treturn this.editorWrapperNode;\n\t}\n\n\tgetContainer(): HTMLElement\n\t{\n\t\treturn this.targetNode;\n\t}\n}\n","import {ajax as Ajax, Type} from \"main.core\";\nimport {PULL} from \"pull.client\";\nimport type {WaitingOptions, DocumentSession, BaseObject} from \"./types\";\n\nexport default class Waiting\n{\n\tdocumentSession: DocumentSession = null;\n\tobject: BaseObject = null;\n\tunifiedLinkMode: boolean = false;\n\n\tconstructor(waitingOptions: WaitingOptions)\n\t{\n\t\tconst options = Type.isPlainObject(waitingOptions) ? waitingOptions : {};\n\n\t\tthis.documentSession = options.documentSession;\n\t\tthis.object = options.object;\n\n\t\tthis.unifiedLinkMode = options.unifiedLinkMode;\n\n\t\tconst loader = new BX.Loader({\n\t\t\ttarget: options.targetNode,\n\t\t});\n\t\tloader.show();\n\n\t\tthis.bindEvents();\n\n\t\tthis.handleSavedDocument({});\n\t}\n\n\tbindEvents(): void\n\t{\n\t\tPULL.subscribe({\n\t\t\ttype: BX.PullClient.SubscriptionType.Server,\n\t\t\tmoduleId: 'disk',\n\t\t\tcommand: 'onlyoffice',\n\t\t\tcallback: this.handleSavedDocument.bind(this),\n\t\t});\n\t}\n\n\thandleSavedDocument(data): void\n\t{\n\t\tconsole.log('handleSavedDocument', data);\n\n\t\tAjax.runAction('disk.api.onlyoffice.continueWithNewSession', {\n\t\t\tmode: 'ajax',\n\t\t\tjson: {\n\t\t\t\tsessionId: this.documentSession.id,\n\t\t\t\tdocumentSessionHash: this.documentSession.hash,\n\t\t\t},\n\t\t}).then((response) => {\n\t\t\tif (response.status === 'success')\n\t\t\t{\n\t\t\t\tif (this.unifiedLinkMode)\n\t\t\t\t{\n\t\t\t\t\twindow.location.reload();\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\tdocument.location.href = response.data.documentSession.link;\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\t}\n}\n"],"names":["ALLOWED_ATTEMPTS_TO_GET_USER_INFO","SECONDS_TO_ACTUALIZE_ONLINE","UserManager","options","users","BX","Disk","Users","badAttempts","Map","context","userBoxNode","alreadySaidHi","add","currentUser","bindEvents","EventEmitter","subscribe","event","getData","handleWhenPullConnected","sentGreetings","sendHiToUsers","setInterval","actualizeOnline","bind","refineUsersByOnline","sendPingToUsers","PULL","isConnected","sendMessageToChannels","object","publicChannel","user","id","name","avatar","fromUserId","infoToken","hasUser","addUser","console","log","updateOnline","renderBox","userId","getUser","onlineAt","Date","now","get","Promise","resolve","reject","status","Ajax","runComponentAction","mode","json","documentSessionId","documentSession","documentSessionHash","hash","then","response","data","attempts","set","deleteUser","secondsToOffline","forEach","remove","childElementCount","appendChild","getContainer","link","includes","document","location","origin","BaseCommandHandler","commandOptions","userManager","onlyOffice","PullClient","SubscriptionType","Server","handler","ClientCommandHandler","Client","exitDocument","handleExitDocument","pingDocument","handlePingDocument","hiToDocument","handleHiToDocument","welcomeToDocument","handleWelcomeToDocument","isCurrentUser","processNewbieInDocument","newbieAdded","sendWelcomeToUser","has","getUserInfo","userData","ServerCommandHandler","_classPrivateMethodInitSpec","onlyoffice","filterCurrentObject","handleSavedDocument","contentUpdated","handleContentUpdated","documentSessionInfo","wasFinallySaved","UI","Notification","Center","notify","autoHide","content","Loc","getMessage","updatedBy","wasDocumentChanged","Text","encode","isViewMode","Tag","render","refreshButton","querySelector","style","addEventListener","_classPrivateMethodGet","reloadView","CustomErrorControl","fileName","container","targetNode","linkToDownload","downloadSizeValue","showCommonWarning","title","description","containerClass","fileNameNode","downloadButtonNode","downloadSize","downloadButton","Button","text","round","noCaps","tag","LINK","color","AirButtonStyle","FILLED","className","icon","ButtonIcon","DOWNLOAD","iconPosition","size","ButtonSize","LARGE","props","target","setText","errorControl","Dom","addClass","prepend","SECONDS_TO_MARK_AS_STILL_WORKING","cache","LocalStorageCache","OnlyOffice","editorOptions","Type","isPlainObject","pullConfig","pullUserConfig","linkToEdit","linkToView","editorNode","editorWrapperNode","editButton","ButtonManager","createByUniqId","panelButtonUniqIds","edit","setupSharingButton","setupSharing","sharingControlType","attachedObject","usersInDocument","sessionBoostButton","PromoBoostFactory","getSessionBoostButton","sessionBoostButtonContainerId","sessionBoostOptions","unifiedLinkAccessOnly","promoShowImmediately","onlyOfficePromoActions","OnlyOfficePromoActions","realtimeForceReloadTag","realtimeForceReloadCommand","autoForceReloadAfter","texts","initializeEditor","editorJson","currentSlider","SidePanel","Instance","getSliderByWindow","window","loadDiskExtensionInTopWindow","initPull","isEditMode","registerTimerToTrackWork","shouldShow","show","getMainButton","button","PromoBoostChecker","isSessionBoostAvailable","init","setOverlayToWidget","shouldShowButtonWidgetInstantly","showSessionBoostWidgetOnBoostButton","saveWidgetOnBoostButtonView","skipStorageInit","start","userPullClient","handleSliderClose","handleClose","top","permissions","Object","prototype","hasOwnProperty","call","bindEvent","handleClickEditButton","menuWindow","getMenuWindow","menuItems","Runtime","clone","getMenuItems","menuItem","menuItemOptions","onclick","handleClickEditSubItems","removeMenuItem","getId","addMenuItem","extLinkOptions","getMenuItem","handleClickSharingByExternalLink","sharingOptions","handleClickSharing","extendWatch","type","moduleId","command","callback","message","regular","forceReloadRegularServer","booster","forceReloadBoosterServer","newServersType","forceReloadUndefinedServer","mb","MessageBox","modal","onOk","reload","okCaption","forceReloadPopupOkButton","buttons","MessageBoxButtons","OK","setTimeout","events","onDocumentStateChange","handleDocumentStateChange","onDocumentReady","handleDocumentReady","onMetaChange","handleMetaChange","onInfo","handleInfo","onWarning","handleWarning","onError","handleError","onRequestClose","handleRequestClose","rename","onRequestRename","handleRequestRename","editor","DocsAPI","DocEditor","getClass","loadExt","sliderByWindow","postMessageAll","emit","process","handleRequestEditRights","showWidget","optionParamsToControlButtonWidgetDisplay","category","userOptions","save","Math","floor","send","SharingControlType","WITH_CHANGE_RIGHTS","LegacyPopup","showSharingDetailWithChangeRights","WITH_SHARING","WITHOUT_EDIT","showSharingDetailWithoutEdit","BLOCKED_BY_FEATURE","InfoHelper","warn","dataset","shouldBlockExternalLinkFeature","eval","blockerExternalLinkFeature","ExternalLinkForUnifiedLink","showPopup","uniqueCode","ExternalLink","serviceCode","Viewer","Actions","runActionEdit","objectId","attachedObjectId","emitEventOnSaved","showModalWithStatusAction","close","brokenDocumentOpened","caughtDocumentReady","currentSliderData","uid","sliderEvent","getSlider","isDocumentReadyToEdit","requestClose","denyAction","emitEventOnClosed","dontEndCurrentDocumentSession","endEditSession","documentWasChanged","caughtInfoEvent","max","editorConfig","d","errorCode","processBrokenDocument","showWhenTooLarge","getEditorWrapperNode","key","lastTime","runAction","force","sessionId","href","newName","util","add_url_param","action","customLeftBoundary","getCustomLeftBoundary","open","width","cacheable","allowChangeHistory","documentEditor","responce","Waiting","waitingOptions","unifiedLinkMode","loader","Loader"],"mappings":"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"}