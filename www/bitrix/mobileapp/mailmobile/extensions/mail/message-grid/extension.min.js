jn.define("mail/message-grid",((e,t,s)=>{const{mailsAddedFromServer:i,mailsUpsertedFromServer:a,setMultiSelectMode:n,setTaskId:o}=e("mail/statemanager/redux/slices/messages");const{selectEntities:l,selectIsMultiSelectMode:r}=e("mail/statemanager/redux/slices/messages/selector");const{observeMailboxesChange:d}=e("mail/statemanager/redux/slices/mailboxes/observers/stateful-list");const{observeFoldersChange:u}=e("mail/statemanager/redux/slices/folders/observers/stateful-list");const{observeListChange:h}=e("mail/statemanager/redux/slices/messages/observers/stateful-list");const{selectCurrentFolder:c,selectByType:g,selectCurrentFolderCounter:m}=e("mail/statemanager/redux/slices/folders/selector");const{selectStartEmailSender:M,selectCurrentMailbox:f}=e("mail/statemanager/redux/slices/mailboxes/selector");const{MessageModel:S}=e("mail/statemanager/redux/slices/messages/model/message");const{setCurrentMailbox:p}=e("mail/statemanager/redux/slices/mailboxes");const{Selector:b}=e("mail/folder/selector");const{stringToColor:I}=e("mail/message/elements/avatar");const{foldersAdded:E,foldersUpserted:L,clearFolders:T,setCurrentFolder:C}=e("mail/statemanager/redux/slices/folders");const{syncMailbox:_}=e("mail/statemanager/redux/slices/mailboxes/thunk");const{batchActions:B}=e("statemanager/redux/batched-actions");const v=e("statemanager/redux/store");const{dispatch:A}=v;const{MessageGridSorting:F,MessageGridMoreMenu:R,MessageGridMultiSelectMenu:y,MessageGridGroupActionsMenu:x}=e("mail/message-grid/navigation");const{ListItemType:O,ListItemsFactory:w}=e("mail/simple-list/items");const{DefaultFolderType:k}=e("mail/enum/default-folder-type");const{updateMailboxList:G}=e("mail/mailbox/selector");const{MailOpener:D}=e("mail/opener");const{AjaxMethod:W}=e("mail/const");const{StatusBlock:P,makeLibraryImagePath:V}=e("ui-system/blocks/status-block");const{StatefulList:U}=e("layout/ui/stateful-list");const{SearchLayout:N}=e("layout/ui/search-bar");const{Box:H}=e("ui-system/layout/box");const{MobileFeature:j}=e("im/messenger/lib/feature");const{BottomPanel:X}=e("native/bottom-panel");const{Color:Y}=e("tokens");const{Type:z}=e("type");const{Loc:K}=e("loc");const q="all_income";const J="unread";const Q="sent";const Z=50;const $=20;class ee extends LayoutComponent{static#e=null;static#t=null;constructor(e){super(e);this.mailboxes=this.props.mailboxes;this.showFloatingButton=false;this.markAsRemovedMails=new Set;this.parentWidget=e.layout;this.stateFulListRef=null;const t=e.mailboxId??0;this.parentWidget.setBackButtonHandler(this.#s);this.sorting=new F({type:F.types.RECEIVE_DATE,fallbackType:F.types.ID,isASC:false});this.moreMenu=new R({selectedSorting:this.sorting.getType(),isASC:this.sorting.getIsASC()});this.search=new N({layout:this.parentWidget,disablePresets:true,onSearch:this.#i,onCancel:this.#i});if(j.isNativeBottomPanelApiSupported()){this.panel=new X;this.actionMenu=new x({parentWidget:this.parentWidget,panel:this.panel});this.panel.setComponent(this.actionMenu)}else{this.parentWidget.setLeftButtons(this.leftMenuButtons);this.multiSelectMenu=new y({parentWidget:this.parentWidget})}this.folderSelector=new b({parentWidget:this.parentWidget});this.filter={tabId:q};if(t!==0){this.filter.mailboxId=Number(t)}BX.addCustomEvent("Mail.Binding::bindingSent",(()=>{this.stateFulListRef?.reload({skipUseCache:true})}));BX.addCustomEvent("Mail.Mailbox::significantChangesInStructure",(e=>{this.newMailboxWasConnected(e)}));BX.addCustomEvent("Mail.Mailbox::significantChangesInStructure",(e=>{this.newMailboxWasConnected(e)}))}static#a(){return Math.floor(Date.now()/1e3)}static#n(e){this.#e=e;return this.#o().setNumber("ttl",e)}static#l(e=$){const t=this.getTtlValue();const s=this.#a();return s>t+e}static#r(){this.#n(this.#a())}static getTtlValue(){if(this.#e===null){this.#e=this.#o().getNumber("ttl",0)}return this.#e}static#o(){if(!this.#t){this.#t=Application.storageById("MailMessageGrid")}return this.#t}componentDidMount(){G((()=>{}),this.mailboxes);this.parentWidget.on("removed",this.#d);this.parentWidget.on("hidden",this.#d);this.parentWidget.on("titleClick",this.openFolderMenu);this.unsubscribeMailboxesObserver=d(v,this.onVisibleMailboxesChange);this.unsubscribeMailsObserver=h(v,this.onVisibleMailsChange);this.unsubscribeFoldersObserver=u(v,this.onVisibleFoldersChange);this.parentWidget.setTitle({text:K.getMessage("MAILMOBILE_MESSAGE_GRID_TITLE"),type:"section"});BX.PULL.subscribe({moduleId:"tasks",command:"task_add",callback:this.#u})}changeShowFloatingButtonStatus(e){if(this.showFloatingButton!==e){this.showFloatingButton=e;this.stateFulListRef?.updateFloatingButton({hide:!e});this.setState({})}}componentWillUnmount(){this.parentWidget.off("removed",this.#d);this.parentWidget.off("onViewHidden",this.#d);this.parentWidget.off("titleClick",this.openFolderMenu);if(this.unsubscribeMailboxesObserver){this.unsubscribeMailboxesObserver()}if(this.unsubscribeMailsObserver){this.unsubscribeMailsObserver()}if(this.unsubscribeFoldersObserver){this.unsubscribeFoldersObserver()}}render(){return H({resizableByKeyboard:true,backgroundColor:Y.bgPrimary},View({style:{flex:1}},this.renderTabs(),this.renderList()))}renderTabs(){return TabView({ref:this.onTabsRef,style:{height:51},params:{items:[{title:K.getMessage("MAILMOBILE_MESSAGE_GRID_TAB_TITLE_ALL"),id:q},{title:K.getMessage("MAILMOBILE_MESSAGE_GRID_TAB_TITLE_UNREAD"),id:J},{title:K.getMessage("MAILMOBILE_MESSAGE_GRID_TAB_TITLE_SENT"),id:Q}]},onTabSelected:this.#h})}openMessageChain(e,t){ComponentHelper.openLayout({name:"mail:mail.message.view",object:"layout",widgetParams:{title:K.getMessage("MAILMOBILE_MESSAGE_MESSAGE_CHAIN_TITLE")},componentParams:{threadId:e,isCrmMessage:0,startEmailSender:t}})}renderList(){return new U({isFloatingButtonAccent:true,layout:this.parentWidget,ref:this.onListRef,testId:"message-grid",useCache:false,needInitMenu:true,showAirStyle:false,isShowFloatingButton:this.showFloatingButton,onListReloaded:this.onListReloaded,onFloatingButtonClick:this.#c,sortingConfig:this.sorting.getSortingConfig(),onBeforeItemsSetState:this.onBeforeItemsSetState,getEmptyListComponent:this.renderEmptyListComponent,menuButtons:this.rightMenuButtons,itemFactory:w,itemDetailOpenHandler:this.openMessageChain,itemType:O.MESSAGE,itemsLoadLimit:Z,actions:{loadItems:W.mailGetList},actionParams:this.actionParams,actionCallbacks:{loadItems:this.#g}})}renderEmptyListComponent(){return P({image:Image({uri:V("empty-folder-grid-full.png","empty-states","mail"),style:{width:146,height:137}}),testId:"empty-state-message-grid",description:K.getMessage("MAILMOBILE_MESSAGE_GRID_EMPTY_STATE_DESCRIPTION_EMPTY_FOLDER"),emptyScreen:false,onRefresh:()=>{}})}get actionParams(){return{loadItems:{filterParams:this.filter}}}openFolderMenu=()=>{this.parentWidget.openWidget("layout",{...b.FOLDER_LAYOUT_PROPERTIES,onReady:e=>{e.showComponent(new b({parentWidget:this.parentWidget,layoutWidget:e}))}},this.parentWidget)};get rightMenuButtons(){return[this.search.getSearchButton(),this.folderSelector.getMenuButton(this.openFolderMenu),this.moreMenu.getMenuButton()]}get leftMenuButtons(){return[]}onBeforeItemsSetState=e=>{const t=l(v.getState());const s=e.map((e=>S.prepareReduxMailFromServer(e)));return s.filter((({id:e})=>{const{isRemoved:s}=t[e]||{};return z.isNil(s)||!s}))};onVisibleMailboxesChange=({selected:e,removed:t})=>{if(e!==null&&e!==undefined){console.log("onVisibleMailboxesChange",e);this.tabViewRef.setActiveItem(q);this.filter.folderPath=null;this.filter.mailboxId=Number(e.id);A(T());this.setState({},(()=>this.stateFulListRef.reload({skipUseCache:true})));this.updateMultiSelectModeTitle(true)}};onVisibleMailsChange=({moved:e,removed:t,added:s,created:i,multiSelectMode:a,selectedIds:n})=>{if(!this.stateFulListRef||this.stateFulListRef.isLoading()){setTimeout((()=>{this.onVisibleMailsChange({moved:e,removed:t,added:s,created:i,multiSelectMode:a,selectedIds:n})}),30);return}if(a.changed){this.toggleMultiSelectModeHeader(a.previous);const e=this.stateFulListRef.getItems();this.stateFulListRef.updateItemsData(e)}if(n.changed&&!a.changed){this.updateMultiSelectModeTitle(!a.current)}if(t.length>0){void this.removeMails(t)}if(s.length>0){void this.addOrRestoreMails(s)}if(e.length>0){void this.updateMails(e)}};onVisibleFoldersChange=({moved:e,removed:t,added:s,created:i,selected:a})=>{if(!this.stateFulListRef||this.stateFulListRef.isLoading()){setTimeout((()=>{this.onVisibleFoldersChange({moved:e,removed:t,added:s,created:i,selected:a})}),30);return}if(a!==null){this.updateCurrentFolder(a)}else{this.updateMultiSelectModeTitle(true)}};updateCurrentFolder(e){const t=r(v.getState());if(t){A(n({isMultiSelectMode:false}))}else{this.toggleMultiSelectModeHeader(true)}this.#m(e)}toggleMultiSelectModeHeader(e){let t=[];if(j.isNativeBottomPanelApiSupported()){if(e){this.changeShowFloatingButtonStatus(true);this.panel.hide()}else{this.changeShowFloatingButtonStatus(false);this.panel.show()}t=e?this.rightMenuButtons:[this.actionMenu.getCancelButton()]}else{const s=e?this.leftMenuButtons:[this.multiSelectMenu.getChanelButton()];t=e?this.rightMenuButtons:[this.multiSelectMenu.getMenuButton()];this.parentWidget.setLeftButtons(s)}this.updateMultiSelectModeTitle(e);this.parentWidget.setRightButtons(t)}updateMultiSelectModeTitle(e){let t={};const s=c(v.getState());const i=f(v.getState());const a=m(v.getState());const n=Number(a)>0?String(a):null;if(j.isNativeBottomPanelApiSupported()){t={text:s?.name??K.getMessage("MAILMOBILE_MESSAGE_GRID_TITLE"),detailText:n,type:"section",avatar:{title:i.userName,backgroundColor:I(i.email),placeholder:{backgroundColor:I(i.email)},hideOutline:true}}}else{t={text:e?s?.name??K.getMessage("MAILMOBILE_MESSAGE_GRID_TITLE"):this.prepareMultiSelectModeTitle(),detailText:e?n:null,avatar:e?{title:i.userName,backgroundColor:I(i.email),placeholder:{backgroundColor:I(i.email)},hideOutline:true}:null,type:e?"section":"wizard"}}this.parentWidget.setTitle(t)}prepareMultiSelectModeTitle(){const e=v.getState();const t=l(e);const s=Object.values(t).filter((({isSelected:e})=>e)).length;if(s===0){return K.getMessage("MAILMOBILE_MESSAGE_GRID_MULTISELECT_MODE_TITLE_1",{"#COUNT#":s})}const i=e=>{const t=e%10;const s=e%100;if(s>=11&&s<=14){return"MAILMOBILE_MESSAGE_GRID_MULTISELECT_MODE_TITLE_1"}if(t===1){return"MAILMOBILE_MESSAGE_GRID_MULTISELECT_MODE_TITLE_2"}if(t>=2&&t<=4){return"MAILMOBILE_MESSAGE_GRID_MULTISELECT_MODE_TITLE_5"}return"MAILMOBILE_MESSAGE_GRID_MULTISELECT_MODE_TITLE_1"};return K.getMessage(i(s),{"#COUNT#":s})}removeMails(e){if(e.length>0){const t=e.map((({id:e})=>e));const s=e.filter((e=>e.isRemoved)).map((({id:e})=>e));if(s.length>0){s.forEach((e=>this.markAsRemovedMails.add(e)))}return this.stateFulListRef.deleteItem(t)}return Promise.resolve()}updateMails(e){this.stateFulListRef.updateItemsData(e)}async addOrRestoreMails(e){const t=[];const s=[];e.forEach((e=>{if(this.markAsRemovedMails.has(e.id)){t.push(e)}else if(!this.stateFulListRef.hasItem(e.id)){s.push(e)}}));if(t.length>0){await this.stateFulListRef.updateItemsData(t)}if(s.length>0){await this.stateFulListRef.updateItemsData(s)}e.forEach((({id:e})=>this.markAsRemovedMails.delete(e)))}newMailboxWasConnected(e){G((()=>{A(p({mailboxId:e}))}))}#d=()=>{A(n({isMultiSelectMode:false}));this.panel.hide()};#s=()=>{const e=r(v.getState());if(e){A(n({isMultiSelectMode:false}));return true}return false};#g=(e,t)=>{const{items:s=[],dirs:n=[],currentMailboxId:o=0,mailboxIsNotAvailable:l=false,currentFolderPath:r="",startEmailSender:d=null}=e||{};if(!l){this.changeShowFloatingButtonStatus(true)}const u=t==="cache";const h=[];if(n&&n.length>0){h.push(u?E(n):L(n))}if(s&&s.length>0){h.push(u?i(s):a(s))}if(Number(o)>0){h.push(p({mailboxId:Number(o),startEmailSender:d}))}if(r!==""){this.filter.folderPath=r;h.push(C({folderPath:r}))}if(h.length>0){A(B(h))}if(ee.#l()&&o>0){A(_({mailboxId:o}));ee.#r()}};#m=e=>{if(e.type===k.OUTCOME.value){this.tabViewRef.setActiveItem(Q)}else if(this.filter.tabId!==J){this.tabViewRef.setActiveItem(q)}this.filter.folderPath=e.path;this.setState({},(()=>this.stateFulListRef.reload({skipUseCache:true})))};#h=e=>{const t=c(v.getState());if(e.id===J&&t&&t.type===k.OUTCOME.value){const e=g(v.getState(),k.DEFAULT.value);if(e!==null){this.filter.tabId=J;A(C({folderPath:e.path}));return}}if(e.id===Q){const e=g(v.getState(),k.OUTCOME.value);if(e!==null){this.filter.tabId=q;A(C({folderPath:e.path}))}}else if(t&&t.type===k.OUTCOME.value&&e.id===q){const e=g(v.getState(),k.DEFAULT.value);if(e!==null){A(C({folderPath:e.path}))}}else{this.filter.tabId=e.id;this.setState({},(()=>this.stateFulListRef.reload({skipUseCache:true})))}};#i=({text:e})=>{this.filter.searchString=e??"";this.setState({},(()=>this.stateFulListRef.reload({skipUseCache:true})))};#u=e=>{const t=Number(e?.AFTER?.UF_MAIL_MESSAGE);const s=Number(e?.TASK_ID);if(t&&s){A(o({objectId:t,taskId:s}))}};#c=()=>{D.openSend({isCrmMessage:false,startEmailSender:M(v.getState())})};onListReloaded=e=>{if(r(v.getState())){A(n({isMultiSelectMode:false}))}if(!e){this.markAsRemovedMails?.clear()}};onListRef=e=>{this.stateFulListRef=e};onTabsRef=e=>{this.tabViewRef=e}}s.exports={MessageGrid:ee}}));
//# sourceMappingURL=extension.map.js