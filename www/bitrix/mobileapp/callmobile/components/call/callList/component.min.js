(()=>{const t=t=>jn.require(t);const{LoaderItem:e}=t("im/messenger/lib/ui/base/loader");const{parseStatusTime:s,restCall:a}=t("call/callList/utils");const{Tabs:i}=t("call/callList/tabs");const{ListView:l}=t("call/callList/listView");const{DialogOpener:n}=t("im/messenger/api/dialog-opener");const{openFastCallView:o}=t("call/callList/fastCallView");const{CallLogType:r}=t("call/const");const{EmptyView:c}=t("call/callList/emptyView");const{SearchController:h}=t("call/callList/searchController");const{Icon:u}=t("ui-system/blocks/icon");const d=BX.componentParameters.get("SITE_ID","s1");const m=BX.componentParameters.get("IS_CREATE_CALL_BUTTON_ENABLED",false);const I=40;const p="CALL_LIST";const S="call_list";const C=Object.freeze({ALL:"all",MISSED:r.Status.MISSED,INCOMING:r.Type.INCOMING,OUTGOING:r.Type.OUTGOING});const T=Object.freeze({[C.ALL]:{title:BX.message("MOBILEAPP_EMPTY_TAB_MAIN_TITLE"),description:BX.message("MOBILEAPP_EMPTY_TAB_MAIN_DESCRIPTION")},[C.MISSED]:{title:BX.message("MOBILEAPP_EMPTY_TAB_MISSED")},[C.INCOMING]:{title:BX.message("MOBILEAPP_EMPTY_TAB_INCOMING")},[C.OUTGOING]:{title:BX.message("MOBILEAPP_EMPTY_TAB_OUTGOING")}});const f=Object.freeze({[C.MISSED]:{STATUS:r.Status.MISSED},[C.INCOMING]:{STATUS:r.Status.ANSWERED},[C.OUTGOING]:{TYPE:r.Type.OUTGOING},[C.ALL]:{}});class g extends LayoutComponent{constructor(t){super(t);this.state={allItems:[],tabItems:[],selectedScopeId:C.ALL,missedCount:0,isReady:false,isRefreshing:false,isTestOk:false,searchQuery:"",isSearchMode:false,searchItems:[]};this.isFetching=false;this.hasMore=true;this.lastId=0;this.unsubscribeFromPull=null;this.loader=new e({enable:true,text:BX.message("MOBILEAPP_LOADING_TEXT")});this.searchController=new h(this);BX.addCustomEvent("onUpdateUserCounters",this.onUpdateUserCounters.bind(this));BX.addCustomEvent("onTabsSelected",this.onTabsSelected.bind(this));BX.addCustomEvent("onTabsReSelected",this.onTabsReSelected.bind(this));BX.addCustomEvent("onAppActive",this.onAppActive.bind(this));this.pullSubscribe();this.fetchList(true)}componentDidMount(){this.isMountedFlag=true;this.searchController.setupSearch();this.initFloatingButton()}initFloatingButton(){if(!layout?.setFloatingButton||!m){return}layout.setFloatingButton({type:"plus",callback:()=>{o(layout)},icon:u.PLUS.getIconName(),animation:"hide_on_scroll",showLoader:false,accentByDefault:false})}componentWillUnmount(){if(this.unsubscribeFromPull){this.unsubscribeFromPull();this.unsubscribeFromPull=null}BX.removeCustomEvent("onUpdateUserCounters",this.onUpdateUserCounters.bind(this));BX.removeCustomEvent("onTabsSelected",this.onTabsSelected.bind(this));BX.removeCustomEvent("onTabsReSelected",this.onTabsReSelected.bind(this));BX.removeCustomEvent("onAppActive",this.onAppActive.bind(this));this.isMountedFlag=false;this.cleanupOnExit()}onAppActive(){if(this.isMountedFlag){this.fetchList(true)}}async onRefresh(){if(this.state.isRefreshing){return}this.setState({isRefreshing:true},(async()=>{try{await this.fetchList(true)}finally{this.setState({isRefreshing:false})}}))}onTabsSelected(t){if(String(t)===S){this.isMountedFlag=true}else if(this.isMountedFlag){this.isMountedFlag=false;this.cleanupOnExit()}}onTabsReSelected(t){if(String(t)!==S){return}if(this.state.selectedScopeId!==C.ALL){this.onTabChange(C.ALL)}if(this.tabsScrollRef){this.tabsScrollRef.scrollToBegin(true)}}onBadgeUpdate(t){Application.setBadges({call_list:t})}onUpdateUserCounters(t){const e=t?.[d];if(!e){return}if(typeof e.call_list==="undefined"&&typeof e.CALL_LIST==="undefined"){return}const s=Number(e.call_list??e.CALL_LIST)||0;this.applyMissedCount(s)}applyMissedCount(t){this.setState({missedCount:t});this.onBadgeUpdate(t)}recalcMissedCountFrom(t){return t.filter((t=>t.status===r.Status.MISSED&&t.isUnseen)).length}computeTabItems(t,e){if(e===r.Status.MISSED){return t.filter((t=>t.status===r.Status.MISSED))}if(e===r.Type.INCOMING){return t.filter((t=>t.type===r.Type.INCOMING&&t.status!==r.Status.MISSED))}if(e===r.Type.OUTGOING){return t.filter((t=>t.type===r.Type.OUTGOING))}return t}pullSubscribe(){this.unsubscribeFromPull=BX.PULL.subscribe({moduleId:"call",callback:t=>this.processPullEvent(t)})}processPullEvent(t){const e=t?.command||"";const s=t?.params||{};switch(e){case"Call::callLogAdd":this.onCallLogAdd(s);break;case"Call::callLogUpdate":this.onCallLogUpdate(s);break;case"Call::callLogCounterUpdate":this.onCallLogCounterUpdate(s);break;default:}}onCallLogAdd(t){const e={id:t.id,statusTime:t.statusTime,sourceType:t.sourceType,sourceCallId:t.sourceCallId,userId:t.userId,status:t.status,chatInfo:t.chatInfo,callData:t.callData||{},isUnseen:t.isUnseen,type:t.type};const s=this.normalizeCallData(e);const a=String(s.id);this.setState((t=>{const e=t.allItems.findIndex((t=>String(t.id)===a));const i=e===-1?[s,...t.allItems]:t.allItems.map(((t,a)=>a===e?s:t));const l=this.computeTabItems(i,t.selectedScopeId);const n=this.recalcMissedCountFrom(i);this.applyMissedCount(n);return{allItems:i,tabItems:l,missedCount:n}}))}onCallLogUpdate(t){const e={id:t.id,statusTime:t.statusTime,sourceType:t.sourceType,sourceCallId:t.sourceCallId,userId:t.userId,status:t.status,chatInfo:t.chatInfo,callData:t.callData||{},isUnseen:t.isUnseen,type:t.type,previousStatus:t.previousStatus};const s=this.normalizeCallData(e);this.setState((t=>{const e=t.allItems.map((t=>{if(String(t.id)===String(s.id)){return s}return t}));const a=this.computeTabItems(e,t.selectedScopeId);const i=this.recalcMissedCountFrom(e);this.applyMissedCount(i);return{allItems:e,tabItems:a,missedCount:i}}))}onCallLogCounterUpdate(t){const e=Number(t.counterValue)||0;this.applyMissedCount(e)}cleanupOnExit(){this.clearMissedTimer();this.searchController.cleanup();this.markAllAsSeen()}startSeenTimerIfNeeded(){if(!this.isMountedFlag){return}if(this.state.selectedScopeId===r.Status.MISSED){this.scheduleMissedTimer()}}clearMissedTimer(){if(this.markTimer){clearTimeout(this.markTimer);this.markTimer=null}}scheduleMissedTimer(){if(this.markTimer){return}const t=Number(this.state.missedCount||0);const e=this.state.selectedScopeId===r.Status.MISSED?this.state.tabItems.some((t=>t.status===r.Status.MISSED&&t.isUnseen===true)):false;if(t>0||e){this.markTimer=setTimeout((()=>this.markMissedAsSeen()),1e3)}}markMissedAsSeen(){if(this.state.selectedScopeId!==r.Status.MISSED){return}this.clearMissedTimer();a("call.CallLog.markAllAsSeen",{scope:r.Status.MISSED}).then((()=>{this.setState((t=>{const e=t.allItems.map((t=>t.status===r.Status.MISSED?{...t,isUnseen:false}:t));const s=0;this.applyMissedCount(s);return{allItems:e,missedCount:s}}));this.fetchList(true)})).catch((t=>{console.error("[CallList][markMissedAsSeen][rest][error]",t)}))}onTabChange(t){if(this.state.selectedScopeId===r.Status.MISSED){this.clearMissedTimer()}this.setState((e=>{const s=String(t);const a=this.computeTabItems(e.allItems,s);return{selectedScopeId:s,tabItems:a}}),(()=>{this.fetchList(true);if(String(t)===r.Status.MISSED){this.scheduleMissedTimer()}}))}normalizeCallData(t){const e=t?.statusTime||null;const a=s(e);const i=t?.sourceType||"";const l=t?.callData||{};const{title:n,phone:o}=this.extractTitleAndPhone(i,l);const c=String(t?.id??"");return{id:c,key:c,ts:a,title:n,phone:o,sourceType:i,dialogId:l?.dialogId?String(l.dialogId):"",chatId:Number(l.chatId)||0,chatType:l?.chatType||"",avatar:l?.avatar||"",color:l?.color||"",type:t?.type===r.Type.INCOMING?r.Type.INCOMING:r.Type.OUTGOING,status:t?.status===r.Status.MISSED?r.Status.MISSED:r.Status.ANSWERED,isUnseen:Boolean(t?.isUnseen),duration:l?.duration||0,userCount:l?.userCount||0}}extractTitleAndPhone(t,e){let s="";let a="";if(t==="voximplant"){s=e.phoneNumber||e.displayName||"";a=e.phoneNumber||""}else if(t==="call"){s=e.title||""}return{title:s,phone:a}}async markAllAsSeen(){try{await a("call.CallLog.markAllAsSeen",{});this.setState((t=>{const e=t.allItems.map((t=>({...t,isUnseen:t.status===r.Status.MISSED?false:t.isUnseen})));const s=0;this.applyMissedCount(s);return{allItems:e,missedCount:s}}));this.fetchList(true)}catch(t){console.error("[CallList][markAllAsSeen][error]",t)}}async fetchList(t){if(this.isFetching){return}this.isFetching=true;try{const e=this.state.selectedScopeId;const s=this.lastId===0&&this.state.allItems.length===0;if(t){this.lastId=0;this.hasMore=true}const i={...f[e]};const l=await a("call.CallLog.list",{filter:i,lastId:this.lastId,count:I});const n=l?.calls&&Array.isArray(l.calls)?l.calls:l?.result?.calls||[];const o=n.map((t=>this.normalizeCallData(t)));this.lastId=n.length>0?Number(n[n.length-1].id):this.lastId;this.hasMore=n.length===I;this.setState((a=>{if(a.selectedScopeId!==e){return a}const i=t?o:[...a.allItems,...o];const l=this.computeTabItems(i,e);let n=a.missedCount;if(e===C.ALL){n=this.recalcMissedCountFrom(i);this.applyMissedCount(n)}return{allItems:i,tabItems:l,isReady:s?true:a.isReady,missedCount:n}}));this.startSeenTimerIfNeeded()}catch(t){console.error("[CallList][list][error]",t);this.setState((t=>t))}finally{this.isFetching=false}}startCall(t){const e=String(t.dialogId||"");const s=e.startsWith("chat")||t.chatType==="group";const a=String(t.avatar||"");const i=a?`${currentDomain}${a}`:null;if(t.phone){this.startPhoneCall(t.phone);return}if(s){this.startGroupCall(t,e,i);return}this.startPrivateCall(t,e,i)}startPhoneCall(t){BX.postComponentEvent("onPhoneTo",[{number:t}],"calls")}startGroupCall(t,e,s){const a=t.chatId||(e.startsWith("chat")?Number(e.replace("chat","")):0);if(a>0){const i=e||`chat${a}`;const l={dialogId:i,video:false,chatData:{dialogId:i,chatId:a,name:t.title,avatar:s,userCounter:t.userCount}};BX.postComponentEvent("onCallInvite",[l],"calls")}}startPrivateCall(t,e,s){const a=t.chatType==="private";if(a){const a=Number(e||0);if(!a){return}const i={userId:a,video:false,chatData:{dialogId:a,chatId:t.chatId,name:t.title,avatar:s},userData:{[a]:{id:a,name:t.title,avatar:s}}};BX.postComponentEvent("onCallInvite",[i],"calls")}}getSortedItems(){if(this.state.isSearchMode){if(this.state.searchItems===null){return[]}return[...this.state.searchItems].sort(((t,e)=>(e.ts||0)-(t.ts||0)))}const t=this.state.tabItems.length>0?this.state.tabItems:this.state.allItems;return[...t].sort(((t,e)=>(e.ts||0)-(t.ts||0)))}getTabEmptyStateText(){const{selectedScopeId:t}=this.state;return T[t]||T[C.ALL]}openChat(t){const e=String(t.dialogId||(t.chatId?`chat${t.chatId}`:""));if(e){n.open({dialogId:e})}}deleteCallItem(t){const e=Number(t.id)||t.id;a("call.CallLog.delete",{callId:e}).then((()=>{this.setState((e=>{const s=e.allItems.filter((e=>String(e.id)!==String(t.id)));const a=e.tabItems.filter((e=>String(e.id)!==String(t.id)));const i=this.recalcMissedCountFrom(s);this.applyMissedCount(i);return{allItems:s,tabItems:a,missedCount:i}}))})).catch((t=>console.error("[CallList][delete][error]",t)))}render(){const t=this.getSortedItems();const e=this.state.isSearchMode;const s=this.state.allItems.length===0;const a=!this.state.isReady&&!e||this.isFetching&&s&&!e;const n=Number(this.state.missedCount||0);const o=!a&&!e&&t.length===0;const r=View({style:{flex:1,justifyContent:"center",alignItems:"center"}},this.loader);const h=l({items:t,testId:p,style:{flex:1},onRefresh:()=>this.onRefresh(),isRefreshing:this.state.isRefreshing,hasMore:!a&&this.hasMore&&!e,onLoadMore:!a&&this.hasMore&&!e?()=>this.fetchList(false):null,onItemClick:t=>this.startCall(t),onOpenChat:t=>this.openChat(t),onDelete:t=>this.deleteCallItem(t)});const u=c({text:this.getTabEmptyStateText()});return View({style:{flex:1}},i({selectedScopeId:this.state.selectedScopeId,missedTotal:n,onScrollRef:t=>{this.tabsScrollRef=t},onChange:t=>this.onTabChange(t)}),a?r:o?u:h)}}layout.showComponent(new g)})();
//# sourceMappingURL=component.map.js