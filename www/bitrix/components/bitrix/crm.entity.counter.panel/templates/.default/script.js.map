{"version":3,"file":"script.js","sources":["src/entity-counter-type.js","src/entity-counter-filter-manager.js","src/entity-counter-manager.js","src/entity-counter-panel.js"],"sourcesContent":["export default class EntityCounterType\n{\n\t// type ID\n\tstatic UNDEFINED = 0;\n\tstatic IDLE = 1;\n\tstatic PENDING = 2;\n\tstatic OVERDUE = 4;\n\tstatic INCOMING_CHANNEL = 8;\n\tstatic READY_TODO = 16;\n\n\tstatic CURRENT = 20 // READY_TODO|OVERDUE\n\tstatic ALL_DEADLINE_BASED = 7;  //IDLE|PENDING|OVERDUE\n\n\n\tstatic ALL = 31;  //IDLE|PENDING|OVERDUE|INCOMINGCHANNEL|READY_TODO\n\n\t// type name\n\tstatic IDLE_NAME  = 'IDLE';\n\tstatic PENDING_NAME = 'PENDING';\n\tstatic OVERDUE_NAME = 'OVERDUE';\n\tstatic READY_TODO_NAME = 'READYTODO';\n\tstatic CURRENT_NAME = 'CURRENT';\n\tstatic INCOMING_CHANNEL_NAME = 'INCOMINGCHANNEL';\n\tstatic ALL_DEADLINE_BASED_NAME = 'ALLDEADLINEBASED';\n\tstatic ALL_NAME = 'ALL';\n}\n","import { Type } from 'main.core';\nimport { EventEmitter } from 'main.core.events';\nimport EntityCounterType from './entity-counter-type';\n\nexport default class EntityCounterFilterManager\n{\n\tstatic COUNTER_TYPE_FIELD = 'ACTIVITY_COUNTER';\n\n\tstatic EXCLUDED_FIELDS = [\n\t\t'FIND',\n\t];\n\n\tstatic FILTER_OTHER_USERS = 'other-users';\n\n\t#filterManager: ?BX.Main.Filter;\n\t#fields: ?Object;\n\t#isActive = false;\n\n\tbindToFilter(): void\n\t{\n\t\tconst filters = Type.isObject(BX.Main.filterManager) && BX.Main.filterManager.hasOwnProperty('getList')\n\t\t\t? BX.Main.filterManager.getList()\n\t\t\t: Object.values(BX.Main.filterManager.data);\n\n\t\tif (filters.length === 0)\n\t\t{\n\t\t\tthis.#isActive = false;\n\t\t\tconsole.warn('BX.Crm.EntityCounterFilter: Unable to define filter.');\n\t\t}\n\t\telse\n\t\t{\n\t\t\tthis.#isActive = true;\n\t\t\tthis.#filterManager = filters[0]; // use first filter to work\n\t\t\tthis.#bindEvents();\n\t\t\tthis.updateFields();\n\t\t}\n\t}\n\n\t#bindEvents(): void\n\t{\n\t\tEventEmitter.subscribe('BX.Main.Filter:apply', this.#onFilterApply.bind(this));\n\t}\n\n\t#onFilterApply(): void\n\t{\n\t\tthis.updateFields();\n\t}\n\n\t#isFilteredByField(field: string): boolean\n\t{\n\t\tif (Type.isArray(this.#fields[field]))\n\t\t{\n\t\t\treturn this.#fields[field].length > 0;\n\t\t}\n\n\t\tif (Type.isObject(this.#fields[field]))\n\t\t{\n\t\t\treturn Object.values(this.#fields[field]).length > 0;\n\t\t}\n\n\t\treturn this.#fields[field] !== '';\n\t}\n\n\tgetManager(): BX.Main.filterManager\n\t{\n\t\treturn this.#filterManager;\n\t}\n\n\tisActive(): boolean\n\t{\n\t\treturn this.#isActive;\n\t}\n\n\tgetFields(isFilterEmpty: boolean = false): Object\n\t{\n\t\tif (isFilterEmpty)\n\t\t{\n\t\t\tconst filtered = Object.entries(this.#fields).filter(([field, value]) => this.#isFilteredByField(field));\n\n\t\t\treturn Object.fromEntries(filtered);\n\t\t}\n\n\t\treturn this.#fields;\n\t}\n\n\tgetApi(): BX.Filter.Api\n\t{\n\t\treturn this.#filterManager.getApi();\n\t}\n\n\tupdateFields(): void\n\t{\n\t\tthis.#fields = this.#filterManager.getFilterFieldsValues();\n\t}\n\n\tisFilteredByFieldEx(field: string): boolean\n\t{\n\t\tif (\n\t\t\t!Object.keys(this.#fields).includes(field)\n\t\t\t|| field.endsWith('_datesel')\n\t\t\t|| field.endsWith('_numsel')\n\t\t\t|| field.endsWith('_label')\n\t\t)\n\t\t{\n\t\t\treturn false;\n\t\t}\n\n\t\treturn this.#isFilteredByField(field);\n\t}\n\n\tisFiltered(\n\t\tuserId: number,\n\t\ttypeId: number,\n\t\tentityTypeId: number,\n\t\tisOtherUsersFilter: boolean,\n\t\tcounterUserFieldName: string,\n\t): boolean\n\t{\n\t\tif (userId === 0 || typeId === EntityCounterType.UNDEFINED)\n\t\t{\n\t\t\treturn false;\n\t\t}\n\n\t\tlet isFilteredByUser = this.isFilteredByFieldEx(counterUserFieldName);\n\n\t\tif (\n\t\t\tType.isArray(this.#fields[counterUserFieldName])\n\t\t\t&& this.#fields[counterUserFieldName].length === 1\n\t\t)\n\t\t{\n\t\t\tlet nodeValue = this.#fields[counterUserFieldName][0];\n\t\t\ttry\n\t\t\t{\n\t\t\t\tconst [type, value] = JSON.parse(this.#fields[counterUserFieldName][0]);\n\t\t\t\tnodeValue = value;\n\t\t\t}\n\t\t\tcatch (error)\n\t\t\t{\n\t\t\t\tnodeValue = this.#fields[counterUserFieldName][0];\n\t\t\t}\n\n\t\t\tisFilteredByUser &&= isOtherUsersFilter\n\t\t\t\t? nodeValue === EntityCounterFilterManager.FILTER_OTHER_USERS\n\t\t\t\t: parseInt(nodeValue, 10) === userId\n\t\t\t;\n\t\t}\n\t\telse\n\t\t{\n\t\t\tisFilteredByUser = false;\n\t\t}\n\n\t\tconst hasFilteredByTypeValue = this.isFilteredByFieldEx(EntityCounterFilterManager.COUNTER_TYPE_FIELD)\n\t\t\t&& Type.isObject(this.#fields[EntityCounterFilterManager.COUNTER_TYPE_FIELD])\n\t\t;\n\n\t\tconst filteredTypeValues = hasFilteredByTypeValue\n\t\t\t? Object.values(this.#fields[EntityCounterFilterManager.COUNTER_TYPE_FIELD])\n\t\t\t\t.map((item) => parseInt(item, 10))\n\t\t\t\t.sort()\n\t\t\t: []\n\t\t;\n\n\t\tconst isFilteredByType = (filteredTypeValues.length === 1 && filteredTypeValues[0] === typeId)\n\t\t\t|| (\n\t\t\t\tfilteredTypeValues.length === 2\n\t\t\t\t&& typeId === EntityCounterType.CURRENT\n\t\t\t\t&& filteredTypeValues[0] === EntityCounterType.READY_TODO\n\t\t\t\t&& filteredTypeValues[1] === EntityCounterType.OVERDUE\n\t\t\t)\n\t\t;\n\n\t\tconst counterFields = [\n\t\t\tcounterUserFieldName,\n\t\t\tEntityCounterFilterManager.COUNTER_TYPE_FIELD,\n\t\t\t...EntityCounterFilterManager.EXCLUDED_FIELDS,\n\t\t];\n\n\t\tconst keysFields = Object.keys(this.#fields);\n\t\tconst otherFields = [\n\t\t\t...counterFields.filter((item) => !keysFields.includes(item)),\n\t\t\t...keysFields.filter((x) => !counterFields.includes(x)),\n\t\t];\n\n\t\tconst isOtherFilterUsed = otherFields.some((item) => this.isFilteredByFieldEx(item));\n\n\t\treturn isFilteredByUser && isFilteredByType && !isOtherFilterUsed;\n\t}\n}\n","import { ajax as Ajax, Event, Loc, Runtime, Text, Type } from 'main.core';\nimport { BaseEvent, EventEmitter } from 'main.core.events';\n\nimport type { EntityCounterManagerOptions } from './entity-counter-manager-options';\n\nexport default class EntityCounterManager\n{\n\tstatic lastInstance:?EntityCounterManager = null;\n\n\t#id: string;\n\t#entityTypeId: number;\n\t#codes: Array;\n\t#extras: Object;\n\t#withExcludeUsers: boolean = false;\n\t#counterData: Object;\n\t#isRequestRunning: boolean;\n\t#lastPullEventData: Object;\n\t#isTabActive: boolean;\n\t#openedSlidersCount: Number;\n\n\tconstructor(options: EntityCounterManagerOptions): void\n\t{\n\t\tif (!Type.isPlainObject(options))\n\t\t{\n\t\t\tthrow new TypeError('BX.Crm.EntityCounterManager: The \"options\" argument must be object.');\n\t\t}\n\n\t\tthis.#id = Type.isString(options.id) ? options.id : '';\n\t\tif (this.#id === '')\n\t\t{\n\t\t\tthrow new RangeError('BX.Crm.EntityCounterManager: The \"id\" argument must be specified.');\n\t\t}\n\n\t\tthis.#entityTypeId = options.entityTypeId ? Text.toInteger(options.entityTypeId) : 0;\n\t\tthis.#codes = Type.isArray(options.codes) ? options.codes : [];\n\t\tthis.#extras = Type.isObject(options.extras) ? options.extras : {};\n\t\tthis.#withExcludeUsers = Type.isBoolean(options.withExcludeUsers) ? options.withExcludeUsers : false;\n\t\tthis.#counterData = {};\n\t\tthis.#isTabActive = true;\n\t\tthis.#openedSlidersCount = 0;\n\n\t\tthis.constructor.lastInstance = this;\n\t}\n\n\tbindEvents(): void\n\t{\n\t\tEventEmitter.subscribe(\n\t\t\t'onPullEvent-main',\n\t\t\tRuntime.debounce(this.#onPullEvent, 3000, this),\n\t\t);\n\n\t\tEvent.ready(() => {\n\t\t\tEvent.bind(document, 'visibilitychange', () => {\n\t\t\t\tthis.#isTabActive = document.visibilityState === 'visible';\n\t\t\t\tif (this.#isTabActive && this.#isRecalculationRequired())\n\t\t\t\t{\n\t\t\t\t\tthis.#tryRecalculate(this.#lastPullEventData);\n\t\t\t\t}\n\t\t\t});\n\t\t});\n\n\t\tEventEmitter.subscribe('SidePanel.Slider:onOpen', () => {\n\t\t\tthis.#openedSlidersCount++;\n\t\t\tthis.#isTabActive = false;\n\t\t});\n\n\t\tEventEmitter.subscribe('SidePanel.Slider:onClose', () => {\n\t\t\tthis.#openedSlidersCount--;\n\t\t\tif (this.#openedSlidersCount <= 0)\n\t\t\t{\n\t\t\t\tthis.#openedSlidersCount = 0;\n\t\t\t\tthis.#isTabActive = true;\n\t\t\t\tif (this.#isRecalculationRequired())\n\t\t\t\t{\n\t\t\t\t\tthis.#tryRecalculate(this.#lastPullEventData);\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\t}\n\n\t#onPullEvent(event: BaseEvent): void\n\t{\n\t\tconst [command, params] = event.getData();\n\t\tif (command !== 'user_counter')\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tthis.#lastPullEventData = params;\n\t\tif (!this.#isTabActive)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tthis.#tryRecalculate(params);\n\t}\n\n\t#tryRecalculate(params: Object): void\n\t{\n\t\tlet enableRecalculation = false;\n\t\tlet enableRecalculationWithRequest = false;\n\n\t\tconst counterData = this.#fetchCounterData(params);\n\n\t\t// eslint-disable-next-line no-restricted-syntax\n\t\tfor (const counterId in counterData)\n\t\t{\n\t\t\tif (\n\t\t\t\t!Object.hasOwn(counterData, counterId)\n\t\t\t\t|| !this.#codes.includes(counterId)\n\t\t\t)\n\t\t\t{\n\t\t\t\tcontinue;\n\t\t\t}\n\n\t\t\tconst counterValue = BX.prop.getInteger(counterData, counterId, 0);\n\t\t\tif (counterValue < 0)\n\t\t\t{\n\t\t\t\tenableRecalculationWithRequest = true;\n\n\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\tconst currentCounterValue = BX.prop.getInteger(this.#counterData, counterId, 0);\n\t\t\tif (currentCounterValue !== counterValue)\n\t\t\t{\n\t\t\t\tenableRecalculation = true;\n\n\t\t\t\t// update counter data\n\t\t\t\tthis.#counterData[counterId] = counterValue;\n\t\t\t}\n\t\t}\n\n\t\tif (enableRecalculationWithRequest)\n\t\t{\n\t\t\tthis.#startRecalculationRequest();\n\t\t}\n\n\t\tif (enableRecalculation)\n\t\t{\n\t\t\tEventEmitter.emit(this, 'BX.Crm.EntityCounterManager:onRecalculate');\n\t\t}\n\t}\n\n\t#startRecalculationRequest(): void\n\t{\n\t\tif (this.#isRequestRunning)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tif (!this.#isTabActive)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tthis.#isRequestRunning = true;\n\n\t\tconst data = {\n\t\t\tentityTypeId: this.#entityTypeId,\n\t\t\textras: this.#extras,\n\t\t\twithExcludeUsers: this.#withExcludeUsers ? 1 : 0,\n\t\t};\n\n\t\tvoid Ajax\n\t\t\t.runAction('crm.counter.list', { data })\n\t\t\t.then(this.#onRecalculationSuccess.bind(this))\n\t\t;\n\t}\n\n\t#onRecalculationSuccess(result: Object): void\n\t{\n\t\tthis.#isRequestRunning = false;\n\n\t\tconst data = Type.isPlainObject(result.data) ? result.data : null;\n\t\tif (data === null)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tthis.setCounterData(data);\n\n\t\tEventEmitter.emit('BX.Crm.EntityCounterManager:onRecalculate', this);\n\t}\n\n\t#fetchCounterData(params: Object): Object\n\t{\n\t\tconst currentSiteId = Loc.getMessage('SITE_ID');\n\n\t\treturn Type.isPlainObject(params[currentSiteId]) ? params[currentSiteId] : {};\n\t}\n\n\t#isRecalculationRequired(): Boolean\n\t{\n\t\tif (!this.#lastPullEventData)\n\t\t{\n\t\t\treturn false;\n\t\t}\n\n\t\tconst counterData = this.#fetchCounterData(this.#lastPullEventData);\n\n\t\treturn Object.values(counterData).includes(-1);\n\t}\n\n\tgetId(): string\n\t{\n\t\treturn this.#id;\n\t}\n\n\tgetCounterData(): Object\n\t{\n\t\treturn this.#counterData;\n\t}\n\n\tsetCounterData(data: Object): void\n\t{\n\t\tthis.#counterData = data;\n\t}\n\n\tstatic getLastInstance(): ?EntityCounterManager\n\t{\n\t\treturn this.lastInstance;\n\t}\n}\n","import { Event, Loc, Reflection, Text, Type } from 'main.core';\nimport { BaseEvent, EventEmitter } from 'main.core.events';\nimport { CounterItem, CounterPanel } from 'ui.counterpanel';\nimport EntityCounterFilterManager from './entity-counter-filter-manager';\nimport EntityCounterManager from './entity-counter-manager';\n\nimport type { EntityCounterPanelOptions } from './entity-counter-panel-options';\nimport EntityCounterType from './entity-counter-type';\n\nconst namespace = Reflection.namespace('BX.Crm');\n\nclass EntityCounterPanel extends CounterPanel\n{\n\tstatic EXCLUDE_USERS_CODE_SUFFIX = 'excl';\n\tstatic EXCLUDE_ALL_USERS_CODE_SUFFIX = 'all_excl';\n\n\t#id: String;\n\t#entityTypeId: Number;\n\t#entityTypeName: String;\n\t#userId: Number;\n\t#userName: String;\n\t#codes: Array;\n\t#data: Array;\n\t#counterManager: ?EntityCounterManager;\n\t#filterManager: ?EntityCounterFilterManager;\n\t#filterLastPresetId: String;\n\t#filterLastPreset: Object;\n\t#filterResponsibleFiledName: string;\n\t#lockedCallback: ?string;\n\n\tconstructor(options: EntityCounterPanelOptions): void\n\t{\n\t\tif (!Type.isPlainObject(options))\n\t\t{\n\t\t\tthrow 'BX.Crm.EntityCounterPanel: The \"options\" argument must be object.';\n\t\t}\n\n\t\tconst data = Type.isPlainObject(options.data) ? options.data : {};\n\t\tconst withExcludeUsers = Type.isBoolean(options.withExcludeUsers) ? options.withExcludeUsers : false;\n\n\t\tsuper({\n\t\t\ttarget: BX(options.id),\n\t\t\titems: EntityCounterPanel.getCounterItems(data, options),\n\t\t\tmultiselect: false, // disable multiselect for CRM counters\n\t\t\ttitle: Loc.getMessage('NEW_CRM_COUNTER_TITLE_MY')\n\t\t});\n\n\t\tthis.#id = options.id;\n\t\tthis.#entityTypeId = options.entityTypeId ? Text.toInteger(options.entityTypeId) : 0;\n\t\tthis.#entityTypeName = options.entityTypeName;\n\t\tthis.#userId = options.userId ? Text.toInteger(options.userId) : 0;\n\t\tthis.#userName = Type.isStringFilled(options.userName) ? options.userName : this.#userId;\n\t\tthis.#codes = Type.isArray(options.codes) ? options.codes : [];\n\t\tthis.#data = data;\n\t\tthis.#filterResponsibleFiledName = options.filterResponsibleFiledName;\n\n\t\tif (BX.CrmEntityType.isDefined(this.#entityTypeId))\n\t\t{\n\t\t\tthis.#counterManager = new EntityCounterManager({\n\t\t\t\tid: this.#id,\n\t\t\t\tentityTypeId: this.#entityTypeId,\n\t\t\t\tcodes: this.#codes,\n\t\t\t\textras: Type.isObject(options.extras) ? options.extras : {},\n\t\t\t\twithExcludeUsers,\n\t\t\t});\n\t\t}\n\n\t\tthis.#filterManager = new EntityCounterFilterManager();\n\t\tthis.#filterLastPresetId = options.filterLastPresetId;\n\t\tthis.#filterLastPreset = Type.isArray(options.filterLastPresetData)\n\t\t\t? JSON.parse(options.filterLastPresetData[0])\n\t\t\t: {presetId: null};\n\n\t\tthis.#lockedCallback = Type.isStringFilled(options.lockedCallback) ? options.lockedCallback : null;\n\t}\n\n\tbindToFilter(): void\n\t{\n\t\tthis.#filterManager.bindToFilter();\n\t\tthis.#markCounters();\n\t}\n\n\tbindEvents(): void\n\t{\n\t\tthis.#counterManager?.bindEvents();\n\n\t\tif (Type.isStringFilled(this.#lockedCallback))\n\t\t{\n\t\t\tconst elem = document.getElementById(this.#id);\n\n\t\t\tEvent.bind(elem, 'click', () => {\n\t\t\t\t// eslint-disable-next-line no-eval\n\t\t\t\teval(this.#lockedCallback);\n\t\t\t});\n\n\t\t\treturn;\n\t\t}\n\n\t\tEventEmitter.subscribe('BX.UI.CounterPanel.Item:activate', this.#onActivateItem.bind(this));\n\t\tEventEmitter.subscribe('BX.UI.CounterPanel.Item:deactivate', this.#onDeactivateItem.bind(this));\n\t\tEventEmitter.subscribe('BX.Main.Filter:apply', this.#onFilterApply.bind(this));\n\t\tEventEmitter.subscribe('BX.Crm.EntityCounterManager:onRecalculate', this.#onRecalculate.bind(this));\n\t}\n\n\t#onActivateItem(event: BaseEvent): void\n\t{\n\t\tconst item = event.getData();\n\n\t\tif (!this.#processItemSelection(item))\n\t\t{\n\t\t\tevent.preventDefault();\n\t\t}\n\t}\n\n\t#onDeactivateItem(event: BaseEvent): void\n\t{\n\t\tthis.#deactivateLinkedMenuItem(event.getData());\n\t\tif (this.#isAllDeactivated() && this.#filterManager.isActive())\n\t\t{\n\t\t\tconst api = this.#filterManager.getApi();\n\n\t\t\tif (this.#filterLastPreset.presetId === 'tmp_filter')\n\t\t\t{\n\t\t\t\tapi.setFields(this.#filterLastPreset.fields);\n\t\t\t\tapi.apply();\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tapi.setFilter({preset_id: this.#filterLastPreset.presetId});\n\t\t\t}\n\t\t}\n\t}\n\n\t#onFilterApply(): void\n\t{\n\t\tif (this.#filterManager.isActive())\n\t\t{\n\t\t\tthis.#filterManager.updateFields();\n\t\t}\n\t\tthis.#markCounters();\n\t}\n\n\t#onRecalculate(): void\n\t{\n\t\tlet isValueUpdated = false;\n\n\t\tconst data = this.#counterManager.getCounterData();\n\t\tconst parentItem = this.getItemById(EntityCounterPanel.getMenuParentItemId(this.#codes));\n\n\t\tfor (let code in data)\n\t\t{\n\t\t\tif (\n\t\t\t\t!data.hasOwnProperty(code)\n\t\t\t\t|| !(code.indexOf('crm') === 0 && data[code] >= 0) // HACK: Skip of CRM counter reset\n\t\t\t\t|| !this.#data.hasOwnProperty(code)\n\t\t\t\t|| Text.toNumber(this.#data[code].VALUE) === Text.toNumber(data[code])\n\t\t\t)\n\t\t\t{\n\t\t\t\tcontinue;\n\t\t\t}\n\n\t\t\tthis.#data[code].VALUE = data[code];\n\n\t\t\tconst item = this.getItemById(code);\n\t\t\titem.updateValue(Text.toNumber(data[code]));\n\t\t\titem.updateColor(EntityCounterPanel.detectCounterItemColor(this.#data[code].TYPE_NAME, Text.toNumber(data[code])));\n\n\t\t\tisValueUpdated = isValueUpdated || true;\n\t\t}\n\n\t\tif (parentItem)\n\t\t{\n\t\t\tparentItem.updateValue(this.#getParentItemTotalValue());\n\t\t}\n\t}\n\n\t#processItemSelection(item: CounterItem): Boolean\n\t{\n\t\tconst isOtherUsersFilter = item.id.endsWith(EntityCounterPanel.EXCLUDE_USERS_CODE_SUFFIX);\n\t\tconst typeId = parseInt(this.#data[item.id].TYPE_ID, 10);\n\t\tif (typeId > 0)\n\t\t{\n\t\t\tif (this.#filterManager.isActive())\n\t\t\t{\n\t\t\t\tconst filteredFields = this.#filterManager.getFields(true);\n\t\t\t\tif (typeof (filteredFields[EntityCounterFilterManager.COUNTER_TYPE_FIELD]) === 'undefined')\n\t\t\t\t{\n\t\t\t\t\tthis.#filterLastPreset.presetId = this.#filterManager.getApi().parent.getPreset().getCurrentPresetId();\n\t\t\t\t\tif (this.#filterLastPreset.presetId === 'tmp_filter')\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.#filterLastPreset.fields = filteredFields\n\t\t\t\t\t}\n\n\t\t\t\t\tBX.userOptions.save('crm', this.#filterLastPresetId, '', JSON.stringify(this.#filterLastPreset));\n\t\t\t\t}\n\n\t\t\t\tconst userId = isOtherUsersFilter ? EntityCounterFilterManager.FILTER_OTHER_USERS : this.#userId.toString();\n\t\t\t\tconst userName = isOtherUsersFilter ? Loc.getMessage('NEW_CRM_COUNTER_TYPE_OTHER') : this.#userName;\n\t\t\t\tconst counterTypeId = this.#prepareFilterTypeId(typeId);\n\n\t\t\t\tconst filterItem = JSON.stringify([\n\t\t\t\t\tisOtherUsersFilter ? 'meta-user' : 'user',\n\t\t\t\t\tuserId,\n\t\t\t\t]);\n\n\t\t\t\tconst api = this.#filterManager.getApi();\n\n\t\t\t\tlet fields = {\n\t\t\t\t\t\"ACTIVITY_COUNTER\": BX.Type.isPlainObject(counterTypeId)\n\t\t\t\t\t\t? counterTypeId\n\t\t\t\t\t\t: { 0: counterTypeId }\n\t\t\t\t};\n\n\t\t\t\tconst responsibleField = this.#filterResponsibleFiledName;\n\t\t\t\tfields = {\n\t\t\t\t\t...fields,\n\t\t\t\t\t[responsibleField]: { 0: filterItem },\n\t\t\t\t\t[`${responsibleField}_label`]: [userName],\n\t\t\t\t};\n\n\t\t\t\tapi.setFields(fields);\n\t\t\t\tapi.apply({'COUNTER': this.#makeFilterAnalyticsLabel(counterTypeId)});\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\treturn false;\n\t\t\t}\n\t\t}\n\n\t\treturn true;\n\t}\n\n\t// entityTypeName\n\t#makeFilterAnalyticsLabel(counterTypeId: Object | string): string\n\t{\n\t\tif (this.#entityTypeName && counterTypeId)\n\t\t{\n\t\t\treturn 'CRM_' + this.#entityTypeName + '_COUNTER_TYPE_' + counterTypeId;\n\t\t}\n\t\treturn '';\n\t}\n\n\t#prepareFilterTypeId(typeId: Number): Object\n\t{\n\t\tif (typeId === EntityCounterType.CURRENT)\n\t\t{\n\t\t\treturn {\n\t\t\t\t0: EntityCounterType.OVERDUE.toString(),\n\t\t\t\t1: EntityCounterType.READY_TODO.toString(),\n\t\t\t}\n\t\t}\n\n\t\treturn typeId.toString();\n\t}\n\n\t#markCounters(): void\n\t{\n\t\tif (!this.#filterManager.isActive())\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tconst parentItem = this.getItemById(EntityCounterPanel.getMenuParentItemId(this.#codes));\n\n\t\tlet isOtherUsersFilterUse = false;\n\n\t\tObject.entries(this.#data).forEach(([code, record]) => {\n\t\t\tlet item = this.getItemById(code);\n\n\t\t\tconst isOtherUsersFilter = item.id.endsWith(EntityCounterPanel.EXCLUDE_USERS_CODE_SUFFIX);\n\n\t\t\tconst isFiltered = this.#filterManager.isFiltered(\n\t\t\t\tthis.#userId,\n\t\t\t\tparseInt(record.TYPE_ID, 10),\n\t\t\t\tthis.#entityTypeId,\n\t\t\t\tisOtherUsersFilter,\n\t\t\t\tthis.#filterResponsibleFiledName\n\t\t\t);\n\n\t\t\tif (isFiltered)\n\t\t\t{\n\t\t\t\titem.activate(false);\n\n\t\t\t\tif (isOtherUsersFilter)\n\t\t\t\t{\n\t\t\t\t\tisOtherUsersFilterUse = true;\n\t\t\t\t}\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\titem.deactivate(false);\n\t\t\t}\n\n\t\t\t// TODO: need fix it in parent CounterItem class\n\t\t\tif (item.value !== item.counter.getValue())\n\t\t\t{\n\t\t\t\titem.updateValue(item.value);\n\t\t\t}\n\t\t});\n\n\t\tif (parentItem)\n\t\t{\n\t\t\tisOtherUsersFilterUse ? parentItem.activate(false) : parentItem.deactivate(false);\n\t\t}\n\t}\n\n\t#isAllDeactivated(): Boolean\n\t{\n\t\treturn this.getItems().every((record: CounterItem) => {\n\t\t\treturn !record.isActive\n\t\t});\n\t}\n\n\t#deactivateLinkedMenuItem(item: CounterItem): void\n\t{\n\t\tif (item.hasParentId())\n\t\t{\n\t\t\tconst parentItem = this.getItemById(EntityCounterPanel.getMenuParentItemId(this.#codes));\n\t\t\tparentItem.deactivate(false);\n\n\t\t\treturn;\n\t\t}\n\n\t\tif (item.parent)\n\t\t{\n\t\t\titem.getItems().forEach(childItemId => {\n\t\t\t\tlet childItem = this.getItemById(childItemId);\n\t\t\t\tif (childItem.isActive)\n\t\t\t\t{\n\t\t\t\t\tchildItem.deactivate(false);\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t}\n\n\t#getParentItemTotalValue(): number\n\t{\n\t\tlet result = 0;\n\n\t\tthis.getItems().forEach((record: CounterItem) => {\n\t\t\tif (record.hasParentId())\n\t\t\t{\n\t\t\t\tresult += record.value;\n\t\t\t}\n\t\t});\n\n\t\treturn result;\n\t}\n\n\tinit(): void\n\t{\n\t\tsuper.init();\n\n\t\tthis.#markCounters();\n\t}\n\n\tgetId(): String\n\t{\n\t\treturn this.#id;\n\t}\n\n\tstatic getCounterItems(input: Object, options: EntityCounterPanelOptions): Array\n\t{\n\t\tconst withExcludeUsers = Type.isBoolean(options.withExcludeUsers) ? options.withExcludeUsers : false;\n\t\tconst isRestricted = Type.isStringFilled(options.lockedCallback);\n\t\tconst parentItemId = EntityCounterPanel.getMenuParentItemId(Type.isArray(options.codes) ? options.codes : [])\n\n\t\tlet otherUsersItems = [];\n\t\tif (withExcludeUsers && !Type.isUndefined(parentItemId))\n\t\t{\n\t\t\tlet parentTotal = 0;\n\n\t\t\totherUsersItems = Object.entries(input).map(([code: String, item: Object]) => {\n\t\t\t\tif (code.endsWith(EntityCounterPanel.EXCLUDE_USERS_CODE_SUFFIX))\n\t\t\t\t{\n\t\t\t\t\tconst value = parseInt(item.VALUE, 10);\n\n\t\t\t\t\tparentTotal += value;\n\n\t\t\t\t\tconst color = EntityCounterPanel.detectCounterItemColor(item.TYPE_NAME, value);\n\n\t\t\t\t\treturn {\n\t\t\t\t\t\tid: code,\n\t\t\t\t\t\ttitle: Loc.getMessage('NEW_CRM_COUNTER_TYPE_OTHER_' + item.TYPE_NAME),\n\t\t\t\t\t\tvalue: {\n\t\t\t\t\t\t\tvalue: value,\n\t\t\t\t\t\t\torder: -1\n\t\t\t\t\t\t},\n\t\t\t\t\t\tcolor: color === 'THEME' ? 'GRAY' : color, // override color to correct display on different themes\n\t\t\t\t\t\tparentId: parentItemId\n\t\t\t\t\t};\n\t\t\t\t}\n\t\t\t}, this);\n\n\t\t\t// add parent item\n\t\t\totherUsersItems = [{\n\t\t\t\tid: parentItemId,\n\t\t\t\ttitle: Loc.getMessage('NEW_CRM_COUNTER_TYPE_OTHER_TITLE'),\n\t\t\t\tvalue: {\n\t\t\t\t\tvalue: parentTotal,\n\t\t\t\t\torder: -1\n\t\t\t\t},\n\t\t\t\tisRestricted: isRestricted,\n\t\t\t\tcolor: 'THEME'\n\t\t\t}].concat(otherUsersItems);\n\t\t}\n\n\t\tlet currentUserItems = Object.entries(input).map(([code: String, item: Object]) => {\n\t\t\tif (!code.endsWith(EntityCounterPanel.EXCLUDE_USERS_CODE_SUFFIX))\n\t\t\t{\n\t\t\t\tconst value = parseInt(item.VALUE, 10);\n\n\t\t\t\treturn {\n\t\t\t\t\tid: code,\n\t\t\t\t\ttitle: Loc.getMessage('NEW_CRM_COUNTER_TYPE_' + item.TYPE_NAME),\n\t\t\t\t\tvalue: value,\n\t\t\t\t\tisRestricted: isRestricted,\n\t\t\t\t\tcolor: EntityCounterPanel.detectCounterItemColor(item.TYPE_NAME, value)\n\t\t\t\t};\n\t\t\t}\n\t\t}, this);\n\n\t\treturn currentUserItems.concat(otherUsersItems).filter(item => Type.isObject(item));\n\t}\n\n\tstatic getMenuParentItemId(codes: Array): ?String\n\t{\n\t\treturn codes.find(element => element.endsWith(EntityCounterPanel.EXCLUDE_ALL_USERS_CODE_SUFFIX));\n\t}\n\n\tstatic detectCounterItemColor(type: String, value: Number): String\n\t{\n\t\tconst isRedCounter = [\n\t\t\tEntityCounterType.IDLE_NAME,\n\t\t\tEntityCounterType.OVERDUE_NAME,\n\t\t\tEntityCounterType.CURRENT_NAME,\n\t\t].includes(type);\n\n\t\tconst isGreenCounter  =  [\n\t\t\tEntityCounterType.INCOMING_CHANNEL_NAME,\n\t\t].includes(type);\n\n\t\treturn (value > 0)\n\t\t\t? (isRedCounter ? 'DANGER' : (isGreenCounter ? 'SUCCESS' : 'THEME'))\n\t\t\t: 'THEME';\n\t}\n}\n\nnamespace.EntityCounterPanel = EntityCounterPanel;\n"],"names":["EntityCounterType","EntityCounterFilterManager","filters","Type","isObject","BX","Main","filterManager","hasOwnProperty","getList","Object","values","data","length","console","warn","updateFields","isFilterEmpty","filtered","entries","filter","field","value","fromEntries","getApi","getFilterFieldsValues","keys","includes","endsWith","userId","typeId","entityTypeId","isOtherUsersFilter","counterUserFieldName","UNDEFINED","isFilteredByUser","isFilteredByFieldEx","isArray","nodeValue","JSON","parse","type","error","FILTER_OTHER_USERS","parseInt","hasFilteredByTypeValue","COUNTER_TYPE_FIELD","filteredTypeValues","map","item","sort","isFilteredByType","CURRENT","READY_TODO","OVERDUE","counterFields","EXCLUDED_FIELDS","keysFields","otherFields","x","isOtherFilterUsed","some","EventEmitter","subscribe","bind","EntityCounterManager","options","_classPrivateMethodInitSpec","_classPrivateFieldInitSpec","isPlainObject","TypeError","isString","id","RangeError","Text","toInteger","codes","extras","isBoolean","withExcludeUsers","constructor","lastInstance","Runtime","debounce","Event","ready","document","visibilityState","_classPrivateMethodGet","event","getData","command","params","enableRecalculation","enableRecalculationWithRequest","counterData","counterId","hasOwn","counterValue","prop","getInteger","currentCounterValue","emit","Ajax","runAction","then","result","setCounterData","currentSiteId","Loc","getMessage","namespace","Reflection","EntityCounterPanel","target","items","getCounterItems","multiselect","title","entityTypeName","isStringFilled","userName","filterResponsibleFiledName","CrmEntityType","isDefined","filterLastPresetId","filterLastPresetData","presetId","lockedCallback","bindToFilter","bindEvents","elem","getElementById","eval","input","isRestricted","parentItemId","getMenuParentItemId","otherUsersItems","isUndefined","parentTotal","code","EXCLUDE_USERS_CODE_SUFFIX","VALUE","color","detectCounterItemColor","TYPE_NAME","order","parentId","concat","currentUserItems","find","element","EXCLUDE_ALL_USERS_CODE_SUFFIX","isRedCounter","IDLE_NAME","OVERDUE_NAME","CURRENT_NAME","isGreenCounter","INCOMING_CHANNEL_NAME","CounterPanel","preventDefault","isActive","api","setFields","fields","apply","setFilter","preset_id","getCounterData","parentItem","getItemById","indexOf","toNumber","updateValue","updateColor","TYPE_ID","filteredFields","getFields","parent","getPreset","getCurrentPresetId","userOptions","save","stringify","toString","counterTypeId","filterItem","responsibleField","isOtherUsersFilterUse","forEach","record","isFiltered","activate","deactivate","counter","getValue","getItems","every","hasParentId","childItemId","childItem"],"mappings":"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"}