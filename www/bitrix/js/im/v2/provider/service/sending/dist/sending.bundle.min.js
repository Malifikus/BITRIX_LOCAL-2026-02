this.BX=this.BX||{};this.BX.Messenger=this.BX.Messenger||{};this.BX.Messenger.v2=this.BX.Messenger.v2||{};(function(e,s,a,r,t,i,l,o,d){"use strict";var c=babelHelpers.classPrivateFieldLooseKey("store");var n=babelHelpers.classPrivateFieldLooseKey("addLoadingMessage");var p=babelHelpers.classPrivateFieldLooseKey("processMessageSending");var b=babelHelpers.classPrivateFieldLooseKey("handleAddingMessageToModels");var v=babelHelpers.classPrivateFieldLooseKey("sendAndProcessMessage");var h=babelHelpers.classPrivateFieldLooseKey("prepareMessage");var g=babelHelpers.classPrivateFieldLooseKey("prepareMessageWithFiles");var P=babelHelpers.classPrivateFieldLooseKey("prepareMessageWithSticker");var u=babelHelpers.classPrivateFieldLooseKey("preparePrompt");var f=babelHelpers.classPrivateFieldLooseKey("handlePagination");var F=babelHelpers.classPrivateFieldLooseKey("addMessageToModels");var L=babelHelpers.classPrivateFieldLooseKey("addMessageToRecent");var y=babelHelpers.classPrivateFieldLooseKey("sendMessageToServer");var I=babelHelpers.classPrivateFieldLooseKey("updateModels");var H=babelHelpers.classPrivateFieldLooseKey("updateMessageError");var B=babelHelpers.classPrivateFieldLooseKey("removeMessageError");var m=babelHelpers.classPrivateFieldLooseKey("sendScrollEvent");var M=babelHelpers.classPrivateFieldLooseKey("getDialog");var w=babelHelpers.classPrivateFieldLooseKey("getDialogByChatId");var S=babelHelpers.classPrivateFieldLooseKey("needToSetAsViewed");var O=babelHelpers.classPrivateFieldLooseKey("handleForwardMessageResponse");var j=babelHelpers.classPrivateFieldLooseKey("handleForwardMessageError");var K=babelHelpers.classPrivateFieldLooseKey("prepareForwardMessages");var T=babelHelpers.classPrivateFieldLooseKey("prepareForwardParams");var k=babelHelpers.classPrivateFieldLooseKey("prepareSendForwardRequest");var A=babelHelpers.classPrivateFieldLooseKey("addForwardsToModels");var E=babelHelpers.classPrivateFieldLooseKey("getForwardUuidMap");var x=babelHelpers.classPrivateFieldLooseKey("buildForwardContextId");var C=babelHelpers.classPrivateFieldLooseKey("logSendErrors");var X=babelHelpers.classPrivateFieldLooseKey("clearLastMessageViews");var U=babelHelpers.classPrivateFieldLooseKey("sendForwardRequest");var W=babelHelpers.classPrivateFieldLooseKey("prepareCopilotMessageParams");var D=babelHelpers.classPrivateFieldLooseKey("prepareAiAssistantMessageParams");class ${static getInstance(){if(!this.instance){this.instance=new this}return this.instance}constructor(){Object.defineProperty(this,D,{value:Le});Object.defineProperty(this,W,{value:Fe});Object.defineProperty(this,U,{value:fe});Object.defineProperty(this,X,{value:ue});Object.defineProperty(this,C,{value:Pe});Object.defineProperty(this,x,{value:ge});Object.defineProperty(this,E,{value:he});Object.defineProperty(this,A,{value:ve});Object.defineProperty(this,k,{value:be});Object.defineProperty(this,T,{value:pe});Object.defineProperty(this,K,{value:ne});Object.defineProperty(this,j,{value:ce});Object.defineProperty(this,O,{value:de});Object.defineProperty(this,S,{value:oe});Object.defineProperty(this,w,{value:le});Object.defineProperty(this,M,{value:ie});Object.defineProperty(this,m,{value:te});Object.defineProperty(this,B,{value:re});Object.defineProperty(this,H,{value:ae});Object.defineProperty(this,I,{value:se});Object.defineProperty(this,y,{value:ee});Object.defineProperty(this,L,{value:Z});Object.defineProperty(this,F,{value:Q});Object.defineProperty(this,f,{value:J});Object.defineProperty(this,u,{value:G});Object.defineProperty(this,P,{value:z});Object.defineProperty(this,g,{value:Y});Object.defineProperty(this,h,{value:_});Object.defineProperty(this,v,{value:N});Object.defineProperty(this,b,{value:q});Object.defineProperty(this,p,{value:V});Object.defineProperty(this,n,{value:R});Object.defineProperty(this,c,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,c)[c]=l.Core.getStore()}async sendMessage(e){const{text:a=""}=e;if(!s.Type.isStringFilled(a)){return}t.Logger.warn("SendingService: sendMessage",e);const r=babelHelpers.classPrivateFieldLooseBase(this,h)[h](e);void babelHelpers.classPrivateFieldLooseBase(this,p)[p](r)}async sendMessageWithFiles(e){const{text:a="",fileIds:r=[]}=e;if(!s.Type.isStringFilled(a)&&!s.Type.isArrayFilled(r)){return Promise.resolve()}t.Logger.warn("SendingService: sendMessage with files",e);const i=babelHelpers.classPrivateFieldLooseBase(this,g)[g](e);await babelHelpers.classPrivateFieldLooseBase(this,f)[f](i.dialogId);await babelHelpers.classPrivateFieldLooseBase(this,n)[n](i);await babelHelpers.classPrivateFieldLooseBase(this,L)[L](i);await babelHelpers.classPrivateFieldLooseBase(this,X)[X](i.dialogId);babelHelpers.classPrivateFieldLooseBase(this,m)[m]({force:true,dialogId:i.dialogId});return Promise.resolve()}async sendMessageWithSticker(e){const{stickerParams:a}=e;if(!s.Type.isPlainObject(a)){return}void babelHelpers.classPrivateFieldLooseBase(this,c)[c].dispatch("stickers/recent/update",a);t.Logger.warn("SendingService: sendMessage with sticker",e);const r=babelHelpers.classPrivateFieldLooseBase(this,P)[P](e);void babelHelpers.classPrivateFieldLooseBase(this,p)[p](r)}async forwardMessages(e){const{forwardIds:a,dialogId:r,text:i}=e;if(!s.Type.isArrayFilled(a)){return Promise.resolve()}t.Logger.warn("SendingService: forwardMessages",e);await babelHelpers.classPrivateFieldLooseBase(this,f)[f](r);let l=null;if(s.Type.isStringFilled(i)){l=babelHelpers.classPrivateFieldLooseBase(this,h)[h](e);await babelHelpers.classPrivateFieldLooseBase(this,F)[F](l)}const o=[...a].sort();const d=babelHelpers.classPrivateFieldLooseBase(this,E)[E](o);const c=babelHelpers.classPrivateFieldLooseBase(this,K)[K](e,d);await babelHelpers.classPrivateFieldLooseBase(this,A)[A](c);babelHelpers.classPrivateFieldLooseBase(this,m)[m]({force:true,dialogId:r});return babelHelpers.classPrivateFieldLooseBase(this,U)[U]({forwardUuidMap:d,commentMessage:l,dialogId:r})}async retrySendMessage(e){const{tempMessageId:a,dialogId:r}=e;const t=babelHelpers.classPrivateFieldLooseBase(this,c)[c].getters["messages/getById"](a);if(!t){return Promise.resolve()}babelHelpers.classPrivateFieldLooseBase(this,B)[B](a);const i=babelHelpers.classPrivateFieldLooseBase(this,h)[h]({text:t.text,dialogId:r,tempMessageId:t.id,replyId:t.replyId});if(s.Type.isStringFilled(t.forward.id)){const[,e]=t.forward.id.split("/");const s={[t.id]:e};return babelHelpers.classPrivateFieldLooseBase(this,U)[U]({forwardUuidMap:s,dialogId:r})}return babelHelpers.classPrivateFieldLooseBase(this,v)[v](i)}async sendCopilotPrompt(e){const{text:a=""}=e;if(!s.Type.isStringFilled(a)){return Promise.resolve()}t.Logger.warn("SendingService: sendCopilotPrompt",e);const r=babelHelpers.classPrivateFieldLooseBase(this,u)[u](e);return babelHelpers.classPrivateFieldLooseBase(this,p)[p](r)}}async function R(e){return babelHelpers.classPrivateFieldLooseBase(this,c)[c].dispatch("messages/addLoadingMessage",{message:e})}async function V(e){await babelHelpers.classPrivateFieldLooseBase(this,b)[b](e);return babelHelpers.classPrivateFieldLooseBase(this,v)[v](e)}async function q(e){await babelHelpers.classPrivateFieldLooseBase(this,f)[f](e.dialogId);await babelHelpers.classPrivateFieldLooseBase(this,F)[F](e);babelHelpers.classPrivateFieldLooseBase(this,m)[m]({force:true,dialogId:e.dialogId})}async function N(e){const s=await babelHelpers.classPrivateFieldLooseBase(this,y)[y](e).catch((s=>{babelHelpers.classPrivateFieldLooseBase(this,H)[H](e.temporaryId);babelHelpers.classPrivateFieldLooseBase(this,C)[C](s,"sendAndProcessMessage")}));t.Logger.warn("SendingService: sendAndProcessMessage result -",s);const{id:a}=s;if(!a){return Promise.resolve()}babelHelpers.classPrivateFieldLooseBase(this,I)[I]({oldId:e.temporaryId,newId:a,dialogId:e.dialogId});return Promise.resolve()}function _(e){const{text:s,tempMessageId:a,dialogId:t,replyId:i,forwardIds:o}=e;const d={authorId:l.Core.getUserId(),unread:false,sending:true};const c=babelHelpers.classPrivateFieldLooseBase(this,W)[W](t);const n=babelHelpers.classPrivateFieldLooseBase(this,D)[D](t);return{text:s,dialogId:t,chatId:babelHelpers.classPrivateFieldLooseBase(this,M)[M](t).chatId,temporaryId:a!=null?a:r.Utils.text.getUuidV4(),replyId:i,forwardIds:o,viewedByOthers:babelHelpers.classPrivateFieldLooseBase(this,S)[S](t),...c,...n,...d}}function Y(e){const{fileIds:a}=e;if(!s.Type.isArrayFilled(a)){throw new Error("SendingService: sendMessageWithFile: no fileId provided")}return{...babelHelpers.classPrivateFieldLooseBase(this,h)[h](e),params:{FILE_ID:a}}}function z(e){const{stickerParams:a}=e;if(!s.Type.isPlainObject(a)){throw new TypeError("SendingService: sendMessageWithSticker: no stickerParams provided")}return{...babelHelpers.classPrivateFieldLooseBase(this,h)[h](e),stickerParams:a}}function G(e){const{copilot:s}=e;if(!s||!s.promptCode){throw new Error("SendingService: preparePrompt: no code provided")}return{...babelHelpers.classPrivateFieldLooseBase(this,h)[h](e),copilot:s}}async function J(e){if(!babelHelpers.classPrivateFieldLooseBase(this,M)[M](e).hasNextPage){return Promise.resolve()}t.Logger.warn("SendingService: sendMessage: there are unread pages, move to chat end");const s=new d.MessageService({chatId:babelHelpers.classPrivateFieldLooseBase(this,M)[M](e).chatId});await s.loadContext(babelHelpers.classPrivateFieldLooseBase(this,M)[M](e).lastMessageId);babelHelpers.classPrivateFieldLooseBase(this,m)[m]({dialogId:e});return Promise.resolve()}function Q(e){babelHelpers.classPrivateFieldLooseBase(this,L)[L](e);const a=s.Type.isPlainObject(e.stickerParams);if(a){void babelHelpers.classPrivateFieldLooseBase(this,c)[c].dispatch("stickers/messages/set",[{messageId:e.temporaryId,...e.stickerParams}])}void babelHelpers.classPrivateFieldLooseBase(this,X)[X](e.dialogId);return babelHelpers.classPrivateFieldLooseBase(this,c)[c].dispatch("messages/add",e)}function Z(e){var a;const r=s.Type.isStringFilled(e.text);const t=s.Type.isArrayFilled((a=e.params)==null?void 0:a.FILE_ID);const i=s.Type.isPlainObject(e.stickerParams);if(r||t||i){void babelHelpers.classPrivateFieldLooseBase(this,c)[c].dispatch("recent/update",{id:e.dialogId,fields:{messageId:e.temporaryId}})}}function ee(e){const s={};if(e.replyId){s.replyId=e.replyId}if(e.forwardIds){s.forwardIds=e.forwardIds}if(e.text){s.message=e.text;s.templateId=e.temporaryId}if(e.copilot){s.copilot=e.copilot}if(e.aiAssistant){s.aiAssistant=e.aiAssistant}if(e.stickerParams){s.templateId=e.temporaryId;s.stickerParams=e.stickerParams}const a={dialogId:e.dialogId.toString(),fields:s};return i.runAction(o.RestMethod.imV2ChatMessageSend,{data:a})}function se(e){const{oldId:s,newId:a,dialogId:r}=e;void babelHelpers.classPrivateFieldLooseBase(this,c)[c].dispatch("messages/updateWithId",{id:s,fields:{id:a}});void babelHelpers.classPrivateFieldLooseBase(this,c)[c].dispatch("chats/update",{dialogId:r,fields:{lastId:a,lastMessageId:a}});void babelHelpers.classPrivateFieldLooseBase(this,c)[c].dispatch("recent/update",{id:r,fields:{messageId:a}});const t=babelHelpers.classPrivateFieldLooseBase(this,c)[c].getters["stickers/messages/isSticker"](s);if(t){void babelHelpers.classPrivateFieldLooseBase(this,c)[c].dispatch("stickers/messages/updateWithId",{oldId:s,newId:a})}}function ae(e){void babelHelpers.classPrivateFieldLooseBase(this,c)[c].dispatch("messages/update",{id:e,fields:{error:true}})}function re(e){void babelHelpers.classPrivateFieldLooseBase(this,c)[c].dispatch("messages/update",{id:e,fields:{sending:true,error:false}})}function te(e={}){const{force:s=false,dialogId:r}=e;a.EventEmitter.emit(o.EventType.dialog.scrollToBottom,{chatId:babelHelpers.classPrivateFieldLooseBase(this,M)[M](r).chatId,threshold:s?o.DialogScrollThreshold.none:o.DialogScrollThreshold.halfScreenUp})}function ie(e){return babelHelpers.classPrivateFieldLooseBase(this,c)[c].getters["chats/get"](e,true)}function le(e){return babelHelpers.classPrivateFieldLooseBase(this,c)[c].getters["chats/getByChatId"](e,true)}function oe(e){return babelHelpers.classPrivateFieldLooseBase(this,c)[c].getters["users/bots/isNetwork"](e)}function de(e){const{response:s,dialogId:a,commentMessage:r}=e;const{id:t,uuidMap:i}=s;if(t){babelHelpers.classPrivateFieldLooseBase(this,I)[I]({oldId:r.temporaryId,newId:t,dialogId:a})}Object.entries(i).forEach((([e,s])=>{babelHelpers.classPrivateFieldLooseBase(this,I)[I]({oldId:e,newId:s,dialogId:a})}))}function ce({commentMessage:e,forwardUuidMap:s}){if(e){void babelHelpers.classPrivateFieldLooseBase(this,c)[c].dispatch("messages/update",{id:e.temporaryId,fields:{error:true}})}Object.keys(s).forEach((e=>{void babelHelpers.classPrivateFieldLooseBase(this,c)[c].dispatch("messages/update",{id:e,fields:{error:true}})}))}function ne(e,s){const{forwardIds:a,dialogId:r}=e;if(a.length===0){return[]}const t=[];Object.entries(s).forEach((([e,s])=>{const a=babelHelpers.classPrivateFieldLooseBase(this,c)[c].getters["messages/getById"](s);if(!a){return}const i={...babelHelpers.classPrivateFieldLooseBase(this,h)[h]({dialogId:r,text:a.text,tempMessageId:e,replyId:a.replyId}),forward:babelHelpers.classPrivateFieldLooseBase(this,T)[T](s),attach:a.attach,isDeleted:a.isDeleted,files:a.files};const l=babelHelpers.classPrivateFieldLooseBase(this,c)[c].getters["stickers/messages/isSticker"](s);if(l){i.stickerParams=babelHelpers.classPrivateFieldLooseBase(this,c)[c].getters["stickers/messages/getStickerByMessageId"](s)}t.push(i)}));return t}function pe(e){const s=babelHelpers.classPrivateFieldLooseBase(this,c)[c].getters["messages/getById"](e);const a=babelHelpers.classPrivateFieldLooseBase(this,w)[w](s.chatId);const r=babelHelpers.classPrivateFieldLooseBase(this,c)[c].getters["messages/isForward"](e);const t=r?s.forward.userId:s.authorId;const i=r?s.forward.chatType:a.type;let l=r?s.forward.chatTitle:a.name;if(i===o.ChatType.channel){l=null}return{id:babelHelpers.classPrivateFieldLooseBase(this,x)[x](s.chatId,e),userId:t,chatType:i,chatTitle:l}}function be(e){const{dialogId:s,forwardUuidMap:a,commentMessage:r}=e;const t={dialogId:s,forwardIds:a};if(r){t.text=r.text;t.temporaryId=r.temporaryId}return t}function ve(e){const s=[];e.forEach((e=>{s.push(babelHelpers.classPrivateFieldLooseBase(this,F)[F](e))}));return Promise.all(s)}function he(e){const s={};e.forEach((e=>{s[r.Utils.text.getUuidV4()]=e}));return s}function ge(e,s){const a=babelHelpers.classPrivateFieldLooseBase(this,w)[w](e).dialogId;if(a.startsWith("chat")){return`${a}/${s}`}const r=l.Core.getUserId();return`${a}:${r}/${s}`}function Pe(e,s){e.forEach((e=>{console.error(`SendingService: ${s} error: code: ${e.code} message: ${e.message}`)}))}function ue(e){return babelHelpers.classPrivateFieldLooseBase(this,c)[c].dispatch("chats/clearLastMessageViews",{dialogId:e})}async function fe({forwardUuidMap:e,commentMessage:s,dialogId:a}){try{const r=babelHelpers.classPrivateFieldLooseBase(this,k)[k]({forwardUuidMap:e,commentMessage:s,dialogId:a});const i=await babelHelpers.classPrivateFieldLooseBase(this,y)[y](r);t.Logger.warn("SendingService: forwardMessage result -",i);babelHelpers.classPrivateFieldLooseBase(this,O)[O]({response:i,dialogId:a,commentMessage:s})}catch(a){babelHelpers.classPrivateFieldLooseBase(this,j)[j]({commentMessage:s,forwardUuidMap:e});babelHelpers.classPrivateFieldLooseBase(this,C)[C](a,"forwardMessage")}return Promise.resolve()}function Fe(e){const s=l.Core.getStore().getters["copilot/chats/isReasoningEnabled"](e);if(!s){return{}}return{copilot:{reasoning:"Y"}}}function Le(e){const s=l.Core.getStore().getters["users/bots/isAiAssistant"](e);if(!s){return{}}const a=l.Core.getStore().getters["aiAssistant/getMcpAuthId"];if(!a){return{}}return{aiAssistant:{mcpAuthId:a}}}$.instance=null;e.SendingService=$})(this.BX.Messenger.v2.Service=this.BX.Messenger.v2.Service||{},BX,BX.Event,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX.Messenger.v2.Application,BX.Messenger.v2.Const,BX.Messenger.v2.Service);
//# sourceMappingURL=sending.bundle.map.js