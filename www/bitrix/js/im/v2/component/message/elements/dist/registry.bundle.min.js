this.BX=this.BX||{};this.BX.Messenger=this.BX.Messenger||{};this.BX.Messenger.v2=this.BX.Messenger.v2||{};this.BX.Messenger.v2.Component=this.BX.Messenger.v2.Component||{};(function(t,e,s,i,n,r,a,o,c,l,m,d,u,h,g,p,v,I,C,b,S,_,M,y,f,E,T,w,R,A,x,B,U){"use strict";const P={name:"MessageStatus",props:{item:{type:Object,required:true},isOverlay:{type:Boolean,default:false}},computed:{message(){return this.item},formattedDate(){return e.DateFormatter.formatByCode(this.message.date,e.DateCode.shortTimeFormat)},isSelfMessage(){return this.message.authorId===I.Core.getUserId()},messageStatus(){if(this.message.error){return E.OwnMessageStatus.error}if(this.message.sending){return E.OwnMessageStatus.sending}if(this.message.viewedByOthers){return E.OwnMessageStatus.viewed}return E.OwnMessageStatus.sent}},methods:{loc(t){return this.$Bitrix.Loc.getMessage(t)}},template:`\n\t\t<div class="bx-im-message-status__container" :class="{'--overlay': isOverlay}">\n\t\t\t<div v-if="message.isEdited && !message.isDeleted" class="bx-im-message-status__edit-mark">\n\t\t\t\t{{ loc('IM_MESSENGER_MESSAGE_EDITED') }}\n\t\t\t</div>\n\t\t\t<div class="bx-im-message-status__date" :class="{'--overlay': isOverlay}">\n\t\t\t\t{{ formattedDate }}\n\t\t\t</div>\n\t\t\t<div v-if="isSelfMessage" :class="'--' + messageStatus" class="bx-im-message-status__icon"></div>\n\t\t</div>\n\t`};const N={name:"MessageAttach",components:{Attach:i.Attach},props:{item:{type:Object,required:true},dialogId:{type:String,required:true}},computed:{message(){return this.item},dialog(){return this.$store.getters["chats/get"](this.dialogId,true)},user(){return this.$store.getters["users/get"](this.dialogId,true)},dialogColor(){return this.dialog.type===E.ChatType.user?this.user.color:this.dialog.color}},created(){s.provide("message",this.message)},template:`\n\t\t<div v-for="config in message.attach" :key="config.id" class="bx-im-message-attach__container">\n\t\t\t<Attach :baseColor="dialogColor" :config="config" />\n\t\t</div>\n\t`};const F={name:"MessageKeyboard",components:{Keyboard:n.Keyboard},props:{item:{type:Object,required:true},dialogId:{type:String,required:true}},computed:{message(){return this.item},dialog(){return this.$store.getters["chats/get"](this.dialogId,true)},user(){return this.$store.getters["users/get"](this.dialogId,true)}},template:`\n\t\t<div class="bx-im-message-keyboard__container">\n\t\t\t<Keyboard :buttons="message.keyboard" :dialogId="dialogId" :messageId="message.id" />\n\t\t</div>\n\t`};const L={name:"ReactionUser",components:{ChatAvatar:T.ChatAvatar},props:{userId:{type:Number,required:true}},computed:{AvatarSize:()=>T.AvatarSize,user(){return this.$store.getters["users/get"](this.userId)},avatarStyle(){if(!this.user.avatar){return{}}return{backgroundImage:`url('${this.user.avatar}')`}}},template:`\n\t\t<div class="bx-im-reaction-list__user_avatar">\n\t\t\t<ChatAvatar \n\t\t\t\t:avatarDialogId="userId" \n\t\t\t\t:size="AvatarSize.XS" \n\t\t\t\t:withAvatarLetters="false"\n\t\t\t\t:withTooltip="false"\n\t\t\t/>\n\t\t</div>\n\t`};var k=babelHelpers.classPrivateFieldLooseKey("reaction");class O extends c.BaseUserService{constructor(t){super();Object.defineProperty(this,k,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,k)[k]=t}getRequestFilter(t=false){return{...super.getRequestFilter(t),reaction:babelHelpers.classPrivateFieldLooseBase(this,k)[k]}}getRestMethodName(){return E.RestMethod.imV2ChatMessageReactionTail}getLastId(t){const{reactions:e}=t;if(!e||e.length===0){return 0}const s=[...e].sort(((t,e)=>e.id-t.id));return s[s.length-1].id}}const $={components:{UserListPopup:o.UserListPopup},props:{messageId:{type:[String,Number],required:true},reaction:{type:String,required:true},show:{type:Boolean,required:true},bindElement:{type:Object,required:true}},emits:["close"],data(){return{showPopup:false,loadingAdditionalUsers:false,additionalUsers:[]}},watch:{show(t,e){if(!e&&t){this.showPopup=true;this.loadUsers()}}},methods:{async loadUsers(){this.loadingAdditionalUsers=true;try{this.additionalUsers=await this.getUserService().loadFirstPage(this.messageId);this.loadingAdditionalUsers=false}catch{this.loadingAdditionalUsers=false}},async onScroll(t){if(!v.Utils.dom.isOneScreenRemaining(t.target)||!this.getUserService().hasMoreItemsToLoad()){return}const e=await this.getUserService().loadNextPage(this.messageId);if(!e){return}this.additionalUsers=[...this.additionalUsers,...e]},onPopupClose(){this.showPopup=false;this.$emit("close")},prepareAdditionalUsers(t){const e=this.dialog.lastMessageViews.firstViewer.userId;return t.filter((t=>t!==I.Core.getUserId()&&t!==e))},getUserService(){if(!this.userService){this.userService=new O(this.reaction)}return this.userService}},template:`\n\t\t<UserListPopup\n\t\t\tid="bx-im-message-reaction-users"\n\t\t\t:showPopup="showPopup"\n\t\t\t:loading="loadingAdditionalUsers"\n\t\t\t:userIds="additionalUsers"\n\t\t\t:bindElement="bindElement || {}"\n\t\t\t:withAngle="false"\n\t\t\t:offsetLeft="-112"\n\t\t\t:forceTop="true"\n\t\t\t@close="onPopupClose"\n\t\t\t@scroll="onScroll"\n\t\t/>\n\t`};const D=5;const X=16;const q=500;const H={components:{ReactionUser:L,AdditionalUsers:$,Reaction:a.Reaction},props:{messageId:{type:[String,Number],required:true},type:{type:String,required:true},counter:{type:Number,required:true},users:{type:Array,required:true},selected:{type:Boolean,required:true},animate:{type:Boolean,required:true},showAvatars:{type:Boolean,required:false,default:true}},emits:["click","animationFinish"],data(){return{showAdditionalUsers:false}},computed:{REACTION_SIZE:()=>X,needToShowUsers(){if(!this.showAvatars){return false}const t=this.counter<=D;const e=this.counter===this.users.length;return t&&e},preparedUsers(){return[...this.users].sort(((t,e)=>e-t))}},methods:{startShowUsersTimer(){this.showUsersTimeout=setTimeout((()=>{this.showAdditionalUsers=true}),q)},clearShowUsersTimer(){clearTimeout(this.showUsersTimeout)},onClick(){this.clearShowUsersTimer();this.$emit("click")}},template:`\n\t\t<div\n\t\t\t@click="onClick" \n\t\t\t@mouseenter="startShowUsersTimer"\n\t\t\t@mouseleave="clearShowUsersTimer"\n\t\t\tclass="bx-im-reaction-list__item"\n\t\t\t:class="{'--selected': selected}"\n\t\t>\n\t\t\t<div class="bx-im-reaction-list__item_icon">\n\t\t\t\t<Reaction\n\t\t\t\t\t:size="REACTION_SIZE"\n\t\t\t\t\t:name="type"\n\t\t\t\t\t:animate="animate"\n\t\t\t\t\t@animationFinish="$emit('animationFinish')"\n\t\t\t\t/>\n\t\t\t</div>\n\t\t\t<div v-if="needToShowUsers" class="bx-im-reaction-list__user_container" ref="users">\n\t\t\t\t<TransitionGroup name="bx-im-reaction-list__user_animation">\n\t\t\t\t\t<ReactionUser \n\t\t\t\t\t\tv-for="user in preparedUsers" \n\t\t\t\t\t\t:key="type + user" \n\t\t\t\t\t\t:userId="user"\n\t\t\t\t\t/>\n\t\t\t\t</TransitionGroup>\n\t\t\t</div>\n\t\t\t<div v-else class="bx-im-reaction-list__item_counter" ref="counter">{{ counter }}</div>\n\t\t\t<AdditionalUsers\n\t\t\t\t:show="showAdditionalUsers"\n\t\t\t\t:bindElement="$refs['users'] || $refs['counter'] || {}"\n\t\t\t\t:messageId="messageId"\n\t\t\t\t:reaction="type"\n\t\t\t\t@close="showAdditionalUsers = false"\n\t\t\t/>\n\t\t</div>\n\t`};class G{setReaction(t,e){l.Logger.warn("ReactionService: setReaction",t,e);const s={data:{messageId:t,reaction:e}};const i=g.FeatureManager.isFeatureAvailable(g.Feature.reactionsV2Available);void I.Core.getStore().dispatch("messages/reactions/setReaction",{messageId:t,reaction:e,userId:I.Core.getUserId(),withReplace:!i});m.runAction(E.RestMethod.imV2ChatMessageReactionAdd,s).catch((([t])=>{console.error("ReactionService: error setting reaction",t)}))}removeReaction(t,e){l.Logger.warn("ReactionService: removeReaction",t,e);const s={data:{messageId:t,reaction:e}};void I.Core.getStore().dispatch("messages/reactions/removeReaction",{messageId:t,reaction:e,userId:I.Core.getUserId()});m.runAction(E.RestMethod.imV2ChatMessageReactionDelete,s).catch((([t])=>{console.error("ReactionService: error removing reaction",t)}))}}const j={name:"ReactionList",components:{ReactionItem:H},props:{messageId:{type:[String,Number],required:true}},data(){return{reactionsToAnimate:new Set}},computed:{message(){return this.$store.getters["messages/getById"](this.messageId)},dialog(){return this.$store.getters["chats/getByChatId"](this.message.chatId)},reactionsData(){return this.$store.getters["messages/reactions/getByMessageId"](this.messageId)},reactionCounters(){var t,e;return(t=(e=this.reactionsData)==null?void 0:e.reactionCounters)!=null?t:{}},ownReactions(){var t,e;return(t=(e=this.reactionsData)==null?void 0:e.ownReactions)!=null?t:new Set},reactionListToShow(){return Object.keys(h.ReactionName).filter((t=>Boolean(this.reactionCounters[t])))},needToShowReactionsContainer(){return Object.keys(this.reactionCounters).length>0},isChannel(){return U.ChannelManager.isChannel(this.dialog.dialogId)},showAvatars(){return!this.isChannel}},watch:{reactionCounters(t,e){const s=Object.keys(t);const i=Object.keys(e);for(const t of s){if(!i.includes(t)){this.reactionsToAnimate.add(t)}}},needToShowReactionsContainer(t,e){if(!e&&t){r.EventEmitter.emit(E.EventType.dialog.scrollToBottom,{chatId:this.message.chatId,threshold:E.DialogScrollThreshold.nearTheBottom,animation:false})}}},mounted(){const t=500;this.getEmitter().setMaxListeners(E.EventType.reaction.onReactionSelected,t);this.getEmitter().subscribe(E.EventType.reaction.onReactionSelected,this.onPickerReactionSelected)},beforeUnmount(){this.getEmitter().unsubscribe(E.EventType.reaction.onReactionSelected,this.onPickerReactionSelected)},methods:{onReactionClick(t){const e=w.PermissionManager.getInstance();if(!e.canPerformActionByRole(E.ActionByRole.setReaction,this.dialog.dialogId)){return}if(this.ownReactions.has(t)){this.getReactionService().removeReaction(this.messageId,t);return}this.reactionsToAnimate.add(t);this.getReactionService().setReaction(this.messageId,t)},async onPickerReactionSelected(t){const{messageId:e,reaction:s}=t.getData();if(this.messageId!==e){return}this.onReactionClick(s)},getReactionUsers(t){const e=this.reactionsData.reactionUsers[t];if(!e){return[]}return[...e]},getReactionService(){if(!this.reactionService){this.reactionService=new G}return this.reactionService},getEmitter(){return this.$Bitrix.eventEmitter}},template:`\n\t\t<div v-if="needToShowReactionsContainer" class="bx-im-reaction-list__container bx-im-reaction-list__scope">\n\t\t\t<ReactionItem\n\t\t\t\tv-for="reactionType in reactionListToShow"\n\t\t\t\t:key="reactionType + messageId"\n\t\t\t\t:messageId="messageId"\n\t\t\t\t:type="reactionType"\n\t\t\t\t:counter="reactionCounters[reactionType]"\n\t\t\t\t:users="getReactionUsers(reactionType)"\n\t\t\t\t:selected="ownReactions.has(reactionType)"\n\t\t\t\t:animate="reactionsToAnimate.has(reactionType)"\n\t\t\t\t:showAvatars="showAvatars"\n\t\t\t\t@click="onReactionClick(reactionType)"\n\t\t\t\t@animationFinish="reactionsToAnimate.delete(reactionType)"\n\t\t\t/>\n\t\t</div>\n\t`};const K=250;const W=500;const z={name:"ReactionSelector",props:{messageId:{type:[String,Number],required:true}},computed:{message(){return this.$store.getters["messages/getById"](this.messageId)},dialog(){return this.$store.getters["chats/getByChatId"](this.message.chatId)},reactionsData(){return this.$store.getters["messages/reactions/getByMessageId"](this.messageId)},ownReactions(){var t,e;return(t=(e=this.reactionsData)==null?void 0:e.ownReactions)!=null?t:new Set},ownPlainLikeSet(){return this.ownReactions.has(h.ReactionName.like)},isChatWithBot(){const t=this.$store.getters["users/get"](this.dialog.dialogId);return(t==null?void 0:t.type)===E.UserType.bot},areBotReactionsEnabled(){const t=this.$store.getters["users/bots/getByUserId"](this.message.authorId);if(!t){return false}return t.reactionsEnabled},hasError(){return this.message.error},isRealMessage(){return this.$store.getters["messages/isRealMessage"](this.messageId)},canSetReactions(){if(!this.isRealMessage||!this.canSetReactionsByRole||this.hasError){return false}if(this.isChatWithBot){return this.areBotReactionsEnabled}return true},canSetReactionsByRole(){const t=w.PermissionManager.getInstance();return t.canPerformActionByRole(E.ActionByRole.setReaction,this.dialog.dialogId)}},methods:{startShowTimer(){var t;this.clearHideTimer();if((t=this.selector)!=null&&t.isShown()){return}this.showTimeout=setTimeout((()=>{this.showSelector()}),K)},clearShowTimer(){clearTimeout(this.showTimeout);this.startHideTimer()},showSelector(){if(g.FeatureManager.isFeatureAvailable(g.Feature.reactionsV2Available)){this.selector=new u.ReactionPicker({target:this.$refs.selector})}else{this.selector=new d.ReactionsSelect({name:"im-base-message-reaction-selector",position:this.$refs.selector})}this.subscribeToSelectorEvents();this.selector.show()},subscribeToSelectorEvents(){this.selector.subscribe("select",(t=>{var e;const{reaction:s}=t.getData();this.getEmitter().emit(E.EventType.reaction.onReactionSelected,{messageId:this.messageId,reaction:s});(e=this.selector)==null?void 0:e.hide()}));this.selector.subscribe("mouseleave",this.startHideTimer);this.selector.subscribe("mouseenter",(()=>{clearTimeout(this.hideTimeout)}));this.selector.subscribe("hide",(()=>{clearTimeout(this.hideTimeout);this.selector=null}))},startHideTimer(){this.hideTimeout=setTimeout((()=>{var t;(t=this.selector)==null?void 0:t.hide()}),W)},clearHideTimer(){clearTimeout(this.hideTimeout)},onIconClick(){this.clearShowTimer();this.getEmitter().emit(E.EventType.reaction.onReactionSelected,{messageId:this.messageId,reaction:h.ReactionName.like})},getEmitter(){return this.$Bitrix.eventEmitter}},template:`\n\t\t<div v-if="canSetReactions" class="bx-im-reaction-selector__container">\n\t\t\t<div\n\t\t\t\t@click="onIconClick"\n\t\t\t\t@mouseenter="startShowTimer"\n\t\t\t\t@mouseleave="clearShowTimer"\n\t\t\t\tclass="bx-im-reaction-selector__selector"\n\t\t\t\tref="selector"\n\t\t\t>\n\t\t\t\t<div class="bx-im-reaction-selector__icon" :class="{'--active': ownPlainLikeSet}"></div>\n\t\t\t</div>\n\t\t</div>\n\t`};const V="none";const Y={name:"ReplyComponent",props:{dialogId:{type:String,required:true},replyId:{type:Number,required:true},isForward:{type:Boolean,default:false}},computed:{dialog(){return this.$store.getters["chats/get"](this.dialogId,true)},replyMessage(){return this.$store.getters["messages/getById"](this.replyId)},replyMessageChat(){var t;return this.$store.getters["chats/getByChatId"]((t=this.replyMessage)==null?void 0:t.chatId)},replyAuthor(){return this.$store.getters["users/get"](this.replyMessage.authorId)},replyTitle(){return this.replyAuthor?this.replyAuthor.name:this.loc("IM_DIALOG_CHAT_QUOTE_DEFAULT_TITLE")},replyText(){let t=x.Parser.prepareQuote(this.replyMessage);t=x.Parser.decodeText(t);return t},isQuoteFromTheSameChat(){var t;return((t=this.replyMessage)==null?void 0:t.chatId)===this.dialog.chatId},replyContext(){if(!this.isQuoteFromTheSameChat){return V}if(!this.isForward){return`${this.dialogId}/${this.replyId}`}return`${this.replyMessageChat.dialogId}/${this.replyId}`},canShowReply(){return!B.Type.isNil(this.replyMessage)}},methods:{loc(t){return this.$Bitrix.Loc.getMessage(t)}},template:`\n\t\t<div v-if="canShowReply" class="bx-im-message-quote" :data-context="replyContext">\n\t\t\t<div class="bx-im-message-quote__wrap">\n\t\t\t\t<div class="bx-im-message-quote__name">\n\t\t\t\t\t<div class="bx-im-message-quote__name-text">{{ replyTitle }}</div>\n\t\t\t\t</div>\n\t\t\t\t<div class="bx-im-message-quote__text" v-html="replyText"></div>\n\t\t\t</div>\n\t\t</div>\n\t`};const Q={name:"AuthorTitle",components:{MessageAuthorTitle:p.MessageAuthorTitle},props:{item:{type:Object,required:true}},computed:{message(){return this.item},dialog(){return this.$store.getters["chats/getByChatId"](this.message.chatId)},user(){return this.$store.getters["users/get"](this.message.authorId,true)},isSystemMessage(){return this.message.authorId===0},isSelfMessage(){return this.message.authorId===I.Core.getUserId()},isUserChat(){return this.dialog.type===E.ChatType.user&&!this.isBotWithFakeAuthorNames},isBotWithFakeAuthorNames(){return this.isSupportBot||this.isNetworkBot},isNetworkBot(){return this.$store.getters["users/bots/isNetwork"](this.dialog.dialogId)},isSupportBot(){return this.$store.getters["users/bots/isSupport"](this.dialog.dialogId)},showTitle(){return!this.isSystemMessage&&!this.isSelfMessage&&!this.isUserChat},authorDialogId(){if(this.message.authorId){return this.message.authorId.toString()}return this.dialogId},isCopilot(){const t=Number.parseInt(this.authorDialogId,10);return this.$store.getters["users/bots/isCopilot"](t)}},methods:{onAuthorNameClick(){const t=Number.parseInt(this.authorDialogId,10);if(!t||t===I.Core.getUserId()||this.isCopilot){return}this.getEmitter().emit(E.EventType.textarea.insertMention,{mentionText:this.user.name,mentionReplacement:v.Utils.text.getMentionBbCode(this.user.id,this.user.name),dialogId:this.dialog.dialogId})},getEmitter(){return this.$Bitrix.eventEmitter}},template:`\n\t\t<div \n\t\t\tv-if="showTitle" \n\t\t\t@click="onAuthorNameClick" \n\t\t\tclass="bx-im-message-author-title__container" \n\t\t\t:class="{'--clickable': !isCopilot}"\n\t\t>\n\t\t\t<MessageAuthorTitle\n\t\t\t\t:dialogId="authorDialogId"\n\t\t\t\t:messageId="message.id"\n\t\t\t\t:showItsYou="false"\n\t\t\t\t:withColor="true"\n\t\t\t\t:withLeftIcon="!isCopilot"\n\t\t\t/>\n\t\t</div>\n\t`};const Z={name:"ContextMenu",props:{dialogId:{type:String,required:true},message:{type:Object,required:true},showContextMenu:{type:Boolean,default:true}},computed:{menuTitle(){return this.$Bitrix.Loc.getMessage("IM_MESSENGER_MESSAGE_MENU_TITLE",{"#SHORTCUT#":v.Utils.platform.isMac()?"CMD":"CTRL"})},messageItem(){return this.message},messageHasError(){return this.messageItem.error},canShowContextMenu(){return this.showContextMenu&&!this.messageHasError},isBulkActionsMode(){return this.$store.getters["messages/select/isBulkActionsModeActive"](this.dialogId)}},methods:{onMenuClick(t){this.getEmitter().emit(E.EventType.dialog.onClickMessageContextMenu,{message:this.message,dialogId:this.dialogId,bindElement:t.currentTarget,event:t})},getEmitter(){return this.$Bitrix.eventEmitter}},template:`\n\t\t<template v-if="!isBulkActionsMode">\n\t\t\t<div v-if="canShowContextMenu" class="bx-im-message-context-menu__container bx-im-message-context-menu__scope">\n\t\t\t\t<button\n\t\t\t\t\t:title="menuTitle"\n\t\t\t\t\t@click="onMenuClick"\n\t\t\t\t\t@contextmenu.prevent\n\t\t\t\t\tclass="bx-im-message-context-menu__button"\n\t\t\t\t></button>\n\t\t\t</div>\n\t\t\t<div v-else class="bx-im-message-base__context-menu-placeholder"></div>\n\t\t</template>\n\t`};var J=babelHelpers.classPrivateFieldLooseKey("isOwnMessage");var tt=babelHelpers.classPrivateFieldLooseKey("hasError");var et=babelHelpers.classPrivateFieldLooseKey("hasFiles");var st=babelHelpers.classPrivateFieldLooseKey("retrySend");var it=babelHelpers.classPrivateFieldLooseKey("retrySendMessage");class nt extends C.BaseMenu{constructor(){super();Object.defineProperty(this,it,{value:lt});Object.defineProperty(this,st,{value:ct});Object.defineProperty(this,et,{value:ot});Object.defineProperty(this,tt,{value:at});Object.defineProperty(this,J,{value:rt});this.id="bx-im-message-retry-context-menu"}getMenuItems(){return[this.getRetryItem(),this.getDeleteItem()]}getRetryItem(){if(!babelHelpers.classPrivateFieldLooseBase(this,J)[J]()||!babelHelpers.classPrivateFieldLooseBase(this,tt)[tt]()){return null}return{title:B.Loc.getMessage("IM_MESSENGER_MESSAGE_CONTEXT_MENU_RETRY"),onClick:()=>{babelHelpers.classPrivateFieldLooseBase(this,st)[st]();this.menuInstance.close()}}}getDeleteItem(){if(!babelHelpers.classPrivateFieldLooseBase(this,J)[J]()||!babelHelpers.classPrivateFieldLooseBase(this,tt)[tt]()){return null}return{title:B.Loc.getMessage("IM_MESSENGER_MESSAGE_CONTEXT_MENU_DELETE"),design:M.MenuItemDesign.Alert,onClick:()=>{const t=new S.MessageService({chatId:this.context.chatId});t.deleteMessages([this.context.id]);this.menuInstance.close()}}}}function rt(){return this.context.authorId===I.Core.getUserId()}function at(){return this.context.error}function ot(){return this.context.files.length>0}function ct(){if(babelHelpers.classPrivateFieldLooseBase(this,et)[et]()){const t=_.UploadingService.getInstance();const e=t.getUploaderIdByFileId(this.context.files[0]);t.retry(e);return}babelHelpers.classPrivateFieldLooseBase(this,it)[it]()}function lt(){void(new b.SendingService).retrySendMessage({tempMessageId:this.context.id,dialogId:this.context.dialogId})}const mt={name:"RetryButton",props:{message:{type:Object,required:true},dialogId:{type:String,required:true}},computed:{messageItem(){return this.message},menuTitle(){return this.$Bitrix.Loc.getMessage("IM_MESSENGER_MESSAGE_CONTEXT_MENU_RETRY")}},created(){this.contextMenu=new nt},methods:{onClick(t){const e={dialogId:this.dialogId,...this.messageItem};this.contextMenu.openMenu(e,t.currentTarget)}},template:`\n\t\t<div class="bx-im-message-retry-button__container bx-im-message-retry-button__scope">\n\t\t\t<button\n\t\t\t\t:title="menuTitle"\n\t\t\t\t@click="onClick"\n\t\t\t\tclass="bx-im-message-retry-button__arrow"\n\t\t\t></button>\n\t\t</div>\n\t`};const dt=20;const ut={name:"MessageHeader",components:{AuthorTitle:Q,BIcon:y.BIcon},props:{item:{type:Object,required:true},withTitle:{type:Boolean,default:false},isOverlay:{type:Boolean,default:false}},computed:{OutlineIcons:()=>y.Outline,Color:()=>E.Color,FORWARD_ICON_SIZE:()=>dt,message(){return this.item},forwardAuthorId(){return this.message.forward.userId},forwardContextId(){return this.message.forward.id},isForwarded(){return this.$store.getters["messages/isForward"](this.message.id)},isChannelForward(){return U.ChannelManager.channelTypes.has(this.message.forward.chatType)},forwardAuthorName(){const t=new f.CopilotManager;if(t.isCopilotBot(this.forwardAuthorId)){const e=this.forwardContextId.split("/")[1];return t.getName({dialogId:this.forwardAuthorId,messageId:e})}return this.$store.getters["users/get"](this.forwardAuthorId,true).name},forwardChatName(){var t;return(t=this.message.forward.chatTitle)!=null?t:this.loc("IM_MESSENGER_MESSAGE_HEADER_FORWARDED_CLOSED_CHANNEL")},isSystemMessage(){return this.message.forward.userId===0},forwardAuthorTitle(){return B.Loc.getMessage("IM_MESSENGER_MESSAGE_HEADER_FORWARDED_FROM_CHAT",{"[user_name]":'<span class="bx-im-message-header__author-name">',"#USER_NAME#":B.Text.encode(this.forwardAuthorName),"[/user_name]":"</span>"})},forwardChannelTitle(){return B.Loc.getMessage("IM_MESSENGER_MESSAGE_HEADER_FORWARDED_FROM_CHANNEL",{"[user_name]":'<span class="bx-im-message-header__author-name">',"#USER_NAME#":B.Text.encode(this.forwardAuthorName),"[/user_name]":"</span>","[channel_name]":'<span class="bx-im-message-header__author-name">',"#CHANNEL_NAME#":B.Text.encode(this.forwardChatName),"[/channel_name]":"</span>"})},iconColor(){return this.isOverlay?E.Color.white:E.Color.blue60}},methods:{onForwardClick(){const t=x.Parser.getContextCodeFromForwardId(this.forwardContextId);if(t.length===0){return}const[e,s]=t.split("/");this.getEmitter().emit(E.EventType.dialog.goToMessageContext,{messageId:Number.parseInt(s,10),dialogId:e.toString()})},getEmitter(){return this.$Bitrix.eventEmitter},loc(t){return this.$Bitrix.Loc.getMessage(t)}},template:`\n\t\t<div \n\t\t\tv-if="isForwarded" \n\t\t\t:class="{'--overlay': isOverlay}"\n\t\t\tclass="bx-im-message-header__container" \n\t\t\t@click="onForwardClick"\n\t\t>\n\t\t\t<BIcon\n\t\t\t\t:name="OutlineIcons.FORWARD"\n\t\t\t\t:color="iconColor"\n\t\t\t\t:size="FORWARD_ICON_SIZE"\n\t\t\t/>\n\t\t\t<span v-if="isSystemMessage" class="--ellipsis">\n\t\t\t\t{{ loc('IM_MESSENGER_MESSAGE_HEADER_FORWARDED_FROM_SYSTEM')}}\n\t\t\t</span>\n\t\t\t<span v-else-if="isChannelForward" v-html="forwardChannelTitle" class="--ellipsis"></span>\n\t\t\t<span v-else v-html="forwardAuthorTitle" class="--ellipsis"></span>\n\t\t</div>\n\t\t<AuthorTitle v-else-if="withTitle" :item="item" />\n\t`};const ht={name:"CommentsPanel",components:{ChatAvatar:T.ChatAvatar,FadeAnimation:R.FadeAnimation},props:{item:{type:Object,required:true},dialogId:{type:String,required:true}},computed:{AvatarSize:()=>T.AvatarSize,dialog(){return this.$store.getters["chats/get"](this.dialogId)},message(){return this.item},commentInfo(){return this.$store.getters["messages/comments/getByMessageId"](this.message.id)},commentsChatId(){return this.commentInfo.chatId},commentsCount(){if(this.commentInfo.messageCount>0){return this.commentInfo.messageCount-1}return this.commentInfo.messageCount},commentsCountText(){return B.Loc.getMessagePlural("IM_MESSAGE_COMMENTS_PANEL_COMMENT_COUNT",this.commentsCount,{"#COUNT#":this.commentsCount})},noComments(){return this.commentsCount===0},lastUsers(){return[...this.commentInfo.lastUserIds].map((t=>this.$store.getters["users/get"](t))).reverse()},unreadCount(){const t=this.$store.getters["counters/getSpecificCommentsCounter"]({channelId:this.dialog.chatId,commentChatId:this.commentsChatId});if(!t){return""}return`+${t}`},isSubscribed(){return this.$store.getters["messages/comments/isUserSubscribed"](this.message.id)},showSubscribeIcon(){const t=w.PermissionManager.getInstance();return t.canPerformActionByRole(E.ActionByRole.subscribeToComments,this.dialogId)},subscribeIconTitle(){if(this.isSubscribed){return this.loc("IM_MESSAGE_COMMENTS_PANEL_ICON_UNSUBSCRIBE")}return this.loc("IM_MESSAGE_COMMENTS_PANEL_ICON_SUBSCRIBE")}},methods:{onCommentsClick(){const t=w.PermissionManager.getInstance();if(!t.canPerformActionByRole(E.ActionByRole.openComments,this.dialogId)){return}this.getEmitter().emit(E.EventType.dialog.openComments,{messageId:this.message.id})},onSubscribeIconClick(){if(this.isSubscribed){A.CommentsService.unsubscribe(this.message.id);return}A.CommentsService.subscribe(this.message.id)},getEmitter(){return this.$Bitrix.eventEmitter},loc(t){return this.$Bitrix.Loc.getMessage(t)}},template:`\n\t\t<slot :totalCount="commentsCount" :unreadCount="unreadCount" :onCommentsClick="onCommentsClick">\n\t\t\t<div class="bx-im-message-comments-panel__container" @click="onCommentsClick">\n\t\t\t\t<div class="bx-im-message-comments-panel__left">\n\t\t\t\t\t<div v-if="noComments" class="bx-im-message-comments-panel__empty_container">\n\t\t\t\t\t\t<div class="bx-im-message-comments-panel__empty_icon"></div>\n\t\t\t\t\t\t<div class="bx-im-message-comments-panel__text">{{ loc('IM_MESSAGE_COMMENTS_PANEL_EMPTY_TEXT') }}</div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div v-else class="bx-im-message-comments-panel__meta_container">\n\t\t\t\t\t\t<div class="bx-im-message-comments-panel__user_container">\n\t\t\t\t\t\t\t<TransitionGroup name="bx-im-message-comments-panel__user_animation">\n\t\t\t\t\t\t\t\t<div v-for="(user, index) in lastUsers" :key="user.id" class="bx-im-message-comments-panel__user_avatar" :class="'--image-' + (index + 1)">\n\t\t\t\t\t\t\t\t\t<ChatAvatar\n\t\t\t\t\t\t\t\t\t\t:avatarDialogId="user.id"\n\t\t\t\t\t\t\t\t\t\t:contextDialogId="dialogId"\n\t\t\t\t\t\t\t\t\t\t:size="AvatarSize.S"\n\t\t\t\t\t\t\t\t\t\t:withTooltip="false"\n\t\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t</TransitionGroup>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div class="bx-im-message-comments-panel__text">{{ commentsCountText }}</div>\n\t\t\t\t\t\t<FadeAnimation :duration="200">\n\t\t\t\t\t\t\t<div v-if="unreadCount" class="bx-im-message-comments-panel__unread-counter">{{ unreadCount }}</div>\n\t\t\t\t\t\t</FadeAnimation>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t<div v-if="showSubscribeIcon" :title="subscribeIconTitle" class="bx-im-message-comments-panel__right">\n\t\t\t\t\t<div\n\t\t\t\t\t\t@click.stop="onSubscribeIconClick"\n\t\t\t\t\t\tclass="bx-im-message-comments-panel__subscribe-icon"\n\t\t\t\t\t\t:class="{'--active': isSubscribed}"\n\t\t\t\t\t></div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</slot>\n\t`};const gt={name:"MessageFooter",components:{CommentsPanel:ht},props:{item:{type:Object,required:true},dialogId:{type:String,required:true}},data(){return{}},computed:{dialog(){return this.$store.getters["chats/get"](this.dialogId)},message(){return this.item},isChannelPost(){return U.ChannelManager.isChannel(this.dialogId)},isSystemMessage(){return this.message.authorId===0},showCommentsPanel(){return this.isChannelPost&&!this.isSystemMessage}},template:`\n\t\t<CommentsPanel v-if="showCommentsPanel" :dialogId="dialogId" :item="item" />\n\t`};const pt={name:"DefaultMessageContent",components:{MessageStatus:P,MessageAttach:N,ReactionList:j,Reply:Y},props:{item:{type:Object,required:true},dialogId:{type:String,required:true},withMessageStatus:{type:Boolean,default:true},withText:{type:Boolean,default:true},withAttach:{type:Boolean,default:true}},computed:{message(){return this.item},isReply(){return this.message.replyId!==0},formattedText(){return x.Parser.decodeMessage(this.item)},canSetReactions(){return B.Type.isNumber(this.message.id)},isForward(){return this.$store.getters["messages/isForward"](this.message.id)}},template:`\n\t\t<div class="bx-im-message-default-content__container bx-im-message-default-content__scope" :class="{'--no-text': !withText}">\n\t\t\t<Reply v-if="isReply" :dialogId="dialogId" :replyId="message.replyId" :isForward="isForward" />\n\t\t\t<div v-if="withText" class="bx-im-message-default-content__text" v-html="formattedText"></div>\n\t\t\t<div v-if="withAttach && message.attach.length > 0" class="bx-im-message-default-content__attach">\n\t\t\t\t<MessageAttach :item="message" :dialogId="dialogId" />\n\t\t\t</div>\n\t\t\t<div class="bx-im-message-default-content__bottom-panel">\n\t\t\t\t<ReactionList \n\t\t\t\t\tv-if="canSetReactions" \n\t\t\t\t\t:messageId="message.id" \n\t\t\t\t\tclass="bx-im-message-default-content__reaction-list" \n\t\t\t\t/>\n\t\t\t\t<div v-if="withMessageStatus" class="bx-im-message-default-content__status-container">\n\t\t\t\t\t<MessageStatus :item="message" />\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</div>\n\t`};const vt={name:"CompactCommentsPanel",components:{CommentsPanel:ht},props:{item:{type:Object,required:true},dialogId:{type:String,required:true}},computed:{dialog(){return this.$store.getters["chats/get"](this.dialogId)},message(){return this.item},isChannelPost(){return U.ChannelManager.isChannel(this.dialogId)},isSystemMessage(){return this.message.authorId===0},showCommentsPanel(){return this.isChannelPost&&!this.isSystemMessage}},methods:{hasComments(t){return t>0},hasUnreadComments(t){return B.Type.isStringFilled(t)}},template:`\n\t\t<CommentsPanel \n\t\t\tv-if="showCommentsPanel"\n\t\t\tv-slot="{ onCommentsClick, totalCount, unreadCount }"\n\t\t\t:item="item"\n\t\t\t:dialogId="dialogId"\n\t\t>\n\t\t\t<div \n\t\t\t\t:class="{'--has-comments': hasComments(totalCount)}"\n\t\t\t\tclass="bx-im-message-compact-comments-panel__container"\n\t\t\t\t@click="onCommentsClick"\n\t\t\t>\n\t\t\t\t<div class="bx-im-message-compact-comments-panel__icon"></div>\n\t\t\t\t<div v-if="hasComments(totalCount)" class="bx-im-message-compact-comments-panel__counter-container">\n\t\t\t\t\t<div class="bx-im-message-compact-comments-panel__total-counter">\n\t\t\t\t\t\t{{ totalCount }}\n\t\t\t\t\t</div>\n\t\t\t\t\t<div v-if="hasUnreadComments(unreadCount)" class="bx-im-message-compact-comments-panel__unread-counter">\n\t\t\t\t\t\t{{ unreadCount }}\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</CommentsPanel>\n\t`};t.MessageStatus=P;t.MessageAttach=N;t.MessageKeyboard=F;t.ReactionList=j;t.ReactionSelector=z;t.Reply=Y;t.AuthorTitle=Q;t.ContextMenu=Z;t.RetryButton=mt;t.MessageHeader=ut;t.MessageFooter=gt;t.DefaultMessageContent=pt;t.CompactCommentsPanel=vt})(this.BX.Messenger.v2.Component.Message=this.BX.Messenger.v2.Component.Message||{},BX.Messenger.v2.Lib,BX.Vue3,BX.Messenger.v2.Component.Elements,BX.Messenger.v2.Component.Elements,BX.Event,BX.UI.Reaction.Item.Vue,BX.Messenger.v2.Component.Elements,BX.Messenger.v2.Service,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX.Ui,BX.UI.Reaction.Picker,BX.UI.Reaction.Item,BX.Messenger.v2.Lib,BX.Messenger.v2.Component.Elements,BX.Messenger.v2.Lib,BX.Messenger.v2.Application,BX.Messenger.v2.Lib,BX.Messenger.v2.Service,BX.Messenger.v2.Service,BX.Messenger.v2.Service,BX.UI.System,BX.UI.IconSet,BX.Messenger.v2.Lib,BX.Messenger.v2.Const,BX.Messenger.v2.Component.Elements,BX.Messenger.v2.Lib,BX.Messenger.v2.Component.Animation,BX.Messenger.v2.Service,BX.Messenger.v2.Lib,BX,BX.Messenger.v2.Lib);
//# sourceMappingURL=registry.bundle.map.js