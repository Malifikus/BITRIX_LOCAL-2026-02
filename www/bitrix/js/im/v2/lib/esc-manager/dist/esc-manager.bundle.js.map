{"version":3,"file":"esc-manager.bundle.js","sources":["../src/esc-manager.js"],"sourcesContent":["import { Event } from 'main.core';\nimport { EventEmitter } from 'main.core.events';\nimport { PopupWindowManager } from 'main.popup';\nimport { SidePanel } from 'main.sidepanel';\n\nimport { Utils } from 'im.v2.lib.utils';\nimport { CallManager } from 'im.v2.lib.call';\nimport { Core } from 'im.v2.application.core';\nimport { EventType, Layout } from 'im.v2.const';\nimport { LayoutManager } from 'im.v2.lib.layout';\nimport { MessengerSlider } from 'im.v2.lib.slider';\nimport { DesktopManager } from 'im.v2.lib.desktop';\nimport { DesktopApi } from 'im.v2.lib.desktop-api';\n\nimport type { ApplicationContext } from 'im.v2.const';\n\nexport const EscEventAction = Object.freeze({\n\thandled: 'handled',\n\tignored: 'ignored',\n});\n\nexport class EscManager\n{\n\t#messengerContainer: HTMLElement;\n\t#emitter: EventEmitter;\n\t#wasKeyDownHandled: boolean = false;\n\n\tstatic #instance: EscManager;\n\n\tconstructor()\n\t{\n\t\tthis.keyUpEventHandler = this.#onKeyUp.bind(this);\n\t\tthis.keyDownEventHandler = this.#onKeyDown.bind(this);\n\t}\n\n\tstatic getInstance(): EscManager\n\t{\n\t\tEscManager.#instance = EscManager.#instance ?? new EscManager();\n\n\t\treturn EscManager.#instance;\n\t}\n\n\tregister(payload: { messengerContainer: HTMLElement, context: ApplicationContext })\n\t{\n\t\tconst { messengerContainer, context: { emitter } } = payload;\n\t\tthis.#emitter = emitter;\n\t\tthis.#messengerContainer = messengerContainer;\n\n\t\tEvent.bind(document, 'keyup', this.keyUpEventHandler);\n\t\tEvent.bind(document, 'keydown', this.keyDownEventHandler);\n\t}\n\n\tunregister()\n\t{\n\t\tEvent.unbind(document, 'keyup', this.keyUpEventHandler);\n\t\tEvent.unbind(document, 'keydown', this.keyDownEventHandler);\n\t}\n\n\tasync handleEsc(): Promise\n\t{\n\t\tif (this.#wasKeyDownHandled)\n\t\t{\n\t\t\tthis.#wasKeyDownHandled = false;\n\n\t\t\treturn;\n\t\t}\n\n\t\tif (this.#shouldIgnoreEscape())\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tif (await this.#isHandledBySubscriber())\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tif (this.#handleActiveInput())\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tif (this.#handleChannelComments())\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tif (this.#handleLayoutClear())\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tif (this.#handleMessengerSliderClose())\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tthis.#handleDesktopAction();\n\t}\n\n\t#shouldIgnoreEscape(): boolean\n\t{\n\t\tconst hasVisibleCall = CallManager.getInstance().hasVisibleCall();\n\t\t// popups have their own escape handling\n\t\tconst isAnyPopupShown = PopupWindowManager.isAnyPopupShown();\n\n\t\treturn hasVisibleCall || isAnyPopupShown || this.#isExternalSliderOpened();\n\t}\n\n\tasync #isHandledBySubscriber(): Promise<boolean>\n\t{\n\t\tconst eventResult = await this.#emitter.emitAsync(EventType.key.onBeforeEscape);\n\t\tconst globalEventResult = await EventEmitter.emitAsync(EventType.key.onBeforeEscape);\n\n\t\tconst mergedEventResult = [...eventResult, ...globalEventResult];\n\n\t\treturn mergedEventResult.includes(EscEventAction.handled);\n\t}\n\n\t#handleActiveInput(): boolean\n\t{\n\t\tconst { activeElement } = document;\n\t\tif (!activeElement)\n\t\t{\n\t\t\treturn false;\n\t\t}\n\n\t\tconst isMessengerFocused = this.#messengerContainer.contains(activeElement);\n\t\tconst isInputFocused = activeElement.matches('input');\n\n\t\tif (isMessengerFocused && isInputFocused)\n\t\t{\n\t\t\tactiveElement.blur();\n\n\t\t\treturn true;\n\t\t}\n\n\t\treturn false;\n\t}\n\n\t#handleLayoutClear(): boolean\n\t{\n\t\tconst layoutManager = LayoutManager.getInstance();\n\t\tconst currentLayout = layoutManager.getLayout();\n\t\tconst isChatLayout = layoutManager.isChatLayout(currentLayout.name);\n\n\t\tconst isChatLayoutEmptyState = isChatLayout && currentLayout.entityId === '';\n\t\tif (isChatLayoutEmptyState)\n\t\t{\n\t\t\treturn false;\n\t\t}\n\n\t\tif (isChatLayout)\n\t\t{\n\t\t\tlayoutManager.clearCurrentLayoutEntityId();\n\t\t}\n\t\telse\n\t\t{\n\t\t\tthis.#switchToChatLayout();\n\t\t}\n\n\t\treturn true;\n\t}\n\n\t#handleMessengerSliderClose(): boolean\n\t{\n\t\tconst slider = MessengerSlider.getInstance();\n\t\tif (slider.getCurrent() && slider.isFocused())\n\t\t{\n\t\t\tslider.getCurrent().close();\n\n\t\t\treturn true;\n\t\t}\n\n\t\treturn false;\n\t}\n\n\t#handleDesktopAction(): boolean\n\t{\n\t\tif (!DesktopManager.isDesktop())\n\t\t{\n\t\t\treturn false;\n\t\t}\n\n\t\tDesktopApi.hideWindow();\n\n\t\treturn true;\n\t}\n\n\t#onKeyUp(event: KeyboardEvent)\n\t{\n\t\tif (!Utils.key.isCombination(event, 'Escape'))\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tvoid this.handleEsc();\n\t}\n\n\t#onKeyDown()\n\t{\n\t\t// Viewer has its own ESC keydown handler, so we need to check if it is opened\n\t\tthis.#wasKeyDownHandled = BX.UI.Viewer.Instance.isOpen();\n\t}\n\n\t#switchToChatLayout()\n\t{\n\t\tvoid LayoutManager.getInstance().setLayout({\n\t\t\tname: Layout.chat,\n\t\t\tentityId: '',\n\t\t});\n\t}\n\n\t#isExternalSliderOpened(): boolean\n\t{\n\t\tconst isEmbeddedMode = LayoutManager.getInstance().isEmbeddedMode();\n\t\tif (isEmbeddedMode)\n\t\t{\n\t\t\treturn SidePanel.Instance.getOpenSlidersCount() > 0;\n\t\t}\n\n\t\treturn !MessengerSlider.getInstance().isFocused();\n\t}\n\n\t#handleChannelComments(): boolean\n\t{\n\t\tconst areCommentsOpened = Core.getStore().getters['messages/comments/areOpened'];\n\t\tif (areCommentsOpened)\n\t\t{\n\t\t\tthis.#emitter.emit(EventType.dialog.closeComments);\n\t\t}\n\n\t\treturn areCommentsOpened;\n\t}\n}\n"],"names":["EscEventAction","Object","freeze","handled","ignored","EscManager","constructor","keyUpEventHandler","bind","keyDownEventHandler","getInstance","register","payload","messengerContainer","context","emitter","Event","document","unregister","unbind","handleEsc","hasVisibleCall","CallManager","isAnyPopupShown","PopupWindowManager","eventResult","emitAsync","EventType","key","onBeforeEscape","globalEventResult","EventEmitter","mergedEventResult","includes","activeElement","isMessengerFocused","contains","isInputFocused","matches","blur","layoutManager","LayoutManager","currentLayout","getLayout","isChatLayout","name","isChatLayoutEmptyState","entityId","clearCurrentLayoutEntityId","slider","MessengerSlider","getCurrent","isFocused","close","DesktopManager","isDesktop","DesktopApi","hideWindow","event","Utils","isCombination","BX","UI","Viewer","Instance","isOpen","setLayout","Layout","chat","isEmbeddedMode","SidePanel","getOpenSlidersCount","areCommentsOpened","Core","getStore","getters","emit","dialog","closeComments"],"mappings":"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"}