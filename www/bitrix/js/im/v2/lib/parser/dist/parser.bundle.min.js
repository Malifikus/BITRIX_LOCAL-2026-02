this.BX=this.BX||{};this.BX.Messenger=this.BX.Messenger||{};this.BX.Messenger.v2=this.BX.Messenger.v2||{};(function(e,t,r,s,i){"use strict";const a={decode(e){if(e.startsWith("/me")){return`[i]${e.substr(4)}[/i]`}if(e.startsWith("/loud")){return`[size=20]${e.substr(6)}[/size]`}return e},purify(e){if(e.startsWith("/me")){return e.substr(4)}if(e.startsWith("/loud")){return e.substr(6)}return e}};const n=i.Extension.getSettings("im.v2.lib.parser");const o=n.get("v2");const c=()=>o?BX.Messenger.v2.Application.Core:BX.Messenger.Embedding.Application.Core;const l=()=>o?BX.Messenger.v2.Lib.Utils:BX.Messenger.Embedding.Lib.Utils;const g=()=>o?BX.Messenger.v2.Lib.Logger:BX.Messenger.Embedding.Lib.Logger;const d=()=>o?BX.Messenger.v2.Const:BX.Messenger.Embedding.Const;const u=()=>o?BX.Messenger.v2.Lib.SmileManager:BX.Messenger.Embedding.Lib.SmileManager;const p=()=>{if(o){const e=BX.Messenger.v2.Const.Settings.message.bigSmiles;return c().getStore().getters["application/settings/get"](e)}return c().getStore().getters["application/getOption"]("bigSmileEnable")};const m=10;const h={recursiveReplace(e,t,r){if(!i.Type.isStringFilled(e)){return e}let s=0;let a=true;do{a=false;s++;e=e.replace(t,((...e)=>{a=true;return r(...e)}))}while(a&&s<=m);return e},getFinalContextTag(e){const t=e.match(/(chat\d+|(\d+):(\d+))\/(\d+)/i);if(!t){return""}let[,r,s,i,a]=t;if(r.toString().startsWith("chat")){if(r==="chat0"){return""}return e}s=Number.parseInt(s,10);i=Number.parseInt(i,10);if(c().getUserId()===s){return`${i}/${a}`}if(c().getUserId()===i){return`${s}/${a}`}return""},getDialogIdFromFinalContextTag(e){if(!/^(chat\d+|\d+)\/\d+$/.test(e)){return""}const[t]=e.split("/");return t},getDialogIdByChatId(e){const t=c().getStore().getters["chats/getByChatId"](e);if(!t){return""}return t.dialogId}};const{FileType:f,FileIconType:b,AttachDescription:T}=d();const x={getIcon(e,t=""){return t},addIconToShortText(e){let{text:t}=e;const{attach:r,files:s,isSticker:a}=e;if(i.Type.isArrayFilled(s)||s===true){t=this.getTextForFile(t,s)}else if(r===true||i.Type.isArrayFilled(r)||i.Type.isStringFilled(r)){t=this.getTextForAttach(t,r)}else if(a){t=this.getTextForSticker()}return t.trim()},getQuoteBlock(){const e=this.getIcon(b.quote);if(e){return e}return`[${i.Loc.getMessage("IM_PARSER_ICON_TYPE_QUOTE")}]`},getCodeBlock(){const e=this.getIcon(b.code);if(e){return e}return`[${i.Loc.getMessage("IM_PARSER_ICON_TYPE_CODE")}]`},getImageBlock(){const e=this.getIcon(b.image);if(e){return e}return`[${i.Loc.getMessage("IM_PARSER_ICON_TYPE_IMAGE")}]`},getFileBlock(){const e=this.getIcon(b.file);if(e){return e}return`[${i.Loc.getMessage("IM_PARSER_ICON_TYPE_FILE")}]`},getTextForFile(e,t){let r=e;if(i.Type.isArray(t)&&t.length>0){r=this.getIconTextForFile(e,t)}else if(t===true){r=this.getIconTextForFileType(e,b.file)}return r},getTextForAttach(e,t){let r="";if(i.Type.isArray(t)&&t.length>0){const[e]=t;if(i.Type.isStringFilled(e.description)){r=e.description}}else if(i.Type.isStringFilled(t)){r=t}if(i.Type.isStringFilled(r)){if(r===T.skipMessage){r=""}else{r=Xe.purifyText(r)}}else{const e=this.getIcon(b.attach);if(e){r=`${e} ${i.Loc.getMessage("IM_PARSER_ICON_TYPE_ATTACH")}`}else{r=`[${i.Loc.getMessage("IM_PARSER_ICON_TYPE_ATTACH")}]`}}return`${e} ${r}`.trim()},getTextForSticker(){return`[${i.Loc.getMessage("IM_PARSER_ICON_TYPE_STICKER")}]`},getIconTextForFileType(e,t=b.file){let r=e;const s=this.getIcon(t);const a=i.Loc.getMessage(`IM_PARSER_ICON_TYPE_${t.toUpperCase()}`);if(s){const t=e.replace(/(\s|\n)/gi,"").length>0;const i=t?e:a;r=`${s} ${i}`}else{r=`[${a}] ${e}`}return r.trim()},getIconTextForFile(e,t){const r=e.replace(/(\s|\n)/gi,"").length>0;const[s]=t;if(!s||!s.type){return e}const a=t.every((e=>[b.image,b.video].includes(e.type)));if(s.type===f.image&&t.length===1){return this.getIconTextForFileType(e,b.image)}else if(a&&t.length>1){return this.getIconTextForFileType(e,b.gallery)}else if(s.type===f.audio){return this.getIconTextForFileType(e,b.audio)}else if(s.type===f.video){return this.getIconTextForFileType(e,b.video)}else{const t=this.getIcon(b.file);if(t){const i=r?e:"";e=`${t} ${s.name} ${i}`}else{e=`${i.Loc.getMessage("IM_PARSER_ICON_TYPE_FILE")}: ${s.name} ${e}`}return e.trim()}}};let y=e=>e,I,E;const{EventType:S}=d();const v="&gt;&gt;";const L="none";const M={decodeArrowQuote(e){if(!e.includes(v)){return e}let t=false;const r=e.split("<br />");for(let e=0;e<r.length;e++){if(!r[e].startsWith(v)){continue}const s=e;const i=`<div data-context="${L}" class="bx-im-message-quote --inline">`;const a='<div class="bx-im-message-quote__wrap">';const n="</div>";r[s]=r[s].replace(v,`${i}${a}`);while(++e<r.length&&r[e].startsWith(v)){r[e]=r[e].replace(v,"")}const o=e-1;r[o]+=`${n}${n}`;t=true}if(!t){return e}return r.join("<br />")},purifyArrowQuote(e,t=" "){e=e.replace(new RegExp(`^(${v}(.*))`,"gim"),x.getQuoteBlock()+t);return e},decodeQuote(e,{contextDialogId:t=""}={}){return e.replaceAll(/-{54}(<br \/>(.*?)\[(.*?)]( #(?:chat\d+|\d+:\d+)\/\d+)?)?<br \/>(.*?)-{54}(<br \/>)?/gs,((e,r,s,a,n,o)=>{const c=_(s,a,o);const l=R(s,a);const g=P(n,t);const d=i.Tag.render(I||(I=y`
					<div class='bx-im-message-quote' data-context='${0}'>
						<div class='bx-im-message-quote__wrap'>
							${0}
							<div class='bx-im-message-quote__text'>${0}</div>
						</div>
					</div>
				`),g,l,c);return d.outerHTML}))},purifyQuote(e,t=" "){return e.replace(/-{54}(.*?)-{54}/gims,x.getQuoteBlock()+t)},decodeCode(e){return e.replace(/\[code](<br \/>)?([\0-\uFFFF]*?)\[\/code](<br \/>)?/gis,((e,t,r)=>i.Dom.create({tag:"div",attrs:{className:"bx-im-message-content-code"},html:r}).outerHTML))},purifyCode(e,t=" "){return e.replace(/\[code](<br \/>)?([\0-\uFFFF]*?)\[\/code]/gis,x.getCodeBlock()+t)},executeClickEvent(e,t){if(!e.target.className.startsWith("bx-im-message-quote")&&!(e.target.parentNode&&e.target.parentNode.className.startsWith("bx-im-message-quote"))){return}const r=l().dom.recursiveBackwardNodeSearch(e.target,"bx-im-message-quote");if(!r||r.dataset.context===L){return}const[s,i]=r.dataset.context.split("/");const{emitter:a}=t;a.emit(S.dialog.goToMessageContext,{messageId:Number.parseInt(i,10),dialogId:s.toString()})}};const _=(e,t,r)=>{const s=e&&t;if(!s&&!r){return String(t)}const i="<br />";if(r.endsWith(i)){return r.slice(0,-i.length)}return r};const R=(e,t)=>{const r=e&&t;if(!r){return""}return i.Tag.render(E||(E=y`
		<div class='bx-im-message-quote__name'>
			<div class="bx-im-message-quote__name-text">${0}</div>
			<div class="bx-im-message-quote__name-time">${0}</div>
		</div>
	`),e.trim(),t.trim())};const P=(e,t)=>{if(!e){return L}const r=e.trim().slice(1);const s=h.getFinalContextTag(r);if(!C(s,t)){return L}return s};const C=(e,t)=>{const r=h.getDialogIdFromFinalContextTag(e);return r===t};let $=e=>e,A;const N=Object.freeze({small:"small",medium:"medium",large:"large"});const F={decodeLink(e){return e.replaceAll(/>((https|http):\/\/(\S+)\.(jpg|jpeg|png|gif|webp)(\?\S+[^<])?)<\/a>/gi,((e,t)=>{const r=i.Text.decode(t);if(!/(\.(jpg|jpeg|png|gif|webp)\?|\.(jpg|jpeg|png|gif|webp)$)/i.test(r)||r.toLowerCase().indexOf("/docs/pub/")>0||r.toLowerCase().indexOf("logout=yes")>0){return e}if(!l().text.checkUrl(r)){return e}const s=i.Dom.create({tag:"span",attrs:{className:"bx-im-message-image"},children:[i.Dom.create({tag:"img",attrs:{className:"bx-im-message-image-source",src:r},events:{error(){F.hideErrorImage(this)}}})]}).outerHTML;return`>${s}</a>`}))},purifyLink(e){return e.replaceAll(/(.)?(https?:\/\/\S+)/gi,((e,t,r)=>{if(!O(t,r)){return e}const s=t||"";return`${s}${x.getImageBlock()}`}))},decodeIcon(e){let t=0;const r=p();if(r){t=e.replaceAll(/\[icon=([^\]]*)]/gi,"").trim().length}return e.replaceAll(/\[icon=([^\]]*)]/gi,(e=>{let s=e.match(/icon=(\S+[^\s!"'),.;>?\]])/i);if(s&&s[1]){s=s[1]}else{return""}if(!l().text.checkUrl(s)){return e}const a={src:s,border:0};const n=e.match(/size=(\d+)/i);if(n&&n[1]){a.width=n[1];a.height=n[1]}else{const t=e.match(/width=(\d+)/i);if(t&&t[1]){a.width=t[1]}const r=e.match(/height=(\d+)/i);if(r&&r[1]){a.height=r[1]}if(a.width&&!a.height){a.height=a.width}else if(a.height&&!a.width){a.width=a.height}else if(a.height&&a.width);else{a.width=20;a.height=20}}a.width=a.width>100?100:a.width;a.height=a.height>100?100:a.height;if(r&&t===0&&a.width===a.height&&a.width===20){a.width=40;a.height=40}let o=e.match(/title=(.*[^\s\]])/i);if(o&&o[1]){o=o[1];if(o.includes("width=")){o=o.slice(0,Math.max(0,o.indexOf("width=")))}if(o.includes("height=")){o=o.slice(0,Math.max(0,o.indexOf("height=")))}if(o.includes("size=")){o=o.slice(0,Math.max(0,o.indexOf("size=")))}if(o){a.title=i.Text.decode(o).trim();a.alt=a.title}}return i.Dom.create({tag:"img",attrs:{className:"bx-smile bx-icon",...a}}).outerHTML}))},purifyIcon(e){return e.replaceAll(/\[icon=([^\]]*)]/gi,(e=>{let t=e.match(/title=(.*[^\s\]])/i);if(t&&t[1]){t=t[1];if(t.includes("width=")){t=t.slice(0,Math.max(0,t.indexOf("width=")))}if(t.includes("height=")){t=t.slice(0,Math.max(0,t.indexOf("height=")))}if(t.includes("size=")){t=t.slice(0,Math.max(0,t.indexOf("size=")))}if(t){t=`(${t.trim()})`}}else{t=`(${i.Loc.getMessage("IM_PARSER_IMAGE_ICON")})`}return t}))},purifyImageBbCode(e){const t=Object.values(N).join("|");const r=new RegExp(`\\[img\\s+size=(${t})]([\\s\\S]*?)\\[\\/img]`,"gi");return e.replaceAll(r,(()=>x.getImageBlock()))},hideErrorImage(e){const t=e;if(t&&t.parentNode){t.parentNode.innerHTML=`<a href="${encodeURI(e.src)}" target="_blank">${e.src}</a>`}},decodeImageBbCode(e,{contextDialogId:t=""}={}){if(!i.Type.isStringFilled(e)){return""}return e.replaceAll(/\[img(?:\s+size=([^\]]+))?]\s*(?:\[url])?([\S\s]*?)(?:\[\/url])?\s*\[\/img]/gi,((e,r,s)=>{const a=i.Text.decode(s);const n=r&&Object.values(N).includes(r.toLowerCase());const o=["/docs/pub/","logout=yes"].includes(a.toLowerCase());const g=l().text.checkUrl(a);const d=H(a);const u=j(a);if(!n||o||!g||!d||u){return e.replaceAll(/\[url]([\S\s]*?)\[\/url]/gi,"$1")}const p=`--${r}`;const{file:m}=l();const h=c().getStore().getters["chats/get"](t,true);const f=h.chatId;const b=m.getViewerDataForImageSrc({src:a,viewerGroupBy:f});const T=i.Tag.render(A||(A=$`
					<a class='bx-im-message-image ${0}'>
						<img
							class='bx-im-message-image-source'
							src="${0}"
						/>
					</a>
				`),p,a);i.Dom.attr(T.firstChild,b);return T.outerHTML}))}};function w(e){return e.toLowerCase().indexOf("/docs/pub/")>0}function D(e){return e.toLowerCase().indexOf("logout=yes")>0}function B(e){const[t]=e.split("?");return/\.(jpg|jpeg|png|gif|webp)$/i.test(t)}function k(e){const t=new Set([">","]"," "]);return i.Type.isStringFilled(e)&&!t.has(e)}function O(e,t){return B(t)&&!w(t)&&!D(t)&&!k(e)}function H(e){return/^https?:\/\/.+\.(jpg|jpeg|png|gif|webp)(\?.*)?$/i.test(e.trim())}function j(e){return/\[img/i.test(e.trim())}let U=e=>e,X;const z=Object.freeze({Default:1,Big:1.6});const q=(e,t,r=z)=>{const s=e.replaceAll(new RegExp(t,"g"),"");const i=s.trim().length===0;const a=new RegExp(`(?:(?:${t})\\s*){4,}`);if(i&&!a.test(e)){return r.Big}return r.Default};const K=e=>{const t=e.reduce(((e,t)=>{const{image:r,typing:s,definition:a,name:n,width:o,height:c}=t;const l=i.Tag.render(X||(X=U`
			<img
				src="${0}"
				data-code="${0}"
				data-definition="${0}"
				title="${0}"
				alt="${0}"
				class="bx-smile bx-im-message-base__text_smile"
				style="width: ${0}px; height: ${0}px;"
				draggable="false"
			/>
		`),r,s,a,n!=null?n:s,s,o,c);return{...e,[s]:l}}),{});return t};const Q=function(e,t,r){const s=e.slice(0,r+t.length);const i=l().text.escapeRegex(t);const a=new RegExp(`(?:^|&quot;|>|(?:${this.pattern})|\\s|<)(?:${i})$`);return s.match(a)};const W={typings:null,pattern:"",loadSmilePatterns(){var e,t;if(!u()){return}const r=u().getInstance();const s=(e=(t=r.smileList)==null?void 0:t.smiles)!=null?e:[];if(s.length===0){return}const i=[...s].sort(((e,t)=>t.typing.localeCompare(e.typing)));this.pattern=i.map((e=>l().text.escapeRegex(e.typing))).join("|");this.typings=K(i)},decodeSmile(e,t={}){if(!this.typings){this.loadSmilePatterns()}if(!this.pattern){return e}let r;if(i.Type.isBoolean(t.enableBigSmile)){r=t.enableBigSmile}else{r=p()}const s=i.Type.isObjectLike(t.ratioConfig)?t.ratioConfig:z;const a=r?q(e,this.pattern,s):s.Default;const n=`(?:(?:${this.pattern})(?=(?:(?:${this.pattern})|\\s|&quot;|<|$)))`;const o=new RegExp(n,"g");const c=e.replaceAll(o,((t,r)=>{const s=Q.call(this,e,t,r);if(!s){return t}const n=this.typings[t].cloneNode();const{width:o,height:c}=n.style;i.Dom.style(n,"width",`${Number.parseInt(o,10)*a}px`);i.Dom.style(n,"height",`${Number.parseInt(c,10)*a}px`);return n.outerHTML}));return c}};const{DataAttribute:G}=d();const Y={decode(e,t={}){const{urlTarget:r="_blank",removeLinks:s=false}=t;e=e.replace(/\[url(?:=([^[\]]+))?](.*?)\[\/url]/gis,((e,t,s)=>{const a=i.Text.decode(t||s);if(!l().text.checkUrl(a)){return s}return this.getLinkHtml(a,r,s)}));e=e.replace(/\[url(?:=(.+?[^[\]]))?](.*?)\[\/url]/gis,((e,t,s)=>{let a=i.Text.decode(t||s);if(!l().text.checkUrl(a)){return s}if(!a.slice(a.lastIndexOf("[")).includes("]")){if(s.startsWith("]")){a=`${a}]`;s=s.slice(1)}else if(s.startsWith("=")){const e=i.Text.decode(s.slice(1,s.lastIndexOf("]")));a=`${a}]=${e}`;s=s.slice(s.lastIndexOf("]")+1)}}return this.getLinkHtml(a,r,s)}));if(s){e=e.replace(/<a.*?href="([^"]*)".*?>(.*?)<\/a>/gi,"$2")}return e},purify(e){e=e.replace(/\[url(?:=([^\[\]]+))?](.*?)\[\/url]/gis,((e,t,r)=>r?r:t));e=e.replace(/\[url(?:=(.+))?](.*?)\[\/url]/gis,((e,t,r)=>r?r:t));return e},removeSimpleUrlTag(e){e=e.replace(/\[url](.*?)\[\/url]/gis,((e,t)=>t));return e},getLinkHtml(e,t,r){return i.Dom.create({tag:"a",attrs:{href:e,target:t,[G.useNativeContextMenu]:true},html:r}).outerHTML}};const V={decode(e){e=h.recursiveReplace(e,/\[b]([^[]*(?:\[(?!b]|\/b])[^[]*)*)\[\/b]/gi,((e,t)=>"<b>"+t+"</b>"));e=h.recursiveReplace(e,/\[u]([^[]*(?:\[(?!u]|\/u])[^[]*)*)\[\/u]/gi,((e,t)=>"<u>"+t+"</u>"));e=h.recursiveReplace(e,/\[i]([^[]*(?:\[(?!i]|\/i])[^[]*)*)\[\/i]/gi,((e,t)=>"<i>"+t+"</i>"));e=h.recursiveReplace(e,/\[s]([^[]*(?:\[(?!s]|\/s])[^[]*)*)\[\/s]/gi,((e,t)=>"<s>"+t+"</s>"));e=h.recursiveReplace(e,/\[size=(\d+)(?:pt|px)?](.*?)\[\/size]/gis,((e,t,r)=>{t=Number.parseInt(t,10);if(t<=8){t=8}else if(t>=30){t=30}return i.Dom.create({tag:"span",style:{fontSize:`${t}px`},html:r}).outerHTML}));e=h.recursiveReplace(e,/\[color=#([0-9a-f]{3}|[0-9a-f]{6})](.*?)\[\/color]/gis,((e,t,r)=>i.Dom.create({tag:"span",style:{color:"#"+t},html:r}).outerHTML));return e},purify(e,t=true){if(t){e=h.recursiveReplace(e,/\[s]([^[]*(?:\[(?!s]|\/s])[^[]*)*)\[\/s]/gi,(()=>" "))}e=h.recursiveReplace(e,/\[b]([^[]*(?:\[(?!b]|\/b])[^[]*)*)\[\/b]/gi,((e,t)=>t));e=h.recursiveReplace(e,/\[u]([^[]*(?:\[(?!u]|\/u])[^[]*)*)\[\/u]/gi,((e,t)=>t));e=h.recursiveReplace(e,/\[i]([^[]*(?:\[(?!i]|\/i])[^[]*)*)\[\/i]/gi,((e,t)=>t));e=h.recursiveReplace(e,/\[s]([^[]*(?:\[(?!s]|\/s])[^[]*)*)\[\/s]/gi,((e,t)=>t));e=h.recursiveReplace(e,/\[size=(\d+)(?:pt|px)?](.*?)\[\/size]/gis,((e,t,r)=>r));e=h.recursiveReplace(e,/\[color=#([0-9a-f]{3}|[0-9a-f]{6})](.*?)\[\/color]/gis,((e,t,r)=>r));return e}};let J=e=>e,Z;const ee={decode(e){let t=e;t=t.replaceAll(/\[like]/gi,`<span class="bx-im-lines-vote-like" title="${i.Loc.getMessage("IM_PARSER_LINES_RATING_LIKE")}"></span>`);t=t.replaceAll(/\[dislike]/gi,`<span class="bx-im-lines-vote-dislike" title="${i.Loc.getMessage("IM_PARSER_LINES_RATING_DISLIKE")}"></span>`);t=t.replaceAll(/\[rating=([1-5])]/gi,((e,t)=>{const r=i.Tag.render(Z||(Z=J`
				<span class="bx-im-lines-rating" title="${0} - ${0}">
					<span class="bx-im-lines-rating-selected" style="width: ${0}%"></span>
				</span>
			`),i.Loc.getMessage("IM_PARSER_LINES_RATING"),t,t*20);return r.outerHTML}));return t},purify(e){let t=e;t=t.replaceAll(/\[like]/gi,i.Loc.getMessage("IM_PARSER_LINES_RATING_LIKE"));t=t.replaceAll(/\[dislike]/gi,i.Loc.getMessage("IM_PARSER_LINES_RATING_DISLIKE"));t=t.replaceAll(/\[rating=([1-5])]/gi,(()=>`[${i.Loc.getMessage("IM_PARSER_LINES_RATING")}] `));return t}};const{EventType:te}=d();const re={put:"put",send:"send"};const se={decodePut(e){e=e.replace(/\[PUT(?:=(?:.+?))?](?:.+?)?\[\/PUT]/gi,(e=>e.replace(/\[PUT(?:=(.+))?](.+?)?\[\/PUT]/gi,((e,t,r)=>{r=r?r:t;t=t?t:r;r=i.Text.decode(r);t=i.Text.decode(t).replace("<br />","\n");if(!r.trim()){return""}r=r.replace(/<(\w+)[^>]*>(.*?)<\/\1>/i,"$2",r);r=r.replace(/\[(\w+)[^\]]*](.*?)\[\/\1]/i,"$2",r);return this._getHtmlForAction("put",r,t)}))));return e},purifyPut(e){e=e.replace(/\[PUT(?:=(?:.+?))?](?:.+?)?\[\/PUT]/gi,(e=>e.replace(/\[PUT(?:=(.+))?](.+?)?\[\/PUT]/gi,((e,t,r)=>r?r:t))));return e},decodeSend(e){e=e.replace(/\[SEND(?:=(?:.+?))?](?:.+?)?\[\/SEND]/gi,(e=>e.replace(/\[SEND(?:=(.+))?](.+?)?\[\/SEND]/gi,((e,t,r)=>{r=r?r:t;t=t?t:r;r=i.Text.decode(r);t=i.Text.decode(t).replace("<br />","\n");if(!r.trim()){return""}r=r.replace(/<(\w+)[^>]*>(.*?)<\\1>/i,"$2",r);r=r.replace(/\[(\w+)[^\]]*](.*?)\[\/\1]/i,"$2",r);t=t.split("####REPLACEMENT_PUT_").join("####REPLACEMENT_SP_");return this._getHtmlForAction("send",r,t)}))));return e},purifySend(e){e=e.replace(/\[SEND(?:=(?:.+?))?](?:.+?)?\[\/SEND]/gi,(e=>e.replace(/\[SEND(?:=(.+))?](.+?)?\[\/SEND]/gi,((e,t,r)=>r?r:t))));return e},_getHtmlForAction(e,t,r){return i.Dom.create({tag:"span",attrs:{className:"bx-im-message-command-wrap"},children:[i.Dom.create({tag:"span",attrs:{className:"bx-im-message-command","data-entity":e},text:t}),i.Dom.create({tag:"span",attrs:{className:"bx-im-message-command-data"},text:r})]}).outerHTML},executeClickEvent(e,t){var r;if(!i.Dom.hasClass(e.target,"bx-im-message-command")){return}const{emitter:s}=t;const a=e.target;const n=ie(a);const o=(r=ae(n))!=null?r:"";if(a.dataset.entity===re.put){const{innerText:e=""}=a.parentElement.querySelector(".bx-im-message-command-data");if(!e){return}s.emit(te.textarea.insertText,{text:e,dialogId:o})}else if(a.dataset.entity===re.send){const{innerText:e=""}=a.parentElement.querySelector(".bx-im-message-command-data");if(!e){return}s.emit(te.textarea.sendMessage,{text:e,dialogId:o})}}};const ie=e=>{const t=e.closest(".bx-im-message-base__wrap");if(!t||!t.dataset.id){return null}return t.dataset.id};const ae=e=>{const t=c().getStore().getters["messages/getById"](e);if(!t){return null}const r=c().getStore().getters["chats/getByChatId"](t.chatId);if(!r){return null}return r.dialogId};const{MessageMentionType:ne}=d();const oe={decode(e){let t=e;t=t.replaceAll(/\[call(?:=([\d #()+./-]+))?](.+?)\[\/call]/gi,((e,t,r)=>{if(!r){return e}let s="";if(t){s=t}else if(l.call.isNumber(r)){s=r}else{return e}return i.Dom.create({tag:"span",attrs:{className:"bx-im-mention","data-type":ne.call,"data-destination":s},text:i.Text.decode(r)}).outerHTML}));t=t.replaceAll(/\[pch=(\d+)](.*?)\[\/pch]/gi,((e,t,r)=>""));return t},purify(e){let t=e;t=t.replaceAll(/\[call(?:=([\d #()+./-]+))?](.+?)\[\/call]/gi,((e,t,r)=>r||t));t=t.replaceAll(/\[pch=(\d+)](.*?)\[\/pch]/gi,((e,t,r)=>r));return t}};const{EventType:ce,MessageMentionType:le,SidebarDetailBlock:ge,SpecialMentionDialogId:de,ChatType:ue}=d();const pe="bx-im-mention";var me=babelHelpers.classPrivateFieldLooseKey("handlersByMentionType");var he=babelHelpers.classPrivateFieldLooseKey("handlersByDialogId");var fe=babelHelpers.classPrivateFieldLooseKey("getCopilotBotDialogId");var be=babelHelpers.classPrivateFieldLooseKey("handleCopilot");var Te=babelHelpers.classPrivateFieldLooseKey("handleChat");var xe=babelHelpers.classPrivateFieldLooseKey("handleLines");var ye=babelHelpers.classPrivateFieldLooseKey("handleContext");var Ie=babelHelpers.classPrivateFieldLooseKey("handleCall");var Ee=babelHelpers.classPrivateFieldLooseKey("handleAllParticipants");class Se{constructor(e){Object.defineProperty(this,Ee,{value:Ce});Object.defineProperty(this,Ie,{value:Pe});Object.defineProperty(this,ye,{value:Re});Object.defineProperty(this,xe,{value:_e});Object.defineProperty(this,Te,{value:Me});Object.defineProperty(this,be,{value:Le});Object.defineProperty(this,fe,{value:ve});Object.defineProperty(this,me,{writable:true,value:{[le.user]:e=>babelHelpers.classPrivateFieldLooseBase(this,Te)[Te](e),[le.chat]:e=>babelHelpers.classPrivateFieldLooseBase(this,Te)[Te](e),[le.lines]:e=>babelHelpers.classPrivateFieldLooseBase(this,xe)[xe](e),[le.context]:e=>babelHelpers.classPrivateFieldLooseBase(this,ye)[ye](e),[le.call]:e=>babelHelpers.classPrivateFieldLooseBase(this,Ie)[Ie](e)}});Object.defineProperty(this,he,{writable:true,value:{[babelHelpers.classPrivateFieldLooseBase(this,fe)[fe]()]:()=>babelHelpers.classPrivateFieldLooseBase(this,be)[be](),[de.allParticipants]:()=>babelHelpers.classPrivateFieldLooseBase(this,Ee)[Ee]()}});const{emitter:t}=e;this.emitter=t}handleClick(e){if(!i.Dom.hasClass(e.target,pe)){return}const t=e.target.dataset;const r=babelHelpers.classPrivateFieldLooseBase(this,he)[he][t.value];if(r){r();return}const s=babelHelpers.classPrivateFieldLooseBase(this,me)[me][t.type];if(!s){return}s(t)}}function ve(){return c().getStore().getters["users/bots/getCopilotBotDialogId"]}function Le(){void s.Messenger.openCopilot()}function Me(e){void s.Messenger.openChat(e.value)}function _e(e){const t=e.value;if(l().dialog.isLinesHistoryId(t)){void s.Messenger.openLinesHistory(t)}else if(l().dialog.isLinesExternalId(t)){void s.Messenger.openLines(t)}}function Re(e){const t=Number.parseInt(e.messageId,10);this.emitter.emit(ce.dialog.goToMessageContext,{messageId:t,dialogId:e.dialogId})}function Pe(e){const t=e.destination;if(l().call.isNumber(t)){void s.Messenger.startPhoneCall(t)}}function Ce(){const{entityId:e}=c().getStore().getters["application/getLayout"];const{type:t}=c().getStore().getters["chats/get"](e,true);if(!e){return}if(t===ue.user){return}this.emitter.emit(ce.sidebar.open,{panel:ge.members,dialogId:e})}const{UserType:$e,MessageMentionType:Ae,SpecialMentionDialogId:Ne={}}=d();const Fe={[Ne.allParticipants]:e=>Be.renderAllParticipantsMention(e)};const we="bx-im-mention";const De={highlight:"--highlight",extranet:"--extranet"};const Be={decode(e){e=e.replace(/\[USER=(all|[0-9]+)( REPLACE)?](.*?)\[\/USER]/gi,((e,t,r,s)=>{if(Fe[t]){return Fe[t](s)}t=Number.parseInt(t,10);if(!i.Type.isNumber(t)||t===0){return s}const a=c().getStore().getters["users/get"](t);if(r||!s){if(a){s=a.name}}else{s=i.Text.decode(s)}if(!s){s=`User ${t}`}let n=we;if(c().getUserId()===t){n+=` ${De.highlight}`}if(a&&a.type===$e.extranet){n+=` ${De.extranet}`}return i.Dom.create({tag:"span",attrs:{className:n,"data-type":Ae.user,"data-value":t},text:s}).outerHTML}));e=e.replace(/\[chat=(imol\|)?(\d+)](.*?)\[\/chat]/gi,((e,t,r,s)=>{if(r===0){return s}let a=s;if(a){a=i.Text.decode(a)}else{const e=c().getStore().getters["chats/get"](`chat${r}`);a=e?e.name:`Chat ${r}`}return i.Dom.create({tag:"span",attrs:{className:we,"data-type":t?Ae.lines:Ae.chat,"data-value":t?`imol|${r}`:`chat${r}`},text:a}).outerHTML}));e=e.replace(/\[context=((?:chat\d+|\d+:\d+)\/(\d+))](.*?)\[\/context]/gis,((e,t,r,s)=>{if(!s){return""}s=i.Text.decode(s);t=h.getFinalContextTag(t);if(!t){return s}const a=t.split("/")[0];let n="";r=Number.parseInt(r,10);if(i.Type.isNumber(r)&&r>0){const e=c().getStore().getters["messages/getById"](r);if(e){n=Xe.purifyMessage(e);const t=c().getStore().getters["users/get"](e.authorId);if(t){n=`${t.name}: ${n}`}}}if(!i.Type.isStringFilled(n)){n=i.Loc.getMessage("IM_PARSER_MENTION_DIALOG")}return i.Dom.create({tag:"span",attrs:{className:we,"data-type":Ae.context,"data-dialog-id":a,"data-message-id":r,title:n},text:s}).outerHTML}));return e},purify(e){e=e.replace(/\[USER=(all|[0-9]+)( REPLACE)?](.*?)\[\/USER]/gi,((e,t,r,s)=>{t=Number.parseInt(t,10);if(!i.Type.isNumber(t)||t===0){return s}if(r||!s){const e=c().getStore().getters["users/get"](t);if(e){s=e.name}}else{s=i.Text.decode(s)}if(!s){s=`User ${t}`}return s}));e=e.replace(/\[CHAT=(imol\|)?(\d+)](.*?)\[\/CHAT]/gi,((e,t,r,s)=>{r=Number.parseInt(r,10);if(!s){const e=c().getStore().getters["chats/get"]("chat"+r);s=e?e.name:"Chat "+r}return s}));e=e.replace(/\[context=(chat\d+|\d+:\d+)\/(\d+)](.*?)\[\/context]/gis,((e,t,r,s)=>{if(!s){const e=c().getStore().getters["chats/get"](t);s=e?e.name:"Dialog "+t}return s}));return e},executeClickEvent(e,t){const r=new Se(t);r.handleClick(e)},renderAllParticipantsMention(e){const t=`${we} ${De.highlight}`;return i.Dom.create({tag:"span",attrs:{className:t,"data-type":Ae.user,"data-value":Ne.allParticipants},text:e}).outerHTML}};const ke={decodeNewLine(e){e=e.replace(/\n/gi,"<br />");e=e.replace(/\[BR]/gi,"<br />");return e},purifyNewLine(e,t=" "){if(t!=="\n"){e=e.replace(/\n/gi,t)}e=e.replace(/\[BR]/gi,t);return e},purifyBreakLine(e,t=" "){e=e.replace(/<br><br \/>/gi,"<br />");e=e.replace(/<br \/><br>/gi,"<br />");e=e.replace(/\[BR]/gi,"<br />");e=e.replace(/<br \/>/gi,t);return e},decodeTabulation(e){e=e.replace(/( ){4}/gi,"\t");e=e.replace(/\t/gi,"&nbsp;&nbsp;&nbsp;&nbsp;");return e},purifyTabulation(e){e=e.replace(/&nbsp;&nbsp;&nbsp;&nbsp;/gi," ");return e},purifyNbsp(e){e=e.replace(/&nbsp;/gi," ");return e},removeDuplicateTags(e){if(e.substr(-6)==="<br />"){e=e.substr(0,e.length-6)}e=e.replace(/<br><br \/>/gi,"<br />");e=e.replace(/<br \/><br>/gi,"<br />");return e}};const Oe={decode(e){const t=`[${i.Loc.getMessage("IM_PARSER_ICON_TYPE_FILE")}]`;return e.replaceAll(/\[disk=\d+]/gi,t)},purify(e){return this.decode(e)}};const He={decode(e){return je(e)},purify(e){return je(e)}};const je=e=>{const t=/\[timestamp=(?<timestamp>\d+)\s+format=(?<format>[_a-z]+)]/gi;return e.replaceAll(t,((e,...t)=>{const{timestamp:r,format:s}=t.at(-1);const a=i.Reflection.getClass("BX.Messenger.v2.Lib.DateFormatter");const n=i.Reflection.getClass("BX.Messenger.v2.Lib.DateFormat");const o=i.Reflection.getClass("BX.Messenger.v2.Lib.DateCode");if(!a){return e}const c=Number(r)*1e3;const l=new Date(c);const g=i.Text.toCamelCase(s);const d=Object.keys(n);if(!d.includes(g)){return e}return a.formatByCode(l,o[g])}))};const Ue={putReplacement:[],sendReplacement:[],codeReplacement:[],clean(){this.putReplacement=[];this.sendReplacement=[];this.codeReplacement=[]},cutPutTag(e){return e.replaceAll(/\[put(?:=(.+?))?](.+?)?\[\/put]/gi,(e=>{const t=this.putReplacement.length;this.putReplacement.push(e);return`####REPLACEMENT_PUT_${t}####`}))},recoverPutTag(e){this.putReplacement.forEach(((t,r)=>{e=e.replace(`####REPLACEMENT_PUT_${r}####`,t)}));return e},cutSendTag(e){e=e.replaceAll(/\[send(?:=(.+?))?](.+?)?\[\/send]/gi,(e=>{const t=this.sendReplacement.length;this.sendReplacement.push(e);return`####REPLACEMENT_SEND_${t}####`}));return e},recoverSendTag(e){this.sendReplacement.forEach(((t,r)=>{const s=`####REPLACEMENT_SEND_${r}####`;e=e.split(s).join(t)}));return e},cutCodeTag(e){e=e.replaceAll(/\[code](<br \/>)?(.*?)\[\/code]/gis,(e=>{const t=this.codeReplacement.length;this.codeReplacement.push(e);return`####REPLACEMENT_CODE_${t}####`}));return e},recoverCodeTag(e){this.codeReplacement.forEach(((t,r)=>{e=e.replace(`####REPLACEMENT_CODE_${r}####`,t)}));this.sendReplacement.forEach(((t,r)=>{e=e.replaceAll(`####REPLACEMENT_SEND_${r}####`,t)}));return e},recoverRecursionTag(e){if(this.sendReplacement.length>0){this.sendReplacement.forEach(((t,r)=>{e=e.replaceAll(`####REPLACEMENT_SEND_${r}####`,t)}))}e=e.split("####REPLACEMENT_SP_").join("####REPLACEMENT_PUT_");if(this.putReplacement.length>0){do{this.putReplacement.forEach(((t,r)=>{e=e.replace(`####REPLACEMENT_PUT_${r}####`,t)}))}while(e.includes("####REPLACEMENT_PUT_"))}return e}};const Xe={decodeMessage(e){const t=c().getStore().getters["messages/getMessageFiles"](e.id);const r=h.getDialogIdByChatId(e.chatId);return this.decode({text:e.text,attach:e.attach,files:t,showIconIfEmptyText:false,contextDialogId:r})},decodeNotification(e){var r;return this.decode({text:e.text,attach:(r=e.params.attach)!=null?r:false,showIconIfEmptyText:false,showImageFromLink:false,urlTarget:t.DesktopApi.isDesktop()?"_blank":"_self"})},decodeNotificationParam(e){return this.decode({text:e,urlTarget:t.DesktopApi.isDesktop()?"_blank":"_self"})},decodeText(e){return this.decode({text:e})},decodeHtml(e){return this.decode({text:e})},decodeSmile(e,t){return W.decodeSmile(e,t)},decodeSmileForLegacyCore(e,t){const r={...t};r.ratioConfig=Object.freeze({Default:1,Big:1.6});return W.decodeSmile(e,r)},decode(e){if(!i.Type.isPlainObject(e)){g().error("Parser.decode: the first parameter must be object",e);return'<b style="color:red">Parser.decode: the first parameter must be a parameter object</b'}let{text:t}=e;const{attach:r=false,files:s=false,removeLinks:n=false,showIconIfEmptyText:o=true,showImageFromLink:c=true,contextDialogId:l="",urlTarget:d="_blank"}=e;if(!i.Type.isString(t)){if(i.Type.isNumber(t)){return t.toString()}return""}if(!t){if(o){t=x.addIconToShortText({text:t,attach:r,files:s})}return t.trim()}t=i.Text.encode(t.trim());t=ke.decodeNewLine(t);t=ke.decodeTabulation(t);t=Ue.cutPutTag(t);t=Ue.cutSendTag(t);t=Ue.cutCodeTag(t);t=W.decodeSmile(t);t=a.decode(t);t=F.decodeImageBbCode(t,{contextDialogId:l});t=Y.decode(t,{urlTarget:d,removeLinks:n});t=V.decode(t);t=ee.decode(t);t=Be.decode(t);t=oe.decode(t);t=F.decodeIcon(t);if(c){t=F.decodeLink(t)}t=Oe.decode(t);t=He.decode(t);t=M.decodeArrowQuote(t);t=M.decodeQuote(t,{contextDialogId:l});t=Ue.recoverSendTag(t);t=se.decodeSend(t);t=Ue.recoverPutTag(t);t=se.decodePut(t);t=Ue.recoverCodeTag(t);t=M.decodeCode(t);t=Ue.recoverRecursionTag(t);t=ke.removeDuplicateTags(t);Ue.clean();return t},purifyMessage(e){const t=c().getStore().getters["messages/getMessageFiles"](e.id);const r=c().getStore().getters["stickers/messages/isSticker"](e.id);return this.purify({text:e.text,attach:e.attach,files:t,isSticker:r})},purifyNotification(e){var t;const r=c().getStore().getters["messages/getMessageFiles"](e.id);return this.purify({text:e.text,attach:(t=e.params.attach)!=null?t:false,files:r})},purifyRecent(e){const t=i.Extension.getSettings("im.v2.lib.parser");const r=t.get("v2");if(!r){const{files:t,attach:r,text:s}=this.prepareLegacyConfigForRecent(e);return this.purify({text:s,attach:r,files:t,showPhraseMessageWasDeleted:e.message.id!==0})}const{files:s,attach:a,text:n,isSticker:o}=this.prepareConfigForRecent(e);return this.purify({text:n,attach:a,files:s,showPhraseMessageWasDeleted:e.messageId!==0,isSticker:o})},purifyText(e){return this.purify({text:e})},purify(e){if(!i.Type.isPlainObject(e)){g().error("Parser.purify: the first parameter must be a object",e);return"Parser.purify: the first parameter must be a parameter object"}let{text:t}=e;const{attach:r=false,files:s=false,isSticker:n=false,showPhraseMessageWasDeleted:o=true}=e;if(!i.Type.isString(t)){t=i.Type.isNumber(t)?t.toString():""}if(!t||n){t=x.addIconToShortText({text:t,attach:r,files:s,isSticker:n});return t.trim()}t=i.Text.encode(t.trim());t=ke.purifyNewLine(t,"\n");t=a.purify(t);t=M.purifyArrowQuote(t);t=M.purifyQuote(t);t=M.purifyCode(t);t=se.purifyPut(t);t=se.purifySend(t);t=Be.purify(t);t=V.purify(t);t=ee.purify(t);t=oe.purify(t);t=Y.purify(t);t=F.purifyLink(t);t=F.purifyIcon(t);t=F.purifyImageBbCode(t);t=Oe.purify(t);t=He.purify(t);t=ke.purifyNewLine(t);t=x.addIconToShortText({text:t,attach:r,files:s});if(t.length>0){t=i.Text.decode(t)}else if(o){t=i.Loc.getMessage("IM_PARSER_MESSAGE_DELETED")}return t.trim()},prepareQuote(e,t=""){const{id:r,attach:s}=e;let a=t===""?e.text:t;const n=c().getStore().getters["messages/getMessageFiles"](r);const o=c().getStore().getters["stickers/messages/isSticker"](r);a=i.Text.encode(a.trim());a=Be.purify(a);a=oe.purify(a);a=ee.purify(a);a=ke.purifyBreakLine(a,"\n");a=ke.purifyNbsp(a);a=Y.removeSimpleUrlTag(a);a=M.purifyCode(a," ");a=M.purifyQuote(a," ");a=M.purifyArrowQuote(a," ");if(t===""){a=x.addIconToShortText({text:a,attach:s,files:n})}if(o){a=x.addIconToShortText({isSticker:o})}a=a.length>0?i.Text.decode(a):i.Loc.getMessage("IM_PARSER_MESSAGE_DELETED");return a.trim()},prepareEdit(e){let{text:t}=e;t=Y.removeSimpleUrlTag(t);t=Be.purify(t);return t.trim()},prepareCopy(e){let{text:t}=e;t=Y.removeSimpleUrlTag(t);return t.trim()},prepareCopyFile(e){const{id:t}=e;const r=c().getStore().getters["messages/getMessageFiles"](t).map((e=>`[DISK=${e.id}]\n`));return r.join("\n").trim()},prepareConfigForRecent(e){let t=c().getStore().getters["messages/getMessageFiles"](e.messageId);if(t.length===0){t=false}const r=c().getStore().getters["messages/getById"](e.messageId);let s=false;if(i.Type.isBoolean(r==null?void 0:r.attach)||i.Type.isStringFilled(r==null?void 0:r.attach)||i.Type.isArray(r==null?void 0:r.attach)){s=r.attach}else if(i.Type.isPlainObject(r==null?void 0:r.attach)){s=[r.attach]}const a=c().getStore().getters["stickers/messages/isSticker"](e.messageId);return{files:t,attach:s,text:r.text,isSticker:a}},prepareLegacyConfigForRecent(e){let t=false;const r=e.message.params.withFile;if(i.Type.isBoolean(r)){t=r}else if(i.Type.isPlainObject(r)){t=[r]}let s=false;const a=e.message.params.withAttach;if(i.Type.isBoolean(a)||i.Type.isStringFilled(a)||i.Type.isArray(a)){s=a}else if(i.Type.isPlainObject(a)){s=[a]}return{files:t,attach:s,text:e.message.text}},executeClickEvent(e,t){Be.executeClickEvent(e,t);M.executeClickEvent(e,t);se.executeClickEvent(e,t)},getContextCodeFromForwardId(e){return h.getFinalContextTag(e)}};e.Parser=Xe})(this.BX.Messenger.v2.Lib=this.BX.Messenger.v2.Lib||{},BX.Messenger.v2.Lib,BX.Event,BX.Messenger.v2.Lib,BX);
//# sourceMappingURL=parser.bundle.map.js