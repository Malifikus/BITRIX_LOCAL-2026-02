this.BX=this.BX||{};(function(e,t,i,n,a,s,r,o,l,c,u,d,h,p,v,f,m,g,b,C,k,y,S,w){"use strict";function I(){if(window["BXDesktopSystem"]){navigator["getDisplayMedia"]=function(){var e={audio:false,video:{mandatory:{chromeMediaSource:"desktop",maxWidth:screen.width>1920?screen.width:1920,maxHeight:screen.height>1080?screen.height:1080},optional:[{googTemporalLayeredScreencast:true}]}};return navigator.mediaDevices.getUserMedia(e)}}}var T=function(){function e(){babelHelpers.classCallCheck(this,e)}babelHelpers.createClass(e,null,[{key:"isAvailable",value:function e(){return t.Utils.platform.getDesktopVersion()>=52}},{key:"isMaskAvailable",value:function e(){return t.Utils.platform.isDesktopFeatureEnabled("mask")}},{key:"open",value:function e(t){var i=this;t=p.Type.isPlainObject(t)?t:{};var n=p.Type.isStringFilled(t.tab)?t.tab:"background";if(!this.isAvailable()){if(window.BX.Helper){window.BX.Helper.show("redirect=detail&code=12398124")}return false}var a='<div id="bx-desktop-loader" class="bx-desktop-loader-wrap">\n\t\t\t\t<div class="bx-desktop-loader">\n\t\t\t\t\t<svg class="bx-desktop-loader-circular" viewBox="25 25 50 50">\n\t\t\t\t\t\t<circle class="bx-desktop-loader-path" cx="50" cy="50" r="20" fill="none" stroke-miterlimit="10"/>\n\t\t\t\t\t</svg>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t<div id="placeholder"></div>';var s='BX.Runtime.loadExtension("call.component.v2.call-background").then(function(exports) {\n\t\t\t\tBX.Vue3.BitrixVue.createApp({\n\t\t\t\t\tcomponents: {CallBackground: exports.CallBackground},\n\t\t\t\t\ttemplate: \'<CallBackground tab="'.concat(n,'"/>\',\n\t\t\t\t}).mount("#placeholder");\n\t\t\t});');r.DesktopApi.createWindow("callBackground",(function(e){var t=i.isMaskAvailable()?BX.message("BXD_CALL_BG_MASK_TITLE"):BX.message("BXD_CALL_BG_TITLE");e.SetProperty("title",t);e.SetProperty("clientSize",{Width:943,Height:670});e.SetProperty("minClientSize",{Width:943,Height:670});e.SetProperty("backgroundColor","#2B3038");e.ExecuteCommand("center");e.ExecuteCommand("html.load",r.DesktopApi.prepareHtml(a,s))}));return true}}]);return e}();var P={HIGH:2,MEDIUM:1,LOW:0,NO_VIDEO:-1};var _={HIGH:720,MEDIUM:360,LOW:180,NO_VIDEO:0};function E(){/*! regenerator-runtime -- Copyright (c) 2014-present, Facebook, Inc. -- license (MIT): https://github.com/facebook/regenerator/blob/main/LICENSE */E=function t(){return e};var e={},t=Object.prototype,i=t.hasOwnProperty,n=Object.defineProperty||function(e,t,i){e[t]=i.value},a="function"==typeof Symbol?Symbol:{},s=a.iterator||"@@iterator",r=a.asyncIterator||"@@asyncIterator",o=a.toStringTag||"@@toStringTag";function l(e,t,i){return Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{l({},"")}catch(e){l=function e(t,i,n){return t[i]=n}}function c(e,t,i,a){var s=t&&t.prototype instanceof h?t:h,r=Object.create(s.prototype),o=new T(a||[]);return n(r,"_invoke",{value:y(e,i,o)}),r}function u(e,t,i){try{return{type:"normal",arg:e.call(t,i)}}catch(e){return{type:"throw",arg:e}}}e.wrap=c;var d={};function h(){}function p(){}function v(){}var f={};l(f,s,(function(){return this}));var m=Object.getPrototypeOf,g=m&&m(m(P([])));g&&g!==t&&i.call(g,s)&&(f=g);var b=v.prototype=h.prototype=Object.create(f);function C(e){["next","throw","return"].forEach((function(t){l(e,t,(function(e){return this._invoke(t,e)}))}))}function k(e,t){function a(n,s,r,o){var l=u(e[n],e,s);if("throw"!==l.type){var c=l.arg,d=c.value;return d&&"object"==babelHelpers["typeof"](d)&&i.call(d,"__await")?t.resolve(d.__await).then((function(e){a("next",e,r,o)}),(function(e){a("throw",e,r,o)})):t.resolve(d).then((function(e){c.value=e,r(c)}),(function(e){return a("throw",e,r,o)}))}o(l.arg)}var s;n(this,"_invoke",{value:function e(i,n){function r(){return new t((function(e,t){a(i,n,e,t)}))}return s=s?s.then(r,r):r()}})}function y(e,t,i){var n="suspendedStart";return function(a,s){if("executing"===n)throw new Error("Generator is already running");if("completed"===n){if("throw"===a)throw s;return _()}for(i.method=a,i.arg=s;;){var r=i.delegate;if(r){var o=S(r,i);if(o){if(o===d)continue;return o}}if("next"===i.method)i.sent=i._sent=i.arg;else if("throw"===i.method){if("suspendedStart"===n)throw n="completed",i.arg;i.dispatchException(i.arg)}else"return"===i.method&&i.abrupt("return",i.arg);n="executing";var l=u(e,t,i);if("normal"===l.type){if(n=i.done?"completed":"suspendedYield",l.arg===d)continue;return{value:l.arg,done:i.done}}"throw"===l.type&&(n="completed",i.method="throw",i.arg=l.arg)}}}function S(e,t){var i=t.method,n=e.iterator[i];if(undefined===n)return t.delegate=null,"throw"===i&&e.iterator["return"]&&(t.method="return",t.arg=undefined,S(e,t),"throw"===t.method)||"return"!==i&&(t.method="throw",t.arg=new TypeError("The iterator does not provide a '"+i+"' method")),d;var a=u(n,e.iterator,t.arg);if("throw"===a.type)return t.method="throw",t.arg=a.arg,t.delegate=null,d;var s=a.arg;return s?s.done?(t[e.resultName]=s.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=undefined),t.delegate=null,d):s:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,d)}function w(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function I(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function T(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(w,this),this.reset(!0)}function P(e){if(e){var t=e[s];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var n=-1,a=function t(){for(;++n<e.length;)if(i.call(e,n))return t.value=e[n],t.done=!1,t;return t.value=undefined,t.done=!0,t};return a.next=a}}return{next:_}}function _(){return{value:undefined,done:!0}}return p.prototype=v,n(b,"constructor",{value:v,configurable:!0}),n(v,"constructor",{value:p,configurable:!0}),p.displayName=l(v,o,"GeneratorFunction"),e.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===p||"GeneratorFunction"===(t.displayName||t.name))},e.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,v):(e.__proto__=v,l(e,o,"GeneratorFunction")),e.prototype=Object.create(b),e},e.awrap=function(e){return{__await:e}},C(k.prototype),l(k.prototype,r,(function(){return this})),e.AsyncIterator=k,e.async=function(t,i,n,a,s){void 0===s&&(s=Promise);var r=new k(c(t,i,n,a),s);return e.isGeneratorFunction(i)?r:r.next().then((function(e){return e.done?e.value:r.next()}))},C(b),l(b,o,"Generator"),l(b,s,(function(){return this})),l(b,"toString",(function(){return"[object Generator]"})),e.keys=function(e){var t=Object(e),i=[];for(var n in t)i.push(n);return i.reverse(),function e(){for(;i.length;){var n=i.pop();if(n in t)return e.value=n,e.done=!1,e}return e.done=!0,e}},e.values=P,T.prototype={constructor:T,reset:function e(t){if(this.prev=0,this.next=0,this.sent=this._sent=undefined,this.done=!1,this.delegate=null,this.method="next",this.arg=undefined,this.tryEntries.forEach(I),!t)for(var n in this)"t"===n.charAt(0)&&i.call(this,n)&&!isNaN(+n.slice(1))&&(this[n]=undefined)},stop:function e(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function e(t){if(this.done)throw t;var n=this;function a(e,i){return o.type="throw",o.arg=t,n.next=e,i&&(n.method="next",n.arg=undefined),!!i}for(var s=this.tryEntries.length-1;s>=0;--s){var r=this.tryEntries[s],o=r.completion;if("root"===r.tryLoc)return a("end");if(r.tryLoc<=this.prev){var l=i.call(r,"catchLoc"),c=i.call(r,"finallyLoc");if(l&&c){if(this.prev<r.catchLoc)return a(r.catchLoc,!0);if(this.prev<r.finallyLoc)return a(r.finallyLoc)}else if(l){if(this.prev<r.catchLoc)return a(r.catchLoc,!0)}else{if(!c)throw new Error("try statement without catch or finally");if(this.prev<r.finallyLoc)return a(r.finallyLoc)}}}},abrupt:function e(t,n){for(var a=this.tryEntries.length-1;a>=0;--a){var s=this.tryEntries[a];if(s.tryLoc<=this.prev&&i.call(s,"finallyLoc")&&this.prev<s.finallyLoc){var r=s;break}}r&&("break"===t||"continue"===t)&&r.tryLoc<=n&&n<=r.finallyLoc&&(r=null);var o=r?r.completion:{};return o.type=t,o.arg=n,r?(this.method="next",this.next=r.finallyLoc,d):this.complete(o)},complete:function e(t,i){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&i&&(this.next=i),d},finish:function e(t){for(var i=this.tryEntries.length-1;i>=0;--i){var n=this.tryEntries[i];if(n.finallyLoc===t)return this.complete(n.completion,n.afterLoc),I(n),d}},catch:function e(t){for(var i=this.tryEntries.length-1;i>=0;--i){var n=this.tryEntries[i];if(n.tryLoc===t){var a=n.completion;if("throw"===a.type){var s=a.arg;I(n)}return s}}throw new Error("illegal catch attempt")},delegateYield:function e(t,i,n){return this.delegate={iterator:P(t),resultName:i,nextLoc:n},"next"===this.method&&(this.arg=undefined),d}},e}var R={defaultMicrophone:"bx-im-settings-default-microphone",defaultCamera:"bx-im-settings-default-camera",defaultSpeaker:"bx-im-settings-default-speaker"};var M={initialized:"initialized",deviceChanged:"deviceChange"};var A=function(e){babelHelpers.inherits(t,e);function t(){var e;babelHelpers.classCallCheck(this,t);e=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this));babelHelpers.defineProperty(babelHelpers.assertThisInitialized(e),"Events",M);e.setEventNamespace("BX.Call.HardwareManager");e.initialized=false;e._currentDeviceList=[];e.updating=false;return e}babelHelpers.createClass(t,[{key:"init",value:function e(){var t=this;if(this.initialized){return Promise.resolve()}if(this.initPromise){return this.initPromise}this._checkPermissions();this.initPromise=new Promise((function(e,i){t.enumerateDevices().then((function(i){t._currentDeviceList=t.filterDeviceList(i);navigator.mediaDevices.addEventListener("devicechange",BX.debounce(t.onNavigatorDeviceChanged.bind(t),500));t.initialized=true;t.initPromise=null;t.emit(M.initialized,{});e()}))["catch"]((function(e){t.initPromise=null;i(e)}))}));return this.initPromise}},{key:"_checkPermissions",value:function(){var e=babelHelpers.asyncToGenerator(E().mark((function e(){var t=this;var i,n;return E().wrap((function e(a){while(1)switch(a.prev=a.next){case 0:a.next=2;return navigator.permissions.query({name:"camera"});case 2:i=a.sent;a.next=5;return navigator.permissions.query({name:"microphone"});case 5:n=a.sent;i.onchange=function(e){t.getCurrentDeviceList()};n.onchange=function(e){t.getCurrentDeviceList()};case 8:case"end":return a.stop()}}),e)})));function t(){return e.apply(this,arguments)}return t}()},{key:"getUserMedia",value:function(){var e=babelHelpers.asyncToGenerator(E().mark((function e(t){return E().wrap((function e(i){while(1)switch(i.prev=i.next){case 0:return i.abrupt("return",new Promise((function(e,i){if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia){var n=new Error("NO_WEBRTC");n.code="NO_WEBRTC";throw n}navigator.mediaDevices.getUserMedia(t).then((function(t){e(t)}))["catch"]((function(e){i(e)}))})));case 1:case"end":return i.stop()}}),e)})));function t(t){return e.apply(this,arguments)}return t}()},{key:"enumerateDevices",value:function(){var e=babelHelpers.asyncToGenerator(E().mark((function e(){var t,i;return E().wrap((function e(n){while(1)switch(n.prev=n.next){case 0:if(!(!navigator.mediaDevices||!navigator.mediaDevices.enumerateDevices)){n.next=4;break}t=new Error("NO_WEBRTC");t.code="NO_WEBRTC";throw t;case 4:n.prev=4;n.next=7;return navigator.mediaDevices.enumerateDevices();case 7:i=n.sent;return n.abrupt("return",i);case 11:n.prev=11;n.t0=n["catch"](4);throw n.t0;case 14:case"end":return n.stop()}}),e,null,[[4,11]])})));function t(){return e.apply(this,arguments)}return t}()},{key:"hasCamera",value:function e(){if(!this.initialized){throw new Error("HardwareManager is not initialized yet")}return Object.keys(this.cameraList).length>0}},{key:"hasMicrophone",value:function e(){if(!this.initialized){throw new Error("HardwareManager is not initialized yet")}return Object.keys(this.microphoneList).length>0}},{key:"getMicrophoneList",value:function e(){if(!this.initialized){throw new Error("HardwareManager is not initialized yet")}return Object.values(this._currentDeviceList).filter((function(e){return e.kind==="audioinput"&&e.deviceId!=="default"}))}},{key:"getCameraList",value:function e(){if(!this.initialized){throw new Error("HardwareManager is not initialized yet")}return Object.values(this._currentDeviceList).filter((function(e){return e.kind=="videoinput"}))}},{key:"getSpeakerList",value:function e(){if(!this.initialized){throw new Error("HardwareManager is not initialized yet")}return Object.values(this._currentDeviceList).filter((function(e){return e.kind==="audiooutput"&&e.deviceId!=="default"}))}},{key:"canSelectSpeaker",value:function e(){return"setSinkId"in HTMLMediaElement.prototype}},{key:"updateDeviceList",value:function e(t){var i=this;if(this.updating){return}this.updating=true;var n=this._currentDeviceList;var a=[];var s=this._currentDeviceList.every((function(e){return e.deviceId==""&&e.label==""}));this.enumerateDevices().then((function(e){e=i.filterDeviceList(e);e.forEach((function(e){var t=n.findIndex((function(t){return t.kind===e.kind&&t.deviceId===e.deviceId&&t.groupId===e.groupId}));if(t!=-1){n.splice(t,1)}else{a.push(e)}}));i._currentDeviceList=e;if(!s){i.emit(M.deviceChanged,{added:a,removed:n})}i.updating=false}))}},{key:"filterDeviceList",value:function e(t){var i=this;return t.filter((function(e){switch(e.kind){case"audioinput":return e.deviceId!=="communications"&&!i.isDeviceInBlackList(e);case"audiooutput":return e.deviceId!=="communications"&&!i.isDeviceInBlackList(e);default:return true}}))}},{key:"isDeviceInBlackList",value:function e(t){var i=["(virtual)","zoomaudiodevice","microsoft teams audio","bitrixaudio"];var n=false;i.forEach((function(e){if(t.label.toLowerCase().includes(e)){n=true;return false}}));return n}},{key:"onNavigatorDeviceChanged",value:function e(t){if(!this.initialized){return}this.updateDeviceList()}},{key:"_getDeviceMap",value:function e(t){var i={};if(!this.initialized){throw new Error("HardwareManager is not initialized yet")}for(var n=0;n<this._currentDeviceList.length;n++){if(this._currentDeviceList[n].kind==t){i[this._currentDeviceList[n].deviceId]=this._currentDeviceList[n].label}}return i}},{key:"getDefaultDeviceIdByGroupId",value:function e(t,i){var n;this._currentDeviceList.forEach((function(e){if(e.groupId===t&&e.deviceId!=="default"&&e.kind===i){n=e.deviceId;return false}}));return n}},{key:"getDeviceGroupIdByDeviceId",value:function e(t,i){var n;this._currentDeviceList.forEach((function(e){if(e.deviceId===t&&e.kind===i){n=e.groupId;return false}}));return n}},{key:"removeDevicesByDefaultGroup",value:function e(t){var i=t;t.forEach((function(e){if(e.deviceId==="default"){i=i.filter((function(t){return t.kind!==e.kind||t.groupId!==e.groupId}))}}));return i}},{key:"getCurrentDeviceList",value:function e(){var t=this;return new Promise((function(e,i){t.enumerateDevices().then((function(i){t._currentDeviceList=t.filterDeviceList(i);e(t._currentDeviceList,i)}))}))}},{key:"getRemovedUsedDevices",value:function e(t,i){return t.filter((function(e){switch(e.kind){case"audioinput":return e.deviceId===i.microphoneId;case"audiooutput":return e.deviceId===i.speakerId;case"videoinput":return e.deviceId===i.cameraId;default:return false}}))}},{key:"cameraList",get:function e(){return this._getDeviceMap("videoinput")}},{key:"microphoneList",get:function e(){return this._getDeviceMap("audioinput")}},{key:"audioOutputList",get:function e(){return this._getDeviceMap("audiooutput")}},{key:"defaultMicrophone",get:function e(){var t=localStorage?localStorage.getItem(R.defaultMicrophone):"";if((!t||!this.microphoneList[t])&&Object.keys(this.microphoneList).length){if(Object.keys(this.microphoneList).includes("default")){t=this.getDefaultDeviceIdByGroupId(this.getDeviceGroupIdByDeviceId("default","audioinput"),"audioinput")}if(!t){t=Object.keys(this.microphoneList)[0]}return t}return this.microphoneList[t]?t:""},set:function e(t){if(localStorage){localStorage.setItem(R.defaultMicrophone,t)}}},{key:"defaultCamera",get:function e(){var t=localStorage?localStorage.getItem(R.defaultCamera):"";if((!t||!this.cameraList[t])&&Object.keys(this.cameraList).length){return Object.keys(this.cameraList)[0]}return this.cameraList[t]?t:""},set:function e(t){if(localStorage){localStorage.setItem(R.defaultCamera,t)}}},{key:"defaultSpeaker",get:function e(){var t=localStorage?localStorage.getItem(R.defaultSpeaker):"";if((!t||this.audioOutputList[t])&&Object.keys(this.audioOutputList).length){t=Object.keys(this.audioOutputList).includes("default")?this.getDefaultDeviceIdByGroupId(this.getDeviceGroupIdByDeviceId("default","audiooutput"),"audiooutput"):Object.keys(this.audioOutputList)[0];return t}return this.audioOutputList[t]?t:""},set:function e(t){if(localStorage){localStorage.setItem(R.defaultSpeaker,t)}}}]);return t}(f.EventEmitter);var L={enableMicAutoParameters:"bx-im-settings-enable-mic-auto-parameters",preferHd:"bx-im-settings-camera-prefer-hd",enableMirroring:"bx-im-settings-camera-enable-mirroring"};var B={onChangeMirroringVideo:"onChangeMirroringVideo",onChangeMicrophoneMuted:"onChangeMicrophoneMuted",onChangeCameraOn:"onChangeCameraOn"};var D=function(e){babelHelpers.inherits(t,e);function t(){var e;babelHelpers.classCallCheck(this,t);e=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this));e._isCameraOn=false;e._isMicrophoneMuted=false;e.Events=Object.assign(e.Events,B);return e}babelHelpers.createClass(t,[{key:"setIsCameraOn",value:function e(t){if(this._isCameraOn!==t.isCameraOn){this._isCameraOn=t.isCameraOn;this.emit(this.Events.onChangeCameraOn,t)}}},{key:"setIsMicrophoneMuted",value:function e(t){if(this._isMicrophoneMuted!==t.isMicrophoneMuted){this._isMicrophoneMuted=t.isMicrophoneMuted;this.emit(this.Events.onChangeMicrophoneMuted,t)}}},{key:"enableMicAutoParameters",get:function e(){return localStorage?localStorage.getItem(L.enableMicAutoParameters)!=="N":true},set:function e(t){if(localStorage){localStorage.setItem(L.enableMicAutoParameters,t?"Y":"N")}}},{key:"preferHdQuality",get:function e(){return localStorage?localStorage.getItem(L.preferHd)!=="N":true},set:function e(t){if(localStorage){localStorage.setItem(L.preferHd,t?"Y":"N")}}},{key:"enableMirroring",get:function e(){return localStorage?localStorage.getItem(L.enableMirroring)!=="N":true},set:function e(t){if(this.enableMirroring!==t){this.emit(this.Events.onChangeMirroringVideo,{enableMirroring:t});if(DesktopApi.isDesktop()){DesktopApi.emit(this.Events.onChangeMirroringVideo,[t])}if(localStorage){localStorage.setItem(L.enableMirroring,t?"Y":"N")}}}},{key:"isCameraOn",get:function e(){return this._isCameraOn},set:function e(t){if(this._isCameraOn!==t){this._isCameraOn=t;this.emit(this.Events.onChangeCameraOn,{isCameraOn:this._isCameraOn})}}},{key:"isMicrophoneMuted",get:function e(){return this._isMicrophoneMuted},set:function e(t){if(this._isMicrophoneMuted!==t){this._isMicrophoneMuted=t;this.emit(this.Events.onChangeMicrophoneMuted,{isMicrophoneMuted:this._isMicrophoneMuted})}}}]);return t}(A);var H=new D;function N(){/*! regenerator-runtime -- Copyright (c) 2014-present, Facebook, Inc. -- license (MIT): https://github.com/facebook/regenerator/blob/main/LICENSE */N=function t(){return e};var e={},t=Object.prototype,i=t.hasOwnProperty,n=Object.defineProperty||function(e,t,i){e[t]=i.value},a="function"==typeof Symbol?Symbol:{},s=a.iterator||"@@iterator",r=a.asyncIterator||"@@asyncIterator",o=a.toStringTag||"@@toStringTag";function l(e,t,i){return Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{l({},"")}catch(e){l=function e(t,i,n){return t[i]=n}}function c(e,t,i,a){var s=t&&t.prototype instanceof h?t:h,r=Object.create(s.prototype),o=new T(a||[]);return n(r,"_invoke",{value:y(e,i,o)}),r}function u(e,t,i){try{return{type:"normal",arg:e.call(t,i)}}catch(e){return{type:"throw",arg:e}}}e.wrap=c;var d={};function h(){}function p(){}function v(){}var f={};l(f,s,(function(){return this}));var m=Object.getPrototypeOf,g=m&&m(m(P([])));g&&g!==t&&i.call(g,s)&&(f=g);var b=v.prototype=h.prototype=Object.create(f);function C(e){["next","throw","return"].forEach((function(t){l(e,t,(function(e){return this._invoke(t,e)}))}))}function k(e,t){function a(n,s,r,o){var l=u(e[n],e,s);if("throw"!==l.type){var c=l.arg,d=c.value;return d&&"object"==babelHelpers["typeof"](d)&&i.call(d,"__await")?t.resolve(d.__await).then((function(e){a("next",e,r,o)}),(function(e){a("throw",e,r,o)})):t.resolve(d).then((function(e){c.value=e,r(c)}),(function(e){return a("throw",e,r,o)}))}o(l.arg)}var s;n(this,"_invoke",{value:function e(i,n){function r(){return new t((function(e,t){a(i,n,e,t)}))}return s=s?s.then(r,r):r()}})}function y(e,t,i){var n="suspendedStart";return function(a,s){if("executing"===n)throw new Error("Generator is already running");if("completed"===n){if("throw"===a)throw s;return _()}for(i.method=a,i.arg=s;;){var r=i.delegate;if(r){var o=S(r,i);if(o){if(o===d)continue;return o}}if("next"===i.method)i.sent=i._sent=i.arg;else if("throw"===i.method){if("suspendedStart"===n)throw n="completed",i.arg;i.dispatchException(i.arg)}else"return"===i.method&&i.abrupt("return",i.arg);n="executing";var l=u(e,t,i);if("normal"===l.type){if(n=i.done?"completed":"suspendedYield",l.arg===d)continue;return{value:l.arg,done:i.done}}"throw"===l.type&&(n="completed",i.method="throw",i.arg=l.arg)}}}function S(e,t){var i=t.method,n=e.iterator[i];if(undefined===n)return t.delegate=null,"throw"===i&&e.iterator["return"]&&(t.method="return",t.arg=undefined,S(e,t),"throw"===t.method)||"return"!==i&&(t.method="throw",t.arg=new TypeError("The iterator does not provide a '"+i+"' method")),d;var a=u(n,e.iterator,t.arg);if("throw"===a.type)return t.method="throw",t.arg=a.arg,t.delegate=null,d;var s=a.arg;return s?s.done?(t[e.resultName]=s.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=undefined),t.delegate=null,d):s:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,d)}function w(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function I(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function T(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(w,this),this.reset(!0)}function P(e){if(e){var t=e[s];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var n=-1,a=function t(){for(;++n<e.length;)if(i.call(e,n))return t.value=e[n],t.done=!1,t;return t.value=undefined,t.done=!0,t};return a.next=a}}return{next:_}}function _(){return{value:undefined,done:!0}}return p.prototype=v,n(b,"constructor",{value:v,configurable:!0}),n(v,"constructor",{value:p,configurable:!0}),p.displayName=l(v,o,"GeneratorFunction"),e.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===p||"GeneratorFunction"===(t.displayName||t.name))},e.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,v):(e.__proto__=v,l(e,o,"GeneratorFunction")),e.prototype=Object.create(b),e},e.awrap=function(e){return{__await:e}},C(k.prototype),l(k.prototype,r,(function(){return this})),e.AsyncIterator=k,e.async=function(t,i,n,a,s){void 0===s&&(s=Promise);var r=new k(c(t,i,n,a),s);return e.isGeneratorFunction(i)?r:r.next().then((function(e){return e.done?e.value:r.next()}))},C(b),l(b,o,"Generator"),l(b,s,(function(){return this})),l(b,"toString",(function(){return"[object Generator]"})),e.keys=function(e){var t=Object(e),i=[];for(var n in t)i.push(n);return i.reverse(),function e(){for(;i.length;){var n=i.pop();if(n in t)return e.value=n,e.done=!1,e}return e.done=!0,e}},e.values=P,T.prototype={constructor:T,reset:function e(t){if(this.prev=0,this.next=0,this.sent=this._sent=undefined,this.done=!1,this.delegate=null,this.method="next",this.arg=undefined,this.tryEntries.forEach(I),!t)for(var n in this)"t"===n.charAt(0)&&i.call(this,n)&&!isNaN(+n.slice(1))&&(this[n]=undefined)},stop:function e(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function e(t){if(this.done)throw t;var n=this;function a(e,i){return o.type="throw",o.arg=t,n.next=e,i&&(n.method="next",n.arg=undefined),!!i}for(var s=this.tryEntries.length-1;s>=0;--s){var r=this.tryEntries[s],o=r.completion;if("root"===r.tryLoc)return a("end");if(r.tryLoc<=this.prev){var l=i.call(r,"catchLoc"),c=i.call(r,"finallyLoc");if(l&&c){if(this.prev<r.catchLoc)return a(r.catchLoc,!0);if(this.prev<r.finallyLoc)return a(r.finallyLoc)}else if(l){if(this.prev<r.catchLoc)return a(r.catchLoc,!0)}else{if(!c)throw new Error("try statement without catch or finally");if(this.prev<r.finallyLoc)return a(r.finallyLoc)}}}},abrupt:function e(t,n){for(var a=this.tryEntries.length-1;a>=0;--a){var s=this.tryEntries[a];if(s.tryLoc<=this.prev&&i.call(s,"finallyLoc")&&this.prev<s.finallyLoc){var r=s;break}}r&&("break"===t||"continue"===t)&&r.tryLoc<=n&&n<=r.finallyLoc&&(r=null);var o=r?r.completion:{};return o.type=t,o.arg=n,r?(this.method="next",this.next=r.finallyLoc,d):this.complete(o)},complete:function e(t,i){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&i&&(this.next=i),d},finish:function e(t){for(var i=this.tryEntries.length-1;i>=0;--i){var n=this.tryEntries[i];if(n.finallyLoc===t)return this.complete(n.completion,n.afterLoc),I(n),d}},catch:function e(t){for(var i=this.tryEntries.length-1;i>=0;--i){var n=this.tryEntries[i];if(n.tryLoc===t){var a=n.completion;if("throw"===a.type){var s=a.arg;I(n)}return s}}throw new Error("illegal catch attempt")},delegateYield:function e(t,i,n){return this.delegate={iterator:P(t),resultName:i,nextLoc:n},"next"===this.method&&(this.arg=undefined),d}},e}function x(e,t){U(e,t);t.add(e)}function O(e,t,i){U(e,t);t.set(e,i)}function U(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}function F(e,t,i){if(!t.has(e)){throw new TypeError("attempted to get private field on non-instance")}return i}var V=new WeakMap;var G=new WeakMap;var W=new WeakMap;var X=new WeakMap;var z=new WeakSet;var j=new WeakSet;var q=new WeakSet;var Y=new WeakSet;var Q=new WeakSet;var J=new WeakSet;var K=function(){function e(){var t,i,n;babelHelpers.classCallCheck(this,e);x(this,J);x(this,Q);x(this,Y);x(this,q);x(this,j);x(this,z);O(this,V,{writable:true,value:void 0});O(this,G,{writable:true,value:void 0});O(this,W,{writable:true,value:void 0});O(this,X,{writable:true,value:void 0});babelHelpers.classPrivateFieldSet(this,V,{});babelHelpers.classPrivateFieldSet(this,G,{});babelHelpers.classPrivateFieldSet(this,W,{});babelHelpers.classPrivateFieldSet(this,X,((t=window)===null||t===void 0?void 0:(i=t.BXDesktopSystem)===null||i===void 0?void 0:(n=i.GetProperty("versionParts"))===null||n===void 0?void 0:n[3])<78)}babelHelpers.createClass(e,[{key:"getLocalStream",value:function e(t){var i;return((i=babelHelpers.classPrivateFieldGet(this,G)[t])===null||i===void 0?void 0:i.track)||null}},{key:"getUserMedia",value:function(){var e=babelHelpers.asyncToGenerator(N().mark((function e(t){var i;return N().wrap((function e(n){while(1)switch(n.prev=n.next){case 0:i=F(this,j,$).call(this,t);return n.abrupt("return",F(this,z,Z).call(this,i));case 2:case"end":return n.stop()}}),e,this)})));function t(t){return e.apply(this,arguments)}return t}()},{key:"getUserScreen",value:function(){var e=babelHelpers.asyncToGenerator(N().mark((function e(){var t;return N().wrap((function e(i){while(1)switch(i.prev=i.next){case 0:t=F(this,q,ee).call(this);return i.abrupt("return",F(this,z,Z).call(this,t));case 2:case"end":return i.stop()}}),e,this)})));function t(){return e.apply(this,arguments)}return t}()},{key:"stopStream",value:function e(t){var i=this;if(babelHelpers.classPrivateFieldGet(this,W)[t]){var n;(n=babelHelpers.classPrivateFieldGet(this,W)[t])===null||n===void 0?void 0:n.then((function(){i.stopStream(t)}));delete babelHelpers.classPrivateFieldGet(this,W)[t]}if(babelHelpers.classPrivateFieldGet(this,G)[t]){babelHelpers.classPrivateFieldGet(this,G)[t].track.stop();delete babelHelpers.classPrivateFieldGet(this,G)[t]}}}]);return e}();function Z(e){return Promise.allSettled(e).then((function(e){var t=new Map;e.forEach((function(e){if(e.reason){throw new Error(e.reason)}e.value.forEach((function(e){t.set(e.id,e)}))}));if(t.size>0){return new MediaStream(babelHelpers.toConsumableArray(t.values()))}throw new Error("Could not get any media stream")}))}function $(e){var t=this;var i=[];var n={video:false,audio:false};var a=F(this,Q,ie).call(this,e.video,ge.Camera);var s=F(this,Q,ie).call(this,e.audio,ge.Microphone);if(a){i.push(a)}else if(e.video){n.video=e.video}if(s){i.push(s)}else if(e.audio){n.audio=e.audio}if(i.length===Number(Boolean(e.video))+Number(Boolean(e.audio))){return i}var r=new Promise((function(i,a){H.getUserMedia(n).then((function(n){var a,s;var r=(a=n.getVideoTracks())===null||a===void 0?void 0:a[0];var o=(s=n.getAudioTracks())===null||s===void 0?void 0:s[0];if(r){var l,c;(l=babelHelpers.classPrivateFieldGet(t,G)[ge.Camera])===null||l===void 0?void 0:(c=l.track)===null||c===void 0?void 0:c.stop();babelHelpers.classPrivateFieldGet(t,G)[ge.Camera]={track:r,constraints:e.video};delete babelHelpers.classPrivateFieldGet(t,W)[ge.Camera]}if(o){var u,d;(u=babelHelpers.classPrivateFieldGet(t,G)[ge.Microphone])===null||u===void 0?void 0:(d=u.track)===null||d===void 0?void 0:d.stop();babelHelpers.classPrivateFieldGet(t,G)[ge.Microphone]={track:o,constraints:e.audio};delete babelHelpers.classPrivateFieldGet(t,W)[ge.Microphone]}i(n.getTracks())}))["catch"]((function(e){if(n.video){delete babelHelpers.classPrivateFieldGet(t,G)[ge.Camera];delete babelHelpers.classPrivateFieldGet(t,W)[ge.Camera]}if(n.audio){delete babelHelpers.classPrivateFieldGet(t,G)[ge.Microphone];delete babelHelpers.classPrivateFieldGet(t,W)[ge.Microphone]}a(e)}))}));if(n.video){babelHelpers.classPrivateFieldGet(this,W)[ge.Camera]=r}if(n.audio){babelHelpers.classPrivateFieldGet(this,W)[ge.Microphone]=r}i.push(r);return i}function ee(){var e=this;var t=[];var i=null;var n=F(this,Q,ie).call(this,undefined,ge.Screen);var a=F(this,Q,ie).call(this,undefined,ge.ScreenAudio);if(n){t.push(n)}if(a){t.push(a)}if(t.length>0){return t}var s=F(this,J,ne).call(this);if(babelHelpers.classPrivateFieldGet(this,X)){i=H.getUserMedia(s)}else if(navigator.mediaDevices.getDisplayMedia){i=navigator.mediaDevices.getDisplayMedia(s)}else{var r={message:"Screen sharing is not supported"};t.push(Promise.reject(r));return t}var o=new Promise((function(t,n){i.then((function(i){var n,a;var s=(n=i.getVideoTracks())===null||n===void 0?void 0:n[0];var r=(a=i.getAudioTracks())===null||a===void 0?void 0:a[0];if(s){var o,l;(o=babelHelpers.classPrivateFieldGet(e,G)[ge.Screen])===null||o===void 0?void 0:(l=o.track)===null||l===void 0?void 0:l.stop();babelHelpers.classPrivateFieldGet(e,G)[ge.Screen]={track:s};delete babelHelpers.classPrivateFieldGet(e,W)[ge.Screen]}if(r){var c,u;(c=babelHelpers.classPrivateFieldGet(e,G)[ge.ScreenAudio])===null||c===void 0?void 0:(u=c.track)===null||u===void 0?void 0:u.stop();babelHelpers.classPrivateFieldGet(e,G)[ge.ScreenAudio]={track:r};delete babelHelpers.classPrivateFieldGet(e,W)[ge.ScreenAudio]}t(i.getTracks())}))["catch"]((function(t){delete babelHelpers.classPrivateFieldGet(e,G)[ge.Screen];delete babelHelpers.classPrivateFieldGet(e,G)[ge.ScreenAudio];delete babelHelpers.classPrivateFieldGet(e,W)[ge.Screen];delete babelHelpers.classPrivateFieldGet(e,W)[ge.ScreenAudio];n(t)}))}));babelHelpers.classPrivateFieldGet(this,W)[ge.Screen]=o;babelHelpers.classPrivateFieldGet(this,W)[ge.ScreenAudio]=o;t.push(o);return t}function te(e,t){if(!e&&!t){return true}if(!e||!t){return false}var i=Object.keys(e);var n=Object.keys(t);if(i.length!==n.length){return false}for(var a=0,s=i;a<s.length;a++){var r=s[a];if(JSON.stringify(e[r])!==JSON.stringify(t[r])){return false}}return true}function ie(e,t){var i;var n=babelHelpers.classPrivateFieldGet(this,W)[t];if(e&&n){return n}var a=babelHelpers.classPrivateFieldGet(this,G)[t];var s=F(this,Y,te).call(this,e,a===null||a===void 0?void 0:a.constraints);if((a===null||a===void 0?void 0:(i=a.track)===null||i===void 0?void 0:i.readyState)==="live"&&s){return Promise.resolve([a.track])}return null}function ne(){var e=1920;var t=1080;if(babelHelpers.classPrivateFieldGet(this,X)){return{video:{mandatory:{chromeMediaSource:"screen",maxWidth:e,maxHeight:t,maxFrameRate:5}}}}return{video:{cursor:"always",width:{ideal:e},height:{ideal:t}},systemAudio:"include",audio:true}}var ae=new K;function se(e,t){var i=typeof Symbol!=="undefined"&&e[Symbol.iterator]||e["@@iterator"];if(!i){if(Array.isArray(e)||(i=re(e))||t&&e&&typeof e.length==="number"){if(i)e=i;var n=0;var a=function e(){};return{s:a,n:function t(){if(n>=e.length)return{done:true};return{done:false,value:e[n++]}},e:function e(t){throw t},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var s=true,r=false,o;return{s:function t(){i=i.call(e)},n:function e(){var t=i.next();s=t.done;return t},e:function e(t){r=true;o=t},f:function e(){try{if(!s&&i["return"]!=null)i["return"]()}finally{if(r)throw o}}}}function re(e,t){if(!e)return;if(typeof e==="string")return oe(e,t);var i=Object.prototype.toString.call(e).slice(8,-1);if(i==="Object"&&e.constructor)i=e.constructor.name;if(i==="Map"||i==="Set")return Array.from(e);if(i==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i))return oe(e,t)}function oe(e,t){if(t==null||t>e.length)t=e.length;for(var i=0,n=new Array(t);i<t;i++)n[i]=e[i];return n}function le(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function ce(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?le(Object(i),!0).forEach((function(t){babelHelpers.defineProperty(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):le(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}function ue(){/*! regenerator-runtime -- Copyright (c) 2014-present, Facebook, Inc. -- license (MIT): https://github.com/facebook/regenerator/blob/main/LICENSE */ue=function t(){return e};var e={},t=Object.prototype,i=t.hasOwnProperty,n=Object.defineProperty||function(e,t,i){e[t]=i.value},a="function"==typeof Symbol?Symbol:{},s=a.iterator||"@@iterator",r=a.asyncIterator||"@@asyncIterator",o=a.toStringTag||"@@toStringTag";function l(e,t,i){return Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{l({},"")}catch(e){l=function e(t,i,n){return t[i]=n}}function c(e,t,i,a){var s=t&&t.prototype instanceof h?t:h,r=Object.create(s.prototype),o=new T(a||[]);return n(r,"_invoke",{value:y(e,i,o)}),r}function u(e,t,i){try{return{type:"normal",arg:e.call(t,i)}}catch(e){return{type:"throw",arg:e}}}e.wrap=c;var d={};function h(){}function p(){}function v(){}var f={};l(f,s,(function(){return this}));var m=Object.getPrototypeOf,g=m&&m(m(P([])));g&&g!==t&&i.call(g,s)&&(f=g);var b=v.prototype=h.prototype=Object.create(f);function C(e){["next","throw","return"].forEach((function(t){l(e,t,(function(e){return this._invoke(t,e)}))}))}function k(e,t){function a(n,s,r,o){var l=u(e[n],e,s);if("throw"!==l.type){var c=l.arg,d=c.value;return d&&"object"==babelHelpers["typeof"](d)&&i.call(d,"__await")?t.resolve(d.__await).then((function(e){a("next",e,r,o)}),(function(e){a("throw",e,r,o)})):t.resolve(d).then((function(e){c.value=e,r(c)}),(function(e){return a("throw",e,r,o)}))}o(l.arg)}var s;n(this,"_invoke",{value:function e(i,n){function r(){return new t((function(e,t){a(i,n,e,t)}))}return s=s?s.then(r,r):r()}})}function y(e,t,i){var n="suspendedStart";return function(a,s){if("executing"===n)throw new Error("Generator is already running");if("completed"===n){if("throw"===a)throw s;return _()}for(i.method=a,i.arg=s;;){var r=i.delegate;if(r){var o=S(r,i);if(o){if(o===d)continue;return o}}if("next"===i.method)i.sent=i._sent=i.arg;else if("throw"===i.method){if("suspendedStart"===n)throw n="completed",i.arg;i.dispatchException(i.arg)}else"return"===i.method&&i.abrupt("return",i.arg);n="executing";var l=u(e,t,i);if("normal"===l.type){if(n=i.done?"completed":"suspendedYield",l.arg===d)continue;return{value:l.arg,done:i.done}}"throw"===l.type&&(n="completed",i.method="throw",i.arg=l.arg)}}}function S(e,t){var i=t.method,n=e.iterator[i];if(undefined===n)return t.delegate=null,"throw"===i&&e.iterator["return"]&&(t.method="return",t.arg=undefined,S(e,t),"throw"===t.method)||"return"!==i&&(t.method="throw",t.arg=new TypeError("The iterator does not provide a '"+i+"' method")),d;var a=u(n,e.iterator,t.arg);if("throw"===a.type)return t.method="throw",t.arg=a.arg,t.delegate=null,d;var s=a.arg;return s?s.done?(t[e.resultName]=s.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=undefined),t.delegate=null,d):s:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,d)}function w(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function I(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function T(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(w,this),this.reset(!0)}function P(e){if(e){var t=e[s];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var n=-1,a=function t(){for(;++n<e.length;)if(i.call(e,n))return t.value=e[n],t.done=!1,t;return t.value=undefined,t.done=!0,t};return a.next=a}}return{next:_}}function _(){return{value:undefined,done:!0}}return p.prototype=v,n(b,"constructor",{value:v,configurable:!0}),n(v,"constructor",{value:p,configurable:!0}),p.displayName=l(v,o,"GeneratorFunction"),e.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===p||"GeneratorFunction"===(t.displayName||t.name))},e.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,v):(e.__proto__=v,l(e,o,"GeneratorFunction")),e.prototype=Object.create(b),e},e.awrap=function(e){return{__await:e}},C(k.prototype),l(k.prototype,r,(function(){return this})),e.AsyncIterator=k,e.async=function(t,i,n,a,s){void 0===s&&(s=Promise);var r=new k(c(t,i,n,a),s);return e.isGeneratorFunction(i)?r:r.next().then((function(e){return e.done?e.value:r.next()}))},C(b),l(b,o,"Generator"),l(b,s,(function(){return this})),l(b,"toString",(function(){return"[object Generator]"})),e.keys=function(e){var t=Object(e),i=[];for(var n in t)i.push(n);return i.reverse(),function e(){for(;i.length;){var n=i.pop();if(n in t)return e.value=n,e.done=!1,e}return e.done=!0,e}},e.values=P,T.prototype={constructor:T,reset:function e(t){if(this.prev=0,this.next=0,this.sent=this._sent=undefined,this.done=!1,this.delegate=null,this.method="next",this.arg=undefined,this.tryEntries.forEach(I),!t)for(var n in this)"t"===n.charAt(0)&&i.call(this,n)&&!isNaN(+n.slice(1))&&(this[n]=undefined)},stop:function e(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function e(t){if(this.done)throw t;var n=this;function a(e,i){return o.type="throw",o.arg=t,n.next=e,i&&(n.method="next",n.arg=undefined),!!i}for(var s=this.tryEntries.length-1;s>=0;--s){var r=this.tryEntries[s],o=r.completion;if("root"===r.tryLoc)return a("end");if(r.tryLoc<=this.prev){var l=i.call(r,"catchLoc"),c=i.call(r,"finallyLoc");if(l&&c){if(this.prev<r.catchLoc)return a(r.catchLoc,!0);if(this.prev<r.finallyLoc)return a(r.finallyLoc)}else if(l){if(this.prev<r.catchLoc)return a(r.catchLoc,!0)}else{if(!c)throw new Error("try statement without catch or finally");if(this.prev<r.finallyLoc)return a(r.finallyLoc)}}}},abrupt:function e(t,n){for(var a=this.tryEntries.length-1;a>=0;--a){var s=this.tryEntries[a];if(s.tryLoc<=this.prev&&i.call(s,"finallyLoc")&&this.prev<s.finallyLoc){var r=s;break}}r&&("break"===t||"continue"===t)&&r.tryLoc<=n&&n<=r.finallyLoc&&(r=null);var o=r?r.completion:{};return o.type=t,o.arg=n,r?(this.method="next",this.next=r.finallyLoc,d):this.complete(o)},complete:function e(t,i){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&i&&(this.next=i),d},finish:function e(t){for(var i=this.tryEntries.length-1;i>=0;--i){var n=this.tryEntries[i];if(n.finallyLoc===t)return this.complete(n.completion,n.afterLoc),I(n),d}},catch:function e(t){for(var i=this.tryEntries.length-1;i>=0;--i){var n=this.tryEntries[i];if(n.tryLoc===t){var a=n.completion;if("throw"===a.type){var s=a.arg;I(n)}return s}}throw new Error("illegal catch attempt")},delegateYield:function e(t,i,n){return this.delegate={iterator:P(t),resultName:i,nextLoc:n},"next"===this.method&&(this.arg=undefined),d}},e}function de(e,t){pe(e,t);t.add(e)}function he(e,t,i){pe(e,t);t.set(e,i)}function pe(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}function ve(e,t,i){if(!t.has(e)){throw new TypeError("attempted to get private field on non-instance")}return i}var fe="web";var me="1.0.0";var ge={Camera:1,Microphone:2,Screen:3,ScreenAudio:4};var be=function e(t,i){babelHelpers.classCallCheck(this,e);babelHelpers.defineProperty(this,"id",null);babelHelpers.defineProperty(this,"source","");babelHelpers.defineProperty(this,"track",{});this.id=t;this.source=i.source;this.track=i};var Ce=function e(t){babelHelpers.classCallCheck(this,e);this.text=t.message;this.from=t.senderSid;this.timestamp=Math.floor(Date.now()/1e3)};var ke={CONNECTED:"Connected",PROGRESSING:"Progressing",TERMINATED:"Terminated"};var ye={INITIAL:"",ENABLE:"enable",DISABLE:"disable"};var Se={INFO:"INFO",WARNING:"WARNING",ERROR:"ERROR"};var we={TRACK_SUBSCRIPTION_FAILED:"webrtc_track_subscription_failed",TRACK_SUBSCRIPTION_DELAY:"webrtc_track_subscription_delay",HIGH_PACKET_LOSS_SEND:"webrtc_high_packet_loss_send",HIGH_PACKET_LOSS_RECEIVE:"webrtc_high_packet_loss_receive",CPU_ISSUES:"webrtc_cpu_issues",NETWORK_ISSUES:"webrtc_network_issues",NETWORK_LATENCY_MS:"webrtc_network_latency_ms",PEER_CONNECTION_REFUSED:"webrtc_peer_connection_refused",PEER_CONNECTION_ISSUES_HANDLING_OFFER:"webrtc_peer_connection_issues_handling_offer",PEER_CONNECTION_ISSUES_HANDLING_ANSWER:"webrtc_peer_connection_issues_handling_answer",PEER_CONNECTION_ISSUES_ADDING_ICE_CANDIDATE:"webrtc_peer_connection_issues_adding_ice_candidate",USER_CAMERA_DISABLED:"webrtc_user_camera_disabled",USER_RECONNECTED:"webrtc_user_reconnected",LOCAL_VIDEO_STREAM_RECEIVING_FAILED:"webrtc_local_video_stream_receiving_failed",LOCAL_MICROPHONE_STREAM_RECEIVING_FAILED:"webrtc_local_microphone_stream_receiving_failed",LOCAL_SCREEN_STREAM_RECEIVING_FAILED:"webrtc_local_screen_stream_receiving_failed",LOCAL_VIDEO_STREAM_PUBLICATION_FAILED:"webrtc_local_video_stream_publication_failed",LOCAL_MICROPHONE_STREAM_PUBLICATION_FAILED:"webrtc_local_microphone_stream_publication_failed",LOCAL_SCREEN_STREAM_PUBLICATION_FAILED:"webrtc_local_screen_stream_publication_failed",STREAM_FAILURE_TOTAL:"webrtc_stream_failure_total",RECONNECT_ATTEMPTS:"webrtc_reconnect_attempts",RECONNECT_DURATION_SECONDS:"webrtc_reconnect_duration_seconds",CPU_USAGE_PERCENT:"webrtc_cpu_usage_percent",HIGH_PACKET_LOSS_PERCENT:"webrtc_packet_loss_percent",SUBSCRIPTION_DELAY_MS:"webrtc_subscription_delay_ms"};var Ie={COUNT_TRACKS:"COUNT_TRACKS",COUNT_VIDEO_TRACKS:"COUNT_VIDEO_TRACKS",COUNT_AUDIO_TRACKS:"COUNT_AUDIO_TRACKS",PACKET_LOST_RECEIVE:"PACKET_LOST_RECEIVE",PACKET_LOST_SEND:"PACKET_LOST_SEND",BITRATE_IN:"BITRATE_IN",BITRATE_OUT:"BITRATE_OUT",CONN_SCORE_CURRENT:"CONN_SCORE_CURRENT",FRAMES_LOSS:"FRAMES_LOSS",FREEZE_COUNT:"FREEZE_COUNT",TOTAL_FREEZE_DURATION:"TOTAL_FREEZE_DURATION",JITTER:"JITTER",FRAMES_DECODED:"FRAMES_DECODED",FRAMES_DROPPED:"FRAMES_DROPPED",FRAMES_RECEIVED:"FRAMES_RECEIVED"};var Te={COUNT_TRACKS:"webrtc_active_tracks",COUNT_VIDEO_TRACKS:"webrtc_active_video_tracks",COUNT_AUDIO_TRACKS:"webrtc_active_audio_tracks",PACKET_LOST_RECEIVE:"webrtc_packets_lost_receive_total",PACKET_LOST_SEND:"webrtc_packets_lost_send_total",BITRATE_IN:"webrtc_bitrate_receive_bps",BITRATE_OUT:"webrtc_bitrate_send_bps",CONN_SCORE_CURRENT:"webrtc_connection_score",FRAMES_LOSS:"webrtc_frames_lost_total",FREEZE_COUNT:"webrtc_freeze_count_total",TOTAL_FREEZE_DURATION:"webrtc_freeze_duration_seconds_total",JITTER:"webrtc_jitter_seconds",FRAMES_DECODED:"webrtc_frames_decoded_total",FRAMES_DROPPED:"webrtc_frames_dropped_total",FRAMES_RECEIVED:"webrtc_frames_received_total"};var Pe={UNAVAILABLE:0,NONE:1,ENABLED:2,DISABLED:3,PAUSED:4,DESTROYED:5};var _e={NONE:1,STARTED:2,STOPPED:3,PAUSED:4,DESTROYED:5};var Ee={AUDIO:1,VIDEO:2};var Re={NetworkError:"NetworkError",PingPongMissed:"PingPongMissed",PeerConnectionFailed:"PeerConnectionFailed",WsTransportClosed:"WsTransportClosed",LeaveCommand:"LeaveCommand",JoinResponseError:"JoinResponseError"};var Me={CanNotCreateRoom:1,InputError:2,AccessDenied:3,RoomNotFound:5,MalfunctioningSignaling:7,JsonParsingError:"JsonParsingError",UnexpectedResponse:"UnexpectedResponse",UnknownError:"UnknownError"};var Ae={PeerToPeer:0,MediaServer:1};var Le={Normal:1e3,Reconnect:4001};var Be=function(e){babelHelpers.inherits(t,e);function t(e,i){var n;var a;babelHelpers.classCallCheck(this,t);var s=null;var r=null;var o=Object.entries(Me).find((function(e){var t=babelHelpers.slicedToArray(e,2),n=t[0],a=t[1];return a===i}));if(o){var l=babelHelpers.slicedToArray(o,2);r=l[0];s=l[1]}if(!r){r="UnknownError"}a=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this,e));a.name=r;a.code=(n=s)!==null&&n!==void 0?n:i;return a}return t}(babelHelpers.wrapNativeSuper(Error));var De={Reconnected:"Reconnected",Connected:"Connected"};var He=new WeakMap;var Ne=new WeakSet;var xe=new WeakSet;var Oe=new WeakSet;var Ue=new WeakSet;var Fe=new WeakSet;var Ve=new WeakSet;var Ge=new WeakSet;var We=new WeakSet;var Xe=new WeakSet;var ze=new WeakSet;var je=new WeakSet;var qe=new WeakSet;var Ye=new WeakSet;var Qe=new WeakSet;var Je=new WeakSet;var Ke=new WeakSet;var Ze=new WeakSet;var $e=new WeakSet;var et=new WeakSet;var tt=new WeakSet;var it=new WeakSet;var nt=new WeakSet;var at=new WeakSet;var st=new WeakSet;var rt=new WeakSet;var ot=new WeakSet;var lt=new WeakSet;var ct=new WeakSet;var ut=new WeakSet;var dt=new WeakSet;var ht=new WeakSet;var pt=new WeakSet;var vt=new WeakSet;var ft=new WeakSet;var mt=new WeakSet;var gt=new WeakSet;var bt=new WeakSet;var Ct=new WeakSet;var kt=new WeakSet;var yt=new WeakSet;var St=new WeakSet;var wt=new WeakSet;var It=new WeakSet;var Tt=new WeakSet;var Pt=new WeakSet;var _t=new WeakSet;var Et=new WeakSet;var Rt=new WeakSet;var Mt=new WeakSet;var At=function(){function e(){var t=this;babelHelpers.classCallCheck(this,e);de(this,Mt);de(this,Rt);de(this,Et);de(this,_t);de(this,Pt);de(this,Tt);de(this,It);de(this,wt);de(this,St);de(this,yt);de(this,kt);de(this,Ct);de(this,bt);de(this,gt);de(this,mt);de(this,ft);de(this,vt);de(this,pt);de(this,ht);de(this,dt);de(this,ut);de(this,ct);de(this,lt);de(this,ot);de(this,rt);de(this,st);de(this,at);de(this,nt);de(this,it);de(this,tt);de(this,et);de(this,$e);de(this,Ze);de(this,Ke);de(this,Je);de(this,Qe);de(this,Ye);de(this,qe);de(this,je);de(this,ze);de(this,Xe);de(this,We);de(this,Ge);de(this,Ve);de(this,Fe);de(this,Ue);de(this,Oe);de(this,xe);de(this,Ne);babelHelpers.defineProperty(this,"sender",null);babelHelpers.defineProperty(this,"recipient",null);he(this,He,{writable:true,value:{codec:"vp8",canReconnect:true,logs:{},isloggingEnable:true,loggerCallback:null,abortController:new AbortController,isWaitAnswer:false,reportsForIncomingTracks:{},outgoingTracksReports:{},prevParticipantsWithLargeDataLoss:new Set,tracksDataFromSocket:{},realTracksIds:{},mediaServerUrl:null,monitoringServerUrl:"",monitoringLogsServerUrl:"",monitoringJwtToken:"",monitoringEnvironment:"",monitoringRegion:"",roomData:null,roomType:Ic.Small,roomId:null,isLegacy:false,token:null,endpoint:null,jwt:null,options:null,iceServers:null,socketConnect:null,peerConnectionFailed:false,pendingOffer:null,pendingCandidates:{recipient:[],sender:[]},pendingPublications:{},pendingSubscriptions:{},publicationTimeout:1e4,subscriptionTimeout:1500,subscriptionTries:5,cameraStream:null,microphoneStream:null,screenStream:null,needToStopStreams:true,mediaMutedBySystem:false,needToEnableAudioAfterSystemMuted:false,needToDisableAudioAfterPublish:false,localTracks:{},localConnectionQuality:0,minimalConnectionQuality:2,rtt:0,pingIntervalDuration:0,pingTimeoutDuration:0,ontrackData:{},remoteTracks:{},remoteParticipants:{},participantsToUpdateTrackAvailability:{},mainStream:{},pingPongTimeout:null,pingPongInterval:null,userId:"",localParticipantSid:"",defaultVideoResolution:{width:1280,height:720},defaultSimulcastBitrate:{q:12e4,h:3e5,f:1e6},defaultRemoteStreamsQuality:P.MEDIUM,audioBitrate:7e4,videoBitrate:15e5,screenBitrate:15e5,videoSimulcast:true,screenSimulcast:false,events:new Map,offersStack:0,audioDeviceId:"",switchActiveAudioDeviceInProgress:null,switchActiveAudioDevicePending:null,videoDeviceId:"",switchActiveVideoDeviceInProgress:null,switchActiveVideoDevicePending:null,isReconnecting:false,reconnectionAttempt:0,reconnectionTimeout:null,lastReconnectionReason:null,fastReconnectionDelay:1e3,reconnectionDelay:5e3,callStatsInterval:null,callState:"",wasConnected:false,packetLostThreshold:7,statsTimeout:3e3,videoQueue:ye.INITIAL,videoStreamSetupErrorList:{}}});this.sendLeaveBound=ve(this,Mt,Mi).bind(this);this.beforeDisconnectBound=ve(this,xe,Bt).bind(this);this.monitoringEvents=[];this.monitoringDelayTime=3e4;this.monitoringIntervalTime=5e3;this.countMetricsInMetricsInterval=this.monitoringDelayTime/babelHelpers.classPrivateFieldGet(this,He).statsTimeout;this.monitoringInterval=null;this.currentMonitoringEventsObject={metrics:[],events:[],logs:[],increasingEvents:[]};this.currentMonitoringRtcStatsObject={};this.prevInboundRtpStatsSum={freezeCount:0,totalFreezesDuration:0,jitter:0,framesDecoded:0,framesDropped:0,framesReceived:0};p.Event.EventEmitter.subscribe("BX.Call.Logger:sendLog",(function(e){t.setLog(e.data)}));this.initConnectionEvent();H.maxLocalStreamQualityHeight=_.HIGH}babelHelpers.createClass(e,[{key:"onChangeConnection",value:function e(t){var i=t.rtt;if(!i&&!babelHelpers.classPrivateFieldGet(this,He).isReconnecting){ve(this,xe,Bt).call(this);ve(this,Ne,Lt).call(this,{reconnectionReason:"ON_CHANGE_CONNECTION",reconnectionReasonInfo:"RTT: ".concat(i)})}}},{key:"initConnectionEvent",value:function e(){var t=this;var i=navigator.connection||navigator.mozConnection||navigator.webkitConnection;if(!i){return}i.addEventListener("change",(function(){t.onChangeConnection(i)}))}},{key:"checkMetricsFeatureAndExecutionCallback",value:function e(t){if(typeof t==="function"&&Yf.isMetricsEnabled()){t()}}},{key:"clearMonitoringEvents",value:function e(){this.monitoringEvents=[]}},{key:"calcBitrateSumFromArray",value:function e(t){var i=t.bitrateArray;if(i&&Array.isArray(i)){return i.reduce((function(e,t){return e+t.bitrate||0}),0)}return 0}},{key:"addValidatedMonitoringMetric",value:function e(t){var i=t.additionalData,n=t.metricValue,a=t.metricKey;if(!this.currentMonitoringRtcStatsObject[a]){this.currentMonitoringRtcStatsObject[a]={metric:{__name__:Te[a]||a,user_id:String(babelHelpers.classPrivateFieldGet(this,He).userId),session_id:String(babelHelpers.classPrivateFieldGet(this,He).roomId),env:String(babelHelpers.classPrivateFieldGet(this,He).monitoringEnvironment),region:String(babelHelpers.classPrivateFieldGet(this,He).monitoringRegion),platform:fe},values:[],timestamps:[]}}this.currentMonitoringRtcStatsObject[a].values.push(n);this.currentMonitoringRtcStatsObject[a].timestamps.push(Date.now());if(this.currentMonitoringEventsObject.metrics[a]){this.currentMonitoringEventsObject.metrics[a].push(n)}}},{key:"addMonitoringEvents",value:function e(t){var i=t.name,n=t.value,a=n===void 0?1:n,s=t.withCounter,r=s===void 0?false:s;var o=this.currentMonitoringEventsObject.events.findIndex((function(e){return e.name===i}));if(r){var l=this.currentMonitoringEventsObject.increasingEvents.findIndex((function(e){return e.name===i}));if(l===-1){this.currentMonitoringEventsObject.increasingEvents.push({name:i,value:a})}else{this.currentMonitoringEventsObject.increasingEvents[l].value+=1;a=this.currentMonitoringEventsObject.increasingEvents[l].value}}this.addValidatedMonitoringMetric({metricKey:i,metricValue:a})}},{key:"setClearValuesForCurrentMonitoringEventsObject",value:function e(){this.currentMonitoringEventsObject.events=[];this.currentMonitoringEventsObject.logs=[];this.currentMonitoringEventsObject.metrics=this.fillDefaultValueMonitoringMetrics()}},{key:"getCountRemoteTracks",value:function e(){var t=0;var i=0;Object.values(babelHelpers.classPrivateFieldGet(this,He).remoteParticipants).forEach((function(e){if(e.getTrack(ge.Camera)&&!e.isMutedVideo&&!e.isLocalVideoMute){t+=1}if(e.getTrack(ge.Microphone)&&!e.isMutedAudio){i+=1}if(e.getTrack(ge.Screen)){t+=1}if(e.getTrack(ge.ScreenAudio)){i+=1}}));return{countVideoTracks:t,countAudioTracks:i}}},{key:"getDefaultValueMonitoringMetric",value:function e(t){switch(t){case"COUNT_TRACKS":return{video:0,audio:0};default:return[]}}},{key:"fillDefaultValueMonitoringMetrics",value:function e(){var t=this;return Object.entries(Ie).reduce((function(e,i){var n=babelHelpers.slicedToArray(i,2),a=n[0],s=n[1];e[s]=t.getDefaultValueMonitoringMetric(a);return e}),{})}},{key:"startAggregateMonitoringEvents",value:function e(){var t=this;this.setClearValuesForCurrentMonitoringEventsObject();if(Yf.isMetricsEnabled()){this.monitoringInterval=setInterval((function(){var e=t.getCountRemoteTracks(),i=e.countVideoTracks,n=e.countAudioTracks;t.currentMonitoringEventsObject.metrics[Ie.COUNT_TRACKS]={video:i,audio:n}}),this.monitoringIntervalTime)}this.monitoringTimeout=setTimeout((function(){clearTimeout(t.monitoringTimeout);t.monitoringTimeout=null;if(babelHelpers.classPrivateFieldGet(t,He).isReconnecting){return}t.sendMonitoringEvents()}),this.monitoringDelayTime)}},{key:"sendLogMonitoringRtcStats",value:function e(){if(Yf.isMetricsEnabled()){var t=!!Object.keys(this.currentMonitoringRtcStatsObject);var i="";if(t){for(var n in this.currentMonitoringRtcStatsObject){if(this.currentMonitoringRtcStatsObject.hasOwnProperty(n)){i+=JSON.stringify(this.currentMonitoringRtcStatsObject[n])+"\r\n"}}}for(var a in this.currentMonitoringEventsObject.events){if(this.currentMonitoringEventsObject.events.hasOwnProperty(a)){i+=JSON.stringify(this.currentMonitoringEventsObject.events[a])+"\r\n"}}if(i){this.sendMonitoringHandler(i,babelHelpers.classPrivateFieldGet(this,He).monitoringServerUrl,babelHelpers.classPrivateFieldGet(this,He).monitoringJwtToken)}}if(Yf.isMetricsLogsEnabled()&&this.currentMonitoringEventsObject.logs.length){var s={resourceLogs:[{resource:{attributes:{"service.name":"call-logs","service.version":"v0.0.1",platform:fe}},scopeLogs:[{scope:{name:"call-logs",version:"v0.0.1"},logRecords:this.currentMonitoringEventsObject.logs}]}]};var r=JSON.stringify(s);this.sendMonitoringHandler(r,babelHelpers.classPrivateFieldGet(this,He).monitoringLogsServerUrl,babelHelpers.classPrivateFieldGet(this,He).monitoringJwtToken)}this.currentMonitoringRtcStatsObject={}}},{key:"sendMonitoringHandler",value:function e(t,i,n){if(!i){return}var a=new XMLHttpRequest;a.open("POST",i,true);a.setRequestHeader("Content-Type","application/json");if(n){a.setRequestHeader("Authorization","Bearer "+n)}a.send(t)}},{key:"sendMonitoringEvents",value:function e(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:true;this.sendLogMonitoringRtcStats();clearInterval(this.monitoringInterval);this.monitoringInterval=null;clearTimeout(this.monitoringTimeout);this.monitoringTimeout=null;if(t){this.startAggregateMonitoringEvents()}}},{key:"onPublishFailed",value:function e(t){var i=this;this.triggerEvents("PublishFailed",[t]);var n;if(t===ge.Camera){n=we.LOCAL_VIDEO_STREAM_PUBLICATION_FAILED}else if(t===ge.Microphone){n=we.LOCAL_MICROPHONE_STREAM_PUBLICATION_FAILED}else if(t===ge.Screen){n=we.LOCAL_SCREEN_STREAM_PUBLICATION_FAILED}this.checkMetricsFeatureAndExecutionCallback((function(){i.addMonitoringEvents({name:n,withCounter:true})}))}},{key:"connect",value:function(){var e=babelHelpers.asyncToGenerator(ue().mark((function e(t){var i=this;var n,a,s;return ue().wrap((function e(r){while(1)switch(r.prev=r.next){case 0:this.setLog("Connecting to the call (desktop: ".concat(Yf.isDesktop(),")"),Se.INFO);babelHelpers.classPrivateFieldGet(this,He).callState=ke.PROGRESSING;for(n in t){babelHelpers.classPrivateFieldGet(this,He)["".concat(n)]=t[n]}if(!babelHelpers.classPrivateFieldGet(this,He).isLegacy){r.next=13;break}if(babelHelpers.classPrivateFieldGet(this,He).endpoint){r.next=8;break}this.setLog("Missing required param 'endpoint' from backend, disconnecting",Se.ERROR);this.triggerEvents("Failed",[{name:"AUTHORIZE_ERROR",message:"Missing required param 'endpoint'"}]);return r.abrupt("return");case 8:if(babelHelpers.classPrivateFieldGet(this,He).jwt){r.next=12;break}this.setLog("Missing required param 'jwt' from backend, disconnecting",Se.ERROR);this.triggerEvents("Failed",[{name:"AUTHORIZE_ERROR",message:"Missing required param 'jwt'"}]);return r.abrupt("return");case 12:babelHelpers.classPrivateFieldGet(this,He).endpoint=babelHelpers.classPrivateFieldGet(this,He).endpoint.replace(/\/+$/,"");case 13:a=babelHelpers.classPrivateFieldGet(this,He).mediaServerUrl&&babelHelpers.classPrivateFieldGet(this,He).roomData;if(a){r.next=33;break}r.prev=15;r.next=18;return this.getMediaServerInfo();case 18:s=r.sent;babelHelpers.classPrivateFieldGet(this,He).mediaServerUrl=s.mediaServerUrl;babelHelpers.classPrivateFieldGet(this,He).roomData=s.roomData;babelHelpers.classPrivateFieldGet(this,He).roomType=s.roomType;babelHelpers.classPrivateFieldGet(this,He).monitoringServerUrl=s.monitoringServerUrl;babelHelpers.classPrivateFieldGet(this,He).monitoringLogsServerUrl=s.monitoringLogsServerUrl;babelHelpers.classPrivateFieldGet(this,He).monitoringJwtToken=s.monitoringJwtToken;babelHelpers.classPrivateFieldGet(this,He).monitoringEnvironment=s.monitoringEnvironment;babelHelpers.classPrivateFieldGet(this,He).monitoringRegion=s.monitoringRegion;r.next=33;break;case 29:r.prev=29;r.t0=r["catch"](15);if(r.t0.name!=="AbortError"&&!babelHelpers.classPrivateFieldGet(this,He).abortController.signal.aborted){ve(this,Ne,Lt).call(this,{reconnectionReason:"GET_MEDIASERVER_INFO",reconnectionReasonInfo:(r.t0===null||r.t0===void 0?void 0:r.t0.name)||""})}else if(babelHelpers.classPrivateFieldGet(this,He).abortController.signal.aborted){this.triggerEvents("Failed",[r.t0])}return r.abrupt("return");case 33:if(!babelHelpers.classPrivateFieldGet(this,He).abortController.signal.aborted){r.next=36;break}ve(this,xe,Bt).call(this);return r.abrupt("return");case 36:babelHelpers.classPrivateFieldGet(this,He).abortController.signal.addEventListener("abort",this.beforeDisconnectBound);babelHelpers.classPrivateFieldGet(this,He).socketConnect=new WebSocket("".concat(babelHelpers.classPrivateFieldGet(this,He).mediaServerUrl,"?auto_subscribe=1&sdk=js&version=1.6.7&protocol=8")+"&roomData=".concat(babelHelpers.classPrivateFieldGet(this,He).roomData)+"&clientVersion=".concat(me)+"&clientPlatform=".concat(fe));babelHelpers.classPrivateFieldGet(this,He).socketConnect.onmessage=function(e){return i.socketOnMessageHandler(e)};babelHelpers.classPrivateFieldGet(this,He).socketConnect.onopen=function(){return i.socketOnOpenHandler()};babelHelpers.classPrivateFieldGet(this,He).socketConnect.onerror=function(){return i.socketOnErrorHandler()};babelHelpers.classPrivateFieldGet(this,He).socketConnect.onclose=function(e){return i.socketOnCloseHandler(e)};case 42:case"end":return r.stop()}}),e,this,[[15,29]])})));function t(t){return e.apply(this,arguments)}return t}()},{key:"getMediaServerInfo",value:function e(){var t=this;var i=null;if(babelHelpers.classPrivateFieldGet(this,He).isLegacy){var n="".concat(babelHelpers.classPrivateFieldGet(this,He).endpoint,"/join");n+="?token=".concat(babelHelpers.classPrivateFieldGet(this,He).jwt);n+="&clientVersion=".concat(me);n+="&clientPlatform=".concat(fe);i=new Promise((function(e,i){fetch(n,{method:"GET",signal:babelHelpers.classPrivateFieldGet(t,He).abortController.signal}).then((function(e){return e.json()})).then((function(t){e(t)}))["catch"]((function(e){i(e)}))}))}else{i=Yf.getCallConnectionDataById(babelHelpers.classPrivateFieldGet(this,He).roomId)}return new Promise((function(e,n){var a=function e(t){var i=new Set(["InputError","AccessDenied","RoomNotFound","MalfunctioningSignaling","CanNotCreateRoom"]);return Object.entries(Me).some((function(e){var n=babelHelpers.slicedToArray(e,2),a=n[0],s=n[1];return i.has(a)&&s===t}))};i.then((function(t){var i,n,a,s,r,o,l;if(t.error){throw t.error}else if(!(t!==null&&t!==void 0&&(i=t.result)!==null&&i!==void 0&&i.mediaServerUrl)||!(t!==null&&t!==void 0&&(n=t.result)!==null&&n!==void 0&&n.roomData)){throw{name:"MEDIASERVER_MISSING_PARAMS",message:"Incorrect signaling response"}}var c=t.result,u=c.mediaServerUrl,d=c.roomData,h=c.roomType;var p=(a=t.result.monitoring)===null||a===void 0?void 0:a.metricsServerUrl;var v=(s=t.result.monitoring)===null||s===void 0?void 0:s.logsServerUrl;var f=(r=t.result.monitoring)===null||r===void 0?void 0:r.token;var m=(o=t.result.monitoring)===null||o===void 0?void 0:o.env;var g=(l=t.result.monitoring)===null||l===void 0?void 0:l.region;e({mediaServerUrl:u,roomData:d,roomType:h,monitoringServerUrl:p,monitoringLogsServerUrl:v,monitoringJwtToken:f,monitoringEnvironment:m,monitoringRegion:g})}))["catch"]((function(e){if(e.code&&a(e.code)||e.name==="AbortError"||e.name==="SyntaxError"){babelHelpers.classPrivateFieldGet(t,He).abortController.abort();n({name:"MEDIASERVER_UNEXPECTED_ANSWER",message:e===null||e===void 0?void 0:e.message})}else{babelHelpers.classPrivateFieldGet(t,He).lastReconnectionReason=e.code?Re.JoinResponseError:Re.NetworkError;n({name:"MEDIASERVER_ERROR",message:"Reason: ".concat(e===null||e===void 0?void 0:e.message)})}}))}))}},{key:"sendOffer",value:function(){var e=babelHelpers.asyncToGenerator(ue().mark((function e(){var t;return ue().wrap((function e(i){while(1)switch(i.prev=i.next){case 0:if(!(babelHelpers.classPrivateFieldGet(this,He).offersStack>0&&!babelHelpers.classPrivateFieldGet(this,He).isWaitAnswer)){i.next=20;break}this.setLog("Start sending an offer",Se.INFO);babelHelpers.classPrivateFieldGet(this,He).isWaitAnswer=true;babelHelpers.classPrivateFieldGet(this,He).offersStack--;i.prev=4;i.next=7;return this.sender.createOffer();case 7:t=i.sent;if(Yf.useTcpSdp()){t={type:t.type,sdp:ve(this,ct,oi).call(this,t.sdp)}}i.next=11;return this.sender.setLocalDescription(t);case 11:ve(this,Rt,Ri).call(this,{offer:t});this.setLog("Sending an offer succeeded",Se.INFO);i.next=20;break;case 15:i.prev=15;i.t0=i["catch"](4);this.setLog("Sending an offer failed: ".concat(i.t0),Se.ERROR);ve(this,xe,Bt).call(this);ve(this,Ne,Lt).call(this,{reconnectionReason:"SENDING_OFFER",reconnectionReasonInfo:"Sending an offer failed: ".concat(i.t0)});case 20:case"end":return i.stop()}}),e,this,[[4,15]])})));function t(){return e.apply(this,arguments)}return t}()},{key:"startStream",value:function(){var e=babelHelpers.asyncToGenerator(ue().mark((function e(){var t,i;return ue().wrap((function e(n){while(1)switch(n.prev=n.next){case 0:n.next=2;return this.getLocalVideo();case 2:t=n.sent;if(!t){n.next=8;break}n.next=6;return this.publishTrack(ge.Camera,t);case 6:n.next=10;break;case 8:ve(this,_t,_i).call(this,ge.Camera);this.onPublishFailed(ge.Camera);case 10:n.next=12;return this.getLocalAudio();case 12:i=n.sent;if(!i){n.next=18;break}n.next=16;return this.publishTrack(ge.Microphone,i);case 16:n.next=20;break;case 18:ve(this,_t,_i).call(this,ge.Microphone);this.onPublishFailed(ge.Microphone);case 20:case"end":return n.stop()}}),e,this)})));function t(){return e.apply(this,arguments)}return t}()},{key:"socketOnMessageHandler",value:function(){var e=babelHelpers.asyncToGenerator(ue().mark((function e(t){var i,n,a,s=this,r,o,l,c,u,d,h,p,v,f,m,g,b;var C,k,y,S,w,I,T,P,_,E,R,M,A,L,B,D,H,N,x,O,U,F,V,G,W,X,z,j,q,Y,Q,J,K,Z,$,ee;return ue().wrap((function e(te){while(1)switch(te.prev=te.next){case 0:if(!(typeof t.data!=="string")){te.next=2;break}return te.abrupt("return");case 2:te.prev=2;C=JSON.parse(t.data);te.next=10;break;case 6:te.prev=6;te.t0=te["catch"](2);this.setLog("Could not parse a socket message: ".concat(t.data),Se.WARNING);return te.abrupt("return");case 10:if(!((i=C)!==null&&i!==void 0&&i.answer)){te.next=15;break}te.next=13;return ve(this,ut,li).call(this,C);case 13:te.next=162;break;case 15:if(!((n=C)!==null&&n!==void 0&&n.offer)){te.next=20;break}te.next=18;return ve(this,dt,ui).call(this,C);case 18:te.next=162;break;case 20:if(!((a=C)!==null&&a!==void 0&&a.joinResponse)){te.next=46;break}if(C.joinResponse.role){Yf.setCurrentUserRole(C.joinResponse.role)}babelHelpers.classPrivateFieldGet(this,He).abortController.signal.removeEventListener("abort",this.beforeDisconnectBound);babelHelpers.classPrivateFieldGet(this,He).iceServers=C.joinResponse.iceServers;babelHelpers.classPrivateFieldGet(this,He).localParticipantSid=C.joinResponse.localParticipant.sid;ve(this,Tt,Ti).call(this);k=babelHelpers.classPrivateFieldGet(this,He).isReconnecting&&this.wasConnected?De.Reconnected:De.Connected;babelHelpers.classPrivateFieldGet(this,He).callState=ke.CONNECTED;this.wasConnected=true;this.setLog("".concat(k," to the call ").concat(babelHelpers.classPrivateFieldGet(this,He).roomId," on the mediaserver after ").concat(babelHelpers.classPrivateFieldGet(this,He).reconnectionAttempt," attempts"),Se.INFO);babelHelpers.classPrivateFieldGet(this,He).isReconnecting=false;babelHelpers.classPrivateFieldGet(this,He).reconnectionAttempt=0;if(C.joinResponse.oneToOneType){this.triggerEvents("ConnectionTypeChanged",[{type:C.joinResponse.oneToOneType}])}if(C.joinResponse.permissions&&k===De.Connected){ve(this,pt,pi).call(this,C.joinResponse.permissions)}if(C.joinResponse.roomState&&k===De.Connected){Yf.setRoomPermissions(C.joinResponse.roomState);Yf.setUserPermissionsByRoomPermissions(C.joinResponse.roomState)}this.checkMetricsFeatureAndExecutionCallback((function(){if(k===De.Reconnected&&s.monitoringEvents.length){s.sendMonitoringEvents()}}));y=ce({},babelHelpers.classPrivateFieldGet(this,He).remoteParticipants);Object.values(C.joinResponse.otherParticipants).forEach((function(e){if(y[e.userId]){delete y[e.userId]}s.setLog("Adding an early connected participant with id ".concat(e.userId," (sid: ").concat(e.sid,")"),Se.INFO);ve(s,vt,vi).call(s,e)}));if(k===De.Reconnected){for(S in y){w=babelHelpers.classPrivateFieldGet(this,He).remoteParticipants[S];this.setLog("Deleting a missing participant with id ".concat(w.userId," (sid: ").concat(w.sid,")"),Se.INFO);this.triggerEvents("ParticipantLeaved",[w]);delete babelHelpers.classPrivateFieldGet(this,He).remoteTracks[S];delete babelHelpers.classPrivateFieldGet(this,He).remoteParticipants[S]}}if("recorderStatus"in C.joinResponse){I={code:C.joinResponse.recorderStatus};if(C.joinResponse.recorderRespStatus){I.errMsg=C.joinResponse.recorderRespStatus}this.triggerEvents("RecorderStatusChanged",[I])}babelHelpers.classPrivateFieldGet(this,He).pingIntervalDuration=C.joinResponse.pingInterval*1e3;babelHelpers.classPrivateFieldGet(this,He).pingTimeoutDuration=babelHelpers.classPrivateFieldGet(this,He).pingIntervalDuration*2;ve(this,Fe,Nt).call(this);this.triggerEvents(k);te.next=162;break;case 46:if(!((r=C)!==null&&r!==void 0&&r.participantJoined)){te.next=51;break}this.setLog("Adding a new participant with id ".concat(C.participantJoined.participant.userId," (sid: ").concat(C.participantJoined.participant.sid,")"),Se.INFO);ve(this,vt,vi).call(this,C.participantJoined.participant);te.next=162;break;case 51:if(!((o=C)!==null&&o!==void 0&&o.participantLeft)){te.next=59;break}T=C.participantLeft.userId;P=babelHelpers.classPrivateFieldGet(this,He).remoteParticipants[T];_=babelHelpers.classPrivateFieldGet(this,He).pendingSubscriptions[T];if(_){for(E in _){clearTimeout(_[E].timeout);this.setLog("A participant with id ".concat(T," (sid: ").concat(C.participantLeft.sid,") left during subscription attempt, cancel it"),Se.WARNING)}delete babelHelpers.classPrivateFieldGet(this,He).pendingSubscriptions[T]}if(P){this.setLog("Deleting a participant with id ".concat(P.userId," (sid: ").concat(P.sid,")"),Se.INFO);this.triggerEvents("ParticipantLeaved",[P]);delete babelHelpers.classPrivateFieldGet(this,He).remoteTracks[T];delete babelHelpers.classPrivateFieldGet(this,He).remoteParticipants[T]}else{this.setLog("Got participantLeft signal for a non-existent participant with id ".concat(T," (sid: ").concat(C.participantLeft.sid,")"),Se.WARNING)}te.next=162;break;case 59:if(!((l=C)!==null&&l!==void 0&&l.trackCreated)){te.next=99;break}R=C.trackCreated.userId;M=C.trackCreated.cid;A=C.trackCreated.track;L=A.sid;A.userId=R;if(!(R==babelHelpers.classPrivateFieldGet(this,He).userId)){te.next=78;break}B=babelHelpers.classPrivateFieldGet(this,He).pendingPublications[M];if(!B){te.next=75;break}clearTimeout(babelHelpers.classPrivateFieldGet(this,He).pendingPublications[M]);delete babelHelpers.classPrivateFieldGet(this,He).pendingPublications[M];this.setLog("Publishing a local track with kind ".concat(A.source," (sid: ").concat(L,") succeeded"),Se.INFO);babelHelpers.classPrivateFieldGet(this,He).localTracks[A.source]=A;this.triggerEvents("PublishSucceed",[A.source]);if(A.source===ge.Microphone&&babelHelpers.classPrivateFieldGet(this,He).needToDisableAudioAfterPublish){babelHelpers.classPrivateFieldGet(this,He).needToDisableAudioAfterPublish=false;this.disableAudio({calledFrom:"data.trackCreated"})}else if(A.source===ge.Camera&&babelHelpers.classPrivateFieldGet(this,He).videoQueue){ve(this,tt,Kt).call(this)}return te.abrupt("return");case 75:this.setLog("Got trackCreated signal for a non-existent local track with kind ".concat(A.source," (sid: ").concat(L,")"),Se.WARNING);te.next=97;break;case 78:babelHelpers.classPrivateFieldGet(this,He).tracksDataFromSocket[L]=A;D=babelHelpers.classPrivateFieldGet(this,He).remoteParticipants[R];if(!D){te.next=96;break}this.setLog("Got a track info with kind ".concat(A.source," (sid: ").concat(C.trackCreated.track.sid,") for a participant with id ").concat(R," (sid: ").concat(D.sid,"), waiting for it"),Se.INFO);te.t1=A.source;te.next=te.t1===ge.Camera?85:te.t1===ge.Microphone?87:te.t1===ge.Screen?89:91;break;case 85:D.videoEnabled=true;return te.abrupt("break",91);case 87:D.audioEnabled=true;return te.abrupt("break",91);case 89:D.screenSharingEnabled=true;return te.abrupt("break",91);case 91:H=babelHelpers.classPrivateFieldGet(this,He).ontrackData[L];delete babelHelpers.classPrivateFieldGet(this,He).ontrackData[L];if(H){ve(this,ft,fi).call(this,L,H)}else{ve(this,Xe,Ft).call(this,D,A)}te.next=97;break;case 96:this.setLog("Got a track info with kind ".concat(A.source," (sid: ").concat(C.trackCreated.track.sid,") for a non-existent participant with id ").concat(R),Se.WARNING);case 97:te.next=162;break;case 99:if(!((c=C)!==null&&c!==void 0&&c.trackDeleted)){te.next=122;break}te.prev=100;O=C.trackDeleted.publisher;U=C.trackDeleted.shortId;F=(N=babelHelpers.classPrivateFieldGet(this,He).pendingSubscriptions[O])===null||N===void 0?void 0:N[U];if(F){clearTimeout(F.timeout);delete babelHelpers.classPrivateFieldGet(this,He).pendingSubscriptions[O][U];this.setLog("Track with id ".concat(U," was deleted during subscription attempt, cancel it"),Se.WARNING)}if(!(O==babelHelpers.classPrivateFieldGet(this,He).userId)){te.next=107;break}return te.abrupt("return");case 107:this.setLog("Start deleting a track with id ".concat(U," from a participant with id ").concat(O," "),Se.INFO);V=babelHelpers.classPrivateFieldGet(this,He).remoteParticipants[O];if(V){te.next=112;break}this.setLog("Deleting a track with id ".concat(U," failed: can't find a participant with id ").concat(O),Se.WARNING);return te.abrupt("return");case 112:G=(x=Object.values(V.tracks))===null||x===void 0?void 0:x.find((function(e){return(e===null||e===void 0?void 0:e.id)===U}));delete babelHelpers.classPrivateFieldGet(this,He).tracksDataFromSocket[U];if(G){if(G.source===ge.Microphone){V.audioEnabled=false}else if(G.source===ge.Camera){V.videoEnabled=false}else if(G.source===ge.Screen){V.screenSharingEnabled=false}V.removeTrack(G.source);this.setLog("Deleting a track with id ".concat(U," from a participant with id ").concat(O," (sid: ").concat(V.sid,") succeeded"),Se.INFO);this.triggerEvents("RemoteMediaRemoved",[V,G])}else{this.setLog("Deleting a track with id ".concat(U," from a participant with id ").concat(O," (sid: ").concat(V.sid,") failed: can't find a track"),Se.WARNING)}te.next=120;break;case 117:te.prev=117;te.t2=te["catch"](100);this.setLog("Deleting a track with id ".concat(trackId," from a participant with id ").concat(participantId," failed: ").concat(te.t2),Se.ERROR);case 120:te.next=162;break;case 122:if(!((u=C)!==null&&u!==void 0&&u.trackMuted)){te.next=126;break}ve(this,gt,gi).call(this,C.trackMuted);te.next=162;break;case 126:if(!C.recorderStatus){te.next=130;break}this.triggerEvents("RecorderStatusChanged",[C.recorderStatus]);te.next=162;break;case 130:if(!((d=C)!==null&&d!==void 0&&d.videoRecorderStatus)){te.next=134;break}this.triggerEvents("CloudRecordStatusChanged",[C.videoRecorderStatus]);te.next=162;break;case 134:if(!((h=C)!==null&&h!==void 0&&h.trickle)){te.next=138;break}ve(this,ht,hi).call(this,C.trickle);te.next=162;break;case 138:if(!((p=C)!==null&&p!==void 0&&p.newMessage)){te.next=143;break}W=new Ce(C.newMessage);this.triggerEvents("MessageReceived",[W]);te.next=162;break;case 143:if(!((v=C)!==null&&v!==void 0&&v.handRaised)){te.next=148;break}X=babelHelpers.classPrivateFieldGet(this,He).remoteParticipants[C.handRaised.participantId];if(X){X.isHandRaised=C.handRaised.isHandRaised;this.triggerEvents("HandRaised",[X])}te.next=162;break;case 148:if(!((f=C)!==null&&f!==void 0&&f.speakersChanged)){te.next=152;break}ve(this,mt,mi).call(this,C);te.next=162;break;case 152:if(!((m=C)!==null&&m!==void 0&&m.connectionQuality)){te.next=161;break}if(C.connectionQuality.updates){te.next=155;break}return te.abrupt("return");case 155:z={};j=ce({},babelHelpers.classPrivateFieldGet(this,He).remoteParticipants);C.connectionQuality.updates.forEach((function(e){Object.values(j).forEach((function(t){var i=e.score>babelHelpers.classPrivateFieldGet(s,He).minimalConnectionQuality;if(e.participantSid===t.sid&&(!t.isMutedVideo||!t.connectionQuality)&&!t.screenSharingEnabled){z[t.userId]=e.score;babelHelpers.classPrivateFieldGet(s,He).remoteParticipants[t.userId].connectionQuality=e.score}var n=babelHelpers.classPrivateFieldGet(s,He).localTracks[ge.Camera]&&babelHelpers.classPrivateFieldGet(s,He).localTracks[ge.Camera].muted;s.checkMetricsFeatureAndExecutionCallback((function(){if(e.participantSid===babelHelpers.classPrivateFieldGet(s,He).localParticipantSid){s.addValidatedMonitoringMetric({metricKey:Ie.CONN_SCORE_CURRENT,metricValue:e.score})}}));if(e.participantSid===babelHelpers.classPrivateFieldGet(s,He).localParticipantSid&&(!n||!babelHelpers.classPrivateFieldGet(s,He).localConnectionQuality)&&!babelHelpers.classPrivateFieldGet(s,He).localTracks[ge.Screen]){z[babelHelpers.classPrivateFieldGet(s,He).userId]=e.score;babelHelpers.classPrivateFieldGet(s,He).localConnectionQuality=e.score}}))}));this.triggerEvents("ConnectionQualityChanged",[z]);te.next=162;break;case 161:if(C.pongResp){babelHelpers.classPrivateFieldGet(this,He).rtt=Date.now()-C.pongResp.lastPingTimestamp;ve(this,Oe,Dt).call(this)}else if(C.leave){this.setLog("Got leave signal with ".concat(C.leave.reason," reason"),Se.WARNING);ve(this,xe,Bt).call(this,{initiatedByUser:true});q=["CHANGING_MEDIA_SERVER","FULL_RECONNECT_NEEDED","STATE_MISMATCH"];if((C.leave.canReconnect||q.includes(C.leave.reason))&&C.leave.reason!=="SIGNALING_DUPLICATE_PARTICIPANT"){babelHelpers.classPrivateFieldGet(this,He).lastReconnectionReason=Re.LeaveCommand;ve(this,Ne,Lt).call(this,{reconnectionReason:"GOT_LEAVE_SIGNAL",reconnectionReasonInfo:"Leave reason ".concat(C.leave.reason)})}else{babelHelpers.classPrivateFieldGet(this,He).canReconnect=false;this.triggerEvents("Failed",[{name:C.leave.reason,leaveInformation:{code:C.leave.code,reason:C.leave.reason}}])}}else if((g=C)!==null&&g!==void 0&&g.onErrorResponse){this.setLog("Got signaling error: ".concat(C.onErrorResponse.message),Se.ERROR)}else if((b=C)!==null&&b!==void 0&&b.onActionSent){if((Y=C)!==null&&Y!==void 0&&Y.onActionSent.changeSettings){ve(this,It,Ii).call(this,C.onActionSent.changeSettings)}else if((Q=C)!==null&&Q!==void 0&&Q.onActionSent.givePermissions){ve(this,wt,wi).call(this,C.onActionSent.givePermissions)}else if((J=C)!==null&&J!==void 0&&J.onActionSent.participantMuted){ve(this,kt,ki).call(this,C.onActionSent.participantMuted)}else if((K=C)!==null&&K!==void 0&&K.onActionSent.allParticipantsMuted){ve(this,yt,yi).call(this,C.onActionSent.allParticipantsMuted)}else if((Z=C)!==null&&Z!==void 0&&Z.onActionSent.updateRole){ve(this,St,Si).call(this,C.onActionSent.updateRole)}else if(($=C)!==null&&$!==void 0&&$.onActionSent.switchConnectionType){this.triggerEvents("ConnectionTypeChanged",[(ee=C)===null||ee===void 0?void 0:ee.onActionSent.switchConnectionType])}}case 162:case"end":return te.stop()}}),e,this,[[2,6],[100,117]])})));function t(t){return e.apply(this,arguments)}return t}()},{key:"socketOnOpenHandler",value:function e(){window.addEventListener("unload",this.sendLeaveBound)}},{key:"socketOnCloseHandler",value:function e(t){ve(this,xe,Bt).call(this);if(t!==null&&t!==void 0&&t.code&&(t===null||t===void 0?void 0:t.code)!==1005){this.setLog("Socket closed with a code ".concat(t.code,", reconnecting"),Se.ERROR);babelHelpers.classPrivateFieldGet(this,He).lastReconnectionReason=Re.WsTransportClosed;ve(this,Ne,Lt).call(this,{reconnectionReason:"WS_CONNECTION_CLOSED",reconnectionReasonInfo:"Socket closed with a code ".concat(t.code)})}else{this.setLog("Socket closed with a code ".concat(t.code),Se.ERROR)}}},{key:"socketOnErrorHandler",value:function e(){this.setLog("Got a socket error",Se.ERROR)}},{key:"onIceCandidate",value:function(){var e=babelHelpers.asyncToGenerator(ue().mark((function e(t,i){var n,a,s;var r;return ue().wrap((function e(o){while(1)switch(o.prev=o.next){case 0:if(i.candidate){o.next=2;break}return o.abrupt("return");case 2:if(!(Yf.useTcpSdp()&&i.candidate.protocol!=="tcp")){o.next=4;break}return o.abrupt("return");case 4:r={candidateInit:JSON.stringify({candidate:i.candidate.candidate,sdpMid:(n=i.candidate)===null||n===void 0?void 0:n.sdpMid,sdpMLineIndex:(a=i.candidate)===null||a===void 0?void 0:a.sdpMLineIndex,usernameFragment:(s=i.candidate)===null||s===void 0?void 0:s.usernameFragment})};if(t){r.target=t}ve(this,Rt,Ri).call(this,{trickle:r});case 7:case"end":return o.stop()}}),e,this)})));function t(t,i){return e.apply(this,arguments)}return t}()},{key:"onConnectionStateChange",value:function e(t){var i=this;var n=t?this.recipient.connectionState:this.sender.connectionState;if(n==="failed"&&!babelHelpers.classPrivateFieldGet(this,He).isReconnecting){this.setLog("State of ".concat(t?"recipient":"sender"," peer connection changed to ").concat(n,", reconnecting"),Se.WARNING);if(babelHelpers.classPrivateFieldGet(this,He).peerConnectionFailed){return}babelHelpers.classPrivateFieldGet(this,He).peerConnectionFailed=true;this.checkMetricsFeatureAndExecutionCallback((function(){i.addMonitoringEvents({name:we.PEER_CONNECTION_REFUSED,withCounter:true})}));ve(this,xe,Bt).call(this);if(babelHelpers.classPrivateFieldGet(this,He).canReconnect){babelHelpers.classPrivateFieldGet(this,He).lastReconnectionReason=Re.PeerConnectionFailed;ve(this,Ne,Lt).call(this,{reconnectionReason:"ON_CONNECTION_STATE_CHANGED",reconnectionReasonInfo:"State of ".concat(t?"recipient":"sender"," peer connection changed to ").concat(n)})}}else if(n==="failed"||n==="disconnected"){var a="State of ".concat(t?"recipient":"sender"," PEER CONNECTION changed to ").concat(n);this.setLog(a,Se.WARNING)}}},{key:"onIceConnectionStateChange",value:function e(t){var i=t?this.recipient.iceConnectionState:this.sender.iceConnectionState;if(i==="failed"||i==="disconnected"){var n="State of ".concat(t?"recipient":"sender"," ICE connection changed to ").concat(i);this.setLog(n,Se.WARNING)}}},{key:"on",value:function e(t,i){babelHelpers.classPrivateFieldGet(this,He).events.set(t,i);return this}},{key:"off",value:function e(t){if(babelHelpers.classPrivateFieldGet(this,He).events.has(t)){return babelHelpers.classPrivateFieldGet(this,He).events["delete"](t)}return this}},{key:"triggerEvents",value:function e(t,i){if(babelHelpers.classPrivateFieldGet(this,He).events.has(t)){var n=babelHelpers.classPrivateFieldGet(this,He).events.get(t);if(i){n.apply(void 0,babelHelpers.toConsumableArray(i))}else{n()}}}},{key:"isRecordable",value:function e(){console.log("isRecordable")}},{key:"setBitrate",value:function e(t,i){var n=this;this.setLog("Start setting bitrate",Se.INFO);var a;var s;switch(i){case ge.Camera:a=babelHelpers.classPrivateFieldGet(this,He).cameraStream.getVideoTracks[0];s=babelHelpers.classPrivateFieldGet(this,He).videoSimulcast;break;case ge.Microphone:a=babelHelpers.classPrivateFieldGet(this,He).microphoneStream.getAudioTracks[0];break;case ge.Screen:a=babelHelpers.classPrivateFieldGet(this,He).screenStream.getVideoTracks[0];break}var r=this.sender.getSenders();r.forEach((function(e){var i=e.getParameters();if(!i||!i.encodings||i.encodings.length===0){n.setLog("Setting bitrate failed: has no encodings in the sender parameters",Se.WARNING)}else{i.encodings.forEach((function(e){if(s){e.maxBitrate=t<babelHelpers.classPrivateFieldGet(n,He).defaultSimulcastBitrate[e.rid]?t:babelHelpers.classPrivateFieldGet(n,He).defaultSimulcastBitrate[e.rid]}else{e.maxBitrate=t}}));e.setParameters(i);n.setLog("Setting bitrate succeeded",Se.INFO)}}))}},{key:"setCodec",value:function e(t){var i=this;if(!("getCapabilities"in RTCRtpReceiver)){return}var n=RTCRtpReceiver.getCapabilities("video");if(!n)return;var a=[];var s=[];var r=[];n.codecs.forEach((function(e){var t=e.mimeType.toLowerCase();if(t==="audio/opus"){a.push(e);return}var n=t==="video/".concat(babelHelpers.classPrivateFieldGet(i,He).codec);if(!n){r.push(e);return}if(babelHelpers.classPrivateFieldGet(i,He).codec==="h264"){if(e.sdpFmtpLine&&e.sdpFmtpLine.includes("profile-level-id=42e01f")){a.push(e)}else{s.push(e)}return}a.push(e)}));if("setCodecPreferences"in t){t.setCodecPreferences(a.concat(s,r))}}},{key:"publishTrack",value:function(){var e=babelHelpers.asyncToGenerator(ue().mark((function e(t,i){var n,a,s,r,o,l,c,u,d,h,p,v,f,m,g=arguments;return ue().wrap((function e(b){while(1)switch(b.prev=b.next){case 0:n=g.length>2&&g[2]!==undefined?g[2]:{};if(this.sender){b.next=4;break}this.setLog("Publishing a track before a peer connection was created, ignoring",Se.WARNING);return b.abrupt("return");case 4:this.setLog("Start publishing a track with kind ".concat(t),Se.INFO);b.prev=5;for(a in n){babelHelpers.classPrivateFieldGet(this,He)["".concat(a)]=n[a]}s=t;i.source=s;if(!(s===ge.Camera)){b.next=49;break}if(!babelHelpers.classPrivateFieldGet(this,He).videoSimulcast){b.next=31;break}r=i.getSettings().width;o=i.getSettings().height;l=ve(this,Et,Ei).call(this,ge.Camera);if(!l){b.next=23;break}b.next=17;return l.replaceTrack(i);case 17:ve(this,Ye,Xt).call(this,l,i);this.setLog("Publishing a track with kind ".concat(t," via replace track succeeded"),Se.INFO);this.triggerEvents("PublishSucceed",[ge.Camera]);return b.abrupt("return");case 23:c=ve(this,je,Gt).call(this,r);this.setLog("Add sender transceiver - direction: sendonly",Se.INFO);u=this.sender.addTransceiver(i,{direction:"sendonly",streams:[babelHelpers.classPrivateFieldGet(this,He).cameraStream],sendEncodings:i.sendEncodings||c});this.setCodec(u);ve(this,We,Ut).call(this,i.id,s);ve(this,Rt,Ri).call(this,{addTrack:{cid:i.id,type:"VIDEO",width:r,height:o,source:s,layers:ve(this,qe,Wt).call(this,r,o,c)}});case 29:b.next=47;break;case 31:d=ve(this,Et,Ei).call(this,ge.Camera);if(!d){b.next=40;break}b.next=35;return d.replaceTrack(i);case 35:this.setLog("Publishing a track with kind ".concat(t," via replace track succeeded"),Se.INFO);this.triggerEvents("PublishSucceed",[ge.Camera]);return b.abrupt("return");case 40:this.setLog("Add sender transceiver - direction: sendonly",Se.INFO);this.sender.addTransceiver(i,{direction:"sendonly"});this.setBitrate(babelHelpers.classPrivateFieldGet(this,He).videoBitrate,ge.Camera);h=i.getSettings().width;p=i.getSettings().height;ve(this,We,Ut).call(this,i.id,s);ve(this,Rt,Ri).call(this,{addTrack:{cid:i.id,type:"VIDEO",width:h,height:p,source:s}});case 47:b.next=65;break;case 49:if(!(s===ge.Microphone)){b.next=64;break}v=ve(this,Et,Ei).call(this,ge.Microphone);if(!v){b.next=59;break}b.next=54;return v.replaceTrack(i);case 54:this.setLog("Publishing a track with kind ".concat(t," via replace track succeeded"),Se.INFO);this.triggerEvents("PublishSucceed",[ge.Microphone]);return b.abrupt("return");case 59:this.sender.addTransceiver(i,{direction:"sendonly"});ve(this,We,Ut).call(this,i.id,s);ve(this,Rt,Ri).call(this,{addTrack:{cid:i.id,source:s}});case 62:b.next=65;break;case 64:if(s===ge.Screen){this.sender.addTransceiver(i,{direction:"sendonly"});f=i.getSettings().width;m=i.getSettings().height;ve(this,We,Ut).call(this,i.id,s);ve(this,Rt,Ri).call(this,{addTrack:{cid:i.id,type:"VIDEO",width:f,height:m,source:s}})}else if(s===ge.ScreenAudio){this.sender.addTransceiver(i,{direction:"sendonly"});this.sender.addTransceiver(i,{direction:"sendonly"});ve(this,We,Ut).call(this,i.id,s);ve(this,Rt,Ri).call(this,{addTrack:{cid:i.id,source:s}})}case 65:babelHelpers.classPrivateFieldGet(this,He).offersStack++;b.next=68;return this.sendOffer();case 68:b.next=76;break;case 70:b.prev=70;b.t0=b["catch"](5);if(t===ge.Microphone){babelHelpers.classPrivateFieldGet(this,He).needToDisableAudioAfterPublish=false}this.setLog("Publishing a track with kind ".concat(t," failed: ").concat(b.t0),Se.ERROR);ve(this,_t,_i).call(this,t);this.onPublishFailed(t);case 76:case"end":return b.stop()}}),e,this,[[5,70]])})));function t(t,i){return e.apply(this,arguments)}return t}()},{key:"changeStreamQuality",value:function(){var e=babelHelpers.asyncToGenerator(ue().mark((function e(t){var i,n,a;return ue().wrap((function e(s){while(1)switch(s.prev=s.next){case 0:s.t0=ue().keys(t);case 1:if((s.t1=s.t0()).done){s.next=18;break}i=s.t1.value;if(!(babelHelpers.classPrivateFieldGet(this,He)["".concat(i)]!==t[i])){s.next=16;break}babelHelpers.classPrivateFieldGet(this,He)["".concat(i)]=t[i];if(!(i==="videoSimulcast"||i==="screenSimulcast"&&babelHelpers.classPrivateFieldGet(this,He).screenStream)){s.next=12;break}n=i==="videoSimulcast"?ge.Camera:ge.Screen;if(!ve(this,Et,Ei).call(this,n)){s.next=10;break}s.next=10;return this.republishTrack(n);case 10:s.next=16;break;case 12:if(!["videoBitrate","audioBitrate","screenBitrate"].includes(i)){s.next=16;break}a=i==="videoBitrate"?ge.Camera:i==="screenBitrate"?ge.Screen:ge.Microphone;s.next=16;return this.setBitrate(t[i],a);case 16:s.next=1;break;case 18:case"end":return s.stop()}}),e,this)})));function t(t){return e.apply(this,arguments)}return t}()},{key:"republishTrack",value:function(){var e=babelHelpers.asyncToGenerator(ue().mark((function e(t){var i;return ue().wrap((function e(n){while(1)switch(n.prev=n.next){case 0:this.setLog("Start republishing a track with kind ".concat(t),Se.INFO);n.next=3;return this.unpublishTrack(t);case 3:n.next=5;return this.getTrack(t);case 5:i=n.sent;if(!i){n.next=11;break}n.next=9;return this.publishTrack(t,i);case 9:n.next=14;break;case 11:this.setLog("Republishing a track with kind ".concat(t," failed: ").concat(error),Se.ERROR);ve(this,_t,_i).call(this,t);this.triggerEvents("PublishFailed",[t]);case 14:case"end":return n.stop()}}),e,this)})));function t(t){return e.apply(this,arguments)}return t}()},{key:"unpublishTrack",value:function(){var e=babelHelpers.asyncToGenerator(ue().mark((function e(t){var i;return ue().wrap((function e(n){while(1)switch(n.prev=n.next){case 0:this.setLog("Start unpublishing a track with kind ".concat(t),Se.INFO);i=ve(this,Et,Ei).call(this,t);if(!i){n.next=10;break}this.sender.removeTrack(i);babelHelpers.classPrivateFieldGet(this,He).offersStack++;n.next=7;return this.sendOffer();case 7:this.setLog("Unpublishing a track with kind ".concat(t," succeeded"),Se.INFO);n.next=11;break;case 10:this.setLog("Unpublishing a track with kind ".concat(t," failed: has no sender for a track"),Se.ERROR);case 11:case"end":return n.stop()}}),e,this)})));function t(t){return e.apply(this,arguments)}return t}()},{key:"toggleRemoteParticipantVideo",value:function e(t,i){var n=arguments.length>2&&arguments[2]!==undefined?arguments[2]:false;ve(this,et,Jt).call(this,t,i,n)}},{key:"hangup",value:function e(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:false;if(babelHelpers.classPrivateFieldGet(this,He).callState===ke.TERMINATED){return}babelHelpers.classPrivateFieldGet(this,He).abortController.abort();babelHelpers.classPrivateFieldGet(this,He).callState=ke.TERMINATED;this.setLog("Disconnecting from the call",Se.INFO);if(t){ve(this,Rt,Ri).call(this,{closeRoom:{timestamp:Math.floor(Date.now()/1e3)}})}else{ve(this,Mt,Mi).call(this)}ve(this,xe,Bt).call(this,{initiatedByUser:true});ve(this,Pt,Pi).call(this);clearTimeout(babelHelpers.classPrivateFieldGet(this,He).reconnectionTimeout);for(var i in babelHelpers.classPrivateFieldGet(this,He).pendingPublications){clearTimeout(babelHelpers.classPrivateFieldGet(this,He).pendingPublications[i])}babelHelpers.classPrivateFieldGet(this,He).pendingPublications={};for(var n in babelHelpers.classPrivateFieldGet(this,He).pendingSubscriptions){for(var a in babelHelpers.classPrivateFieldGet(this,He).pendingSubscriptions[n]){clearTimeout(babelHelpers.classPrivateFieldGet(this,He).pendingSubscriptions[n][a].timeout)}}babelHelpers.classPrivateFieldGet(this,He).pendingSubscriptions={};babelHelpers.classPrivateFieldGet(this,He).options=null;babelHelpers.classPrivateFieldGet(this,He).iceServers=null;babelHelpers.classPrivateFieldGet(this,He).lastReconnectionReason=null;ve(this,_t,_i).call(this,ge.Camera);ve(this,_t,_i).call(this,ge.Microphone);ve(this,_t,_i).call(this,ge.Screen);babelHelpers.classPrivateFieldGet(this,He).rtt=0;babelHelpers.classPrivateFieldGet(this,He).remoteTracks={};babelHelpers.classPrivateFieldGet(this,He).isReconnecting=false;babelHelpers.classPrivateFieldGet(this,He).reconnectionAttempt=0;babelHelpers.classPrivateFieldGet(this,He).mainStream={};this.triggerEvents("Disconnected")}},{key:"isConnected",value:function e(){return babelHelpers.classPrivateFieldGet(this,He).callState===ke.CONNECTED}},{key:"setVideoStreamSetupErrorList",value:function e(t,i){var n=babelHelpers.classPrivateFieldGet(this,He).videoStreamSetupErrorList[t];var a=!!n&&n.includes(i);var s=n||[];if(!a){babelHelpers.classPrivateFieldGet(this,He).videoStreamSetupErrorList[t]=[i].concat(babelHelpers.toConsumableArray(s))}}},{key:"setMainStream",value:function e(t,i){var n=babelHelpers.classPrivateFieldGet(this,He).remoteParticipants[t.userId];if(!n){this.setVideoStreamSetupErrorList(t.userId,i);this.setLog("Setting main stream error (No remoteParticipant with ID - ".concat(t.userId," in list)"),Se.ERROR);return}ve(this,Ze,Yt).call(this,t,i)}},{key:"setVideoQualityForStreams",value:function e(t){babelHelpers.classPrivateFieldGet(this,He).defaultRemoteStreamsQuality=t.videoQuality;ve(this,Ze,Yt).call(this,t);if(babelHelpers.classPrivateFieldGet(this,He).defaultRemoteStreamsQuality===P.NO_VIDEO){this.disableVideo({calledFrom:"setVideoQuality"});H.maxLocalStreamQualityHeight=_.NO_VIDEO;return}if(t.isCameraWasEnabledBeforeQualityChanged&&babelHelpers.classPrivateFieldGet(this,He).defaultRemoteStreamsQuality!==P.NO_VIDEO){this.triggerEvents("TurnOnCamera")}switch(babelHelpers.classPrivateFieldGet(this,He).defaultRemoteStreamsQuality){case P.HIGH:H.maxLocalStreamQualityHeight=_.HIGH;break;case P.MEDIUM:H.maxLocalStreamQualityHeight=_.MEDIUM;break;case P.LOW:H.maxLocalStreamQualityHeight=_.LOW;break}var i=ve(this,Et,Ei).call(this,ge.Camera);if(i){ve(this,Ye,Xt).call(this,i)}}},{key:"resetMainStream",value:function e(t){this.setLog("Resetting main stream",Se.INFO);ve(this,Ze,Yt).call(this,t)}},{key:"removeTrack",value:function e(t){var i;var n=(i=babelHelpers.classPrivateFieldGet(this,He).localTracks[t])===null||i===void 0?void 0:i.sid;if(n){this.setLog("Sending removeTrack signal for a track with kind ".concat(t," (sid: ").concat(n,")"),Se.INFO);delete babelHelpers.classPrivateFieldGet(this,He).localTracks[t];ve(this,Rt,Ri).call(this,{removeTrack:{sid:n}})}else{this.setLog("Sending removeTrack signal for a non-existent track with kind ".concat(t),Se.WARNING)}}},{key:"pauseTrack",value:function e(t,i){var n;var a=(n=babelHelpers.classPrivateFieldGet(this,He).localTracks[t])===null||n===void 0?void 0:n.sid;if(a){this.setLog("Sending pause signal (keep: ".concat(i,") for a track with kind ").concat(t," (sid: ").concat(a,")"),Se.INFO);if(!i){delete babelHelpers.classPrivateFieldGet(this,He).localTracks[t]}ve(this,Rt,Ri).call(this,{mute:{sid:a,muted:true}})}else{this.setLog("Sending pause signal for a non-existent track with kind ".concat(t),Se.WARNING)}}},{key:"unpauseTrack",value:function e(t){var i;var n=(i=babelHelpers.classPrivateFieldGet(this,He).localTracks[t])===null||i===void 0?void 0:i.sid;if(n){this.setLog("Sending unpause signal for a track with kind ".concat(t," (sid: ").concat(n,")"),Se.INFO);ve(this,Rt,Ri).call(this,{mute:{sid:n,muted:false}})}else{this.setLog("Sending unpause signal for a non-existent track with kind ".concat(t),Se.WARNING)}}},{key:"disableAudio",value:function e(t){var i;var n=(t===null||t===void 0?void 0:t.bySystem)||false;var a=(t===null||t===void 0?void 0:t.calledFrom)||"";if(babelHelpers.classPrivateFieldGet(this,He).mediaMutedBySystem){return}this.setLog("Start disabling audio - calledFrom: ".concat(a,", isReconnecting: ").concat(babelHelpers.classPrivateFieldGet(this,He).isReconnecting,", bySystem: ").concat(n));var s=(i=babelHelpers.classPrivateFieldGet(this,He).microphoneStream)===null||i===void 0?void 0:i.getAudioTracks()[0];if(s){babelHelpers.classPrivateFieldGet(this,He).needToEnableAudioAfterSystemMuted=n?s.enabled:false;s.enabled=false;if(babelHelpers.classPrivateFieldGet(this,He).localTracks[ge.Microphone]){babelHelpers.classPrivateFieldGet(this,He).localTracks[ge.Microphone].muted=true}this.pauseTrack(ge.Microphone,true)}else{this.setLog("Disabling audio failed: has no track",Se.ERROR)}}},{key:"enableAudio",value:function(){var e=babelHelpers.asyncToGenerator(ue().mark((function e(t){var i,n;var a,s,r,o;return ue().wrap((function e(l){while(1)switch(l.prev=l.next){case 0:a=(t===null||t===void 0?void 0:t.disabled)||false;s=(t===null||t===void 0?void 0:t.calledFrom)||"";if(Yf.havePermissionToBroadcast("mic")){l.next=4;break}return l.abrupt("return");case 4:this.setLog("Start enabling audio - calledFrom: ".concat(s,", isReconnecting: ").concat(babelHelpers.classPrivateFieldGet(this,He).isReconnecting,", disabled: ").concat(a));babelHelpers.classPrivateFieldGet(this,He).needToEnableAudioAfterSystemMuted=false;if(!babelHelpers.classPrivateFieldGet(this,He).switchActiveAudioDeviceInProgress){l.next=15;break}l.prev=7;l.next=10;return babelHelpers.classPrivateFieldGet(this,He).switchActiveAudioDeviceInProgress;case 10:l.next=15;break;case 12:l.prev=12;l.t0=l["catch"](7);this.onPublishFailed(ge.Microphone);case 15:r=(i=babelHelpers.classPrivateFieldGet(this,He).microphoneStream)===null||i===void 0?void 0:i.getAudioTracks()[0];o=((n=r)===null||n===void 0?void 0:n.readyState)!=="live";if(!o){l.next=21;break}l.next=20;return this.getLocalAudio();case 20:r=l.sent;case 21:if(r){l.next=26;break}this.setLog("Enabling audio failed: has no track",Se.ERROR);ve(this,_t,_i).call(this,ge.Microphone);this.triggerEvents("PublishFailed",[ge.Microphone]);return l.abrupt("return");case 26:if(!babelHelpers.classPrivateFieldGet(this,He).localTracks[ge.Microphone]){l.next=35;break}this.setLog("Enabling audio via unpause signal",Se.INFO);r.enabled=true;babelHelpers.classPrivateFieldGet(this,He).localTracks[ge.Microphone].muted=false;l.next=32;return this.publishTrack(ge.Microphone,r);case 32:this.unpauseTrack(ge.Microphone);l.next=41;break;case 35:this.setLog("Enabling audio via publish",Se.INFO);r.enabled=!a;if(a){babelHelpers.classPrivateFieldGet(this,He).needToDisableAudioAfterPublish=true}if(babelHelpers.classPrivateFieldGet(this,He).localTracks[ge.Microphone]){babelHelpers.classPrivateFieldGet(this,He).localTracks[ge.Microphone].muted=false}l.next=41;return this.publishTrack(ge.Microphone,r);case 41:case"end":return l.stop()}}),e,this,[[7,12]])})));function t(t){return e.apply(this,arguments)}return t}()},{key:"disableVideo",value:function(){var e=babelHelpers.asyncToGenerator(ue().mark((function e(t){var i,n=this;var a,s,r,o;return ue().wrap((function e(l){while(1)switch(l.prev=l.next){case 0:a=(t===null||t===void 0?void 0:t.bySystem)||false;s=(t===null||t===void 0?void 0:t.calledFrom)||"";r=babelHelpers.classPrivateFieldGet(this,He).videoQueue!==ye.INITIAL;this.setLog("Start disabling video - calledFrom: ".concat(s,", isReconnecting: ").concat(babelHelpers.classPrivateFieldGet(this,He).isReconnecting,", bySystem: ").concat(a,", mediaMutedBySystem: ").concat(babelHelpers.classPrivateFieldGet(this,He).mediaMutedBySystem,", hasQueue: ").concat(r,", videoQueue: ").concat(babelHelpers.classPrivateFieldGet(this,He).videoQueue," "),Se.INFO);if(!babelHelpers.classPrivateFieldGet(this,He).isReconnecting){l.next=6;break}return l.abrupt("return");case 6:babelHelpers.classPrivateFieldGet(this,He).videoQueue=ye.DISABLE;if(!r){l.next=9;break}return l.abrupt("return");case 9:o=(i=babelHelpers.classPrivateFieldGet(this,He).cameraStream)===null||i===void 0?void 0:i.getVideoTracks()[0];if(!(o&&babelHelpers.classPrivateFieldGet(this,He).localTracks[ge.Camera])){l.next=27;break}if(!babelHelpers.classPrivateFieldGet(this,He).mediaMutedBySystem){l.next=20;break}babelHelpers.classPrivateFieldGet(this,He).videoQueue=ye.INITIAL;babelHelpers.classPrivateFieldGet(this,He).mediaMutedBySystem=false;this.setLog("Video disabling stops track - bySystem: ".concat(a,", mediaMutedBySystem: ").concat(babelHelpers.classPrivateFieldGet(this,He).mediaMutedBySystem),Se.INFO);o.stop();this.checkMetricsFeatureAndExecutionCallback((function(){n.addMonitoringEvents({name:we.USER_CAMERA_DISABLED,withCounter:true})}));this.triggerEvents("MediaMutedBySystem",[false]);this.triggerEvents("PublishEnded",[ge.Camera]);return l.abrupt("return");case 20:babelHelpers.classPrivateFieldGet(this,He).localTracks[ge.Camera].muted=true;this.setLog("Video disabling pauses track - bySystem: ".concat(a,", mediaMutedBySystem: ").concat(babelHelpers.classPrivateFieldGet(this,He).mediaMutedBySystem),Se.INFO);this.pauseTrack(ge.Camera,true);if(babelHelpers.classPrivateFieldGet(this,He).needToStopStreams){ae.stopStream(ge.Camera)}if(!a){babelHelpers.classPrivateFieldGet(this,He).videoQueue=ye.INITIAL;this.setLog("Video disabling stops track - bySystem: ".concat(a,", mediaMutedBySystem: ").concat(babelHelpers.classPrivateFieldGet(this,He).mediaMutedBySystem),Se.INFO);o.stop();this.checkMetricsFeatureAndExecutionCallback((function(){n.addMonitoringEvents({name:we.USER_CAMERA_DISABLED,withCounter:true})}));this.triggerEvents("PublishEnded",[ge.Camera])}l.next=29;break;case 27:this.setLog("Disabling video failed: has no track",Se.ERROR);babelHelpers.classPrivateFieldGet(this,He).videoQueue=ye.INITIAL;case 29:case"end":return l.stop()}}),e,this)})));function t(t){return e.apply(this,arguments)}return t}()},{key:"enableVideo",value:function(){var e=babelHelpers.asyncToGenerator(ue().mark((function e(t){var i;var n,a,s,r,o;return ue().wrap((function e(l){while(1)switch(l.prev=l.next){case 0:n=(t===null||t===void 0?void 0:t.skipUnpause)||false;a=(t===null||t===void 0?void 0:t.calledFrom)||"";s=babelHelpers.classPrivateFieldGet(this,He).videoQueue!==ye.INITIAL;this.setLog("Start enabling video - calledFrom: ".concat(a,", isReconnecting: ").concat(babelHelpers.classPrivateFieldGet(this,He).isReconnecting,", skipUnpause: ").concat(n,", mediaMutedBySystem: ").concat(babelHelpers.classPrivateFieldGet(this,He).mediaMutedBySystem,", hasQueue: ").concat(s,", videoQueue: ").concat(babelHelpers.classPrivateFieldGet(this,He).videoQueue," "),Se.INFO);if(!babelHelpers.classPrivateFieldGet(this,He).isReconnecting){l.next=6;break}return l.abrupt("return");case 6:if(Yf.havePermissionToBroadcast("cam")){l.next=8;break}return l.abrupt("return");case 8:babelHelpers.classPrivateFieldGet(this,He).videoQueue=ye.ENABLE;if(!s){l.next=11;break}return l.abrupt("return");case 11:if(!babelHelpers.classPrivateFieldGet(this,He).switchActiveVideoDeviceInProgress){l.next=20;break}l.prev=12;l.next=15;return babelHelpers.classPrivateFieldGet(this,He).switchActiveVideoDeviceInProgress;case 15:l.next=20;break;case 17:l.prev=17;l.t0=l["catch"](12);this.onPublishFailed(ge.Camera);case 20:r=!!((i=babelHelpers.classPrivateFieldGet(this,He).cameraStream)!==null&&i!==void 0&&i.getVideoTracks()[0]);l.next=23;return this.getLocalVideo();case 23:o=l.sent;if(!(o&&r&&babelHelpers.classPrivateFieldGet(this,He).localTracks[ge.Camera])){l.next=33;break}if(babelHelpers.classPrivateFieldGet(this,He).mediaMutedBySystem){babelHelpers.classPrivateFieldGet(this,He).mediaMutedBySystem=false;this.triggerEvents("MediaMutedBySystem",[false])}if(n){this.setLog("Re-enabling video after automatic camera change",Se.INFO)}else{this.setLog("Enabling video via unpause signal",Se.INFO)}babelHelpers.classPrivateFieldGet(this,He).localTracks[ge.Camera].muted=false;l.next=30;return this.publishTrack(ge.Camera,o);case 30:if(n){babelHelpers.classPrivateFieldGet(this,He).videoQueue=ye.INITIAL}else{babelHelpers.classPrivateFieldGet(this,He).localTracks[ge.Camera].muted=false;this.unpauseTrack(ge.Camera)}l.next=44;break;case 33:if(!o){l.next=40;break}if(babelHelpers.classPrivateFieldGet(this,He).localTracks[ge.Camera]){babelHelpers.classPrivateFieldGet(this,He).localTracks[ge.Camera].muted=false}this.setLog("Enabling video via publish",Se.INFO);l.next=38;return this.publishTrack(ge.Camera,o);case 38:l.next=44;break;case 40:this.setLog("Enabling video failed: has no track",Se.ERROR);babelHelpers.classPrivateFieldGet(this,He).videoQueue=ye.INITIAL;ve(this,_t,_i).call(this,ge.Camera);this.triggerEvents("PublishFailed",[ge.Camera]);case 44:case"end":return l.stop()}}),e,this,[[12,17]])})));function t(t){return e.apply(this,arguments)}return t}()},{key:"startScreenShare",value:function(){var e=babelHelpers.asyncToGenerator(ue().mark((function e(){var t,i,n;return ue().wrap((function e(a){while(1)switch(a.prev=a.next){case 0:if(Yf.havePermissionToBroadcast("screenshare")){a.next=2;break}return a.abrupt("return");case 2:this.setLog("Start enabling screen sharing",Se.INFO);a.next=5;return this.getLocalScreen();case 5:t=a.sent;i=t===null||t===void 0?void 0:t.video;n=t===null||t===void 0?void 0:t.audio;if(i){a.next=14;break}this.setLog("Enabling screen sharing failed: has no track",Se.ERROR);ve(this,_t,_i).call(this,ge.Screen);this.onPublishFailed(ge.Screen);this.onPublishFailed(ge.ScreenAudio);return a.abrupt("return");case 14:a.next=16;return this.publishTrack(ge.Screen,i);case 16:if(!n){a.next=19;break}a.next=19;return this.publishTrack(ge.ScreenAudio,n);case 19:case"end":return a.stop()}}),e,this)})));function t(){return e.apply(this,arguments)}return t}()},{key:"stopScreenShare",value:function(){var e=babelHelpers.asyncToGenerator(ue().mark((function e(){return ue().wrap((function e(t){while(1)switch(t.prev=t.next){case 0:this.setLog("Start disabling screen sharing",Se.INFO);ve(this,_t,_i).call(this,ge.Screen);ve(this,_t,_i).call(this,ge.ScreenAudio);this.removeTrack(ge.Screen);this.removeTrack(ge.ScreenAudio);t.next=7;return this.unpublishTrack(ge.Screen);case 7:t.next=9;return this.unpublishTrack(ge.ScreenAudio);case 9:case"end":return t.stop()}}),e,this)})));function t(){return e.apply(this,arguments)}return t}()},{key:"sendMessage",value:function e(t){ve(this,Rt,Ri).call(this,{sendMessage:{message:t}})}},{key:"switchConnectionType",value:function e(t){ve(this,Rt,Ri).call(this,{switchConnectionType:{type:t}})}},{key:"raiseHand",value:function e(t){ve(this,Rt,Ri).call(this,{raiseHand:{raised:t}})}},{key:"updateUserData",value:function e(t){ve(this,Rt,Ri).call(this,{updateUserData:t})}},{key:"changeSettings",value:function e(t){if(!Yf.isUserControlFeatureEnabled()){return}var i={};switch(t.typeOfSetting){case"mic":i={audioMutedEvent:{muted:!t.settingEnabled}};break;case"cam":this.setLog("Settings changes send videoMutedEvent (act: 'change_settings') - muted: ".concat(!t.settingEnabled),Se.INFO);i={videoMutedEvent:{muted:!t.settingEnabled}};break;case"screenshare":i={screenShareMutedEvent:{muted:!t.settingEnabled}};break}ve(this,Rt,Ri).call(this,{sendAction:{act:"change_settings",changeSettingsPayload:i}})}},{key:"turnOffAllParticipansStream",value:function e(t){if(!Yf.isUserControlFeatureEnabled()){return}if(t!==null&&t!==void 0&&t.data){var i;if((i=t.data)!==null&&i!==void 0&&i.typeOfStream){switch(t.data.typeOfStream){case"mic":ve(this,Rt,Ri).call(this,{sendAction:{act:"mute_others",muteAllParticipantPayload:{audioMutedEvent:{muted:true}}}});break;case"cam":this.setLog("turnOffAllParticipansStream send videoMutedEvent (act: 'mute_others') - muted: true",Se.INFO);ve(this,Rt,Ri).call(this,{sendAction:{act:"mute_others",muteAllParticipantPayload:{videoMutedEvent:{muted:true}}}});break;case"screenshare":ve(this,Rt,Ri).call(this,{sendAction:{act:"mute_others",muteAllParticipantPayload:{screenShareMutedEvent:{muted:true}}}});break}}}}},{key:"turnOffParticipantStream",value:function e(t){if(!Yf.isUserControlFeatureEnabled()){return}if(!t.typeOfStream){return}switch(t.typeOfStream){case"mic":ve(this,Rt,Ri).call(this,{sendAction:{act:"mute_others",muteParticipantPayload:{participantID:String(t.userId),audioMutedEvent:{muted:true}}}});break;case"cam":this.setLog("turnOffParticipantStream send videoMutedEvent (act: 'mute_others') - muted: true, participantID: ".concat(t.userId),Se.INFO);ve(this,Rt,Ri).call(this,{sendAction:{act:"mute_others",muteParticipantPayload:{participantID:String(t.userId),videoMutedEvent:{muted:true}}}});break;case"screenshare":ve(this,Rt,Ri).call(this,{sendAction:{act:"mute_others",muteParticipantPayload:{participantID:String(t.userId),screenShareMutedEvent:{muted:true}}}});break}}},{key:"allowSpeakPermission",value:function e(t){if(Yf.canControlGiveSpeakPermission()){ve(this,Rt,Ri).call(this,{sendAction:{act:"give_permissions",givePermissionsPayload:{forUserId:String(t.userId),allow:t.allow}}})}}},{key:"getLocalVideo",value:function(){var e=babelHelpers.asyncToGenerator(ue().mark((function e(){var t,i,n;var a,s;return ue().wrap((function e(r){while(1)switch(r.prev=r.next){case 0:a=(t=babelHelpers.classPrivateFieldGet(this,He).cameraStream)===null||t===void 0?void 0:(i=t.getVideoTracks()[0])===null||i===void 0?void 0:i.readyState;s=a?" - readyState: ".concat(a):"";this.setLog("Local video getting".concat(s),Se.INFO);if(!(a!=="live")){r.next=6;break}r.next=6;return this.getTrack(ge.Camera);case 6:return r.abrupt("return",(n=babelHelpers.classPrivateFieldGet(this,He).cameraStream)===null||n===void 0?void 0:n.getVideoTracks()[0]);case 7:case"end":return r.stop()}}),e,this)})));function t(){return e.apply(this,arguments)}return t}()},{key:"getLocalAudio",value:function(){var e=babelHelpers.asyncToGenerator(ue().mark((function e(){var t,i;return ue().wrap((function e(n){while(1)switch(n.prev=n.next){case 0:if(!(((t=babelHelpers.classPrivateFieldGet(this,He).microphoneStream)===null||t===void 0?void 0:t.getAudioTracks()[0].readyState)!=="live")){n.next=3;break}n.next=3;return this.getTrack(ge.Microphone);case 3:return n.abrupt("return",(i=babelHelpers.classPrivateFieldGet(this,He).microphoneStream)===null||i===void 0?void 0:i.getAudioTracks()[0]);case 4:case"end":return n.stop()}}),e,this)})));function t(){return e.apply(this,arguments)}return t}()},{key:"getLocalScreen",value:function(){var e=babelHelpers.asyncToGenerator(ue().mark((function e(){var t,i;return ue().wrap((function e(n){while(1)switch(n.prev=n.next){case 0:if(babelHelpers.classPrivateFieldGet(this,He).screenStream){n.next=3;break}n.next=3;return this.getTrack(ge.Screen);case 3:return n.abrupt("return",{video:(t=babelHelpers.classPrivateFieldGet(this,He).screenStream)===null||t===void 0?void 0:t.getVideoTracks()[0],audio:(i=babelHelpers.classPrivateFieldGet(this,He).screenStream)===null||i===void 0?void 0:i.getAudioTracks()[0]});case 4:case"end":return n.stop()}}),e,this)})));function t(){return e.apply(this,arguments)}return t}()},{key:"getTrack",value:function(){var e=babelHelpers.asyncToGenerator(ue().mark((function e(t){var i,n;var a,s,r,o,l,c,u,d,h,p,v;return ue().wrap((function e(f){while(1)switch(f.prev=f.next){case 0:if(t===ge.Camera){r=(a=babelHelpers.classPrivateFieldGet(this,He).cameraStream)===null||a===void 0?void 0:(s=a.getVideoTracks()[0])===null||s===void 0?void 0:s.readyState;o=r?" - readyState: ".concat(r):"";this.setLog("Video rack getting".concat(o),Se.INFO)}if(!(t===ge.Camera&&((i=babelHelpers.classPrivateFieldGet(this,He).cameraStream)===null||i===void 0?void 0:(n=i.getVideoTracks()[0])===null||n===void 0?void 0:n.readyState)!=="live")){f.next=7;break}f.next=4;return ve(this,nt,$t).call(this,{video:true});case 4:babelHelpers.classPrivateFieldGet(this,He).cameraStream=f.sent;f.next=17;break;case 7:if(!(t===ge.Microphone&&!babelHelpers.classPrivateFieldGet(this,He).microphoneStream)){f.next=13;break}f.next=10;return ve(this,nt,$t).call(this,{audio:true});case 10:babelHelpers.classPrivateFieldGet(this,He).microphoneStream=f.sent;f.next=17;break;case 13:if(!(t===ge.Screen&&!babelHelpers.classPrivateFieldGet(this,He).screenStream)){f.next=17;break}f.next=16;return ve(this,at,ti).call(this);case 16:babelHelpers.classPrivateFieldGet(this,He).screenStream=f.sent;case 17:if(!babelHelpers.classPrivateFieldGet(this,He).abortController.signal.aborted){f.next=20;break}ve(this,_t,_i).call(this,t);return f.abrupt("return");case 20:if(t===ge.Screen){l=(c=babelHelpers.classPrivateFieldGet(this,He).screenStream)===null||c===void 0?void 0:c.getVideoTracks()[0];if(l&&l.readyState!=="live"){babelHelpers.classPrivateFieldGet(this,He).screenStream=null;l=this.getLocalScreen()}}else if(t===ge.Camera){l=(u=babelHelpers.classPrivateFieldGet(this,He).cameraStream)===null||u===void 0?void 0:u.getVideoTracks()[0];h=(d=l)===null||d===void 0?void 0:d.readyState;p=h?" - readyState: ".concat(h):"";this.setLog("New video track getting".concat(p),Se.INFO);if(l&&l.readyState!=="live"){babelHelpers.classPrivateFieldGet(this,He).cameraStream=null;l=this.getLocalVideo()}}else if(t===ge.Microphone){l=(v=babelHelpers.classPrivateFieldGet(this,He).microphoneStream)===null||v===void 0?void 0:v.getAudioTracks()[0];if(l&&l.readyState!=="live"){babelHelpers.classPrivateFieldGet(this,He).microphoneStream=null;l=this.getLocalAudio()}}ve(this,st,ni).call(this,l,t);return f.abrupt("return",l);case 23:case"end":return f.stop()}}),e,this)})));function t(t){return e.apply(this,arguments)}return t}()},{key:"switchActiveAudioDevice",value:function(){var e=babelHelpers.asyncToGenerator(ue().mark((function e(t,i){var n=this;var a,s,r;return ue().wrap((function e(o){while(1)switch(o.prev=o.next){case 0:if(!(babelHelpers.classPrivateFieldGet(this,He).switchActiveAudioDeviceInProgress&&!i)){o.next=4;break}this.setLog("Got another request to switch an audio device to ".concat(t,", saving it"),Se.INFO);babelHelpers.classPrivateFieldGet(this,He).switchActiveAudioDevicePending=t;return o.abrupt("return");case 4:a=null;s=false;this.setLog("Start switching an audio device to ".concat(t),Se.INFO);r=new Promise(function(){var e=babelHelpers.asyncToGenerator(ue().mark((function e(i,r){var o,l,c,u,d,h,p,v;return ue().wrap((function e(f){while(1)switch(f.prev=f.next){case 0:babelHelpers.classPrivateFieldGet(n,He).audioDeviceId=t;o=babelHelpers.classPrivateFieldGet(n,He).microphoneStream;f.prev=2;c=ve(n,Et,Ei).call(n,ge.Microphone);if(c){f.next=8;break}n.setLog("Switching an audio device skipped - no sender",Se.WARNING);a="No sender for audio";return f.abrupt("return");case 8:u=(l=babelHelpers.classPrivateFieldGet(n,He).microphoneStream)===null||l===void 0?void 0:l.getAudioTracks()[0];babelHelpers.classPrivateFieldGet(n,He).microphoneStream=null;d=true;h="";if(u){d=u.enabled;h=u.id;u.stop()}f.next=15;return n.getLocalAudio();case 15:p=f.sent;p.source=ge.Microphone;p.enabled=d;if(!(n.isAudioPublished()||c.track.id!==p.id||p.id!==h)){f.next=22;break}n.setLog("Have sender for audio, start replacing track",Se.INFO);f.next=22;return c.replaceTrack(p);case 22:n.setLog("Switching an audio device succeeded",Se.INFO);f.next=30;break;case 25:f.prev=25;f.t0=f["catch"](2);a=f.t0;n.setLog("Switching an audio device failed: ".concat(f.t0),Se.ERROR);if(!babelHelpers.classPrivateFieldGet(n,He).microphoneStream){babelHelpers.classPrivateFieldGet(n,He).microphoneStream=o}case 30:f.prev=30;if(!babelHelpers.classPrivateFieldGet(n,He).switchActiveAudioDevicePending){f.next=37;break}v=babelHelpers.classPrivateFieldGet(n,He).switchActiveAudioDevicePending;babelHelpers.classPrivateFieldGet(n,He).switchActiveAudioDevicePending=null;i(n.switchActiveAudioDevice(v,true));f.next=40;break;case 37:s=true;babelHelpers.classPrivateFieldGet(n,He).switchActiveAudioDeviceInProgress=null;return f.abrupt("return",a?r(a):i());case 40:return f.finish(30);case 41:case"end":return f.stop()}}),e,null,[[2,25,30,41]])})));return function(t,i){return e.apply(this,arguments)}}());if(!i&&!s){babelHelpers.classPrivateFieldGet(this,He).switchActiveAudioDeviceInProgress=r}return o.abrupt("return",r);case 10:case"end":return o.stop()}}),e,this)})));function t(t,i){return e.apply(this,arguments)}return t}()},{key:"switchActiveVideoDevice",value:function(){var e=babelHelpers.asyncToGenerator(ue().mark((function e(t,i){var n=this;var a,s,r;return ue().wrap((function e(o){while(1)switch(o.prev=o.next){case 0:if(!(babelHelpers.classPrivateFieldGet(this,He).switchActiveVideoDeviceInProgress&&!i)){o.next=4;break}this.setLog("Got another request to switch a video device to ".concat(t,", saving it"),Se.INFO);babelHelpers.classPrivateFieldGet(this,He).switchActiveVideoDevicePending=t;return o.abrupt("return");case 4:a=null;s=false;this.setLog("Start switching a video device to ".concat(t),Se.INFO);r=new Promise(function(){var e=babelHelpers.asyncToGenerator(ue().mark((function e(i,r){var o,l,c,u,d;return ue().wrap((function e(h){while(1)switch(h.prev=h.next){case 0:babelHelpers.classPrivateFieldGet(n,He).videoDeviceId=t;o=babelHelpers.classPrivateFieldGet(n,He).cameraStream;h.prev=2;l=ve(n,Et,Ei).call(n,ge.Camera);if(l){h.next=8;break}n.setLog("Switching a video device skipped - no sender",Se.WARNING);a="No sender for video";return h.abrupt("return");case 8:if(!n.isVideoPublished()){h.next=19;break}n.setLog("Have sender for video, start replacing track",Se.INFO);(c=babelHelpers.classPrivateFieldGet(n,He).cameraStream)===null||c===void 0?void 0:c.getVideoTracks()[0].stop();babelHelpers.classPrivateFieldGet(n,He).cameraStream=null;h.next=14;return n.getLocalVideo();case 14:u=h.sent;u.source=ge.Camera;h.next=18;return l.replaceTrack(u);case 18:ve(n,Ye,Xt).call(n,l,u);case 19:n.setLog("Switching a video device succeeded",Se.INFO);h.next=27;break;case 22:h.prev=22;h.t0=h["catch"](2);a=h.t0;n.setLog("Switching a video device failed: ".concat(h.t0),Se.ERROR);if(!babelHelpers.classPrivateFieldGet(n,He).cameraStream){babelHelpers.classPrivateFieldGet(n,He).cameraStream=o}case 27:h.prev=27;if(!babelHelpers.classPrivateFieldGet(n,He).switchActiveVideoDevicePending){h.next=34;break}d=babelHelpers.classPrivateFieldGet(n,He).switchActiveVideoDevicePending;babelHelpers.classPrivateFieldGet(n,He).switchActiveVideoDevicePending=null;i(n.switchActiveVideoDevice(d,true));h.next=37;break;case 34:s=true;babelHelpers.classPrivateFieldGet(n,He).switchActiveVideoDeviceInProgress=null;return h.abrupt("return",a?r(a):i());case 37:return h.finish(27);case 38:case"end":return h.stop()}}),e,null,[[2,22,27,38]])})));return function(t,i){return e.apply(this,arguments)}}());if(!i&&!s){babelHelpers.classPrivateFieldGet(this,He).switchActiveVideoDeviceInProgress=r}return o.abrupt("return",r);case 10:case"end":return o.stop()}}),e,this)})));function t(t,i){return e.apply(this,arguments)}return t}()},{key:"isAudioPublished",value:function e(){return ve(this,rt,ai).call(this,ge.Microphone)}},{key:"isVideoPublished",value:function e(){return ve(this,rt,ai).call(this,ge.Camera)}},{key:"isScreenPublished",value:function e(){return ve(this,rt,ai).call(this,ge.Screen)}},{key:"getParticipants",value:function e(){return babelHelpers.classPrivateFieldGet(this,He).remoteParticipants}},{key:"getState",value:function e(){return babelHelpers.classPrivateFieldGet(this,He).callState}},{key:"setRecorderState",value:function e(t){if(!Object.values(Pe).includes(t)){return}var i={recorderControl:{status:t}};return this.isConnected()?ve(this,Rt,Ri).call(this,i):false}},{key:"setCloudRecordState",value:function e(t){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:null;if(!Object.values(_e).includes(t)){return}var n={videoRecorderControl:{status:t,kind:i}};if(Yf.isCloudRecordLogEnabled()){console.warn("CloudRecord: videoRecorderControl",n)}if(this.isConnected()){ve(this,Rt,Ri).call(this,n)}}},{key:"setLog",value:function e(t,i){var n,a;i=Se[i]||Se.INFO;var s=(n=window["BXDesktopSystem"])===null||n===void 0?void 0:(a=n.ApiVersion)===null||a===void 0?void 0:a.call(n);var r=me+(s?" (desktopApi: ".concat(s,")"):"");var o=Date.now();var l={timestamp:Math.floor(o/1e3),timestampMS:o,event:t,client:fe,appVersion:r};if(Yf.isMetricsLogsEnabled()){return ve(this,lt,ri).call(this,l,i)}if(babelHelpers.classPrivateFieldGet(this,He).isloggingEnable){var c=Object.values(babelHelpers.classPrivateFieldGet(this,He).logs).length;babelHelpers.classPrivateFieldGet(this,He).logs[c]={level:i,data:l};var u=0;for(var d in babelHelpers.classPrivateFieldGet(this,He).logs){if(!ve(this,lt,ri).call(this,babelHelpers.classPrivateFieldGet(this,He).logs[d].data,babelHelpers.classPrivateFieldGet(this,He).logs[d].level)){break}u=d}if(u){babelHelpers.classPrivateFieldGet(this,He).logs=Object.values(babelHelpers.classPrivateFieldGet(this,He).logs).slice(u+1)}if(babelHelpers.classPrivateFieldGet(this,He).loggerCallback){babelHelpers.classPrivateFieldGet(this,He).loggerCallback()}}}},{key:"prepareMetricsLogs",value:function e(t){var i=t.logData,n=t.level;var a={timeUnixNano:i.timestampMS*1e6,severityNumber:9,severityText:"INFO",body:{stringValue:i.event},attributes:{level:n,session_id:String(babelHelpers.classPrivateFieldGet(this,He).roomId),peer_id:String(babelHelpers.classPrivateFieldGet(this,He).userId),app_version:i.appVersion,env:String(babelHelpers.classPrivateFieldGet(this,He).monitoringEnvironment),region:String(babelHelpers.classPrivateFieldGet(this,He).monitoringRegion)}};this.currentMonitoringEventsObject.logs.push(a)}},{key:"setLoggerCallback",value:function e(t){babelHelpers.classPrivateFieldGet(this,He).loggerCallback=t}},{key:"enableSilentLogging",value:function e(t){babelHelpers.classPrivateFieldGet(this,He).isloggingEnable=t}},{key:"iceServers",get:function e(){return babelHelpers.classPrivateFieldGet(this,He).iceServers}},{key:"remoteParticipantsCount",get:function e(){return Object.keys(babelHelpers.classPrivateFieldGet(this,He).remoteParticipants).length}},{key:"isMediaMutedBySystem",get:function e(){return babelHelpers.classPrivateFieldGet(this,He).mediaMutedBySystem}},{key:"needToStopStreams",set:function e(t){babelHelpers.classPrivateFieldGet(this,He).needToStopStreams=Boolean(t)}}]);return e}();function Lt(e){var t=this;babelHelpers.classPrivateFieldGet(this,He).isReconnecting=true;babelHelpers.classPrivateFieldGet(this,He).videoQueue=ye.INITIAL;var i=function e(){var i=babelHelpers.classPrivateFieldGet(t,He).lastReconnectionReason!==Re.JoinResponseError?babelHelpers.classPrivateFieldGet(t,He).fastReconnectionDelay:babelHelpers.classPrivateFieldGet(t,He).reconnectionDelay;t.setLog("Reconnecting attempt: ".concat(++babelHelpers.classPrivateFieldGet(t,He).reconnectionAttempt),Se.WARNING);babelHelpers.classPrivateFieldGet(t,He).reconnectionTimeout=setTimeout(t.connect.bind(t),i)};i();this.checkMetricsFeatureAndExecutionCallback((function(){t.addMonitoringEvents({name:we.USER_RECONNECTED,withCounter:true})}));this.triggerEvents("Reconnecting",[e])}function Bt(e){var t=p.Type.isObject(e)?e:{};window.removeEventListener("unload",this.sendLeaveBound);ve(this,Ve,xt).call(this);ve(this,Ue,Ht).call(this);clearInterval(babelHelpers.classPrivateFieldGet(this,He).callStatsInterval);babelHelpers.classPrivateFieldGet(this,He).mediaServerUrl="";babelHelpers.classPrivateFieldGet(this,He).roomData="";babelHelpers.classPrivateFieldGet(this,He).pendingOffer=null;babelHelpers.classPrivateFieldGet(this,He).pendingCandidates={recipient:[],sender:[]};babelHelpers.classPrivateFieldGet(this,He).localTracks={};babelHelpers.classPrivateFieldGet(this,He).isWaitAnswer=false;if(babelHelpers.classPrivateFieldGet(this,He).socketConnect){var i=t.initiatedByUser?Le.Normal:Le.Reconnect;babelHelpers.classPrivateFieldGet(this,He).socketConnect.onmessage=null;babelHelpers.classPrivateFieldGet(this,He).socketConnect.onopen=null;babelHelpers.classPrivateFieldGet(this,He).socketConnect.onerror=null;babelHelpers.classPrivateFieldGet(this,He).socketConnect.onclose=null;babelHelpers.classPrivateFieldGet(this,He).socketConnect.close(i);babelHelpers.classPrivateFieldGet(this,He).socketConnect=null}}function Dt(){var e=this;ve(this,Ue,Ht).call(this);if(!babelHelpers.classPrivateFieldGet(this,He).pingTimeoutDuration){return}babelHelpers.classPrivateFieldGet(this,He).pingTimeout=setTimeout((function(){e.setLog("Ping signal was not received, reconnecting",Se.WARNING);ve(e,xe,Bt).call(e);babelHelpers.classPrivateFieldGet(e,He).lastReconnectionReason=Re.PingPongMissed;ve(e,Ne,Lt).call(e,{reconnectionReason:"PING_SIGNAL_NOT_RECEIVED",reconnectionReasonInfo:""})}),babelHelpers.classPrivateFieldGet(this,He).pingTimeoutDuration)}function Ht(){if(babelHelpers.classPrivateFieldGet(this,He).pingTimeout){clearTimeout(babelHelpers.classPrivateFieldGet(this,He).pingTimeout)}}function Nt(){var e=this;ve(this,Ve,xt).call(this);ve(this,Oe,Dt).call(this);if(!babelHelpers.classPrivateFieldGet(this,He).pingIntervalDuration){return}babelHelpers.classPrivateFieldGet(this,He).pingPongInterval=setInterval((function(){ve(e,Ge,Ot).call(e)}),babelHelpers.classPrivateFieldGet(this,He).pingIntervalDuration)}function xt(){ve(this,Ue,Ht).call(this);if(babelHelpers.classPrivateFieldGet(this,He).pingPongInterval){clearInterval(babelHelpers.classPrivateFieldGet(this,He).pingPongInterval)}}function Ot(){ve(this,Rt,Ri).call(this,{pingReq:{timestamp:Date.now(),rtt:babelHelpers.classPrivateFieldGet(this,He).rtt}})}function Ut(e,t){var i=this;babelHelpers.classPrivateFieldGet(this,He).pendingPublications[e]=setTimeout((function(){delete babelHelpers.classPrivateFieldGet(i,He).pendingPublications[e];i.onPublishFailed(t)}),babelHelpers.classPrivateFieldGet(this,He).publicationTimeout)}function Ft(e,t,i){var n,a,s=this;clearTimeout((n=babelHelpers.classPrivateFieldGet(this,He).pendingSubscriptions[e.userId])===null||n===void 0?void 0:(a=n[t.sid])===null||a===void 0?void 0:a.timeout);if(!babelHelpers.classPrivateFieldGet(this,He).pendingSubscriptions[e.userId]){babelHelpers.classPrivateFieldGet(this,He).pendingSubscriptions[e.userId]={}}if(i===undefined){i=babelHelpers.classPrivateFieldGet(this,He).subscriptionTries}var r=setTimeout((function(){s.setLog("Track ".concat(t.sid," with kind ").concat(t.source," for a participant with id ").concat(e.userId," (sid: ").concat(e.sid,") was not received, trying to subscribe to it"),Se.WARNING);s.checkMetricsFeatureAndExecutionCallback((function(){s.addMonitoringEvents({name:we.TRACK_SUBSCRIPTION_DELAY,withCounter:true})}));if(i){ve(s,Xe,Ft).call(s,e,t,i-1);ve(s,Qe,zt).call(s,t.sid,e.sid,true)}else{s.setLog("Subscription to track ".concat(t.sid," with kind ").concat(t.source," for a participant with id ").concat(e.userId," (sid: ").concat(e.sid,") failed"),Se.ERROR);s.checkMetricsFeatureAndExecutionCallback((function(){s.addMonitoringEvents({name:we.TRACK_SUBSCRIPTION_FAILED,withCounter:true})}));s.triggerEvents("TrackSubscriptionFailed",[{participant:e,track:t}])}}),babelHelpers.classPrivateFieldGet(this,He).subscriptionTimeout);babelHelpers.classPrivateFieldGet(this,He).pendingSubscriptions[e.userId][t.sid]={timeout:r,tries:i}}function Vt(e){var t=16/9;var i=Math.ceil(H.maxLocalStreamQualityHeight*t);if(i<=e){e=i}if(e>=960){return 3}else if(e>=480){return 2}return 1}function Gt(e){var t=ve(this,ze,Vt).call(this,e);var i=["q","h","f"];var n=[];for(var a=0;a<3;a++){var s=i[a];n.push({rid:s,active:a<t,maxBitrate:babelHelpers.classPrivateFieldGet(this,He).defaultSimulcastBitrate[s],scaleResolutionDownBy:Math.pow(2,Math.max(0,t-1-a))})}return n}function Wt(e,t,i){var n=this;return i.map((function(i,a){return{quality:a,width:e/i.scaleResolutionDownBy,height:t/i.scaleResolutionDownBy,bitrate:babelHelpers.classPrivateFieldGet(n,He).defaultSimulcastBitrate[i.rid]}}))}function Xt(e,t){var i=e.getParameters();var n=(t===null||t===void 0?void 0:t.getSettings().width)||H.maxLocalStreamQualityHeight;var a=ve(this,je,Gt).call(this,n);if(i&&i.encodings&&i.encodings.length){i.encodings.forEach((function(e){var t=a.find((function(t){return t.rid===e.rid}));if(t){e.active=t.active;e.maxBitrate=t.maxBitrate;e.scaleResolutionDownBy=t.scaleResolutionDownBy}}));e.setParameters(i)}}function zt(e,t,i){ve(this,Rt,Ri).call(this,{subscription:{trackSids:[e],subscribe:i,participantTracks:[{participantSid:t,trackSids:[e]}]}})}function jt(e,t,i,n){var a=babelHelpers.classPrivateFieldGet(this,He).remoteParticipants[e];if(!a){this.setLog("Trying to pause a track with kind ".concat(i," (sid: ").concat(t,") for a non-existent participant with id ").concat(e),Se.WARNING);return}a.videoPaused=n;ve(this,Rt,Ri).call(this,{trackSetting:{trackSids:[t],disabled:n,quality:ve(this,Ke,qt).call(this,e,i)}})}function qt(e,t){var i=babelHelpers.classPrivateFieldGet(this,He).remoteParticipants[e];var n=babelHelpers.classPrivateFieldGet(this,He).mainStream.userId==e;var a=babelHelpers.classPrivateFieldGet(this,He).mainStream.kind===t;var s=P.LOW;if(n&&(a||!i.screenSharingEnabled)){s=P.HIGH}else if(!babelHelpers.classPrivateFieldGet(this,He).mainStream.userId){s=babelHelpers.classPrivateFieldGet(this,He).defaultRemoteStreamsQuality}return s}function Yt(e,t){var i,n=this;this.setLog("Changing quality of streams; main stream: ".concat(e.userId,", other users: ").concat(e.otherUsers),Se.INFO);(i=e.otherUsers)===null||i===void 0?void 0:i.forEach((function(e){var t=babelHelpers.classPrivateFieldGet(n,He).remoteParticipants[e];if(t){var i=ve(n,Ke,qt).call(n,e,ge.Camera);ve(n,$e,Qt).call(n,t,i)}}));if(e.userId){var a=babelHelpers.classPrivateFieldGet(this,He).remoteParticipants[e.userId];if(a){var s=babelHelpers.classPrivateFieldGet(this,He).defaultRemoteStreamsQuality;if(t===ge.Camera&&babelHelpers.classPrivateFieldGet(this,He).defaultRemoteStreamsQuality>=P.HIGH){s=P.HIGH}babelHelpers.classPrivateFieldGet(this,He).mainStream={userId:e.userId,kind:t};ve(this,$e,Qt).call(this,a,s)}}else{babelHelpers.classPrivateFieldGet(this,He).mainStream={}}}function Qt(e,t){if(!e.setStreamQuality(t)){return}ve(this,Rt,Ri).call(this,{requestLayers:{targetUserId:e.userId,layers:{q:t===P.LOW,h:t===P.MEDIUM,f:t===P.HIGH}}});ve(this,Rt,Ri).call(this,{trackSetting:{quality:t,trackSids:[e.getTrack(ge.Camera).id]}},e.mediaServerId)}function Jt(e,t){var i=this;var n=arguments.length>2&&arguments[2]!==undefined?arguments[2]:false;e.forEach((function(e){var n;var a=e.userId;var s=babelHelpers.classPrivateFieldGet(i,He).remoteParticipants[a];var r=s===null||s===void 0?void 0:(n=s.tracks)===null||n===void 0?void 0:n[ge.Camera];var o=(r===null||r===void 0?void 0:r.subscribed)===true;var l=(s===null||s===void 0?void 0:s.isLocalVideoMute)===t;if(o&&t&&!s.isLocalVideoMute&&!s.isMutedVideo){ve(i,$e,Qt).call(i,s)}else if(o&&l){s.isLocalVideoMute=!t;if(s.isMutedVideo){return}ve(i,Je,jt).call(i,s.userId,s.tracks[ge.Camera].id,s.tracks[ge.Camera].source,s.isLocalVideoMute)}else if(s&&r&&!o&&t&&l){s.isLocalVideoMute=!t;if(s.isMutedVideo){return}ve(i,Qe,zt).call(i,s.tracks[ge.Camera].id,s.sid,!s.isLocalVideoMute,s.mediaServerId)}else if(s&&!t){s.isLocalVideoMute=!t}else if(!s||!s.tracks[ge.Camera]){babelHelpers.classPrivateFieldGet(i,He).participantsToUpdateTrackAvailability[a]=t}}));if(!n){this.triggerEvents("ToggleRemoteParticipantVideo",[t])}}function Kt(){var e,t,i,n;var a=babelHelpers.classPrivateFieldGet(this,He).videoQueue;babelHelpers.classPrivateFieldGet(this,He).videoQueue=ye.INITIAL;if(a===ye.ENABLE&&((e=babelHelpers.classPrivateFieldGet(this,He).cameraStream)===null||e===void 0?void 0:(t=e.getVideoTracks()[0])===null||t===void 0?void 0:t.readyState)!=="live"){this.enableVideo({calledFrom:"processVideoQueue"})}else if(a===ye.DISABLE&&((i=babelHelpers.classPrivateFieldGet(this,He).cameraStream)===null||i===void 0?void 0:(n=i.getVideoTracks()[0])===null||n===void 0?void 0:n.readyState)==="live"&&!babelHelpers.classPrivateFieldGet(this,He).mediaMutedBySystem){this.disableVideo({calledFrom:"processVideoQueue"})}}function Zt(e){var t=arguments.length>1&&arguments[1]!==undefined?arguments[1]:false;var i={audio:false,video:false};if(e.video){i.video={};if(!t){i.video.width={ideal:babelHelpers.classPrivateFieldGet(this,He).defaultVideoResolution.width};i.video.height={ideal:babelHelpers.classPrivateFieldGet(this,He).defaultVideoResolution.height};if(babelHelpers.classPrivateFieldGet(this,He).videoDeviceId){i.video.deviceId={exact:babelHelpers.classPrivateFieldGet(this,He).videoDeviceId}}}return i}if(babelHelpers.classPrivateFieldGet(this,He).audioDeviceId){i.audio={deviceId:{exact:babelHelpers.classPrivateFieldGet(this,He).audioDeviceId}}}else{i.audio=true}return i}function $t(e){return ei.apply(this,arguments)}function ei(){ei=babelHelpers.asyncToGenerator(ue().mark((function e(t){var i=this;var n,a,s,r,o,l,c=arguments;return ue().wrap((function e(u){while(1)switch(u.prev=u.next){case 0:n=c.length>1&&c[1]!==undefined?c[1]:false;this.setLog("Start getting user media with options: ".concat(JSON.stringify(t)));this.triggerEvents("GetUserMediaStarted",[t]);a=ve(this,it,Zt).call(this,t,n);u.prev=4;u.next=7;return ae.getUserMedia(a);case 7:s=u.sent;r=s.clone();if(t.video&&r.getVideoTracks()[0]){ve(this,ot,si).call(this,r.getVideoTracks()[0]);this.triggerEvents("GetUserMediaSuccess",[{video:true}])}if(t.audio&&r.getAudioTracks()[0]){this.triggerEvents("GetUserMediaSuccess",[{audio:true}])}o=t.video?" - trackMuteHandlersAreAdded: true":"";this.setLog("Getting user media with constraints: ".concat(JSON.stringify(a)," succeeded").concat(o));this.triggerEvents("GetUserMediaEnded");return u.abrupt("return",r);case 17:u.prev=17;u.t0=u["catch"](4);if(!t.video){u.next=27;break}this.setLog("Getting user media with constraints: ".concat(JSON.stringify(a)," failed (fallbackMode: ").concat(n,"): ").concat(u.t0),Se.ERROR);if(n){u.next=27;break}this.checkMetricsFeatureAndExecutionCallback((function(){i.addMonitoringEvents({name:we.LOCAL_VIDEO_STREAM_RECEIVING_FAILED,withCounter:true})}));u.next=25;return ve(this,nt,$t).call(this,t,true);case 25:l=u.sent;return u.abrupt("return",l);case 27:if(t.audio){this.checkMetricsFeatureAndExecutionCallback((function(){i.addMonitoringEvents({name:we.LOCAL_MICROPHONE_STREAM_RECEIVING_FAILED,withCounter:true})}))}this.setLog("Getting user media with constraints: ".concat(JSON.stringify(a)," failed: ").concat(u.t0),Se.ERROR);this.triggerEvents("GetUserMediaEnded");return u.abrupt("return",null);case 31:case"end":return u.stop()}}),e,this,[[4,17]])})));return ei.apply(this,arguments)}function ti(){return ii.apply(this,arguments)}function ii(){ii=babelHelpers.asyncToGenerator(ue().mark((function e(){var t=this;var i,n;return ue().wrap((function e(a){while(1)switch(a.prev=a.next){case 0:this.setLog("Start getting display media");a.prev=1;a.next=4;return ae.getUserScreen();case 4:i=a.sent;n=i.clone();this.setLog("Getting display media succeeded");return a.abrupt("return",n);case 10:a.prev=10;a.t0=a["catch"](1);this.setLog("Getting display media failed: ".concat(a.t0),Se.ERROR);this.checkMetricsFeatureAndExecutionCallback((function(){t.addMonitoringEvents({name:we.LOCAL_SCREEN_STREAM_RECEIVING_FAILED,withCounter:true})}));return a.abrupt("return",null);case 15:case"end":return a.stop()}}),e,this,[[1,10]])})));return ii.apply(this,arguments)}function ni(e,t){var i=this;if(e&&!e.onended){e.onended=function(){var e,n;var a=false;var s=null;if(t===ge.Microphone){s="microphone"}else if(t===ge.Camera){s="camera"}if(babelHelpers.classPrivateFieldGet(i,He).localTracks[t]){babelHelpers.classPrivateFieldGet(i,He).localTracks[t].muted=true;if(t===ge.Camera){i.setLog("Video track is ended - muted: true",Se.INFO)}}var r=(e=navigator)!==null&&e!==void 0&&(n=e.permissions)!==null&&n!==void 0&&n.query?navigator.permissions.query({name:s}):Promise.resolve();r.then((function(e){a=(e===null||e===void 0?void 0:e.state)==="granted"}))["catch"]((function(){}))["finally"]((function(){i.triggerEvents("PublishEnded",[t,a])}))}}}function ai(e){var t;return babelHelpers.classPrivateFieldGet(this,He).localTracks[e]&&((t=babelHelpers.classPrivateFieldGet(this,He).localTracks[e])===null||t===void 0?void 0:t.muted)!==true}function si(e){var t=this;e.onmute=function(e){t.setLog('Video track event "mute" was triggered',Se.INFO);babelHelpers.classPrivateFieldGet(t,He).mediaMutedBySystem=false;t.disableVideo({calledFrom:"track.onmute",bySystem:true});t.disableAudio({calledFrom:"track.onmute",bySystem:true});babelHelpers.classPrivateFieldGet(t,He).mediaMutedBySystem=true;t.triggerEvents("MediaMutedBySystem",[true])};e.onunmute=function(e){t.setLog('Video track event "unmute" was triggered',Se.INFO);if(babelHelpers.classPrivateFieldGet(t,He).mediaMutedBySystem){babelHelpers.classPrivateFieldGet(t,He).mediaMutedBySystem=false;t.triggerEvents("MediaMutedBySystem",[false])}t.enableVideo({calledFrom:"track.onunmute"});if(babelHelpers.classPrivateFieldGet(t,He).needToEnableAudioAfterSystemMuted){t.enableAudio()}}}function ri(e,t){if(Yf.isMetricsLogsEnabled()){return this.prepareMetricsLogs({logData:e,level:t})}if(!Yf.isKibanaLogsEnabled()){return true}var i={sendLog:{userName:"".concat(babelHelpers.classPrivateFieldGet(this,He).userId),data:JSON.stringify(e),msgLevel:t}};return this.isConnected()?ve(this,Rt,Ri).call(this,i):false}function oi(e){var t=[];e.split(/(\r\n|\r|\n)/).filter(RegExp.prototype.test.bind(/^([a-z])=(.*)/)).forEach((function(e){if(!e.startsWith("a=candidate")||e.includes("tcp")){t.push(e)}}));e=t.join("\r\n")+"\r\n";return e}function li(e){return ci.apply(this,arguments)}function ci(){ci=babelHelpers.asyncToGenerator(ue().mark((function e(t){var i=this;var n;return ue().wrap((function e(a){while(1)switch(a.prev=a.next){case 0:this.setLog("Start handling a remote answer",Se.INFO);n=false;a.prev=2;if(Yf.useTcpSdp()){t.answer.sdp=ve(this,ct,oi).call(this,t.answer.sdp)}a.next=6;return this.sender.setRemoteDescription(t.answer);case 6:babelHelpers.classPrivateFieldGet(this,He).pendingCandidates.sender.forEach((function(e){i.sender.addIceCandidate(e);i.setLog("Added a deferred ICE candidate",Se.INFO)}));babelHelpers.classPrivateFieldGet(this,He).pendingCandidates.sender=[];a.next=17;break;case 10:a.prev=10;a.t0=a["catch"](2);this.setLog("Handling a remote answer failed: ".concat(a.t0),Se.ERROR);n=true;ve(this,xe,Bt).call(this);ve(this,Ne,Lt).call(this,{reconnectionReason:"HANDLING_ANSWER",reconnectionReasonInfo:"Handling a remote answer failed: ".concat(a.t0)});this.checkMetricsFeatureAndExecutionCallback((function(){i.addMonitoringEvents({name:we.PEER_CONNECTION_ISSUES_HANDLING_ANSWER})}));case 17:a.prev=17;if(n){a.next=23;break}this.setLog("Handling a remote answer succeeded",Se.INFO);babelHelpers.classPrivateFieldGet(this,He).isWaitAnswer=false;a.next=23;return this.sendOffer();case 23:return a.finish(17);case 24:case"end":return a.stop()}}),e,this,[[2,10,17,24]])})));return ci.apply(this,arguments)}function ui(e){return di.apply(this,arguments)}function di(){di=babelHelpers.asyncToGenerator(ue().mark((function e(t){var i=this;var n;return ue().wrap((function e(a){while(1)switch(a.prev=a.next){case 0:this.setLog("Handling a remote offer",Se.INFO);if(this.recipient){a.next=5;break}this.setLog("Handling a remote offer deferred");babelHelpers.classPrivateFieldGet(this,He).pendingOffer=t;return a.abrupt("return");case 5:a.prev=5;if(Yf.useTcpSdp()){t.offer.sdp=ve(this,ct,oi).call(this,t.offer.sdp)}a.next=9;return this.recipient.setRemoteDescription(t.offer);case 9:babelHelpers.classPrivateFieldGet(this,He).pendingCandidates.recipient.forEach((function(e){i.recipient.addIceCandidate(e);i.setLog("Added a deferred ICE candidate",Se.INFO)}));babelHelpers.classPrivateFieldGet(this,He).pendingCandidates.recipient=[];a.next=13;return this.recipient.createAnswer();case 13:n=a.sent;if(Yf.useTcpSdp()){n={type:n.type,sdp:ve(this,ct,oi).call(this,n.sdp)}}a.next=17;return this.recipient.setLocalDescription(n);case 17:ve(this,Rt,Ri).call(this,{answer:n});this.setLog("Handling a remote offer succeeded",Se.INFO);a.next=27;break;case 21:a.prev=21;a.t0=a["catch"](5);this.setLog("Handling a remote offer failed: ".concat(a.t0),Se.ERROR);ve(this,xe,Bt).call(this);ve(this,Ne,Lt).call(this,{reconnectionReason:"HANDLING_OFFER",reconnectionReasonInfo:"Handling a remote offer failed: ".concat(a.t0)});this.checkMetricsFeatureAndExecutionCallback((function(){i.addMonitoringEvents({name:we.PEER_CONNECTION_ISSUES_HANDLING_OFFER})}));case 27:case"end":return a.stop()}}),e,this,[[5,21]])})));return di.apply(this,arguments)}function hi(e){var t=this;this.setLog("Start adding an ICE candidate",Se.INFO);try{var i=JSON.parse(e.candidateInit);if(Yf.useTcpSdp()&&!i.candidate.includes("tcp")){return}if(e.target){var n;if((n=this.recipient)!==null&&n!==void 0&&n.remoteDescription){this.recipient.addIceCandidate(i);this.setLog("Adding an ICE candidate succeeded",Se.INFO);return}babelHelpers.classPrivateFieldGet(this,He).pendingCandidates.recipient.push(i);this.setLog("Adding an ICE candidate deferred: has no remote description",Se.INFO)}else{var a;if((a=this.sender)!==null&&a!==void 0&&a.remoteDescription){this.sender.addIceCandidate(i);this.setLog("Adding an ICE candidate succeeded",Se.INFO);return}babelHelpers.classPrivateFieldGet(this,He).pendingCandidates.sender.push(i);this.setLog("Adding an ICE candidate deferred: has no remote description",Se.INFO)}}catch(e){this.setLog("Adding an ICE candidate failed: ".concat(e),Se.ERROR);this.checkMetricsFeatureAndExecutionCallback((function(){t.addMonitoringEvents({name:we.PEER_CONNECTION_ISSUES_ADDING_ICE_CANDIDATE,value:3})}))}}function pi(e){try{var t=JSON.parse(e);Yf.setUserPermissions(t)}catch(t){this.setLog("Could not parse a permissions JSON: ".concat(e,"  ").concat(t.message),Se.WARNING)}}function vi(e){var t=this;var i=e.userId;var n=babelHelpers.classPrivateFieldGet(this,He).remoteParticipants[i]?"ParticipantStateUpdated":"ParticipantJoined";var a=new Li(e,babelHelpers.classPrivateFieldGet(this,He).socketConnect);babelHelpers.classPrivateFieldGet(this,He).remoteParticipants[i]=a;this.triggerEvents(n,[a]);if(e.participantTracks){Object.values(e.participantTracks).forEach((function(n){n.userId=i;babelHelpers.classPrivateFieldGet(t,He).tracksDataFromSocket[n.sid]=n;if(n.muted&&n.source===ge.Microphone){a.isMutedAudio=true}if(n.muted&&n.source===ge.Camera){a.isMutedVideo=true}switch(n.source){case ge.Camera:a.videoEnabled=true;break;case ge.Microphone:a.audioEnabled=true;break;case ge.Screen:a.screenSharingEnabled=true;break}t.setLog("A participant with id ".concat(i," (sid: ").concat(e.sid,") has a track info with kind ").concat(n.source," (sid: ").concat(n.sid,", waiting for it"),Se.INFO);var s=babelHelpers.classPrivateFieldGet(t,He).ontrackData[n.sid];delete babelHelpers.classPrivateFieldGet(t,He).ontrackData[n.sid];if(s){ve(t,ft,fi).call(t,n.sid,s)}else{ve(t,Xe,Ft).call(t,e,n)}}))}if(babelHelpers.classPrivateFieldGet(this,He).videoStreamSetupErrorList[i]){var s=babelHelpers.toConsumableArray(babelHelpers.classPrivateFieldGet(this,He).videoStreamSetupErrorList[i]);delete babelHelpers.classPrivateFieldGet(this,He).videoStreamSetupErrorList[i];s.forEach((function(e){t.setMainStream(i,e)}))}}function fi(e,t){var i,n,a,s=this;var r=babelHelpers.classPrivateFieldGet(this,He).tracksDataFromSocket[e];var o=r.userId;var l=babelHelpers.classPrivateFieldGet(this,He).remoteParticipants[o];var c=t.track;var u=!!r.muted;babelHelpers.classPrivateFieldGet(this,He).realTracksIds[c.id]=e;c.source=r.source;c.layers=r.layers||null;if(!((i=babelHelpers.classPrivateFieldGet(this,He).remoteTracks)!==null&&i!==void 0&&i[o])){babelHelpers.classPrivateFieldGet(this,He).remoteTracks[o]={}}var d=new be(e,c);babelHelpers.classPrivateFieldGet(this,He).remoteTracks[o][e]=d;if(d.source===ge.Camera){l.isMutedVideo=u}else if(d.source===ge.Microphone){l.isMutedAudio=u;if(u){this.setLog("Trigger mute signal (".concat(u,") for received audio from a participant with id ").concat(l.userId," (sid: ").concat(l.sid,")"),Se.INFO);this.triggerEvents("RemoteMediaMuted",[l,d])}}if((n=babelHelpers.classPrivateFieldGet(this,He).pendingSubscriptions[o])!==null&&n!==void 0&&(a=n[e])!==null&&a!==void 0&&a.timeout){clearTimeout(babelHelpers.classPrivateFieldGet(this,He).pendingSubscriptions[o][e].timeout);delete babelHelpers.classPrivateFieldGet(this,He).pendingSubscriptions[o][e]}this.setLog("Got an expected track with kind ".concat(d.source," (sid: ").concat(e,") for a participant with id ").concat(l.userId," (sid: ").concat(l.sid,")"),Se.INFO);l.addTrack(d.source,d);if(d.source!==ge.Camera||!l.isMutedVideo){this.triggerEvents("RemoteMediaAdded",[l,d])}if(d.source===ge.Camera){var h=ve(this,Ke,qt).call(this,o,d.source);this.setLog("Quality of video for a participant with id ".concat(l.userId," (sid: ").concat(l.sid,") was changed to ").concat(h," after receiving"),Se.INFO);l.setStreamQuality(h)}if(c.kind==="video"){var p=Yf.getUuidv4();l.streamRemovingId=p;t.streams[0].onremovetrack=function(){var e=babelHelpers.classPrivateFieldGet(s,He).remoteParticipants[o];if((e===null||e===void 0?void 0:e.streamRemovingId)===p){s.setLog("Track with kind ".concat(c.source," (sid: ").concat(c.id,") for a participant with id ").concat(o," (sid: ").concat(e.sid||"unknown",") was removed from peer connection"),Se.WARNING);s.triggerEvents("RemoteMediaRemoved",[e,d])}else{s.setLog("Track with kind ".concat(c.source," (sid: ").concat(c.id,") was removed from a disconnected participant with id ").concat(o," (sid: unknown) before it was removed from peer connection"),Se.WARNING)}}}}function mi(e){var t=this;e.speakersChanged.speakers.forEach((function(e){var i=Object.values(babelHelpers.classPrivateFieldGet(t,He).remoteParticipants).find((function(t){return t.sid===e.sid}));if(i&&(i===null||i===void 0?void 0:i.userId)!=babelHelpers.classPrivateFieldGet(t,He).userId){i.isSpeaking=(e===null||e===void 0?void 0:e.active)||false;if(e!==null&&e!==void 0&&e.active){t.triggerEvents("VoiceStarted",[i])}else{t.triggerEvents("VoiceEnded",[i])}}}))}function gi(e){var t;var i=babelHelpers.classPrivateFieldGet(this,He).remoteParticipants[e.track.publisher];var n=e.track.shortId;this.setLog('Got socket message "trackMuted" - trackId: '.concat(n,", muted: ").concat(e===null||e===void 0?void 0:e.muted),Se.INFO);if(e.track.publisher==babelHelpers.classPrivateFieldGet(this,He).userId){var a;var s=(a=Object.values(babelHelpers.classPrivateFieldGet(this,He).localTracks))===null||a===void 0?void 0:a.find((function(e){return(e===null||e===void 0?void 0:e.sid)===n}));if(s){if(s.source===ge.Camera){this.setLog("Got mute self video signal (".concat(e.muted,") - trackId: ").concat(n),Se.INFO);if(!e.muted&&s.muted&&!babelHelpers.classPrivateFieldGet(this,He).mediaMutedBySystem){this.triggerEvents("PublishSucceed",[s.source])}else if(!babelHelpers.classPrivateFieldGet(this,He).mediaMutedBySystem){this.triggerEvents("PublishPaused",[s.source])}if(babelHelpers.classPrivateFieldGet(this,He).videoQueue){ve(this,tt,Kt).call(this)}}else if(s.source===ge.Microphone){this.triggerEvents("PublishPaused",[s.source,e.muted])}}else{this.setLog("Mute self signal (".concat(e.muted,") getting failed - trackId: ").concat(n),Se.INFO)}return}if(!i){if(e.track.publisher!=babelHelpers.classPrivateFieldGet(this,He).userId){this.setLog("Got mute signal (".concat(e.muted,") for a non-existent participant with id ").concat(e.track.publisher),Se.WARNING)}return}var r=(t=Object.values(i.tracks))===null||t===void 0?void 0:t.find((function(e){return(e===null||e===void 0?void 0:e.id)===n}));var o=babelHelpers.classPrivateFieldGet(this,He).tracksDataFromSocket[n];if(o&&!r){babelHelpers.classPrivateFieldGet(this,He).tracksDataFromSocket[n].muted=e.muted;this.setLog("Got mute signal (".concat(e.muted,") for a non-received track with id ").concat(n),Se.WARNING);return}else if(!r){this.setLog("Got mute signal (".concat(e.muted,") for a non-existent track with id ").concat(n),Se.WARNING);return}if(r.source===ge.Microphone){ve(this,bt,bi).call(this,{track:r,isMuted:e.muted,participant:i});this.setLog("Got mute signal (".concat(e.muted,") for audio from a participant with id ").concat(i.userId," (sid: ").concat(i.sid,")"),Se.INFO)}else if(r.source===ge.Camera){ve(this,Ct,Ci).call(this,{track:r,isMuted:e.muted,participant:i});this.setLog("Got mute signal (".concat(e.muted,") for video from a participant with id ").concat(i.userId," (sid: ").concat(i.sid,")"),Se.INFO)}}function bi(e){e.participant.isMutedAudio=e.isMuted;var t=e.isMuted?"RemoteMediaMuted":"RemoteMediaUnmuted";this.triggerEvents(t,[e.participant,e.track])}function Ci(e){var t,i,n;this.setLog("Camera muting was changed (".concat(e===null||e===void 0?void 0:e.isMuted,") - trackSid: ").concat(e===null||e===void 0?void 0:(t=e.track)===null||t===void 0?void 0:t.sid,", participantUserId: ").concat(e===null||e===void 0?void 0:(i=e.participant)===null||i===void 0?void 0:i.userId,", trackSource: ").concat(e===null||e===void 0?void 0:(n=e.track)===null||n===void 0?void 0:n.source),Se.INFO);e.participant.isMutedVideo=e.isMuted;var a=e.isMuted?"RemoteMediaRemoved":"RemoteMediaAdded";if(babelHelpers.classPrivateFieldGet(this,He).tracksDataFromSocket[e.track.sid]){babelHelpers.classPrivateFieldGet(this,He).tracksDataFromSocket[e.track.sid].muted=e.isMuted}this.triggerEvents(a,[e.participant,e.track])}function ki(e){if(!Yf.isUserControlFeatureEnabled()){return}if(e.toUserId===e.fromUserId){return}if(e.toUserId!=babelHelpers.classPrivateFieldGet(this,He).userId){var t=babelHelpers.classPrivateFieldGet(this,He).remoteParticipants[e.toUserId];if(!t){this.setLog("Got a onParticipantMuted event for non-existent user (toUserId: ".concat(e.toUserId,")"),Se.WARNING);return}if(e!==null&&e!==void 0&&e.track.muted){if(e.track.type===0&&t.audioEnabled){var i;t.audioEnabled=false;var n=(i=Object.values(t.tracks))===null||i===void 0?void 0:i.find((function(e){return(e===null||e===void 0?void 0:e.source)===ge.Microphone}));ve(this,bt,bi).call(this,{track:n,isMuted:true,participant:t})}else if(e.track.type===1&&t.videoEnabled){var a;this.setLog("Mute participant video - from: ".concat(e===null||e===void 0?void 0:e.fromUserId,", to: ").concat(e===null||e===void 0?void 0:e.toUserId),Se.INFO);t.videoEnabled=false;var s=(a=Object.values(t.tracks))===null||a===void 0?void 0:a.find((function(e){return(e===null||e===void 0?void 0:e.source)===ge.Camera}));ve(this,Ct,Ci).call(this,{track:s,isMuted:true,participant:t})}else if(e.track.type===1&&!t.videoEnabled){this.setLog("Cancel participant video muting - from: ".concat(e===null||e===void 0?void 0:e.fromUserId,", to: ").concat(e===null||e===void 0?void 0:e.toUserId),Se.INFO)}else if(e.track.type===2&&t.screenSharingEnabled){var r;t.screenSharingEnabled=false;var o=(r=Object.values(t.tracks))===null||r===void 0?void 0:r.find((function(e){return(e===null||e===void 0?void 0:e.source)===ge.Screen}));var l=t.getTrack(ge.ScreenAudio);ve(this,Ct,Ci).call(this,{track:o,isMuted:true,participant:t});if(l){ve(this,bt,bi).call(this,{track:l,isMuted:true,participant:t})}}}}this.triggerEvents("ParticipantMuted",[e])}function yi(e){if(!Yf.isUserControlFeatureEnabled()){return}if(e.fromUserId==babelHelpers.classPrivateFieldGet(this,He).userId){if(!e.reason||e.reason&&e.reason!="settings"){this.triggerEvents("YouMuteAllParticipants",[e])}}else{if((e===null||e===void 0?void 0:e.track.type)===0){this.triggerEvents("AllParticipantsAudioMuted",[e])}else if(e.track.type===1){this.setLog("Try to mute all participant videos - from: ".concat(e===null||e===void 0?void 0:e.fromUserId),Se.INFO);this.triggerEvents("AllParticipantsVideoMuted",[e])}else if(e.track.type===2){this.triggerEvents("AllParticipantsScreenshareMuted",[e])}}if(e!==null&&e!==void 0&&e.track.muted){for(var t in babelHelpers.classPrivateFieldGet(this,He).remoteParticipants){if(babelHelpers.classPrivateFieldGet(this,He).remoteParticipants.hasOwnProperty(t)){var i=babelHelpers.classPrivateFieldGet(this,He).remoteParticipants[t];if(i.userId!=e.fromUserId&&Yf.isRegularUser(Yf.getUserRoleByUserId(i.userId))){if(e.track.type===0&&i.audioEnabled){i.audioEnabled=false;var n=i.getTrack(ge.Microphone);ve(this,bt,bi).call(this,{track:n,isMuted:true,participant:i})}else if(e.track.type===1&&i.videoEnabled){i.videoEnabled=false;this.setLog("Mute participant video - from: ".concat(e===null||e===void 0?void 0:e.fromUserId,", to: ").concat(i===null||i===void 0?void 0:i.userId),Se.INFO);var a=i.getTrack(ge.Camera);ve(this,Ct,Ci).call(this,{track:a,isMuted:true,participant:i})}else if(e.track.type===1&&!i.videoEnabled){this.setLog("Cancel participant video muting - from: ".concat(e===null||e===void 0?void 0:e.fromUserId,", to: ").concat(i===null||i===void 0?void 0:i.userId),Se.INFO)}else if(e.track.type===2){i.screenSharingEnabled=false;var s=i.getTrack(ge.Screen);var r=i.getTrack(ge.ScreenAudio);ve(this,Ct,Ci).call(this,{track:s,isMuted:true,participant:i});if(r){ve(this,bt,bi).call(this,{track:r,isMuted:true,participant:i})}}}}}}}function Si(e){if(!Yf.isUserControlFeatureEnabled()){return}if(e.toUserId==babelHelpers.classPrivateFieldGet(this,He).userId){Yf.setCurrentUserRole(e.role);ve(this,pt,pi).call(this,e.permissions)}this.triggerEvents("UserRoleChanged",[e])}function wi(e){if(!Yf.isUserControlFeatureEnabled()){return}if(e.allow===true&&Yf.isRegularUser(Yf.getCurrentUserRole())){var t=Yf.getUserPermissions();t.audio=e.allow;t.video=e.allow;t.screen_share=e.allow;Yf.setUserPermissions(t)}this.triggerEvents("UserPermissionsChanged",[e])}function Ii(e){if(!Yf.isUserControlFeatureEnabled()){return}e.calledFrom="settingsChanged";var t=Yf.getRoomPermissions();var i={reason:"settings",eft:e.eft,fromUserId:e.fromUserId,track:{type:0}};switch(e.act){case"audio":i.track.type=0;t.AudioEnabled=e.roomState.AudioEnabled;break;case"video":i.track.type=1;t.VideoEnabled=e.roomState.VideoEnabled;break;case"screen_share":i.track.type=2;t.ScreenShareEnabled=e.roomState.ScreenShareEnabled;break}Yf.setRoomPermissions(t);Yf.updateUserPermissionByNewRoomPermission(e.act,!e.eft);if(e.eft===true){ve(this,yt,yi).call(this,i)}this.triggerEvents("RoomSettingsChanged",[e])}function Ti(){var e=this;ve(this,Pt,Pi).call(this);var t={};if(babelHelpers.classPrivateFieldGet(this,He).iceServers){t.iceServers=babelHelpers.classPrivateFieldGet(this,He).iceServers}this.sender=new RTCPeerConnection(t);this.sender.addEventListener("icecandidate",(function(t){return e.onIceCandidate(null,t)}));this.sender.addEventListener("connectionstatechange",(function(t){return e.onConnectionStateChange()}));this.sender.addEventListener("iceconnectionstatechange",(function(t){return e.onIceConnectionStateChange()}));this.recipient=new RTCPeerConnection(t);this.recipient.ontrack=function(t){var i;var n=t.streams[0].id.split("|");var a=n[1];var s=(i=babelHelpers.classPrivateFieldGet(e,He).tracksDataFromSocket[a])===null||i===void 0?void 0:i.userId;if(babelHelpers.classPrivateFieldGet(e,He).remoteParticipants[s]&&babelHelpers.classPrivateFieldGet(e,He).tracksDataFromSocket[a]){ve(e,ft,fi).call(e,a,t)}else{e.setLog("Got a track with kind ".concat(t.track.kind," (sid: ").concat(a,") without a participant, saving it"),Se.WARNING);babelHelpers.classPrivateFieldGet(e,He).ontrackData[a]=t}};this.recipient.addEventListener("icecandidate",(function(t){return e.onIceCandidate("SUBSCRIBER",t)}));this.recipient.addEventListener("connectionstatechange",(function(t){return e.onConnectionStateChange(true)}));this.recipient.addEventListener("iceconnectionstatechange",(function(t){return e.onIceConnectionStateChange(true)}));if(babelHelpers.classPrivateFieldGet(this,He).pendingOffer){ve(this,dt,ui).call(this,babelHelpers.classPrivateFieldGet(this,He).pendingOffer);babelHelpers.classPrivateFieldGet(this,He).pendingOffer=null}var i=function(){var t=babelHelpers.asyncToGenerator(ue().mark((function t(){var i,n;return ue().wrap((function t(a){while(1)switch(a.prev=a.next){case 0:a.prev=0;i={};n=false;a.next=5;return e.sender.getStats(null).then((function(t){var a=[];var s={};var r={};var o={};var l={};var c=false;var u=[];t.forEach((function(t){var i=ce({},t);a.push(i);if(i.type==="codec"){Yf.processReportsWithoutCodecs(i,s,r)}if(i.type==="remote-inbound-rtp"){var d=i.localId;if(!l[d]){o[d]=i;return}if(!babelHelpers.classPrivateFieldGet(e,He).outgoingTracksReports[d]){babelHelpers.classPrivateFieldGet(e,He).outgoingTracksReports[d]={}}var h=babelHelpers.classPrivateFieldGet(e,He).outgoingTracksReports[d];var p=Yf.calcLocalPacketsLost(l[d],h,i);var v=p.currentPercentPacketLost;e.checkMetricsFeatureAndExecutionCallback((function(){var t,n,a;e.addValidatedMonitoringMetric({additionalData:{currentReportPacketsSent:(t=l[d])===null||t===void 0?void 0:t.packetsSent,prevReportPacketsSent:(n=babelHelpers.classPrivateFieldGet(e,He).outgoingTracksReports[d])===null||n===void 0?void 0:n.packetsSent,prevReportPacketsLost:(a=babelHelpers.classPrivateFieldGet(e,He).outgoingTracksReports[d])===null||a===void 0?void 0:a.packetsLost,remoteReportPacketsLost:i===null||i===void 0?void 0:i.packetsLost},metricKey:Ie.PACKET_LOST_SEND,metricValue:v})}));if(!n&&v>babelHelpers.classPrivateFieldGet(e,He).packetLostThreshold){n=true;e.checkMetricsFeatureAndExecutionCallback((function(){e.addMonitoringEvents({name:we.HIGH_PACKET_LOSS_SEND,withCounter:true})}))}h.packetsLostData=p;h.packetsLost=ce({},p);h.packetsLostExtended=Yf.formatPacketsLostData(p);delete l[d]}if(i.type==="outbound-rtp"){var f=i.id;if(!babelHelpers.classPrivateFieldGet(e,He).outgoingTracksReports[f]){babelHelpers.classPrivateFieldGet(e,He).outgoingTracksReports[f]={}}var m=babelHelpers.classPrivateFieldGet(e,He).outgoingTracksReports[f];i.bitrate=Yf.calcBitrate(i,m,true);babelHelpers.classPrivateFieldGet(e,He).outgoingTracksReports[f]=ce(ce({},m),i);i.userId=babelHelpers.classPrivateFieldGet(e,He).userId;if(i.kind==="audio"){i.source=ge.Microphone}else if(i.kind==="video"){i.source=i.contentType==="screenshare"?ge.Screen:ge.Camera}u.push({bitrate:i.bitrate,kind:i.kind,contentType:i.contentType});if(i.qualityLimitationReason&&i.qualityLimitationReason!=="none"&&!c){e.checkMetricsFeatureAndExecutionCallback((function(){if(i.qualityLimitationReason==="cpu"){e.addMonitoringEvents({name:we.CPU_ISSUES,withCounter:true})}if(i.qualityLimitationReason==="bandwidth"){e.addMonitoringEvents({name:we.NETWORK_ISSUES,withCounter:true})}}));c=true;var g=Object.entries(i.qualityLimitationDurations).reduce((function(e,t,i){return"".concat(e).concat(i?", ":"").concat(t[0],": ").concat(t[1])}),"");e.setLog("Local user have problems with sending video: ".concat(i.qualityLimitationReason," (").concat(g,")"),Se.WARNING)}if(!Yf.setCodecToReport(i,s,r)){Yf.saveReportWithoutCodecs(i,r)}Yf.setLocalPacketsLostOrSaveReport(i,o,l)}}));e.checkMetricsFeatureAndExecutionCallback((function(){var t=e.calcBitrateSumFromArray({bitrateArray:u});var i=Number.parseFloat((t/1e6).toFixed(2));if(e.currentMonitoringEventsObject.metrics[Ie.BITRATE_OUT].length<e.countMetricsInMetricsInterval){e.addValidatedMonitoringMetric({additionalData:{bitrateList:u,bitrateSumOut:t,formattedBitrateOut:i},metricKey:Ie.BITRATE_OUT,metricValue:t})}}));i.sender=a}));case 5:a.next=7;return e.recipient.getStats(null).then((function(t){var n=[];var a=new Map;var s={};var r={};var o=[];var l=0;var c={freezeCount:[],totalFreezesDuration:[],jitter:[],framesDecoded:[],framesDropped:[],framesReceived:[],framesLoss:[]};t.forEach((function(t){if(t.type==="inbound-rtp"&&t.kind==="video"){var i=t.freezeCount,u=t.totalFreezesDuration,d=t.jitter,h=t.framesDecoded,p=t.framesDropped,v=t.framesReceived;c.jitter.push(d);c.totalFreezesDuration.push(u);c.freezeCount.push(i);c.framesDecoded.push(h);c.framesDropped.push(p);c.framesReceived.push(v);c.framesLoss.push(p/v*100)}n.push(t);var f=(t===null||t===void 0?void 0:t.trackIdentifier)&&t.hasOwnProperty("packetsLost")&&t.hasOwnProperty("packetsReceived");if(f){var m=Yf.calcRemotePacketsLost(t,babelHelpers.classPrivateFieldGet(e,He).reportsForIncomingTracks[t.trackIdentifier]);t.packetsLostExtended=Yf.formatPacketsLostData(m);babelHelpers.classPrivateFieldGet(e,He).reportsForIncomingTracks[t.trackIdentifier]=t;var g=babelHelpers.classPrivateFieldGet(e,He).realTracksIds[t.trackIdentifier];var b=babelHelpers.classPrivateFieldGet(e,He).tracksDataFromSocket[g];if(b){var C=b.report||{};b.report=t;t.bitrate=Yf.calcBitrate(t,C);t.userId=b.userId;t.source=b.source;var k=m.currentPercentPacketLost;if(b.source===ge.Camera){l=k}o.push({bitrate:t.bitrate,kind:t.kind,contentType:t.contentType});if(!Yf.setCodecToReport(t,s,r)){Yf.saveReportWithoutCodecs(t,r)}t.inRemoteTracks=!!(babelHelpers.classPrivateFieldGet(e,He).remoteTracks[b.userId]&&babelHelpers.classPrivateFieldGet(e,He).remoteTracks[b.userId][g])?"Y":"N"}if(m.currentPercentPacketLost>babelHelpers.classPrivateFieldGet(e,He).packetLostThreshold){var y=Object.values(babelHelpers.classPrivateFieldGet(e,He).remoteParticipants).find((function(e){var i,n,a;return(e===null||e===void 0?void 0:(i=e.tracks)===null||i===void 0?void 0:(n=i[ge.Camera])===null||n===void 0?void 0:(a=n.track)===null||a===void 0?void 0:a.id)===t.trackIdentifier}));if(y&&y.userId!=babelHelpers.classPrivateFieldGet(e,He).userId){a.set(y.userId,"userId: ".concat(y.userId," (").concat(m.currentPercentPacketLost,"%)"));babelHelpers.classPrivateFieldGet(e,He).prevParticipantsWithLargeDataLoss["delete"](y.userId)}}}if(t.type==="codec"){Yf.processReportsWithoutCodecs(t,s,r)}}));e.checkMetricsFeatureAndExecutionCallback((function(){var t=e.getCountRemoteTracks(),i=t.countVideoTracks,n=t.countAudioTracks;var a=function e(t,i){return Math.round(t*Math.pow(10,i))/Math.pow(10,i)};var s=function t(n){var s=n.key,r=n.metricsKey,o=n.isSum,l=n.decimal,u=l===void 0?0:l,d=n.interval;if(e.currentMonitoringEventsObject.metrics[Ie[r]].length>=e.countMetricsInMetricsInterval){return}var h=c[s].reduce((function(e,t){return e+t}),0)/(d?babelHelpers.classPrivateFieldGet(e,He).statsTimeout/1e3:1);var p=e.prevInboundRtpStatsSum[s];var v=p&&!!o?h-p:h;var f=!!i?v/i:0;e.addValidatedMonitoringMetric({additionalData:{inboundRtpStatsArrayByKey:c[s],inboundRtpStatsArraySumByKey:h,prevInboundRtpStatsArraySumByKey:p,diffInboundRtpStatsArraySumByKey:v,metricValue:f},metricKey:r,metricValue:a(f,u)});e.prevInboundRtpStatsSum[s]=h};s({key:"jitter",metricsKey:Ie.JITTER,isSum:false,decimal:3});s({key:"freezeCount",metricsKey:Ie.FREEZE_COUNT,isSum:true,interval:true});s({key:"totalFreezesDuration",metricsKey:Ie.TOTAL_FREEZE_DURATION,isSum:true,decimal:3,interval:true});s({key:"framesDecoded",metricsKey:Ie.FRAMES_DECODED,isSum:true,interval:true});s({key:"framesReceived",metricsKey:Ie.FRAMES_RECEIVED,isSum:true,interval:true});s({key:"framesDropped",metricsKey:Ie.FRAMES_DROPPED,isSum:true,interval:true});e.addValidatedMonitoringMetric({metricKey:Ie.COUNT_VIDEO_TRACKS,metricValue:i});e.addValidatedMonitoringMetric({metricKey:Ie.COUNT_AUDIO_TRACKS,metricValue:n});if(e.currentMonitoringEventsObject.metrics[Ie.FRAMES_LOSS].length<e.countMetricsInMetricsInterval){var r=e.currentMonitoringEventsObject.metrics[Ie.FRAMES_RECEIVED];var u=e.currentMonitoringEventsObject.metrics[Ie.FRAMES_DROPPED];var d=r.slice(-1)[0];var h=u.slice(-1)[0];var p=!!d?h/d:0;e.addValidatedMonitoringMetric({additionalData:{currentFramesReceivedArray:r,currentFramesDroppedArray:u,currentFramesReceived:d,currentFramesDropped:h,currentFramesLoss:p},metricKey:Ie.FRAMES_LOSS,metricValue:p>0?a(p*100,0):0})}var v=e.calcBitrateSumFromArray({bitrateArray:o});var f=Number.parseFloat((v/1e6).toFixed(2));if(e.currentMonitoringEventsObject.metrics[Ie.BITRATE_IN].length<e.countMetricsInMetricsInterval){e.addValidatedMonitoringMetric({additionalData:{bitrateList:o,bitrateSumIn:v,formattedBitrateIn:f},metricKey:Ie.BITRATE_IN,metricValue:v})}if(e.currentMonitoringEventsObject.metrics[Ie.PACKET_LOST_RECEIVE].length<e.countMetricsInMetricsInterval){e.addValidatedMonitoringMetric({metricKey:Ie.PACKET_LOST_RECEIVE,metricValue:l})}if(l>babelHelpers.classPrivateFieldGet(e,He).packetLostThreshold){e.addMonitoringEvents({name:we.HIGH_PACKET_LOSS_RECEIVE,withCounter:true})}}));i.recipient=n;if(a.size||babelHelpers.classPrivateFieldGet(e,He).prevParticipantsWithLargeDataLoss.size){if(a.size){e.setLog("Have high packetsLost on users: ".concat(babelHelpers.toConsumableArray(a.values())),Se.WARNING)}e.triggerEvents("UpdatePacketLoss",[babelHelpers.toConsumableArray(a.keys())])}babelHelpers.classPrivateFieldGet(e,He).prevParticipantsWithLargeDataLoss=a}));case 7:e.triggerEvents("CallStatsReceived",[i]);a.next=12;break;case 10:a.prev=10;a.t0=a["catch"](0);case 12:case"end":return a.stop()}}),t,null,[[0,10]])})));return function e(){return t.apply(this,arguments)}}();i()["finally"]((function(){if(Yf.isMetricsEnabled()||Yf.isMetricsLogsEnabled()){e.startAggregateMonitoringEvents()}babelHelpers.classPrivateFieldGet(e,He).callStatsInterval=setInterval(babelHelpers.asyncToGenerator(ue().mark((function e(){return ue().wrap((function e(t){while(1)switch(t.prev=t.next){case 0:t.next=2;return i();case 2:case"end":return t.stop()}}),e)}))),babelHelpers.classPrivateFieldGet(e,He).statsTimeout)}))}function Pi(){if(this.sender){this.sender.close();this.sender=null}if(this.recipient){this.recipient.close();this.recipient=null}babelHelpers.classPrivateFieldGet(this,He).peerConnectionFailed=false}function _i(e){var t;var i=(t={},babelHelpers.defineProperty(t,ge.Camera,"cameraStream"),babelHelpers.defineProperty(t,ge.Microphone,"microphoneStream"),babelHelpers.defineProperty(t,ge.Screen,"screenStream"),babelHelpers.defineProperty(t,ge.ScreenAudio,"screenStream"),t);var n=i[e];if(n){var a,s,r;(a=babelHelpers.classPrivateFieldGet(this,He)[n])===null||a===void 0?void 0:(s=a.getTracks)===null||s===void 0?void 0:(r=s.call(a))===null||r===void 0?void 0:r.forEach((function(e){e.onended=null;e.stop()}));babelHelpers.classPrivateFieldGet(this,He)[n]=null;if(babelHelpers.classPrivateFieldGet(this,He).needToStopStreams){ae.stopStream(e)}}}function Ei(e){var t,i;var n=(t=this.sender)===null||t===void 0?void 0:(i=t.getSenders)===null||i===void 0?void 0:i.call(t);var a=null;if((n===null||n===void 0?void 0:n.length)>0){var s=se(n),r;try{for(s.s();!(r=s.n()).done;){var o;var l=r.value;if(((o=l.track)===null||o===void 0?void 0:o.source)===e){a=l;break}}}catch(e){s.e(e)}finally{s.f()}}return a}function Ri(e){var t;if(((t=babelHelpers.classPrivateFieldGet(this,He).socketConnect)===null||t===void 0?void 0:t.readyState)===1){babelHelpers.classPrivateFieldGet(this,He).socketConnect.send(JSON.stringify(e));return true}return false}function Mi(){var e=this,t;this.checkMetricsFeatureAndExecutionCallback((function(){e.sendMonitoringEvents(false)}));if(((t=babelHelpers.classPrivateFieldGet(this,He).socketConnect)===null||t===void 0?void 0:t.readyState)===1){ve(this,Rt,Ri).call(this,{leave:{reason:"CLIENT_INITIATED"}})}}var Ai=new WeakMap;var Li=function(){function e(t,i){babelHelpers.classCallCheck(this,e);he(this,Ai,{writable:true,value:void 0});babelHelpers.defineProperty(this,"name","");babelHelpers.defineProperty(this,"image","");babelHelpers.defineProperty(this,"userId","");babelHelpers.defineProperty(this,"videoEnabled",false);babelHelpers.defineProperty(this,"audioEnabled",false);babelHelpers.defineProperty(this,"screenSharingEnabled",false);babelHelpers.defineProperty(this,"isSpeaking",false);babelHelpers.defineProperty(this,"tracks",{});babelHelpers.defineProperty(this,"sid","");babelHelpers.defineProperty(this,"isMutedVideo",false);babelHelpers.defineProperty(this,"isMutedAudio",false);babelHelpers.defineProperty(this,"isHandRaised",false);babelHelpers.defineProperty(this,"videoPaused",false);babelHelpers.defineProperty(this,"isLocalVideoMute",false);babelHelpers.defineProperty(this,"streamRemovingId","");this.name=(t===null||t===void 0?void 0:t.name)||"";this.image=(t===null||t===void 0?void 0:t.image)||"";this.userId=(t===null||t===void 0?void 0:t.userId)||"";this.sid=(t===null||t===void 0?void 0:t.sid)||"";this.videoEnabled=(t===null||t===void 0?void 0:t.videoEnabled)||false;this.audioEnabled=(t===null||t===void 0?void 0:t.audioEnabled)||false;this.screenSharingEnabled=(t===null||t===void 0?void 0:t.screenSharingEnabled)||false;this.isSpeaking=(t===null||t===void 0?void 0:t.isSpeaking)||false;this.isHandRaised=(t===null||t===void 0?void 0:t.isHandRaised)||false;babelHelpers.classPrivateFieldSet(this,Ai,i)}babelHelpers.createClass(e,[{key:"subscribeTrack",value:function e(t){}},{key:"unsubscribeTrack",value:function e(t){}},{key:"attachTrack",value:function e(t){}},{key:"detachTrack",value:function e(t){}},{key:"disableAudio",value:function e(){this.tracks[ge.Microphone].track.enabled=false;this.isMutedAudio=true}},{key:"enableAudio",value:function e(){this.tracks[ge.Microphone].track.enabled=true;this.isMutedAudio=false}},{key:"disableVideo",value:function e(){this.tracks[ge.Camera].track.enabled=false;this.isMutedVideo=true}},{key:"enableVideo",value:function e(){this.tracks[ge.Camera].track.enabled=true;this.isMutedVideo=false}},{key:"addTrack",value:function e(t,i){this.tracks[t]=i}},{key:"removeTrack",value:function e(t,i){delete this.tracks[t]}},{key:"getTrack",value:function e(t){var i;return(i=this.tracks)===null||i===void 0?void 0:i[t]}},{key:"setStreamQuality",value:function e(t){var i;if(this.cameraStreamQuality===t||this.videoPaused){return}if((i=this.tracks)!==null&&i!==void 0&&i[ge.Camera]){this.cameraStreamQuality=t;var n=this.tracks[ge.Camera].id;this.tracks[ge.Camera].track.currentVideoQuality=t;var a={trackSetting:{trackSids:[n],quality:t}};babelHelpers.classPrivateFieldGet(this,Ai).send(JSON.stringify(a))}}}]);return e}();var Bi=function(){function e(t,i){babelHelpers.classCallCheck(this,e);this.serviceUrl=t;this.token=i;this.socket=null;this.attempt=0;this.reconnectTimeout=null;this.unsentMessages=[];this.onSocketOpenHandler=this.onSocketOpen.bind(this);this.onSocketCloseHandler=this.onSocketClose.bind(this);this.onSocketErrorHandler=this.onSocketError.bind(this);this.connect()}babelHelpers.createClass(e,[{key:"log",value:function e(t){if(typeof t!="string"){console.error("Message should be string");return}if(this.isConnected){this.socket.send(JSON.stringify({action:"log",message:t}))}else{this.unsentMessages.push(t)}}},{key:"sendStat",value:function e(t){if(babelHelpers["typeof"](t)=="object"){t=JSON.stringify(t)}if(this.isConnected){this.socket.send(JSON.stringify({action:"stat",message:t}))}}},{key:"connect",value:function e(){if(this.socket){return}if(!this.serviceUrl){console.error("Logging service url is empty");return}if(!this.serviceUrl.startsWith("ws://")&&!this.serviceUrl.startsWith("wss://")){console.error("Logging service url should start with ws:// or wss://");return}if(!this.token){console.error("Logging token is empty");return}this.attempt++;this.socket=new WebSocket(this.serviceUrl+"?token="+this.token);this.bindSocketEvents()}},{key:"scheduleReconnect",value:function e(){clearTimeout(this.reconnectTimeout);if(this.attempt>3){console.error("Could not connect to the logging service, giving up");return}this.reconnectTimeout=setTimeout(this.connect.bind(this),this.getConnectionDelay(this.attempt)*1e3)}},{key:"getConnectionDelay",value:function e(t){switch(t){case 0:case 1:return 15;case 2:return 30;default:return 60}}},{key:"disconnect",value:function e(){clearTimeout(this.reconnectTimeout);if(this.socket){this.removeSocketEvents();this.socket.close(1e3);this.socket=null}}},{key:"bindSocketEvents",value:function e(){this.socket.addEventListener("open",this.onSocketOpenHandler);this.socket.addEventListener("close",this.onSocketCloseHandler);this.socket.addEventListener("error",this.onSocketErrorHandler)}},{key:"removeSocketEvents",value:function e(){this.socket.removeEventListener("open",this.onSocketOpenHandler);this.socket.removeEventListener("close",this.onSocketCloseHandler);this.socket.removeEventListener("error",this.onSocketErrorHandler)}},{key:"onSocketOpen",value:function e(){this.attempt=0;for(var t=0;t<this.unsentMessages.length;t++){this.socket.send(JSON.stringify({action:"log",message:this.unsentMessages[t]}))}this.unsentMessages=[]}},{key:"onSocketClose",value:function e(){this.socket=null;this.scheduleReconnect()}},{key:"onSocketError",value:function e(){this.socket=null;this.scheduleReconnect()}},{key:"destroy",value:function e(){this.disconnect();this.unsentMessages=null}},{key:"isConnected",get:function e(){return this.socket&&this.socket.readyState===1}}]);return e}();var Di={Started:"started",Resumed:"resumed",Paused:"paused",Stopped:"stopped",Destroyed:"destroyed"};var Hi={None:"none",Video:"video",Audio:"audio"};var Ni=function(){function e(){babelHelpers.classCallCheck(this,e);this.serviceEnabled=false;this.tariffAvailable=false;this.isCisRegion=false;this.tariffSlider=false;if(p.Extension.getSettings("call.core").cloudRecord){this.setup(p.Extension.getSettings("call.core").cloudRecord)}}babelHelpers.createClass(e,[{key:"setup",value:function e(t){var i=t.serviceEnabled,n=t.tariffAvailable,a=t.isCisRegion,s=t.tariffSlider;if(i!==undefined){this.serviceEnabled=i}if(n!==undefined){this.tariffAvailable=n}if(a!==undefined){this.isCisRegion=a}if(s!==undefined){this.tariffSlider=s}}}]);return e}();var xi=new Ni;var Oi=function(){function e(t){var i=this;babelHelpers.classCallCheck(this,e);this.id=t.id;this.uuid=t.uuid;this.instanceId=t.instanceId;this.parentId=t.parentId||null;this.parentUuid=t.parentUuid||null;this.direction=t.direction;this.scheme=t.scheme;this.type=BX.prop.getInteger(t,"type",wc.Instant);this.state=BX.prop.getString(t,"state",kc.Idle);this.ready=false;this.userId=tu.getCurrentUserId();this.userData=p.Type.isPlainObject(t.userData)?t.userData:{};this.initiatorId=t.initiatorId||"";this.users=p.Type.isArray(t.users)?t.users.filter((function(e){return e!=i.userId})):[];this.associatedEntity=p.Type.isPlainObject(t.associatedEntity)?t.associatedEntity:{};this.startDate=new Date(BX.prop.getString(t,"startDate",""));this.videoEnabled=H.isCameraOn;this.videoHd=t.videoHd===true;this.cameraId=t.cameraId||"";this.microphoneId=t.microphoneId||"";this.muted=H.isMicrophoneMuted;this.wasConnected=false;this.logToken=t.logToken||"";if(tu.getLogService()&&this.logToken){this.logger=new Bi(tu.getLogService(),this.logToken)}this.localStreams={main:null,screen:null};this.eventListeners={};if(p.Type.isPlainObject(t.events)){this.initEventListeners(t.events)}this.connectionData=t.connectionData||{};this._microphoneLevel=0;this.commonRecordState={state:Di.Stopped,type:Hi.None,userId:0,date:{start:null,pause:[]}}}babelHelpers.createClass(e,[{key:"addDialogInfo",value:function e(t){this.associatedEntity=p.Type.isPlainObject(t)?t:{}}},{key:"initEventListeners",value:function e(t){for(var i in t){this.addEventListener(i,t[i])}}},{key:"addEventListener",value:function e(t,i){if(!p.Type.isArray(this.eventListeners[t])){this.eventListeners[t]=[]}if(p.Type.isArray(this.eventListeners[t])&&this.eventListeners[t].includes(i)){return}if(p.Type.isFunction(i)){this.eventListeners[t].push(i)}}},{key:"removeEventListener",value:function e(t,i){if(p.Type.isArray(this.eventListeners[t])&&this.eventListeners[t].indexOf(i)>=0){var n=this.eventListeners[t].indexOf(i);if(n>=0){this.eventListeners[t].splice(n,1)}}}},{key:"runCallback",value:function e(t,i){if(p.Type.isArray(this.eventListeners[t])&&this.eventListeners[t].length>0){if(t===null||babelHelpers["typeof"](i)!=="object"){i={}}i.call=this;for(var n=0;n<this.eventListeners[t].length;n++){try{this.eventListeners[t][n].call(this,i)}catch(e){console.error(t+" callback error: ",e);this.log(t+" callback error: ",e)}}}}},{key:"getLocalStream",value:function e(t){return this.localStreams[t]}},{key:"setLocalStream",value:function e(t,i){i=i||"main";this.localStreams[i]=t}},{key:"isAnyoneParticipating",value:function e(){throw new Error("isAnyoneParticipating should be implemented")}},{key:"__onPullEvent",value:function e(t,i){throw new Error("__onPullEvent should be implemented")}},{key:"inviteUsers",value:function e(){throw new Error("inviteUsers is not implemented")}},{key:"cancel",value:function e(){throw new Error("cancel is not implemented")}},{key:"answer",value:function e(){throw new Error("answer is not implemented")}},{key:"decline",value:function e(t,i){throw new Error("decline is not implemented")}},{key:"hangup",value:function e(){throw new Error("hangup is not implemented")}},{key:"log",value:function e(){var t=Yf.getLogMessage.apply(null,arguments);if(r.DesktopApi.isDesktop()){r.DesktopApi.writeToLogFile(BX.message("USER_ID")+".video.log",t.substr(3))}if(tu.debugFlag&&console){var i=["Call log ["+Yf.getTimeForLog()+"]: "];console.log.apply(this,i.concat(Array.prototype.slice.call(arguments)))}if(this.logger){this.logger.log(t)}if(BX.MessengerDebug){BX.MessengerDebug.addLog(this.id,t)}}},{key:"destroy",value:function e(){if(this.logger){this.logger.destroy();this.logger=null}this.state=kc.Finished;this.runCallback(Ac.onDestroy)}},{key:"updateCommonRecordState",value:function e(t){var i=t.action,n=t.type,a=t.senderId,s=t.date;var r=this.commonRecordState,o=r.state,l=r.userId;if(i!==Di.Started&&l!==a){return false}switch(i){case Di.Started:{if(!Yf.isCommonRecordStateInactive(o)){return false}Object.assign(this.commonRecordState,{state:Di.Started,type:n,userId:a,date:{start:s,pause:[]}});break}case Di.Paused:{if(o!==Di.Started){return false}this.commonRecordState.state=Di.Paused;this.commonRecordState.date.pause.push({start:s,finish:null});break}case Di.Resumed:{if(o!==Di.Paused){return false}this.commonRecordState.state=Di.Started;var c=babelHelpers.toConsumableArray(this.commonRecordState.date.pause).reverse().find((function(e){return e.finish===null}));if(c){c.finish=s}break}case Di.Stopped:{Object.assign(this.commonRecordState,{state:Di.Stopped,type:Hi.None,userId:0,date:{start:null,pause:[]}});break}default:{return false}}return true}},{key:"provider",get:function e(){throw new Error("must be overwritten")}},{key:"microphoneLevel",get:function e(){return this._microphoneLevel},set:function e(t){if(t!=this._microphoneLevel){this._microphoneLevel=t;this.runCallback(Ac.onMicrophoneLevel,{level:t})}}}]);return e}();function Ui(e){console.error("Playback start error: ",e);Yf.sendLog({description:"Playback start error",error:e})}function Fi(e){return decodeURI(e)===e?encodeURI(e):e}var Vi=function(){function e(t){babelHelpers.classCallCheck(this,e);this.data={id:BX.prop.getInteger(t,"id",0),name:BX.prop.getString(t,"name",""),avatar:Fi(BX.prop.getString(t,"avatar","")),gender:BX.prop.getString(t,"gender",""),state:BX.prop.getString(t,"state",yc.Idle),talking:BX.prop.getBoolean(t,"talking",false),cameraState:BX.prop.getBoolean(t,"cameraState",true),prevCameraState:BX.prop.getBoolean(t,"cameraState",true),microphoneState:BX.prop.getBoolean(t,"microphoneState",true),screenState:BX.prop.getBoolean(t,"screenState",false),videoPaused:BX.prop.getBoolean(t,"videoPaused",false),floorRequestState:BX.prop.getBoolean(t,"floorRequestState",false),permissionToSpeak:BX.prop.getBoolean(t,"permissionToSpeak",false),localUser:BX.prop.getBoolean(t,"localUser",false),centralUser:BX.prop.getBoolean(t,"centralUser",false),pinned:BX.prop.getBoolean(t,"pinned",false),presenter:BX.prop.getBoolean(t,"presenter",false),order:BX.prop.getInteger(t,"order",false),prevOrder:BX.prop.getInteger(t,"prevOrder",false),allowRename:BX.prop.getBoolean(t,"allowRename",false),wasRenamed:BX.prop.getBoolean(t,"wasRenamed",false),renameRequested:BX.prop.getBoolean(t,"renameRequested",false),direction:BX.prop.getString(t,"direction",Sc.SendRecv)};for(var i in this.data){if(this.data.hasOwnProperty(i)){Object.defineProperty(this,i,{get:this._getField(i).bind(this),set:this._setField(i).bind(this)})}}this.onUpdate={talking:this._onUpdateTalking.bind(this),state:this._onUpdateState.bind(this)};this.talkingStop=null;this.eventEmitter=new f.EventEmitter(this,"UserModel")}babelHelpers.createClass(e,[{key:"_getField",value:function e(t){return function(){return this.data[t]}}},{key:"_setField",value:function e(t){return function(e){var i=this.data[t];if(i==e){return}this.data[t]=e;if(this.onUpdate.hasOwnProperty(t)){this.onUpdate[t](e,i)}this.eventEmitter.emit("changed",{user:this,fieldName:t,oldValue:i,newValue:e})}}},{key:"_onUpdateTalking",value:function e(t){if(!t){this.talkingStop=(new Date).getTime()}}},{key:"_onUpdateState",value:function e(t){if(t!=yc.Connected){this.talking=false;this.screenState=false}}},{key:"wasTalkingAgo",value:function e(){if(this.state!=yc.Connected){return+Infinity}if(this.talking){return 0}if(!this.talkingStop){return+Infinity}return(new Date).getTime()-this.talkingStop}},{key:"subscribe",value:function e(t,i){this.eventEmitter.subscribe(t,i)}},{key:"unsubscribe",value:function e(t,i){this.eventEmitter.unsubscribe(t,i)}}]);return e}();var Gi=function(e){babelHelpers.inherits(t,e);function t(){var e;babelHelpers.classCallCheck(this,t);e=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this));e.setEventNamespace("BX.Call.UserRegistry");e.users=new Map;return e}babelHelpers.createClass(t,[{key:"get",value:function e(t){return this.users.get(Number(t))||null}},{key:"push",value:function e(t){if(!(t instanceof Vi)){throw Error("user should be instance of UserModel")}this.users.set(Number(t.id),t);t.subscribe("changed",this._onUserChanged.bind(this));this.emit("userAdded",{user:t})}},{key:"_onUserChanged",value:function e(t){if(t.data.fieldName==="order"){this._sort()}this.emit("userChanged",t.data)}},{key:"_sort",value:function e(){this.users=new Map(babelHelpers.toConsumableArray(this.users).sort((function(e,t){return e[1].order-t[1].order})))}}]);return t}(f.EventEmitter);function Wi(e,t){var i=document.createElementNS("http://www.w3.org/2000/svg",e);if("attrNS"in t&&p.Type.isObject(t.attrNS)){for(var n in t.attrNS){if(t.attrNS.hasOwnProperty(n)){i.setAttributeNS(null,n,t.attrNS[n])}}}p.Dom.adjust(i,t);return i}var Xi=function e(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};var i=t.width,n=i===void 0?"max-content":i,a=t.position,s=a===void 0?"top":a,r=t.getText,o=r===void 0?function(){return""}:r;var l=Boolean(Object.keys(t).length);var c=o();var u=s==="bottom"?"-bottom":"-top";var d="bx-videocall-tooltip ".concat(u);var h="--data-tooltip-text";return{hasTooltip:l,tooltipClass:l?d:"",tooltipText:c,tooltipStyle:"--data-tooltip-width:".concat(n,"; ").concat(h,":'").concat(c,"'"),getTooltipText:o,tooltipTextVarName:h}};var zi=function(){function e(t){babelHelpers.classCallCheck(this,e);this.elements={root:null};this.text=p.Type.isStringFilled(t.text)?t.text:"";this.isGroupCall=t.isGroupCall}babelHelpers.createClass(e,[{key:"render",value:function e(){this.elements.root=p.Dom.create("div",{props:{className:"bx-messenger-videocall-panel-title"},html:this.getTitle()});return this.elements.root}},{key:"getTitle",value:function e(){var t='<span class="bx-messenger-videocall-panel-title-name">'+p.Text.encode(this.text)+"</span>";if(this.isGroupCall){return BX.message("IM_M_GROUP_CALL_WITH").replace("#CHAT_NAME#",t)}else{return BX.message("IM_M_CALL_WITH").replace("#USER_NAME#",t)}}},{key:"update",value:function e(t){this.text=p.Type.isStringFilled(t.text)?t.text:"";this.isGroupCall=t.isGroupCall;this.elements.root.innerHTML=this.getTitle()}}]);return e}();var ji=function(){function e(t){babelHelpers.classCallCheck(this,e);this["class"]=t["class"];this.backgroundClass=BX.prop.getString(t,"backgroundClass","");this.backgroundClass="bx-messenger-videocall-panel-icon-background"+(this.backgroundClass?" ":"")+this.backgroundClass;this.blocked=t.blocked===true;this.tooltip=Xi(BX.prop.getObject(t,"tooltip",{}));this.text=BX.prop.getString(t,"text","");this.isActive=false;this.counter=BX.prop.getInteger(t,"counter",0);this.isComingSoon=t.isComingSoon||false;this.elements={root:null,counter:null,comingSoon:null};this.callbacks={onClick:BX.prop.getFunction(t,"onClick",BX.DoNothing)}}babelHelpers.createClass(e,[{key:"render",value:function e(){if(this.elements.root){return this.elements.root}var t;if(this.text!==""){t=p.Dom.create("div",{props:{className:"bx-messenger-videocall-panel-text"},text:this.text,children:[p.Dom.create("div",{props:{className:"bx-messenger-videocall-panel-text-content"},text:this.text})]})}else{t=null}var i=this.tooltip,n=i.tooltipClass,a=i.tooltipStyle;this.elements.root=p.Dom.create("div",{props:{className:"bx-messenger-videocall-panel-item ".concat(n).concat(this.blocked?" blocked":"").concat(this.isComingSoon?" coming-soon":"")},attrs:{style:a},children:[p.Dom.create("div",{props:{className:this.backgroundClass},children:[p.Dom.create("div",{props:{className:"bx-messenger-videocall-panel-icon bx-messenger-videocall-panel-icon-".concat(this["class"])}}),this.elements.counter=p.Dom.create("span",{props:{className:"bx-messenger-videocall-panel-item-counter"},text:0,dataset:{counter:0,counterType:"digits"}}),this.elements.comingSoon=p.Dom.create("span",{props:{className:"bx-messenger-videocall-panel-item-coming-soon"},text:BX.message("CALL_FEATURES_COMING_SOON_MSGVER_1"),dataset:{visible:this.isComingSoon?"Y":"N"}})]}),t],events:{click:this.callbacks.onClick}});if(this.isActive){this.elements.root.classList.add("active")}return this.elements.root}},{key:"setActive",value:function e(t){if(this.isActive==t){return}this.isActive=t;if(!this.elements.root){return}if(this.isActive){this.elements.root.classList.add("active")}else{this.elements.root.classList.remove("active")}var i=this.tooltip,n=i.hasTooltip,a=i.getTooltipText,s=i.tooltipTextVarName;n&&this.elements.root.style.setProperty(s,"'".concat(a(),"'"))}},{key:"setBlocked",value:function e(t){if(this.blocked==t){return}this.blocked=t;if(this.blocked){this.elements.root.classList.add("blocked")}else{this.elements.root.classList.remove("blocked")}}},{key:"setCounter",value:function e(t){this.counter=parseInt(t,10);if(Number.isNaN(this.counter)){this.counter=0;this.elements.counter.dataset.counter=0;this.elements.counter.dataset.counterType="digits";this.elements.counter.innerText=0;return}var i=this.counter;var n=i;if(i>99){i="99+"}var a="digits";if(i.toString().length===2){a="dozens"}else if(i.toString().length>2){a="hundreds"}this.elements.counter.dataset.counter=n;this.elements.counter.dataset.counterType=a;this.elements.counter.innerText=i}},{key:"setIsComingSoon",value:function e(t){this.isComingSoon=t;this.isComingSoon?this.elements.comingSoon.dataset.visible="Y":this.elements.comingSoon.dataset.visible="N";if(this.isComingSoon){var i;(i=this.elements.root)===null||i===void 0?void 0:i.classList.add("coming-soon")}else{var n;(n=this.elements.root)===null||n===void 0?void 0:n.classList.remove("coming-soon")}}}]);return e}();var qi=function(){function e(t){babelHelpers.classCallCheck(this,e);this["class"]=t["class"];this.text=t.text;this.enabled=t.enabled===true;this.arrowEnabled=t.arrowEnabled===true;this.arrowHidden=t.arrowHidden===true;this.blocked=t.blocked===true;this.tooltip=Xi(BX.prop.getObject(t,"tooltip",{}));this.backgroundClass=BX.prop.getString(t,"backgroundClass","");this.showLevel=t.showLevel===true;this.level=t.level||0;this.sideIcon=BX.prop.getString(t,"sideIcon","");this.elements={root:null,iconContainer:null,icon:null,arrow:null,levelMeter:null,pointer:null,ellipsis:null};this.callbacks={onClick:BX.prop.getFunction(t,"onClick",BX.DoNothing),onArrowClick:BX.prop.getFunction(t,"onArrowClick",BX.DoNothing),onSideIconClick:BX.prop.getFunction(t,"onSideIconClick",BX.DoNothing)}}babelHelpers.createClass(e,[{key:"render",value:function e(){if(this.elements.root){return this.elements.root}var t=this.tooltip,i=t.tooltipClass,n=t.tooltipStyle;this.elements.arrow=p.Dom.create("div",{props:{className:"bx-messenger-videocall-panel-item-with-arrow-right"},children:[p.Dom.create("div",{props:{className:"bx-messenger-videocall-panel-item-with-arrow-right-icon"}})],events:{click:function(e){var t;(t=this.elements.arrow)===null||t===void 0?void 0:t.classList.add("rotate");this.callbacks.onArrowClick.apply(this,arguments);e.stopPropagation()}.bind(this)}});this.elements.root=p.Dom.create("div",{props:{id:"bx-messenger-videocall-panel-item-with-arrow-".concat(this["class"]),className:"bx-messenger-videocall-panel-item-with-arrow ".concat(i).concat(this.blocked?" blocked":"")},attrs:{style:n},children:[p.Dom.create("div",{props:{className:"bx-messenger-videocall-panel-item-with-arrow-left"},children:[this.elements.iconContainer=p.Dom.create("div",{props:{className:this.getIconContainerClass()},children:[this.elements.icon=p.Dom.create("div",{props:{className:this.getIconClass()}})]})].concat(babelHelpers.toConsumableArray(this.arrowHidden?[]:[this.elements.arrow]))}),p.Dom.create("div",{props:{className:"bx-messenger-videocall-panel-text"},text:this.text,children:[p.Dom.create("div",{props:{className:"bx-messenger-videocall-panel-text-content"},text:this.text})]})],events:{click:this.callbacks.onClick}});if(this.showLevel){this.elements.icon.appendChild(Wi("svg",{attrNS:{class:"bx-messenger-videocall-panel-item-level-meter-container",width:"28",height:"28",viewBox:"0 0 28 28",fill:"none"},children:[Wi("defs",{children:[Wi("linearGradient",{attrNS:{id:"volumeGradient",x1:"0%",y1:"100%",x2:"0%",y2:"0%"},children:[this.elements.gradientStop1=Wi("stop",{attrNS:{offset:"0",id:"gradientStop1"}}),this.elements.gradientStop2=Wi("stop",{attrNS:{offset:"0","stop-color":"transparent",id:"gradientStop2"}})]})]}),Wi("path",{attrNS:{"fill-rule":"evenodd","clip-rule":"evenodd",d:"M7.01843 12.8394C7.46936 12.8492 7.82709 13.2234 7.81726 13.6743C7.76065 16.2837 9.9066 19.8267 13.9882 19.8267C18.0865 19.8265 20.3038 16.2334 20.1805 13.6987C20.1586 13.2483 20.5056 12.8654 20.9559 12.8433C21.4064 12.8213 21.7894 13.1682 21.8114 13.6187C21.9638 16.7444 19.4696 20.9702 14.8124 21.4204V23.1763H16.7714C17.2222 23.1765 17.5878 23.5427 17.5878 23.9937C17.5875 24.4443 17.2221 24.8099 16.7714 24.8101H11.2206C10.7699 24.8098 10.4044 24.4443 10.4042 23.9937C10.4042 23.5428 10.7698 23.1765 11.2206 23.1763H13.1796V21.4224C8.50848 20.9829 6.11622 16.768 6.18445 13.6382C6.1943 13.1874 6.56769 12.8297 7.01843 12.8394ZM13.9921 3.30518C16.1622 3.30518 17.9218 5.06469 17.9218 7.23486V13.5396C17.9218 15.7097 16.1622 17.4692 13.9921 17.4692C11.8221 17.469 10.0634 15.7096 10.0634 13.5396V7.23486C10.0634 5.06481 11.8221 3.30537 13.9921 3.30518ZM13.9921 4.93896C12.7241 4.93916 11.6962 5.96687 11.6962 7.23486V13.5396C11.6962 14.8075 12.7241 15.8353 13.9921 15.8354C15.2602 15.8354 16.2889 14.8077 16.2889 13.5396V7.23486C16.2889 5.96676 15.2602 4.93896 13.9921 4.93896Z",fill:"url(#volumeGradient)"}})]}))}this.elements.ellipsis=p.Dom.create("div",{props:{className:"bx-messenger-videocall-panel-icon-ellipsis"},events:{click:this.callbacks.onSideIconClick}});this.elements.pointer=p.Dom.create("div",{props:{className:"bx-messenger-videocall-panel-icon-pointer"},events:{click:this.callbacks.onSideIconClick}});if(this.sideIcon=="pointer"){BX.Dom.insertAfter(this.elements.pointer,this.elements.icon)}else if(this.sideIcon=="ellipsis"){BX.Dom.insertAfter(this.elements.ellipsis,this.elements.icon)}return this.elements.root}},{key:"getIconClass",value:function e(){return"bx-messenger-videocall-panel-item-with-arrow-icon bx-messenger-videocall-panel-item-with-arrow-icon-"+this["class"]+(this.enabled?"":"-off")}},{key:"getIconContainerClass",value:function e(){return"bx-messenger-videocall-panel-item-with-arrow-icon-container"+" bx-messenger-videocall-panel-item-with-arrow-icon-container-"+this["class"]+(this.enabled?"":"-off")+(this.arrowHidden?" bx-messenger-videocall-panel-item-with-arrow-icon-container-arrow-hidden":"")+(this.backgroundClass?" ".concat(this.backgroundClass):"")}},{key:"enable",value:function e(){if(this.enabled){return}this.enabled=true;this.elements.iconContainer.className=this.getIconContainerClass();this.elements.icon.className=this.getIconClass();if(this.elements.gradientStop1&&this.elements.gradientStop2){this.elements.gradientStop1.setAttribute("offset","0%");this.elements.gradientStop2.setAttribute("offset","0%")}else if(this.elements.levelMeter){this.elements.levelMeter.setAttribute("y",Math.round((1-this.level)*20))}var t=this.tooltip,i=t.hasTooltip,n=t.getTooltipText,a=t.tooltipTextVarName;i&&this.elements.root.style.setProperty(a,"'".concat(n(),"'"))}},{key:"disable",value:function e(){if(!this.enabled){return}this.enabled=false;this.elements.iconContainer.className=this.getIconContainerClass();this.elements.icon.className=this.getIconClass();if(this.elements.gradientStop1&&this.elements.gradientStop2){this.elements.gradientStop1.setAttribute("offset","0%");this.elements.gradientStop2.setAttribute("offset","0%")}else if(this.elements.levelMeter){this.elements.levelMeter.setAttribute("y",Math.round((1-this.level)*20))}var t=this.tooltip,i=t.hasTooltip,n=t.getTooltipText,a=t.tooltipTextVarName;i&&this.elements.root.style.setProperty(a,"'".concat(n(),"'"))}},{key:"setBlocked",value:function e(t){if(this.blocked==t){return}this.blocked=t;this.elements.iconContainer.className=this.getIconContainerClass();this.elements.icon.className=this.getIconClass();if(this.blocked){this.elements.root.classList.add("blocked")}else{this.elements.root.classList.remove("blocked")}}},{key:"setSideIcon",value:function e(t){if(this.sideIcon==t){return}this.sideIcon=t;BX.Dom.remove(this.elements.pointer);BX.Dom.remove(this.elements.ellipsis);if(this.sideIcon=="pointer"){BX.Dom.insertAfter(this.elements.pointer,this.elements.icon)}else if(this.sideIcon=="ellipsis"){BX.Dom.insertAfter(this.elements.ellipsis,this.elements.icon)}}},{key:"showArrow",value:function e(){if(!this.arrowHidden){return}this.arrowHidden=false;this.elements.iconContainer.className=this.getIconContainerClass();if(!this.elements.root.querySelector(".bx-messenger-videocall-panel-item-with-arrow-right-icon")){this.elements.root.children[0].appendChild(this.elements.arrow)}}},{key:"hideArrow",value:function e(){if(this.arrowHidden){return}this.arrowHidden=true;this.elements.iconContainer.className=this.getIconContainerClass();if(this.elements.root.querySelector(".bx-messenger-videocall-panel-item-with-arrow-right-icon")){this.elements.root.children[0].removeChild(this.elements.arrow)}}},{key:"setLevel",value:function e(t){this.level=Math.log(t*100)/4.6;if(this.showLevel&&this.enabled){var i="".concat(100-Math.round((1-this.level)*100),"%");this.elements.gradientStop1.setAttribute("offset",i);this.elements.gradientStop2.setAttribute("offset",i)}}}]);return e}();var Yi=function(){function e(t){babelHelpers.classCallCheck(this,e);this.language=t.language;this.elements={root:null}}babelHelpers.createClass(e,[{key:"render",value:function e(){if(this.elements.root){return this.elements.root}this.elements.root=p.Dom.create("div",{props:{className:"bx-messenger-videocall-watermark"},children:[p.Dom.create("img",{props:{className:"bx-messenger-videocall-watermark-img",src:this.getWatermarkUrl(this.language)}})]});return this.elements.root}},{key:"getWatermarkUrl",value:function e(t){switch(t){case"ru":case"kz":case"by":return"/bitrix/js/call/images/new-logo-white-ru.svg";default:return"/bitrix/js/call/images/new-logo-white-en.svg"}}}]);return e}();var Qi=function(){function e(t){babelHelpers.classCallCheck(this,e);this.iconClass=BX.prop.getString(t,"iconClass","");this.text=BX.prop.getString(t,"text","");this.elements={root:null,icon:null,text:null};this.tooltip=Xi(BX.prop.getObject(t,"tooltip",{}));this.callbacks={onClick:BX.prop.getFunction(t,"onClick",BX.DoNothing)}}babelHelpers.createClass(e,[{key:"render",value:function e(){if(this.elements.root){return this.elements.root}var t=this.tooltip,i=t.tooltipClass,n=t.tooltipStyle;this.elements.root=p.Dom.create("div",{props:{className:"bx-messenger-videocall-top-button ".concat(i)},attrs:{style:n},children:[this.elements.icon=p.Dom.create("div",{props:{className:"bx-messenger-videocall-top-button-icon ".concat(this.iconClass)}}),this.elements.text=p.Dom.create("div",{props:{className:"bx-messenger-videocall-top-button-text ".concat(this.iconClass)},text:this.text})],events:{click:this.callbacks.onClick}});return this.elements.root}},{key:"update",value:function e(t){var i=BX.prop.getString(t,"iconClass",this.iconClass);var n=BX.prop.getString(t,"text",this.text);if(this.iconClass!==i){this.iconClass=i;this.elements.icon.className="bx-messenger-videocall-top-button-icon ".concat(this.iconClass)}if(this.text!==n){this.text=n;this.elements.text.innerText=this.text;this.elements.text.className="bx-messenger-videocall-top-button-text ".concat(this.iconClass)}}}]);return e}();var Ji=function(){function e(t){babelHelpers.classCallCheck(this,e);this.iconClass=BX.prop.getString(t,"iconClass","");this.textClass=BX.prop.getString(t,"textClass","");this.text=BX.prop.getString(t,"text","");this.tooltip=Xi(BX.prop.getObject(t,"tooltip",{}));this.elements={root:null};this.callbacks={onClick:BX.prop.getFunction(t,"onClick",BX.DoNothing)}}babelHelpers.createClass(e,[{key:"render",value:function e(){if(this.elements.root){return this.elements.root}var t=this.tooltip,i=t.tooltipClass,n=t.tooltipStyle;this.elements.root=p.Dom.create("div",{props:{className:"bx-messenger-videocall-top-button-frameless ".concat(i)},attrs:{style:n},children:[p.Dom.create("div",{props:{className:"bx-messenger-videocall-top-button-icon ".concat(this.iconClass)}}),this.text===""?null:p.Dom.create("div",{props:{className:"bx-messenger-videocall-top-button-text ".concat(this.textClass)},text:this.text})],events:{click:this.callbacks.onClick}});return this.elements.root}}]);return e}();var Ki=function(){function e(t){babelHelpers.classCallCheck(this,e);this.count=BX.prop.getInteger(t,"count",0);this.foldButtonState=BX.prop.getString(t,"foldButtonState",e.FoldButtonState.Hidden);this.allowAdding=BX.prop.getBoolean(t,"allowAdding",false);this.elements={root:null,leftContainer:null,rightContainer:null,foldIcon:null,count:null,separator:null};this.callbacks={onListClick:BX.prop.getFunction(t,"onListClick",BX.DoNothing),onAddClick:BX.prop.getFunction(t,"onAddClick",BX.DoNothing)}}babelHelpers.createClass(e,[{key:"render",value:function t(){if(this.elements.root){return this.elements.root}this.elements.root=p.Dom.create("div",{props:{className:"bx-messenger-videocall-top-participants"},children:[this.elements.leftContainer=p.Dom.create("div",{props:{className:"bx-messenger-videocall-top-participants-inner left"+(this.foldButtonState!=e.FoldButtonState.Hidden?" active":"")},children:[p.Dom.create("div",{props:{className:"bx-messenger-videocall-top-button-icon participants"}}),this.elements.count=p.Dom.create("div",{props:{className:"bx-messenger-videocall-top-participants-text-count"},text:this.count}),this.elements.foldIcon=p.Dom.create("div",{props:{className:"bx-messenger-videocall-top-participants-fold-icon "+this.foldButtonState}})],events:{click:this.callbacks.onListClick}})]});this.elements.separator=p.Dom.create("div",{props:{className:"bx-messenger-videocall-top-participants-separator"}});this.elements.rightContainer=p.Dom.create("div",{props:{className:"bx-messenger-videocall-top-participants-inner active"},children:[p.Dom.create("div",{props:{className:"bx-messenger-videocall-top-participants-text"},text:BX.message("IM_M_CALL_BTN_ADD")}),p.Dom.create("div",{props:{className:"bx-messenger-videocall-top-button-icon add"}})],events:{click:this.callbacks.onAddClick}});if(this.allowAdding){this.elements.root.appendChild(this.elements.separator);this.elements.root.appendChild(this.elements.rightContainer)}return this.elements.root}},{key:"update",value:function t(i){this.count=BX.prop.getInteger(i,"count",this.count);this.foldButtonState=BX.prop.getString(i,"foldButtonState",this.foldButtonState);this.allowAdding=BX.prop.getBoolean(i,"allowAdding",this.allowAdding);this.elements.count.innerText=this.count;this.elements.foldIcon.className="bx-messenger-videocall-top-participants-fold-icon "+this.foldButtonState;if(this.foldButtonState==e.FoldButtonState.Hidden){this.elements.leftContainer.classList.remove("active")}else{this.elements.leftContainer.classList.add("active")}if(this.allowAdding&&!this.elements.separator.parentElement){this.elements.root.appendChild(this.elements.separator);this.elements.root.appendChild(this.elements.rightContainer)}if(!this.allowAdding&&this.elements.separator.parentElement){BX.remove(this.elements.separator);BX.remove(this.elements.rightContainer)}}}]);return e}();babelHelpers.defineProperty(Ki,"FoldButtonState",{Active:"active",Fold:"fold",Unfold:"unfold",Hidden:"hidden"});var Zi=function(){function e(t){babelHelpers.classCallCheck(this,e);this.count=BX.prop.getInteger(t,"count",0);this.elements={root:null,icon:null,text:null,arrow:null};this.callbacks={onClick:BX.prop.getFunction(t,"onClick",BX.DoNothing)}}babelHelpers.createClass(e,[{key:"render",value:function e(){if(this.elements.root){return this.elements.root}this.elements.root=p.Dom.create("div",{props:{className:"bx-messenger-videocall-top-participants-mobile"},children:[this.elements.icon=p.Dom.create("div",{props:{className:"bx-messenger-videocall-top-participants-mobile-icon"}}),this.elements.text=p.Dom.create("div",{props:{className:"bx-messenger-videocall-top-participants-mobile-text"},text:BX.message("IM_M_CALL_PARTICIPANTS").replace("#COUNT#",this.count)}),this.elements.arrow=p.Dom.create("div",{props:{className:"bx-messenger-videocall-top-participants-mobile-arrow"}})],events:{click:this.callbacks.onClick}});return this.elements.root}},{key:"setCount",value:function e(t){if(this.count==t||!this.elements.text){return}this.count=t;this.elements.text.innerText=BX.message("IM_M_CALL_PARTICIPANTS").replace("#COUNT#",this.count)}}]);return e}();var $i=function(){function e(t){babelHelpers.classCallCheck(this,e);this.userId=t.userId;this.commonRecordState=t.commonRecordState;this.updateViewInterval=null;this.tooltip=Xi(BX.prop.getObject(t,"tooltip",{}));this.elements={root:null,timeText:null,stateText:null}}babelHelpers.createClass(e,[{key:"render",value:function e(){if(this.elements.root){return this.elements.root}var t=this.tooltip.tooltipStyle;this.elements.root=p.Dom.create("div",{props:{className:"bx-messenger-videocall-top-recordstatus record-status-".concat(this.commonRecordState.state)},attrs:{style:t},children:[p.Dom.create("div",{props:{className:"bx-messenger-videocall-top-recordstatus-status"},children:[p.Dom.create("div",{props:{className:"bx-messenger-videocall-top-button-icon record-status"}})]}),p.Dom.create("div",{props:{className:"bx-messenger-videocall-top-recordstatus-time"},children:[this.elements.timeText=p.Dom.create("span",{props:{className:"bx-messenger-videocall-top-recordstatus-time-text"},text:Yf.getRecordTimeText(this.commonRecordState)})]})]});return this.elements.root}},{key:"update",value:function e(t){var i,n=this;var a=(i=this.commonRecordState)===null||i===void 0?void 0:i.state;if(a!==t.state){clearInterval(this.updateViewInterval);this.updateViewInterval=null;if(t.state===Di.Started){this.updateViewInterval=setInterval((function(){return n.updateView()}),1e3)}}this.commonRecordState=t;this.updateView()}},{key:"updateView",value:function e(){var t=Yf.getRecordTimeText(this.commonRecordState);if(this.elements.timeText.innerText!==t){this.elements.timeText.innerText=t}var i="record-status-".concat(this.commonRecordState.state);if(!this.elements.root.classList.contains(i)){var n=this.tooltip,a=n.tooltipClass,s=n.hasTooltip,r=n.tooltipTextVarName,o=n.getTooltipText;var l=o();if(s&&l){this.elements.root.style.setProperty(r,"'".concat(l,"'"))}var c=[l?a:"","bx-messenger-videocall-top-recordstatus",i].filter(Boolean);this.elements.root.className=c.join(" ")}}},{key:"stopViewUpdate",value:function e(){if(this.updateViewInterval){clearInterval(this.updateViewInterval);this.updateViewInterval=null}}}]);return e}();var en=function(){function e(t){babelHelpers.classCallCheck(this,e);this.userModel=t.userModel;this.elements={root:null,avatar:null,avatarOutline:null,userName:null,userStatus:null,menuArrow:null,floorRequest:null,mic:null,cam:null};this._onUserFieldChangeHandler=this._onUserFieldChange.bind(this);this.userModel.subscribe("changed",this._onUserFieldChangeHandler);this.callbacks={onClick:BX.prop.getFunction(t,"onClick",BX.DoNothing)};this.avatarBackground=Yf.getAvatarBackground()}babelHelpers.createClass(e,[{key:"render",value:function e(){if(this.elements.root){return this.elements.root}this.elements.root=p.Dom.create("div",{props:{className:"bx-messenger-videocall-user-mobile"},children:[this.elements.avatar=p.Dom.create("div",{props:{className:"bx-messenger-videocall-user-mobile-avatar"+(this.userModel.talking?" talking":"")},children:[this.elements.floorRequest=p.Dom.create("div",{props:{className:"bx-messenger-videocall-user-mobile-floor-request bx-messenger-videocall-floor-request-icon"}})]}),p.Dom.create("div",{props:{className:"bx-messenger-videocall-user-mobile-body"},children:[p.Dom.create("div",{props:{className:"bx-messenger-videocall-user-mobile-text"},children:[this.elements.mic=p.Dom.create("div",{props:{className:"bx-messenger-videocall-user-mobile-icon"+(this.userModel.microphoneState?"":" bx-call-view-icon-red-microphone-off")}}),this.elements.cam=p.Dom.create("div",{props:{className:"bx-messenger-videocall-user-mobile-icon"+(this.userModel.cameraState?"":" bx-call-view-icon-red-camera-off")}}),this.elements.userName=p.Dom.create("div",{props:{className:"bx-messenger-videocall-user-mobile-username"},text:this.userModel.name}),p.Dom.create("div",{props:{className:"bx-messenger-videocall-user-mobile-menu-arrow"}})]}),this.elements.userStatus=p.Dom.create("div",{props:{className:"bx-messenger-videocall-user-mobile-user-status"},text:this.userModel.pinned?BX.message("IM_M_CALL_PINNED_USER"):BX.message("IM_M_CALL_CURRENT_PRESENTER")})]})],events:{click:this.callbacks.onClick}});return this.elements.root}},{key:"update",value:function e(){if(!this.elements.root){return}this.elements.userName.innerText=this.userModel.name;if(this.userModel.avatar!==""){this.elements.root.style.setProperty("--avatar","url('"+this.userModel.avatar+"')");this.elements.avatar.innerText="";this.elements.root.style.removeProperty("--avatar-background")}else{this.elements.root.style.removeProperty("--avatar");this.elements.root.style.setProperty("--avatar-background",this.avatarBackground);this.elements.avatar.innerText=u.Utils.text.getFirstLetters(this.userModel.name).toUpperCase()}this.elements.avatar.classList.toggle("talking",this.userModel.talking);this.elements.floorRequest.classList.toggle("active",this.userModel.floorRequestState);this.elements.mic.classList.toggle("bx-call-view-icon-red-microphone-off",!this.userModel.microphoneState);this.elements.cam.classList.toggle("bx-call-view-icon-red-camera-off",!this.userModel.cameraState);this.elements.userStatus.innerText=this.userModel.pinned?BX.message("IM_M_CALL_PINNED_USER"):BX.message("IM_M_CALL_CURRENT_PRESENTER")}},{key:"mount",value:function e(t){t.appendChild(this.render())}},{key:"dismount",value:function e(){if(!this.elements.root){return}p.Dom.remove(this.elements.root)}},{key:"setUserModel",value:function e(t){this.userModel.unsubscribe("changed",this._onUserFieldChangeHandler);this.userModel=t;this.userModel.subscribe("changed",this._onUserFieldChangeHandler);this.update()}},{key:"_onUserFieldChange",value:function e(t){this.update()}}]);return e}();var tn=function(){function e(t){babelHelpers.classCallCheck(this,e);this.userRegistry=t.userRegistry;this.userRegistry.subscribe("userAdded",this._onUserAdded.bind(this));this.userRegistry.subscribe("userChanged",this._onUserChanged.bind(this));this.elements={root:null,users:{}}}babelHelpers.createClass(e,[{key:"render",value:function e(){if(this.elements.root){return this.elements.root}this.elements.root=p.Dom.create("div",{props:{className:"bx-messenger-videocall-user-selector-mobile"}});this.updateUsers();return this.elements.root}},{key:"renderUser",value:function e(t){return Wi("svg",{attrNS:{width:14.5,height:11.6},style:{order:t.order},children:[Wi("circle",{attrNS:{class:"bx-messenger-videocall-user-selector-mobile-border"+(t.talking?" talking":""),cx:7.25,cy:5.8,r:4.6}}),Wi("circle",{attrNS:{class:"bx-messenger-videocall-user-selector-mobile-dot"+(t.centralUser?" pinned":""),cx:7.25,cy:5.8,r:3.3}})]})}},{key:"updateUsers",value:function e(){this.userRegistry.users.forEach((function(e){if(e.localUser||e.state!=yc.Connected){if(this.elements.users[e.id]){BX.remove(this.elements.users[e.id]);this.elements.users[e.id]=null}}else{var t=this.renderUser(e);if(this.elements.users[e.id]){BX.replace(this.elements.users[e.id],t)}else{this.elements.root.appendChild(t)}this.elements.users[e.id]=t}}),this)}},{key:"_onUserAdded",value:function e(t){this.updateUsers()}},{key:"_onUserChanged",value:function e(t){this.updateUsers()}},{key:"mount",value:function e(t){t.appendChild(this.render())}},{key:"dismount",value:function e(){if(!this.elements.root){return}BX.remove(this.elements.root)}}]);return e}();var nn=function(){function e(t){babelHelpers.classCallCheck(this,e);this.parent=t.parent||null;this.content=t.content||null;this.elements={background:null,root:null,handle:null,body:null};this.callbacks={onClose:BX.prop.getFunction(t,"onClose",BX.DoNothing),onDestroy:BX.prop.getFunction(t,"onDestroy",BX.DoNothing)};this.touchStartY=0;this.processedTouchId=0}babelHelpers.createClass(e,[{key:"render",value:function e(){if(this.elements.root){return this.elements.root}this.elements.background=p.Dom.create("div",{props:{className:"bx-videocall-mobile-menu-background"},events:{click:this._onBackgroundClick.bind(this)}});this.elements.root=p.Dom.create("div",{props:{className:"bx-videocall-mobile-menu-container"},children:[this.elements.handle=p.Dom.create("div",{props:{className:"bx-videocall-mobile-menu-handle"}}),this.elements.body=p.Dom.create("div",{props:{className:"bx-videocall-mobile-menu"},children:[this.content]})],events:{touchstart:this._onTouchStart.bind(this),touchmove:this._onTouchMove.bind(this),touchend:this._onTouchEnd.bind(this)}});return this.elements.root}},{key:"show",value:function e(){if(this.parent){this.render();this.parent.appendChild(this.elements.root);this.parent.appendChild(this.elements.background)}}},{key:"close",value:function e(){BX.remove(this.elements.root);BX.remove(this.elements.background);this.callbacks.onClose()}},{key:"closeWithAnimation",value:function e(){if(!this.elements.root){return}this.elements.root.classList.add("closing");this.elements.background.classList.add("closing");this.elements.root.addEventListener("animationend",function(){this.close()}.bind(this))}},{key:"_onTouchStart",value:function e(t){this.touchStartY=t.pageY;if(this.processedTouchId||t.touches.length>1){return}if(t.target==this.elements.header||t.target==this.elements.root||this.elements.body.scrollTop===0){this.processedTouchId=t.touches[0].identifier}}},{key:"_onTouchMove",value:function e(t){if(t.touches.length>1){return}if(t.touches[0].identifier!=this.processedTouchId){return}var i=this.touchStartY-t.pageY;if(i>0){i=0}this.elements.root.style.bottom=i+"px";if(i){t.preventDefault()}}},{key:"_onTouchEnd",value:function e(t){var i=false;for(var n=0;n<t.changedTouches.length;n++){if(t.changedTouches[n].identifier==this.processedTouchId){i=true;break}}if(!i){return}var a=t.pageY-this.touchStartY;if(a>100){this.closeWithAnimation();t.preventDefault()}else{this.elements.root.style.removeProperty("bottom")}this.processedTouchId=0;this.touchStartY=0}},{key:"destroy",value:function e(){this.callbacks.onDestroy();this.elements={};this.callbacks={};this.parent=null}},{key:"_onBackgroundClick",value:function e(){this.closeWithAnimation()}}]);return e}();var an=function(){function e(t){babelHelpers.classCallCheck(this,e);this.parent=t.parent||null;this.header=BX.prop.getString(t,"header","");this.largeIcons=BX.prop.getBoolean(t,"largeIcons",false);this.slider=null;var i=BX.prop.getArray(t,"items",[]);if(i.length===0){throw Error("Items array should not be empty")}this.items=i.filter((function(e){return babelHelpers["typeof"](e)==="object"&&!!e})).map((function(e){return new sn(e)}));this.elements={root:null,header:null,body:null};this.callbacks={onClose:BX.prop.getFunction(t,"onClose",BX.DoNothing),onDestroy:BX.prop.getFunction(t,"onDestroy",BX.DoNothing)}}babelHelpers.createClass(e,[{key:"render",value:function e(){var t=this;this.elements.header=p.Dom.create("div",{props:{className:"bx-videocall-mobile-menu-header"},text:this.header});this.elements.body=p.Dom.create("div",{props:{className:"bx-videocall-mobile-menu-body"+(this.largeIcons?" bx-videocall-mobile-menu-large":"")}});this.items.forEach((function(e){if(e){t.elements.body.appendChild(e.render())}}));return BX.createFragment([this.elements.header,this.elements.body])}},{key:"setHeader",value:function e(t){this.header=t;if(this.elements.header){this.elements.header.innerText=t}}},{key:"show",value:function e(){if(!this.slider){this.slider=new nn({parent:this.parent,content:this.render(),onClose:this.onSliderClose.bind(this),onDestroy:this.onSliderDestroy.bind(this)})}this.slider.show()}},{key:"close",value:function e(){if(this.slider){this.slider.close()}}},{key:"onSliderClose",value:function e(){this.slider.destroy()}},{key:"onSliderDestroy",value:function e(){this.slider=null;this.destroy()}},{key:"destroy",value:function e(){if(this.slider){this.slider.destroy()}this.slider=null;this.items.forEach((function(e){e.destroy()}));this.items=[];this.callbacks.onDestroy();this.elements={};this.callbacks={};this.parent=null}}]);return e}();var sn=function(){function e(t){babelHelpers.classCallCheck(this,e);this.id=BX.prop.getString(t,"id",Yf.getUuidv4());this.icon=BX.prop.getString(t,"icon","");this.iconClass=BX.prop.getString(t,"iconClass","");this.text=BX.prop.getString(t,"text","");this.showSubMenu=BX.prop.getBoolean(t,"showSubMenu",false);this.separator=BX.prop.getBoolean(t,"separator",false);this.enabled=BX.prop.getBoolean(t,"enabled",true);this.userModel=BX.prop.get(t,"userModel",null);this.avatarBackground=Yf.getAvatarBackground();if(this.userModel){this._userChangeHandler=this._onUserChange.bind(this);this.subscribeUserEvents();this.text=this.userModel.name;this.icon=this.userModel.avatar;this.iconClass="user-avatar";this.iconText=u.Utils.text.getFirstLetters(this.userModel.name);this.iconBackground=Yf.getAvatarBackground()}this.elements={root:null,icon:null,content:null,submenu:null,separator:null,mic:null,cam:null};this.callbacks={click:BX.prop.getFunction(t,"onClick",BX.DoNothing),clickSubMenu:BX.prop.getFunction(t,"onClickSubMenu",BX.DoNothing)}}babelHelpers.createClass(e,[{key:"render",value:function e(){if(this.elements.root){return this.elements.root}if(this.separator){this.elements.root=p.Dom.create("hr",{props:{className:"bx-videocall-mobile-menu-item-separator"}})}else{this.elements.root=p.Dom.create("div",{props:{className:"bx-videocall-mobile-menu-item"+(this.enabled?"":" disabled")},children:[this.elements.icon=p.Dom.create("div",{props:{className:"bx-videocall-mobile-menu-item-icon "+this.iconClass}}),this.elements.content=p.Dom.create("div",{props:{className:"bx-videocall-mobile-menu-item-content"},children:[p.Dom.create("span",{text:this.text})]})],events:{click:this.callbacks.click}});if(this.icon!=""){this.elements.icon.style.backgroundImage='url("'+this.icon+'")';this.elements.icon.innerText=""}else if(this.iconText){this.elements.icon.innerText=this.iconText;this.elements.root.style.setProperty("--avatar-background",this.avatarBackground)}if(this.showSubMenu){this.elements.submenu=p.Dom.create("div",{props:{className:"bx-videocall-mobile-menu-item-submenu-icon"}});this.elements.root.appendChild(this.elements.submenu)}if(this.userModel){this.elements.mic=p.Dom.create("div",{props:{className:"bx-videocall-mobile-menu-icon-user bx-call-view-icon-red-microphone-off"}});this.elements.cam=p.Dom.create("div",{props:{className:"bx-videocall-mobile-menu-icon-user bx-call-view-icon-red-camera-off"}});if(!this.userModel.cameraState){this.elements.content.prepend(this.elements.cam)}if(!this.userModel.microphoneState){this.elements.content.prepend(this.elements.mic)}}}return this.elements.root}},{key:"updateUserIcons",value:function e(){if(!this.userModel){return}if(this.userModel.microphoneState){BX.remove(this.elements.mic)}else{this.elements.content.prepend(this.elements.mic)}if(this.userModel.cameraState){BX.remove(this.elements.cam)}else{this.elements.content.prepend(this.elements.cam)}}},{key:"subscribeUserEvents",value:function e(){this.userModel.subscribe("changed",this._userChangeHandler)}},{key:"_onUserChange",value:function e(t){this.updateUserIcons()}},{key:"destroy",value:function e(){if(this.userModel){this.userModel.unsubscribe("changed",this._userChangeHandler);this.userModel=null}this.callbacks=null;this.elements=null}}]);return e}();var rn=function(){function e(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};babelHelpers.classCallCheck(this,e);babelHelpers.defineProperty(this,"elements",{});this._onUserFieldChangedHandler=this._onUserFieldChanged.bind(this);this.userModel=t.userModel;this.userModel.subscribe("changed",this._onUserFieldChangedHandler);this.parentContainer=t.parentContainer;this.screenSharingUser=p.Type.isBoolean(t.screenSharingUser)?t.screenSharingUser:false;this.allowBackgroundItem=p.Type.isBoolean(t.allowBackgroundItem)?t.allowBackgroundItem:true;this.allowMaskItem=p.Type.isBoolean(t.allowMaskItem)?t.allowMaskItem:true;this._allowPinButton=p.Type.isBoolean(t.allowPinButton)?t.allowPinButton:true;this._visible=true;this._audioTrack=t.audioTrack;this._screenAudioTrack=t.screenAudioTrack;this._audioStream=this._audioTrack?new MediaStream([this._audioTrack]):null;this._screenAudioStream=this._screenAudioTrack?new MediaStream([this._screenAudioTrack]):null;this._videoTrack=t.videoTrack;this._stream=this._videoTrack?new MediaStream([this._videoTrack]):null;this._videoRenderer=null;this._previewRenderer=null;this._flipVideo=t.flipVideo||false;this._tracksSubscriptionFailed={};this._alwaysShowName=t.alwaysShowName;this._hiddenFloorRequest=t.hiddenFloorRequest;this._hiddenRemoteParticipantButtonMenu=t.hiddenRemoteParticipantButtonMenu;this.hidden=false;this.videoBlurState=false;this.isChangingName=false;this._badNetworkIndicator=false;this.incomingVideoConstraints={width:0,height:0};if(t.audioElement){this.elements.audio=t.audioElement}if(t.screenAudioElement){this.elements.screenAudio=t.screenAudioElement}this.callBacks={onClick:p.Type.isFunction(t.onClick)?t.onClick:BX.DoNothing,onUserRename:p.Type.isFunction(t.onUserRename)?t.onUserRename:BX.DoNothing,onUserRenameInputFocus:p.Type.isFunction(t.onUserRenameInputFocus)?t.onUserRenameInputFocus:BX.DoNothing,onUserRenameInputBlur:p.Type.isFunction(t.onUserRenameInputBlur)?t.onUserRenameInputBlur:BX.DoNothing,onPin:p.Type.isFunction(t.onPin)?t.onPin:BX.DoNothing,onUnPin:p.Type.isFunction(t.onUnPin)?t.onUnPin:BX.DoNothing,onTurnOffParticipantMic:p.Type.isFunction(t.onTurnOffParticipantMic)?t.onTurnOffParticipantMic:BX.DoNothing,onTurnOffParticipantCam:p.Type.isFunction(t.onTurnOffParticipantCam)?t.onTurnOffParticipantCam:BX.DoNothing,onTurnOffParticipantScreenshare:p.Type.isFunction(t.onTurnOffParticipantScreenshare)?t.onTurnOffParticipantScreenshare:BX.DoNothing};this.checkAspectInterval=setInterval(this.checkVideoAspect.bind(this),500);this.hintManager=BX.UI.Hint.createInstance({popupParameters:{targetContainer:document.body,className:"bx-messenger-videocall-panel-item-hotkey-hint ".concat(this.userModel.id),bindOptions:{forceBindPosition:true}}});this.connectionStats={};this.connectionStatsVisible=false;this.avatarBackground=t.avatarBackground||Yf.getAvatarBackground();this.removeAvatarPulseTimer=null;this.hideUserNameTimer=null}babelHelpers.createClass(e,[{key:"initUserNameState",value:function e(){if(this._alwaysShowName){this.toggleStateUserName(true)}}},{key:"isVisibleMediaStateIcon",value:function e(t){return!t&&this.userModel.state===yc.Connected}},{key:"isVisibleCameraStateIcon",value:function e(){return this.isVisibleMediaStateIcon(this.userModel.cameraState)}},{key:"isVisibleMicStateIcon",value:function e(){return this.isVisibleMediaStateIcon(this.userModel.microphoneState)}},{key:"showStats",value:function e(t){this.connectionStats=t;if(this.elements.statsOverlay&&this.connectionStatsVisible){this.showConnectionStats()}}},{key:"showTrackSubscriptionFailed",value:function e(t){this._tracksSubscriptionFailed[t.sid]=t}},{key:"_formatFailedSubscribtionTracks",value:function e(){var t="";for(var i in this._tracksSubscriptionFailed){t+=this._tracksSubscriptionFailed[i].source+" "+i+"\n"}return t}},{key:"render",value:function e(){var t=this;if(this.elements.root){return this.elements.root}this.elements.root=p.Dom.create("div",{props:{className:"bx-messenger-videocall-user"},dataset:{userId:this.userModel.id,order:this.userModel.order},children:[this.elements.videoBorder=p.Dom.create("div",{props:{className:"bx-messenger-videocall-user-border"}}),this.elements.container=p.Dom.create("div",{props:{className:"bx-messenger-videocall-user-inner"},children:[this.elements.avatarContainer=p.Dom.create("div",{props:{className:"bx-messenger-videocall-user-avatar-border"},children:[this.elements.avatar=p.Dom.create("div",{props:{className:"bx-messenger-videocall-user-avatar"},text:""}),p.Dom.create("div",{props:{className:"bx-messenger-videocall-user-avatar-overlay-border"}}),p.Dom.create("div",{props:{className:"bx-messenger-videocall-user-avatar-pulse-element",style:"animation-delay: -2s;"}}),p.Dom.create("div",{props:{className:"bx-messenger-videocall-user-avatar-pulse-element",style:"animation-delay: -1.5s;"}}),p.Dom.create("div",{props:{className:"bx-messenger-videocall-user-avatar-pulse-element",style:"animation-delay: -1s;"}}),p.Dom.create("div",{props:{className:"bx-messenger-videocall-user-avatar-pulse-element",style:"animation-delay: -0.5s;"}})]}),this.elements.panel=p.Dom.create("div",{props:{className:"bx-messenger-videocall-user-panel"}}),this.elements.state=p.Dom.create("div",{props:{className:"bx-messenger-videocall-user-status-text"},text:this.getStateMessage(this.userModel.state)}),p.Dom.create("div",{props:{className:"bx-messenger-videocall-user-bottom-gradient"}}),this.elements.userBottomContainer=p.Dom.create("div",{props:{className:"bx-messenger-videocall-user-bottom"},children:[this.elements.nameContainer=p.Dom.create("div",{props:{className:"bx-messenger-videocall-user-name-container"+(this.userModel.allowRename&&!this.userModel.wasRenamed?" hidden":"")},children:[this.elements.name=p.Dom.create("span",{props:{className:"bx-messenger-videocall-user-name",title:this.screenSharingUser?BX.message("IM_CALL_USERS_SCREEN").replace("#NAME#",this.userModel.name):this.userModel.name},text:this.screenSharingUser?BX.message("IM_CALL_USERS_SCREEN").replace("#NAME#",this.userModel.name):this.userModel.name}),this.elements.changeNameIcon=p.Dom.create("div",{props:{className:"bx-messenger-videocall-user-name-icon bx-messenger-videocall-user-change-name-icon hidden"}})],events:{click:this.toggleNameInput.bind(this)}}),this.elements.changeNameContainer=p.Dom.create("div",{props:{className:"bx-messenger-videocall-user-change-name-container hidden"},children:[this.elements.changeNameCancel=p.Dom.create("div",{props:{className:"bx-messenger-videocall-user-change-name-cancel"},events:{click:this.toggleNameInput.bind(this)}}),this.elements.changeNameInput=p.Dom.create("input",{props:{className:"bx-messenger-videocall-user-change-name-input"},attrs:{type:"text",value:this.userModel.name,placeholder:BX.message("IM_CALL_GUEST_INPUT_NAME")},events:{keydown:this.onNameInputKeyDown.bind(this),focus:this.callBacks.onUserRenameInputFocus,blur:this.callBacks.onUserRenameInputBlur,click:function e(t){t.stopPropagation()}}}),this.elements.changeNameConfirm=p.Dom.create("div",{props:{className:"bx-messenger-videocall-user-change-name-confirm"},events:{click:this.changeName.bind(this)}}),this.elements.changeNameLoader=p.Dom.create("div",{props:{className:"bx-messenger-videocall-user-change-name-loader hidden"},children:[p.Dom.create("div",{props:{className:"bx-messenger-videocall-user-change-name-loader-icon"}})]})]}),this.elements.introduceYourselfContainer=p.Dom.create("div",{props:{className:"bx-messenger-videocall-user-introduce-yourself-container"+(!this.userModel.allowRename||this.userModel.wasRenamed?" hidden":"")},children:[p.Dom.create("div",{props:{className:"bx-messenger-videocall-user-introduce-yourself-text"},text:BX.message("IM_CALL_GUEST_INTRODUCE_YOURSELF")})],events:{click:this.toggleNameInput.bind(this)}})]}),this.elements.floorRequest=p.Dom.create("div",{props:{className:"bx-messenger-videocall-user-floor-request bx-messenger-videocall-floor-request-icon"}}),this.elements.statsOverlay=p.Dom.create("div",{props:{className:"bx-messenger-videocall-user-stats-overlay"}})]})],style:{order:this.userModel.order},events:{click:function(e){e.stopPropagation();this.callBacks.onClick({userId:this.id})}.bind(this)}});if(this.userModel.talking){this.updateAvatarPulseState()}this.elements.debugPanel=p.Dom.create("div",{props:{className:"bx-messenger-videocall-user-debug-panel"},children:[p.Dom.create("div",{props:{className:"bx-messenger-videocall-user-debug-panel-button connection-stats"},children:[this.elements.connectionQualityIcon=p.Dom.create("div",{props:{className:"bx-messenger-videocall-user-debug-panel-button-icon connection-quality-icon",title:BX.message("IM_M_CALL_CONNECTION_QUALITY_HINT")}})],events:{click:function e(i){i.stopPropagation();t.connectionStatsVisible=!t.connectionStatsVisible;if(t.connectionStatsVisible){t.showConnectionStats();t.elements.statsOverlay.classList.add("stats-overlay-visble")}else{t.elements.statsOverlay.classList.remove("stats-overlay-visble")}}}}),this.elements.connectionProblem=p.Dom.create("div",{props:{className:"bx-messenger-videocall-user-debug-panel-button connection-problem"},children:[p.Dom.create("div",{props:{className:"bx-messenger-videocall-user-debug-panel-button-icon connection-problem-icon"},events:{mouseover:function e(i){t.hintManager.show(i.currentTarget,BX.message("IM_M_CALL_POOR_CONNECTION_WITH_USER"))},mouseout:function e(i){t.hintManager.hide()}}})]})]});if(this.userModel.localUser){this.elements.root.classList.add("bx-messenger-videocall-user-self")}if(this.userModel.avatar!==""){this.elements.root.style.setProperty("--avatar","url('".concat(this.userModel.avatar,"')"));this.elements.avatar.innerText="";this.elements.root.style.removeProperty("--avatar-background")}else{this.elements.root.style.removeProperty("--avatar");this.elements.root.style.setProperty("--avatar-background",this.avatarBackground);this.elements.avatar.innerText=this.getAvatarInnerText()}this.elements.videoContainer=p.Dom.create("div",{props:{className:"bx-messenger-videocall-video-container"},children:[this.elements.video=p.Dom.create("video",{props:{className:"bx-messenger-videocall-video",volume:0,autoplay:true},attrs:{playsinline:true,muted:true}}),p.Dom.create("div",{props:{className:"bx-messenger-videocall-preview"},children:[p.Dom.create("div",{props:{className:"bx-messenger-videocall-preview-container"},children:[this.elements.preview=p.Dom.create("video",{props:{className:"bx-messenger-videocall-preview-video",volume:0,autoplay:true},attrs:{playsinline:true,muted:true}})]})]})]});this.elements.container.appendChild(this.elements.videoContainer);if(this.stream&&this.stream.active){this.elements.video.srcObject=this.stream}if(this.flipVideo){this.elements.video.classList.add("bx-messenger-videocall-video-flipped")}if(this.userModel.screenState){this.elements.video.classList.add("bx-messenger-videocall-video-contain")}if(this.isVisibleCameraStateIcon()&&this.isVisibleMicStateIcon()){this.elements.nameContainer.classList.add("extra-padding")}this.elements.buttonBackground=p.Dom.create("div",{props:{className:"bx-messenger-videocall-user-panel-button"},children:[p.Dom.create("div",{props:{className:"bx-messenger-videocall-user-panel-button-icon background"}}),p.Dom.create("div",{props:{className:"bx-messenger-videocall-user-panel-button-text"},text:BX.message("IM_CALL_CHANGE_BACKGROUND")})],events:{click:function e(t){t.stopPropagation();T.open()}}});this.elements.buttonMenu=p.Dom.create("div",{props:{className:"bx-messenger-videocall-user-panel-button"},children:[p.Dom.create("div",{props:{className:"bx-messenger-videocall-user-panel-button-icon menu"}})],events:{click:function e(i){i.stopPropagation();t.showMenu()}}});if(!this._hiddenRemoteParticipantButtonMenu){this.elements.remoteParticipantButtonMenu=p.Dom.create("div",{props:{className:"bx-messenger-videocall-user-panel-button"},children:[p.Dom.create("div",{props:{className:"bx-messenger-videocall-user-panel-button-icon menu"}})],events:{click:function e(i){i.stopPropagation();t.showRemoteParticipantMenu()}}})}this.elements.buttonPin=p.Dom.create("div",{props:{className:"bx-messenger-videocall-user-panel-button"},children:[p.Dom.create("div",{props:{className:"bx-messenger-videocall-user-panel-button-icon pin"}}),p.Dom.create("div",{props:{className:"bx-messenger-videocall-user-panel-button-text"},text:BX.message("IM_CALL_PIN")})],events:{click:function e(i){i.stopPropagation();t.callBacks.onPin({userId:t.userModel.id})}}});this.elements.buttonUnPin=p.Dom.create("div",{props:{className:"bx-messenger-videocall-user-panel-button"},children:[p.Dom.create("div",{props:{className:"bx-messenger-videocall-user-panel-button-icon unpin"}}),p.Dom.create("div",{props:{className:"bx-messenger-videocall-user-panel-button-text"},text:BX.message("IM_CALL_UNPIN")})],events:{click:function e(i){i.stopPropagation();t.callBacks.onUnPin()}}});this.elements.userBottomContainer.appendChild(p.Dom.create("div",{props:{className:"bx-messenger-videocall-user-device-state-container"},children:[this.elements.micState=p.Dom.create("div",{props:{className:"bx-messenger-videocall-user-name-icon bx-messenger-videocall-user-device-state mic".concat(this.isVisibleMicStateIcon()?"":" hidden")}}),this.elements.cameraState=p.Dom.create("div",{props:{className:"bx-messenger-videocall-user-name-icon bx-messenger-videocall-user-device-state camera".concat(this.isVisibleCameraStateIcon()?"":" hidden")}})]}));this.updatePanelDeferred();return this.elements.root}},{key:"showConnectionStats",value:function e(){var t,i,n;if(!this.elements.statsOverlay){return}var a="";var s=(t=this.connectionStats)===null||t===void 0?void 0:t[ge.Camera];var r=(i=this.connectionStats)===null||i===void 0?void 0:i[ge.Screen];var o=(n=this.connectionStats)===null||n===void 0?void 0:n[ge.Microphone];var l=this._formatFailedSubscribtionTracks();if(l){a+="Failed subscribe to:\n";a+=l}if(s||!r){a+="Video stats:\n";a+=this._formatVideoStats(s)}if(r){a+="\n\nScreen share stats:\n";a+=this._formatVideoStats(r)}if(o){a+="\n\nAudio stats:\n";a+="Bitrate: ".concat((o===null||o===void 0?void 0:o.bitrate)||0,"\n");a+="PacketsLost: ".concat((o===null||o===void 0?void 0:o.packetsLostExtended)||0,"\n");a+="Codec: ".concat((o===null||o===void 0?void 0:o.codecName)||"-")}this.elements.statsOverlay.innerText=a}},{key:"setIncomingVideoConstraints",value:function e(t,i){this.incomingVideoConstraints.width=typeof t==="undefined"?this.incomingVideoConstraints.width:t;this.incomingVideoConstraints.height=typeof i==="undefined"?this.incomingVideoConstraints.height:i;if(!this.videoRenderer){return}this.videoRenderer.requestVideoSize(this.incomingVideoConstraints.width,this.incomingVideoConstraints.height)}},{key:"updateRendererState",value:function e(){}},{key:"_onUserFieldChanged",value:function e(t){var i=t.data;switch(i.fieldName){case"id":return this.updateId();case"name":return this.updateName();case"avatar":return this.updateAvatar();case"state":return this.updateState();case"talking":return this.updateTalking();case"microphoneState":return this.updateMicrophoneState();case"cameraState":return this.updateCameraState();case"videoPaused":return this.updateVideoPaused();case"floorRequestState":return this.updateFloorRequestState();case"screenState":return this.updateScreenState();case"pinned":return this.updatePanel();case"allowRename":return this.updateRenameAllowed();case"wasRenamed":return this.updateWasRenamed();case"renameRequested":return this.updateRenameRequested();case"order":return this.updateOrder()}}},{key:"toggleRenameIcon",value:function e(){if(!this.userModel.allowRename){return}this.elements.changeNameIcon.classList.toggle("hidden")}},{key:"toggleNameInput",value:function e(t){if(!this.userModel.allowRename||!this.elements.root){return}t.stopPropagation();if(this.isChangingName){this.isChangingName=false;if(!this.userModel.wasRenamed){this.elements.introduceYourselfContainer.classList.remove("hidden");this.elements.changeNameContainer.classList.add("hidden")}else{this.elements.changeNameContainer.classList.add("hidden");this.elements.nameContainer.classList.remove("hidden")}}else{if(!this.userModel.wasRenamed){this.elements.introduceYourselfContainer.classList.add("hidden")}this.isChangingName=true;this.elements.nameContainer.classList.add("hidden");this.elements.changeNameContainer.classList.remove("hidden");this.elements.changeNameInput.value=this.userModel.name;this.elements.changeNameInput.focus();this.elements.changeNameInput.select()}}},{key:"onNameInputKeyDown",value:function e(t){if(!this.userModel.allowRename){return}if(t.keyCode===13){this.changeName(t)}else if(t.keyCode===27){this.toggleNameInput(t)}}},{key:"onNameInputFocus",value:function e(t){}},{key:"onNameInputBlur",value:function e(t){}},{key:"changeName",value:function e(t){t.stopPropagation();var i=this.elements.changeNameInput.value;var n=i.trim();var a=true;if(n===this.userModel.name||n===""){a=false}if(a){this.elements.changeNameConfirm.classList.toggle("hidden");this.elements.changeNameLoader.classList.toggle("hidden");this.callBacks.onUserRename(n)}else{this.toggleNameInput(t)}}},{key:"showMenu",value:function e(){var t=this;var i=[];if(this.userModel.localUser&&this.allowBackgroundItem){i.push({text:this.allowMaskItem?BX.message("IM_CALL_CHANGE_BG_MASK"):BX.message("IM_CALL_CHANGE_BACKGROUND"),onclick:function e(){t.menu.close();T.open()}})}if(i.length===0){return}var n=p.Dom.getRelativePosition(this.elements.buttonMenu,this.parentContainer);this.menu=new v.Menu({id:"call-view-user-menu-"+this.userModel.id,className:"bx-call-user-context-menu",background:"#00428F",contentBackground:"#00428F",darkMode:true,contentBorderRadius:"6px",borderRadius:"6px",bindElement:{left:n.left,top:n.top,bottom:n.bottom},items:i,targetContainer:this.parentContainer,autoHide:true,closeByEsc:true,offsetTop:0,offsetLeft:0,bindOptions:{position:"bottom"},angle:true,overlay:{backgroundColor:"white",opacity:0},cacheable:false,events:{onPopupDestroy:function e(){return t.menu=null}}});this.menu.show()}},{key:"showRemoteParticipantMenu",value:function e(){var t=this;if(this.remoteParticipantMenu){this.remoteParticipantMenu.destroy();this.remoteParticipantMenu=null}var i=[];if(!this.userModel.localUser){if(this.userModel.microphoneState){i.push({text:BX.message("CALL_REMOTE_USER_DROPDOWN_MENU_TURN_OFF_MIC"),className:"bx-call-remote-user-turn-off-mic",disabled:!this.userModel.microphoneState,onclick:function e(){t.remoteParticipantMenu.destroy();t.callBacks.onTurnOffParticipantMic({userId:t.userModel.id})}})}if(this.userModel.cameraState){i.push({text:BX.message("CALL_REMOTE_USER_DROPDOWN_MENU_TURN_OFF_CAM"),className:"bx-call-remote-user-turn-off-cam",disabled:!this.userModel.cameraState,onclick:function e(){t.remoteParticipantMenu.destroy();t.callBacks.onTurnOffParticipantCam({userId:t.userModel.id})}})}if(this.userModel.screenState){i.push({text:BX.message("CALL_REMOTE_USER_DROPDOWN_MENU_TURN_OFF_SCREENSHARE"),className:"bx-call-remote-user-turn-off-screenshare",disabled:!this.userModel.screenState,onclick:function e(){t.remoteParticipantMenu.destroy();t.callBacks.onTurnOffParticipantScreenshare({userId:t.userModel.id})}})}}if(i.length===0){return}var n=p.Dom.getRelativePosition(this.elements.remoteParticipantButtonMenu,this.parentContainer);this.remoteParticipantMenu=new v.Menu({id:"call-view-user-menu-"+this.userModel.id,className:"bx-call-remote-user-menu-container",background:"#00428F",contentBackground:"#00428F",contentBorderRadius:"6px",borderRadius:"6px",bindElement:{left:n.left,top:n.top,bottom:n.bottom},items:i,targetContainer:this.parentContainer,darkMode:true,autoHide:true,closeByEsc:true,angle:true,offsetTop:0,bindOptions:{position:"bottom"},overlay:{backgroundColor:"white",opacity:0},cacheable:false,events:{onShow:function e(i){var n=i.getTarget();n.adjustPosition();t.elements.root.classList.add("bx-messenger-videocall-user-dropdown-menu-opened")},onPopupDestroy:function e(){t.elements.root.classList.remove("bx-messenger-videocall-user-dropdown-menu-opened");t.remoteParticipantMenu=null}}});this.remoteParticipantMenu.show()}},{key:"updateAvatar",value:function e(){if(this.elements.root){if(this.userModel.avatar!==""){this.elements.root.style.setProperty("--avatar","url('".concat(this.userModel.avatar,"')"));this.elements.avatar.innerText="";this.elements.root.style.removeProperty("--avatar-background")}else{this.elements.root.style.removeProperty("--avatar");this.elements.root.style.setProperty("--avatar-background",this.avatarBackground);this.elements.avatar.innerText=this.getAvatarInnerText()}}}},{key:"updateId",value:function e(){if(this.elements.root){this.elements.root.dataset.userId=this.userModel.id}}},{key:"updateName",value:function e(){if(this.isChangingName){this.isChangingName=false;this.elements.changeNameConfirm.classList.toggle("hidden");this.elements.changeNameLoader.classList.toggle("hidden");this.elements.changeNameContainer.classList.add("hidden");this.elements.nameContainer.classList.remove("hidden")}if(this.elements.name){this.elements.name.innerText=this.screenSharingUser?BX.message("IM_CALL_USERS_SCREEN").replace("#NAME#",this.userModel.name):this.userModel.name}if(this.userModel.avatar===""&&this.elements.avatar){this.elements.avatar.innerText=this.getAvatarInnerText()}}},{key:"getAvatarInnerText",value:function e(){return u.Utils.text.getFirstLetters(this.userModel.name).toUpperCase()}},{key:"updateRenameAllowed",value:function e(){if(this.userModel.allowRename&&this.elements.nameContainer&&this.elements.introduceYourselfContainer){this.elements.nameContainer.classList.add("hidden");this.elements.introduceYourselfContainer.classList.remove("hidden")}}},{key:"updateWasRenamed",value:function e(){if(!this.elements.root){return}if(this.userModel.allowRename){this.elements.introduceYourselfContainer.classList.add("hidden");this.elements.changeNameIcon.classList.remove("hidden");if(this.elements.changeNameContainer.classList.contains("hidden")){this.elements.nameContainer.classList.remove("hidden")}}}},{key:"updateRenameRequested",value:function e(){if(this.userModel.allowRename){this.elements.introduceYourselfContainer.classList.add("hidden")}}},{key:"updateOrder",value:function e(){if(this.elements.root){this.elements.root.dataset.order=this.userModel.order;this.elements.root.style.order=this.userModel.order}}},{key:"updatePanelDeferred",value:function e(){setTimeout(this.updatePanel.bind(this),0)}},{key:"updatePanel",value:function e(){if(!this.isMounted()){return}var t=this.elements.root.offsetWidth;var i=!this.elements.panel.hasChildNodes();if(this.lastWIdth&&this.lastWIdth===t&&!i){return}var n=this.userModel.localUser&&this.allowBackgroundItem;var a=this.lastWIdth||this.lastWIdth<=300&&t>300||this.lastWIdth>300&&t<=300;var s=this.userModel.pinned&&Boolean(this.elements.buttonPin.parentElement);var r=!this.userModel.pinned&&Boolean(this.elements.buttonUnPin.parentElement);var o=i||n&&a||s||r;this.lastWIdth=t;if(o){p.Dom.clean(this.elements.panel)}if(n&&(a||i)){if(t>300){p.Dom.append(this.elements.buttonBackground,this.elements.panel)}else{p.Dom.append(this.elements.buttonMenu,this.elements.panel)}}if(this.allowPinButton){if(i||s||r){if(this.userModel.pinned){p.Dom.append(this.elements.buttonUnPin,this.elements.panel)}else{p.Dom.append(this.elements.buttonPin,this.elements.panel)}}if(t>250){this.elements.buttonPin.classList.remove("no-text");this.elements.buttonUnPin.classList.remove("no-text")}else{this.elements.buttonPin.classList.add("no-text");this.elements.buttonUnPin.classList.add("no-text")}}if(!this.userModel.localUser){this.currentBitrixCall=Yf.getCurrentBitrixCall();this.isShowRemoteParticipantButtonMenu=Yf.isUserControlFeatureEnabled()&&Yf.canControlChangeSettings()&&(this.userModel.microphoneState||this.userModel.cameraState||this.userModel.screenState)&&this.currentBitrixCall&&this.currentBitrixCall.provider!==Tc.Plain;if(this.isShowRemoteParticipantButtonMenu&&this.elements.remoteParticipantButtonMenu){this.elements.panel.appendChild(this.elements.remoteParticipantButtonMenu)}}}},{key:"playVideoElements",value:function e(t){var i=this;var n=Boolean(t);var a=n&&Boolean(t.srcObject);var s=n&&t.readyState>=t.HAVE_CURRENT_DATA;var r=n&&t.ended;if(a&&s&&!r){t.play()["catch"](Ui)}if(a&&r){t.load()}if(a&&!s&&!r&&!t.onloadeddata){t.onloadeddata=function(){i.playVideoElements(t)}}}},{key:"update",value:function e(){if(!this.elements.root){return}if(this.hasVideo()){var t,i;if(this.visible){var n,a;if(this.videoRenderer){this.videoRenderer.render(this.elements.video);this.playVideoElements(this.elements.video);if(this._previewRenderer){this._previewRenderer.render(this.elements.preview)}else{this.elements.preview.srcObject=null}}else if(this.stream&&((n=this.elements.video.srcObject)===null||n===void 0?void 0:n.id)!==((a=this.stream)===null||a===void 0?void 0:a.id)){this.elements.video.srcObject=this.stream;this.playVideoElements(this.elements.video)}if(this.elements.avatarContainer){this.elements.avatarContainer.classList.add("bx-messenger-videocall-hidden-avatar")}}if(((t=this.videoRenderer)===null||t===void 0?void 0:t.kind)==="video"&&this.flipVideo){this.elements.video.classList.toggle("bx-messenger-videocall-video-flipped",this.flipVideo);this.elements.preview.classList.toggle("bx-messenger-videocall-video-flipped",!this.flipVideo)}else if(((i=this.videoRenderer)===null||i===void 0?void 0:i.kind)==="sharing"&&this.flipVideo){this.elements.video.classList.toggle("bx-messenger-videocall-video-flipped",!this.flipVideo);this.elements.preview.classList.toggle("bx-messenger-videocall-video-flipped",this.flipVideo)}else{this.elements.video.classList.toggle("bx-messenger-videocall-video-flipped",this.flipVideo)}this.elements.video.classList.toggle("bx-messenger-videocall-video-contain",this.userModel.screenState)}else{this.elements.video.srcObject=null;this.elements.preview.srcObject=null;if(this.elements.avatarContainer){this.elements.avatarContainer.classList.remove("bx-messenger-videocall-hidden-avatar")}}if(Yf.isCallServerAllowed()&&this.userModel.state===yc.Connected&&!this.elements.debugPanel.parentElement&&!this.screenSharingUser){this.elements.container.appendChild(this.elements.debugPanel)}this.updatePanelDeferred()}},{key:"playAudio",value:function e(){if(!this.audioStream){var t;this.elements.audio.srcObject=null;Yf.sendLog({description:"no audioStream to play",userModelId:(t=this.userModel)===null||t===void 0?void 0:t.id});return}if(this.speakerId&&p.Type.isFunction(this.elements.audio.setSinkId)){this.elements.audio.setSinkId(this.speakerId).then(function(){this.elements.audio.srcObject=this.audioStream;this.elements.audio.play()["catch"](Ui)}.bind(this))["catch"](console.error)}else{this.elements.audio.srcObject=this.audioStream;this.elements.audio.play()["catch"](Ui)}}},{key:"playScreenAudio",value:function e(){if(!this.screenAudioStream){this.elements.screenAudio.srcObject=null;return}this.elements.screenAudio.srcObject=this.screenAudioStream;this.elements.screenAudio.play()["catch"](Ui)}},{key:"playVideo",value:function e(){this.playVideoElements(this.elements.video);this.playVideoElements(this.elements.preview)}},{key:"blurVideo",value:function e(t){t=!!t;if(this.videoBlurState==t){return}this.videoBlurState=t;if(this.elements.video){this.elements.video.classList.toggle("bx-messenger-videocall-video-blurred")}}},{key:"getStateMessage",value:function e(t,i){switch(t){case yc.Idle:return"";case yc.Calling:return BX.message("IM_M_CALL_STATUS_WAIT_ANSWER");case yc.Declined:return BX.message("IM_M_CALL_STATUS_DECLINED");case yc.Ready:case yc.Connecting:return BX.message("IM_M_CALL_STATUS_WAIT_CONNECT");case yc.Connected:return i?BX.message("IM_M_CALL_STATUS_VIDEO_PAUSED"):"";case yc.Failed:return BX.message("IM_M_CALL_STATUS_CONNECTION_ERROR");case yc.Unavailable:return BX.message("IM_M_CALL_STATUS_UNAVAILABLE");default:return""}}},{key:"mount",value:function e(t,i){i=i===true;if(!this.elements.root){this.render();this.initUserNameState()}if(this.isMounted()&&this.elements.root.parentElement==t&&!i){this.updatePanelDeferred();return false}else{this.checkAspectInterval=setInterval(this.checkVideoAspect.bind(this),500)}t.appendChild(this.elements.root);this.update()}},{key:"dismount",value:function e(){if(!this.isMounted()){return false}clearInterval(this.checkAspectInterval);this.elements.video.srcObject=null;this.elements.preview.srcObject=null;p.Dom.remove(this.elements.root)}},{key:"isMounted",value:function e(){return!!(this.elements.root&&this.elements.root.parentElement)}},{key:"updateState",value:function e(){if(!this.elements.root){return}if(this.userModel.state==yc.Calling||this.userModel.state==yc.Connecting){this.updateAvatarPulseState()}else{this.addAvatarPulseTimer()}if(this.userModel.state==yc.Idle){this._videoRenderer=null;this._previewRenderer=null;this._audioTrack=null;this._audioStream=null}this.elements.state.innerText=this.getStateMessage(this.userModel.state,this.userModel.videoPaused);this.updateMicrophoneState();this.updateCameraState();this.update()}},{key:"updateTalking",value:function e(){if(!this.elements.root){return}if(this.userModel.talking){this.updateAvatarPulseState()}else{this.addAvatarPulseTimer()}}},{key:"updateMicrophoneState",value:function e(){if(!this.elements.root){return}if(!this.isVisibleMicStateIcon()){this.elements.micState.classList.add("hidden")}else{this.elements.micState.classList.remove("hidden");this.clearAvatarPulseTimer()}if(this.isVisibleCameraStateIcon()&&this.isVisibleMicStateIcon()){this.elements.nameContainer.classList.add("extra-padding")}else{this.elements.nameContainer.classList.remove("extra-padding")}this.updateRemoteParticipantMenuState()}},{key:"updateCameraState",value:function e(){if(!this.elements.root){return}if(!this.isVisibleCameraStateIcon()){this.elements.cameraState.classList.add("hidden")}else{this.elements.cameraState.classList.remove("hidden")}if(this.isVisibleCameraStateIcon()&&this.isVisibleMicStateIcon()){this.elements.nameContainer.classList.add("extra-padding")}else{this.elements.nameContainer.classList.remove("extra-padding")}this.updateRemoteParticipantMenuState()}},{key:"updateRemoteParticipantMenuState",value:function e(){if(this.remoteParticipantMenu){this.showRemoteParticipantMenu()}this.updatePanelDeferred()}},{key:"updateVideoPaused",value:function e(){if(!this.elements.root){return}if(this.stream&&this.hasVideo()){this.blurVideo(this.userModel.videoPaused)}this.updateState()}},{key:"updateFloorRequestState",value:function e(){if(!this.elements.floorRequest||this._hiddenFloorRequest){return}if(this.userModel.floorRequestState){this.elements.floorRequest.classList.add("active")}else{this.elements.floorRequest.classList.remove("active")}}},{key:"updateScreenState",value:function e(){if(!this.elements.video){return}if(this.userModel.screenState){this.elements.video.classList.add("bx-messenger-videocall-video-contain")}else{this.elements.video.classList.remove("bx-messenger-videocall-video-contain")}}},{key:"hide",value:function e(){if(!this.elements.root){return}this.elements.root.dataset.hidden=1}},{key:"show",value:function e(){if(!this.elements.root){return}delete this.elements.root.dataset.hidden}},{key:"hasAudio",value:function e(){var t=this.userModel.state===yc.Connected;var i=Boolean(this._audioTrack)||Boolean(this._screenAudioTrack);return t&&i}},{key:"hasVideo",value:function e(){if(H.maxLocalStreamQualityHeight===_.NO_VIDEO){return false}return this.userModel.state==yc.Connected&&(!!this._videoTrack||!!this._videoRenderer)}},{key:"hasCameraVideo",value:function e(){var t,i;return this.userModel.state==yc.Connected&&(!!this._videoTrack||((t=this._videoRenderer)===null||t===void 0?void 0:t.kind)==="video"||((i=this._previewRenderer)===null||i===void 0?void 0:i.kind)==="video")}},{key:"checkVideoAspect",value:function e(){if(!this.elements.video){return}if(this.elements.video.videoHeight>this.elements.video.videoWidth){this.elements.video.classList.add("bx-messenger-videocall-video-vertical")}else{this.elements.video.classList.remove("bx-messenger-videocall-video-vertical")}}},{key:"releaseStream",value:function e(){if(this._videoRenderer&&!this._previewRenderer){if(this.elements.video){this.elements.video.srcObject=null}this._videoRenderer=null}else{if(this.elements.video){this.elements.video.srcObject=null}this.videoTrack=null}}},{key:"_getVideoStats",value:function e(t){var i="";var n="";i+="Bitrate: ".concat((t===null||t===void 0?void 0:t.bitrate)||0,"\n");i+="Track ID: ".concat((t===null||t===void 0?void 0:t.trackIdentifier)||"no track id!","\n");i+="PacketsLost: ".concat((t===null||t===void 0?void 0:t.packetsLostExtended)||0,"\n");i+="Codec: ".concat((t===null||t===void 0?void 0:t.codecName)||"-","\n");i+="Resolution: ".concat((t===null||t===void 0?void 0:t.frameWidth)||0,"x").concat((t===null||t===void 0?void 0:t.frameHeight)||0," \n");i+="In Remote Tracks: ".concat((t===null||t===void 0?void 0:t.inRemoteTracks)||"U"," \n");if(t!==null&&t!==void 0&&t.qualityLimitationReason){i+="(changes:".concat(t.qualityLimitationResolutionChanges,", FPS: ").concat((t===null||t===void 0?void 0:t.framesPerSecond)||0,")");n="Limitation: ".concat(t.qualityLimitationReason);n+=" (duration: ".concat(Object.entries(t.qualityLimitationDurations||{}).reduce((function(e,t,i){return e+"".concat(i?", ":"")+"".concat(t[0],": ").concat(t[1])}),""),")")}else{i+="(".concat((t===null||t===void 0?void 0:t.framesPerSecond)||0," FPS)")}return{resultString:i,limitationsString:n}}},{key:"_formatVideoStats",value:function e(t){var i=this;var n="";var a="";if(p.Type.isArray(t)){t.forEach((function(e,s){if(s){n+="\n\n"}if(t.length>1){n+="Track ".concat(s+1,"\n")}var r=i._getVideoStats(e),o=r.resultString,l=r.limitationsString;if(o){n+=o}if(l){a=l}}))}else{var s=this._getVideoStats(t),r=s.resultString,o=s.limitationsString;if(r){n+=r}if(o){a=o}}return a?"".concat(a,"\n\n").concat(n):n}},{key:"toggleStateUserName",value:function e(t){if(!this.elements.nameContainer){return}var i="active";var n=this.elements.nameContainer.classList.contains(i);if(n!==t){this.elements.nameContainer.classList.toggle(i)}}},{key:"destroy",value:function e(){if(this.hintManager){this.hintManager.hide();this.hintManager=null}this.userModel.unsubscribe("changed",this._onUserFieldChangedHandler);this.releaseStream();clearInterval(this.checkAspectInterval)}},{key:"addAvatarPulseTimer",value:function e(){var t=this;if(this.removeAvatarPulseTimer){clearTimeout(this.removeAvatarPulseTimer);this.removeAvatarPulseTimer=null}this.removeAvatarPulseTimer=setTimeout((function(){t.elements.avatarContainer.classList.remove("bx-messenger-videocall-user-avatar-pulse");t.elements.root.classList.remove("bx-messenger-videocall-user-talking")}),1e3)}},{key:"clearAvatarPulseTimer",value:function e(){if(this.removeAvatarPulseTimer){clearTimeout(this.removeAvatarPulseTimer);this.removeAvatarPulseTimer=null}this.elements.avatarContainer.classList.remove("bx-messenger-videocall-user-avatar-pulse");this.elements.root.classList.remove("bx-messenger-videocall-user-talking")}},{key:"updateAvatarPulseState",value:function e(){if(this.removeAvatarPulseTimer){clearTimeout(this.removeAvatarPulseTimer);this.removeAvatarPulseTimer=null}this.elements.avatarContainer.classList.add("bx-messenger-videocall-user-avatar-pulse");if(this.userModel.talking){this.elements.root.classList.add("bx-messenger-videocall-user-talking")}}},{key:"id",get:function e(){return this.userModel.id}},{key:"allowPinButton",get:function e(){return this._allowPinButton},set:function e(t){if(this._allowPinButton==t){return}this._allowPinButton=t;this.update()}},{key:"audioTrack",get:function e(){return this._audioTrack},set:function e(t){if(this._audioTrack===t){return}this._audioTrack=t;if(!this._audioTrack){var i;Yf.sendLog({description:"trying to set not defined audioTrack!",userModelId:(i=this.userModel)===null||i===void 0?void 0:i.id})}this._audioStream=this._audioTrack?new MediaStream([this._audioTrack]):null;this.playAudio()}},{key:"audioStream",get:function e(){return this._audioStream}},{key:"screenAudioTrack",get:function e(){return this._screenAudioTrack},set:function e(t){if(this._screenAudioTrack===t){return}this._screenAudioTrack=t;this._screenAudioStream=this._screenAudioTrack?new MediaStream([this._screenAudioTrack]):null;this.playScreenAudio()}},{key:"screenAudioStream",get:function e(){return this._screenAudioStream}},{key:"flipVideo",get:function e(){return this._flipVideo},set:function e(t){this._flipVideo=t;this.update()}},{key:"stream",get:function e(){return this._stream}},{key:"visible",get:function e(){return this._visible},set:function e(t){if(this._visible!==t){this._visible=t;this.update();this.updateRendererState()}}},{key:"videoRenderer",get:function e(){return this._videoRenderer},set:function e(t){if(this._videoTrack){this._videoTrack=null}if(this._badNetworkIndicator){if(t.stream){this._tempVideoRenderer=t;this._videoRenderer=null}else{this._tempVideoRenderer=this._videoRenderer=null}}else{var i;this._tempVideoRenderer=null;var n=(i=this._videoRenderer)===null||i===void 0?void 0:i.kind;var a=t===null||t===void 0?void 0:t.kind;if(t!==null&&t!==void 0&&t.stream){if(a==="sharing"&&n==="video"){this._previewRenderer=this._videoRenderer;this._videoRenderer=t}else if(a==="video"&&n==="sharing"){this._previewRenderer=t}else{this._videoRenderer=t}}else{if(a==="sharing"){if(n==="sharing"){this._videoRenderer=this._previewRenderer}this._previewRenderer=null;delete this.connectionStats[ge.Screen]}else if(a==="video"){if(n==="sharing"){this._previewRenderer=null}else{this._videoRenderer=null}delete this.connectionStats[ge.Camera]}this.showConnectionStats()}}this.update();this.updateRendererState()}},{key:"previewRenderer",get:function e(){return this._previewRenderer}},{key:"videoTrack",get:function e(){return this._videoTrack},set:function e(t){if(this._videoTrack===t){return}this._videoTrack=t;if(this._videoTrack&&this._stream){this._stream.removeTrack(this._stream.getVideoTracks()[0]);this._stream.addTrack(this._videoTrack)}else{this._stream=this._videoTrack?new MediaStream([this._videoTrack]):null}this.update()}},{key:"badNetworkIndicator",set:function e(t){if(this._badNetworkIndicator===t){return}this._badNetworkIndicator=t;if(this._badNetworkIndicator){if(this._videoRenderer){this._tempVideoRenderer=this._videoRenderer;this._videoRenderer=null}}else{if(this._tempVideoRenderer){this._videoRenderer=this._tempVideoRenderer;this._tempVideoRenderer=null}}this.update()}},{key:"hasConnectionProblem",set:function e(t){this._hasConnectionProblem=t;if(this._hasConnectionProblem){this.elements.connectionProblem.classList.add("connection-problem-visible")}else{this.elements.connectionProblem.classList.remove("connection-problem-visible")}}},{key:"connectionQuality",set:function e(t){this._connectionQuality=t;var i={excellent:"--excellent-quality-icon",good:"--good-quality-icon",poor:"--poor-quality-icon",bad:"--bad-quality-icon"};if(this._connectionQuality!==undefined&&this.elements.connectionQualityIcon){var n=i.bad;if(this._connectionQuality>=4){n=i.excellent}if(this._connectionQuality>=3&&this._connectionQuality<4){n=i.good}if(this._connectionQuality>=2&&this._connectionQuality<3){n=i.poor}if(this._connectionQuality<2){n=i.bad}this.elements.connectionQualityIcon.style.setProperty("--connection-quality-icon","var(".concat(n,")"))}}}]);return e}();var on=function(e){babelHelpers.inherits(t,e);function t(e){var i;babelHelpers.classCallCheck(this,t);i=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this));i.setEventNamespace("BX.Call.FloorRequest");i.hideTime=BX.prop.getInteger(e,"hideTime",10);i.userModel=e.userModel;i.isShowAllowPermissionButton=i._canChangeSpeakPermission();i.elements={root:null,avatar:null};i.callbacks={onAllowSpeakPermissionClicked:BX.type.isFunction(e.onAllowSpeakPermissionClicked)?e.onAllowSpeakPermissionClicked:BX.DoNothing,onDisallowSpeakPermissionClicked:BX.type.isFunction(e.onDisallowSpeakPermissionClicked)?e.onDisallowSpeakPermissionClicked:BX.DoNothing,onDestroy:BX.type.isFunction(e.onDestroy)?e.onDestroy:BX.DoNothing};i._hideTimeout=null;i.container=null;i._onUserModelChangedHandler=i._onUserModelChanged.bind(babelHelpers.assertThisInitialized(i));i.userModel.subscribe("changed",i._onUserModelChangedHandler);return i}babelHelpers.createClass(t,[{key:"_canChangeSpeakPermission",value:function e(){return i.Util.isUserControlFeatureEnabled()&&!this.userModel.permissionToSpeak&&!i.Util.getRoomPermissions().AudioEnabled&&i.Util.canControlGiveSpeakPermission()}},{key:"mount",value:function e(t){this.container=t;this.container.appendChild(this.render());this.scheduleDismount()}},{key:"updatePermissionButtonState",value:function e(){this.isShowAllowPermissionButton=this._canChangeSpeakPermission();if(this.elements){BX.remove(this.elements.root);this.elements.root=null}this.container.appendChild(this.render())}},{key:"dismount",value:function e(){if(this.elements){BX.remove(this.elements.root)}this.destroy()}},{key:"onCloseClicked",value:function e(t){t.stopPropagation();if(this.isShowAllowPermissionButton){this.callbacks.onDisallowSpeakPermissionClicked(this.userModel)}this.dismount()}},{key:"dismountWithAnimation",value:function e(){var t=this;if(!this.elements.root){return}this.elements.root.classList.add("closing");this.elements.root.addEventListener("animationend",(function(){return t.dismount()}))}},{key:"render",value:function e(){if(this.elements.root){return this.elements.root}this.elements.root=p.Dom.create("div",{props:{className:"bx-call-view-floor-request-notification"},children:[p.Dom.create("div",{props:{className:"bx-call-view-floor-request-notification-icon-container"},children:[this.elements.avatar=p.Dom.create("div",{props:{className:"bx-call-view-floor-request-notification-avatar"},text:""}),p.Dom.create("div",{props:{className:"bx-call-view-floor-request-notification-icon bx-messenger-videocall-floor-request-icon"}})]}),this.elements.name=p.Dom.create("span",{props:{className:"bx-call-view-floor-request-notification-text-container"},html:BX.message("IM_CALL_WANTS_TO_SAY_"+(this.userModel.gender=="F"?"F":"M")).replace("#NAME#",'<span class ="bx-call-view-floor-request-notification-text-name">'+BX.util.htmlspecialchars(this.userModel.name)+"</span>")}),this.isShowAllowPermissionButton?this.createAllowPermissionButton():null,p.Dom.create("div",{props:{className:"bx-call-view-floor-request-notification-close"},events:{click:this.onCloseClicked.bind(this)}})]});if(this.userModel.avatar){this.elements.avatar.style.setProperty("--avatar","url('"+this.userModel.avatar+"')");this.elements.avatar.innerText=""}else{this.elements.avatar.style.setProperty("--avatar-background","var(--call-view__floor-request-notification-avatar-background-color)");this.elements.avatar.innerText=u.Utils.text.getFirstLetters(this.userModel.name).toUpperCase()}return this.elements.root}},{key:"scheduleDismount",value:function e(){return;this._hideTimeout=setTimeout(this.dismountWithAnimation.bind(this),this.hideTime*1e3)}},{key:"createAllowPermissionButton",value:function e(){var t=this;return new BX.UI.Button({baseClass:"ui-btn ui-btn-icon-mic",text:BX.message("CALL_RAISE_HAND_NOTIFY_ALLOW"),size:BX.UI.Button.Size.EXTRA_SMALL,color:BX.UI.Button.Color.LIGHT_BORDER,noCaps:true,round:true,events:{click:function e(){t._allowPermissionHandler()}}}).render()}},{key:"_allowPermissionHandler",value:function e(){this.callbacks.onAllowSpeakPermissionClicked(this.userModel);this.dismount()}},{key:"_onUserModelChanged",value:function e(t){var i=t.data;if(i.fieldName=="floorRequestState"&&!this.userModel.floorRequestState){this.dismountWithAnimation()}if(this.userModel.avatar===""&&this.elements.avatar){this.elements.avatar.innerText=u.Utils.text.getFirstLetters(this.userModel.name).toUpperCase()}if(this.elements.name){this.elements.name.innerHtml=BX.message("IM_CALL_WANTS_TO_SAY_"+(this.userModel.gender=="F"?"F":"M")).replace("#NAME#",'<span class ="bx-call-view-floor-request-notification-text-name">'+BX.util.htmlspecialchars(this.userModel.name)+"</span>")}}},{key:"destroy",value:function e(){this.callbacks.onDestroy();clearTimeout(this._hideTimeout);this._hideTimeout=null;this.elements=null;if(this.userModel){this.userModel.unsubscribe("changed",this._onUserModelChangedHandler);this.userModel=null}this.emit("onDestroy",{})}}],[{key:"create",value:function e(i){return new t(i)}}]);return t}(f.EventEmitter);var ln=5;var cn;var un=function(){function e(){babelHelpers.classCallCheck(this,e);this.maxNotification=ln;this.notifications=[]}babelHelpers.createClass(e,[{key:"addNotification",value:function e(t){var i=this;t.subscribe("onDestroy",(function(){return i.onNotificationDestroy(t)}));this.notifications.push(t);if(this.notifications.length>this.maxNotification){var n=this.notifications.shift();n.dismount()}}},{key:"onNotificationDestroy",value:function e(t){var i=this.notifications.indexOf(t);if(i!=-1){this.notifications.splice(i,1)}}}],[{key:"Instance",get:function t(){if(!cn){cn=new e}return cn}}]);return e}();var dn={onMicrophoneSelect:"onMicrophoneSelect",onMicrophoneSwitch:"onMicrophoneSwitch",onCameraSelect:"onCameraSelect",onCameraSwitch:"onCameraSwitch",onSpeakerSelect:"onSpeakerSelect",onSpeakerSwitch:"onSpeakerSwitch",onChangeHdVideo:"onChangeHdVideo",onChangeMicAutoParams:"onChangeMicAutoParams",onChangeFaceImprove:"onChangeFaceImprove",onChangeVideoQuality:"onChangeVideoQuality",onAdvancedSettingsClick:"onOpenAdvancedSettingsClick",onShow:"onShow",onDestroy:"onDestroy"};var hn=function(){function e(t){var i=this;babelHelpers.classCallCheck(this,e);this.viewElement=t.viewElement||null;this.parentElement=t.parentElement;this.zIndex=t.zIndex;this.cameraEnabled=BX.prop.getBoolean(t,"cameraEnabled",false);this.cameraId=BX.prop.getString(t,"cameraId",false);this.microphoneEnabled=BX.prop.getBoolean(t,"microphoneEnabled",false);this.microphoneId=BX.prop.getString(t,"microphoneId",false);this.speakerEnabled=BX.prop.getBoolean(t,"speakerEnabled",false);this.speakerId=BX.prop.getString(t,"speakerId",false);this.allowHdVideo=BX.prop.getBoolean(t,"allowHdVideo",false);this.faceImproveEnabled=BX.prop.getBoolean(t,"faceImproveEnabled",false);this.allowFaceImprove=BX.prop.getBoolean(t,"allowFaceImprove",false);this.allowBackground=BX.prop.getBoolean(t,"allowBackground",true);this.allowMask=BX.prop.getBoolean(t,"allowMask",true);this.allowAdvancedSettings=BX.prop.getBoolean(t,"allowAdvancedSettings",false);this.switchCameraBlocked=t.switchCameraBlocked||false;this.switchMicrophoneBlocked=t.switchMicrophoneBlocked||false;this.isDestroying=false;this.isCameraWasEnabledBeforeQualityChanged=false;this.popup=null;this.eventEmitter=new BX.Event.EventEmitter(this,"DeviceSelector");this.elements={root:null,micContainer:null,cameraContainer:null,speakerContainer:null};var n=BX.prop.getObject(t,"events",{});Object.values(dn).forEach((function(e){if(n[e]){i.eventEmitter.subscribe(e,n[e])}}))}babelHelpers.createClass(e,[{key:"show",value:function e(){var t=this;this.isCameraWasEnabledBeforeQualityChanged=H.isCameraOn;if(this.popup){this.popup.show();return}this.popup=new v.Popup({id:"call-view-device-selector",className:"call-view-device-selector-popup",background:"#00428F",contentBackground:"#00428F",darkMode:true,contentBorderRadius:"6px",borderRadius:"6px",bindElement:this.parentElement,targetContainer:this.viewElement,autoHide:true,zIndex:this.zIndex,closeByEsc:true,angle:false,overlay:{backgroundColor:"#22272B",opacity:0},content:this.render(),events:{onPopupClose:function e(){return t.popup.destroy()},onPopupDestroy:function e(){return t.destroy()}}});this.popup.show();this.eventEmitter.emit(dn.onShow,{})}},{key:"render",value:function e(){var t=this;if(this.elements.root){return this.elements.root}return p.Dom.create("div",{props:{className:"bx-call-view-device-selector"},children:[p.Dom.create("div",{props:{className:"bx-call-view-device-selector-top"},children:[(this.microphoneContainer=vn.create({blocked:this.switchMicrophoneBlocked,deviceLabel:BX.message("IM_M_CALL_BTN_MIC"),deviceList:H.getMicrophoneList(),selectedDevice:this.microphoneId,deviceEnabled:this.microphoneEnabled,icons:["microphone","microphone-off"],events:{onSwitch:this.onMicrophoneSwitch.bind(this),onSelect:this.onMicrophoneSelect.bind(this)}})).render(),(this.cameraContainer=vn.create({blocked:this.switchCameraBlocked,deviceLabel:BX.message("IM_M_CALL_BTN_CAMERA"),deviceList:H.getCameraList(),selectedDevice:this.cameraId,deviceEnabled:this.cameraEnabled,icons:["camera","camera-off"],events:{onSwitch:this.onCameraSwitch.bind(this),onSelect:this.onCameraSelect.bind(this),onChangeVideoQuality:this.onVideoQualityChanged.bind(this)}})).render(),H.canSelectSpeaker()?vn.create({deviceLabel:BX.message("IM_M_CALL_BTN_SPEAKER"),deviceList:H.getSpeakerList(),selectedDevice:this.speakerId,deviceEnabled:this.speakerEnabled,icons:["speaker","speaker-off"],events:{onSwitch:this.onSpeakerSwitch.bind(this),onSelect:this.onSpeakerSelect.bind(this)}}).render():null]}),p.Dom.create("div",{props:{className:"bx-call-view-device-selector-bottom"},children:[p.Dom.create("div",{props:{className:"bx-call-view-device-selector-bottom-item"},children:[p.Dom.create("input",{props:{id:"device-selector-hd-video",className:"bx-call-view-device-selector-bottom-item-checkbox"},attrs:{type:"checkbox",checked:this.allowHdVideo},events:{change:this.onAllowHdVideoChange.bind(this)}}),p.Dom.create("div",{props:{className:"bx-call-view-device-selector-bottom-item-checkbox-checked"}}),p.Dom.create("label",{props:{className:"bx-call-view-device-selector-bottom-item-label"},attrs:{for:"device-selector-hd-video"},text:BX.message("IM_M_CALL_HD_VIDEO")})]}),this.allowFaceImprove?p.Dom.create("div",{props:{className:"bx-call-view-device-selector-bottom-item"},children:[p.Dom.create("input",{props:{id:"device-selector-mic-auto-params",className:"bx-call-view-device-selector-bottom-item-checkbox"},attrs:{type:"checkbox",checked:this.faceImproveEnabled},events:{change:this.onFaceImproveChange.bind(this)}}),p.Dom.create("label",{props:{className:"bx-call-view-device-selector-bottom-item-label"},attrs:{for:"device-selector-mic-auto-params"},text:BX.message("IM_SETTINGS_HARDWARE_CAMERA_FACE_IMPROVE")})]}):null,this.allowBackground?p.Dom.create("div",{props:{className:"bx-call-view-device-selector-bottom-item"},children:[p.Dom.create("span",{props:{className:"bx-call-view-device-selector-bottom-item-action"},text:this.allowMask?BX.message("IM_M_CALL_BG_MASK_CHANGE"):BX.message("IM_M_CALL_BACKGROUND_CHANGE"),events:{click:function e(){T.open();t.popup.close()}}})]}):null,p.Dom.create("div",{props:{className:"bx-call-view-device-selector-bottom-item"},children:[p.Dom.create("span",{props:{className:"bx-call-view-device-selector-bottom-item-action"},text:BX.message("CALL_RUN_SELF_TEST"),events:{click:function e(){Yf.startSelfTest();t.popup.close()}}})]}),this.allowAdvancedSettings&&!!BX.MessengerCommon?p.Dom.create("div",{props:{className:"bx-call-view-device-selector-bottom-item"},children:[p.Dom.create("span",{props:{className:"bx-call-view-device-selector-bottom-item-action"},text:BX.message("IM_M_CALL_ADVANCED_SETTINGS"),events:{click:function e(i){i.stopPropagation();t.eventEmitter.emit(dn.onAdvancedSettingsClick);t.popup.close()}}})]}):null]})]})}},{key:"toggleCameraAvailability",value:function e(t){if(t){this.cameraContainer.unblock();return}this.cameraContainer.block()}},{key:"toggleMicrophoneAvailability",value:function e(t){if(t){this.microphoneContainer.unblock();return}this.microphoneContainer.block()}},{key:"onMicrophoneSwitch",value:function e(){this.microphoneEnabled=!this.microphoneEnabled;this.eventEmitter.emit(dn.onMicrophoneSwitch,{microphoneEnabled:this.microphoneEnabled})}},{key:"onMicrophoneSelect",value:function e(t){this.eventEmitter.emit(dn.onMicrophoneSelect,{deviceId:t.data.deviceId})}},{key:"onCameraSwitch",value:function e(){this.cameraEnabled=!this.cameraEnabled;this.eventEmitter.emit(dn.onCameraSwitch,{cameraEnabled:this.cameraEnabled})}},{key:"onCameraSelect",value:function e(t){this.eventEmitter.emit(dn.onCameraSelect,{deviceId:t.data.deviceId})}},{key:"onVideoQualityChanged",value:function e(t){this.eventEmitter.emit(dn.onChangeVideoQuality,{videoQuality:t.data.videoQuality,isCameraWasEnabledBeforeQualityChanged:this.isCameraWasEnabledBeforeQualityChanged})}},{key:"onSpeakerSwitch",value:function e(){this.speakerEnabled=!this.speakerEnabled;this.eventEmitter.emit(dn.onSpeakerSwitch,{speakerEnabled:this.speakerEnabled})}},{key:"onSpeakerSelect",value:function e(t){this.eventEmitter.emit(dn.onSpeakerSelect,{deviceId:t.data.deviceId})}},{key:"onAllowHdVideoChange",value:function e(t){this.allowHdVideo=t.currentTarget.checked;this.eventEmitter.emit(dn.onChangeHdVideo,{allowHdVideo:this.allowHdVideo})}},{key:"onAllowMirroringVideoChange",value:function e(t){H.enableMirroring=t.target.checked}},{key:"onFaceImproveChange",value:function e(t){this.faceImproveEnabled=t.currentTarget.checked;this.eventEmitter.emit(dn.onChangeFaceImprove,{faceImproveEnabled:this.faceImproveEnabled})}},{key:"destroy",value:function e(){if(this.isDestroying){return}this.isDestroying=true;if(this.popup){this.popup.destroy();this.popup=null}this.eventEmitter.emit(dn.onDestroy,{})}}]);return e}();babelHelpers.defineProperty(hn,"Events",dn);var pn={onSelect:"onSelect",onSwitch:"onSwitch",onChangeVideoQuality:"onChangeVideoQuality"};var vn=function(){function e(t){babelHelpers.classCallCheck(this,e);t=BX.type.isObject(t)?t:{};this.menuBlocked=t.blocked||false;this.deviceList=BX.prop.getArray(t,"deviceList",[]);this.selectedDevice=BX.prop.getString(t,"selectedDevice","");this.deviceEnabled=BX.prop.getBoolean(t,"deviceEnabled",false);this.deviceLabel=BX.prop.getString(t,"deviceLabel","");this.icons=BX.prop.getArray(t,"icons",[]);this.eventEmitter=new f.EventEmitter(this,"DeviceMenu");this.elements={root:null,switchIcon:null,menuInner:null,menuItems:{}};this.currentBitrixCall=Yf.getCurrentBitrixCall();this.isShowVideoQuality=Yf.isStreamQualityFeatureEnabled()&&this.icons[0]==="camera"&&this.currentBitrixCall&&this.currentBitrixCall.provider!==Tc.Plain;var i=BX.prop.getObject(t,"events",{});for(var n in i){if(!i.hasOwnProperty(n)){continue}this.eventEmitter.subscribe(n,i[n])}}babelHelpers.createClass(e,[{key:"render",value:function e(){var t=this;if(this.elements.root){return this.elements.root}this.elements.root=p.Dom.create("div",{props:{className:"bx-call-view-device-selector-menu-container"},children:[p.Dom.create("div",{props:{className:"bx-call-view-device-selector-switch-wrapper"},children:[this.elements.switchIcon=p.Dom.create("div",{props:{className:"bx-call-view-device-selector-device-icon "+this.getDeviceIconClass()}}),p.Dom.create("span",{props:{className:"bx-call-view-device-selector-device-text"},text:this.deviceLabel}),p.Dom.create("div",{props:{className:"bx-call-view-device-selector-device-switch"},children:[new BX.UI.Switcher({size:"small",checked:this.deviceEnabled,handlers:{toggled:this.onSwitchToggled.bind(this)},disabled:this.menuBlocked}).getNode()]})]}),this.elements.menuInner=p.Dom.create("div",{props:{className:"bx-call-view-device-selector-menu-inner"+(this.menuBlocked?" inactive":"")},children:this.deviceList.map(this.renderDevice.bind(this))}),this.isShowVideoQuality?fn.create({title:BX.message("CALL_VIDEO_QUALITY_TITLE"),onVideoQualityChanged:function e(i){t.eventEmitter.emit(pn.onChangeVideoQuality,{videoQuality:i})},videoQualityList:[{label:BX.message("CALL_VIDEO_QUALITY_WITHOUT_VIDEO"),height:0,value:P.NO_VIDEO},{label:"180p",height:180,value:P.LOW},{label:"360p",height:360,value:P.MEDIUM},{label:"720p",height:720,value:P.HIGH}]}).render():null]});return this.elements.root}},{key:"renderDevice",value:function e(t){var i=this.selectedDevice===t.deviceId?"selected":"";var n={};n.root=p.Dom.create("div",{props:{className:"bx-call-view-device-selector-menu-item"},dataset:{deviceId:t.deviceId},children:[n.icon=p.Dom.create("div",{props:{className:"bx-call-view-device-selector-menu-item-icon "+i}}),p.Dom.create("div",{props:{className:"bx-call-view-device-selector-menu-item-text"},text:t.label||"("+BX.message("IM_M_CALL_DEVICE_NO_NAME")+")"})],events:{click:this.onMenuItemClick.bind(this)}});this.elements.menuItems[t.deviceId]=n;return n.root}},{key:"block",value:function e(){this.menuBlocked=true;this.elements.root.classList.add("bx-call-view-device-selector-menu-container-blocked")}},{key:"unblock",value:function e(){this.menuBlocked=false;this.elements.root.classList.remove("bx-call-view-device-selector-menu-container-blocked")}},{key:"getDeviceIconClass",value:function e(){var t="";if(this.deviceEnabled&&this.icons.length>0){t=this.icons[0]}else if(!this.deviceEnabled&&this.icons.length>1){t=this.icons[1]}return t}},{key:"onSwitchToggled",value:function e(){if(this.menuBlocked){return}this.deviceEnabled=!this.deviceEnabled;this.elements.switchIcon.className="bx-call-view-device-selector-device-icon "+this.getDeviceIconClass();this.eventEmitter.emit(pn.onSwitch,{deviceEnabled:this.deviceEnabled})}},{key:"onMenuItemClick",value:function e(t){var i=this.selectedDevice;var n=t.currentTarget.dataset.deviceId;this.selectedDevice=n;if(this.elements.menuItems[i]){this.elements.menuItems[i]["icon"].classList.remove("selected")}if(this.elements.menuItems[this.selectedDevice]){this.elements.menuItems[this.selectedDevice]["icon"].classList.add("selected")}this.eventEmitter.emit(pn.onSelect,{deviceId:this.selectedDevice})}}],[{key:"create",value:function t(i){return new e(i)}}]);return e}();var fn=function(){function e(t){babelHelpers.classCallCheck(this,e);t=BX.type.isObject(t)?t:{};this.id=BX.prop.getString(t,"id",Math.random().toString(16).slice(2));this.title=BX.prop.getString(t,"title","");this.videoQualityList=BX.prop.getArray(t,"videoQualityList",[]);this.currentVideoQualityIndex=this.videoQualityList.findIndex((function(e){return e.height===H.maxLocalStreamQualityHeight}));this.inputId="video_quality_values_"+this.id;this.callbacks={onVideoQualityChanged:BX.prop.getFunction(t,"onVideoQualityChanged",BX.DoNothing)};this.elements={root:null}}babelHelpers.createClass(e,[{key:"renderRangeItem",value:function e(t){return p.Dom.create("option",{props:{className:"bx-call-view-video-quality-datalist-option",value:t.value,label:t.label}})}},{key:"onVideoQualityChange",value:function e(t){this.currentVideoQualityIndex=t.target.value;this.callbacks.onVideoQualityChanged(this.videoQualityList[this.currentVideoQualityIndex].value)}},{key:"render",value:function e(){var t;if(this.elements.root){return this.elements.root}if(!this.videoQualityList.length){return null}this.elements.root=p.Dom.create("div",{props:{className:"bx-call-view-video-quality-container"},children:[p.Dom.create("div",{props:{className:"bx-call-view-video-quality-title"},children:[p.Dom.create("div",{props:{className:"bx-call-view-video-quality-title-icon"}}),p.Dom.create("span",{props:{className:"bx-call-view-video-quality-title-text"},text:this.title})]}),p.Dom.create("div",{props:{className:"bx-call-view-video-quality"},children:[this.elements.input=p.Dom.create("input",{props:{className:"bx-call-view-video-quality-input",id:"bx-call-view-video-quality-input",type:"range",step:1,value:this.currentVideoQualityIndex,min:0,max:((t=this.videoQualityList)===null||t===void 0?void 0:t.length)-1||1}}),p.Dom.create("datalist",{props:{className:"bx-call-view-video-quality-datalist",id:this.inputId},children:this.videoQualityList.map(this.renderRangeItem.bind(this))})]})],events:{change:this.onVideoQualityChange.bind(this)}});this.elements.input.setAttribute("list",this.inputId);return this.elements.root}}],[{key:"create",value:function t(i){return new e(i)}}]);return e}();var mn={COPILOT_ENABLED:"COPILOT_ENABLED",COPILOT_DISABLED:"COPILOT_DISABLED",COPILOT_RESULT:"COPILOT_RESULT",AI_UNAVAILABLE_ERROR:"AI_UNAVAILABLE_ERROR",AI_SETTINGS_ERROR:"AI_SETTINGS_ERROR",AI_AGREEMENT_ERROR:"AI_AGREEMENT_ERROR",AI_NOT_ENOUGH_BAAS_ERROR:"AI_NOT_ENOUGH_BAAS_ERROR",AI_MODULE_ERROR:"AI_MODULE_ERROR",ENABLE_AI_INTERNAL_ERROR:"ENABLE_AI_INTERNAL_ERROR",DISABLE_AI_INTERNAL_ERROR:"DISABLE_AI_INTERNAL_ERROR"};var gn=function(){function e(t){babelHelpers.classCallCheck(this,e);this.callId=t.callId||0;this.type=t.type||"";this.code=t.code||"";this.popup=null;this.notifyText="";this.promoId="";this.popupTemplate=null;this.bindElement=t.bindElement;this.notifyColor="";this.callbacks={onClose:BX.type.isFunction(t.onClose)?t.onClose:BX.DoNothing}}babelHelpers.createClass(e,[{key:"getPopupTemplate",value:function e(){var t=this;if(!this.notifyText){this.popupTemplate=null}this.popupTemplate=p.Dom.create("div",{props:{className:"bx-call-copilot-notify__content"},children:[p.Dom.create("div",{props:{className:"bx-call-copilot-notify__icon"}}),p.Dom.create("div",{props:{className:"bx-call-copilot-notify__message"},text:this.notifyText}),p.Dom.create("button",{props:{className:"bx-call-copilot-notify__close-btn"},events:{click:function e(){t.close()}}})]})}},{key:"setAdditionalInformation",value:function e(){switch(this.type){case mn.COPILOT_ENABLED:this.notifyText=p.Loc.getMessage("CALL_POPUP_WARNING_ENABLED");this.promoId="call:copilot-notify-warning:21112024:all";this.notifyColor="#8E52EC";break;case mn.COPILOT_DISABLED:this.notifyText=p.Loc.getMessage("CALL_POPUP_PROMO_ENABLED");this.promoId="call:copilot-notify-promo:21112024:all";this.notifyColor="#8E52EC";break;case mn.COPILOT_RESULT:this.notifyText=p.Loc.getMessage("CALL_POPUP_RESULT_WARNING");this.promoId="call:copilot-notify-result:24112024:all";this.notifyColor="#8E52EC";break;case mn.AI_UNAVAILABLE_ERROR:this.notifyText=p.Loc.getMessage("CALL_POPUP_AI_UNAVAILABLE_ERROR");this.notifyColor="#FF5752";break;case mn.AI_MODULE_ERROR:this.notifyText=p.Loc.getMessage("CALL_POPUP_AI_MODULE_ERROR").replace("#ERROR_CODE#",this.code);this.notifyColor="#FF5752";break;case mn.AI_SETTINGS_ERROR:this.notifyText=p.Loc.getMessage("CALL_POPUP_AI_SETTINGS_ERROR");this.notifyColor="#FF5752";break;case mn.AI_AGREEMENT_ERROR:this.notifyText=p.Loc.getMessage("CALL_POPUP_AI_AGREEMENT_ERROR");this.notifyColor="#FF5752";break;case mn.AI_NOT_ENOUGH_BAAS_ERROR:this.notifyText=p.Loc.getMessage("CALL_POPUP_AI_NOT_ENOUGH_BAAS_ERROR");this.notifyColor="#FF5752";break;case mn.ENABLE_AI_INTERNAL_ERROR:this.notifyText=p.Loc.getMessage("CALL_POPUP_ENABLE_AI_INTERNAL_ERROR").replace("#ERROR_CODE#",this.code);this.notifyColor="#FF5752";break;case mn.DISABLE_AI_INTERNAL_ERROR:this.notifyText=p.Loc.getMessage("CALL_POPUP_DISABLE_AI_INTERNAL_ERROR").replace("#ERROR_CODE#",this.code);this.notifyColor="#FF5752";break;default:this.notifyText=p.Loc.getMessage("CALL_POPUP_AI_DEFAULT_TEXT");this.notifyColor="#FF5752";break}}},{key:"create",value:function e(){var t=this;this.getPopupTemplate();if(!this.bindElement||!this.popupTemplate){return}this.popup=new v.Popup({className:"bx-call-copilot-notify",bindElement:this.bindElement,targetContainer:document.body,content:this.popupTemplate,bindOptions:{position:"top"},padding:0,contentBorderRadius:"1024px",background:this.notifyColor,contentBackground:this.notifyColor,darkMode:true,contentNoPaddings:true,animation:"fading",autoHide:true,events:{onPopupClose:function e(){t.callbacks.onClose();t.popup.destroy()},onPopupDestroy:function e(){t.popup=null},onShow:function e(){var i=t.popup.getPopupContainer().offsetWidth;var n=t.popup.bindElement.offsetWidth;var a=7;t.popup.setOffset({offsetLeft:n-a-i/2});t.popup.setAngle({offset:i/2,position:"bottom"});t.popup.adjustPosition()},onClose:function e(){if(t.promoId){n.PromoManager.getInstance().markAsWatched(t.promoId)}}}})}},{key:"show",value:function e(){this.close();this.setAdditionalInformation();if(this.promoId&&!n.PromoManager.getInstance().needToShow(this.promoId)){return}this.create();if(this.type===mn.COPILOT_ENABLED||this.type===mn.COPILOT_DISABLED){h.Analytics.getInstance().copilot.onCopilotNotifyShow({isCopilotActive:this.type===mn.COPILOT_ENABLED,callId:this.callId})}if(this.popup){this.popup.show()}}},{key:"close",value:function e(){if(this.popup){this.popup.close()}}}]);return e}();var bn={AI_MODULE_ERROR:"AI_MODULE_ERROR",AI_UNAVAILABLE_ERROR:"AI_UNAVAILABLE_ERROR",AI_SETTINGS_ERROR:"AI_SETTINGS_ERROR",AI_AGREEMENT_ERROR:"AI_AGREEMENT_ERROR",AI_NOT_ENOUGH_BAAS_ERROR:"AI_NOT_ENOUGH_BAAS_ERROR",AI_MARKET_SUBSCRIPTION:"AI_MARKET_SUBSCRIPTION"};var Cn=function(){function e(){babelHelpers.classCallCheck(this,e);this.serviceEnabled=false;this.settingsEnabled=false;this.recordingMinUsers=1e3;this.agreementAccepted=false;this.tariffAvailable=false;this.baasAvailable=false;this.feedBackLink="";this.baasPromoSlider="";this.helpSlider="";this.disclaimerArticleCode="";this.marketSubscriptionEnabled=false;this.marketSubscriptionSlider="";if(p.Extension.getSettings("call.core").ai){this.setup(p.Extension.getSettings("call.core").ai)}}babelHelpers.createClass(e,[{key:"setup",value:function e(t){if(t.serviceEnabled!==undefined){this.serviceEnabled=t.serviceEnabled}if(t.settingsEnabled!==undefined){this.settingsEnabled=t.settingsEnabled}if(t.recordingMinUsers){this.recordingMinUsers=t.recordingMinUsers}if(t.agreementAccepted!==undefined){this.agreementAccepted=t.agreementAccepted}if(t.tariffAvailable!==undefined){this.tariffAvailable=t.tariffAvailable}if(t.baasAvailable!==undefined){this.baasAvailable=t.baasAvailable}if(t.feedBackLink){this.feedBackLink=t.feedBackLink}if(t.baasPromoSlider){this.baasPromoSlider=t.baasPromoSlider}if(t.helpSlider){this.helpSlider=t.helpSlider}if(t.disclaimerArticleCode){this.disclaimerArticleCode=t.disclaimerArticleCode}if(t.marketSubscriptionEnabled){this.marketSubscriptionEnabled=t.marketSubscriptionEnabled}if(t.marketSubscriptionSlider){this.marketSubscriptionSlider=t.marketSubscriptionSlider}}},{key:"handleCopilotError",value:function e(t){switch(t){case bn.AI_UNAVAILABLE_ERROR:this.tariffAvailable=false;break;case bn.AI_MODULE_ERROR:case bn.AI_SETTINGS_ERROR:this.settingsEnabled=false;break;case bn.AI_AGREEMENT_ERROR:this.agreementAccepted=false;break;case bn.AI_NOT_ENOUGH_BAAS_ERROR:this.baasAvailable=false;break;case bn.AI_MARKET_SUBSCRIPTION:this.marketSubscriptionEnabled=false;break;default:console.error("there are no such errorTypes");break}}},{key:"serviceEnabled",get:function e(){return this._serviceEnabled},set:function e(t){this._serviceEnabled=t}},{key:"settingsEnabled",get:function e(){return this._settingsEnabled},set:function e(t){this._settingsEnabled=t}},{key:"recordingMinUsers",get:function e(){return this._recordingMinUsers},set:function e(t){this._recordingMinUsers=t}},{key:"agreementAccepted",get:function e(){return this._agreementAccepted},set:function e(t){this._agreementAccepted=t}},{key:"tariffAvailable",get:function e(){return this._tariffAvailable},set:function e(t){this._tariffAvailable=t}},{key:"baasAvailable",get:function e(){return this._baasAvailable},set:function e(t){this._baasAvailable=t}},{key:"feedBackLink",get:function e(){return this._feedBackLink},set:function e(t){this._feedBackLink=t}},{key:"baasPromoSlider",get:function e(){return this._baasPromoSlider},set:function e(t){this._baasPromoSlider=t}},{key:"helpSlider",get:function e(){return this._helpSlider},set:function e(t){this._helpSlider=t}},{key:"disclaimerArticleCode",get:function e(){return this._disclaimerArticleCode},set:function e(t){this._disclaimerArticleCode=t}},{key:"marketSubscriptionEnabled",get:function e(){return this._marketSubscriptionEnabled},set:function e(t){this._marketSubscriptionEnabled=t}},{key:"marketSubscriptionSlider",get:function e(){return this._marketSubscriptionSlider},set:function e(t){this._marketSubscriptionSlider=t}}]);return e}();var kn=new Cn;var yn=function(){function e(t){babelHelpers.classCallCheck(this,e);babelHelpers.defineProperty(this,"element",null);t=t||{};this.kind=t.kind||"video";if(t.track){this.stream=new MediaStream([t.track])}else{this.stream=null}}babelHelpers.createClass(e,[{key:"render",value:function e(t){if(!t.srcObject||!t.srcObject.active||t.srcObject.id!==this.stream.id){t.srcObject=this.stream}}},{key:"requestVideoSize",value:function e(){}}]);return e}();var Sn=function(){function e(){babelHelpers.classCallCheck(this,e)}babelHelpers.createClass(e,null,[{key:"isNotSupportDevicesListBeforeStream",get:function e(){return this.listOfDevicesBeforeStream.some((function(e){return e}))}},{key:"isPiPAvailable",get:function e(){return this.listOfPiPAvailable.some((function(e){return e}))}}]);return e}();babelHelpers.defineProperty(Sn,"listOfDevicesBeforeStream",[BX.browser.IsFirefox()]);babelHelpers.defineProperty(Sn,"listOfPiPAvailable",[BX.browser.IsChrome(),r.DesktopApi.isDesktop()]);function wn(){/*! regenerator-runtime -- Copyright (c) 2014-present, Facebook, Inc. -- license (MIT): https://github.com/facebook/regenerator/blob/main/LICENSE */wn=function t(){return e};var e={},t=Object.prototype,i=t.hasOwnProperty,n=Object.defineProperty||function(e,t,i){e[t]=i.value},a="function"==typeof Symbol?Symbol:{},s=a.iterator||"@@iterator",r=a.asyncIterator||"@@asyncIterator",o=a.toStringTag||"@@toStringTag";function l(e,t,i){return Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{l({},"")}catch(e){l=function e(t,i,n){return t[i]=n}}function c(e,t,i,a){var s=t&&t.prototype instanceof h?t:h,r=Object.create(s.prototype),o=new T(a||[]);return n(r,"_invoke",{value:y(e,i,o)}),r}function u(e,t,i){try{return{type:"normal",arg:e.call(t,i)}}catch(e){return{type:"throw",arg:e}}}e.wrap=c;var d={};function h(){}function p(){}function v(){}var f={};l(f,s,(function(){return this}));var m=Object.getPrototypeOf,g=m&&m(m(P([])));g&&g!==t&&i.call(g,s)&&(f=g);var b=v.prototype=h.prototype=Object.create(f);function C(e){["next","throw","return"].forEach((function(t){l(e,t,(function(e){return this._invoke(t,e)}))}))}function k(e,t){function a(n,s,r,o){var l=u(e[n],e,s);if("throw"!==l.type){var c=l.arg,d=c.value;return d&&"object"==babelHelpers["typeof"](d)&&i.call(d,"__await")?t.resolve(d.__await).then((function(e){a("next",e,r,o)}),(function(e){a("throw",e,r,o)})):t.resolve(d).then((function(e){c.value=e,r(c)}),(function(e){return a("throw",e,r,o)}))}o(l.arg)}var s;n(this,"_invoke",{value:function e(i,n){function r(){return new t((function(e,t){a(i,n,e,t)}))}return s=s?s.then(r,r):r()}})}function y(e,t,i){var n="suspendedStart";return function(a,s){if("executing"===n)throw new Error("Generator is already running");if("completed"===n){if("throw"===a)throw s;return _()}for(i.method=a,i.arg=s;;){var r=i.delegate;if(r){var o=S(r,i);if(o){if(o===d)continue;return o}}if("next"===i.method)i.sent=i._sent=i.arg;else if("throw"===i.method){if("suspendedStart"===n)throw n="completed",i.arg;i.dispatchException(i.arg)}else"return"===i.method&&i.abrupt("return",i.arg);n="executing";var l=u(e,t,i);if("normal"===l.type){if(n=i.done?"completed":"suspendedYield",l.arg===d)continue;return{value:l.arg,done:i.done}}"throw"===l.type&&(n="completed",i.method="throw",i.arg=l.arg)}}}function S(e,t){var i=t.method,n=e.iterator[i];if(undefined===n)return t.delegate=null,"throw"===i&&e.iterator["return"]&&(t.method="return",t.arg=undefined,S(e,t),"throw"===t.method)||"return"!==i&&(t.method="throw",t.arg=new TypeError("The iterator does not provide a '"+i+"' method")),d;var a=u(n,e.iterator,t.arg);if("throw"===a.type)return t.method="throw",t.arg=a.arg,t.delegate=null,d;var s=a.arg;return s?s.done?(t[e.resultName]=s.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=undefined),t.delegate=null,d):s:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,d)}function w(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function I(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function T(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(w,this),this.reset(!0)}function P(e){if(e){var t=e[s];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var n=-1,a=function t(){for(;++n<e.length;)if(i.call(e,n))return t.value=e[n],t.done=!1,t;return t.value=undefined,t.done=!0,t};return a.next=a}}return{next:_}}function _(){return{value:undefined,done:!0}}return p.prototype=v,n(b,"constructor",{value:v,configurable:!0}),n(v,"constructor",{value:p,configurable:!0}),p.displayName=l(v,o,"GeneratorFunction"),e.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===p||"GeneratorFunction"===(t.displayName||t.name))},e.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,v):(e.__proto__=v,l(e,o,"GeneratorFunction")),e.prototype=Object.create(b),e},e.awrap=function(e){return{__await:e}},C(k.prototype),l(k.prototype,r,(function(){return this})),e.AsyncIterator=k,e.async=function(t,i,n,a,s){void 0===s&&(s=Promise);var r=new k(c(t,i,n,a),s);return e.isGeneratorFunction(i)?r:r.next().then((function(e){return e.done?e.value:r.next()}))},C(b),l(b,o,"Generator"),l(b,s,(function(){return this})),l(b,"toString",(function(){return"[object Generator]"})),e.keys=function(e){var t=Object(e),i=[];for(var n in t)i.push(n);return i.reverse(),function e(){for(;i.length;){var n=i.pop();if(n in t)return e.value=n,e.done=!1,e}return e.done=!0,e}},e.values=P,T.prototype={constructor:T,reset:function e(t){if(this.prev=0,this.next=0,this.sent=this._sent=undefined,this.done=!1,this.delegate=null,this.method="next",this.arg=undefined,this.tryEntries.forEach(I),!t)for(var n in this)"t"===n.charAt(0)&&i.call(this,n)&&!isNaN(+n.slice(1))&&(this[n]=undefined)},stop:function e(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function e(t){if(this.done)throw t;var n=this;function a(e,i){return o.type="throw",o.arg=t,n.next=e,i&&(n.method="next",n.arg=undefined),!!i}for(var s=this.tryEntries.length-1;s>=0;--s){var r=this.tryEntries[s],o=r.completion;if("root"===r.tryLoc)return a("end");if(r.tryLoc<=this.prev){var l=i.call(r,"catchLoc"),c=i.call(r,"finallyLoc");if(l&&c){if(this.prev<r.catchLoc)return a(r.catchLoc,!0);if(this.prev<r.finallyLoc)return a(r.finallyLoc)}else if(l){if(this.prev<r.catchLoc)return a(r.catchLoc,!0)}else{if(!c)throw new Error("try statement without catch or finally");if(this.prev<r.finallyLoc)return a(r.finallyLoc)}}}},abrupt:function e(t,n){for(var a=this.tryEntries.length-1;a>=0;--a){var s=this.tryEntries[a];if(s.tryLoc<=this.prev&&i.call(s,"finallyLoc")&&this.prev<s.finallyLoc){var r=s;break}}r&&("break"===t||"continue"===t)&&r.tryLoc<=n&&n<=r.finallyLoc&&(r=null);var o=r?r.completion:{};return o.type=t,o.arg=n,r?(this.method="next",this.next=r.finallyLoc,d):this.complete(o)},complete:function e(t,i){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&i&&(this.next=i),d},finish:function e(t){for(var i=this.tryEntries.length-1;i>=0;--i){var n=this.tryEntries[i];if(n.finallyLoc===t)return this.complete(n.completion,n.afterLoc),I(n),d}},catch:function e(t){for(var i=this.tryEntries.length-1;i>=0;--i){var n=this.tryEntries[i];if(n.tryLoc===t){var a=n.completion;if("throw"===a.type){var s=a.arg;I(n)}return s}}throw new Error("illegal catch attempt")},delegateYield:function e(t,i,n){return this.delegate={iterator:P(t),resultName:i,nextLoc:n},"next"===this.method&&(this.arg=undefined),d}},e}var In=function(){function e(t){babelHelpers.classCallCheck(this,e);this.pictureWindow=null;this.template=null;this.userPanel=null;this.actionsPanel=null;this.notificationPanel=null;this.buttons={microphone:null,camera:null,returnToCall:null,stopScreen:null,copilot:null};this.preferInitialWindowPlacement=t.preferInitialWindowPlacement;this.user=null;this.userData=t.currentUser;this.buttons=t.buttons||[];this.blockedButtons=t.blockedButtons||[];this.previousFloorRequestNotifications=t.floorRequestNotifications||[];this.callbacks={onButtonClick:BX.type.isFunction(t.onButtonClick)?t.onButtonClick:BX.DoNothing,onClose:BX.type.isFunction(t.onClose)?t.onClose:BX.DoNothing};this.eventEmitter=new f.EventEmitter(this,"BX.Call.View");this.isMinHeight=false;this.isMinWidth=false;this.floorRequestElements={counter:null,mainNotification:null,popup:null,popupTemplate:null};this.floorRequestsList=[];this.floorRequestTimeForHidden=5e3;this.floorRequestTimeout=null;this.baseWidthPopup=244}babelHelpers.createClass(e,[{key:"_onButtonClick",value:function e(t){var i=t.buttonName,n=t.event;this.callbacks.onButtonClick({buttonName:i,event:n})}},{key:"setUserMedia",value:function e(t,i){if(!this.user||+t!==this.user.userModel.id){return}this.user.videoTrack=i}},{key:"setStats",value:function e(t,i){if(!this.user||+t!==this.user.userModel.id){return}this.user.showStats(i)}},{key:"showFloorRequestNotification",value:function e(t){var i=on.create({userModel:t});i.mount(this.notificationPanel)}},{key:"setVideoRenderer",value:function e(t,i){if(!this.user||+t!==this.user.userModel.id){return}this.user.videoRenderer=i}},{key:"releaseLocalStream",value:function e(t){if(!this.user||+t!==this.user.userModel.id){return}this.user.releaseStream()}},{key:"setCurrentUser",value:function e(t){if(!t){return}this.userData=t;var i=!!this.user;var n=this.userData.userModel.id===this.user.userModel.id;if(i&&!n){this.destroyCurrentUser()}if(!i||!n){this.renderUserPanel()}}},{key:"destroyCurrentUser",value:function e(){if(!this.user){return}this.user.dismount();this.user.destroy();this.user=null}},{key:"getCurrentUserId",value:function e(){var t;return((t=this.user)===null||t===void 0?void 0:t.userModel.id)||null}},{key:"isButtonBlocked",value:function e(t){return this.blockedButtons.includes(t)}},{key:"updateBlockButtons",value:function e(t){this.blockedButtons=t;return this}},{key:"setButtons",value:function e(t){this.buttons=t;return this}},{key:"updateButtons",value:function e(){p.Dom.clean(this.actionsPanel);this.renderButtons()}},{key:"getButtonTextBySizePictureWindow",value:function e(t){return this.isMinHeight||this.isMinWidth?"":t}},{key:"renderButtons",value:function e(){var t=this;if(!this.actionsPanel&&this.buttons.length){this.actionsPanel=p.Dom.create("div",{props:{className:"bx-call-picture-in-picture-window__actions"}})}for(var i=0;i<this.buttons.length;i++){switch(this.buttons[i]){case"microphone":this.buttons.microphone=new qi({class:"microphone",backgroundClass:"bx-call-picture-in-picture-window__button-background",text:this.getButtonTextBySizePictureWindow(BX.message("IM_M_CALL_BTN_MIC")),enabled:!H.isMicrophoneMuted,arrowHidden:true,arrowEnabled:false,showPointer:true,blocked:this.isButtonBlocked("microphone"),showLevel:true,sideIcon:null,onClick:function e(i){i.stopPropagation();t._onButtonClick({buttonName:"microphone",event:i})}});this.actionsPanel.appendChild(this.buttons.microphone.render());break;case"camera":this.buttons.camera=new qi({class:"camera",backgroundClass:"bx-call-picture-in-picture-window__button-background",text:this.getButtonTextBySizePictureWindow(BX.message("IM_M_CALL_BTN_CAMERA")),enabled:H.isCameraOn,arrowHidden:true,blocked:this.isButtonBlocked("camera"),onClick:function e(i){i.stopPropagation();t._onButtonClick({buttonName:"camera",event:i})}});this.actionsPanel.appendChild(this.buttons.camera.render());break;case"returnToCall":this.buttons.returnToCall=new ji({class:"go-to-call",backgroundClass:"bx-call-picture-in-picture-window__button-background bx-messenger-videocall-panel-icon-background-go-to-call",text:this.getButtonTextBySizePictureWindow(BX.message("CALL_BUTTON_GO_TO_CALL")),onClick:function e(i){i.stopPropagation();t._onButtonClick({buttonName:"returnToCall",event:i});window.focus()}});this.actionsPanel.appendChild(this.buttons.returnToCall.render());break;case"stop-screen":this.buttons.stopScreen=new ji({class:"stop-screen",backgroundClass:"bx-call-picture-in-picture-window__button-background",text:this.getButtonTextBySizePictureWindow(BX.message("CALL_BUTTON_STOP_SCREEN")),blocked:this.isButtonBlocked("screen"),onClick:function e(i){i.stopPropagation();t._onButtonClick({buttonName:"stop-screen",event:i});window.focus()}});this.actionsPanel.appendChild(this.buttons.stopScreen.render());break;default:break}}}},{key:"renderUserPanel",value:function e(){var t=this;if(!this.userPanel){this.userPanel=p.Dom.create("div",{props:{className:"bx-call-picture-in-picture-window__user"}})}if(!this.user){this.user=new rn({parentContainer:this.userPanel,userModel:this.userData.userModel,avatarBackground:this.userData.avatarBackground,allowPinButton:false,allowBackgroundItem:false,allowMaskItem:false,alwaysShowName:true,flipVideo:this.userData.userModel.localUser,hiddenFloorRequest:true,hiddenRemoteParticipantButtonMenu:true,onClick:function e(i){t._onButtonClick({buttonName:"returnToCall",event:i});window.focus()}});this.user.mount(this.userPanel)}if(this.userData.previewRenderer){this.user.videoRenderer=this.userData.previewRenderer}if(this.userData.videoRenderer){this.user.videoRenderer=this.userData.videoRenderer}}},{key:"renderNotificationPanel",value:function e(){if(!this.notificationPanel){this.notificationPanel=p.Dom.create("div",{props:{className:"bx-call-picture-in-picture-window__notifications bx-messenger-videocall-notification-panel"}})}}},{key:"updateFloorRequestsList",value:function e(t){var i=t.floorRequestsList,n=t.user;if(i){this.floorRequestsList=babelHelpers.toConsumableArray(i.map((function(e){return{userModel:e.userModel,avatarBackgroundColor:e.avatarBackgroundColor,initials:u.Utils.text.getFirstLetters(e.userModel.name).toUpperCase()}})));this.updateFloorRequestCounter();return}if(!n){return}var a=this.floorRequestsList.findIndex((function(e){return e.userModel.id===n.userModel.id}));var s=a!==-1;var r=n.userModel.floorRequestState;if(s===r){return}if(r){this.floorRequestsList.push({userModel:n.userModel,avatarBackgroundColor:n.avatarBackgroundColor,initials:u.Utils.text.getFirstLetters(n.userModel.name).toUpperCase()})}if(!r){this.floorRequestsList.splice(a,1)}this.updateFloorRequestCounter()}},{key:"updateFloorRequestCounter",value:function e(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:false;if(this.floorRequestElements.counter){this.floorRequestElements.counter.innerText=this.floorRequestsList.length;this.updateVisibilityFloorRequestCounter()}if(!t){this.updateTemplateForFloorRequestsPopup()}}},{key:"getTemplateForFloorRequestsPopup",value:function e(){var t=this;return p.Dom.create("div",{props:{className:"bx-call-picture-in-picture-window__popup-template"},children:function(){var e=[];t.floorRequestsList.forEach((function(t,i){var n;e.push(p.Dom.create("li",{props:{className:"bx-call-picture-in-picture-window__floor-request-item"},children:[n=p.Dom.create("div",{props:{className:"bx-call-picture-in-picture-window__floor-request-avatar"}}),p.Dom.create("div",{props:{className:"bx-call-picture-in-picture-window__floor-request-name"},text:t.userModel.name}),p.Dom.create("div",{props:{className:"bx-call-picture-in-picture-window__floor-request-index"},text:i+1})]}));if(t.userModel.avatar){n.style.setProperty("--avatar","url('".concat(t.userModel.avatar,"')"));n.innerText=""}else{n.style.setProperty("--avatar-color",t.avatarBackgroundColor);n.innerText=t.initials}}));return e}()})}},{key:"updateTemplateForFloorRequestsPopup",value:function e(){var t=this.getTemplateForFloorRequestsPopup();if(this.floorRequestElements.template){p.Dom.remove(this.floorRequestElements.template)}this.floorRequestElements.popupTemplate=t;if(!this.floorRequestElements.popup){return}if(!this.floorRequestsList.length){this.floorRequestElements.popup.close();return}this.floorRequestElements.popup.setContent(this.floorRequestElements.popupTemplate)}},{key:"closeFloorRequestMainNotification",value:function e(t){var i=t.withoutAdditionInList,n=t.user,a=t.withoutDismount;if(this.floorRequestTimeout){clearTimeout(this.floorRequestTimeout);this.floorRequestTimeout=null}if(this.floorRequestElements.mainNotification&&!a){this.floorRequestElements.mainNotification.dismount()}if(!i&&n){this.updateFloorRequestsList({user:n})}}},{key:"updateFloorRequestState",value:function e(t){var i=t.userModel,n=t.avatarBackgroundColor;if(this.floorRequestElements.mainNotification&&this.floorRequestElements.mainNotification.userModel&&this.floorRequestElements.mainNotification.userModel.id===i.id&&!i.floorRequestState){this.floorRequestElements.mainNotification=null}if(i.floorRequestState){this.updateFloorRequestMainNotification({userModel:i,avatarBackgroundColor:n})}if(!i.floorRequestState){this.updateFloorRequestsList({user:{userModel:i,avatarBackgroundColor:n}})}}},{key:"updateFloorRequestMainNotification",value:function e(t){var i=this;var n=t.userModel,a=t.avatarBackgroundColor;if(!this.notificationPanel){this.renderNotificationPanel()}if(this.floorRequestElements.mainNotification){this.closeFloorRequestMainNotification({withoutAdditionInList:false,user:{userModel:this.floorRequestElements.mainNotification.userModel,avatarBackgroundColor:this.floorRequestElements.mainNotification.avatarBackgroundColor}})}this.floorRequestElements.mainNotification=on.create({userModel:n,onDestroy:function e(){i.closeFloorRequestMainNotification({withoutAdditionInList:!n.floorRequestState,user:{userModel:n,avatarBackgroundColor:a},withoutDismount:true});i.floorRequestElements.mainNotification=null}});this.floorRequestElements.mainNotification.mount(this.notificationPanel);this.floorRequestTimeout=setTimeout((function(){i.closeFloorRequestMainNotification({withoutAdditionInList:false,user:{userModel:n,avatarBackgroundColor:a}})}),this.floorRequestTimeForHidden)}},{key:"updateVisibilityFloorRequestCounter",value:function e(){var t=!this.floorRequestsList.length;if(!this.floorRequestElements.counter){this.renderFloorRequestCounter()}var i="bx-call-picture-in-picture-window__floor-requests_hidden";var n=this.floorRequestElements.counter.classList.contains(i);if(n===t){return}this.floorRequestElements.counter.classList.toggle(i)}},{key:"onMouseOutCallbackForPopup",value:function e(t){if(!this.floorRequestElements.popup){return}var i=t.composedPath();if(i.some((function(e){return e.classList&&(e.classList.contains("bx-call-picture-in-picture-window__floor-requests")||e.classList.contains("bx-call-picture-in-picture-window__popup"))}))){return}this.floorRequestElements.popup.close()}},{key:"setNewSettingForPopup",value:function e(){if(!this.pictureWindow.document.body||!this.floorRequestElements.popup||!this.floorRequestElements.counter){return}var t=this.pictureWindow.document.body,i=t.clientHeight,n=t.clientWidth;var a=this.floorRequestElements.counter;var s=a.getBoundingClientRect();var r=s.bottom;var o=16;var l=o/2;var c=n-o*2;var u=this.baseWidthPopup<=c?this.baseWidthPopup:c;var d=i-r-l*2;this.floorRequestElements.popup.setOffset({offsetLeft:n-o-u,offsetTop:l});this.floorRequestElements.popup.setWidth(u);this.floorRequestElements.popup.setMaxHeight(d)}},{key:"renderFloorRequestCounter",value:function e(){var t=this;if(!!this.floorRequestElements.counter){return}this.floorRequestElements.counter=p.Dom.create("div",{props:{className:"bx-call-picture-in-picture-window__floor-requests"},text:this.floorRequestsList.length,events:{mouseover:function e(i){i.stopPropagation();var n=t;if(!t.floorRequestElements.popup&&!t.isMinHeight){t.updateTemplateForFloorRequestsPopup();t.floorRequestElements.popup=new v.Popup({className:"bx-call-picture-in-picture-window__popup",bindElement:t.floorRequestElements.counter,targetContainer:t.pictureWindow.document.body,content:t.floorRequestElements.popupTemplate,bindOptions:{position:"top"},autoHide:true,closeByEsc:true,background:"#00428F",contentBackground:"#00428F",darkMode:true,contentNoPaddings:true,animation:"fading",padding:0,contentBorderRadius:"18px",zIndex:11,events:{onPopupClose:function e(){this.destroy()},onPopupDestroy:function e(){n.floorRequestElements.popup=null}}})}t.setNewSettingForPopup();t.floorRequestElements.popup.show()}}});this.updateFloorRequestCounter(true)}},{key:"render",value:function e(){var t=this;this.renderButtons();this.renderUserPanel();this.renderNotificationPanel();this.renderFloorRequestCounter();this.updateFloorRequestsList({floorRequestsList:this.previousFloorRequestNotifications});this.template=p.Dom.create("div",{props:{className:"bx-call-picture-in-picture-window"},events:{click:function e(i){t._onButtonClick({buttonName:"returnToCall",event:i})}}});if(!!this.userPanel){this.template.appendChild(this.userPanel)}if(!!this.actionsPanel){this.template.appendChild(this.actionsPanel)}if(!!this.notificationPanel){this.template.appendChild(this.notificationPanel)}if(!!this.floorRequestElements.counter){this.template.appendChild(this.floorRequestElements.counter)}}},{key:"setHeightPictureWindow",value:function e(){if(!this.template){return false}var t=this.template.clientHeight;var i=t<=80;if(this.isMinHeight===i){return false}if(i&&!!this.floorRequestElements.popup){this.floorRequestElements.popup.close()}this.isMinHeight=i;this.template.classList[this.isMinHeight?"add":"remove"]("bx-call-picture-in-picture-window_min");return true}},{key:"setWidthPictureWindow",value:function e(){if(!this.template){return false}var t=this.template.clientWidth;var i=t<=310;if(this.isMinWidth===i){return false}this.isMinWidth=i;this.template.classList[this.isMinWidth?"add":"remove"]("bx-call-picture-in-picture-window_thin");return true}},{key:"setAvatarSettings",value:function e(){if(!this.userPanel){return}var t=this.userPanel.clientHeight*.45;var i=t*.45;this.userPanel.style.setProperty("--avatar-size",t+"px");this.userPanel.style.setProperty("--avatar-text-size",i+"px")}},{key:"onMouseMove",value:function e(t){this.onMouseOutCallbackForPopup(t)}},{key:"onResize",value:function e(){this.setAvatarSettings();var t=this.setHeightPictureWindow();var i=this.setWidthPictureWindow();if(t||i){this.updateButtons()}if(this.floorRequestElements.popup){this.floorRequestElements.popup.close()}}},{key:"toggleEvents",value:function e(t){var i=this;var n=t?"addEventListener":"removeEventListener";if(this.pictureWindow){this.pictureWindow[n]("pagehide",(function(e){i.onClose()}));this.pictureWindow[n]("resize",(function(e){i.onResize()}));this.pictureWindow[n]("mousemove",(function(e){i.onMouseMove(e)}))}}},{key:"checkAvailableAndCreate",value:function(){var e=babelHelpers.asyncToGenerator(wn().mark((function e(){var t,i=this;return wn().wrap((function e(n){while(1)switch(n.prev=n.next){case 0:if(!this.pictureWindow){n.next=2;break}return n.abrupt("return",this.pictureWindow);case 2:if(!((t=window.documentPictureInPicture)!==null&&t!==void 0&&t.requestWindow)){n.next=18;break}this.render();n.prev=4;n.next=7;return window.documentPictureInPicture.requestWindow({disallowReturnToOpener:true,width:370,height:215,preferInitialWindowPlacement:false});case 7:this.pictureWindow=n.sent;this.toggleEvents(true);babelHelpers.toConsumableArray(document.styleSheets).forEach((function(e){try{var t=babelHelpers.toConsumableArray(e.cssRules).map((function(e){return e.cssText})).join("");var n=document.createElement("style");n.textContent=t;i.pictureWindow.document.head.appendChild(n)}catch(t){var a=document.createElement("link");a.rel="stylesheet";a.type=e.type;a.media=e.media;a.href=e.href;i.pictureWindow.document.head.appendChild(a)}}));this.pictureWindow.document.body.append(this.template);n.next=16;break;case 13:n.prev=13;n.t0=n["catch"](4);this.onClose();case 16:n.next=19;break;case 18:this.onClose();case 19:case"end":return n.stop()}}),e,this,[[4,13]])})));function t(){return e.apply(this,arguments)}return t}()},{key:"onClose",value:function e(){var t;if(typeof((t=this.callbacks)===null||t===void 0?void 0:t.onClose)==="function"){this.callbacks.onClose()}if(this.template){BX.remove(this.template)}this.destroyCurrentUser();this.close();this.pictureWindow=null;this.template=null;this.toggleEvents(false)}},{key:"close",value:function e(){if(this.pictureWindow){this.pictureWindow.close()}}}],[{key:"isAvailable",get:function e(){return Sn.isPiPAvailable}}]);return e}();var Tn=function(){function e(t){babelHelpers.classCallCheck(this,e);this.userList=t.userList;this.current=t.current;this.parentElement=t.parentElement;this.zIndex=t.zIndex;this.menu=null;this.callbacks={onSelect:p.Type.isFunction(t.onSelect)?t.onSelect:BX.DoNothing}}babelHelpers.createClass(e,[{key:"show",value:function e(){var t=this;var i=[];this.userList.forEach((function(e){i.push({id:e.id,text:e.name||"unknown ("+e.id+")",className:t.current==e.id?"menu-popup-item-accept":"device-selector-empty",onclick:function i(){t.menu.close();t.callbacks.onSelect(e.id)}})}));this.menu=new v.Menu({id:"call-view-select-user",bindElement:this.parentElement,items:i,autoHide:true,zIndex:this.zIndex,closeByEsc:true,offsetTop:0,offsetLeft:0,bindOptions:{position:"bottom"},angle:false,overlay:{backgroundColor:"white",opacity:0},events:{onPopupClose:function e(){t.menu.popupWindow.destroy();v.MenuManager.destroy("call-view-select-device")},onPopupDestroy:function e(){t.menu=null}}});this.menu.popupWindow.show()}}],[{key:"create",value:function t(i){return new e(i)}}]);return e}();var Pn="bx-call-aha-moment-notify_spotlight";var _n=function(){function e(t){babelHelpers.classCallCheck(this,e);this.popup=null;this.id=t.id||Math.random().toString(16).slice(2);this.notifyText=t.notifyText||"";this.notifyTitle=t.notifyTitle||"";this.promoId=t.promoId||"";this.popupTemplate=null;this.bindElement=t.bindElement;this.notifyColor="#22272B";this.spotlight=null;this.callbacks={onClose:BX.type.isFunction(t.onClose)?t.onClose:BX.DoNothing}}babelHelpers.createClass(e,[{key:"getPopupTemplate",value:function e(){var t=this;if(this.popupTemplate){return}this.popupTemplate=p.Dom.create("div",{props:{className:"bx-call-aha-moment-notify__content"},children:[p.Dom.create("div",{props:{className:"bx-call-aha-moment-line-top"}}),p.Dom.create("div",{props:{className:"bx-call-aha-moment-notify__title"},text:this.notifyTitle}),p.Dom.create("div",{props:{className:"bx-call-aha-moment-notify__message"},text:this.notifyText}),p.Dom.create("span",{props:{className:"popup-window-close-icon"},events:{click:function e(){if(t.promoId){n.PromoManager.getInstance().markAsWatched(t.promoId)}t.close()}}})]})}},{key:"getSpotlight",value:function e(){if(!this.bindElement){return}if(this.spotlight){this.spotlight.close();this.spotlight=null}var t="".concat(Pn,"_").concat(this.id);this.spotlight=new BX.SpotLight({id:t,targetElement:this.bindElement,targetVertex:"middle-center",lightMode:true,zIndex:1500});return this.spotlight}},{key:"create",value:function e(){var t=this;var i=this;this.getPopupTemplate();if(!this.bindElement||!this.popupTemplate||this.popup){return}this.popup=new v.Popup({className:"bx-call-aha-moment-notify",bindElement:this.bindElement,targetContainer:document.body,content:this.popupTemplate,bindOptions:{position:"bottom",forceBindPosition:true},offsetTop:23,background:this.notifyColor,contentBackground:this.notifyColor,darkMode:true,animation:"fading",autoHide:false,events:{onPopupClose:function e(){i.callbacks.onClose();if(i.spotlight){i.spotlight.close()}this.destroy()},onPopupDestroy:function e(){i.popup=null},onShow:function e(){var i=t.popup.getPopupContainer().offsetWidth;var n=t.popup.bindElement.offsetWidth;var a=0;t.popup.setOffset({offsetLeft:n-a-i/2});t.popup.setAngle({offset:i/2-33,position:"top"});t.popup.adjustPosition()},onClose:function e(){if(i.spotlight){i.spotlight.close()}}}})}},{key:"show",value:function e(){this.create();if(!this.bindElement||!this.popupTemplate){return}if(!this.spotlight){this.getSpotlight()}this.spotlight.show();this.spotlight.getTargetContainer().hidden=false;if(this.popup){this.popup.show()}}},{key:"close",value:function e(){if(this.popup){this.popup.close()}if(this.spotlight){this.spotlight.close()}}}]);return e}();function En(e,t){Rn(e,t);t.add(e)}function Rn(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}function Mn(e,t,i){if(!t.has(e)){throw new TypeError("attempted to get private field on non-instance")}return i}var An=new WeakSet;var Ln=new WeakSet;var Bn=new WeakSet;var Dn=new WeakSet;var Hn=function(){function e(t){babelHelpers.classCallCheck(this,e);En(this,Dn);En(this,Bn);En(this,Ln);En(this,An);this.popup=null;this.popupTemplate=null;this.isCloudRecordFeaturesEnabled=t.isCloudRecordFeaturesEnabled;this.callId=t.callId;this.callbacks={turnOn:BX.type.isFunction(t.turnOn)?t.turnOn:BX.DoNothing,onClose:BX.type.isFunction(t.onClose)?t.onClose:BX.DoNothing}}babelHelpers.createClass(e,[{key:"show",value:function e(){Mn(this,Dn,Un).call(this);this.popup.show()}},{key:"close",value:function e(){if(this.popup){this.popup.close()}}},{key:"toggle",value:function e(){if(!this.popup){this.show();return}this.close()}},{key:"sendAnalytics",value:function e(t){h.Analytics.getInstance().onCloudRecordPopupShow({callId:this.callId,popupType:t})}}]);return e}();function Nn(){var e=this;if(!this.isCloudRecordFeaturesEnabled){this.sendAnalytics("private_coming_soon");return p.Dom.create("span",{props:{className:"call-cloud-record-info-popup__coming-soon"},text:p.Loc.getMessage("CALL_CLOUD_RECORD_INFO_POPUP_BUTTON_COMING_SOON")})}return p.Dom.create("button",{props:{className:"call-cloud-record-info-popup__button --primary"},text:p.Loc.getMessage("CALL_CLOUD_RECORD_INFO_POPUP_BUTTON_TURN_ON"),events:{click:function t(){e.callbacks.turnOn();e.close()}}})}function xn(){var e=this;this.popupTemplate=p.Dom.create("div",{props:{className:"call-cloud-record-info-popup"},children:[p.Dom.create("div",{props:{className:"call-cloud-record-info-popup__wrapper"},children:[p.Dom.create("div",{props:{className:"call-cloud-record-info-popup__icon"}}),p.Dom.create("div",{props:{className:"call-cloud-record-info-popup__text"},children:[p.Dom.create("div",{props:{className:"call-cloud-record-info-popup__title"},text:p.Loc.getMessage("CALL_CLOUD_RECORD_INFO_POPUP_TARIFF_TITLE")}),p.Dom.create("div",{props:{className:"call-cloud-record-info-popup__subtitle"},text:p.Loc.getMessage("CALL_CLOUD_RECORD_INFO_POPUP_TARIFF_SUBTITLE")})]}),p.Dom.create("ul",{props:{className:"call-cloud-record-info-popup__list"},children:[p.Dom.create("li",{props:{className:"call-cloud-record-info-popup__list-item"},children:[p.Dom.create("div",{props:{className:"call-cloud-record-info-popup__list-item_icon --like"}}),p.Dom.create("div",{props:{className:"call-cloud-record-info-popup__list-item_text"},text:p.Loc.getMessage("CALL_CLOUD_RECORD_INFO_POPUP_TARIFF_ITEM_LIKE")})]}),p.Dom.create("li",{props:{className:"call-cloud-record-info-popup__list-item"},children:[p.Dom.create("div",{props:{className:"call-cloud-record-info-popup__list-item_icon --devices"}}),p.Dom.create("div",{props:{className:"call-cloud-record-info-popup__list-item_text"},text:p.Loc.getMessage("CALL_CLOUD_RECORD_INFO_POPUP_TARIFF_ITEM_DEVICE")})]}),p.Dom.create("li",{props:{className:"call-cloud-record-info-popup__list-item"},children:[p.Dom.create("div",{props:{className:"call-cloud-record-info-popup__list-item_icon --cloud"}}),p.Dom.create("div",{props:{className:"call-cloud-record-info-popup__list-item_text"},text:p.Loc.getMessage("CALL_CLOUD_RECORD_INFO_POPUP_TARIFF_ITEM_CLOUD")})]})]}),p.Dom.create("div",{props:{className:"call-cloud-record-info-popup__action"},children:[p.Dom.create("button",{props:{className:"call-cloud-record-info-popup__button --secondary"},children:[p.Dom.create("div",{props:{className:"call-cloud-record-info-popup__button_wrapper"},children:[p.Dom.create("div",{props:{className:"call-cloud-record-info-popup__button_icon"}}),p.Dom.create("div",{props:{className:"call-cloud-record-info-popup__button_text"},text:p.Loc.getMessage("CALL_CLOUD_RECORD_INFO_POPUP_BUTTON_BUY")})]})],events:{click:function t(){Yf.openArticle(xi.tariffSlider);e.close()}}})]})]})]});this.sendAnalytics("tariff_limit")}function On(){this.popupTemplate=p.Dom.create("div",{props:{className:"call-cloud-record-info-popup"},children:[p.Dom.create("div",{props:{className:"call-cloud-record-info-popup__wrapper"},children:[p.Dom.create("div",{props:{className:"call-cloud-record-info-popup__icon"}}),p.Dom.create("div",{props:{className:"call-cloud-record-info-popup__text"},children:[p.Dom.create("div",{props:{className:"call-cloud-record-info-popup__title"},text:p.Loc.getMessage("CALL_CLOUD_RECORD_INFO_POPUP_MAIN_TITLE")}),p.Dom.create("div",{props:{className:"call-cloud-record-info-popup__subtitle"},text:p.Loc.getMessage("CALL_CLOUD_RECORD_INFO_POPUP_MAIN_SUBTITLE")})]}),p.Dom.create("ul",{props:{className:"call-cloud-record-info-popup__list"},children:[p.Dom.create("li",{props:{className:"call-cloud-record-info-popup__list-item"},children:[p.Dom.create("div",{props:{className:"call-cloud-record-info-popup__list-item_icon --cloud"}}),p.Dom.create("div",{props:{className:"call-cloud-record-info-popup__list-item_text"},text:p.Loc.getMessage("CALL_CLOUD_RECORD_INFO_POPUP_MAIN_ITEM_CLOUD")})]}),p.Dom.create("li",{props:{className:"call-cloud-record-info-popup__list-item"},children:[p.Dom.create("div",{props:{className:"call-cloud-record-info-popup__list-item_icon --like"}}),p.Dom.create("div",{props:{className:"call-cloud-record-info-popup__list-item_text"},text:p.Loc.getMessage("CALL_CLOUD_RECORD_INFO_POPUP_MAIN_ITEM_LIKE")})]}),p.Dom.create("li",{props:{className:"call-cloud-record-info-popup__list-item"},children:[p.Dom.create("div",{props:{className:"call-cloud-record-info-popup__list-item_icon --devices"}}),p.Dom.create("div",{props:{className:"call-cloud-record-info-popup__list-item_text"},text:p.Loc.getMessage("CALL_CLOUD_RECORD_INFO_POPUP_MAIN_ITEM_DEVICE")})]})]}),p.Dom.create("div",{props:{className:"call-cloud-record-info-popup__action"},children:[Mn(this,An,Nn).call(this)]})]})]})}function Un(){var e=this;var t=document.querySelector(".bx-messenger-videocall-panel-background-record");if(!t){return}if(xi.tariffAvailable){Mn(this,Bn,On).call(this)}else{Mn(this,Ln,xn).call(this)}this.popup=new v.Popup({className:"call-cloud-record-info-popup",bindElement:t,targetContainer:document.body,content:this.popupTemplate,bindOptions:{position:"top"},autoHide:true,closeByEsc:true,background:"#1f51ae",borderRadius:"18px",contentBackground:"#0D2F70",darkMode:true,contentNoPaddings:true,animation:"fading",width:406,padding:0,angle:{offset:183,position:"bottom"},offsetLeft:-139,contentBorderRadius:"18px",events:{onPopupClose:function t(){e.callbacks.onClose();e.popup.destroy()},onPopupDestroy:function t(){e.popup=null}}})}function Fn(e,t){Gn(e,t);t.add(e)}function Vn(e,t,i){Gn(e,t);t.set(e,i)}function Gn(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}function Wn(e,t,i){if(!t.has(e)){throw new TypeError("attempted to get private field on non-instance")}return i}var Xn=new WeakMap;var zn=new WeakMap;var jn=new WeakMap;var qn=new WeakSet;var Yn=new WeakSet;var Qn=new WeakSet;var Jn=new WeakSet;var Kn=new WeakSet;var Zn=function(){function e(t){babelHelpers.classCallCheck(this,e);Fn(this,Kn);Fn(this,Jn);Fn(this,Qn);Fn(this,Yn);Fn(this,qn);Vn(this,Xn,{writable:true,value:void 0});Vn(this,zn,{writable:true,value:void 0});Vn(this,jn,{writable:true,value:void 0});this.popup=null;this.popupTemplate=null;babelHelpers.classPrivateFieldSet(this,Xn,t.popupType||"kind");babelHelpers.classPrivateFieldSet(this,zn,t.state);babelHelpers.classPrivateFieldSet(this,jn,t.isDesktopRecord);this.callbacks={onStart:BX.type.isFunction(t.onStart)?t.onStart:BX.DoNothing,onStop:BX.type.isFunction(t.onStop)?t.onStop:BX.DoNothing,onPause:BX.type.isFunction(t.onPause)?t.onPause:BX.DoNothing,onDestroy:BX.type.isFunction(t.onDestroy)?t.onDestroy:BX.DoNothing,onClose:BX.type.isFunction(t.onClose)?t.onClose:BX.DoNothing}}babelHelpers.createClass(e,[{key:"show",value:function e(){Wn(this,Kn,na).call(this);this.popup.show()}},{key:"close",value:function e(){if(this.popup){this.popup.close()}}},{key:"toggle",value:function e(){if(!this.popup){this.show();return}this.close()}}]);return e}();function $n(){var e=this;return[p.Dom.create("div",{props:{className:"call-common-record-menu-popup__button"},children:[p.Dom.create("span",{props:{className:"call-common-record-menu-popup__button_text"},text:p.Loc.getMessage("CALL_CLOUD_RECORD_MENU_RECORD_AUDIO")})],events:{click:function t(){e.callbacks.onStart("audio");e.close()}}}),p.Dom.create("div",{props:{className:"call-common-record-menu-popup__button"},children:[p.Dom.create("span",{props:{className:"call-common-record-menu-popup__button_text"},text:p.Loc.getMessage("CALL_CLOUD_RECORD_MENU_RECORD_VIDEO")})],events:{click:function t(){e.callbacks.onStart("video");e.close()}}})]}function ea(){var e=this;var t=[];if(!babelHelpers.classPrivateFieldGet(this,jn)){t.push(p.Dom.create("div",{props:{className:"call-common-record-menu-popup__button  --destroy"},children:[p.Dom.create("span",{props:{className:"call-common-record-menu-popup__button_text"},text:p.Loc.getMessage("CALL_CLOUD_RECORD_MENU_DESTROY_RECORD")}),p.Dom.create("span",{props:{className:"call-common-record-menu-popup__button_icon --destroy"}})],events:{click:function t(){e.callbacks.onDestroy();e.close()}}}))}t.push(p.Dom.create("div",{props:{className:"call-common-record-menu-popup__button"},children:[p.Dom.create("span",{props:{className:"call-common-record-menu-popup__button_text"},text:babelHelpers.classPrivateFieldGet(this,zn)==="paused"?p.Loc.getMessage("CALL_CLOUD_RECORD_MENU_RESUME_RECORD"):p.Loc.getMessage("CALL_CLOUD_RECORD_MENU_PAUSE_RECORD")}),p.Dom.create("span",{props:{className:"call-common-record-menu-popup__button_icon ".concat(babelHelpers.classPrivateFieldGet(this,zn)==="paused"?"--resume":"--pause")}})],events:{click:function t(){e.callbacks.onPause();e.close()}}}),p.Dom.create("div",{props:{className:"call-common-record-menu-popup__button"},children:[p.Dom.create("span",{props:{className:"call-common-record-menu-popup__button_text"},text:p.Loc.getMessage("CALL_CLOUD_RECORD_MENU_STOP_RECORD")}),p.Dom.create("span",{props:{className:"call-common-record-menu-popup__button_icon --stop"}})],events:{click:function t(){e.callbacks.onStop();e.close()}}}));return t}function ta(){if(babelHelpers.classPrivateFieldGet(this,Xn)==="kind"){return Wn(this,qn,$n).call(this)}return Wn(this,Yn,ea).call(this)}function ia(){this.popupTemplate=p.Dom.create("div",{props:{className:"call-common-record-menu-popup__wrapper --".concat(babelHelpers.classPrivateFieldGet(this,Xn))},children:Wn(this,Qn,ta).call(this)})}function na(){var e=this;var t=document.querySelector(".bx-messenger-videocall-panel-background-record");if(!t){return}Wn(this,Jn,ia).call(this);this.popup=new v.Popup({className:"call-common-record-menu-popup",bindElement:t,targetContainer:document.body,content:this.popupTemplate,bindOptions:{position:"top"},autoHide:true,closeByEsc:true,background:"#00428F",contentBackground:"#00428F",darkMode:true,contentNoPaddings:true,animation:"fading",padding:0,angle:{position:"bottom"},offsetLeft:20,contentBorderRadius:"6px",events:{onPopupClose:function t(){e.callbacks.onClose();e.popup.destroy()},onPopupDestroy:function t(){e.popup=null}}})}function aa(e,t){sa(e,t);t.add(e)}function sa(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}function ra(e,t,i){if(!t.has(e)){throw new TypeError("attempted to get private field on non-instance")}return i}var oa=new WeakSet;var la=function(){function e(t){babelHelpers.classCallCheck(this,e);aa(this,oa);this.popup=null;this.callbacks={onClickYesButton:BX.type.isFunction(t.onClickYesButton)?t.onClickYesButton:BX.DoNothing,onClickNoButton:BX.type.isFunction(t.onClickNoButton)?t.onClickNoButton:BX.DoNothing,onClose:BX.type.isFunction(t.onClose)?t.onClose:BX.DoNothing};this.title=BX.type.isString(t.title)?t.title:"";this.message=BX.type.isString(t.message)?t.message:"";this.yesButtonText=BX.type.isString(t.yesButtonText)?t.yesButtonText:"";this.noButtonText=BX.type.isString(t.noButtonText)?t.noButtonText:""}babelHelpers.createClass(e,[{key:"create",value:function e(){var t=this;this.popup=BX.UI.Dialogs.MessageBox.create({modal:true,popupOptions:{content:p.Dom.create("div",{props:{className:"call-confirm-modal__content"},children:[p.Dom.create("div",{props:{className:"call-confirm-modal__title"},text:this.title}),p.Dom.create("div",{props:{className:"call-confirm-modal__message"},text:this.message}),p.Dom.create("div",{props:{className:"call-confirm-modal__actions"},children:ra(this,oa,ca).call(this)})]}),className:"call-confirm-modal",darkMode:true,contentBackground:"#22272B",contentBorderRadius:"10px",autoHide:false,closeByEsc:false,closeIcon:true,contentNoPaddings:true,width:420,maxWidth:420,animation:"fading",events:{onPopupClose:function e(){t.callbacks.onClose();t.popup=null}}}})}},{key:"show",value:function e(){this.close();this.create();this.popup.show()}},{key:"close",value:function e(){if(this.popup){this.popup.close()}}}]);return e}();function ca(){var e=this;var t=[];if(this.yesButtonText){t.push(p.Dom.create("button",{props:{className:"call-confirm-modal__button call-confirm-modal__button-yes"},text:this.yesButtonText,events:{click:function t(){e.callbacks.onClickYesButton();e.popup.close()}}}))}if(this.noButtonText){t.push(p.Dom.create("button",{props:{className:"call-confirm-modal__button call-confirm-modal__button-no"},text:this.noButtonText,events:{click:function t(){e.callbacks.onClickNoButton();e.popup.close()}}}))}return t}var ua=function(){function e(t){babelHelpers.classCallCheck(this,e);this.popup=null;this.customClassName=BX.prop.getString(t,"customClassName","");this.bindElement=BX.prop.getElementNode(t,"bindElement",null);this.targetContainer=BX.prop.getElementNode(t,"targetContainer",null);this.content=t.content;this.closingDelay=1500;this.closingDuration=500;this.closingTimeout=null;this.callbacks={onClose:BX.prop.getFunction(t,"onClose",BX.DoNothing)}}babelHelpers.createClass(e,[{key:"show",value:function e(){var t,i=this;if(p.Type.isNumber(this.closingTimeout)||p.Dom.hasClass((t=this.popup)===null||t===void 0?void 0:t.getPopupContainer(),"closing")){var n;this.clearClosingTimeout();if(p.Dom.hasClass((n=this.popup)===null||n===void 0?void 0:n.getPopupContainer(),"closing")){var a;p.Dom.removeClass((a=this.popup)===null||a===void 0?void 0:a.getPopupContainer(),"closing")}}else{window.requestAnimationFrame((function(){var e;if(!p.Dom.hasClass((e=i.popup)===null||e===void 0?void 0:e.getPopupContainer(),"opening")){var t;p.Dom.addClass((t=i.popup)===null||t===void 0?void 0:t.getPopupContainer(),"opening")}window.requestAnimationFrame((function(){var e;p.Dom.removeClass((e=i.popup)===null||e===void 0?void 0:e.getPopupContainer(),"opening")}))}))}if(!this.popup){this.popup=new v.Popup({bindElement:this.bindElement,targetContainer:this.targetContainer,content:this.render(),padding:0,contentPadding:0,className:"bx-call-view-popup-talking ".concat(this.customClassName," opening"),zIndexOptions:{alwaysOnTop:true},background:"#085DC1",contentBackground:"#085DC1",darkMode:true,contentBorderRadius:"18px",borderRadius:"18px",angle:false,events:{onClose:function e(){i.destroy()},onDestroy:function e(){return i.popup=null}}})}this.popup.show()}},{key:"render",value:function e(){var t=u.Utils.text.getFirstLetters(this.content.name).toUpperCase();return p.Dom.create("div",{props:{className:"bx-call-view-popup-talking-body"},children:[p.Dom.create("div",{props:{className:"bx-call-view-popup-talking-avatar ".concat(this.content.avatar?"":"no-photo")},style:{"background-image":'url("'.concat(this.content.avatar,'")')},children:[p.Dom.create("div",{props:{className:"bx-call-view-popup-talking-avatar-text"},text:this.content.avatar?"":t})]}),p.Dom.create("div",{props:{className:"bx-call-view-popup-talking-text"},text:p.Loc.getMessage("CALL_TALKING_POPUP_TEXT",{"#NAME#":this.content.name})})]})}},{key:"setContent",value:function e(t){this.content=t;if(!this.popup){return}this.popup.setContent(this.render())}},{key:"close",value:function e(t){this.clearClosingTimeout();if(this.popup){this.popup.close();this.callbacks.onClose()}if(t){t()}this.destroy()}},{key:"animatedClose",value:function e(t){var i,n=this;this.clearClosingTimeout();if(!p.Dom.hasClass((i=this.popup)===null||i===void 0?void 0:i.getPopupContainer(),"closing")){var a;p.Dom.addClass((a=this.popup)===null||a===void 0?void 0:a.getPopupContainer(),"closing")}this.closingTimeout=setTimeout((function(){n.close(t)}),this.closingDuration)}},{key:"clearClosingTimeout",value:function e(){clearTimeout(this.closingTimeout);this.closingTimeout=null}},{key:"closeWithDelay",value:function e(t,i){var n=this;if(t){this.close(i)}else{var a;this.clearClosingTimeout();if(p.Dom.hasClass((a=this.popup)===null||a===void 0?void 0:a.getPopupContainer(),"closing")){var s;p.Dom.removeClass((s=this.popup)===null||s===void 0?void 0:s.getPopupContainer(),"closing")}this.closingTimeout=setTimeout((function(){n.animatedClose(i)}),this.closingDelay)}}},{key:"destroy",value:function e(){this.clearClosingTimeout();if(this.popup){this.popup.destroy()}}}]);return e}();function da(e,t){var i=typeof Symbol!=="undefined"&&e[Symbol.iterator]||e["@@iterator"];if(!i){if(Array.isArray(e)||(i=ha(e))||t&&e&&typeof e.length==="number"){if(i)e=i;var n=0;var a=function e(){};return{s:a,n:function t(){if(n>=e.length)return{done:true};return{done:false,value:e[n++]}},e:function e(t){throw t},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var s=true,r=false,o;return{s:function t(){i=i.call(e)},n:function e(){var t=i.next();s=t.done;return t},e:function e(t){r=true;o=t},f:function e(){try{if(!s&&i["return"]!=null)i["return"]()}finally{if(r)throw o}}}}function ha(e,t){if(!e)return;if(typeof e==="string")return pa(e,t);var i=Object.prototype.toString.call(e).slice(8,-1);if(i==="Object"&&e.constructor)i=e.constructor.name;if(i==="Map"||i==="Set")return Array.from(e);if(i==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i))return pa(e,t)}function pa(e,t){if(t==null||t>e.length)t=e.length;for(var i=0,n=new Array(t);i<t;i++)n[i]=e[i];return n}var va=function(){function e(t){var i;babelHelpers.classCallCheck(this,e);this.hasQueue=this.hasQueue.bind(this);this.refreshQueue=this.refreshQueue.bind(this);this.watchTalking=this.watchTalking.bind(this);this.deleteFromQueue=this.deleteFromQueue.bind(this);this.updateQueue=this.updateQueue.bind(this);this.showPopup=this.showPopup.bind(this);this.hidePopup=this.hidePopup.bind(this);this.root=(i=t===null||t===void 0?void 0:t.root)!==null&&i!==void 0?i:null;this.users={};this.activeId=null;this.queue=[]}babelHelpers.createClass(e,[{key:"init",value:function e(t){var i;this.root=(i=t===null||t===void 0?void 0:t.root)!==null&&i!==void 0?i:null}},{key:"hasQueue",value:function e(){return this.queue.length>0}},{key:"refreshQueue",value:function e(){if(this.hasQueue()){this.updateQueue()}}},{key:"watchTalking",value:function e(t){var i=t.data;var n=BX.prop.getInteger(i.user.data,"id",0);if(n<1){return}if(i.fieldName==="talking"){this.updateQueue({user:i.user.data,isUserTalking:i.newValue})}else if(i.fieldName==="order"){this.refreshQueue()}}},{key:"deleteFromQueue",value:function e(t){var i=this.queue.indexOf(t);if(i>-1){this.queue.splice(i,1);delete this.users[t]}}},{key:"updateQueue",value:function e(t){var i=this,n,a;var s=null;var r=false;if(t){s=t.user;r=t.isUserTalking}var o=null;var l=null;var c=function e(){if(o){i.deleteFromQueue(o)}};if(s){if(r){if(!this.users[s.id]){this.queue.push(s.id);this.users[s.id]=s}}else{o=s.id}}var u=null;if(this.activeId){var d;u=(d=this.root)===null||d===void 0?void 0:d.querySelector('.bx-messenger-videocall-user[data-user-id="'.concat(this.activeId,'"]'))}var h=false;var p=s&&((n=s)===null||n===void 0?void 0:n.id)===this.activeId&&r&&((a=this.talkingPopup)===null||a===void 0?void 0:a.closingTimeout);if(!this.activeId||u||o&&o===this.activeId){h=true;var v=da(this.queue),f;try{for(v.s();!(f=v.n()).done;){var m;var g=f.value;if(g===o||g===this.activeId){continue}var b=(m=this.root)===null||m===void 0?void 0:m.querySelector('.bx-messenger-videocall-user[data-user-id="'.concat(g,'"]'));if(!b){l=g;break}}}catch(e){v.e(e)}finally{v.f()}}else if(!p){c();return}if(this.activeId&&!l&&h){this.hidePopup(this.activeId!==o,(function(){c();i.activeId=null}),true)}else if(this.activeId&&l&&this.activeId!==l||!this.activeId&&l){this.showPopup(this.users[l]);c();this.activeId=l}else if(p){var C;this.showPopup(this.users[(C=s)===null||C===void 0?void 0:C.id]);c()}else{c()}}},{key:"showPopup",value:function e(t){if(!this.talkingPopup){this.talkingPopup=new ua({bindElement:document.body,targetContainer:document.body,content:t})}else if(this.talkingPopup&&this.activeId!==t.id){this.talkingPopup.setContent(t)}this.talkingPopup.show()}},{key:"hidePopup",value:function e(t,i){if(!this.talkingPopup){return}this.talkingPopup.closeWithDelay(t,i)}},{key:"destroy",value:function e(){var t;this.hidePopup(true);(t=this.talkingPopup)===null||t===void 0?void 0:t.destroy();this.users={};this.activeId=null;this.queue=[]}}]);return e}();function fa(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function ma(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?fa(Object(i),!0).forEach((function(t){babelHelpers.defineProperty(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):fa(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}function ga(e,t){var i=typeof Symbol!=="undefined"&&e[Symbol.iterator]||e["@@iterator"];if(!i){if(Array.isArray(e)||(i=ba(e))||t&&e&&typeof e.length==="number"){if(i)e=i;var n=0;var a=function e(){};return{s:a,n:function t(){if(n>=e.length)return{done:true};return{done:false,value:e[n++]}},e:function e(t){throw t},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var s=true,r=false,o;return{s:function t(){i=i.call(e)},n:function e(){var t=i.next();s=t.done;return t},e:function e(t){r=true;o=t},f:function e(){try{if(!s&&i["return"]!=null)i["return"]()}finally{if(r)throw o}}}}function ba(e,t){if(!e)return;if(typeof e==="string")return Ca(e,t);var i=Object.prototype.toString.call(e).slice(8,-1);if(i==="Object"&&e.constructor)i=e.constructor.name;if(i==="Map"||i==="Set")return Array.from(e);if(i==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i))return Ca(e,t)}function Ca(e,t){if(t==null||t>e.length)t=e.length;for(var i=0,n=new Array(t);i<t;i++)n[i]=e[i];return n}function ka(e,t){Sa(e,t);t.add(e)}function ya(e,t,i){Sa(e,t);t.set(e,i)}function Sa(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}function wa(e,t,i){if(!t.has(e)){throw new TypeError("attempted to get private field on non-instance")}return i}var Ia={Grid:1,Centered:2,Mobile:3};var Ta={VideoEnabled:"videoEnabled",VideoDisabled:"videoDisabled",UserDisconnected:"userDisconnected"};var Pa={Direct:"direct",Replace:"replace"};var _a={Preparing:1,Initializing:2,Calling:3,Connected:4,Error:5};var Ea={Folded:"folded",Full:"full"};var Ra={None:1,Speaker:2,NonSpeaker:3};var Ma={onShow:"onShow",onClose:"onClose",onDestroy:"onDestroy",onButtonClick:"onButtonClick",onBodyClick:"onBodyClick",onReplaceCamera:"onReplaceCamera",onReplaceMicrophone:"onReplaceMicrophone",onReplaceSpeaker:"onReplaceSpeaker",onSetCentralUser:"onSetCentralUser",onLayoutChange:"onLayoutChange",onChangeHdVideo:"onChangeHdVideo",onChangeMicAutoParams:"onChangeMicAutoParams",onChangeFaceImprove:"onChangeFaceImprove",onChangeVideoQuality:"onChangeVideoQuality",onUserClick:"onUserClick",onUserRename:"onUserRename",onUserPinned:"onUserPinned",onDeviceSelectorShow:"onDeviceSelectorShow",onOpenAdvancedSettings:"onOpenAdvancedSettings",onHasMainStream:"onHasMainStream",onTurnOffParticipantMic:"onTurnOffParticipantMic",onTurnOffParticipantCam:"onTurnOffParticipantCam",onTurnOffParticipantScreenshare:"onTurnOffParticipantScreenshare",onAllowSpeakPermission:"onAllowSpeakPermission",onDisallowSpeakPermission:"onDisallowSpeakPermission",onToggleSubscribe:"onToggleSubscribe",onUnfold:"onUnfold",onPiPClose:"onPiPClose",onCommonRecordMenu:"onCommonRecordMenu",onPiPBodyClick:"onPiPBodyClick"};var Aa=-1;var La=999;var Ba=1001;var Da=250;var Ha=160;var Na=90;var xa=19;var Oa=180;var Ua=100;var Fa=3e3;var Va=3e3;var Ga="call:callcontrol-notify-promo:07052025:all";var Wa="call:cloud-record-info-popup:09092025:all";var Xa={hidden:"hidden",visible:"visible"};var za=new WeakMap;var ja=new WeakMap;var qa=new WeakSet;var Ya=new WeakSet;var Qa=new WeakSet;var Ja=new WeakSet;var Ka=new WeakSet;var Za=new WeakSet;var $a=new WeakSet;var es=function(){function e(t){var i=this;babelHelpers.classCallCheck(this,e);ka(this,$a);ka(this,Za);ka(this,Ka);ka(this,Ja);ka(this,Qa);ka(this,Ya);ka(this,qa);ya(this,za,{writable:true,value:void 0});ya(this,ja,{writable:true,value:void 0});babelHelpers.defineProperty(this,"setCameraState",(function(e){if(i.isCameraOn==e.data.isCameraOn){return}i.isCameraOn=e.data.isCameraOn;if(i.buttons.camera){if(i.isCameraOn){i.buttons.camera.enable()}else{i.buttons.camera.disable()}}if(i.pictureInPictureCallWindow){i.pictureInPictureCallWindow.setButtons(i.getPictureInPictureCallWindowGetButtonsList()).updateButtons()}}));babelHelpers.defineProperty(this,"setMuted",(function(e){if(i.isMuted==e.data.isMicrophoneMuted){return}i.isMuted=e.data.isMicrophoneMuted;if(i.buttons.microphone){if(i.isMuted){i.buttons.microphone.disable()}else{i.buttons.microphone.enable()}}i.userRegistry.get(i.userId).microphoneState=!i.isMuted;if(i.pictureInPictureCallWindow){i.pictureInPictureCallWindow.setButtons(i.getPictureInPictureCallWindowGetButtonsList()).updateButtons()}}));this.title=t.title;this.container=t.container;this.baseZIndex=t.baseZIndex;this.cameraId=t.cameraId;this.microphoneId=t.microphoneId;this.speakerId="";this.speakerMuted=false;this.showChatButtons=t.showChatButtons===true;this.showUsersButton=t.showUsersButton===true;this.showShareButton=t.showShareButton!==false;this.showRecordButton=t.showRecordButton!==false;this.showDocumentButton=t.showDocumentButton!==false;this.showCopilotButton=t.showCopilotButton!==false;this.showButtonPanel=t.showButtonPanel!==false;this.showAddUserButtonInList=t.showAddUserButtonInList||false;this.preferInitialWindowPlacementPictureInPicture=true;this.limitation=null;this.inactiveUsers=[];this.activeUsers=[];this.rerenderTimeout=null;this.waitingForUserMediaTimeouts=new Map;this.rerenderQueue=new Map;this.shelvedRerenderQueue=new Map;this.broadcastingMode=BX.prop.getBoolean(t,"broadcastingMode",false);this.broadcastingPresenters=BX.prop.getArray(t,"broadcastingPresenters",[]);this.currentPage=1;this.pagesCount=1;this.usersPerPage=0;this.language=t.language||"";this.lastPosition=1;this.userData={};if(t.userData){this.updateUserData(t.userData)}this.userLimit=t.userLimit||1;this.userId=BX.message("USER_ID");this.isIntranetOrExtranet=BX.prop.getBoolean(t,"isIntranetOrExtranet",true);this.users={};this.screenUsers={};this.userRegistry=new Gi;this.talkingService=new va;this.userRegistry.subscribe("changed",this.talkingService.refreshQueue);var a=new Vi({id:this.userId,state:BX.prop.getString(t,"localUserState",yc.Connected),localUser:true,order:Aa,name:this.userData[this.userId]?this.userData[this.userId].name:"",avatar:this.userData[this.userId]?this.userData[this.userId].avatar_hr:""});if(this.userId){this.userRegistry.push(a)}this.cache=new Map;this.localUser=new rn({parentContainer:this.container,userModel:a,allowBackgroundItem:T.isAvailable()&&this.isIntranetOrExtranet,allowMaskItem:T.isMaskAvailable()&&this.isIntranetOrExtranet,onUserRename:this._onUserRename.bind(this),onUserRenameInputFocus:this._onUserRenameInputFocus.bind(this),onUserRenameInputBlur:this._onUserRenameInputBlur.bind(this),onClick:this._onUserClick.bind(this),onTurnOffParticipantMic:this._onTurnOffParticipantMic.bind(this),onTurnOffParticipantCam:this._onTurnOffParticipantCam.bind(this),onTurnOffParticipantScreenshare:this._onTurnOffParticipantScreenshare.bind(this),onPin:this._onUserPin.bind(this),onUnPin:this._onUserUnPin.bind(this)});this.centralUser=this.localUser;this.centralUserMobile=null;this.pinnedUser=null;this.presenterId=null;this.localUserReceivedStats=false;this.returnToGridAfterScreenStopped=false;this.mediaSelectionBlocked=t.mediaSelectionBlocked===true;this.visible=false;this.elements={root:null,wrap:null,watermark:null,container:null,overlay:null,topPanel:null,bottom:null,notificationPanel:null,panel:null,audioContainer:null,screenAudioContainer:null,audio:{},screenAudio:{},center:null,localUserMobile:null,userBlock:null,ear:{left:null,right:null},userList:{container:null,addButton:null},userSelectorContainer:null,pinnedUserContainer:null,renameSlider:{input:null,button:null},pageNavigatorLeft:null,pageNavigatorLeftCounter:null,pageNavigatorRight:null,pageNavigatorRightCounter:null};this.buttons={title:null,grid:null,add:null,share:null,record:null,document:null,copilot:null,microphone:null,camera:null,speaker:null,screen:null,mobileMenu:null,chat:null,users:null,history:null,hangup:null,fullscreen:null,overlay:null,status:null,returnToCall:null,recordStatus:null,participants:null,participantsMobile:null,watermark:null,hd:null,protected:null,more:null,hangupOptions:null};this.previousTopButtonList=[];this.needToRerenderTopButtonList=false;this.previousButtonList=[];this.needToRerenderButtonList=false;this.size=Ea.Full;this.maxWidth=null;this.isMuted=H.isMicrophoneMuted;this.isCameraOn=H.isCameraOn;this.isFullScreen=false;this.isUserBlockFolded=false;this.commonRecordState=this.getDefaultCommonRecordState();this.blockedButtons={};var s=BX.prop.getArray(t,"blockedButtons",[]);s.forEach((function(e){return i.blockedButtons[e]=true}));this.hiddenButtons={};this.overflownButtons={};if(!this.showUsersButton){this.hiddenButtons["users"]=true}var r=BX.prop.getArray(t,"hiddenButtons",[]);r.forEach((function(e){return i.hiddenButtons[e]=true}));this.hiddenTopButtons={};var o=BX.prop.getArray(t,"hiddenTopButtons",[]);o.forEach((function(e){return i.hiddenTopButtons[e]=true}));this.uiState=t.uiState||_a.Calling;this.layout=t.layout||Ia.Centered;this.whiteSpaceInUserGrid=0;this.roomState=Ra.None;this.eventEmitter=new f.EventEmitter(this,"BX.Call.View");this.scrollInterval=0;this._onFullScreenChangeHandler=this._onFullScreenChange.bind(this);this._onResizeHandler=this._onResize.bind(this);this._onOrientationChangeHandler=BX.debounce(this._onOrientationChange.bind(this),500);this._onKeyDownHandler=this._onKeyDown.bind(this);this._onKeyUpHandler=this._onKeyUp.bind(this);this.resizeObserver=new BX.ResizeObserver(this._onResizeHandler);this.intersectionObserver=null;this.switchPresenterTimeout=0;this.deviceSelector=null;this.userSelector=null;this.pinnedUserContainer=null;this.renameSlider=null;this.userSize={width:0,height:0};this.hintManager=BX.UI.Hint.createInstance({popupParameters:{targetContainer:document.body,className:"bx-messenger-videocall-panel-item-hotkey-hint",bindOptions:{forceBindPosition:true},angle:false}});this.hotKey={all:Yf.isDesktop(),microphone:true,microphoneSpace:true,camera:true,screen:true,record:true,speaker:true,chat:true,users:true,floorRequest:true,muteSpeaker:true,grid:true};this.hotKeyTemporaryBlock=0;this._isPreparing=false;this._videoRerenderDelay=0;this.isWindowFocus=t.isWindowFocus||false;this._isActivePiPFromController=false;this.enableAutoPip=false;var l=function e(){if(i.pictureInPictureCallWindow){i.pictureInPictureCallWindow.setButtons(i.getPictureInPictureCallWindowGetButtonsList()).updateButtons()}};var c=function t(n,a){if(a===Xa.hidden){if(i.isVideoconf&&(i.uiState!==_a.Connected||!i.visible)){return null}i.toggleStatePictureInPictureCallWindow(true);i.enableAutoPip=true}var s=i.size===e.Size.Folded;var r=i.hasCurrentUserScreenSharing();if(a===Xa.visible){i.enableAutoPip=false;if(r){return null}if(s){return null}i.toggleStatePictureInPictureCallWindow(false)}};this.viewVisibility=wa(this,$a,os).call(this,[l,c]);this.init();this.subscribeEvents(t);if(p.Type.isPlainObject(t.userStates)){this.appendUsers(t.userStates)}this.hideEarTimer=null;this.isCopilotFeaturesEnabled=t.isCopilotFeaturesEnabled||false;this.isCopilotActive=t.isCopilotActive||false;this.copilotNotify=null;this.ahaMomentNotify=null;this.pictureInPictureCallWindow=null;this.floorRequestNotifications=[];this.currentPiPUserId=null;this.isVideoconf=t.isVideoconf||false;this.needToShowCallcontrolPromo=this.isVideoconf?false:n.PromoManager.getInstance().needToShow(Ga);babelHelpers.classPrivateFieldSet(this,za,{infoPopup:null,menuPopup:null,notify:null});babelHelpers.classPrivateFieldSet(this,ja,null)}babelHelpers.createClass(e,[{key:"openArticle",value:function e(t){var i=BX.UI.InfoHelper;if(i.isOpen()){i.close()}i.show(t)}},{key:"onClickButtonWithLimit",value:function t(i,n){var a=i.enabled,s=i.articleCode;if(a&&typeof n==="function"){n();return}if(!a&&s){if(this.size===e.Size.Folded){this._onBodyClick()}this.openArticle(s)}}},{key:"getLimitation",value:function e(){this.limitation=Yf.getCallFeatures()}},{key:"getLimitationByType",value:function e(t){var i;var n={enable:true};var a=(i=this.limitation)===null||i===void 0?void 0:i["call_".concat(t)];if(!a){return n}return{enabled:a.enable,articleCode:a.articleCode}}},{key:"getBackgroundLimitation",value:function e(){return this.getLimitationByType("background")}},{key:"getBackgroundBlurLimitation",value:function e(){return this.getLimitationByType("background_blur")}},{key:"getRecordLimitation",value:function e(){return this.getLimitationByType("record")}},{key:"getScreenSharingLimitation",value:function e(){return this.getLimitationByType("screen_sharing")}},{key:"isDesktopCall",value:function e(){return r.DesktopApi.isDesktop()}},{key:"checkAvailableBackgroundImage",value:function e(){if(!this.isDesktopCall()){return}var t=r.DesktopApi.getBackgroundImage(),i=t.id;if(!i||i==="none"){r.DesktopApi.setCallBackground("none","none")}}},{key:"toggleVisibilityEar",value:function e(){var t,i,n,a,s=this;if(this.hideEarTimer){clearTimeout(this.hideEarTimer);this.hideEarTimer=null}p.Dom.addClass(this.elements.root,"on-mouse-move");(t=this.elements.ear.top)===null||t===void 0?void 0:t.classList.add("force-visible");(i=this.elements.ear.bottom)===null||i===void 0?void 0:i.classList.add("force-visible");(n=this.elements.pageNavigatorLeft)===null||n===void 0?void 0:n.classList.add("force-visible");(a=this.elements.pageNavigatorRight)===null||a===void 0?void 0:a.classList.add("force-visible");this.hideEarTimer=setTimeout((function(){var e,t,i,n;p.Dom.removeClass(s.elements.root,"on-mouse-move");(e=s.elements.ear.top)===null||e===void 0?void 0:e.classList.remove("force-visible");(t=s.elements.ear.bottom)===null||t===void 0?void 0:t.classList.remove("force-visible");(i=s.elements.pageNavigatorLeft)===null||i===void 0?void 0:i.classList.remove("force-visible");(n=s.elements.pageNavigatorRight)===null||n===void 0?void 0:n.classList.remove("force-visible")}),5e3)}},{key:"init",value:function e(){this.getLimitation();this.checkAvailableBackgroundImage();if(this.isFullScreenSupported()){if(p.Browser.isChrome()||p.Browser.isSafari()){window.addEventListener("fullscreenchange",this._onFullScreenChangeHandler);window.addEventListener("webkitfullscreenchange",this._onFullScreenChangeHandler)}else if(p.Browser.isFirefox()){window.addEventListener("mozfullscreenchange",this._onFullScreenChangeHandler)}}if(p.Browser.isMobile()){document.documentElement.style.setProperty("--view-height",window.innerHeight+"px");window.addEventListener("orientationchange",this._onOrientationChangeHandler)}this.elements.audioContainer=p.Dom.create("div",{props:{className:"bx-messenger-videocall-audio-container"}});this.elements.screenAudioContainer=p.Dom.create("div",{props:{className:"bx-messenger-videocall-audio-container"}});if(H.initialized){this.setSpeakerId(H.defaultSpeaker)}else{H.subscribe(H.Events.initialized,function(){this.setSpeakerId(H.defaultSpeaker)}.bind(this))}H.subscribe(H.Events.onChangeMicrophoneMuted,this.setMuted);H.subscribe(H.Events.onChangeCameraOn,this.setCameraState);window.addEventListener("keydown",this._onKeyDownHandler);window.addEventListener("keyup",this._onKeyUpHandler);this.onMouseMoveHandler=this.toggleVisibilityEar.bind(this);document.addEventListener("mousemove",this.onMouseMoveHandler);this.keyModifierForCss=p.Browser.isMac()?"\\2318 + Shift":"Ctrl + Shift";this.container.appendChild(this.elements.audioContainer);this.container.appendChild(this.elements.screenAudioContainer);this.viewVisibility.startViewVisibilityChange()}},{key:"subscribeEvents",value:function e(t){for(var i in Ma){if(Ma.hasOwnProperty(i)&&p.Type.isFunction(t[i])){this.setCallback(i,t[i])}}}},{key:"setCallback",value:function e(t,i){if(p.Type.isFunction(i)&&Ma.hasOwnProperty(t)){this.eventEmitter.subscribe(t,(function(e){i(e.data)}))}}},{key:"subscribe",value:function e(t,i){return this.eventEmitter.subscribe(t,i)}},{key:"unsubscribe",value:function e(t,i){return this.eventEmitter.unsubscribe(t,i)}},{key:"getNextPosition",value:function e(){return this.lastPosition++}},{key:"appendUsers",value:function e(t){if(!p.Type.isPlainObject(t)){return}var i=Object.keys(t);for(var n=0;n<i.length;n++){var a=i[n];this.addUser(a,t[a]?t[a]:yc.Idle)}}},{key:"setCentralUser",value:function e(t){var i=this;if(this.centralUser.id==t){return}if(!this.users[t]&&t!=this.userId){return}var n=this.centralUser;this.centralUser=t==this.userId?this.localUser:this.users[t];if(this.layout===Ia.Centered||this.layout===Ia.Mobile){if(this.layout===Ia.Mobile){n.dismount()}this.updateUserList();if(n.id!=this.centralUser.id){this.eventEmitter.emit(Ma.onHasMainStream,{userId:this.centralUser.id})}}if(this.layout===Ia.Mobile){if(this.centralUserMobile){this.centralUserMobile.setUserModel(this.userRegistry.get(t))}else{this.centralUserMobile=new en({userModel:this.userRegistry.get(t),onClick:function e(){return i.showUserMenu(i.centralUser.id)}});this.centralUserMobile.mount(this.elements.pinnedUserContainer)}}this.userRegistry.get(n.id).centralUser=false;this.userRegistry.get(this.centralUser.id).centralUser=true;this.eventEmitter.emit(Ma.onSetCentralUser,{userId:t,stream:t==this.userId?this.localUser.stream:this.users[t].stream});this.talkingService.refreshQueue()}},{key:"getLeftUser",value:function e(t){var i=null;var n=babelHelpers.toConsumableArray(this.userRegistry.users.keys());var a=n.indexOf(t);if(a===-1){return i}var s=babelHelpers.toConsumableArray(this.userRegistry.users.values()).slice(0,a);var r=s.length;for(var o=r-1;o>=0;o--){var l=s[o];if(!l.localUser&&l.state===yc.Connected){i=l.id;break}}return i}},{key:"getRightUser",value:function e(t){var i=null;var n=babelHelpers.toConsumableArray(this.userRegistry.users.keys());var a=n.indexOf(t);if(a===-1){return i}var s=babelHelpers.toConsumableArray(this.userRegistry.users.values()).slice(a+1);var r=s.length;for(var o=0;o<r;o++){var l=s[o];if(!l.localUser&&l.state===yc.Connected){i=l.id;break}}return i}},{key:"getUserCount",value:function e(){return Object.keys(this.users).length}},{key:"getConnectedUserCount",value:function e(t){var i=this.getConnectedUsers().length;if(t){var n=parseInt(this.userId);if(!this.broadcastingMode||this.broadcastingPresenters.includes(n)){i+=1}}return i}},{key:"getUsersWithVideo",value:function e(){var t=this;if(this.cache.has("usersWithVideo")){return this.cache.get("usersWithVideo")}var i=Object.keys(this.users);var n=[];i.forEach((function(e){if(t.users[e].hasVideo()){n.push(e)}}));this.cache.set("usersWithVideo",n);return n}},{key:"getConnectedUsers",value:function e(){var t=this;if(this.cache.has("currentConnectedUser")){return this.cache.get("currentConnectedUser")}var i=[];var n=babelHelpers.toConsumableArray(this.userRegistry.users.values());n.forEach((function(e){if(e.id!=t.userId&&e.state===yc.Connected){i.push(e.id)}}));this.cache.set("previousConnectedUserCount",0);this.cache.set("currentConnectedUser",i);return i}},{key:"getDisplayedUsers",value:function e(){var t=this;var i=[];var n=babelHelpers.toConsumableArray(this.userRegistry.users.values());n.forEach((function(e){if(e.id!=t.userId&&(e.id!=t.centralUser.id&&t.layout===Ia.Centered||t.layout!==Ia.Centered)&&[yc.Connected,yc.Connecting,yc.Calling].includes(e.state)){i.push(e.id)}}));return i}},{key:"getActiveUsers",value:function e(){var t=this;if(this.cache.has("activeUsers")){return this.cache.get("activeUsers")}var i=[];var n=babelHelpers.toConsumableArray(this.userRegistry.users.values());n.forEach((function(e){if(t.isUserHasActiveState(e)&&Object.hasOwn(t.users,e.id)){i.push(e.id)}}));this.cache.set("activeUsers",i);return i}},{key:"getUsersWithCamera",value:function e(){var t=this;return babelHelpers.toConsumableArray(this.userRegistry.users.values()).filter((function(e){return e.id!=t.userId&&e.cameraState&&t.isUserHasActiveState(e)&&e.state!==yc.Calling}))}},{key:"hasUserWithScreenSharing",value:function e(){return babelHelpers.toConsumableArray(this.userRegistry.users.values()).some((function(e){return e.screenState}))}},{key:"hasCurrentUserScreenSharing",value:function e(){var t=this.userRegistry.get(this.userId);if(t){return t.screenState}return false}},{key:"getPresenterUserId",value:function e(){var t=this.presenterId||0;if(!this.getConnectedUserCount()){return null}if(t==this.localUser.id){t=0}var i=this.userRegistry.get(t);if((i===null||i===void 0?void 0:i.screenState)===true){return t}var n=Object.keys(this.users);for(var a=0,s=n;a<s.length;a++){var r=s[a];if(Object.hasOwn(this.users,r)&&this.userRegistry.get(r).screenState===true){return parseInt(r,10)}}if(i&&i.wasTalkingAgo()<1e3){return t}var o=0;var l=0;for(var c=0,u=n;c<u.length;c++){var d=u[c];if(!Object.hasOwn(this.users,d)){continue}var h=this.userRegistry.get(d).wasTalkingAgo();if(h<1e3){return parseInt(d,10)}if(h<o){l=parseInt(d,10)}}return l||this.centralUser.id}},{key:"switchPresenter",value:function e(){var t=this.presenterId||0;var i=this.getPresenterUserId();if(!i){return}this.presenterId=i;if(t){this.userRegistry.get(t).presenter=false}this.userRegistry.get(i).presenter=true;if(this.pictureInPictureCallWindow){this.pictureInPictureCallWindow.setCurrentUser(this.getPictureInPictureCallWindowUser())}if(this.pinnedUser===null){this.setCentralUser(i)}else if(t!==i){this.eventEmitter.emit(Ma.onHasMainStream,{userId:this.centralUser.id})}}},{key:"switchPresenterDeferred",value:function e(){clearTimeout(this.switchPresenterTimeout);this.switchPresenterTimeout=setTimeout(this.switchPresenter.bind(this),1e3)}},{key:"cancelSwitchPresenter",value:function e(){clearTimeout(this.switchPresenterTimeout)}},{key:"setUiState",value:function e(t){if(this.uiState==t){return}this.uiState=t;if(this.uiState==_a.Error&&this.elements.container){p.Dom.clean(this.elements.container);this.elements.container.appendChild(this.elements.overlay)}if(!this.elements.root){return}this.updateButtons()}},{key:"setLayout",value:function e(t){if(t==this.layout){return}var i=this.layout===Ia.Centered&&t===Ia.Grid;this.layout=t;if(this.layout==Ia.Centered||this.layout==Ia.Mobile){this.elements.root.classList.remove("bx-messenger-videocall-grid");this.elements.root.classList.add("bx-messenger-videocall-centered");this.centralUser.mount(this.elements.center);this.elements.container.appendChild(this.elements.userBlock);if(this.layout!=Ia.Mobile){this.elements.userBlock.appendChild(this.elements.userList.container)}this.centralUser.playVideo()}if(this.layout===Ia.Grid){this.elements.root.classList.remove("bx-messenger-videocall-centered");this.elements.root.classList.add("bx-messenger-videocall-grid");this.elements.container.appendChild(this.elements.userList.container);this.elements.container.removeChild(this.elements.userBlock);this.centralUser.dismount();if(this.isFullScreen&&this.buttons.participants){this.buttons.participants.update({foldButtonState:Ki.FoldButtonState.Hidden})}this.unpinUser()}if(this.layout===Ia.Centered&&this.isFullScreen){this.setUserBlockFolded(true)}this.elements.root.classList.toggle("bx-messenger-videocall-fullscreen-mobile",this.layout==Ia.Mobile);this.updateUserList(i);this.toggleEars();this.updateButtons();this.talkingService.refreshQueue();this.eventEmitter.emit(Ma.onLayoutChange,{layout:this.layout})}},{key:"setRoomState",value:function e(t){if(this.roomState===t){return}this.roomState=t;if(this.buttons.microphone){this.buttons.microphone.setSideIcon(this.getMicrophoneSideIcon(this.roomState))}}},{key:"getMicrophoneSideIcon",value:function e(t){switch(t){case Ra.Speaker:return"ellipsis";case Ra.NonSpeaker:return"pointer";case Ra.None:default:return null}}},{key:"setCurrentPage",value:function e(t){if(t<1||t>this.pagesCount||t==this.currentPage){return}this.currentPage=t;this.recalculateUsersPerPage();if(this.elements.root){this.elements.pageNavigatorLeftCounter.innerHTML=this.currentPage-1+"&nbsp;/&nbsp;"+this.pagesCount;this.elements.pageNavigatorRightCounter.innerHTML=this.currentPage+1+"&nbsp;/&nbsp;"+this.pagesCount}if(!(this.layout===Ia.Grid||this.layout===Ia.Centered)){return}this.renderUserList(true);this.toggleEars();this.talkingService.refreshQueue()}},{key:"calculateUsersPerPage",value:function e(){if(!this.elements.userList){return 1e3}var t=this.elements.userList.container.getBoundingClientRect();var i=Math.floor(t.width/Oa)||1;var n=Math.floor(t.height/Ua)||1;if(this.layout===Ia.Centered){var a=Math.floor(t.height/Na)||1;var s=6;this.whiteSpaceInUserGrid=t.height-a*Na+(a-1)*s;i=1;n=this.whiteSpaceInUserGrid<0?a-1:a}var r=i*n-1;if(this.userId==this.centralUser.id&&this.layout===Ia.Centered){r+=1}if(!r){return 1e3}if(r>=xa){var o=Yf.findBestElementSize(t.width,t.height,xa+1,Oa,Ua);i=Math.floor(t.width/o.width);n=Math.floor(t.height/o.height);r=i*n-1}return r}},{key:"calculatePagesCount",value:function e(t){var i=Math.ceil(this.getDisplayedUsers().length/t);return i>0?i:1}},{key:"recalculateUsersPerPage",value:function e(){this.usersPerPage=this.calculateUsersPerPage();if(this.currentPage<this.pagesCount&&this.layout===Ia.Centered&&this.whiteSpaceInUserGrid>0){this.usersPerPage=this.usersPerPage+1}}},{key:"recalculatePages",value:function e(){this.usersPerPage=this.calculateUsersPerPage();this.pagesCount=this.calculatePagesCount(this.usersPerPage);if(this.currentPage>this.pagesCount){this.currentPage=this.pagesCount}this.recalculateUsersPerPage();if(this.elements.root){this.elements.pageNavigatorLeftCounter.innerHTML=this.currentPage-1+"&nbsp;/&nbsp;"+this.pagesCount;this.elements.pageNavigatorRightCounter.innerHTML=this.currentPage+1+"&nbsp;/&nbsp;"+this.pagesCount}}},{key:"findUsersPage",value:function e(t){if(t==this.userId||this.usersPerPage===0){return 0}var i=this.getDisplayedUsers();var n=0;for(var a=0;a<i.length;a++){if(i[a]==t){n=a+1;break}}return n?Math.ceil(n/this.usersPerPage):0}},{key:"setCameraId",value:function e(t){if(this.cameraId==t){return}if(this.localUser.stream&&this.localUser.stream.getVideoTracks().length>0){throw new Error("Can not set camera id while having active stream")}this.cameraId=t}},{key:"setMicrophoneId",value:function e(t){if(this.microphoneId==t){return}if(this.localUser.stream&&this.localUser.stream.getAudioTracks().length>0){throw new Error("Can not set microphone id while having active stream")}this.microphoneId=t}},{key:"setMicrophoneLevel",value:function e(t){var i;this.microphoneLevel=t;(i=this.buttons.microphone)===null||i===void 0?void 0:i.setLevel(t)}},{key:"setLocalUserId",value:function e(t){if(t==this.userId){return}this.userId=parseInt(t);this.localUser.userModel.id=this.userId;this.localUser.userModel.name=this.userData[this.userId]?this.userData[this.userId].name:"";this.localUser.userModel.avatar=this.userData[this.userId]?Fi(this.userData[this.userId].avatar_hr):"";this.userRegistry.push(this.localUser.userModel)}},{key:"setUserBlockFolded",value:function e(t){var i,n;this.isUserBlockFolded=t;(i=this.elements.userBlock)===null||i===void 0?void 0:i.classList.toggle("folded",this.isUserBlockFolded);(n=this.elements.root)===null||n===void 0?void 0:n.classList.toggle("bx-messenger-videocall-userblock-folded",this.isUserBlockFolded);if(this.isUserBlockFolded){if(this.buttons.participants&&this.layout==Ia.Centered){this.buttons.participants.update({foldButtonState:Ki.FoldButtonState.Unfold})}}else{if(this.buttons.participants){this.buttons.participants.update({foldButtonState:this.isFullScreen&&this.layout==Ia.Centered?Ki.FoldButtonState.Fold:Ki.FoldButtonState.Hidden})}}}},{key:"addUser",value:function e(t,i,n){t=Number(t);if(this.users[t]){return}i=i||yc.Idle;if(!n){if(this.broadcastingPresenters.length>0&&!this.broadcastingPresenters.includes(t)){n=Sc.RecvOnly}else{n=Sc.SendRecv}}var a=new Vi({id:t,name:this.userData[t]?this.userData[t].name:"",avatar:this.userData[t]?this.userData[t].avatar_hr:"",state:i,order:i==yc.Connected?this.getNextPosition():La,direction:n});this.userRegistry.push(a);if(!this.elements.audio[t]){this.elements.audio[t]=p.Dom.create("audio");p.Dom.append(this.elements.audio[t],this.elements.audioContainer)}if(!this.elements.screenAudio[t]){this.elements.screenAudio[t]=p.Dom.create("audio");p.Dom.append(this.elements.screenAudio[t],this.elements.screenAudioContainer)}this.users[t]=new rn({parentContainer:this.container,userModel:a,audioElement:this.elements.audio[t],screenAudioElement:this.elements.screenAudio[t],allowPinButton:this.getConnectedUserCount()>1,onClick:this._onUserClick.bind(this),onPin:this._onUserPin.bind(this),onUnPin:this._onUserUnPin.bind(this),onTurnOffParticipantMic:this._onTurnOffParticipantMic.bind(this),onTurnOffParticipantCam:this._onTurnOffParticipantCam.bind(this),onTurnOffParticipantScreenshare:this._onTurnOffParticipantScreenshare.bind(this)});a.subscribe("changed",this.talkingService.watchTalking);this.screenUsers[t]=new rn({parentContainer:this.container,userModel:a,allowPinButton:false,screenSharingUser:true});if(this.elements.root&&i!==yc.Idle){if(i===yc.Connected){var s;this.cache.set("previousConnectedUserCount",((s=this.cache.get("currentConnectedUser"))===null||s===void 0?void 0:s.length)||0);this.cache["delete"]("currentConnectedUser");this.cache["delete"]("activeUsers")}this.updateUserList();this.updateButtons();this.updateUserButtons();this.muteSpeaker(this.speakerMuted)}}},{key:"setUserDirection",value:function e(t,i){var n=this.userRegistry.get(t);if(!n||n.direction==i){return}n.direction=i;this.updateUserList()}},{key:"setLocalUserDirection",value:function e(t){if(this.localUser.userModel.direction!=t){this.localUser.userModel.direction=t;this.updateUserList()}}},{key:"setUserState",value:function e(t,i){var n=this;var a=this.userRegistry.get(t);if(!a||a.state===i){return}if((a.state===yc.Connected||a.state===yc.Connecting)&&i===yc.Declined){return}if(a.state===yc.Connected||i===yc.Connected){var s;this.cache.set("previousConnectedUserCount",((s=this.cache.get("currentConnectedUser"))===null||s===void 0?void 0:s.length)||0);this.cache["delete"]("currentConnectedUser");this.cache["delete"]("activeUsers")}a.state=i;if(i===yc.Connected&&this.uiState===_a.Calling){this.setUiState(_a.Connected)}if(this.centralUser.id==this.userId&&i==yc.Connected){this.setCentralUser(t)}else if(t==this.centralUser.id){if(i==yc.Connecting||i==yc.Failed){this.centralUser.blurVideo()}else if(i==yc.Connected){this.centralUser.blurVideo(false)}else if(i==yc.Idle){var r=this.getUsersWithVideo();var o=this.getConnectedUsers();if(o.length===0){this.setCentralUser(this.userId)}else if(r.length>0){this.setCentralUser(r[0])}else{this.setCentralUser(o[0])}}}if(i===yc.Connected){var l=setTimeout((function(){n.waitingForUserMediaTimeouts["delete"](t)}),Va);this.waitingForUserMediaTimeouts.set(t,l)}else if(i===yc.Idle){this.setUserFloorRequestState(t,false);this.setUserPermissionToSpeakState(t,false);clearTimeout(this.waitingForUserMediaTimeouts.get(t));this.waitingForUserMediaTimeouts["delete"](t);this.rerenderQueue.set(t,{userId:t,reason:Ta.UserDisconnected})}if(i==yc.Connected&&a.order==La){a.order=this.getNextPosition()}else if(i==yc.Idle){a.prevOrder=a.order;a.order=La;a.prevCameraState=a.cameraState;a.cameraState=false}if(t==this.localUser.id){this.localUser.userModel.cameraState=this.localUser.hasCameraVideo()}var c=t===this.localUser.id?[]:["panel"];if(t==this.presenterId&&i!==yc.Connected){this.switchPresenter()}this.updateUserList();this.updateButtons(c);this.updateUserButtons()}},{key:"setTitle",value:function e(t){this.title=t}},{key:"getUserTalking",value:function e(t){var i=this.userRegistry.get(t);if(!i){return false}return!!i.talking}},{key:"setUserTalking",value:function e(t,i){var n=this.userRegistry.get(t);if(!n){return}n.talking=i;if(t==this.userId){return}if(t==this.presenterId&&!i){this.switchPresenterDeferred()}else{this.switchPresenter()}}},{key:"setUserStats",value:function e(t,i){var n;if(this.users[t]){this.users[t].showStats(i)}if(this.screenUsers[t]){this.screenUsers[t].showStats(i)}if(t==this.localUser.id){this.localUser.showStats(i);this.localUserReceivedStats=true}(n=this.pictureInPictureCallWindow)===null||n===void 0?void 0:n.setStats(t,i);this.updateButtons()}},{key:"setTrackSubscriptionFailed",value:function e(t){if(this.users[t.participant.userId]){if(t.participant.userId&&t.track){this.users[t.participant.userId].showTrackSubscriptionFailed(t.track)}}}},{key:"setUserMicrophoneState",value:function e(t,i){var n=this.userRegistry.get(t);if(n){n.microphoneState=i}}},{key:"setUserCameraState",value:function e(t,i){var n=this.userRegistry.get(t);if(n){n.cameraState=i}}},{key:"setUserVideoPaused",value:function e(t,i){var n=this.userRegistry.get(t);if(n){n.videoPaused=i;n.cameraState=!i;if(!n.videoPaused!==i){return}i?this.updateRerenderQueue(t,Ta.VideoDisabled):this.updateRerenderQueue(t,Ta.VideoEnabled)}}},{key:"getUserFloorRequestState",value:function e(t){var i=this.userRegistry.get(t);return i&&i.floorRequestState}},{key:"setUserFloorRequestState",value:function e(t,i){var n=this.userRegistry.get(t);if(!n){return}if(n.floorRequestState!=i){var a=n===null||n===void 0?void 0:n.state;var s=a!==yc.Idle&&a!==yc.Declined&&a!==yc.Unavailable&&a!==yc.Busy;if(i&&!s){return}n.floorRequestState=i;this.updateFloorRequestNotifications(n,i);if(i){this.showFloorRequestNotification(t)}}if(t==this.userId){this.setButtonActive("floorRequest",i)}}},{key:"setUserPermissionToSpeakState",value:function e(t,i){var n=this.userRegistry.get(t);if(!n){return}if(n.permissionToSpeak!==i){n.permissionToSpeak=i}}},{key:"setAllUserPermissionToSpeakState",value:function e(t){this.userRegistry.users.forEach((function(e){e.permissionToSpeak=t}))}},{key:"pinUser",value:function e(t){if(!(t in this.users)&&t!==Number(this.userId)){console.error("User ".concat(t," is not known"));return}if(this.pinnedUser&&this.userRegistry.users.has(this.pinnedUser.userModel.id)){this.userRegistry.get(this.pinnedUser.userModel.id).pinned=false}this.pinnedUser=this.users[t]||this.localUser;this.userRegistry.get(this.pinnedUser.userModel.id).pinned=true;this.setCentralUser(t);this.eventEmitter.emit(Ma.onUserPinned,{userId:t});this.eventEmitter.emit(Ma.onHasMainStream,{userId:this.centralUser.id})}},{key:"unpinUser",value:function e(){if(this.pinnedUser&&this.userRegistry.users.has(this.pinnedUser.userModel.id)){this.userRegistry.get(this.pinnedUser.userModel.id).pinned=false}this.pinnedUser=null;this.eventEmitter.emit(Ma.onUserPinned,{userId:null});this.eventEmitter.emit(Ma.onHasMainStream,{userId:null});this.switchPresenterDeferred()}},{key:"updateFloorRequestNotifications",value:function e(t,i){var n;var a=this.floorRequestNotifications.findIndex((function(e){return e.userModel.id===t.id}));var s=a!==-1;var r=this.users[t.id];var o={userModel:t,avatarBackgroundColor:(r===null||r===void 0?void 0:r.avatarBackground)||Yf.getAvatarBackground()};if(i&&!s){this.floorRequestNotifications.push(o)}if(!i&&s){this.floorRequestNotifications.splice(a,1)}(n=this.pictureInPictureCallWindow)===null||n===void 0?void 0:n.updateFloorRequestState(o)}},{key:"showFloorRequestNotification",value:function e(t){var i=this;var n=this.userRegistry.get(t);if(!n){return}var a=on.create({userModel:n,onAllowSpeakPermissionClicked:function e(t){i._onAllowSpeakPermissionClickedHandler(t)},onDisallowSpeakPermissionClicked:function e(t){i._onDisallowSpeakPermissionClickedHandler(t)}});a.mount(this.elements.notificationPanel);un.Instance.addNotification(a)}},{key:"updateFloorRequestNotification",value:function e(){if(!(un!==null&&un!==void 0&&un.Instance.notifications.length)){return}un.Instance.notifications.forEach((function(e){e.updatePermissionButtonState()}))}},{key:"_onAllowSpeakPermissionClickedHandler",value:function e(t){this.setUserPermissionToSpeakState(t.id,true);this.eventEmitter.emit(Ma.onAllowSpeakPermission,{userId:t.id})}},{key:"_onDisallowSpeakPermissionClickedHandler",value:function e(t){this.eventEmitter.emit(Ma.onDisallowSpeakPermission,{userId:t.id})}},{key:"setUserScreenState",value:function t(i,n){var a=this.userRegistry.get(i);if(!a){return}a.screenState=n;if(i!=this.userId){if(n===true&&this.layout===e.Layout.Grid){this.setLayout(Ia.Centered);this.returnToGridAfterScreenStopped=true}if(n===false&&this.layout===Ia.Centered&&!this.hasUserWithScreenSharing()&&!this.pinnedUser&&this.returnToGridAfterScreenStopped){this.returnToGridAfterScreenStopped=false;this.setLayout(Ia.Grid)}this.switchPresenter()}}},{key:"flipLocalVideo",value:function e(t){this.localUser.flipVideo=!!t}},{key:"setLocalStream",value:function e(t){var i=t.mediaRenderer;var n=t.stream;var a=t.flipVideo;if(i){var s;this.localUser.videoRenderer=i;(s=this.pictureInPictureCallWindow)===null||s===void 0?void 0:s.setVideoRenderer(this.userId,i)}else{var r;var o=n.getVideoTracks().length>0?n.getVideoTracks()[0]:null;this.localUser.videoTrack=o;(r=this.pictureInPictureCallWindow)===null||r===void 0?void 0:r.setVideoRenderer(this.userId,new yn({kind:"video",track:o}))}if(!p.Type.isUndefined(a)){this.flipLocalVideo(a)}this.localUser.userModel.cameraState=this.localUser.hasCameraVideo();var l=n===null||n===void 0?void 0:n.getVideoTracks();if((l===null||l===void 0?void 0:l.length)>0){var c=l[0].getSettings();this.cameraId=c.deviceId||""}else if(!i){this.cameraId=""}var u=n===null||n===void 0?void 0:n.getAudioTracks();if((u===null||u===void 0?void 0:u.length)>0){var d=u[0].getSettings();this.microphoneId=d.deviceId||""}if(this.layout!==Ia.Grid&&this.centralUser.id==this.userId){if(i){this.centralUser.videoRenderer=i}else if(l.length>0||Object.keys(this.users).length===0){this.centralUser.videoTrack=l[0]}else{this.setCentralUser(Object.keys(this.users)[0])}}else{this.updateUserList()}this.updateButtons()}},{key:"setLocalStreamVideoTrack",value:function e(t){var i;this.localStreamVideoTrack=t;(i=this.pictureInPictureCallWindow)===null||i===void 0?void 0:i.setVideoRenderer(this.userId,new yn({kind:"sharing",track:t}))}},{key:"setSpeakerId",value:function e(t){if(this.speakerId==t){return}if(!("setSinkId"in HTMLMediaElement.prototype)){console.error("Speaker selection is not supported")}this.speakerId=t;for(var i in this.elements.audio){this.elements.audio[i].setSinkId(this.speakerId)}}},{key:"muteSpeaker",value:function e(t){this.speakerMuted=!!t;for(var i in this.elements.audio){this.elements.audio[i].volume=this.speakerMuted?0:1}if(!this.buttons.speaker){return}if(this.speakerMuted){this.buttons.speaker.disable();this.buttons.speaker.hideArrow()}else{this.buttons.speaker.enable();if(H.canSelectSpeaker()){this.buttons.speaker.showArrow()}}}},{key:"updateRerenderQueue",value:function e(t,i){var n=this;if(!this.users[t]){throw Error("User "+t+" is not a part of this call")}if(i===Ta.VideoEnabled){var a;if(((a=this.rerenderQueue.get(t))===null||a===void 0?void 0:a.reason)===Ta.VideoDisabled){this.rerenderQueue["delete"](t);if(!this.rerenderQueue.size){clearTimeout(this.rerenderTimeout);this.rerenderTimeout=null}}else{if(this.waitingForUserMediaTimeouts.has(t)){clearTimeout(this.waitingForUserMediaTimeouts.get(t));this.waitingForUserMediaTimeouts["delete"](t);this.rerenderQueue.set(t,{userId:t,reason:Ta.VideoEnabled});this.renderUserList()}else{if(!this.rerenderTimeout){this.rerenderTimeout=setTimeout((function(){n.renderUserList()}),this.videoRerenderDelay)}this.rerenderQueue.set(t,{userId:t,reason:Ta.VideoEnabled})}}}else if(i===Ta.VideoDisabled){var s;if(((s=this.rerenderQueue.get(t))===null||s===void 0?void 0:s.reason)===Ta.VideoEnabled){this.rerenderQueue["delete"](t);if(!this.rerenderQueue.size){clearTimeout(this.rerenderTimeout);this.rerenderTimeout=null}}else{if(!this.rerenderTimeout){this.rerenderTimeout=setTimeout((function(){n.renderUserList()}),this.videoRerenderDelay)}this.rerenderQueue.set(t,{userId:t,reason:Ta.VideoDisabled})}}}},{key:"setVideoRenderer",value:function e(t,i){var n;var a=this.users[t];if(!a){throw Error("User "+t+" is not a part of this call")}this.cache["delete"]("usersWithVideo");if(i===null){var s;if(a.hasCameraVideo()){this.updateRerenderQueue(t,Ta.VideoDisabled)}a.videoRenderer=null;(s=this.pictureInPictureCallWindow)===null||s===void 0?void 0:s.setVideoRenderer(t,null);return}if(!("render"in i)||!p.Type.isFunction(i.render)){throw Error("mediaRenderer should have method render")}if(!("kind"in i)||i.kind!=="video"&&i.kind!=="sharing"){throw Error("mediaRenderer should be of video kind")}var r=a.hasCameraVideo();a.videoRenderer=i;(n=this.pictureInPictureCallWindow)===null||n===void 0?void 0:n.setVideoRenderer(t,i);if(i.stream&&i.kind==="video"){this.updateRerenderQueue(t,Ta.VideoEnabled)}else if(i.kind==="video"){if(!r){return}this.updateRerenderQueue(t,Ta.VideoDisabled)}}},{key:"setUserMedia",value:function e(t,i,n){var a,s;if(i==="audio"){this.users[t].audioTrack=n}switch(i){case"sharingAudio":this.users[t].screenAudioTrack=n;break;case"video":this.users[t].videoTrack=n;(a=this.pictureInPictureCallWindow)===null||a===void 0?void 0:a.setVideoRenderer(t,new yn({kind:"video",track:n}));break;case"screen":this.screenUsers[t].videoTrack=n;(s=this.pictureInPictureCallWindow)===null||s===void 0?void 0:s.setVideoRenderer(t,new yn({kind:"sharing",track:n}));this.updateUserList();this.setUserScreenState(t,n!==null);break;default:}}},{key:"removeScreenUsers",value:function e(){for(var t in this.screenUsers){this.screenUsers[t].videoTrack=null}this.updateUserList()}},{key:"setBadNetworkIndicator",value:function e(t,i){if(this.users[t]){this.users[t].badNetworkIndicator=i}}},{key:"setUserHasConnectionProblem",value:function e(t,i){if(this.users[t]){this.users[t].hasConnectionProblem=i}}},{key:"setUserConnectionQuality",value:function e(t,i){if(this.users[t]){this.users[t].connectionQuality=i}if(this.localUser.id===t){this.localUser.connectionQuality=i}}},{key:"applyIncomingVideoConstraints",value:function e(){var t;var i;if(this.layout===Ia.Grid){for(t in this.users){i=this.users[t];i.setIncomingVideoConstraints(this.userSize.width,this.userSize.height)}}else if(this.layout===Ia.Centered){for(t in this.users){i=this.users[t];if(t==this.centralUser.id){var n=this.elements.center.getBoundingClientRect();i.setIncomingVideoConstraints(Math.floor(n.width),Math.floor(n.height))}else{i.setIncomingVideoConstraints(Ha,Na)}}}}},{key:"getDefaultCommonRecordState",value:function e(){return{state:Di.Stopped,type:Hi.None,userId:0,date:{start:null,pause:[]}}}},{key:"setCommonRecordState",value:function e(t){this.commonRecordState=t;if(this.buttons.recordStatus){this.buttons.recordStatus.update(this.commonRecordState)}if(this.commonRecordState.userId!=this.userId){if([Di.Stopped,Di.Destroyed].includes(this.commonRecordState.state)){this.unblockButtons(["record"])}else{this.blockButtons(["record"])}}if(this.elements.topPanel){if([Di.Stopped,Di.Destroyed].includes(this.commonRecordState.state)){delete this.elements.topPanel.dataset.recordState}else{this.elements.topPanel.dataset.recordState=t.state}}}},{key:"show",value:function e(){if(!this.elements.root){this.render()}this.container.appendChild(this.elements.root);if(this.layout!==Ia.Mobile){this.startIntersectionObserver()}this.updateButtons();this.updateUserList();this.resumeVideo();this.toggleEars();this.visible=true;this.eventEmitter.emit(Ma.onShow);this.disableFaceImprove();this.checkPanelOverflow()}},{key:"hide",value:function e(){this.closeCopilotNotify();this.clearCallcontrolPromo();if(this.overflownButtonsPopup){this.overflownButtonsPopup.close()}p.Dom.remove(this.elements.root);this.visible=false}},{key:"startIntersectionObserver",value:function e(){if(!("IntersectionObserver"in window)){return}this.intersectionObserver=new IntersectionObserver(this._onIntersectionChange.bind(this),{root:this.elements.userList.container,threshold:.5})}},{key:"observeIntersections",value:function e(t){if(this.intersectionObserver&&t.elements.root){this.intersectionObserver.observe(t.elements.root)}}},{key:"unobserveIntersections",value:function e(t){if(this.intersectionObserver&&t.elements.root){this.intersectionObserver.unobserve(t.elements.root)}}},{key:"showDeviceSelector",value:function e(t){var i=this,n;if(this.deviceSelector){return}this.deviceSelector=new hn({viewElement:this.container,parentElement:t,zIndex:this.baseZIndex+500,microphoneEnabled:!H.isMicrophoneMuted,microphoneId:this.microphoneId||H.defaultMicrophone,cameraEnabled:H.isCameraOn,cameraId:this.cameraId,speakerEnabled:!this.speakerMuted,speakerId:this.speakerId,allowHdVideo:H.preferHdQuality,faceImproveEnabled:Yf.isDesktop()&&r.DesktopApi.isDesktop()&&r.DesktopApi.getCameraSmoothingStatus(),allowFaceImprove:false,allowBackground:T.isAvailable()&&this.isIntranetOrExtranet,allowMask:T.isMaskAvailable()&&this.isIntranetOrExtranet,allowAdvancedSettings:typeof BXIM!=="undefined"&&this.isIntranetOrExtranet,switchCameraBlocked:this.blockedButtons["camera"],switchMicrophoneBlocked:this.blockedButtons["microphone"],events:(n={},babelHelpers.defineProperty(n,hn.Events.onMicrophoneSelect,this._onMicrophoneSelected.bind(this)),babelHelpers.defineProperty(n,hn.Events.onMicrophoneSwitch,this._onMicrophoneButtonClick.bind(this)),babelHelpers.defineProperty(n,hn.Events.onCameraSelect,this._onCameraSelected.bind(this)),babelHelpers.defineProperty(n,hn.Events.onCameraSwitch,this._onCameraButtonClick.bind(this)),babelHelpers.defineProperty(n,hn.Events.onSpeakerSelect,this._onSpeakerSelected.bind(this)),babelHelpers.defineProperty(n,hn.Events.onSpeakerSwitch,this._onSpeakerButtonClick.bind(this)),babelHelpers.defineProperty(n,hn.Events.onChangeHdVideo,this._onChangeHdVideo.bind(this)),babelHelpers.defineProperty(n,hn.Events.onChangeMicAutoParams,this._onChangeMicAutoParams.bind(this)),babelHelpers.defineProperty(n,hn.Events.onChangeFaceImprove,this._onChangeFaceImprove.bind(this)),babelHelpers.defineProperty(n,hn.Events.onChangeVideoQuality,this._onChangeVideoQuality.bind(this)),babelHelpers.defineProperty(n,hn.Events.onAdvancedSettingsClick,(function(){return i.eventEmitter.emit(Ma.onOpenAdvancedSettings)})),babelHelpers.defineProperty(n,hn.Events.onDestroy,(function(){var e,t,n,a;(e=i.buttons)===null||e===void 0?void 0:(t=e.microphone.elements.arrow)===null||t===void 0?void 0:t.classList.remove("rotate");(n=i.buttons)===null||n===void 0?void 0:(a=n.camera.elements.arrow)===null||a===void 0?void 0:a.classList.remove("rotate");i.deviceSelector=null})),babelHelpers.defineProperty(n,hn.Events.onShow,(function(){return i.eventEmitter.emit(Ma.onDeviceSelectorShow,{})})),n)});this.deviceSelector.show()}},{key:"showCallMenu",value:function e(){var t=this;var i=[{text:BX.message("IM_M_CALL_BTN_WANT_TO_SAY"),iconClass:"hand",onClick:this._onMobileCallMenuFloorRequestClick.bind(this)},{text:BX.message("IM_M_CALL_MOBILE_MENU_PARTICIPANTS_LIST"),iconClass:"participants",onClick:this._onMobileCallMenShowParticipantsClick.bind(this)},{text:BX.message("IM_M_CALL_MOBILE_MENU_COPY_INVITE"),iconClass:"add-participant",onClick:this._onMobileCallMenuCopyInviteClick.bind(this)},!this.isIntranetOrExtranet?{text:BX.message("IM_M_CALL_MOBILE_MENU_CHANGE_MY_NAME"),iconClass:"change-name",onClick:function e(){t.callMenu.close();setTimeout(t.showRenameSlider.bind(t),100)}}:null,{separator:true},{text:BX.message("IM_M_CALL_MOBILE_MENU_CANCEL"),enabled:false,onClick:this._onMobileCallMenuCancelClick.bind(this)}];this.callMenu=new an({parent:this.elements.root,items:i,onClose:function e(){return t.callMenu.destroy()},onDestroy:function e(){return t.callMenu=null}});this.callMenu.show()}},{key:"showUserMenu",value:function e(t){var i=this;var n=this.userRegistry.get(t);if(!n){return false}var a=null;if(this.pinnedUser&&this.pinnedUser.id==t){a={text:BX.message("IM_M_CALL_MOBILE_MENU_UNPIN"),iconClass:"unpin",onClick:function e(){i.userMenu.close();i.unpinUser()}}}else if(this.userId!=t){a={text:BX.message("IM_M_CALL_MOBILE_MENU_PIN"),iconClass:"pin",onClick:function e(){i.userMenu.close();i.pinUser(t)}}}var s=[{userModel:n,enabled:false},{separator:true},a,this.userId==t&&!this.isIntranetOrExtranet?{text:BX.message("IM_M_CALL_MOBILE_MENU_CHANGE_MY_NAME"),iconClass:"change-name",onClick:function e(){i.userMenu.close();setTimeout(i.showRenameSlider.bind(i),100)}}:null,{separator:true},{text:BX.message("IM_M_CALL_MOBILE_MENU_CANCEL"),enabled:false,onClick:function e(){return i.userMenu.close()}}];this.userMenu=new an({parent:this.elements.root,items:s,onClose:function e(){return i.userMenu.destroy()},onDestroy:function e(){return i.userMenu=null}});this.userMenu.show()}},{key:"showParticipantsMenu",value:function e(){var t=this;if(this.participantsMenu){return}var i=[{userModel:this.localUser.userModel,showSubMenu:true,onClick:function e(){t.participantsMenu.close();t.showUserMenu(t.localUser.userModel.id)}}];babelHelpers.toConsumableArray(this.userRegistry.users.values()).forEach((function(e){if(e.localUser||e.state!==yc.Connected){return}if(i.length>0){i.push({separator:true})}i.push({userModel:e,showSubMenu:true,onClick:function i(){t.participantsMenu.close();t.showUserMenu(e.id)}})}));if(i.length===0){return false}this.participantsMenu=new an({parent:this.elements.root,items:i,header:BX.message("IM_M_CALL_PARTICIPANTS").replace("#COUNT#",this.getConnectedUserCount(true)),largeIcons:true,onClose:function e(){t.participantsMenu.destroy()},onDestroy:function e(){t.participantsMenu=null}});this.participantsMenu.show();return true}},{key:"showMessage",value:function e(t){var i=p.Dom.create("div",{props:{className:"bx-messenger-videocall-user-status bx-messenger-videocall-user-status-wide"}});if(p.Type.isStringFilled(t.text)){var n=p.Dom.create("div",{props:{className:"bx-messenger-videocall-status-text"},text:t.text});p.Dom.append(n,i)}wa(this,qa,ts).call(this,i)}},{key:"hideMessage",value:function e(){this.elements.overlay.textContent=""}},{key:"renderSelfTestCallLayout",value:function e(){var t=p.Dom.create("div",{props:{className:"bx-messenger-videocall-error-container"},children:[p.Dom.create("div",{props:{className:"bx-messenger-videocall-error-container-icon-alert"}}),p.Dom.create("div",{props:{className:"bx-messenger-videocall-error-message"},text:p.Loc.getMessage("CALL_CONNECTED_ERROR")}),p.Dom.create("div",{props:{className:"bx-messenger-videocall-error-button-self-test"},text:p.Loc.getMessage("CALL_RUN_SELF_TEST"),events:{click:function e(){Yf.startSelfTest()}}})]});wa(this,qa,ts).call(this,t)}},{key:"renderReloadPageLayout",value:function e(){var t=this;var i=p.Dom.create("div",{props:{className:"bx-messenger-videocall-error-container"},children:[p.Dom.create("div",{props:{className:"bx-messenger-videocall-error-container-icon-alert"}}),p.Dom.create("div",{props:{className:"bx-messenger-videocall-error-message"},html:p.Loc.getMessage("CALL_SECURITY_KEY_CHANGED",{"[break]":"<br/>"})}),p.Dom.create("div",{props:{className:"bx-messenger-videocall-error-button-self-test"},text:p.Loc.getMessage("CALL_RELOAD_PAGE"),events:{click:function e(){t.destroy();location.reload()}}})]});wa(this,qa,ts).call(this,i)}},{key:"showFatalError",value:function e(t){this.showMessage(t);wa(this,Ya,is).call(this)}},{key:"showSecurityKeyError",value:function e(){this.renderReloadPageLayout();wa(this,Ya,is).call(this)}},{key:"showSelfTest",value:function e(){this.renderSelfTestCallLayout();wa(this,Ya,is).call(this)}},{key:"close",value:function e(){if(this.buttons.recordStatus){this.buttons.recordStatus.stopViewUpdate()}this.commonRecordState=this.getDefaultCommonRecordState();if(this.elements.root){BX.remove(this.elements.root)}if(this.pictureInPictureCallWindow){this.toggleStatePictureInPictureCallWindow(false)}this.visible=false;this.eventEmitter.emit(Ma.onClose);this.clearCallcontrolPromo()}},{key:"setSize",value:function e(t){if(this.size==t){return}this.size=t;if(this.size==Ea.Folded){this.clearCallcontrolPromo();if(this.overflownButtonsPopup){this.overflownButtonsPopup.close()}if(this.elements.panel){this.elements.panel.classList.add("bx-messenger-videocall-panel-folded")}p.Dom.remove(this.elements.container);p.Dom.remove(this.elements.topPanel);this.elements.root.style.removeProperty("max-width");this.updateButtons()}else{if(this.elements.panel){this.elements.panel.classList.remove("bx-messenger-videocall-panel-folded")}this.elements.wrap.appendChild(this.elements.topPanel);this.elements.wrap.appendChild(this.elements.container);if(this.maxWidth>0){this.elements.root.style.maxWidth=Math.max(this.maxWidth,Da)+"px"}this.updateButtons();this.updateUserList();this.resumeVideo()}if(this.pictureInPictureCallWindow){this.pictureInPictureCallWindow.setButtons(this.getPictureInPictureCallWindowGetButtonsList()).updateButtons()}}},{key:"isButtonBlocked",value:function e(t){switch(t){case"camera":return wa(this,Qa,ns).call(this);case"chat":return!this.showChatButtons||this.blockedButtons[t]===true;case"microphone":return!Yf.havePermissionToBroadcast("mic");case"floorRequest":return this.uiState!==_a.Connected||this.blockedButtons[t]===true;case"screen":return!this.showShareButton||!this.isScreenSharingSupported()||this.isFullScreen||this.blockedButtons[t]===true||!Yf.havePermissionToBroadcast("screenshare");case"users":return!this.showUsersButton||this.blockedButtons[t]===true;case"record":return!this.showRecordButton||this.blockedButtons[t]===true;case"document":return!this.showDocumentButton||this.blockedButtons[t]===true;case"copilot":return!this.showCopilotButton||this.blockedButtons[t]===true;default:return this.blockedButtons[t]===true}}},{key:"isButtonHidden",value:function e(t){return this.hiddenButtons[t]===true}},{key:"showButton",value:function e(t){this.showButtons([t])}},{key:"hideButton",value:function e(t){this.hideButtons([t])}},{key:"checkPanelOverflow",value:function e(){var t=this.elements.panel.scrollWidth-this.elements.panel.offsetWidth;var i=this.layout===Ia.Mobile?60:66;if(t>0){var n=Math.ceil(t/i)+1;var a=this.getButtonList();for(var s=a.length-1;s>=0;s--){if(a[s]==="hangupOptions"||a[s]==="hangup"||a[s]==="close"||a[s]==="more"){continue}this.overflownButtons[a[s]]=true;n-=1;if(!n){break}}return true}else{var r=Object.keys(this.overflownButtons).length;if(r>0){var o=this.calculateUnusedPanelSpace();if(o>320){var l=Math.min(Math.floor(o/i),r);var c=r-l;if(c===1){l+=1}if(l==r){this.overflownButtons={}}else{for(var u=0;u<l;u++){delete this.overflownButtons[Object.keys(this.overflownButtons)[0]]}}return true}}}return false}},{key:"showButtons",value:function e(t){var i=this;if(!p.Type.isArray(t)){console.error("buttons should be array")}t.forEach((function(e){if(i.hiddenButtons.hasOwnProperty(e)){delete i.hiddenButtons[e]}}));this.updateButtons()}},{key:"hideButtons",value:function e(t){var i=this;if(!p.Type.isArray(t)){console.error("buttons should be array")}t.forEach((function(e){return i.hiddenButtons[e]=true}));this.updateButtons()}},{key:"blockAddUser",value:function e(){this.blockButtons(["add"]);if(this.elements.userList.addButton){p.Dom.remove(this.elements.userList.addButton)}}},{key:"unblockAddUser",value:function e(){this.unblockButtons(["add"]);this.updateButtons()}},{key:"blockUsersButton",value:function e(){this.blockButtons(["users"]);this.updateButtons()}},{key:"unblockUsersButton",value:function e(){this.unblockButtons(["users"]);this.updateButtons()}},{key:"blockSwitchCamera",value:function e(){this.blockButtons(["camera"]);if(this.deviceSelector){this.deviceSelector.toggleCameraAvailability(false)}}},{key:"unblockSwitchCamera",value:function e(){this.unblockButtons(["camera"]);if(this.deviceSelector){this.deviceSelector.toggleCameraAvailability(true)}}},{key:"blockSwitchMicrophone",value:function e(){this.blockButtons(["microphone"]);if(this.deviceSelector){this.deviceSelector.toggleMicrophoneAvailability(false)}}},{key:"unblockSwitchMicrophone",value:function e(){this.unblockButtons(["microphone"]);if(this.deviceSelector){this.deviceSelector.toggleMicrophoneAvailability(true)}}},{key:"blockScreenSharing",value:function e(){this.blockButtons(["screen"])}},{key:"blockHistoryButton",value:function e(){this.blockButtons(["history"])}},{key:"blockButtons",value:function e(t){var i=this;if(!p.Type.isArray(t)){console.error("buttons should be array ")}t.forEach((function(e){i.blockedButtons[e]=true;if(i.buttons[e]){i.buttons[e].setBlocked(true)}}));if(this.pictureInPictureCallWindow){this.pictureInPictureCallWindow.updateBlockButtons(this.getBlockedButtonsListPictureInPictureCallWindow()).updateButtons()}}},{key:"unblockButtons",value:function e(t){var i=this;if(!p.Type.isArray(t)){console.error("buttons should be array")}t.forEach((function(e){delete i.blockedButtons[e];if(i.buttons[e]){i.buttons[e].setBlocked(i.isButtonBlocked(e))}}));if(this.pictureInPictureCallWindow){this.pictureInPictureCallWindow.updateBlockButtons(this.getBlockedButtonsListPictureInPictureCallWindow()).updateButtons()}}},{key:"disableMediaSelection",value:function e(){this.mediaSelectionBlocked=true}},{key:"enableMediaSelection",value:function e(){this.mediaSelectionBlocked=false;if(this.buttons.microphone&&this.isMediaSelectionAllowed()){this.buttons.microphone.showArrow()}if(this.buttons.camera&&this.isMediaSelectionAllowed()){this.buttons.camera.showArrow()}}},{key:"isMediaSelectionAllowed",value:function e(){return this.layout!=Ia.Mobile&&(this.uiState==_a.Preparing||this.uiState==_a.Connected)&&!this.mediaSelectionBlocked&&!this.isFullScreen}},{key:"getButtonList",value:function e(){var t=this;var i=[];if(this.uiState===_a.Error){i.push("close")}if(this.uiState===_a.Initializing){i.push("hangup")}if(this.size===Ea.Folded){i.push("title","spacer","returnToCall","hangup")}if(i.length>0){this.needToRerenderButtonList=this.previousButtonList.toString()!==i.toString();this.previousButtonList=i;return i}i.push("microphone","camera");if(this.layout!=Ia.Mobile){i.push("speaker")}else{i.push("mobileMenu")}var n=this.uiState===_a.Initializing||this.uiState===_a.Calling||this.uiState===_a.Connected||this.uiState===_a.Error;if(n){i.push("chat")}if(this.layout!==Ia.Mobile){i.push("users")}if(this.layout!=Ia.Mobile&&n){i.push("floorRequest","screen","record","document")}if(this.layout!==Ia.Mobile&&kn.serviceEnabled&&n){i.push("copilot")}i=i.filter((function(e){return!Object.prototype.hasOwnProperty.call(t.hiddenButtons,e)&&!Object.prototype.hasOwnProperty.call(t.overflownButtons,e)}));if(Object.keys(this.overflownButtons).length>0&&n){i.push("more")}if(this.uiState==_a.Preparing){i.push("close")}else{i.push("hangup")}if(!Object.prototype.hasOwnProperty.call(this.hiddenButtons,"hangupOptions")&&this.isIntranetOrExtranet){i.push("hangupOptions")}this.needToRerenderButtonList=this.previousButtonList.toString()!==i.toString();this.previousButtonList=i;return i}},{key:"getTopButtonList",value:function e(){var t=this;var i=[];if(this.layout==Ia.Mobile){return["participantsMobile"]}i.push("watermark");i.push("protected");i.push("recordStatus");i.push("spacer");if(this.uiState===_a.Connected&&this.layout!=Ia.Mobile){i.push("grid")}if(this.uiState!=_a.Preparing&&this.isFullScreenSupported()&&this.layout!=Ia.Mobile){i.push("fullscreen")}if(this.uiState===_a.Connected&&this.layout!=Ia.Mobile){i.push("feedback")}if(this.uiState===_a.Connected&&this.layout!=Ia.Mobile&&Yf.canControlChangeSettings()&&Yf.isUserControlFeatureEnabled()){i.push("callcontrol")}if(this.uiState!=_a.Preparing){i.push("participants")}var n="";i=i.filter((function(e){if(n==="spacer"&&e==="separator"){return true}n=e;return!t.hiddenTopButtons.hasOwnProperty(e)}));this.needToRerenderTopButtonList=this.previousTopButtonList.toString()!==i.toString();this.previousTopButtonList=i;return i}},{key:"render",value:function e(){var t=this;this.elements.root=p.Dom.create("div",{props:{className:"bx-messenger-videocall bx-messenger-videocall-scope"},children:[this.elements.wrap=p.Dom.create("div",{props:{className:"bx-messenger-videocall-wrap ".concat(this.isCopilotActive?"bx-messenger-videocall-wrap-with-copilot":"")},children:[this.elements.container=p.Dom.create("div",{props:{className:"bx-messenger-videocall-inner"},children:[this.elements.center=p.Dom.create("div",{props:{className:"bx-messenger-videocall-central-user"},events:{touchstart:this._onCenterTouchStart.bind(this),touchend:this._onCenterTouchEnd.bind(this)}}),this.elements.pageNavigatorLeft=p.Dom.create("div",{props:{className:"bx-messenger-videocall-page-navigator left"},children:[this.elements.pageNavigatorLeftCounter=p.Dom.create("div",{props:{className:"bx-messenger-videocall-page-navigator-counter left"},html:this.currentPage-1+"&nbsp;/&nbsp;"+this.pagesCount}),p.Dom.create("div",{props:{className:"bx-messenger-videocall-page-navigator-icon left"}})],events:{click:this._onLeftPageNavigatorClick.bind(this)}}),this.elements.pageNavigatorRight=p.Dom.create("div",{props:{className:"bx-messenger-videocall-page-navigator right"},children:[this.elements.pageNavigatorRightCounter=p.Dom.create("div",{props:{className:"bx-messenger-videocall-page-navigator-counter right"},html:this.currentPage+1+"&nbsp;/&nbsp;"+this.pagesCount}),p.Dom.create("div",{props:{className:"bx-messenger-videocall-page-navigator-icon right"}})],events:{click:this._onRightPageNavigatorClick.bind(this)}})]}),this.elements.topPanel=p.Dom.create("div",{props:{className:"bx-messenger-videocall-top-panel"}}),this.elements.notificationPanel=p.Dom.create("div",{props:{className:"bx-messenger-videocall-notification-panel"}}),this.elements.bottom=p.Dom.create("div",{props:{className:"bx-messenger-videocall-bottom"},children:[this.elements.userSelectorContainer=p.Dom.create("div",{props:{className:"bx-messenger-videocall-bottom-user-selector-container"}}),this.elements.pinnedUserContainer=p.Dom.create("div",{props:{className:"bx-messenger-videocall-bottom-pinned-user-container"}})]})]})],events:{click:this._onBodyClick.bind(this)}});this.talkingService.init({root:this.elements.root});this.talkingService.refreshQueue();if(this.showButtonPanel){this.elements.panel=p.Dom.create("div",{props:{className:"bx-messenger-videocall-panel"}});this.elements.bottom.appendChild(this.elements.panel)}else{this.elements.root.classList.add("bx-messenger-videocall-no-button-panel")}if(this.layout==Ia.Mobile){this.userSelector=new tn({userRegistry:this.userRegistry});this.userSelector.mount(this.elements.userSelectorContainer);this.elements.ear.left=p.Dom.create("div",{props:{className:"bx-messenger-videocall-mobile-ear left"},events:{click:this._onLeftEarClick.bind(this)}});this.elements.ear.right=p.Dom.create("div",{props:{className:"bx-messenger-videocall-mobile-ear right"},events:{click:this._onRightEarClick.bind(this)}});this.elements.localUserMobile=p.Dom.create("div",{props:{className:"bx-messenger-videocall-local-user-mobile"}});if(window.innerHeight<window.innerWidth){this.elements.root.classList.add("orientation-landscape")}this.elements.wrap.appendChild(this.elements.ear.left);this.elements.wrap.appendChild(this.elements.ear.right);this.elements.wrap.appendChild(this.elements.localUserMobile)}this.centralUser.mount(this.elements.center);this.elements.overlay=p.Dom.create("div",{props:{className:"bx-messenger-videocall-overlay"}});this.elements.userBlock=p.Dom.create("div",{props:{className:"bx-messenger-videocall-user-block"},children:[this.elements.ear.top=p.Dom.create("div",{props:{className:"bx-messenger-videocall-ear bx-messenger-videocall-ear-top"},children:[p.Dom.create("div",{props:{className:"bx-messenger-videocall-ear-icon"}})],events:{click:this._onTopPageNavigatorClick.bind(this)}}),this.elements.ear.bottom=p.Dom.create("div",{props:{className:"bx-messenger-videocall-ear bx-messenger-videocall-ear-bottom"},children:[p.Dom.create("div",{props:{className:"bx-messenger-videocall-ear-icon"}})],events:{click:this._onBottomPageNavigatorClick.bind(this)}})]});this.elements.userList.container=p.Dom.create("div",{props:{className:"bx-messenger-videocall-user-list"},events:{scroll:p.Runtime.debounce(this.toggleEars.bind(this),300),wheel:function e(i){return t.elements.userList.container.scrollTop+=i.deltaY}}});this.elements.userList.addButton=p.Dom.create("div",{props:{className:"bx-messenger-videocall-user-add"},children:[p.Dom.create("div",{props:{className:"bx-messenger-videocall-user-add-inner"}})],style:{order:Ba},events:{click:this._onAddButtonClick.bind(this)}});if(this.layout==Ia.Centered||this.layout==Ia.Mobile){this.centralUser.mount(this.elements.center);this.eventEmitter.emit(Ma.onHasMainStream,{userId:this.centralUser.id});this.elements.root.classList.add("bx-messenger-videocall-centered");if(this.layout!==Ia.Mobile){this.elements.container.appendChild(this.elements.userBlock)}}if(this.layout==Ia.Grid){this.elements.root.classList.add("bx-messenger-videocall-grid")}if(this.layout==Ia.Mobile){this.elements.root.classList.add("bx-messenger-videocall-fullscreen-mobile")}this.resizeObserver.observe(this.elements.root);this.resizeObserver.observe(this.container);return this.elements.root}},{key:"toggleSubscribingVideoInRenderUserList",value:function e(t,i){if(t.length>0){this.eventEmitter.emit(Ma.onToggleSubscribe,{participants:t,showVideo:i})}}},{key:"getOrderingRules",value:function e(){var t,i=this;var n=(t={},babelHelpers.defineProperty(t,Ta.VideoEnabled,[]),babelHelpers.defineProperty(t,Ta.VideoDisabled,[]),babelHelpers.defineProperty(t,Ta.UserDisconnected,null),t);this.rerenderQueue.forEach((function(e){switch(e.reason){case Ta.UserDisconnected:n[e.reason]={id:e.userId,order:i.userRegistry.get(e.userId).prevOrder};break;case Ta.VideoEnabled:case Ta.VideoDisabled:n[e.reason].push({id:e.userId,order:i.userRegistry.get(e.userId).order});break;default:}}));this.rerenderQueue.clear();n[Ta.VideoEnabled].sort((function(e,t){return e.order-t.order}));n[Ta.VideoDisabled].sort((function(e,t){return e.order-t.order}));return n}},{key:"applyOrderChanges",value:function e(t){var i=this;if(!p.Type.isArray(t)){return}t.forEach((function(e){if(e.type===Pa.Direct){e.to.userModel.order=e.to.order;i.cache["delete"]("activeUsers")}else if(e.type===Pa.Replace&&e.to&&e.from){e.to.userModel.order=e.from.order;e.to.userModel.prevOrder=0;e.from.userModel.order=e.to.order;i.cache["delete"]("activeUsers")}}))}},{key:"isUserHasActiveState",value:function e(t){return t.state!==yc.Idle&&t.state!==yc.Declined&&t.state!==yc.Unavailable&&t.state!==yc.Busy&&t.direction!==Sc.RecvOnly}},{key:"processVideoRules",value:function e(t,i){var n=this;var a=t[Ta.VideoEnabled].length-t[Ta.VideoDisabled].length;var s=a>0?Ta.VideoDisabled:Ta.VideoEnabled;var r=a>0?Ta.VideoEnabled:Ta.VideoDisabled;if(t[Ta.VideoEnabled].length>0&&t[Ta.VideoDisabled].length>0){t[s].forEach((function(e,a){var s=n.userRegistry.get(e.id);var o=n.userRegistry.get(t[r][a].id);i.orderChanges.push({type:Pa.Replace,to:{userModel:o,order:o.order},from:{userModel:s,order:s.order}})}))}this.applyOrderChanges(i.orderChanges);i.orderChanges.length=0;if(a===0){t[Ta.VideoEnabled].length=0;t[Ta.VideoDisabled].length=0}else{t[r].splice(0,t[r].length-Math.abs(a));t[s].length=0;if(r===Ta.VideoEnabled){t[r].forEach((function(e){i.orderChanges.push({type:Pa.Replace,from:{userModel:n.userRegistry.get(e.id),order:n.userRegistry.get(e.id).order}});i.incompleteSwaps.push(i.orderChanges.length)}))}}}},{key:"processDisconnectRules",value:function e(t,i){if(!t[Ta.UserDisconnected]){return}var n=this.userRegistry.get(t[Ta.UserDisconnected].id);if(n.prevCameraState){i.disconnectedUserHadVideo=true}}},{key:"completeVideoEnableSwap",value:function e(t,i,n){var a=n.incompleteSwaps.length;if(t.state===yc.Calling){return}if(n.usersWithEnabledVideo.includes(t.id)){n.incompleteSwaps.pop();n.usersWithEnabledVideo.splice(n.usersWithEnabledVideo.indexOf(t.id),1);n.usersToKeepActive.push(t.id)}else if(!t.cameraState){var s,r;var o=n.incompleteSwaps[a-1]-1;var l=n.orderChanges[o].from;var c=(s=n.possibleActiveUsers)===null||s===void 0?void 0:s.includes(t.id);var u=(r=n.possibleActiveUsers)===null||r===void 0?void 0:r.includes(l.userModel.id);var d=u||c&&u;n.orderChanges[o].to={userModel:t,order:t.order};if(!d){n.currentPageUsers.pop();n.usersToDeactivate++}else if(u&&!c){n.usersToForceDeactivation.push(l.userModel.id)}else if(c&&u){n.usersToKeepActive.push(t.id)}n.incompleteSwaps.pop()}}},{key:"completeVideoDisabledSwap",value:function e(t,i){var n=this;var a=0;t[Ta.VideoDisabled].forEach((function(e){var t=n.userRegistry.get(e.id);var s=i.activeUsers.indexOf(e.id);var r=Math.ceil((s+1)/n.usersPerPage);var o=(r-1)*n.usersPerPage;var l=i.usersWithVideo.length-o;var c=i.usersWithVideo[i.usersWithVideo.length-1-a];var u=c&&c.order>e.order;if(u&&l-a>=0){a++;i.orderChanges.push({type:Pa.Replace,to:{userModel:t,order:t.order},from:{userModel:c,order:c.order}});var d=i.activeUsers.indexOf(c.id);var h=Math.ceil((d+1)/n.usersPerPage);if(r===n.currentPage&&h>n.currentPage){i.usersToKeepActive.push(c.id);i.usersToForceDeactivation.push(e.id);i.usersToDeactivate++}else if(h===n.currentPage&&h>r){i.usersToKeepActive.push(e.id);i.usersToForceDeactivation.push(c.id);i.usersToDeactivate++}}}));this.applyOrderChanges(i.orderChanges)}},{key:"calculateUserActive",value:function e(t,i,n,a){if(a.usersWithEnabledVideo.includes(t.id)&&!n&&!a.possibleActiveUsers.includes(t.id)){a.currentPageUsers.push(t);a.usersToDeactivate--;i=true}else if(a.currentPageUsers.length+a.usersToDeactivate>this.usersPerPage){a.currentPageUsers.pop();i=false}return i}},{key:"completeDisconnectSwap",value:function e(t,i){var n,a;var s=t[Ta.UserDisconnected];if(!s){return}var r=(n=this.userRegistry.get(i.possibleActiveUsers[0]))===null||n===void 0?void 0:n.order;var o=(a=this.userRegistry.get(i.possibleActiveUsers[i.possibleActiveUsers.length-1]))===null||a===void 0?void 0:a.order;var l=false;if(this.currentPage===1){l=s.order<r||s.order>r&&s.order<o}else{var c=(this.currentPage-2)*this.usersPerPage;var u=i.activeUsers.slice(c,c+this.usersPerPage);var d=this.userRegistry.get(u[u.length-1]);l=s.order>r&&s.order<o||s.order<r&&s.order>(d===null||d===void 0?void 0:d.order)}var h=i.disconnectedUserHadVideo?i.usersWithVideo[i.usersWithVideo.length-1]:this.userRegistry.get(i.activeUsers[i.activeUsers.length-1]);if(!h||h.order<=s.order){return}i.orderChanges.push({type:Pa.Direct,to:{userModel:h,order:s.order}});if(this.currentPage!==this.pagesCount&&l&&!i.possibleActiveUsers.includes(h.id)){i.usersToKeepActive.push(h.id);i.usersToDeactivate++}this.applyOrderChanges(i.orderChanges)}},{key:"renderAddUserButtonInList",value:function e(){var t=this.showAddUserButtonInList&&this.layout==Ia.Centered&&this.uiState===_a.Connected&&!this.isButtonBlocked("add")&&this.getConnectedUserCount()<this.userLimit-1&&!this.isFullScreen&&this.elements.userList.addButton;if(t){this.elements.userList.container.appendChild(this.elements.userList.addButton);return}p.Dom.remove(this.elements.userList.addButton)}},{key:"renderUserList",value:function e(t){var i=this;clearTimeout(this.rerenderTimeout);this.rerenderTimeout=null;this.activeUsers=[];this.inactiveUsers=[];var n=this.shouldShowLocalUser();var a=0;var s=0;var r=0;var o=0;var l=this.getOrderingRules();var c={usersWithVideo:[],usersWithEnabledVideo:[],usersWithDisabledVideo:[],possibleActiveUsers:null,usersToKeepActive:[],usersToForceDeactivation:[],currentPageUsers:[],orderChanges:[],incompleteSwaps:[],disconnectedUserHadVideo:false,usersToDeactivate:0,videoDisabledProceed:false};if((this.layout===Ia.Grid||this.layout===Ia.Centered)&&this.pagesCount>1){s=(this.currentPage-1)*this.usersPerPage}if(this.layout===Ia.Grid){this.processVideoRules(l,c);this.processDisconnectRules(l,c);c.usersWithEnabledVideo=l[Ta.VideoEnabled].map((function(e){return e.id}));c.usersWithDisabledVideo=l[Ta.VideoDisabled].map((function(e){return e.id}));c.activeUsers=this.getActiveUsers();c.possibleActiveUsers=c.activeUsers.slice(s,s+this.usersPerPage);c.usersWithVideo=this.getUsersWithCamera();this.completeVideoDisabledSwap(l,c);this.completeDisconnectSwap(l,c);c.activeUsers=this.getActiveUsers();c.possibleActiveUsers=c.activeUsers.slice(s,s+this.usersPerPage)}else if(this.layout===Ia.Centered){l[Ta.VideoEnabled].forEach((function(e){return i.shelvedRerenderQueue.set(e.id,{userId:e.id,reason:Ta.VideoEnabled})}));l[Ta.VideoDisabled].forEach((function(e){return i.shelvedRerenderQueue.set(e.id,{userId:e.id,reason:Ta.VideoDisabled})}))}var u=babelHelpers.toConsumableArray(this.userRegistry.users.values());var d=ga(u),h;try{for(d.s();!(h=d.n()).done;){var p=h.value;var v=p.id;if(!this.users.hasOwnProperty(v)){continue}var f=this.users[v];var m=this.screenUsers[v];if(v==this.centralUser.id&&(this.layout==Ia.Centered||this.layout==Ia.Mobile)){if(this.layout==Ia.Centered){this.activeUsers.push(v)}this.unobserveIntersections(f);if(m.hasVideo()){m.mount(this.elements.center);m.visible=true;f.mount(this.elements.userList.container)}else{f.visible=true;f.mount(this.elements.center);m.dismount()}continue}var g=this.isUserHasActiveState(p);var b=false;if(g&&s>0&&r<s){r++;g=false;b=true}if(g&&this.layout===Ia.Grid&&this.usersPerPage>0&&o<this.usersPerPage){c.currentPageUsers.push(p)}if(this.layout===Ia.Grid){if(l[Ta.VideoEnabled].length>0){if((g||b)&&c.incompleteSwaps.length>0){var C,k;var y=c.incompleteSwaps.length;var S=c.incompleteSwaps[0]-1;var w=c.orderChanges[S].from;var I=(C=c.possibleActiveUsers)===null||C===void 0?void 0:C.includes(p.id);var T=(k=c.possibleActiveUsers)===null||k===void 0?void 0:k.includes(w.userModel.id);this.completeVideoEnableSwap(p,l,c);var P=y!==c.incompleteSwaps.length;if(P&&g&&!T&&!c.usersToKeepActive.includes(p.id)){g=false}else if(P&&(!b&&!I||b&&T)){g=true}}if(c.usersToDeactivate){g=this.calculateUserActive(p,g,b,c)}if(c.usersToForceDeactivation.includes(p.id)){g=false}}else if(l[Ta.VideoDisabled].length>0){if(c.usersToKeepActive.includes(p.id)){g=true;c.usersToDeactivate--}else if(c.usersToForceDeactivation.includes(p.id)||c.currentPageUsers.length+c.usersToDeactivate>this.usersPerPage){g=false;c.currentPageUsers.pop()}}else if(l[Ta.UserDisconnected]){if(c.usersToKeepActive.includes(p.id)){g=true;c.usersToDeactivate--}else if(c.currentPageUsers.length+c.usersToDeactivate>this.usersPerPage){g=false;c.currentPageUsers.pop()}}}if(g&&(this.layout===Ia.Grid||this.layout===Ia.Centered)&&this.usersPerPage>0&&o>=this.usersPerPage){g=false}if(g){this.activeUsers.push(v)}else{this.inactiveUsers.push(v)}if(!g){f.dismount();this.unobserveIntersections(f);m.dismount();continue}if(m.hasVideo()){m.mount(this.elements.userList.container);a++}else{m.dismount()}f.mount(this.elements.userList.container);if(!this.isPreparing){this.observeIntersections(f)}o++;a++}}catch(e){d.e(e)}finally{d.f()}this.applyOrderChanges(c.orderChanges);if(n){if(this.layout==Ia.Centered&&this.userId==this.centralUser.id||this.layout==Ia.Mobile){this.localUser.mount(this.elements.center,true);this.localUser.visible=true}else{this.localUser.mount(this.elements.userList.container);if(this.layout==Ia.Centered&&this.intersectionObserver);else{this.localUser.visible=true}}a++}else{this.localUser.dismount()}if(this.layout==Ia.Grid){this.updateGridUserSize(a)}else{this.elements.userList.container.classList.add("bx-messenger-videocall-user-list-small");this.elements.userList.container.style.removeProperty("--avatar-size");this.elements.userList.container.style.removeProperty("--avatar-text-size");this.updateCentralUserAvatarSize()}this.applyIncomingVideoConstraints();this.renderAddUserButtonInList();this.elements.root.classList.toggle("bx-messenger-videocall-user-list-empty",this.elements.userList.container.childElementCount===0);this.localUser.updatePanelDeferred();var _=this.currentPiPUserId?[].concat(babelHelpers.toConsumableArray(this.activeUsers),[this.currentPiPUserId]):this.activeUsers;var E=babelHelpers.toConsumableArray(this.inactiveUsers);var R=this.currentPiPUserId?E.indexOf(this.currentPiPUserId):-1;if(R!==-1){E.splice(R,1)}var M=_.map((function(e){return{userId:e}}));this.toggleSubscribingVideoInRenderUserList(M,true);var A=E.map((function(e){return{userId:e}}));this.toggleSubscribingVideoInRenderUserList(A,false)}},{key:"shouldShowLocalUser",value:function e(){return this.localUser.userModel.state!=yc.Idle&&this.localUser.userModel.direction!=Sc.RecvOnly}},{key:"updateGridUserSize",value:function e(t){var i=this.elements.userList.container.getBoundingClientRect();this.userSize=Yf.findBestElementSize(i.width,i.height,t,Oa,Ua);var n=Math.floor(i.height/Ua)||1;this.userSize.width-=5*n;this.userSize.height-=2.75*n;var a=Math.round(this.userSize.height*.45);var s=Math.round(a*.45);this.elements.userList.container.style.setProperty("--grid-user-width",this.userSize.width+"px");this.elements.userList.container.style.setProperty("--grid-user-height",this.userSize.height+"px");this.elements.userList.container.style.setProperty("--avatar-size",a+"px");this.elements.userList.container.style.setProperty("--avatar-text-size",s+"px");if(this.userSize.width<220){this.elements.userList.container.classList.add("bx-messenger-videocall-user-list-small")}else{this.elements.userList.container.classList.remove("bx-messenger-videocall-user-list-small")}}},{key:"updateCentralUserAvatarSize",value:function e(){var t;var i;if(this.layout==Ia.Mobile){t=this.elements.root.getBoundingClientRect();i=Math.round(t.width*.55)}else if(this.layout==Ia.Centered){t=this.elements.center.getBoundingClientRect();i=Math.min(Math.round(t.height*.45),Math.round(t.width*.45));this.centralUser.setIncomingVideoConstraints(Math.floor(t.width),Math.floor(t.height))}var n=Math.round(i*.45);this.elements.center.style.setProperty("--avatar-size",i+"px");this.elements.center.style.setProperty("--avatar-text-size",n+"px")}},{key:"renderButtons",value:function e(t,i){var n=this;var a,s,r,o;if(i){a=p.Dom.create("div",{props:{className:"bx-messenger-videocall-panel-inner"}})}if(this.layout===Ia.Mobile||this.size===Ea.Folded){s=a;r=a;o=a}else if(i){s=p.Dom.create("div",{props:{className:"bx-messenger-videocall-panel-inner-left"}});r=p.Dom.create("div",{props:{className:"bx-messenger-videocall-panel-inner-center"}});o=p.Dom.create("div",{props:{className:"bx-messenger-videocall-panel-inner-right"}});p.Dom.append(s,a);p.Dom.append(r,a);p.Dom.append(o,a)}for(var l=0;l<t.length;l++){switch(t[l]){case"title":if(this.buttons.title){this.buttons.title.update({text:this.title,isGroupCall:Object.keys(this.users).length>1})}else{this.buttons.title=new zi({text:this.title,isGroupCall:Object.keys(this.users).length>1})}if(i){p.Dom.append(this.buttons.title.render(),s)}break;case"share":if(i){this.buttons.share=new ji({class:"share",text:BX.message("IM_M_CALL_BTN_LINK"),onClick:this._onShareButtonClick.bind(this)});p.Dom.append(this.buttons.share.render(),r)}break;case"microphone":if(this.buttons.microphone){this.buttons.microphone.setBlocked(this.isButtonBlocked("microphone"))}else{this.buttons.microphone=new qi(ma({class:"microphone",text:BX.message("IM_M_CALL_BTN_MIC"),enabled:!H.isMicrophoneMuted,arrowHidden:this.layout===Ia.Mobile,arrowEnabled:this.isMediaSelectionAllowed(),showPointer:true,blocked:this.isButtonBlocked("microphone"),showLevel:true,sideIcon:this.getMicrophoneSideIcon(this.roomState),onClick:this._onMicrophoneButtonClick.bind(this),onArrowClick:this._onMicrophoneArrowClick.bind(this),onSideIconClick:this._onMicrophoneSideIconClick.bind(this)},Yf.isDesktop()?{tooltip:{position:"top",getText:function e(){return H.isMicrophoneMuted?"".concat(BX.message("IM_SPACE_HOTKEY"),"\\A"," ").concat(n.keyModifierForCss," + A"," "):"".concat(n.keyModifierForCss," + A")}}}:{}))}if(i){p.Dom.append(this.buttons.microphone.render(),s)}break;case"camera":if(this.buttons.camera){this.buttons.camera.setBlocked(this.isButtonBlocked("camera"))}else{this.buttons.camera=new qi(ma({class:"camera",text:BX.message("IM_M_CALL_BTN_CAMERA"),enabled:H.isCameraOn,arrowHidden:this.layout===Ia.Mobile,arrowEnabled:this.isMediaSelectionAllowed(),blocked:this.isButtonBlocked("camera"),onClick:this._onCameraButtonClick.bind(this),onArrowClick:this._onCameraArrowClick.bind(this)},Yf.isDesktop()?{tooltip:{position:"top",getText:function e(){return"".concat(n.keyModifierForCss," + V")}}}:{}))}if(i){p.Dom.append(this.buttons.camera.render(),s)}break;case"screen":if(this.buttons.screen){this.buttons.screen.setBlocked(this.isButtonBlocked("screen"))}else{this.buttons.screen=new ji(ma({class:"screen",backgroundClass:"bx-messenger-videocall-panel-background-screen",text:BX.message("IM_M_CALL_BTN_SCREEN"),blocked:this.isButtonBlocked("screen"),onClick:this._onScreenButtonClick.bind(this)},Yf.isDesktop()?{tooltip:{position:"top",getText:function e(){return"".concat(n.keyModifierForCss," + S")}}}:{}))}if(i){p.Dom.append(this.buttons.screen.render(),r)}break;case"record":if(this.buttons.record){this.buttons.record.setBlocked(this.isButtonBlocked("record"))}else{this.buttons.record=new ji(ma({class:"record",backgroundClass:"bx-messenger-videocall-panel-background-record",text:p.Loc.getMessage("IM_M_CALL_BTN_RECORD"),blocked:this.isButtonBlocked("record"),onClick:wa(this,Ka,ss).bind(this)},Yf.isDesktop()?{tooltip:{position:"top",getText:function e(){return"".concat(n.keyModifierForCss," + R")}}}:{}))}if(i){p.Dom.append(this.buttons.record.render(),r)}break;case"document":if(this.buttons.document){this.buttons.document.setBlocked(this.isButtonBlocked("document"))}else{this.buttons.document=new ji({class:"document",backgroundClass:"bx-messenger-videocall-panel-background-document",text:BX.message("IM_M_CALL_BTN_DOCUMENT"),blocked:this.isButtonBlocked("document"),onClick:this._onDocumentButtonClick.bind(this)})}if(i){p.Dom.append(this.buttons.document.render(),r)}break;case"copilot":if(this.buttons.copilot){this.buttons.copilot.setBlocked(this.isButtonBlocked("copilot"));this.buttons.copilot.setActive(this.isCopilotActive)}else{this.buttons.copilot=new ji(ma({class:"copilot",backgroundClass:"bx-messenger-videocall-panel-background-copilot",text:BX.message("CALL_BUTTON_COPILOT_TITLE"),blocked:this.isButtonBlocked("copilot"),onClick:this._onCopilotButtonClick.bind(this),isComingSoon:!this.isCopilotFeaturesEnabled},Yf.isDesktop()?{tooltip:{position:"top",getText:function e(){return n.isCopilotActive?p.Loc.getMessage("CALL_COPILOT_BUTTON_ON_HINT_V2"):p.Loc.getMessage("CALL_COPILOT_BUTTON_OFF_HINT")}}}:{}))}if(i){p.Dom.append(this.buttons.copilot.render(),r)}break;case"returnToCall":if(i){this.buttons.returnToCall=new ji({class:"returnToCall",text:BX.message("IM_M_CALL_BTN_RETURN_TO_CALL"),onClick:this._onBodyClick.bind(this)});p.Dom.append(this.buttons.returnToCall.render(),o)}break;case"hangup":if(i){this.buttons.hangup=new ji({class:"hangup",backgroundClass:"bx-messenger-videocall-panel-icon-background-hangup",text:Object.keys(this.users).length>1?BX.message("IM_M_CALL_BTN_DISCONNECT"):BX.message("IM_M_CALL_BTN_HANGUP"),onClick:this._onHangupButtonClick.bind(this)});p.Dom.append(this.buttons.hangup.render(),o)}break;case"hangupOptions":if(i){this.buttons.hangupOptions=new ji({class:"hangup-options",backgroundClass:"bx-messenger-videocall-panel-icon-background-hangup-options",onClick:this._onHangupOptionsButtonClick.bind(this)});p.Dom.append(this.buttons.hangupOptions.render(),o)}break;case"close":if(i){this.buttons.close=new ji({class:"close",backgroundClass:"bx-messenger-videocall-panel-icon-background-hangup",text:BX.message("IM_M_CALL_BTN_CLOSE"),onClick:this._onCloseButtonClick.bind(this)});p.Dom.append(this.buttons.close.render(),o)}break;case"speaker":break;case"mobileMenu":if(i){if(!this.buttons.mobileMenu){this.buttons.mobileMenu=new ji({class:"sandwich",text:BX.message("IM_M_CALL_BTN_MENU"),onClick:this._onMobileMenuButtonClick.bind(this)})}p.Dom.append(this.buttons.mobileMenu.render(),r)}break;case"chat":if(this.buttons.chat){this.buttons.chat.setBlocked(this.isButtonBlocked("chat"))}else{this.buttons.chat=new ji(ma({class:"chat",backgroundClass:"bx-messenger-videocall-panel-background-chat",text:BX.message("IM_M_CALL_BTN_CHAT"),blocked:this.isButtonBlocked("chat"),onClick:this._onChatButtonClick.bind(this)},Yf.isDesktop()?{tooltip:{position:"top",getText:function e(){return"".concat(n.keyModifierForCss," + C")}}}:{}))}if(i){p.Dom.append(this.buttons.chat.render(),r)}break;case"floorRequest":if(!this.buttons.floorRequest){this.buttons.floorRequest=new ji(ma({class:"floor-request",backgroundClass:"bx-messenger-videocall-panel-background-floor-request",text:BX.message("IM_M_CALL_BTN_WANT_TO_SAY"),blocked:this.isButtonBlocked("floorRequest"),onClick:this._onFloorRequestButtonClick.bind(this)},Yf.isDesktop()?{tooltip:{position:"top",getText:function e(){return"".concat(n.keyModifierForCss," + H")}}}:{}))}else{this.buttons.floorRequest.setBlocked(this.isButtonBlocked("floorRequest"))}if(i){p.Dom.append(this.buttons.floorRequest.render(),r)}break;case"more":if(i){if(!this.buttons.more){this.buttons.more=new ji({class:"more",onClick:this._onMoreButtonClick.bind(this)})}p.Dom.append(this.buttons.more.render(),r)}break;case"spacer":if(i){a.appendChild(p.Dom.create("div",{props:{className:"bx-messenger-videocall-panel-spacer"}}))}break}}return a}},{key:"renderTopButtons",value:function e(t,i){var n=this;for(var a=0;a<t.length;a++){switch(t[a]){case"watermark":if(!this.buttons.waterMark){this.buttons.waterMark=new Yi({language:this.language})}if(i){p.Dom.append(this.buttons.waterMark.render(),this.elements.topPanel)}break;case"protected":if(!this.buttons["protected"]){this.buttons["protected"]=new Ji({iconClass:"protected",textClass:"protected",text:BX.message("IM_M_CALL_PROTECTED").toLowerCase(),tooltip:{width:"384px",position:"bottom",getText:function e(){return BX.message("IM_M_CALL_PROTECTED_HINT")}}})}if(i){p.Dom.append(this.buttons["protected"].render(),this.elements.topPanel)}break;case"recordStatus":if(this.buttons.recordStatus){this.buttons.recordStatus.updateView()}else{this.buttons.recordStatus=new $i({userId:this.userId,commonRecordState:this.commonRecordState,tooltip:{position:"bottom",getText:function e(){var t=n.userData[n.commonRecordState.userId];if(!t){return""}var i=p.Text.encode(t.name);var a=t.gender||"M";return p.Loc.getMessage("CALL_COMMON_RECORD_INITIATOR_HINT_".concat(a)).replace("#USER_NAME#",i)}}})}if(i){p.Dom.append(this.buttons.recordStatus.render(),this.elements.topPanel)}break;case"grid":if(this.buttons.grid){this.buttons.grid.update({iconClass:this.layout===Ia.Grid?"speaker":"grid",text:this.layout===Ia.Grid?BX.message("IM_M_CALL_SPEAKER_MODE"):BX.message("IM_M_CALL_GRID_MODE_MSGVER_1")})}else{this.buttons.grid=new Qi(ma({iconClass:this.layout===Ia.Grid?"speaker":"grid",text:this.layout===Ia.Grid?BX.message("IM_M_CALL_SPEAKER_MODE"):BX.message("IM_M_CALL_GRID_MODE_MSGVER_1"),onClick:this._onGridButtonClick.bind(this)},Yf.isDesktop()?{tooltip:{position:"bottom",getText:function e(){return"".concat(n.keyModifierForCss," + W")}}}:{}))}if(i){p.Dom.append(this.buttons.grid.render(),this.elements.topPanel)}break;case"fullscreen":if(this.buttons.fullscreen){this.buttons.fullscreen.update({iconClass:this.isFullScreen?"fullscreen-leave":"fullscreen-enter",text:this.isFullScreen?BX.message("IM_M_CALL_WINDOW_MODE"):BX.message("IM_M_CALL_FULLSCREEN_MODE")})}else{this.buttons.fullscreen=new Qi({iconClass:this.isFullScreen?"fullscreen-leave":"fullscreen-enter",text:this.isFullScreen?BX.message("IM_M_CALL_WINDOW_MODE"):BX.message("IM_M_CALL_FULLSCREEN_MODE"),onClick:this._onFullScreenButtonClick.bind(this)})}if(i){p.Dom.append(this.buttons.fullscreen.render(),this.elements.topPanel)}break;case"feedback":if(!this.buttons.feedback){this.buttons.feedback=new Qi({iconClass:"feedback",text:BX.message("IM_OL_COMMENT_HEAD_BUTTON_VOTE"),onClick:this._onFeedbackButtonClick.bind(this)})}if(i){p.Dom.append(this.buttons.feedback.render(),this.elements.topPanel)}break;case"callcontrol":if(!this.buttons.callcontrol){this.buttons.callcontrol=new Qi({iconClass:"callcontrol",text:BX.message("CALL_CALLCONTROL_BUTTON_LABEL"),onClick:this._onCallcontrolButtonClick.bind(this)})}if(i){p.Dom.append(this.buttons.callcontrol.render(),this.elements.topPanel)}break;case"participants":var s=Ki.FoldButtonState.Hidden;if(this.isFullScreen&&this.layout===Ia.Centered){s=this.isUserBlockFolded?Ki.FoldButtonState.Unfold:Ki.FoldButtonState.Fold}else if(this.showUsersButton){s=Ki.FoldButtonState.Active}if(this.buttons.participants){this.buttons.participants.update({foldButtonState:s,allowAdding:!this.isButtonBlocked("add"),count:this.getConnectedUserCount(true)})}else{this.buttons.participants=new Ki({foldButtonState:s,allowAdding:!this.isButtonBlocked("add"),count:this.getConnectedUserCount(true),onListClick:this._onParticipantsButtonListClick.bind(this),onAddClick:this._onAddButtonClick.bind(this)})}if(i){p.Dom.append(this.buttons.participants.render(),this.elements.topPanel)}break;case"participantsMobile":if(!this.buttons.participantsMobile){this.buttons.participantsMobile=new Zi({count:this.getConnectedUserCount(true),onClick:this._onParticipantsButtonMobileListClick.bind(this)})}if(i){p.Dom.append(this.buttons.participantsMobile.render(),this.elements.topPanel)}break;case"separator":if(i){this.elements.topPanel.appendChild(p.Dom.create("div",{props:{className:"bx-messenger-videocall-top-separator"}}))}break;case"spacer":if(i){this.elements.topPanel.appendChild(p.Dom.create("div",{props:{className:"bx-messenger-videocall-top-panel-spacer"}}))}break}}}},{key:"updateCopilotState",value:function e(t){this.isCopilotActive=t;this.setButtonActive("copilot",this.isCopilotActive);if(this.elements.wrap){this.elements.wrap.classList[this.isCopilotActive?"add":"remove"]("bx-messenger-videocall-wrap-with-copilot")}}},{key:"updateCopilotFeatureState",value:function e(t){this.isCopilotFeaturesEnabled=t;if(!this.buttons.copilot){return}this.buttons.copilot.setIsComingSoon(!this.isCopilotFeaturesEnabled)}},{key:"showCopilotNotify",value:function e(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:0;var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:"";var n=i?null:mn[this.isCopilotActive?"COPILOT_ENABLED":"COPILOT_DISABLED"];if(n){wa(this,Ja,as).call(this,n,t)}}},{key:"closeCopilotNotify",value:function e(){if(this.copilotNotify){this.copilotNotify.close();this.copilotNotify=null}}},{key:"showCopilotResultNotify",value:function e(){wa(this,Ja,as).call(this,mn.COPILOT_RESULT)}},{key:"showCopilotErrorNotify",value:function e(t){var i=mn[t];wa(this,Ja,as).call(this,i)}},{key:"createCopilotNotify",value:function e(t,i){var n=this;if(!this.buttons.copilot){return null}return new gn({type:t,bindElement:this.buttons.copilot.elements.root,onClose:function e(){n.copilotNotify=null},callId:i})}},{key:"createAhaMomentNotifyCallcontrol",value:function e(){var t=this;if(!this.buttons.callcontrol){return}if(this.ahaMomentNotifyCallcontrol){this.ahaMomentNotifyCallcontrol.show();return this.ahaMomentNotifyCallcontrol}this.ahaMomentNotifyCallcontrol=new _n({notifyTitle:BX.message("CALL_CALLCONTROL_AXA_MOMENT_TITLE"),notifyText:BX.message("CALL_CALLCONTROL_AXA_MOMENT_TEXT"),bindElement:this.buttons.callcontrol.elements.root,promoId:Ga,onClose:function e(){t.needToShowCallcontrolPromo=false;t.ahaMomentNotifyCallcontrol=null}});this.ahaMomentNotifyCallcontrol.show();return this.ahaMomentNotifyCallcontrol}},{key:"calculateUnusedPanelSpace",value:function e(t){if(!t){t=this.getButtonList()}var i=0;for(var n=0;n<t.length;n++){var a=this.buttons[t[n]];if(!a){continue}var s=a.elements.root?a.elements.root.getBoundingClientRect().width:0;i+=s}return this.elements.panel.scrollWidth-i-32}},{key:"setWindowFocusState",value:function e(t){if(t===this.isWindowFocus){return}this.isWindowFocus=t;if(this.pictureInPictureCallWindow){this.pictureInPictureCallWindow.setButtons(this.getPictureInPictureCallWindowGetButtonsList()).updateButtons()}}},{key:"getPictureInPictureCallWindowGetButtonsList",value:function t(){var i=["microphone","camera"];if(this.getButtonActive("screen")){i.push("stop-screen")}var n=this.viewVisibility.getCurrentVisibility()===Xa.hidden;if(this.size===e.Size.Folded||n){i.push("returnToCall")}return i}},{key:"getPictureInPictureCallWindowUser",value:function e(){var t,i;var n=this.presenterId||((t=this.centralUser)===null||t===void 0?void 0:t.userModel.id)||this.userId;var a=+this.userId===+n;var s=a?this.localUser:this.users[n];var r=!!this.currentPiPUserId&&n===this.currentPiPUserId;if(r){return}if(!this.activeUsers.includes(n)&&!a){this.toggleSubscribingVideoInRenderUserList([{userId:n}],true)}if(this.currentPiPUserId&&+this.userId!==+this.currentPiPUserId&&!this.activeUsers.includes(this.currentPiPUserId)){this.toggleSubscribingVideoInRenderUserList([{userId:this.currentPiPUserId}],false)}this.currentPiPUserId=n;var o={userModel:this.userRegistry.get(n),avatarBackground:s.avatarBackground,videoRenderer:s.videoRenderer,previewRenderer:s.previewRenderer};if(s.videoTrack){o.videoRenderer=new yn({kind:"video",track:s.videoTrack})}if(!a&&(i=this.screenUsers[n])!==null&&i!==void 0&&i.videoTrack){o.previewRenderer=new yn({kind:"sharing",track:this.screenUsers[n].videoTrack})}if(a&&this.localStreamVideoTrack){o.previewRenderer=new yn({kind:"sharing",track:this.localStreamVideoTrack})}return o}},{key:"getBlockedButtonsListPictureInPictureCallWindow",value:function e(){var t=[];if(this.isButtonBlocked("camera")){t.push("camera")}if(this.isButtonBlocked("microphone")){t.push("microphone")}if(this.isButtonBlocked("screen")){t.push("screen")}return t}},{key:"_onPiPClose",value:function e(){this.eventEmitter.emit(Ma.onPiPClose)}},{key:"toggleStatePictureInPictureCallWindow",value:function e(t){var i=this;var n=In.isAvailable;if(t&&!this.pictureInPictureCallWindow&&n&&Yf.isPictureInPictureFeatureEnabled()){this.pictureInPictureCallWindow=new In({currentUser:this.getPictureInPictureCallWindowUser(),isCopilotFeaturesEnabled:this.isCopilotFeaturesEnabled,buttons:this.getPictureInPictureCallWindowGetButtonsList(),blockedButtons:this.getBlockedButtonsListPictureInPictureCallWindow(),allowPinButton:false,allowBackgroundItem:T.isAvailable()&&this.isIntranetOrExtranet,allowMaskItem:T.isMaskAvailable()&&this.isIntranetOrExtranet,preferInitialWindowPlacement:this.preferInitialWindowPlacementPictureInPicture,floorRequestNotifications:this.floorRequestNotifications,onClose:function e(){i.pictureInPictureCallWindow=null;i.currentPiPUserId=null;i._onPiPClose()},onButtonClick:function e(t){var n=t.buttonName,a=t.event;switch(n){case"microphone":i._onMicrophoneButtonClick(a);break;case"camera":i._onCameraButtonClick(a);break;case"returnToCall":i.eventEmitter.emit(Ma.onPiPBodyClick);break;case"stop-screen":i._onScreenButtonClick(a);break;default:break}}});this.pictureInPictureCallWindow.checkAvailableAndCreate().then((function(){i.preferInitialWindowPlacementPictureInPicture=false}))}if(!t&&this.pictureInPictureCallWindow){this.enableAutoPip=false;this.pictureInPictureCallWindow.close()}}},{key:"setButtonActive",value:function e(t,i){if(!this.buttons[t]){return}this.buttons[t].setActive(i);if(this.pictureInPictureCallWindow){this.pictureInPictureCallWindow.setButtons(this.getPictureInPictureCallWindowGetButtonsList()).updateButtons()}}},{key:"getButtonActive",value:function e(t){if(!this.buttons||!this.buttons[t]){return false}return this.buttons[t].isActive}},{key:"setButtonCounter",value:function e(t,i){if(!this.buttons[t]){return}this.buttons[t].setCounter(i)}},{key:"updateUserList",value:function e(t){var i=this;if(this.layout==Ia.Mobile){if(this.localUser!=this.centralUser){if(this.localUser.hasVideo()){this.localUser.mount(this.elements.localUserMobile);this.localUser.visible=true}else{this.localUser.dismount()}this.centralUser.mount(this.elements.center);this.eventEmitter.emit(Ma.onHasMainStream,{userId:this.centralUser.id});this.centralUser.visible=true}return}if((this.layout==Ia.Grid||this.layout==Ia.Centered)&&this.size==Ea.Full){this.recalculatePages()}if(t){this.shelvedRerenderQueue.forEach((function(e){if(e.reason===Ta.VideoEnabled){i.updateRerenderQueue(e.userId,e.reason)}else if(e.reason===Ta.VideoDisabled){i.updateRerenderQueue(e.userId,e.reason)}}));this.shelvedRerenderQueue.clear()}this.renderUserList();if(this.layout==Ia.Centered){if(!this.elements.userList.container.parentElement){this.elements.userBlock.appendChild(this.elements.userList.container)}}else if(this.layout==Ia.Grid){if(!this.elements.userList.container.parentElement){this.elements.container.appendChild(this.elements.userList.container)}}this.toggleEars()}},{key:"showOverflownButtonsPopup",value:function e(){var t=this;if(this.overflownButtonsPopup){this.overflownButtonsPopup.show();return}var i=this.buttons.more&&this.buttons.more.elements.root?this.buttons.more.elements.root:this.elements.panel;this.overflownButtonsPopup=new v.Popup({id:"bx-call-buttons-popup",bindElement:i,targetContainer:this.container,content:this.renderButtons(Object.keys(this.overflownButtons),true),cacheable:false,closeIcon:false,autoHide:true,overlay:{backgroundColor:"white",opacity:0},bindOptions:{position:"top"},angle:{position:"bottom",offset:49},className:"bx-call-buttons-popup",contentBackground:"unset",events:{onPopupDestroy:function e(){t.overflownButtonsPopup=null;t.buttons.more.setActive(false)}}});this.overflownButtonsPopup.show()}},{key:"resumeVideo",value:function e(){for(var t in this.users){var i=this.users[t];i.playVideo();var n=this.screenUsers[t];n.playVideo()}this.localUser.playVideo()}},{key:"updateUserButtons",value:function e(){var t=this.getConnectedUserCount();var i=this.cache.get("previousConnectedUserCount");if(t>1&&i>1){return}for(var n in this.users){if(this.users.hasOwnProperty(n)){this.users[n].allowPinButton=t>1}}}},{key:"updateButtons",value:function t(){var i=this;var n=arguments.length>0&&arguments[0]!==undefined?arguments[0]:[];if(!this.elements.panel){return}if(!n.includes("panel")){var a=this.getButtonList();if(this.needToRerenderButtonList){p.Dom.clean(this.elements.panel);p.Dom.append(this.renderButtons(a,this.needToRerenderButtonList),this.elements.panel);this.needToRerenderButtonList=false}else{this.renderButtons(a)}}if(this.elements.topPanel){var s=this.getTopButtonList();if(this.needToRerenderTopButtonList){p.Dom.clean(this.elements.topPanel)}this.renderTopButtons(s,this.needToRerenderTopButtonList);this.needToRerenderTopButtonList=false}if(this.buttons.participantsMobile){this.buttons.participantsMobile.setCount(this.getConnectedUserCount(true))}if(this.showCallcontrolPromoPopupTimeout){clearTimeout(this.showCallcontrolPromoPopupTimeout)}if(this.needToShowCallcontrolPromo){this.showCallcontrolPromoPopupTimeout=setTimeout((function(){if(i.size!==e.Size.Folded){i.createAhaMomentNotifyCallcontrol()}}),1500)}this.renderAddUserButtonInList()}},{key:"updateUserData",value:function e(t){for(var i in t){if(!this.userData[i]){this.userData[i]={name:"",avatar_hr:"",gender:"M"}}if(t[i].name){this.userData[i].name=t[i].name}if(t[i].avatar_hr){this.userData[i].avatar_hr=Yf.isAvatarBlank(t[i].avatar_hr)?"":t[i].avatar_hr}else if(t[i].avatar){this.userData[i].avatar_hr=Yf.isAvatarBlank(t[i].avatar)?"":t[i].avatar}if(t[i].gender){this.userData[i].gender=t[i].gender==="F"?"F":"M"}var n=this.userRegistry.get(i);if(n){n.name=this.userData[i].name;n.avatar=Fi(this.userData[i].avatar_hr)}}}},{key:"isScreenSharingSupported",value:function e(){return navigator.mediaDevices&&typeof navigator.mediaDevices.getDisplayMedia==="function"||typeof BXDesktopSystem!=="undefined"}},{key:"isRecordingHotKeySupported",value:function e(){return typeof BXDesktopSystem!=="undefined"&&BXDesktopSystem.ApiVersion()>=60}},{key:"isFullScreenSupported",value:function e(){if(BX.browser.IsChrome()||BX.browser.IsSafari()){return document.webkitFullscreenEnabled===true}else if(BX.browser.IsFirefox()){return document.fullscreenEnabled===true}else{return false}}},{key:"toggleEars",value:function e(){this.toggleTopEar();this.toggleBottomEar();if(this.layout==Ia.Grid&&this.pagesCount>1&&this.currentPage>1){this.elements.pageNavigatorLeft.classList.add("active")}else{this.elements.pageNavigatorLeft.classList.remove("active")}if(this.layout==Ia.Grid&&this.pagesCount>1&&this.currentPage<this.pagesCount){this.elements.pageNavigatorRight.classList.add("active")}else{this.elements.pageNavigatorRight.classList.remove("active")}}},{key:"toggleTopEar",value:function e(){if(this.layout!==Ia.Grid&&this.pagesCount>1){this.elements.ear.top.classList.add("active")}else{this.elements.ear.top.classList.remove("active")}}},{key:"toggleBottomEar",value:function e(){if(this.layout!==Ia.Grid&&this.pagesCount>1){this.elements.ear.bottom.classList.add("active")}else{this.elements.ear.bottom.classList.remove("active")}}},{key:"scrollUserListUp",value:function e(){var t=this;this.stopScroll();this.scrollInterval=setInterval((function(){return t.elements.userList.container.scrollTop-=10}),20)}},{key:"scrollUserListDown",value:function e(){var t=this;this.stopScroll();this.scrollInterval=setInterval((function(){return t.elements.userList.container.scrollTop+=10}),20)}},{key:"stopScroll",value:function e(){if(this.scrollInterval){clearInterval(this.scrollInterval);this.scrollInterval=0}}},{key:"toggleRenameSliderInputLoader",value:function e(){this.elements.renameSlider.button.classList.add("ui-btn-wait")}},{key:"setHotKeyTemporaryBlock",value:function e(t,i){if(!!t){this.hotKeyTemporaryBlock++}else{this.hotKeyTemporaryBlock--;if(this.hotKeyTemporaryBlock<0||i){this.hotKeyTemporaryBlock=0}}}},{key:"setHotKeyActive",value:function e(t,i){if(typeof this.hotKey[t]==="undefined"){return}this.hotKey[t]=!!i}},{key:"isHotKeyActive",value:function e(t){if(!this.hotKey["all"]){return false}if(this.hotKeyTemporaryBlock>0){return false}if(this.isButtonHidden(t)){return false}if(this.isButtonBlocked(t)){return false}return!!this.hotKey[t]}},{key:"showCommonRecordMenuPopup",value:function e(){var t=this;var i=arguments.length>0&&arguments[0]!==undefined?arguments[0]:false;if(babelHelpers.classPrivateFieldGet(this,za).menuPopup){babelHelpers.classPrivateFieldGet(this,za).menuPopup.close();return}var n=[Di.Stopped,Di.Destroyed].includes(this.commonRecordState.state)?"kind":"control";babelHelpers.classPrivateFieldGet(this,za).menuPopup=new Zn({state:this.commonRecordState.state,popupType:n,isDesktopRecord:i,onStart:function e(i){t.eventEmitter.emit(Ma.onCommonRecordMenu,{state:Di.Started,kind:i})},onStop:function e(){t.eventEmitter.emit(Ma.onCommonRecordMenu,{state:Di.Stopped})},onPause:function e(){var i;if(t.commonRecordState.state===Di.Paused){t.commonRecordState.state=Di.Started;i=Di.Resumed}else{t.commonRecordState.state=Di.Paused;i=t.commonRecordState.state}t.buttons.recordStatus.update(t.commonRecordState);t.eventEmitter.emit(Ma.onCommonRecordMenu,{state:i})},onDestroy:function e(){if(!xi.serviceEnabled){return}t.eventEmitter.emit(Ma.onCommonRecordMenu,{state:Di.Destroyed})},onClose:function e(){babelHelpers.classPrivateFieldGet(t,za).menuPopup=null}});babelHelpers.classPrivateFieldGet(this,za).menuPopup.toggle()}},{key:"showCloudRecordInfoPopup",value:function e(t,i){var n=this;if(babelHelpers.classPrivateFieldGet(this,za).infoPopup){babelHelpers.classPrivateFieldGet(this,za).infoPopup.close();return}babelHelpers.classPrivateFieldGet(this,za).infoPopup=new Hn({isCloudRecordFeaturesEnabled:t,callId:i,onClose:function e(){babelHelpers.classPrivateFieldGet(n,za).infoPopup=null},turnOn:function e(){n.showCommonRecordMenuPopup()}});babelHelpers.classPrivateFieldGet(this,za).infoPopup.toggle()}},{key:"showCommonRecordStartNotify",value:function e(t){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:Di.Started;if(babelHelpers.classPrivateFieldGet(this,za).notify){babelHelpers.classPrivateFieldGet(this,za).notify.close();babelHelpers.classPrivateFieldGet(this,za).notify=null}var n=this.userRegistry.get(t);var a=n&&n.data.gender?n.data.gender.toUpperCase():"M";babelHelpers.classPrivateFieldGet(this,za).notify=BX.UI.Notification.Center.notify({position:"top-right",autoHideDelay:8e3,closeButton:true,render:function e(){var t;return p.Dom.create("div",{props:{className:"ui-notification-balloon-content call-cloud-record-notify"},children:[p.Dom.create("div",{props:{className:"ui-notification-balloon-message"},children:[p.Dom.create("div",{props:{className:"call-cloud-record-notify__icon"}}),p.Dom.create("div",{props:{className:"call-cloud-record-notify__message"},text:p.Loc.getMessage("CALL_CLOUD_RECORD_NOTIFY_".concat(i.toUpperCase(),"_").concat(a),{"#INITIATOR_NAME#":(n===null||n===void 0?void 0:(t=n.data)===null||t===void 0?void 0:t.name)||""})})]}),p.Dom.create("div",{props:{className:"ui-notification-balloon-actions"}}),this.getCloseButton()]})}})}},{key:"closeCommonRecordPopups",value:function e(){if(babelHelpers.classPrivateFieldGet(this,za).menuPopup){babelHelpers.classPrivateFieldGet(this,za).menuPopup.close();babelHelpers.classPrivateFieldGet(this,za).menuPopup=null}if(babelHelpers.classPrivateFieldGet(this,za).infoPopup){babelHelpers.classPrivateFieldGet(this,za).infoPopup.close();babelHelpers.classPrivateFieldGet(this,za).infoPopup=null}if(babelHelpers.classPrivateFieldGet(this,za).notify){babelHelpers.classPrivateFieldGet(this,za).notify.close();babelHelpers.classPrivateFieldGet(this,za).notify=null}}},{key:"showConfirmModal",value:function e(t){var i=this;if(babelHelpers.classPrivateFieldGet(this,ja)){babelHelpers.classPrivateFieldGet(this,ja).close();babelHelpers.classPrivateFieldSet(this,ja,null)}return new Promise((function(e){var n=false;var a=function t(i){if(n){return}n=true;e(i)};babelHelpers.classPrivateFieldSet(i,ja,new la(ma(ma({},t),{},{onClose:function e(){babelHelpers.classPrivateFieldSet(i,ja,null);a("close")},onClickYesButton:function e(){return a("yes")},onClickNoButton:function e(){return a("no")}})));babelHelpers.classPrivateFieldGet(i,ja).show()}))}},{key:"showCommonRecordStartModal",value:function e(){this.showConfirmModal({title:p.Loc.getMessage("CALL_CLOUD_RECORD_MODAL_START_TITLE"),message:p.Loc.getMessage("CALL_CLOUD_RECORD_MODAL_START_MESSAGE"),yesButtonText:p.Loc.getMessage("CALL_CLOUD_RECORD_MODAL_START_RESUME_BUTTON")})}},{key:"showCloudRecordPromo",value:function e(t,i){if(this.isVideoconf){return}var a=n.PromoManager.getInstance().needToShow(Wa);if(a){this.showCloudRecordInfoPopup(t,i);n.PromoManager.getInstance().markAsWatched(Wa)}}},{key:"_onBodyClick",value:function e(){this.eventEmitter.emit(Ma.onBodyClick)}},{key:"_onCenterTouchStart",value:function e(t){this.centerTouchX=t.pageX}},{key:"_onCenterTouchEnd",value:function e(t){var i=t.pageX-this.centerTouchX;if(i>100){this.pinUser(this.getRightUser(this.centralUser.id));t.preventDefault()}if(i<-100){this.pinUser(this.getLeftUser(this.centralUser.id));t.preventDefault()}}},{key:"_onFullScreenChange",value:function e(){if("webkitFullscreenElement"in document){this.isFullScreen=!!document.webkitFullscreenElement}else if("fullscreenElement"in document){this.isFullScreen=!!document.fullscreenElement}else{return}setTimeout(function(){if(!this.elements.root){return}if(this.isFullScreen){this.elements.root.classList.add("bx-messenger-videocall-fullscreen")}else{this.elements.root.classList.remove("bx-messenger-videocall-fullscreen")}this.updateUserList();this.updateButtons();this.setUserBlockFolded(this.isFullScreen)}.bind(this),0)}},{key:"_onIntersectionChange",value:function e(t){var i={};t.forEach((function(e){i[e.target.dataset.userId]=e.isIntersecting}));for(var n in i){if(this.users[n]){this.users[n].visible=i[n]}if(n==this.localUser.id){this.localUser.visible=i[n]}}}},{key:"_onResize",value:function e(){if(!this.elements.root){return}if(this.centralUser);if(BX.browser.IsMobile()){document.documentElement.style.setProperty("--view-height",window.innerHeight+"px")}if(this.layout==Ia.Grid||this.layout==Ia.Centered){this.updateUserList()}else{this.updateCentralUserAvatarSize();this.toggleEars()}var t=this.elements.root.getBoundingClientRect();this.elements.root.classList.toggle("bx-messenger-videocall-width-lt-450",t.width<450);this.elements.root.classList.toggle("bx-messenger-videocall-width-lt-550",t.width<550);this.elements.root.classList.toggle("bx-messenger-videocall-width-lt-650",t.width<650);this.elements.root.classList.toggle("bx-messenger-videocall-width-lt-700",t.width<700);this.elements.root.classList.toggle("bx-messenger-videocall-width-lt-850",t.width<850);this.elements.root.classList.toggle("bx-messenger-videocall-width-lt-900",t.width<900);this.elements.root.classList.toggle("bx-messenger-videocall-width-lt-1050",t.width<1050);if(this.checkPanelOverflow()){this.updateButtons();if(this.overflownButtonsPopup&&!Object.keys(this.overflownButtons).length){this.overflownButtonsPopup.close()}}}},{key:"_onOrientationChange",value:function e(){if(!this.elements.root){return}if(window.innerHeight>window.innerWidth){this.elements.root.classList.remove("orientation-landscape")}else{this.elements.root.classList.add("orientation-landscape")}}},{key:"_destroyHotKeyHint",value:function e(){if(!Yf.isDesktop()){return}if(!this.hintManager.popup){return}this.hintManager.hide();this.hintManager.popup.destroy();this.hintManager.popup=null}},{key:"_onKeyDown",value:function t(i){if(!Yf.isDesktop()){return}if(!(i.shiftKey&&(i.ctrlKey||i.metaKey))&&!(i.code==="Space")){return}if(event.repeat){return}var n=this.size===e.Size.Folded;if(i.code==="KeyA"&&this.isHotKeyActive("microphone")){i.preventDefault();if(this.deviceSelector){this.deviceSelector.destroy()}this._onMicrophoneButtonClick(i)}else if(i.code==="Space"&&H.isMicrophoneMuted&&this.isHotKeyActive("microphoneSpace")){if(!n){i.preventDefault();this.pushToTalk=true;this.microphoneHotkeyTimerId=setTimeout(function(){if(this.deviceSelector){this.deviceSelector.destroy()}this._onMicrophoneButtonClick(i)}.bind(this),100)}}else if(i.code==="KeyS"&&this.isHotKeyActive("screen")){i.preventDefault();this._onScreenButtonClick(i)}else if(i.code==="KeyV"&&this.isHotKeyActive("camera")){i.preventDefault();if(this.deviceSelector){this.deviceSelector.destroy()}this._onCameraButtonClick(i)}else if(i.code==="KeyU"&&this.isHotKeyActive("users")){i.preventDefault();this._onUsersButtonClick(i)}else if(i.code==="KeyR"&&this.isRecordingHotKeySupported()&&this.isHotKeyActive("record")){i.preventDefault();wa(this,Za,rs).call(this)}else if(i.code==="KeyH"&&this.isHotKeyActive("floorRequest")){i.preventDefault();this._onFloorRequestButtonClick(i)}else if(i.code==="KeyC"&&this.isHotKeyActive("chat")){i.preventDefault();if(n){this._onBodyClick(i)}else{this._onChatButtonClick(i);this._destroyHotKeyHint()}}else if(i.code==="KeyM"&&this.isHotKeyActive("muteSpeaker")){i.preventDefault();this.eventEmitter.emit(Ma.onButtonClick,{buttonName:"toggleSpeaker",speakerMuted:this.speakerMuted,fromHotKey:true})}else if(i.code==="KeyW"&&this.isHotKeyActive("grid")){i.preventDefault();this.setLayout(this.layout==Ia.Centered?Ia.Grid:Ia.Centered)}}},{key:"_onKeyUp",value:function e(t){if(!Yf.isDesktop()){return}clearTimeout(this.microphoneHotkeyTimerId);if(this.pushToTalk&&!H.isMicrophoneMuted&&t.code==="Space"){t.preventDefault();this.pushToTalk=false;if(this.deviceSelector){this.deviceSelector.destroy()}this._onMicrophoneButtonClick(t)}}},{key:"_onUserClick",value:function e(t){var i=t.userId;if(i==this.centralUser.id&&this.layout!=Ia.Grid){this.elements.root.classList.toggle("bx-messenger-videocall-hidden-panels")}if(this.layout==Ia.Centered&&i!=this.centralUser.id){this.pinUser(i)}else{this.pinnedUser&&this.pinnedUser.id===i?this._onUserUnPin():this._onUserPin({userId:i})}this.eventEmitter.emit(Ma.onUserClick,{userId:i,stream:i==this.userId?this.localUser.stream:this.users[i].stream,layout:this.layout})}},{key:"_onUserRename",value:function e(t){this.eventEmitter.emit(Ma.onUserRename,{newName:t})}},{key:"_onUserRenameInputFocus",value:function e(){this.setHotKeyTemporaryBlock(true)}},{key:"_onUserRenameInputBlur",value:function e(){this.setHotKeyTemporaryBlock(false)}},{key:"_onUserPin",value:function e(t){if(this.layout==Ia.Grid){this.setLayout(Ia.Centered)}this.pinUser(t.userId)}},{key:"_onUserUnPin",value:function e(){if(this.layout==Ia.Centered){this.setLayout(Ia.Grid)}this.unpinUser()}},{key:"_onTurnOffParticipantMic",value:function e(t){this.eventEmitter.emit(Ma.onTurnOffParticipantMic,{userId:t.userId})}},{key:"_onTurnOffParticipantCam",value:function e(t){this.eventEmitter.emit(Ma.onTurnOffParticipantCam,{userId:t.userId})}},{key:"_onTurnOffParticipantScreenshare",value:function e(t){this.eventEmitter.emit(Ma.onTurnOffParticipantScreenshare,{userId:t.userId})}},{key:"_onDocumentButtonClick",value:function e(t){t.stopPropagation();this.eventEmitter.emit(Ma.onButtonClick,{buttonName:"document",node:t.target})}},{key:"_onCopilotButtonClick",value:function e(t){t.stopPropagation();this.eventEmitter.emit(Ma.onButtonClick,{buttonName:"copilot",node:t.target})}},{key:"_onGridButtonClick",value:function e(){this.setLayout(this.layout==Ia.Centered?Ia.Grid:Ia.Centered);if(this.layout==Ia.Centered&&this.localUser.id!==this.centralUser.id){this.eventEmitter.emit(Ma.onHasMainStream,{userId:this.centralUser.id})}}},{key:"_onAddButtonClick",value:function e(t){t.stopPropagation();this.eventEmitter.emit(Ma.onButtonClick,{buttonName:"inviteUser",node:t.currentTarget})}},{key:"_onShareButtonClick",value:function e(t){t.stopPropagation();this.eventEmitter.emit(Ma.onButtonClick,{buttonName:"share",node:t.currentTarget})}},{key:"_onMicrophoneButtonClick",value:function e(t){if(this.isButtonBlocked("microphone")){return}if("stopPropagation"in t){t.stopPropagation()}this.eventEmitter.emit(Ma.onButtonClick,{buttonName:"toggleMute",muted:!H.isMicrophoneMuted})}},{key:"_onMicrophoneArrowClick",value:function e(t){t.stopPropagation();this.showDeviceSelector(t.currentTarget)}},{key:"_onMicrophoneSideIconClick",value:function e(t){t.stopPropagation();this.eventEmitter.emit(Ma.onButtonClick,{buttonName:"microphoneSideIcon"})}},{key:"_onMicrophoneSelected",value:function e(t){this.eventEmitter.emit(Ma.onReplaceMicrophone,{deviceId:t.data.deviceId})}},{key:"_onCameraButtonClick",value:function e(t){if(this.isButtonBlocked("camera")){return}if("stopPropagation"in t){t.stopPropagation()}this.eventEmitter.emit(Ma.onButtonClick,{buttonName:"toggleVideo",video:!H.isCameraOn})}},{key:"_onCameraArrowClick",value:function e(t){t.stopPropagation();this.showDeviceSelector(t.currentTarget)}},{key:"_onCameraSelected",value:function e(t){this.eventEmitter.emit(Ma.onReplaceCamera,{deviceId:t.data.deviceId})}},{key:"_onSpeakerButtonClick",value:function e(){this.eventEmitter.emit(Ma.onButtonClick,{buttonName:"toggleSpeaker",speakerMuted:this.speakerMuted})}},{key:"_onChangeHdVideo",value:function e(t){this.eventEmitter.emit(Ma.onChangeHdVideo,t.data)}},{key:"_onChangeMicAutoParams",value:function e(t){this.eventEmitter.emit(Ma.onChangeMicAutoParams,t.data)}},{key:"_onChangeFaceImprove",value:function e(t){this.eventEmitter.emit(Ma.onChangeFaceImprove,t.data)}},{key:"_onChangeVideoQuality",value:function e(t){this.eventEmitter.emit(Ma.onChangeVideoQuality,t.data)}},{key:"disableFaceImprove",value:function e(){if(Yf.isDesktop()&&r.DesktopApi.isDesktop()&&r.DesktopApi.getCameraSmoothingStatus()){this.eventEmitter.emit(Ma.onChangeFaceImprove,{faceImproveEnabled:false})}}},{key:"_onSpeakerSelected",value:function e(t){this.setSpeakerId(t.data.deviceId);this.eventEmitter.emit(Ma.onReplaceSpeaker,{deviceId:t.data.deviceId})}},{key:"_onScreenButtonClick",value:function e(t){var i=this;t.stopPropagation();var n=this.getScreenSharingLimitation();this.onClickButtonWithLimit(n,(function(){i.eventEmitter.emit(Ma.onButtonClick,{buttonName:"toggleScreenSharing",node:t.target})}))}},{key:"_onChatButtonClick",value:function e(t){this.hintManager.hide();t.stopPropagation();this.eventEmitter.emit(Ma.onButtonClick,{buttonName:"showChat",node:t.target})}},{key:"_onUsersButtonClick",value:function e(t){this.hintManager.hide();t.stopPropagation();this.eventEmitter.emit(Ma.onButtonClick,{buttonName:"toggleUsers",node:t.target})}},{key:"_onMobileMenuButtonClick",value:function e(t){t.stopPropagation();this.showCallMenu()}},{key:"_onFloorRequestButtonClick",value:function e(t){t.stopPropagation();this.eventEmitter.emit(Ma.onButtonClick,{buttonName:"floorRequest",node:t.target})}},{key:"_onMoreButtonClick",value:function e(t){t.stopPropagation();if(this.overflownButtonsPopup){this.overflownButtonsPopup.close();this.buttons.more.setActive(false)}else{this.showOverflownButtonsPopup();this.buttons.more.setActive(true)}}},{key:"_onHistoryButtonClick",value:function e(t){t.stopPropagation();this.eventEmitter.emit(Ma.onButtonClick,{buttonName:"showHistory",node:t.target})}},{key:"_onHangupButtonClick",value:function e(t){t.stopPropagation();this.clearNewLogicRules();this.eventEmitter.emit(Ma.onButtonClick,{buttonName:"hangup",node:t.target})}},{key:"_onHangupOptionsButtonClick",value:function e(t){t.stopPropagation();this.eventEmitter.emit(Ma.onButtonClick,{buttonName:"hangupOptions",node:t.target})}},{key:"_onCloseButtonClick",value:function e(t){t.stopPropagation();this.eventEmitter.emit(Ma.onButtonClick,{buttonName:"close",node:t.target})}},{key:"_onFullScreenButtonClick",value:function e(t){t.stopPropagation();this.eventEmitter.emit(Ma.onButtonClick,{buttonName:"fullscreen",node:t.target})}},{key:"_onFeedbackButtonClick",value:function e(t){t.stopPropagation();this.eventEmitter.emit(Ma.onButtonClick,{buttonName:"feedback",node:t.target})}},{key:"_onCallcontrolButtonClick",value:function e(t){t.stopPropagation();this.eventEmitter.emit(Ma.onButtonClick,{buttonName:"callcontrol",node:t.target});if(this.ahaMomentNotifyCallcontrol){n.PromoManager.getInstance().markAsWatched(Ga)}this.clearCallcontrolPromo()}},{key:"_onParticipantsButtonListClick",value:function e(t){if(!this.isButtonBlocked("users")){this._onUsersButtonClick(t);return}if(!this.isFullScreen){return}this.setUserBlockFolded(!this.isUserBlockFolded)}},{key:"_onParticipantsListButtonClick",value:function e(t){var i=this;t.stopPropagation();var n=new f.BaseEvent({data:{buttonName:"participantsList",node:t.target},compatData:["participantsList",t.target]});this.eventEmitter.emit(Ma.onButtonClick,n);if(n.isDefaultPrevented()){return}Tn.create({parentElement:t.currentTarget,zIndex:this.baseZIndex+500,userList:Object.values(this.users),current:this.centralUser.id,onSelect:function e(t){return i.setCentralUser(t)}}).show()}},{key:"_onParticipantsButtonMobileListClick",value:function e(){this.showParticipantsMenu()}},{key:"_onMobileCallMenuFloorRequestClick",value:function e(){this.callMenu.close();this.eventEmitter.emit(Ma.onButtonClick,{buttonName:"floorRequest"})}},{key:"_onMobileCallMenShowParticipantsClick",value:function e(){this.callMenu.close();this.showParticipantsMenu()}},{key:"_onMobileCallMenuCopyInviteClick",value:function e(){this.callMenu.close();this.eventEmitter.emit(Ma.onButtonClick,{buttonName:"share",node:null})}},{key:"showRenameSlider",value:function e(){var t=this;if(!this.renameSlider){this.renameSlider=new nn({parent:this.elements.root,content:this.renderRenameSlider(),onClose:function e(){return t.renameSlider.destroy()},onDestroy:function e(){return t.renameSlider=null}})}this.renameSlider.show();setTimeout((function(){t.elements.renameSlider.input.focus();t.elements.renameSlider.input.select()}),400)}},{key:"renderRenameSlider",value:function e(){return p.Dom.create("div",{props:{className:"bx-videocall-mobile-rename-slider-wrap"},children:[p.Dom.create("div",{props:{className:"bx-videocall-mobile-rename-slider-title"},text:BX.message("IM_M_CALL_MOBILE_MENU_CHANGE_MY_NAME")}),this.elements.renameSlider.input=p.Dom.create("input",{props:{className:"bx-videocall-mobile-rename-slider-input"},attrs:{type:"text",value:this.localUser.userModel.name}}),this.elements.renameSlider.button=p.Dom.create("button",{props:{className:"bx-videocall-mobile-rename-slider-button ui-btn ui-btn-md ui-btn-primary"},text:BX.message("IM_M_CALL_MOBILE_RENAME_CONFIRM"),events:{click:this._onMobileUserRename.bind(this)}})]})}},{key:"_onMobileUserRename",value:function e(t){t.stopPropagation();var i=this.elements.renameSlider.input.value;var n=i.trim();var a=true;if(n===this.localUser.userModel.name||n===""){a=false}if(a){this.toggleRenameSliderInputLoader();this._onUserRename(n)}else{this.renameSlider.close()}}},{key:"_onMobileCallMenuCancelClick",value:function e(){this.callMenu.close()}},{key:"_onLeftEarClick",value:function e(){this.pinUser(this.getLeftUser(this.centralUser.id))}},{key:"_onRightEarClick",value:function e(){this.pinUser(this.getRightUser(this.centralUser.id))}},{key:"_onLeftPageNavigatorClick",value:function e(t){t.stopPropagation();this.setCurrentPage(this.currentPage-1)}},{key:"_onRightPageNavigatorClick",value:function e(t){t.stopPropagation();this.setCurrentPage(this.currentPage+1)}},{key:"_onTopPageNavigatorClick",value:function e(t){t.stopPropagation();this.setCurrentPage(this.currentPage!==1?this.currentPage-1:this.pagesCount)}},{key:"_onBottomPageNavigatorClick",value:function e(t){t.stopPropagation();this.setCurrentPage(this.currentPage!==this.pagesCount?this.currentPage+1:1)}},{key:"setMaxWidth",value:function t(i){if(this.maxWidth!==i){var n=650;if(i<n&&(!this.maxWidth||this.maxWidth>n)&&this.layout===Ia.Centered){this.setLayout(Ia.Grid)}var a=this.maxWidth===null;this.maxWidth=i;if(this.size!==e.Size.Folded){this._applyMaxWidth(a)}}}},{key:"removeMaxWidth",value:function e(){this.setMaxWidth(null)}},{key:"_applyMaxWidth",value:function e(t){var i=this;var n=this.container.getBoundingClientRect();if(this.maxWidth!==null){if(!this.elements.root.style.maxWidth&&t){this.elements.root.style.maxWidth=n.width+"px"}setTimeout((function(){return i.elements.root.style.maxWidth=Math.max(i.maxWidth,Da)+"px"}),0)}else{this.elements.root.style.maxWidth=n.width+"px";this.elements.root.addEventListener("transitionend",(function(){return i.elements.root.style.removeProperty("max-width")}),{once:true})}}},{key:"releaseLocalMedia",value:function e(){this.localUser.releaseStream();if(this.centralUser.id==this.userId){this.centralUser.releaseStream()}}},{key:"clearNewLogicRules",value:function e(){clearTimeout(this.rerenderTimeout);this.rerenderTimeout=null;this.waitingForUserMediaTimeouts.forEach((function(e){return clearTimeout(e)}));this.waitingForUserMediaTimeouts.clear();this.rerenderQueue.clear()}},{key:"clearCallcontrolPromo",value:function e(){if(this.showCallcontrolPromoPopupTimeout){clearTimeout(this.showCallcontrolPromoPopupTimeout)}if(this.ahaMomentNotifyCallcontrol){this.needToShowCallcontrolPromo=false;this.ahaMomentNotifyCallcontrol.close();this.ahaMomentNotifyCallcontrol=null}}},{key:"destroy",value:function e(){this.destroyed=true;this.closeCopilotNotify();this.closeCommonRecordPopups();if(this.overflownButtonsPopup){this.overflownButtonsPopup.close()}this.preferInitialWindowPlacementPictureInPicture=true;if(this.elements.root){p.Dom.remove(this.elements.root);this.elements.root=null}this.visible=false;this.clearNewLogicRules();window.removeEventListener("webkitfullscreenchange",this._onFullScreenChangeHandler);window.removeEventListener("mozfullscreenchange",this._onFullScreenChangeHandler);window.removeEventListener("orientationchange",this._onOrientationChangeHandler);window.removeEventListener("keydown",this._onKeyDownHandler);window.removeEventListener("keyup",this._onKeyUpHandler);document.removeEventListener("mousemove",this.onMouseMoveHandler);this.resizeObserver.disconnect();this.resizeObserver=null;if(this.intersectionObserver){this.intersectionObserver.disconnect();this.intersectionObserver=null}for(var t in this.users){if(this.users.hasOwnProperty(t)){this.users[t].userModel.unsubscribe("changed",this.talkingService.watchTalking);this.users[t].destroy()}}this.userData=null;this.centralUser.userModel.unsubscribe("changed",this.talkingService.watchTalking);this.userRegistry.unsubscribe("changed",this.talkingService.refreshQueue);this.talkingService.destroy();this.centralUser.destroy();this.hintManager.hide();this.hintManager=null;clearTimeout(this.switchPresenterTimeout);if(this.buttons.recordStatus){this.buttons.recordStatus.stopViewUpdate()}this.commonRecordState=this.getDefaultCommonRecordState();this.buttons=null;this.eventEmitter.emit(Ma.onDestroy);this.eventEmitter.unsubscribeAll();H.unsubscribe(H.Events.onChangeMicrophoneMuted,this.setMuted);H.unsubscribe(H.Events.onChangeCameraOn,this.setCameraState);this.clearCallcontrolPromo();this.viewVisibility.stopViewVisibilityChange();if(this.deviceSelector){this.deviceSelector.destroy()}}},{key:"isActivePiPFromController",get:function e(){return this._isActivePiPFromController},set:function e(t){this._isActivePiPFromController=t}},{key:"isPreparing",get:function e(){return this._isPreparing},set:function e(t){this._isPreparing=!!t}},{key:"videoRerenderDelay",get:function e(){return this._videoRerenderDelay>0?this._videoRerenderDelay:Fa},set:function e(t){this._videoRerenderDelay=t}}]);return e}();function ts(e){if(!this.elements.root){this.render();p.Dom.append(this.elements.root,this.container)}if(this.elements.overlay.childElementCount){p.Dom.clean(this.elements.overlay)}p.Dom.append(e,this.elements.overlay)}function is(){this.setUiState(_a.Error);p.Dom.style(this.elements.userList.container,"display","none")}function ns(){var e=this.uiState!==_a.Preparing&&this.uiState!==_a.Connected;var t=this.blockedButtons.camera===true;var i=!Yf.havePermissionToBroadcast("cam");var n=this.localUser.userModel.state===yc.Connecting;var a=this.localUser.hasVideo()||this.localUser.hasAudio();var s=this.isVideoconf||this.localUserReceivedStats||!a;return e||t||i||n||!s}function as(e){var t=arguments.length>1&&arguments[1]!==undefined?arguments[1]:0;this.closeCopilotNotify();this.copilotNotify=this.createCopilotNotify(e,t);if(this.copilotNotify){this.copilotNotify.show()}}function ss(){var e=this;var t=this.getRecordLimitation();this.onClickButtonWithLimit(t,(function(){e.eventEmitter.emit(Ma.onButtonClick,{buttonName:"record"})}))}function rs(){var e=this;var t=this.getRecordLimitation();this.onClickButtonWithLimit(t,(function(){var t=[Di.Stopped,Di.Destroyed].includes(e.commonRecordState.state)?Di.Started:Di.Stopped;e.eventEmitter.emit(Ma.onCommonRecordMenu,{state:t,hotkey:true})}))}function os(){var e=arguments.length>0&&arguments[0]!==undefined?arguments[0]:[];var t=function t(i){var n=ga(e),a;try{for(n.s();!(a=n.n()).done;){var s=a.value;s(i,document.visibilityState)}}catch(e){n.e(e)}finally{n.f()}};var i=function e(){document.addEventListener("visibilitychange",t,{capture:true})};var n=function e(){document.removeEventListener("visibilitychange",t,{capture:true})};return{startViewVisibilityChange:i,stopViewVisibilityChange:n,getCurrentVisibility:function e(){return document.visibilityState}}}babelHelpers.defineProperty(es,"Layout",Ia);babelHelpers.defineProperty(es,"Size",Ea);babelHelpers.defineProperty(es,"RecordSource",{Chat:"BXCLIENT_CHAT"});babelHelpers.defineProperty(es,"UiState",_a);babelHelpers.defineProperty(es,"Event",Ma);babelHelpers.defineProperty(es,"RoomState",Ra);babelHelpers.defineProperty(es,"DeviceSelector",hn);babelHelpers.defineProperty(es,"NotificationManager",un);babelHelpers.defineProperty(es,"MIN_WIDTH",Da);babelHelpers.defineProperty(es,"DocumentVisibilityState",Xa);var ls=.02;var cs=2e3;var us=.6;var ds=function(){function e(t){babelHelpers.classCallCheck(this,e);if(!(t.mediaStream instanceof MediaStream)){throw new Error("config.mediaStream should be instance of MediaStream")}if(t.mediaStream.getAudioTracks().length===0){throw new Error("config.mediaStream should contain audio track")}this.mediaStream=new MediaStream;this.mediaStream.addTrack(t.mediaStream.getAudioTracks()[0].clone());this.audioContext=null;this.mediaStreamNode=null;this.analyserNode=null;this.audioTimeDomainData=null;this.voiceState=false;this.measureInterval=0;this.inactivityTimeout=0;this.currentVolume=0;this.callbacks={voiceStarted:p.Type.isFunction(t.onVoiceStarted)?t.onVoiceStarted:BX.DoNothing,voiceStopped:p.Type.isFunction(t.onVoiceStopped)?t.onVoiceStopped:BX.DoNothing};if(e.isSupported()){this.init()}}babelHelpers.createClass(e,[{key:"init",value:function e(){this.audioContext=new(window.AudioContext||window.webkitAudioContext);this.analyserNode=this.audioContext.createAnalyser();this.analyserNode.fftSize=128;this.mediaStreamNode=this.audioContext.createMediaStreamSource(this.mediaStream);this.mediaStreamNode.connect(this.analyserNode);this.audioTimeDomainData=new Float32Array(this.analyserNode.fftSize);this.measureInterval=setInterval(this.analyzeAudioStream.bind(this),100)}},{key:"analyzeAudioStream",value:function e(){this.analyserNode.getFloatTimeDomainData(this.audioTimeDomainData);this.updateCurrentVolume(this.audioTimeDomainData);this.setVoiceState(this.currentVolume>=ls)}},{key:"setVoiceState",value:function e(t){if(this.voiceState==t){return}if(t){this.callbacks.voiceStarted();clearTimeout(this.inactivityTimeout);this.inactivityTimeout=0;this.voiceState=true}else{if(!this.inactivityTimeout){this.inactivityTimeout=setTimeout(this.onInactivityTimeout.bind(this),cs)}}}},{key:"onInactivityTimeout",value:function e(){this.inactivityTimeout=0;this.voiceState=false;this.callbacks.voiceStopped()}},{key:"updateCurrentVolume",value:function e(t){var i=0;for(var n=0;n<t.length;n++){i+=t[n]*t[n]}var a=Math.sqrt(i/t.length);this.currentVolume=Math.max(a,this.currentVolume*us)}},{key:"destroy",value:function e(){if(this.analyserNode){this.analyserNode.disconnect()}if(this.mediaStreamNode){this.mediaStreamNode.disconnect()}if(this.audioContext){this.audioContext.close()}if(this.mediaStream){this.mediaStream.getTracks().forEach((function(e){return e.stop()}));this.mediaStream=null}clearInterval(this.measureInterval);this.analyserNode=null;this.mediaStreamNode=null;this.audioContext=null;this.callbacks={voiceStarted:BX.DoNothing,voiceStopped:BX.DoNothing}}}],[{key:"isSupported",value:function e(){return(window.AudioContext||window.webkitAudioContext)&&window.AnalyserNode&&typeof window.AnalyserNode.prototype["getFloatTimeDomainData"]==="function"}}]);return e}();function hs(){/*! regenerator-runtime -- Copyright (c) 2014-present, Facebook, Inc. -- license (MIT): https://github.com/facebook/regenerator/blob/main/LICENSE */hs=function t(){return e};var e={},t=Object.prototype,i=t.hasOwnProperty,n=Object.defineProperty||function(e,t,i){e[t]=i.value},a="function"==typeof Symbol?Symbol:{},s=a.iterator||"@@iterator",r=a.asyncIterator||"@@asyncIterator",o=a.toStringTag||"@@toStringTag";function l(e,t,i){return Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{l({},"")}catch(e){l=function e(t,i,n){return t[i]=n}}function c(e,t,i,a){var s=t&&t.prototype instanceof h?t:h,r=Object.create(s.prototype),o=new T(a||[]);return n(r,"_invoke",{value:y(e,i,o)}),r}function u(e,t,i){try{return{type:"normal",arg:e.call(t,i)}}catch(e){return{type:"throw",arg:e}}}e.wrap=c;var d={};function h(){}function p(){}function v(){}var f={};l(f,s,(function(){return this}));var m=Object.getPrototypeOf,g=m&&m(m(P([])));g&&g!==t&&i.call(g,s)&&(f=g);var b=v.prototype=h.prototype=Object.create(f);function C(e){["next","throw","return"].forEach((function(t){l(e,t,(function(e){return this._invoke(t,e)}))}))}function k(e,t){function a(n,s,r,o){var l=u(e[n],e,s);if("throw"!==l.type){var c=l.arg,d=c.value;return d&&"object"==babelHelpers["typeof"](d)&&i.call(d,"__await")?t.resolve(d.__await).then((function(e){a("next",e,r,o)}),(function(e){a("throw",e,r,o)})):t.resolve(d).then((function(e){c.value=e,r(c)}),(function(e){return a("throw",e,r,o)}))}o(l.arg)}var s;n(this,"_invoke",{value:function e(i,n){function r(){return new t((function(e,t){a(i,n,e,t)}))}return s=s?s.then(r,r):r()}})}function y(e,t,i){var n="suspendedStart";return function(a,s){if("executing"===n)throw new Error("Generator is already running");if("completed"===n){if("throw"===a)throw s;return _()}for(i.method=a,i.arg=s;;){var r=i.delegate;if(r){var o=S(r,i);if(o){if(o===d)continue;return o}}if("next"===i.method)i.sent=i._sent=i.arg;else if("throw"===i.method){if("suspendedStart"===n)throw n="completed",i.arg;i.dispatchException(i.arg)}else"return"===i.method&&i.abrupt("return",i.arg);n="executing";var l=u(e,t,i);if("normal"===l.type){if(n=i.done?"completed":"suspendedYield",l.arg===d)continue;return{value:l.arg,done:i.done}}"throw"===l.type&&(n="completed",i.method="throw",i.arg=l.arg)}}}function S(e,t){var i=t.method,n=e.iterator[i];if(undefined===n)return t.delegate=null,"throw"===i&&e.iterator["return"]&&(t.method="return",t.arg=undefined,S(e,t),"throw"===t.method)||"return"!==i&&(t.method="throw",t.arg=new TypeError("The iterator does not provide a '"+i+"' method")),d;var a=u(n,e.iterator,t.arg);if("throw"===a.type)return t.method="throw",t.arg=a.arg,t.delegate=null,d;var s=a.arg;return s?s.done?(t[e.resultName]=s.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=undefined),t.delegate=null,d):s:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,d)}function w(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function I(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function T(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(w,this),this.reset(!0)}function P(e){if(e){var t=e[s];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var n=-1,a=function t(){for(;++n<e.length;)if(i.call(e,n))return t.value=e[n],t.done=!1,t;return t.value=undefined,t.done=!0,t};return a.next=a}}return{next:_}}function _(){return{value:undefined,done:!0}}return p.prototype=v,n(b,"constructor",{value:v,configurable:!0}),n(v,"constructor",{value:p,configurable:!0}),p.displayName=l(v,o,"GeneratorFunction"),e.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===p||"GeneratorFunction"===(t.displayName||t.name))},e.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,v):(e.__proto__=v,l(e,o,"GeneratorFunction")),e.prototype=Object.create(b),e},e.awrap=function(e){return{__await:e}},C(k.prototype),l(k.prototype,r,(function(){return this})),e.AsyncIterator=k,e.async=function(t,i,n,a,s){void 0===s&&(s=Promise);var r=new k(c(t,i,n,a),s);return e.isGeneratorFunction(i)?r:r.next().then((function(e){return e.done?e.value:r.next()}))},C(b),l(b,o,"Generator"),l(b,s,(function(){return this})),l(b,"toString",(function(){return"[object Generator]"})),e.keys=function(e){var t=Object(e),i=[];for(var n in t)i.push(n);return i.reverse(),function e(){for(;i.length;){var n=i.pop();if(n in t)return e.value=n,e.done=!1,e}return e.done=!0,e}},e.values=P,T.prototype={constructor:T,reset:function e(t){if(this.prev=0,this.next=0,this.sent=this._sent=undefined,this.done=!1,this.delegate=null,this.method="next",this.arg=undefined,this.tryEntries.forEach(I),!t)for(var n in this)"t"===n.charAt(0)&&i.call(this,n)&&!isNaN(+n.slice(1))&&(this[n]=undefined)},stop:function e(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function e(t){if(this.done)throw t;var n=this;function a(e,i){return o.type="throw",o.arg=t,n.next=e,i&&(n.method="next",n.arg=undefined),!!i}for(var s=this.tryEntries.length-1;s>=0;--s){var r=this.tryEntries[s],o=r.completion;if("root"===r.tryLoc)return a("end");if(r.tryLoc<=this.prev){var l=i.call(r,"catchLoc"),c=i.call(r,"finallyLoc");if(l&&c){if(this.prev<r.catchLoc)return a(r.catchLoc,!0);if(this.prev<r.finallyLoc)return a(r.finallyLoc)}else if(l){if(this.prev<r.catchLoc)return a(r.catchLoc,!0)}else{if(!c)throw new Error("try statement without catch or finally");if(this.prev<r.finallyLoc)return a(r.finallyLoc)}}}},abrupt:function e(t,n){for(var a=this.tryEntries.length-1;a>=0;--a){var s=this.tryEntries[a];if(s.tryLoc<=this.prev&&i.call(s,"finallyLoc")&&this.prev<s.finallyLoc){var r=s;break}}r&&("break"===t||"continue"===t)&&r.tryLoc<=n&&n<=r.finallyLoc&&(r=null);var o=r?r.completion:{};return o.type=t,o.arg=n,r?(this.method="next",this.next=r.finallyLoc,d):this.complete(o)},complete:function e(t,i){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&i&&(this.next=i),d},finish:function e(t){for(var i=this.tryEntries.length-1;i>=0;--i){var n=this.tryEntries[i];if(n.finallyLoc===t)return this.complete(n.completion,n.afterLoc),I(n),d}},catch:function e(t){for(var i=this.tryEntries.length-1;i>=0;--i){var n=this.tryEntries[i];if(n.tryLoc===t){var a=n.completion;if("throw"===a.type){var s=a.arg;I(n)}return s}}throw new Error("illegal catch attempt")},delegateYield:function e(t,i,n){return this.delegate={iterator:P(t),resultName:i,nextLoc:n},"next"===this.method&&(this.arg=undefined),d}},e}function ps(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function vs(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?ps(Object(i),!0).forEach((function(t){babelHelpers.defineProperty(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):ps(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}function fs(e,t){gs(e,t);t.add(e)}function ms(e,t,i){gs(e,t);t.set(e,i)}function gs(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}function bs(e,t,i){if(!t.has(e)){throw new TypeError("attempted to get private field on non-instance")}return i}var Cs={decline:"call.Call.decline"};var ks={negotiationNeeded:"Call::negotiationNeeded",connectionOffer:"Call::connectionOffer",connectionAnswer:"Call::connectionAnswer",iceCandidate:"Call::iceCandidate",voiceStarted:"Call::voiceStarted",voiceStopped:"Call::voiceStopped",commonRecordState:"Call::commonRecordState",microphoneState:"Call::microphoneState",cameraState:"Call::cameraState",videoPaused:"Call::videoPaused",customMessage:"Call::customMessage",usersInvited:"Call::usersInvited",userInviteTimeout:"Call::userInviteTimeout"};var ys={offerToReceiveVideo:true,offerToReceiveAudio:true};var Ss=3e4;var ws=1e4;var Is=3e4;var Ts=new WeakMap;var Ps=new WeakMap;var _s=new WeakMap;var Es=new WeakMap;var Rs=new WeakMap;var Ms=new WeakMap;var As=new WeakMap;var Ls=new WeakMap;var Bs=new WeakMap;var Ds=new WeakSet;var Hs=new WeakSet;var Ns=new WeakSet;var xs=new WeakSet;var Os=new WeakSet;var Us=new WeakSet;var Fs=new WeakSet;var Vs=new WeakSet;var Gs=new WeakSet;var Ws=new WeakSet;var Xs=new WeakSet;var zs=new WeakSet;var js=new WeakSet;var qs=new WeakSet;var Ys=new WeakSet;var Qs=new WeakSet;var Js=new WeakSet;var Ks=new WeakSet;var Zs=new WeakSet;var $s=new WeakSet;var er=new WeakSet;var tr=new WeakSet;var ir=new WeakSet;var nr=new WeakSet;var ar=new WeakSet;var sr=new WeakMap;var rr=new WeakMap;var or=new WeakMap;var lr=new WeakMap;var cr=new WeakMap;var ur=new WeakMap;var dr=new WeakMap;var hr=new WeakMap;var pr=new WeakMap;var vr=new WeakMap;var fr=new WeakMap;var mr=new WeakMap;var gr=new WeakMap;var br=new WeakMap;var Cr=new WeakMap;var kr=new WeakMap;var yr=new WeakMap;var Sr=new WeakMap;var wr=new WeakMap;var Ir=new WeakMap;var Tr=new WeakMap;var Pr=new WeakMap;var _r=new WeakSet;var Er=new WeakSet;var Rr=new WeakSet;var Mr=function(e){babelHelpers.inherits(t,e);function t(e){var i;babelHelpers.classCallCheck(this,t);i=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this,e));fs(babelHelpers.assertThisInitialized(i),Rr);fs(babelHelpers.assertThisInitialized(i),Er);fs(babelHelpers.assertThisInitialized(i),_r);fs(babelHelpers.assertThisInitialized(i),ar);fs(babelHelpers.assertThisInitialized(i),nr);fs(babelHelpers.assertThisInitialized(i),ir);fs(babelHelpers.assertThisInitialized(i),tr);fs(babelHelpers.assertThisInitialized(i),er);fs(babelHelpers.assertThisInitialized(i),$s);fs(babelHelpers.assertThisInitialized(i),Zs);fs(babelHelpers.assertThisInitialized(i),Ks);fs(babelHelpers.assertThisInitialized(i),Js);fs(babelHelpers.assertThisInitialized(i),Qs);fs(babelHelpers.assertThisInitialized(i),Ys);fs(babelHelpers.assertThisInitialized(i),qs);fs(babelHelpers.assertThisInitialized(i),js);fs(babelHelpers.assertThisInitialized(i),zs);fs(babelHelpers.assertThisInitialized(i),Xs);fs(babelHelpers.assertThisInitialized(i),Ws);fs(babelHelpers.assertThisInitialized(i),Gs);fs(babelHelpers.assertThisInitialized(i),Vs);fs(babelHelpers.assertThisInitialized(i),Fs);fs(babelHelpers.assertThisInitialized(i),Us);fs(babelHelpers.assertThisInitialized(i),Os);fs(babelHelpers.assertThisInitialized(i),xs);fs(babelHelpers.assertThisInitialized(i),Ns);fs(babelHelpers.assertThisInitialized(i),Hs);fs(babelHelpers.assertThisInitialized(i),Ds);ms(babelHelpers.assertThisInitialized(i),Ts,{writable:true,value:void 0});ms(babelHelpers.assertThisInitialized(i),Ps,{writable:true,value:void 0});ms(babelHelpers.assertThisInitialized(i),_s,{writable:true,value:void 0});ms(babelHelpers.assertThisInitialized(i),Es,{writable:true,value:void 0});ms(babelHelpers.assertThisInitialized(i),Rs,{writable:true,value:void 0});ms(babelHelpers.assertThisInitialized(i),Ms,{writable:true,value:void 0});ms(babelHelpers.assertThisInitialized(i),As,{writable:true,value:void 0});ms(babelHelpers.assertThisInitialized(i),Ls,{writable:true,value:void 0});ms(babelHelpers.assertThisInitialized(i),Bs,{writable:true,value:void 0});babelHelpers.defineProperty(babelHelpers.assertThisInitialized(i),"setVideoEnabled",(function(e){if(i.videoEnabled==e.data.isCameraOn){return}var t="main";i.videoEnabled=e.data.isCameraOn;var n=i.localStreams[t]&&i.localStreams[t].getVideoTracks().length>0;if(i.ready&&n!==i.videoEnabled){if(!i.videoEnabled){ae.stopStream(ge.Camera)}i.replaceLocalMediaStream().then((function(){i.signaling.sendCameraState(i.users,i.videoEnabled)}))["catch"]((function(){var e=Yf.MediaKind[ge.Camera];var n=new yn({kind:e});i.runCallback(Ac.onLocalMediaReceived,{tag:t,mediaRenderer:n,stream:n.stream})}))}}));babelHelpers.defineProperty(babelHelpers.assertThisInitialized(i),"setMuted",(function(e){var t,n;if(i.muted===e.data.isMicrophoneMuted){return}i.muted=e.data.isMicrophoneMuted;var a="main";var s=(t=i.localStreams[a])===null||t===void 0?void 0:(n=t.getAudioTracks())===null||n===void 0?void 0:n[0];if(i.muted&&i.CallApi.isAudioPublished()){i.CallApi.disableAudio({calledFrom:"setMuted"})}else if(!i.muted){i.CallApi.enableAudio({calledFrom:"setMuted"})}if(s){s.enabled=!i.muted}i.signaling.sendMicrophoneState(i.users,!i.muted);i.sendTalkingState()}));ms(babelHelpers.assertThisInitialized(i),sr,{writable:true,value:function e(t){clearTimeout(i.waitForAnswerTimeout);var n=parseInt(t.userId,10);var a=i.peers[n];if(!a){if(!i.users.includes(n)){i.users.push(n)}a=i.createPeer(n);a.participant=t;i.peers[n]=a}i.runCallback(Ac.onUserJoined,{userId:n,userData:babelHelpers.defineProperty({},n,{name:t.name,avatar_hr:t.image,avatar:t.image})});a.setSignalingConnected(true);a.setReady(true);if(i.ready&&!a.isInitiator()){i.log("waiting for the other side to send connection offer");a.sendNegotiationNeeded(false)}if(i.commonRecordState.state!==Di.Stopped&&i.commonRecordState.userId===i.userId){i.signaling.sendLocalRecordState(i.userId,i.commonRecordState)}}});ms(babelHelpers.assertThisInitialized(i),rr,{writable:true,value:function e(t){var n=i.peers[t.userId];n===null||n===void 0?void 0:n.setReady(false)}});ms(babelHelpers.assertThisInitialized(i),or,{writable:true,value:function e(t){var n="";try{n=JSON.parse(t.text);n=Yf.deepParseJSON(n)}catch(e){i.log("Could not parse scenario message.",e);return}var a=n.eventName;switch(a){case ks.connectionOffer:bs(babelHelpers.assertThisInitialized(i),Gs,Ur).call(babelHelpers.assertThisInitialized(i),n);break;case ks.connectionAnswer:bs(babelHelpers.assertThisInitialized(i),Ws,Fr).call(babelHelpers.assertThisInitialized(i),n);break;case ks.negotiationNeeded:bs(babelHelpers.assertThisInitialized(i),Vs,Or).call(babelHelpers.assertThisInitialized(i),n);break;case ks.iceCandidate:bs(babelHelpers.assertThisInitialized(i),Xs,Vr).call(babelHelpers.assertThisInitialized(i),n);break;case ks.microphoneState:bs(babelHelpers.assertThisInitialized(i),qs,Xr).call(babelHelpers.assertThisInitialized(i),n);break;case ks.cameraState:bs(babelHelpers.assertThisInitialized(i),Ys,zr).call(babelHelpers.assertThisInitialized(i),n);break;case ks.voiceStarted:bs(babelHelpers.assertThisInitialized(i),zs,Gr).call(babelHelpers.assertThisInitialized(i),n);break;case ks.voiceStopped:bs(babelHelpers.assertThisInitialized(i),js,Wr).call(babelHelpers.assertThisInitialized(i),n);break;case ks.videoPaused:bs(babelHelpers.assertThisInitialized(i),Qs,jr).call(babelHelpers.assertThisInitialized(i),n);break;case ks.commonRecordState:bs(babelHelpers.assertThisInitialized(i),Js,qr).call(babelHelpers.assertThisInitialized(i),n);break;case ks.usersInvited:bs(babelHelpers.assertThisInitialized(i),xs,Dr).call(babelHelpers.assertThisInitialized(i),n);break;case ks.customMessage:i.runCallback(Ac.onCustomMessage,{message:n.message});break;default:i.log("Unknown scenario event ".concat(a))}}});ms(babelHelpers.assertThisInitialized(i),lr,{writable:true,value:function e(t){var n=Yf.MediaKind[t];if(!n||i.useMediaServer){return}switch(t){case ge.Microphone:i.CallApi.disableAudio({calledFrom:"onLocalMediaRendererAdded"});break;case ge.Camera:i.CallApi.disableVideo({calledFrom:"onLocalMediaRendererAdded"});break;default:}}});ms(babelHelpers.assertThisInitialized(i),cr,{writable:true,value:function e(t,n){if(t===ge.Microphone){i.signaling.sendMicrophoneState(i.users,!n)}}});ms(babelHelpers.assertThisInitialized(i),ur,{writable:true,value:function e(t){var n=t?false:!H.isMicrophoneMuted;var a=t?false:H.isCameraOn;i.signaling.sendMicrophoneState(i.users,n);i.signaling.sendCameraState(i.users,a)}});ms(babelHelpers.assertThisInitialized(i),dr,{writable:true,value:function e(t){i.runCallback(Ac.onToggleRemoteParticipantVideo,{isVideoShown:t})}});ms(babelHelpers.assertThisInitialized(i),hr,{writable:true,value:function e(t){i.runCallback(Ac.onTrackSubscriptionFailed,t)}});ms(babelHelpers.assertThisInitialized(i),pr,{writable:true,value:function e(t,n){if(!i.useMediaServer){return}var a=bs(babelHelpers.assertThisInitialized(i),ar,to).call(babelHelpers.assertThisInitialized(i),t,n);if(!a){i.log("Unknown user: ".concat(t.userId))}a.addMediaRenderer({track:n.track});i.log("[RemoteMediaAdded]: UserId: ".concat(t.userId,", source: ").concat(Yf.MediaKind[n.source]))}});ms(babelHelpers.assertThisInitialized(i),vr,{writable:true,value:function e(t,n){if(!i.useMediaServer){return}var a=bs(babelHelpers.assertThisInitialized(i),ar,to).call(babelHelpers.assertThisInitialized(i),t,n);if(!a){i.log("Unknown user: ".concat(t.userId))}a.removeMediaRenderer({track:n.track});i.log("[RemoteMediaRemoved]: UserId: ".concat(t.userId,", source: ").concat(Yf.MediaKind[n.source]))}});ms(babelHelpers.assertThisInitialized(i),fr,{writable:true,value:function e(t,n){if(!i.useMediaServer){return}if(n.source===ge.Microphone){var a=parseInt(t.userId,10);var s=i.peers[a];if(s){s.addMediaRenderer({track:n.track})}i.runCallback(Ac.onUserMicrophoneState,{userId:a,microphoneState:!t.isMutedAudio})}}});ms(babelHelpers.assertThisInitialized(i),mr,{writable:true,value:function e(t){var n=t.userId;if(n===i.userId){i.runCallback(Ac.onUserVoiceStarted,{userId:n,local:true})}i.runCallback(Ac.onUserVoiceStarted,{userId:n})}});ms(babelHelpers.assertThisInitialized(i),gr,{writable:true,value:function e(t){i.runCallback(Ac.onUserVoiceStopped,{userId:t.userId})}});ms(babelHelpers.assertThisInitialized(i),br,{writable:true,value:function e(t){var n=t.code,a=t.errMsg;var s=[Pe.DESTROYED,Pe.UNAVAILABLE].includes(n);var r=s?"":a;babelHelpers.classPrivateFieldSet(babelHelpers.assertThisInitialized(i),_s,r?babelHelpers.classPrivateFieldGet(babelHelpers.assertThisInitialized(i),_s):n);var o=babelHelpers.classPrivateFieldGet(babelHelpers.assertThisInitialized(i),_s)===Pe.ENABLED;babelHelpers.classPrivateFieldSet(babelHelpers.assertThisInitialized(i),Es,true);if([Pe.DISABLED,Pe.DESTROYED,Pe.UNAVAILABLE].includes(n)){babelHelpers.classPrivateFieldSet(babelHelpers.assertThisInitialized(i),Rs,false)}i.runCallback(Ac.onRecorderStatusChanged,{code:n,error:r,isCopilotActive:o})}});ms(babelHelpers.assertThisInitialized(i),Cr,{writable:true,value:function e(t){var n;if(Yf.isCloudRecordLogEnabled()){console.warn("CloudRecord: videoRecorderStatus",t)}var a=t.code,s=t.errMsg,r=t.initiatorUserID,o=t.userID,l=t.kind,c=t.date,u=t.justJoined;var d=Number(o);var h=Number(r);var p=((n=c.pauses)!==null&&n!==void 0?n:[]).map((function(e){var t=e.start,i=e.end;return{start:new Date(t),finish:i?new Date(i):null}}));var v=l===1?Hi.Audio:Hi.Video;babelHelpers.classPrivateFieldSet(babelHelpers.assertThisInitialized(i),Ps,s?babelHelpers.classPrivateFieldGet(babelHelpers.assertThisInitialized(i),Ps):a);if(s){if(Yf.isCloudRecordLogEnabled()){console.error("CloudRecord: videoRecorderStatus errMsg",s)}i.runCallback(Ac.onCloudRecordStatusChanged,{code:_e.STOPPED,userId:d,initiatorId:h,justJoined:u,commonRecordState:vs({},i.commonRecordState)})}else{switch(a){case _e.STARTED:case _e.PAUSED:{i.commonRecordState.state=a===_e.STARTED?Di.Started:Di.Paused;i.commonRecordState.type=v;i.commonRecordState.userId=h;i.commonRecordState.date.start=new Date(c.start);i.commonRecordState.date.pause=p;break}case _e.STOPPED:case _e.DESTROYED:{i.commonRecordState.state=a===_e.STOPPED?Di.Stopped:Di.Destroyed;i.commonRecordState.type=Hi.None;i.commonRecordState.userId=0;i.commonRecordState.date.start=null;i.commonRecordState.date.pause=[];break}default:{if(Yf.isCloudRecordLogEnabled()){console.error("Unknown record status: ".concat(t))}break}}i.runCallback(Ac.onCloudRecordStatusChanged,{code:a,userId:d,initiatorId:h,justJoined:u,commonRecordState:vs({},i.commonRecordState)})}}});ms(babelHelpers.assertThisInitialized(i),kr,{writable:true,value:function e(t){i._reconnectionEventCount++;i.runCallback(Ac.onReconnecting,{reconnectionEventCount:i._reconnectionEventCount,reconnectionReason:t.reconnectionReason,reconnectionReasonInfo:t.reconnectionReasonInfo})}});ms(babelHelpers.assertThisInitialized(i),yr,{writable:true,value:function e(){i._reconnectionEventCount=0;i.runCallback(Ac.onReconnected);if(i.useMediaServer){bs(babelHelpers.assertThisInitialized(i),Ds,Ar).call(babelHelpers.assertThisInitialized(i))}if(i.commonRecordState.userId===i.userId){i.sendLocalRecordState({action:i.commonRecordState.state,userId:i.userId},true)}}});ms(babelHelpers.assertThisInitialized(i),Sr,{writable:true,value:function e(t,n){i.runCallback(Ac.onReconnectingFailed,{error:n})}});ms(babelHelpers.assertThisInitialized(i),wr,{writable:true,value:function e(t){var n;if((t===null||t===void 0?void 0:(n=t.leaveInformation)===null||n===void 0?void 0:n.reason)===Rc.SecurityKeyChanged){i.runCallback(Ac.onCallFailure,{name:t.leaveInformation.reason});return}i.destroy()}});ms(babelHelpers.assertThisInitialized(i),Ir,{writable:true,value:function e(t){if(!i.useMediaServer){return}var n={};var a={f:2,h:1,q:0};var s=function e(t){var i=t.userId,s=t.kind,r=t.source,o=t.rid;if(!i||!["video","audio"].includes(s)){return}if(!n[i]){n[i]={}}if(s==="audio"){n[i][r]=t;return}if(!n[i][r]){n[i][r]=[]}var l=a[o]||0;n[i][r][l]=t};t.sender.forEach((function(e){s(e)}));t.recipient.forEach((function(e){s(e)}));for(var r=0,o=Object.entries(n);r<o.length;r++){var l=babelHelpers.slicedToArray(o[r],2),c=l[0],u=l[1];i.runCallback(Ac.onUserStatsReceived,{userId:c,report:u})}}});ms(babelHelpers.assertThisInitialized(i),Tr,{writable:true,value:function e(t){Object.keys(t).forEach((function(e){i.runCallback(Ac.onConnectionQualityChanged,{userId:Number(e),score:t[e]})}))}});ms(babelHelpers.assertThisInitialized(i),Pr,{writable:true,value:function e(t){var n=Number(t.fromUserId);var a=Number(t.type);if(n===i.userId||a===babelHelpers.classPrivateFieldGet(babelHelpers.assertThisInitialized(i),Ms)){return}babelHelpers.classPrivateFieldSet(babelHelpers.assertThisInitialized(i),Ms,a);bs(babelHelpers.assertThisInitialized(i),Ds,Ar).call(babelHelpers.assertThisInitialized(i));if(babelHelpers.classPrivateFieldGet(babelHelpers.assertThisInitialized(i),_s)===Pe.ENABLED&&!i.useMediaServer){i.setRecorderState(Pe.PAUSED)}}});i.callFromMobile=e.callFromMobile;i.state=e.state||"";i.peers=i.initPeers(i.users);i.signaling=new oo({call:babelHelpers.assertThisInitialized(i)});i.deviceList=[];i.turnServer=p.Loc.getMessage("turn_server");i.turnServerLogin=p.Loc.getMessage("turn_server_login")||"bitrix";i.turnServerPassword=p.Loc.getMessage("turn_server_password")||"bitrix";i.iceServers=[{urls:"stun:".concat(i.turnServer)},{urls:"turn:".concat(i.turnServer),username:i.turnServerLogin,credential:i.turnServerPassword}];i.userData=e.userData;babelHelpers.classPrivateFieldSet(babelHelpers.assertThisInitialized(i),Ls,bs(babelHelpers.assertThisInitialized(i),_r,io).bind(babelHelpers.assertThisInitialized(i)));babelHelpers.classPrivateFieldSet(babelHelpers.assertThisInitialized(i),Bs,bs(babelHelpers.assertThisInitialized(i),Er,no).bind(babelHelpers.assertThisInitialized(i)));i.enableMicAutoParameters=e.enableMicAutoParameters!==false;i.microphoneLevelInterval=null;i.mediaMutedBySystem=false;i.CallApi=null;babelHelpers.classPrivateFieldSet(babelHelpers.assertThisInitialized(i),Ms,Ae.PeerToPeer);i._reconnectionEventCount=0;i.waitForAnswerTimeout=null;babelHelpers.classPrivateFieldSet(babelHelpers.assertThisInitialized(i),Ts,g.CallSettingsManager.plainCallCloudRecordingEnabled);babelHelpers.classPrivateFieldSet(babelHelpers.assertThisInitialized(i),Ps,_e.NONE);babelHelpers.classPrivateFieldSet(babelHelpers.assertThisInitialized(i),_s,Pe.UNAVAILABLE);babelHelpers.classPrivateFieldSet(babelHelpers.assertThisInitialized(i),Rs,false);babelHelpers.classPrivateFieldSet(babelHelpers.assertThisInitialized(i),Es,false);i._isCopilotFeaturesEnabled=g.CallSettingsManager.plainCallFollowUpEnabled;babelHelpers.classPrivateFieldSet(babelHelpers.assertThisInitialized(i),As,false);p.Event.bind(window,"unload",babelHelpers.classPrivateFieldGet(babelHelpers.assertThisInitialized(i),Ls));p.Event.bind(window,"online",babelHelpers.classPrivateFieldGet(babelHelpers.assertThisInitialized(i),Bs));return i}babelHelpers.createClass(t,[{key:"initPeers",value:function e(t){var i={};for(var n=0;n<t.length;n++){var a=Number(t[n]);if(a==this.userId){continue}i[a]=this.createPeer(a)}return i}},{key:"createPeer",value:function e(t){var i=this;return new To({call:this,userId:t,ready:t==this.initiatorId,signalingConnected:t==this.initiatorId,isLegacyMobile:t==this.initiatorId&&this.callFromMobile,onMediaReceived:function e(t){i.runCallback(Ac.onRemoteMediaReceived,t)},onMediaStopped:function e(t){i.runCallback(Ac.onRemoteMediaStopped,t)},onStateChanged:bs(this,er,Kr).bind(this),onInviteTimeout:bs(this,tr,Zr).bind(this),onRTCStatsReceived:bs(this,ir,$r).bind(this),onRTCQualityChanged:bs(this,nr,eo).bind(this),onNetworkProblem:function e(t){i.runCallback(Ac.onNetworkProblem,t)},onReconnecting:function e(t){babelHelpers.classPrivateFieldGet(i,kr).call(i,t)},onReconnected:function e(){babelHelpers.classPrivateFieldGet(i,yr).call(i)},onUpdateLastUsedCameraId:function e(){i.runCallback(Ac.onUpdateLastUsedCameraId)}})}},{key:"getUsers",value:function e(){var t={};for(var i in this.peers){t[i]=this.peers[i].calculatedState}return t}},{key:"isReady",value:function e(){return this.ready}},{key:"canChangeMediaDevices",value:function e(){var t;return!this.mediaMutedBySystem&&!((t=this.CallApi)!==null&&t!==void 0&&t.isMediaMutedBySystem)}},{key:"setCameraId",value:function e(t){var i;if(this.cameraId===t){return}this.cameraId=t;void((i=this.CallApi)===null||i===void 0?void 0:i.switchActiveVideoDevice(this.cameraId));if(this.ready&&this.mediaMutedBySystem){this.runCallback(Ac.onNeedResetMediaDevicesState);this.changedMediaMutedBySystem(false)}else if(this.ready&&H.isCameraOn){this.runCallback("onUpdateLastUsedCameraId");p.Runtime.debounce(this.replaceLocalMediaStream,100,this)()}}},{key:"setMicrophoneId",value:function e(t){var i;if(this.microphoneId===t){return}this.microphoneId=t;void((i=this.CallApi)===null||i===void 0?void 0:i.switchActiveAudioDevice(this.microphoneId));if(this.ready){if(this.mediaMutedBySystem){return}p.Runtime.debounce(this.replaceLocalAudioStream,100,this)()}}},{key:"setUseMediaServer",value:function e(t){if(t&&!this.useMediaServer){babelHelpers.classPrivateFieldSet(this,Ms,Ae.MediaServer)}else if(!t&&this.useMediaServer){babelHelpers.classPrivateFieldSet(this,Ms,Ae.PeerToPeer)}else{return}if(this.CallApi){this.CallApi.switchConnectionType(babelHelpers.classPrivateFieldGet(this,Ms))}bs(this,Ds,Ar).call(this);if(!t){this.setRecorderState(Pe.PAUSED)}}},{key:"getCurrentMicrophoneId",value:function e(){if(!this.localStreams["main"]){return this.microphoneId}var t=this.localStreams["main"].getAudioTracks();if(t.length>0){var i=t[0].getSettings();return i.deviceId}else{return this.microphoneId}}},{key:"useHdVideo",value:function e(t){this.videoHd=t===true}},{key:"sendLocalRecordState",value:function e(t){if(!this.updateCommonRecordState(vs(vs({},t),{},{senderId:this.userId}))){return}var i=[this.userId].concat(babelHelpers.toConsumableArray(this.users));this.signaling.sendLocalRecordState(i,this.commonRecordState)}},{key:"stopSendingStream",value:function e(t){}},{key:"allowVideoFrom",value:function e(t){}},{key:"inviteUsers",value:function e(){var t=this;var i=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};var n=p.Type.isArray(i.users)?i.users:Object.keys(this.peers);this.ready=true;if(i.localStream instanceof MediaStream&&!this.localStreams["main"]){this.localStreams["main"]=i.localStream}this.subscribeHardwareChanges();this.getLocalMediaStream("main",true).then((function(){return t.attachToConference()})).then((function(){if(!t.ready){bs(t,Rr,ao).call(t);return}clearTimeout(t.waitForAnswerTimeout);t.waitForAnswerTimeout=setTimeout((function(){bs(t,Hs,Lr).call(t)}),Is);for(var e=0;e<n.length;e++){var a=Number(n[e]);if(!t.peers[a]){t.peers[a]=t.createPeer(a)}t.peers[a].onInvited()}if(i.userData&&i.show){t.signaling.sendUsersInvited({users:i.userData})}}))["catch"]((function(e){console.error(e);bs(t,Rr,ao).call(t);t.runCallback(Ac.onCallFailure,e)}))}},{key:"attachToConference",value:function e(){var t=this;if(this.CallApi&&this.CallApi.getState()===ke.CONNECTED){return Promise.resolve()}return new Promise((function(e,i){try{t.CallApi=new At(t.userId);t.CallApi.needToStopStreams=false;if(!t.CallApi){t.log("Error: could not create Plain call");return i({code:"PLAIN_NO_CALL"})}t.bindCallEvents();t.CallApi.on("Connected",(function(){t.CallApi.on("Failed",babelHelpers.classPrivateFieldGet(t,wr));t.state=kc.Connected;t.runCallback(Ac.onJoin,{local:true});e()}));t.CallApi.on("Failed",(function(e){i(e)}));if(!t.ready){return i({code:"PLAIN_NO_CALL"})}t.CallApi.connect(vs({roomId:t.uuid,userId:t.userId,videoBitrate:1e6,videoSimulcast:true,audioDeviceId:t.microphoneId,videoDeviceId:t.cameraId},t.connectionData))}catch(e){i(e)}}))}},{key:"bindCallEvents",value:function e(){this.CallApi.on("ParticipantJoined",babelHelpers.classPrivateFieldGet(this,sr));this.CallApi.on("ParticipantLeaved",babelHelpers.classPrivateFieldGet(this,rr));this.CallApi.on("MessageReceived",babelHelpers.classPrivateFieldGet(this,or));this.CallApi.on("PublishSucceed",babelHelpers.classPrivateFieldGet(this,lr));this.CallApi.on("PublishPaused",babelHelpers.classPrivateFieldGet(this,cr));this.CallApi.on("MediaMutedBySystem",babelHelpers.classPrivateFieldGet(this,ur));this.CallApi.on("ToggleRemoteParticipantVideo",babelHelpers.classPrivateFieldGet(this,dr));this.CallApi.on("TrackSubscriptionFailed",babelHelpers.classPrivateFieldGet(this,hr));this.CallApi.on("RemoteMediaAdded",babelHelpers.classPrivateFieldGet(this,pr));this.CallApi.on("RemoteMediaRemoved",babelHelpers.classPrivateFieldGet(this,vr));this.CallApi.on("RemoteMediaMuted",babelHelpers.classPrivateFieldGet(this,fr));this.CallApi.on("RemoteMediaUnmuted",babelHelpers.classPrivateFieldGet(this,fr));this.CallApi.on("VoiceStarted",babelHelpers.classPrivateFieldGet(this,mr));this.CallApi.on("VoiceEnded",babelHelpers.classPrivateFieldGet(this,gr));this.CallApi.on("RecorderStatusChanged",babelHelpers.classPrivateFieldGet(this,br));this.CallApi.on("CloudRecordStatusChanged",babelHelpers.classPrivateFieldGet(this,Cr));this.CallApi.on("Reconnecting",babelHelpers.classPrivateFieldGet(this,kr));this.CallApi.on("Reconnected",babelHelpers.classPrivateFieldGet(this,yr));this.CallApi.on("ReconnectingFailed",babelHelpers.classPrivateFieldGet(this,Sr));this.CallApi.on("Disconnected",babelHelpers.classPrivateFieldGet(this,wr));this.CallApi.on("CallStatsReceived",babelHelpers.classPrivateFieldGet(this,Ir));this.CallApi.on("ConnectionQualityChanged",babelHelpers.classPrivateFieldGet(this,Tr));this.CallApi.on("ConnectionTypeChanged",babelHelpers.classPrivateFieldGet(this,Pr))}},{key:"removeCallEvents",value:function e(){if(this.CallApi){this.CallApi.on("ParticipantJoined",BX.DoNothing);this.CallApi.on("ParticipantLeaved",BX.DoNothing);this.CallApi.on("MessageReceived",BX.DoNothing);this.CallApi.on("PublishSucceed",BX.DoNothing);this.CallApi.on("PublishPaused",BX.DoNothing);this.CallApi.on("MediaMutedBySystem",BX.DoNothing);this.CallApi.on("ToggleRemoteParticipantVideo",BX.DoNothing);this.CallApi.on("TrackSubscriptionFailed",BX.DoNothing);this.CallApi.on("RemoteMediaAdded",BX.DoNothing);this.CallApi.on("RemoteMediaRemoved",BX.DoNothing);this.CallApi.on("RemoteMediaMuted",BX.DoNothing);this.CallApi.on("RemoteMediaUnmuted",BX.DoNothing);this.CallApi.on("VoiceStarted",BX.DoNothing);this.CallApi.on("VoiceEnded",BX.DoNothing);this.CallApi.on("RecorderStatusChanged",BX.DoNothing);this.CallApi.on("CloudRecordStatusChanged",BX.DoNothing);this.CallApi.on("Reconnecting",BX.DoNothing);this.CallApi.on("Reconnected",BX.DoNothing);this.CallApi.on("ReconnectingFailed",BX.DoNothing);this.CallApi.on("Disconnected",BX.DoNothing);this.CallApi.on("CallStatsReceived",babelHelpers.classPrivateFieldGet(this,Ir));this.CallApi.on("ConnectionQualityChanged",BX.DoNothing);this.CallApi.on("Failed",BX.DoNothing);this.CallApi.on("ConnectionTypeChanged",BX.DoNothing)}}},{key:"subscribeHardwareChanges",value:function e(){H.subscribe(H.Events.onChangeMicrophoneMuted,this.setMuted);H.subscribe(H.Events.onChangeCameraOn,this.setVideoEnabled)}},{key:"unsubscribeHardwareChanges",value:function e(){H.unsubscribe(H.Events.onChangeMicrophoneMuted,this.setMuted);H.unsubscribe(H.Events.onChangeCameraOn,this.setVideoEnabled)}},{key:"getMediaConstraints",value:function e(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};var i={};var n=t.videoEnabled?{}:false;var a=!!t.hdVideo;var s=navigator.mediaDevices.getSupportedConstraints?navigator.mediaDevices.getSupportedConstraints():{};if(this.microphoneId){i.deviceId={exact:this.microphoneId}}if(!this.enableMicAutoParameters){if(s.echoCancellation){i.echoCancellation=false}if(s.noiseSuppression){i.noiseSuppression=false}if(s.autoGainControl){i.autoGainControl=false}}if(n){if(this.cameraId){n.deviceId={exact:this.cameraId}}if(a){n.width={ideal:1280};n.height={ideal:720}}}return{audio:i,video:n}}},{key:"getUserMedia",value:function(){var e=babelHelpers.asyncToGenerator(hs().mark((function e(t){var i;return hs().wrap((function e(n){while(1)switch(n.prev=n.next){case 0:i=t[0];n.prev=1;n.next=4;return ae.getUserMedia(i);case 4:return n.abrupt("return",n.sent);case 7:n.prev=7;n.t0=n["catch"](1);this.log("getUserMedia error: ",n.t0);this.log("Current constraints",i);if(!(t.length>1)){n.next=13;break}return n.abrupt("return",this.getUserMedia(t.slice(1)));case 13:this.log("Last fallback constraints used, failing");throw n.t0;case 15:case"end":return n.stop()}}),e,this,[[1,7]])})));function t(t){return e.apply(this,arguments)}return t}()},{key:"getLocalMediaStream",value:function e(t,i){var n=this;if(!p.Type.isStringFilled(t)){t="main"}if(this.localStreams[t]){var a=ae.getLocalStream(ge.Camera);var s=Yf.MediaKind[ge.Camera];var r=new yn({kind:s,track:a});this.runCallback(Ac.onLocalMediaReceived,{tag:t,mediaRenderer:r,stream:r.stream});return Promise.resolve(this.localStreams[t])}this.log("Requesting access to media devices");return new Promise((function(e,a){var s=[];if(H.isCameraOn){s.push(n.getMediaConstraints({videoEnabled:true,hdVideo:true}),n.getMediaConstraints({videoEnabled:true,hdVideo:false}));if(i){s.push(n.getMediaConstraints({videoEnabled:false}))}}else{s.push(n.getMediaConstraints({videoEnabled:false}))}n.getUserMedia(s).then((function(i){n.log("Local media stream received");var a=i.clone();n.localStreams[t]=a;a.getVideoTracks().forEach((function(e){e.addEventListener("ended",(function(){return n.onLocalVideoTrackEnded()}));e.addEventListener("mute",(function(){return n.onLocalVideoTrackMute()}));e.addEventListener("unmute",(function(){return n.onLocalVideoTrackUnmute()}))}));a.getAudioTracks().forEach((function(e){e.addEventListener("ended",(function(){return n.onLocalAudioTrackEnded()}))}));var s=ae.getLocalStream(ge.Camera);var r=Yf.MediaKind[ge.Camera];var o=new yn({kind:r,track:s});n.runCallback(Ac.onLocalMediaReceived,{tag:t,mediaRenderer:o,stream:o.stream});n.setPublishingState(ge.Camera,true);if(t==="main"){n.attachVoiceDetection();if(H.isMicrophoneMuted){var l=a.getAudioTracks();if(l[0]){l[0].enabled=false}}}if(n.deviceList.length===0){H.getCurrentDeviceList().then((function(e){n.deviceList=e;n.runCallback(Ac.onDeviceListUpdated,{deviceList:n.deviceList})}))}e(n.localStreams[t])}))["catch"]((function(e){n.log("Could not get local media stream.",e);n.log("Request constraints: .",s);n.runCallback("onLocalMediaError",{tag:t,error:e});a(e)}))}))}},{key:"getLocalAudioStream",value:function e(t,i){var n=this;if(!p.Type.isStringFilled(t)){t="main"}if(this.localStreams[t]&&this.localStreams[t].getAudioTracks().length){return Promise.resolve(this.localStreams[t])}this.log("Requesting access to audio devices");return new Promise((function(e,i){var a=[n.getMediaConstraints({videoEnabled:false})];n.getUserMedia(a).then((function(i){n.log("Local audio stream received");if(!n.localStreams[t]){n.localStreams[t]=new MediaStream}n.localStreams[t].addTrack(i.getAudioTracks()[0]);i.getAudioTracks().forEach((function(e){e.addEventListener("ended",(function(){return n.onLocalAudioTrackEnded()}))}));if(t==="main"){n.attachVoiceDetection();if(n.muted){var a=i.getAudioTracks();if(a[0]){a[0].enabled=false}}}if(n.deviceList.length===0){H.getCurrentDeviceList().then((function(e){n.deviceList=e;n.runCallback(Ac.onDeviceListUpdated,{deviceList:n.deviceList})}))}e(n.localStreams[t])}))["catch"]((function(e){n.log("Could not get local audio stream.",e);n.log("Request constraints: .",a);n.runCallback("onLocalMediaError",{tag:t,error:e});i(e)}))}))}},{key:"setRecorderState",value:function e(t){if(!this.CallApi||babelHelpers.classPrivateFieldGet(this,_s)===t){return}if(t===Pe.ENABLED){babelHelpers.classPrivateFieldSet(this,Rs,true)}else if(t===Pe.DISABLED&&t===Pe.DESTROYED){babelHelpers.classPrivateFieldSet(this,Rs,false)}if(t===Pe.ENABLED&&!this.useMediaServer){this.setUseMediaServer(true)}this.CallApi.setRecorderState(t)}},{key:"setCloudRecordState",value:function e(t){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:null;if(!this.CallApi||babelHelpers.classPrivateFieldGet(this,Ps)===t){return}if(t===_e.STARTED&&!this.useMediaServer){this.setUseMediaServer(true)}this.CallApi.setCloudRecordState(t,i)}},{key:"setPublishingState",value:function e(t,i){if(t===ge.Camera){this.runCallback(Ac.onCameraPublishing,{publishing:i})}else if(t===ge.Microphone){this.runCallback(Ac.onMicrophonePublishing,{publishing:i})}}},{key:"setMainStream",value:function e(t){if(!this.CallApi){return}if(t.userId&&t.userId!==this.userId){var i;var n=(i=this.peers[t.userId])===null||i===void 0?void 0:i.participant;var a=n!==null&&n!==void 0&&n.screenSharingEnabled?ge.Screen:ge.Camera;this.CallApi.setMainStream(t,a)}else{this.CallApi.resetMainStream(t)}}},{key:"startMediaCapture",value:function e(){return this.getLocalMediaStream()}},{key:"attachVoiceDetection",value:function e(){if(this.voiceDetection){this.voiceDetection.destroy()}if(this.microphoneLevelInterval){clearInterval(this.microphoneLevelInterval)}try{this.voiceDetection=new ds({mediaStream:this.localStreams["main"],onVoiceStarted:this.onLocalVoiceStarted.bind(this),onVoiceStopped:this.onLocalVoiceStopped.bind(this)});this.microphoneLevelInterval=setInterval(function(){this.microphoneLevel=this.voiceDetection.currentVolume}.bind(this),200)}catch(e){this.log("Could not attach voice detection to media stream")}}},{key:"getDisplayMedia",value:function e(){return new Promise((function(e,t){ae.getUserScreen().then((function(t){e(t)}))["catch"]((function(e){t(e)}))}))}},{key:"startScreenSharing",value:function e(t){var i=this;if(this.localStreams.screen&&!t){return}this.getDisplayMedia().then((function(e){babelHelpers.classPrivateFieldSet(i,As,true);var t=e.clone();i.localStreams.screen=t;t.getVideoTracks().forEach((function(e){p.Event.bind(e,"ended",(function(){return i.stopScreenSharing()}))}));i.runCallback(Ac.onUserScreenState,{userId:i.userId,screenState:true});if(i.ready){var n=Object.values(i.peers);n.forEach((function(e){if(e.calculatedState===yc.Connected){e.sendMedia()}}))}}))["catch"]((function(e){i.log(e)}))}},{key:"onLocalVideoTrackEnded",value:function e(){var t="main";if(!this.localStreams[t]){return}babelHelpers.classPrivateFieldSet(this,As,false);Yf.stopMediaStreamVideoTracks(this.localStreams[t]);var i=Yf.MediaKind[ge.Camera];var n=new yn({kind:i});this.runCallback(Ac.onLocalMediaReceived,{tag:t,mediaRenderer:n,stream:n.stream});if(this.localStreams[t].getAudioTracks().length===0){this.localStreams[t]=null}for(var a in this.peers){if(this.peers[a].calculatedState===yc.Connected){this.peers[a].sendMedia()}}}},{key:"onLocalAudioTrackEnded",value:function e(){if(!this.localStreams.main){return}Yf.stopMediaStreamAudioTracks(this.localStreams.main);if(this.localStreams.main.getVideoTracks().length===0){this.localStreams.main=null}Object.values(this.peers).forEach((function(e){if(e.calculatedState===yc.Connected){e.sendMedia()}}))}},{key:"onLocalVideoTrackMute",value:function e(){this.changedMediaMutedBySystem(true);this.prevMainStream=this.localStreams["main"];if(this.ready){this.localStreams["main"]=null;for(var t in this.peers){if(this.peers[t].isReady()){this.peers[t].replaceMediaStream("main")}}}}},{key:"onLocalVideoTrackUnmute",value:function e(){var t=this;this.changedMediaMutedBySystem(false);if(this.prevMainStream){Yf.stopMediaStream(this.prevMainStream);this.prevMainStream=null}this.replaceLocalMediaStream()["catch"]((function(){var e=ae.getLocalStream(ge.Camera);var i=Yf.MediaKind[ge.Camera];var n=new yn({kind:i,track:e});t.runCallback(Ac.onLocalMediaReceived,{tag:"main",mediaRenderer:n,stream:n.stream})}))}},{key:"changedMediaMutedBySystem",value:function e(t){if(t===this.mediaMutedBySystem){return}this.mediaMutedBySystem=t;babelHelpers.classPrivateFieldGet(this,ur).call(this,t)}},{key:"stopScreenSharing",value:function e(){var t="screen";var i=this.localStreams[t];if(!i){return}babelHelpers.classPrivateFieldSet(this,As,false);Yf.stopMediaStream(i);ae.stopStream(ge.Screen);ae.stopStream(ge.ScreenAudio);this.localStreams[t]=null;this.runCallback(Ac.onUserScreenState,{userId:this.userId,screenState:false});Object.values(this.peers).forEach((function(e){if(e.calculatedState===yc.Connected){e.sendMedia()}}))}},{key:"isScreenSharingStarted",value:function e(){return babelHelpers.classPrivateFieldGet(this,As)}},{key:"onLocalVoiceStarted",value:function e(){this.talking=true;this.sendTalkingState()}},{key:"onLocalVoiceStopped",value:function e(){this.talking=false;this.sendTalkingState()}},{key:"sendTalkingState",value:function e(){if(this.talking&&!H.isMicrophoneMuted){this.runCallback(Ac.onUserVoiceStarted,{userId:this.userId,local:true});this.signaling.sendVoiceStarted({userId:this.users})}else{this.runCallback(Ac.onUserVoiceStopped,{userId:this.userId,local:true});this.signaling.sendVoiceStopped({userId:this.users})}}},{key:"sendLocalRecordState",value:function e(t){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:false;if(!i&&!this.updateCommonRecordState(vs(vs({},t),{},{senderId:this.userId}))){return}this.signaling.sendLocalRecordState(this.userId,this.commonRecordState)}},{key:"sendCustomMessage",value:function e(t){this.signaling.sendCustomMessage({userId:this.users,message:t})}},{key:"answer",value:function e(t){var i=this;if(!p.Type.isPlainObject(t)){t={}}this.ready=true;this.videoEnabled=H.isCameraOn;this.muted=H.isMicrophoneMuted;this.enableMicAutoParameters=t.enableMicAutoParameters!==false;if(t.localStream instanceof MediaStream){this.localStreams["main"]=t.localStream}return new Promise((function(e,t){i.subscribeHardwareChanges();i.getLocalMediaStream("main",true).then((function(){return i.attachToConference()})).then((function(){if(!i.ready){bs(i,Rr,ao).call(i);return}e()}))["catch"]((function(e){bs(i,Rr,ao).call(i);i.runCallback(Ac.onCallFailure,e);t(e)}))}))}},{key:"decline",value:function e(t,i){var n=this;this.ready=false;var a={callUuid:this.uuid,callInstanceId:this.instanceId};if(typeof t!="undefined"){a.code=t}if(typeof i!="undefined"){a.reason=i}tu.getRestClient().callMethod(Cs.decline,a).then((function(){n.destroy()}))}},{key:"hangup",value:function e(){var t=this;var i=arguments.length>0&&arguments[0]!==undefined?arguments[0]:false;if(!this.ready&&!i){var n=new Error("Hangup in wrong state");this.log(n);return Promise.reject(n)}var a=new Error;a.name="Call stack:";this.log("Hangup received \n".concat(a.stack));this.ready=false;this.state=kc.Proceeding;this.connectionData={};babelHelpers.classPrivateFieldSet(this,As,false);return new Promise((function(e,i){var n=Object.values(t.peers);n.forEach((function(e){e.disconnect()}));bs(t,Rr,ao).call(t);t.runCallback(Ac.onLeave,{local:true})}))}},{key:"getState",value:function e(){}},{key:"replaceLocalMediaStream",value:function e(){var t=this;var i=arguments.length>0&&arguments[0]!==undefined?arguments[0]:"main";this.setPublishingState(ge.Camera,true);if(this.localStreams[i]){Yf.stopMediaStream(this.localStreams[i]);this.localStreams[i]=null}return new Promise((function(e,n){t.getLocalMediaStream(i).then((function(){if(t.ready){for(var n in t.peers){if(t.peers[n].isReady()){t.peers[n].replaceMediaStream(i);if(t.mediaMutedBySystem){t.changedMediaMutedBySystem(false)}}}}e()}))["catch"]((function(e){console.error("Could not get access to hardware; don't really know what to do. error:",e);n(e)}))}))}},{key:"replaceLocalAudioStream",value:function e(){var t=this;var i=arguments.length>0&&arguments[0]!==undefined?arguments[0]:"main";if(this.localStreams[i]){Yf.stopMediaStreamAudioTracks(this.localStreams[i])}return new Promise((function(e,n){t.getLocalAudioStream(i).then((function(){if(t.ready){for(var n in t.peers){if(t.peers[n].isReady()){t.peers[n].replaceMediaStream(i)}}}e()}))["catch"]((function(e){console.error("Could not get access to hardware; don't really know what to do. error:",e);n(e)}))}))}},{key:"sendAllStreams",value:function e(t){if(!this.peers[t]){return}if(!this.peers[t].isReady()){return}for(var i in this.localStreams){if(this.localStreams[i]){this.peers[t].sendMedia()}}}},{key:"isAnyoneParticipating",value:function e(){for(var t in this.peers){if(this.peers[t].isParticipating()){return true}}return false}},{key:"getParticipatingUsers",value:function e(){var t=[];for(var i in this.peers){if(this.peers[i].isParticipating()){t.push(i)}}return t}},{key:"addJoinedUsers",value:function e(t){for(var i=0;i<t.length;i++){var n=Number(t[i]);if(n==this.userId||this.peers[n]){continue}this.peers[n]=this.createPeer(n);if(!this.users.includes(n)){this.users.push(n)}}}},{key:"addInvitedUsers",value:function e(t){for(var i in t){var n=Number(i);if(n==this.userId){continue}if(!this.peers[n]){this.peers[n]=this.createPeer(n);this.runCallback(Ac.onUserInvited,{userId:n,userData:babelHelpers.defineProperty({},n,t[i])})}if(this.peers[n].calculatedState!==yc.Calling){this.peers[n].onInvited()}if(!this.users.includes(n)){this.users.push(n)}}}},{key:"__onPullEvent",value:function e(t,i,n){var a={"Call::answer":bs(this,Os,Hr).bind(this),"Call::hangup":bs(this,Fs,xr).bind(this),"Call::usersJoined":bs(this,Ns,Br).bind(this),"Call::associatedEntityReplaced":bs(this,Ks,Yr).bind(this),"Call::finish":bs(this,Zs,Qr).bind(this),"Call::customMessage":bs(this,$s,Jr).bind(this)};if(a[t]){if(t!=="Call::ping"){this.log("Signaling: "+t+"; Parameters: "+JSON.stringify(i))}a[t].call(this,i)}}},{key:"destroy",value:function e(i){this.ready=false;var n=new Error;n.name="Call stack:";this.log("Call destroy \n"+n.stack);for(var a in this.peers){if(this.peers[a]){this.peers[a].destroy()}}bs(this,Rr,ao).call(this,i);this.runCallback(Ac.onLeave,{local:true});return babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"destroy",this).call(this)}},{key:"provider",get:function e(){return Tc.Plain}},{key:"hasConnectionData",get:function e(){return Boolean(this.connectionData.mediaServerUrl&&this.connectionData.roomData)}},{key:"isCopilotInitialized",get:function e(){return babelHelpers.classPrivateFieldGet(this,_s)!==Pe.UNAVAILABLE||babelHelpers.classPrivateFieldGet(this,Es)}},{key:"isCopilotActive",get:function e(){return babelHelpers.classPrivateFieldGet(this,_s)===Pe.ENABLED}},{key:"isCopilotFeaturesEnabled",get:function e(){return this._isCopilotFeaturesEnabled},set:function e(t){if(t!==this._isCopilotFeaturesEnabled){this._isCopilotFeaturesEnabled=t}}},{key:"isCopilotInitiator",get:function e(){return babelHelpers.classPrivateFieldGet(this,Rs)}},{key:"isCloudRecordFeaturesEnabled",get:function e(){return babelHelpers.classPrivateFieldGet(this,Ts)},set:function e(t){if(t!==babelHelpers.classPrivateFieldGet(this,Ts)){babelHelpers.classPrivateFieldSet(this,Ts,t)}}},{key:"isCloudRecordActive",get:function e(){return babelHelpers.classPrivateFieldGet(this,Ps)===_e.STARTED}},{key:"useMediaServer",get:function e(){return babelHelpers.classPrivateFieldGet(this,Ms)===Ae.MediaServer}}]);return t}(Oi);function Ar(){if(!this.ready){return}for(var e=0,t=Object.values(this.peers);e<t.length;e++){var i=t[e];if(i.calculatedState===yc.Connected){i.sendMedia()}}}function Lr(){if(this.ready&&!this.isAnyoneParticipating()){this.destroy(true)}}function Br(e){if(!this.ready){return}var t=e.users;this.addJoinedUsers(t)}function Dr(e){if(!this.ready){return}var t=e.users;this.addInvitedUsers(t)}function Hr(e){var t=Number(e.senderId);if(t==this.userId){return bs(this,Us,Nr).call(this,e)}if(!this.ready){return}if(!this.peers[t]){return}if(this.peers[t].isReady()){this.log("Received answer for user "+t+" in ready state, ignoring");return}this.peers[t].setSignalingConnected(true);this.peers[t].setReady(true);this.peers[t].isLegacyMobile=e.isLegacyMobile===true;if(this.ready){this.sendAllStreams(t)}}function Nr(e){this.runCallback("onGetUserMediaEnded",{});if(e.callInstanceId===this.instanceId){return}if(this.ready){this.log("Received remote self-answer in ready state, ignoring");return}this.log("Call was answered elsewhere");this.runCallback(Ac.onJoin,{local:false})}function xr(e){var t=e.senderId;if(this.userId==t){if(this.instanceId!=e.callInstanceId){this.runCallback(Ac.onLeave,{local:false})}return}if(!this.peers[t]||this.peers[t].participant){return}this.peers[t].disconnect(e.code);this.peers[t].setReady(false);if(e.code==603){this.peers[t].setDeclined(true)}if(!this.isAnyoneParticipating()&&this.ready){this.hangup()}}function Or(e){if(!this.ready){return}var t=this.peers[e.senderId];if(!t){return}t.setReady(true);if(e.restart){t.reconnect({reconnectionReason:"GOT_PULL_EVENT_NEGOTIATION_NEEDED"})}else{t.onNegotiationNeeded()}}function Ur(e){if(!this.ready){return}var t=this.peers[e.senderId];if(!t){return}t.setReady(true);t.setUserAgent(e.userAgent);t.setConnectionOffer(e.connectionId,e.sdp,e.tracks)}function Fr(e){if(!this.ready){return}var t=this.peers[e.senderId];if(!t){return}var i=e.connectionId;t.setUserAgent(e.userAgent);t.setConnectionAnswer(i,e.sdp,e.tracks)}function Vr(e){if(!this.ready){return}var t=this.peers[e.senderId];var i;if(!t){return}try{i=e.candidates;for(var n=0;n<i.length;n++){t.addIceCandidate(e.connectionId,i[n])}}catch(e){this.log("Error parsing serialized candidate: ",e)}}function Gr(e){this.runCallback(Ac.onUserVoiceStarted,{userId:e.senderId})}function Wr(e){this.runCallback(Ac.onUserVoiceStopped,{userId:e.senderId})}function Xr(e){if(e.senderId==this.userId){return}this.runCallback(Ac.onUserMicrophoneState,{userId:e.senderId,microphoneState:e.microphoneState})}function zr(e){this.runCallback(Ac.onUserCameraState,{userId:e.senderId,cameraState:e.cameraState})}function jr(e){var t=this.peers[e.senderId];if(!t){return}this.runCallback(Ac.onUserVideoPaused,{userId:e.senderId,videoPaused:e.videoPaused});t.holdOutgoingVideo(!!e.videoPaused)}function qr(e){this.runCallback(Ac.onUserCommonRecordState,{userId:e.senderId,commonRecordState:e.commonRecordState})}function Yr(e){if(e.call&&e.call.ASSOCIATED_ENTITY){this.associatedEntity=e.call.ASSOCIATED_ENTITY}}function Qr(){this.destroy()}function Jr(e){this.runCallback(Ac.onCustomMessage,{message:e.message})}function Kr(e){var t=this;this.runCallback(Ac.onUserStateChanged,e);if(e.state==yc.Failed||e.state==yc.Unavailable){if(!this.isAnyoneParticipating()){this.hangup().then(this.destroy.bind(this))["catch"]((function(){t.destroy()}))}}else if(e.state==yc.Connected){this.signaling.sendMicrophoneState([e.userId],!H.isMicrophoneMuted);this.signaling.sendCameraState(e.userId,H.isCameraOn);this.wasConnected=true}}function Zr(e){if(!this.ready){return}}function $r(e){if(this.useMediaServer){return}var t={};var i={};e.stats.forEach((function(e){if(e.type==="inbound-rtp"&&(e.kind==="video"||e.kind==="audio")&&e.source){t[e.source]=e}if(e.type==="outbound-rtp"&&(e.kind==="video"||e.kind==="audio")&&e.source){i[e.source]=e}}));this.runCallback(Ac.onUserStatsReceived,{userId:e.userId,report:t});this.runCallback(Ac.onUserStatsReceived,{userId:this.userId,report:i});this.runCallback(Ac.onRTCStatsReceived,e)}function eo(e){this.runCallback(Ac.onConnectionQualityChanged,{userId:e.userId,score:e.score})}function to(e,t){var i=null;if(!e||!t){return i}var n=e.userId;var a=Yf.MediaKind[t.source];if(!a){this.log("Unknown kind for mediaRenderer: ".concat(t.source," for user: ").concat(n));return i}i=this.peers[n];return i}function io(){if(!this.ready){return}for(var e in this.peers){this.peers[e].disconnect()}}function no(){var e=Object.values(this.peers);e.forEach((function(e){e.reconnect({reconnectionReason:"GOT_ONLINE_EVENT_FROM_BROWSER"})}))}function ao(){var e=arguments.length>0&&arguments[0]!==undefined?arguments[0]:false;this.removeCallEvents();if(this.CallApi){this.CallApi.hangup(e);this.CallApi=null}this.unsubscribeHardwareChanges();for(var t=0,i=Object.keys(this.localStreams);t<i.length;t++){var n=i[t];if(this.localStreams[n]){Yf.stopMediaStream(this.localStreams[n]);this.localStreams[n]=null}}if(this.prevMainStream){Yf.stopMediaStream(this.prevMainStream);this.prevMainStream=null}if(this.voiceDetection){this.voiceDetection.destroy();this.voiceDetection=null}p.Event.unbind(window,"unload",babelHelpers.classPrivateFieldGet(this,Ls));p.Event.unbind(window,"online",babelHelpers.classPrivateFieldGet(this,Bs));clearInterval(this.statsInterval);clearInterval(this.microphoneLevelInterval)}var so=new WeakSet;var ro=new WeakSet;var oo=function(){function e(t){babelHelpers.classCallCheck(this,e);fs(this,ro);fs(this,so);this.call=t.call}babelHelpers.createClass(e,[{key:"isIceTricklingAllowed",value:function e(){return tu.getPullClient().isPublishingSupported()}},{key:"sendUsersInvited",value:function e(t){bs(this,so,lo).call(this,ks.usersInvited,t)}},{key:"sendConnectionOffer",value:function e(t){return bs(this,so,lo).call(this,ks.connectionOffer,t)}},{key:"sendConnectionAnswer",value:function e(t){return bs(this,so,lo).call(this,ks.connectionAnswer,t)}},{key:"sendIceCandidate",value:function e(t){return bs(this,so,lo).call(this,ks.iceCandidate,t)}},{key:"sendNegotiationNeeded",value:function e(t){return bs(this,so,lo).call(this,ks.negotiationNeeded,t)}},{key:"sendVoiceStarted",value:function e(t){return bs(this,so,lo).call(this,ks.voiceStarted,t)}},{key:"sendVoiceStopped",value:function e(t){return bs(this,so,lo).call(this,ks.voiceStopped,t)}},{key:"sendMicrophoneState",value:function e(t,i){return bs(this,so,lo).call(this,ks.microphoneState,{userId:t,microphoneState:i})}},{key:"sendCameraState",value:function e(t,i){return bs(this,so,lo).call(this,ks.cameraState,{userId:t,cameraState:i})}},{key:"sendVideoPaused",value:function e(t,i){return bs(this,so,lo).call(this,ks.videoPaused,{userId:t,videoPaused:i})}},{key:"sendUseMediaServer",value:function e(t,i){return bs(this,so,lo).call(this,ks.useMediaServer,{useMediaServer:i,userId:t})}},{key:"sendLocalRecordState",value:function e(t,i){return bs(this,so,lo).call(this,ks.commonRecordState,{userId:t,commonRecordState:i})}},{key:"sendCustomMessage",value:function e(t){return bs(this,so,lo).call(this,ks.customMessage,t)}}]);return e}();function lo(e,t){if(!this.call.CallApi){return}var i=vs({eventName:e,requestId:Yf.getUuidv4(),senderId:this.call.userId},p.Type.isPlainObject(t)?t:{});this.call.CallApi.sendMessage(JSON.stringify(i))}var co=new WeakSet;var uo=new WeakSet;var ho=new WeakSet;var po=new WeakSet;var vo=new WeakSet;var fo=new WeakSet;var mo=new WeakSet;var go=new WeakSet;var bo=new WeakSet;var Co=new WeakSet;var ko=new WeakSet;var yo=new WeakSet;var So=new WeakSet;var wo=new WeakSet;var Io=new WeakSet;var To=function(){function e(t){babelHelpers.classCallCheck(this,e);fs(this,Io);fs(this,wo);fs(this,So);fs(this,yo);fs(this,ko);fs(this,Co);fs(this,bo);fs(this,go);fs(this,mo);fs(this,fo);fs(this,vo);fs(this,po);fs(this,ho);fs(this,uo);fs(this,co);this.call=t.call;this.userId=t.userId;this.ready=t.ready===true;this.calling=false;this.inviteTimeout=false;this.declined=false;this.busy=false;this.signalingConnected=t.signalingConnected===true;this.failureReason="";this.userAgent="";this.isFirefox=false;this.isChrome=false;this.isLegacyMobile=t.isLegacyMobile===true;this.calculatedState=this.calculateState();this.localStreams={main:null,screen:null};this.pendingIceCandidates={};this.localIceCandidates=[];this.trackList={};this.callbacks={onStateChanged:p.Type.isFunction(t.onStateChanged)?t.onStateChanged:BX.DoNothing,onInviteTimeout:p.Type.isFunction(t.onInviteTimeout)?t.onInviteTimeout:BX.DoNothing,onMediaReceived:p.Type.isFunction(t.onMediaReceived)?t.onMediaReceived:BX.DoNothing,onMediaStopped:p.Type.isFunction(t.onMediaStopped)?t.onMediaStopped:BX.DoNothing,onRTCStatsReceived:p.Type.isFunction(t.onRTCStatsReceived)?t.onRTCStatsReceived:BX.DoNothing,onRTCQualityChanged:p.Type.isFunction(t.onRTCQualityChanged)?t.onRTCQualityChanged:BX.DoNothing,onNetworkProblem:p.Type.isFunction(t.onNetworkProblem)?t.onNetworkProblem:BX.DoNothing,onReconnecting:p.Type.isFunction(t.onReconnecting)?t.onReconnecting:BX.DoNothing,onReconnected:p.Type.isFunction(t.onReconnected)?t.onReconnected:BX.DoNothing,onUpdateLastUsedCameraId:p.Type.isFunction(t.onUpdateLastUsedCameraId)?t.onUpdateLastUsedCameraId:BX.DoNothing};this.answerTimeout=null;this.callingTimeout=null;this.connectionTimeout=null;this.signalingConnectionTimeout=null;this.candidatesTimeout=null;this.statsInterval=null;this.connectionOfferReplyTimeout=null;this.negotiationNeededReplyTimeout=null;this.reconnectAfterDisconnectTimeout=null;this.connectionAttempt=0;this.hasStun=false;this.hasTurn=false;this._outgoingVideoTrack=null;Object.defineProperty(this,"outgoingVideoTrack",{get:function e(){return this._outgoingVideoTrack},set:function e(t){if(this._outgoingVideoTrack){this._outgoingVideoTrack.stop()}this._outgoingVideoTrack=t;if(this._outgoingVideoTrack){this._outgoingVideoTrack.enabled=!this.outgoingVideoHoldState}}});this._outgoingScreenTrack=null;Object.defineProperty(this,"outgoingScreenTrack",{get:function e(){return this._outgoingScreenTrack},set:function e(t){if(this._outgoingScreenTrack){this._outgoingScreenTrack.stop()}this._outgoingScreenTrack=t;if(this._outgoingScreenTrack){this._outgoingScreenTrack.enabled=!this.outgoingVideoHoldState}}});this._incomingAudioTrack=null;this._incomingScreenAudioTrack=null;this._incomingVideoTrack=null;this._incomingScreenTrack=null;Object.defineProperty(this,"incomingAudioTrack",{get:this._mediaGetter("_incomingAudioTrack"),set:this._mediaSetter("_incomingAudioTrack","audio")});Object.defineProperty(this,"incomingVideoTrack",{get:this._mediaGetter("_incomingVideoTrack"),set:this._mediaSetter("_incomingVideoTrack","video")});Object.defineProperty(this,"incomingScreenTrack",{get:this._mediaGetter("_incomingScreenTrack"),set:this._mediaSetter("_incomingScreenTrack","screen")});Object.defineProperty(this,"incomingScreenAudioTrack",{get:this._mediaGetter("_incomingScreenAudioTrack"),set:this._mediaSetter("_incomingScreenAudioTrack","sharingAudio")});this.outgoingVideoHoldState=false;this._onPeerConnectionIceCandidateHandler=this._onPeerConnectionIceCandidate.bind(this);this._onPeerConnectionConnectionStateChangeHandler=bs(this,po,Ro).bind(this);this._onPeerConnectionIceGatheringStateChangeHandler=bs(this,vo,Mo).bind(this);this._onPeerConnectionSignalingStateChangeHandler=bs(this,fo,Ao).bind(this);this._onPeerConnectionTrackHandler=bs(this,go,Lo).bind(this);this._onPeerConnectionRemoveStreamHandler=bs(this,Co,Do).bind(this);this._updateTracksDebounced=p.Runtime.debounce(bs(this,wo,Oo).bind(this),50);this._waitTurnCandidatesTimeout=null;this.prevPercentPacketLostList={incomingPacketLost:[],outgoingPacketLost:[]};this.reportsForIncomingTracks={};this.reportsForOutgoingTracks={};this.packetLostThreshold=7;this.videoBitrate=1e6;this.screenShareBitrate=15e5;this.maxConnectionScore=5;this.incomingConnectionScore=0;this.outgoingConnectionScore=0}babelHelpers.createClass(e,[{key:"_mediaGetter",value:function e(t){return function(){return this[t]}.bind(this)}},{key:"_mediaSetter",value:function e(t,i){return function(e){if(this[t]!=e){this[t]=e;if(e){this.callbacks.onMediaReceived({userId:this.userId,kind:i,track:e})}else{this.callbacks.onMediaStopped({userId:this.userId,kind:i})}}}.bind(this)}},{key:"sendMedia",value:function e(t){if(!this.peerConnection){if(!this.isInitiator()){this.log("waiting for the other side to send connection offer");this.sendNegotiationNeeded(false);return}}if(!this.peerConnection){var i=Yf.getUuidv4();bs(this,ho,Eo).call(this,i)}this.updateOutgoingTracks();if(!t){this.applyResolutionScale();this.createAndSendOffer()}}},{key:"updateOutgoingTracks",value:function e(){bs(this,co,Po).call(this);bs(this,uo,_o).call(this)}},{key:"getSenderMid",value:function e(t){if(!t||!this.peerConnection){return null}var i=this.peerConnection.getTransceivers().find((function(e){if(e.sender.track&&t.track){return e.sender.track.id===t.track.id}return false}));return i?i.mid:null}},{key:"applyResolutionScale",value:function e(t){if(this.videoSender){var i=t||(this.screenSender?2:1);var n=this.videoBitrate/i;var a=this.videoSender.getParameters();if(a.encodings&&a.encodings.length>0){a.encodings[0].scaleResolutionDownBy=i;a.encodings[0].maxBitrate=n;this.videoSender.setParameters(a)}}if(this.screenSender){var s=this.screenSender.getParameters();if(s.encodings&&s.encodings.length>0){s.encodings[0].maxBitrate=this.screenShareBitrate;this.screenSender.setParameters(s)}}}},{key:"replaceMediaStream",value:function e(t){if(this.isRenegotiationSupported()){this.sendMedia()}else{this.localStreams[t]=this.call.getLocalStream(t);this.reconnect({reconnectionReasonInfo:"Reconnect by replaceMediaStream"})}}},{key:"holdOutgoingVideo",value:function e(t){if(this.outgoingVideoHoldState==t){return}this.outgoingVideoHoldState=t;if(this._outgoingVideoTrack){this._outgoingVideoTrack.enabled=!this.outgoingVideoHoldState}}},{key:"isInitiator",value:function e(){return this.call.userId<this.userId}},{key:"isRenegotiationSupported",value:function e(){return true}},{key:"setReady",value:function e(t){this.ready=t;if(this.ready){this.declined=false;this.busy=false}if(this.calling){clearTimeout(this.callingTimeout);this.calling=false}this.updateCalculatedState()}},{key:"isReady",value:function e(){return this.ready}},{key:"onInvited",value:function e(){this.ready=false;this.inviteTimeout=false;this.declined=false;this.calling=true;if(this.callingTimeout){clearTimeout(this.callingTimeout)}this.callingTimeout=setTimeout(function(){this.onInviteTimeout(true)}.bind(this),Is);this.updateCalculatedState()}},{key:"onInviteTimeout",value:function e(t){clearTimeout(this.callingTimeout);this.calling=false;this.inviteTimeout=true;if(t){this.callbacks.onInviteTimeout({userId:this.userId})}this.updateCalculatedState()}},{key:"setUserAgent",value:function e(t){this.userAgent=t;this.isFirefox=t.toLowerCase().indexOf("firefox")!=-1;this.isChrome=t.toLowerCase().indexOf("chrome")!=-1;this.isLegacyMobile=t==="Bitrix Legacy Mobile"}},{key:"getUserAgent",value:function e(){return this.userAgent}},{key:"isParticipating",value:function e(){if(this.calling){return true}if(this.declined||this.busy){return false}if(this.peerConnection){var t=this.peerConnection.iceConnectionState;if(t=="checking"||t=="connected"||t=="completed"){return true}}return false}},{key:"setSignalingConnected",value:function e(t){this.signalingConnected=t;this.updateCalculatedState();if(this.signalingConnected){this.refreshSignalingTimeout()}else{this.stopSignalingTimeout()}}},{key:"isSignalingConnected",value:function e(){return this.signalingConnected}},{key:"setDeclined",value:function e(t){this.declined=t;if(this.calling){clearTimeout(this.callingTimeout);this.calling=false}this.updateCalculatedState()}},{key:"setBusy",value:function e(t){this.busy=t;if(this.calling){clearTimeout(this.callingTimeout);this.calling=false}this.updateCalculatedState()}},{key:"isDeclined",value:function e(){return this.declined}},{key:"updateCalculatedState",value:function e(){var t=this.calculateState();if(this.calculatedState!=t){this.callbacks.onStateChanged({userId:this.userId,state:t,previousState:this.calculatedState,isLegacyMobile:this.isLegacyMobile,networkProblem:!this.hasStun||!this.hasTurn});this.calculatedState=t}}},{key:"calculateState",value:function e(){if(this.peerConnection){if(this.failureReason!==""){return yc.Failed}if(this.peerConnection.iceConnectionState==="connected"||this.peerConnection.iceConnectionState==="completed"){return yc.Connected}return yc.Connecting}if(this.calling){return yc.Calling}if(this.inviteTimeout){return yc.Unavailable}if(this.declined){return yc.Declined}if(this.busy){return yc.Busy}if(this.ready){return yc.Ready}return yc.Idle}},{key:"getSignaling",value:function e(){return this.call.signaling}},{key:"startStatisticsGathering",value:function e(){clearInterval(this.statsInterval);this.statsInterval=setInterval(function(){if(!this.peerConnection){return false}this.peerConnection.getStats().then(function(e){var t=this;var i=[];var n={};var a={};var s={};var r={};var o=0;var l=0;e.forEach((function(e){i.push(e);var c=(e===null||e===void 0?void 0:e.trackIdentifier)&&(e===null||e===void 0?void 0:e.type)==="inbound-rtp"&&e.hasOwnProperty("packetsLost")&&e.hasOwnProperty("packetsReceived");if(c||e.type==="outbound-rtp"){switch(t.trackList[e.mid]){case"video":e.source=ge.Camera;break;case"screen":e.source=ge.Screen;break;case"audio":e.source=ge.Microphone;break;default:return}}if(c){e.bitrate=Yf.calcBitrate(e,t.reportsForIncomingTracks[e.source]);var u=Yf.calcRemotePacketsLost(e,t.reportsForIncomingTracks[e.source]);e.packetsLostExtended=Yf.formatPacketsLostData(u);if(!Yf.setCodecToReport(e,n,a)){Yf.saveReportWithoutCodecs(e,a)}t.reportsForIncomingTracks[e.source]=e;if(e.source===ge.Camera){o=u.currentPercentPacketLost}}if(e.type==="codec"){Yf.processReportsWithoutCodecs(e,n,a)}if(e.type==="remote-inbound-rtp"){var d=e.localId;if(r[d]){var h=Yf.calcLocalPacketsLost(r[d],t.reportsForOutgoingTracks[d],e);r[d].packetsLostData=h;r[d].packetsLost=h.totalPacketsLost;r[d].packetsLostExtended=Yf.formatPacketsLostData(h);t.reportsForOutgoingTracks[d]=r[d];delete r[d];if(t.reportsForOutgoingTracks[d].source===ge.Camera){l=e.packetsLost}return}s[d]=e}if(e.type==="outbound-rtp"){e.bitrate=Yf.calcBitrate(e,t.reportsForOutgoingTracks[e.id],true);e.userId=t.call.userId;if(!Yf.setCodecToReport(e,n,a)){Yf.saveReportWithoutCodecs(e,a)}if(Yf.setLocalPacketsLostOrSaveReport(e,s,r)){t.reportsForOutgoingTracks[e.id]=e;if(e.source===ge.Camera){l=e.packetsLostData.currentPercentPacketLost}}}}));if(this.prevPercentPacketLostList.incomingPacketLost.push(o)>10){this.prevPercentPacketLostList.incomingPacketLost.shift()}var c=this.prevPercentPacketLostList.incomingPacketLost.reduce((function(e,t){return e+t}),0)/this.prevPercentPacketLostList.incomingPacketLost.length;var u=this.calcNewConnectionScore(c);if(!this.incomingConnectionScore||this.incomingConnectionScore!==u){this.incomingConnectionScore=u;this.callbacks.onRTCQualityChanged({userId:this.userId,score:this.incomingConnectionScore})}if(this.prevPercentPacketLostList.outgoingPacketLost.push(l)>10){this.prevPercentPacketLostList.outgoingPacketLost.shift()}var d=this.prevPercentPacketLostList.outgoingPacketLost.reduce((function(e,t){return e+t}),0)/this.prevPercentPacketLostList.outgoingPacketLost.length;var h=this.calcNewConnectionScore(d);if(!this.outgoingConnectionScore||this.outgoingConnectionScore!==h){this.outgoingConnectionScore=h;this.callbacks.onRTCQualityChanged({userId:this.call.userId,score:this.outgoingConnectionScore})}this.callbacks.onRTCStatsReceived({userId:this.userId,stats:i})}.bind(this))}.bind(this),1e3)}},{key:"calcNewConnectionScore",value:function e(t){var i;if(t<10){i=4}if(t>10&&t<=20){i=3}if(t>20&&t<=30){i=2}if(t>30){i=1}return i}},{key:"stopStatisticsGathering",value:function e(){clearInterval(this.statsInterval);this.statsInterval=null}},{key:"updateCandidatesTimeout",value:function e(){if(this.candidatesTimeout){clearTimeout(this.candidatesTimeout)}this.candidatesTimeout=setTimeout(this.sendIceCandidates.bind(this),500)}},{key:"sendIceCandidates",value:function e(){this.log("User "+this.userId+": sending ICE candidates due to the timeout");this.candidatesTimeout=null;if(this.localIceCandidates.length>0){this.getSignaling().sendIceCandidate({userId:this.userId,connectionId:this.peerConnectionId,candidates:this.localIceCandidates});this.localIceCandidates=[]}else{this.log("User "+this.userId+": ICE candidates pool is empty")}}},{key:"_destroyPeerConnection",value:function e(){if(!this.peerConnection){return}clearTimeout(this.reconnectAfterDisconnectTimeout);this.log("User "+this.userId+": Destroying peer connection "+this.peerConnectionId);this.stopStatisticsGathering();this.peerConnection.removeEventListener("icecandidate",this._onPeerConnectionIceCandidateHandler);this.peerConnection.removeEventListener("connectionstatechange",this._onPeerConnectionConnectionStateChangeHandler);this.peerConnection.removeEventListener("icegatheringstatechange",this._onPeerConnectionIceGatheringStateChangeHandler);this.peerConnection.removeEventListener("signalingstatechange",this._onPeerConnectionSignalingStateChangeHandler);this.peerConnection.removeEventListener("track",this._onPeerConnectionTrackHandler);this.peerConnection.removeEventListener("removestream",this._onPeerConnectionRemoveStreamHandler);this.localIceCandidates=[];if(this.pendingIceCandidates[this.peerConnectionId]){delete this.pendingIceCandidates[this.peerConnectionId]}this.peerConnection.close();this.peerConnection=null;this.peerConnectionId=null;this.videoSender=null;this.audioSender=null;this.screenSender=null;this.screenAudioSender=null;this.incomingAudioTrack=null;this.incomingScreenAudioTrack=null;this.incomingVideoTrack=null;this.incomingScreenTrack=null}},{key:"_onPeerConnectionIceCandidate",value:function e(t){var i=t.candidate;this.log("User "+this.userId+": ICE candidate discovered. Candidate: "+(i?i.candidate:i));if(i){if(this.getSignaling().isIceTricklingAllowed()){this.getSignaling().sendIceCandidate({userId:this.userId,connectionId:this.peerConnectionId,candidates:[i.toJSON()]})}else{this.localIceCandidates.push(i.toJSON());this.updateCandidatesTimeout()}var n=i.candidate.match(/typ\s(\w+)?/);if(n){var a=n[1];if(a=="srflx"){this.hasStun=true}else if(a=="relay"){this.hasTurn=true}}}}},{key:"addMediaRenderer",value:function e(t){bs(this,bo,Bo).call(this,t)}},{key:"removeMediaRenderer",value:function e(t){this.log("Removing media renderer for user ".concat(this.userId," ").concat(t.track.source));switch(t.track.source){case ge.Camera:this.incomingVideoTrack=null;break;case ge.Microphone:this.incomingAudioTrack=null;break;case ge.Screen:case ge.ScreenAudio:this.incomingScreenTrack=null;this.incomingScreenAudioTrack=null;break;default:}}},{key:"stopSignalingTimeout",value:function e(){clearTimeout(this.signalingConnectionTimeout)}},{key:"refreshSignalingTimeout",value:function e(){clearTimeout(this.signalingConnectionTimeout);this.signalingConnectionTimeout=setTimeout(bs(this,Io,Uo).bind(this),Ss)}},{key:"_onConnectionOfferReplyTimeout",value:function e(t){var i="Did not receive connection answer for connection ".concat(t);this.log(i);this.call.setPublishingState(ge.Camera,false);this.reconnect({reconnectionReasonInfo:i})}},{key:"_onNegotiationNeededReplyTimeout",value:function e(){var t="Did not receive connection offer in time";this.log(t);this.reconnect({reconnectionReasonInfo:t})}},{key:"setConnectionOffer",value:function e(t,i,n){this.log("User "+this.userId+": applying connection offer for connection "+t);clearTimeout(this.negotiationNeededReplyTimeout);this.negotiationNeededReplyTimeout=null;if(!this.call.isReady()){return}if(!this.isReady()){return}if(n){this.trackList=BX.util.array_flip(n)}if(this.peerConnection){if(this.peerConnectionId!==t){this._destroyPeerConnection();bs(this,ho,Eo).call(this,t)}}else{bs(this,ho,Eo).call(this,t)}this.applyOfferAndSendAnswer(i)}},{key:"createAndSendOffer",value:function e(t){var i=this;var n=ys;for(var a in t){n[a]=t[a]}this.peerConnection.createOffer(n).then((function(e){i.log("User "+i.userId+": Created connection offer.");i.log("Applying local description");return i.peerConnection.setLocalDescription(e)})).then((function(){i.sendOffer()}))}},{key:"sendOffer",value:function e(){var t=this;clearTimeout(this.connectionOfferReplyTimeout);this.connectionOfferReplyTimeout=setTimeout((function(){return t._onConnectionOfferReplyTimeout(t.peerConnectionId)}),ws);this.getSignaling().sendConnectionOffer({userId:this.userId,connectionId:this.peerConnectionId,sdp:this.peerConnection.localDescription.sdp,tracks:{audio:this.getSenderMid(this.audioSender),video:this.getSenderMid(this.videoSender),screen:this.getSenderMid(this.screenSender),sharingAudio:this.getSenderMid(this.screenAudioSender)},userAgent:navigator.userAgent})}},{key:"sendNegotiationNeeded",value:function e(t){var i=this;t=t===true;clearTimeout(this.negotiationNeededReplyTimeout);this.negotiationNeededReplyTimeout=setTimeout((function(){return i._onNegotiationNeededReplyTimeout()}),ws);var n={userId:this.userId};if(t){n.restart=true}this.getSignaling().sendNegotiationNeeded(n)}},{key:"applyOfferAndSendAnswer",value:function e(t){var i=this;var n=new RTCSessionDescription({sdp:t,type:"offer"});if(this.pendingRemoteSdpDelay){this.pendingRemoteSdp=t;return}this.log("User: ".concat(this.userId,"; Applying remote offer"));this.log("User: ".concat(this.userId,"; Peer ice connection state ").concat(this.peerConnection.iceConnectionState));var a=this.peerConnection.signalingState==="have-local-offer";if(this.isInitiator()&&a){return}var s=a?new Promise((function(e){clearTimeout(i.connectionOfferReplyTimeout);e(i.peerConnection.setLocalDescription())})):Promise.resolve();this.pendingRemoteSdpDelay=true;s.then((function(){return i.peerConnection.setRemoteDescription(n)})).then((function(){if(i.peerConnection.iceConnectionState==="new"){i.sendMedia(true)}return i.peerConnection.createAnswer()})).then((function(e){i.log("Created connection answer.");i.log("Applying local description.");return i.peerConnection.setLocalDescription(e)})).then((function(){i.applyResolutionScale();i.applyPendingIceCandidates();i.getSignaling().sendConnectionAnswer({userId:i.userId,connectionId:i.peerConnectionId,sdp:i.peerConnection.localDescription.sdp,tracks:{audio:i.getSenderMid(i.audioSender),video:i.getSenderMid(i.videoSender),screen:i.getSenderMid(i.screenSender),sharingAudio:i.getSenderMid(i.screenAudioSender)},userAgent:navigator.userAgent})}))["catch"]((function(e){i.failureReason=e.toString();i.updateCalculatedState();i.log("Could not apply remote offer",e);console.error("Could not apply remote offer",e)}))["finally"]((function(){var e;i.pendingRemoteSdpDelay=false;if(i.pendingRemoteSdp){i.applyOfferAndSendAnswer(i.pendingRemoteSdp);i.pendingRemoteSdp=null}var t=(e=i.peerConnection)===null||e===void 0?void 0:e.getTransceivers().reduce((function(e,t){return t.mid===null?e:e+1}),0);var n=0;Object.values(i.call.localStreams).forEach((function(e){e===null||e===void 0?void 0:e.getTracks().forEach((function(e){if(e.readyState==="live"){n++}}))}));if(t<n){Object.values(i.call.peers).forEach((function(e){e.sendMedia()}))}}))}},{key:"setConnectionAnswer",value:function e(t,i,n){var a=this;if(!this.peerConnection||this.peerConnectionId!=t){this.log("Could not apply answer, for unknown connection "+t);return}if(this.peerConnection.signalingState!=="have-local-offer"){this.log("Could not apply answer, wrong peer connection signaling state "+this.peerConnection.signalingState);return}if(n){this.trackList=BX.util.array_flip(n)}var s=new RTCSessionDescription({type:"answer",sdp:i});clearTimeout(this.connectionOfferReplyTimeout);this.log("User: "+this.userId+"; Applying remote answer");this.peerConnection.setRemoteDescription(s).then((function(){a.applyPendingIceCandidates()}))["catch"]((function(e){a.failureReason=e.toString();a.updateCalculatedState();a.log(e)}))["finally"]((function(){a.call.setPublishingState(ge.Camera,false)}))}},{key:"addIceCandidate",value:function e(t,i){var n=this;if(!this.peerConnection){return}if(this.peerConnectionId!=t){this.log("Error: Candidate for unknown connection "+t);return}if(this.peerConnection.remoteDescription&&this.peerConnection.remoteDescription.type){this.peerConnection.addIceCandidate(i).then((function(){n.log("User: "+n.userId+"; Added remote ICE candidate: "+(i?i.candidate:i))}))["catch"]((function(e){n.log(e)}))}else{if(!this.pendingIceCandidates[t]){this.pendingIceCandidates[t]=[]}this.pendingIceCandidates[t].push(i)}}},{key:"applyPendingIceCandidates",value:function e(){var t=this;if(!this.peerConnection||!this.peerConnection.remoteDescription.type){return}if(p.Type.isArray(this.pendingIceCandidates[this.peerConnectionId])){this.pendingIceCandidates[this.peerConnectionId].forEach((function(e){t.peerConnection.addIceCandidate(e).then((function(){t.log("User: "+t.userId+"; Added remote ICE candidate: "+(e?e.candidate:e))}))}));this.pendingIceCandidates[this.peerConnectionId]=[]}}},{key:"onNegotiationNeeded",value:function e(){if(this.peerConnection){if(this.peerConnection.signalingState=="have-local-offer"){this.sendOffer()}else{this.createAndSendOffer({iceRestart:true})}}else{this.sendMedia()}}},{key:"reconnect",value:function e(t){var i;clearTimeout(this.reconnectAfterDisconnectTimeout);this.connectionAttempt++;var n=3;var a=(i=this.call.CallApi)!==null&&i!==void 0&&i.isConnected()?0:this.connectionAttempt;if(a>n){this.log("Error: Too many reconnection attempts, giving up");this.failureReason="Could not connect to user in time";this.updateCalculatedState();return}this.callbacks.onReconnecting(t);this.log("Trying to restore ICE connection. Attempt ".concat(this.connectionAttempt));if(this.isInitiator()){this._destroyPeerConnection();this.sendMedia()}else{this.sendNegotiationNeeded(true)}}},{key:"disconnect",value:function e(){this._destroyPeerConnection();this.outgoingVideoTrack=null;this.outgoingScreenTrack=null;this.outgoingVideoHoldState=false;this.incomingAudioTrack=null;this.incomingScreenAudioTrack=null;this.incomingVideoTrack=null;this.incomingScreenTrack=null}},{key:"log",value:function e(){this.call.log.apply(this.call,arguments)}},{key:"destroy",value:function e(){this.disconnect();if(this.voiceDetection){this.voiceDetection.destroy();this.voiceDetection=null}for(var t in this.localStreams){this.localStreams[t]=null}clearTimeout(this.answerTimeout);this.answerTimeout=null;clearTimeout(this.connectionTimeout);this.connectionTimeout=null;clearTimeout(this.signalingConnectionTimeout);this.signalingConnectionTimeout=null;this.callbacks.onStateChanged=BX.DoNothing;this.callbacks.onMediaReceived=BX.DoNothing;this.callbacks.onMediaStopped=BX.DoNothing}}]);return e}();function Po(){var e,t,i,n,a,s,r,o,l,c,u,d;if(!this.peerConnection){return}var h=(e=this.call.localStreams)===null||e===void 0?void 0:(t=e.main)===null||t===void 0?void 0:(i=t.getAudioTracks())===null||i===void 0?void 0:i[0];var p=(n=this.call.localStreams)===null||n===void 0?void 0:(a=n.main)===null||a===void 0?void 0:(s=a.getVideoTracks())===null||s===void 0?void 0:s[0];var v=(r=this.call.localStreams)===null||r===void 0?void 0:(o=r.screen)===null||o===void 0?void 0:(l=o.getVideoTracks())===null||l===void 0?void 0:l[0];var f=(c=this.call.localStreams)===null||c===void 0?void 0:(u=c.screen)===null||u===void 0?void 0:(d=u.getAudioTracks())===null||d===void 0?void 0:d[0];this.outgoingVideoTrack=p?p.clone():null;this.outgoingScreenTrack=v?v.clone():null;var m=[];if((h===null||h===void 0?void 0:h.readyState)==="live"){m.push("".concat(h.id," (audio)"))}if((f===null||f===void 0?void 0:f.readyState)==="live"){m.push("".concat(f.id," (sharingAudio)"))}if(p){m.push("".concat(p.id," (").concat(p.kind,")"))}if(v){m.push("".concat(v.id," (").concat(v.kind,")"))}console.log("User: ".concat(this.userId,"; Sending media streams. Tracks: ").concat(m.join("; ")));if(this.videoSender&&this.outgoingVideoTrack){this.outgoingVideoTrack.enabled=!this.call.useMediaServer;void this.videoSender.replaceTrack(this.outgoingVideoTrack)}else if(!this.videoSender&&this.outgoingVideoTrack){this.outgoingVideoTrack.enabled=!this.call.useMediaServer;this.videoSender=this.peerConnection.addTrack(this.outgoingVideoTrack)}else if(this.videoSender&&!this.outgoingVideoTrack){this.peerConnection.removeTrack(this.videoSender);this.videoSender=null}if(this.screenSender&&this.outgoingScreenTrack){this.outgoingScreenTrack.enabled=!this.call.useMediaServer;void this.screenSender.replaceTrack(this.outgoingScreenTrack)}else if(!this.screenSender&&this.outgoingScreenTrack){this.outgoingScreenTrack.enabled=!this.call.useMediaServer;this.screenSender=this.peerConnection.addTrack(this.outgoingScreenTrack)}else if(this.screenSender&&!this.outgoingScreenTrack){this.peerConnection.removeTrack(this.screenSender);this.screenSender=null}if(this.screenAudioSender&&f){f.enabled=!this.call.useMediaServer;void this.screenAudioSender.replaceTrack(f)}else if(!this.screenAudioSender&&f){f.enabled=!this.call.useMediaServer;this.screenAudioSender=this.peerConnection.addTrack(f)}else if(this.screenAudioSender&&!f){this.peerConnection.removeTrack(this.screenAudioSender);this.screenAudioSender=null}if(this.audioSender&&h){h.enabled=!H.isMicrophoneMuted&&!this.call.useMediaServer;void this.audioSender.replaceTrack(h)}else if(!this.audioSender&&h){h.enabled=!H.isMicrophoneMuted&&!this.call.useMediaServer;this.audioSender=this.peerConnection.addTrack(h)}else if(this.audioSender&&!h){this.peerConnection.removeTrack(this.audioSender);this.audioSender=null}}function _o(){if(H.isCameraOn&&!this.call.CallApi.isVideoPublished()){void this.call.CallApi.enableVideo({calledFrom:"updateOutgoingTracks"})}else if(!this.call.useMediaServer||!H.isCameraOn){void this.call.CallApi.disableVideo({calledFrom:"updateOutgoingTracks"})}if(!H.isMicrophoneMuted&&!this.call.CallApi.isAudioPublished()){void this.call.CallApi.enableAudio({calledFrom:"updateOutgoingTracks"})}else if(!this.call.useMediaServer||H.isMicrophoneMuted){void this.call.CallApi.disableAudio({calledFrom:"updateOutgoingTracks"})}if(this.call.isScreenSharingStarted()&&this.call.useMediaServer&&!this.call.CallApi.isScreenPublished()){void this.call.CallApi.startScreenShare()}else if(!this.call.useMediaServer||!this.call.isScreenSharingStarted()){void this.call.CallApi.stopScreenShare()}}function Eo(e){var t;this.log("User ".concat(this.userId,": Creating peer connection"));var i=((t=this.call.CallApi)===null||t===void 0?void 0:t.iceServers)||this.call.iceServers;var n={iceServers:i};this.localIceCandidates=[];this.peerConnection=new RTCPeerConnection(n);this.peerConnectionId=e;this.peerConnection.addEventListener("icecandidate",this._onPeerConnectionIceCandidateHandler);this.peerConnection.addEventListener("connectionstatechange",this._onPeerConnectionConnectionStateChangeHandler);this.peerConnection.addEventListener("icegatheringstatechange",this._onPeerConnectionIceGatheringStateChangeHandler);this.peerConnection.addEventListener("signalingstatechange",this._onPeerConnectionSignalingStateChangeHandler);this.peerConnection.addEventListener("track",this._onPeerConnectionTrackHandler);this.peerConnection.addEventListener("removestream",this._onPeerConnectionRemoveStreamHandler);this.failureReason="";this.hasStun=false;this.hasTurn=false;this.updateCalculatedState();this.startStatisticsGathering()}function Ro(){this.log("User "+this.userId+": peer connection state changed. New state: "+this.peerConnection.connectionState);if(this.peerConnection.connectionState==="connected"||this.peerConnection.connectionState==="completed"){this.connectionAttempt=0;this.callbacks.onReconnected();clearTimeout(this.reconnectAfterDisconnectTimeout);this._updateTracksDebounced()}else if(this.peerConnection.connectionState==="failed"){var e="Peer connection failed. Trying to restore connection immediately";this.log(e);this.reconnect({reconnectionReason:"PEER_CONNECTION_FAILED",reconnectionReasonInfo:e})}this.updateCalculatedState()}function Mo(e){var t=e.target;this.log("User "+this.userId+": ICE gathering state changed to : "+t.iceGatheringState);if(t.iceGatheringState==="complete"){this.log("User "+this.userId+": ICE gathering complete");if(!this.hasStun||!this.hasTurn){var i=[];if(!this.hasTurn){i.push("TURN")}if(!this.hasStun){i.push("STUN")}this.log("Connectivity problem detected: no ICE candidates from "+i.join(" and ")+" servers");console.error("Connectivity problem detected: no ICE candidates from "+i.join(" and ")+" servers");this.callbacks.onNetworkProblem()}if(!this.hasTurn&&!this.hasStun);if(!this.getSignaling().isIceTricklingAllowed()){if(this.localIceCandidates.length>0){this.getSignaling().sendIceCandidate({userId:this.userId,connectionId:this.peerConnectionId,candidates:this.localIceCandidates});this.localIceCandidates=[]}else{this.log("User "+this.userId+": ICE candidates already sent")}}}}function Ao(){this.log("User "+this.userId+" PC signalingState: "+this.peerConnection.signalingState);if(this.peerConnection.signalingState==="stable"){this._updateTracksDebounced()}}function Lo(e){if(this.call.useMediaServer){return}bs(this,bo,Bo).call(this,e)}function Bo(e){this.log("User ".concat(this.userId,": media track received: ").concat(e.track.id," (").concat(e.track.kind,")"));if(e.track.kind==="video"){var t;p.Event.bind(e.track,"mute",bs(this,ko,Ho).bind(this));p.Event.bind(e.track,"unmute",bs(this,yo,No).bind(this));p.Event.bind(e.track,"ended",bs(this,So,xo).bind(this));var i=this.call.useMediaServer?e.track.source===ge.Screen:this.trackList[(t=e.transceiver)===null||t===void 0?void 0:t.mid]==="screen";if(i){this.incomingScreenTrack=e.track}else{this.incomingVideoTrack=e.track}}else if(e.track.kind==="audio"){var n;var a=this.call.useMediaServer?e.track.source===ge.ScreenAudio:this.trackList[(n=e.transceiver)===null||n===void 0?void 0:n.mid]==="screenAudio";if(a){this.incomingScreenAudioTrack=e.track}else{this.incomingAudioTrack=e.track}}}function Do(e){this.log("User: "+this.userId+"_onPeerConnectionRemoveStream: ",e)}function Ho(){console.log("Video track muted")}function No(){console.log("Video track unmuted")}function xo(){console.log("Video track ended")}function Oo(){var e=this;if(!this.peerConnection||this.call.useMediaServer){return null}var t=null;var i=null;var n=null;var a=null;this.peerConnection.getTransceivers().forEach((function(s){e.call.log("[debug] tr direction: "+s.direction+" currentDirection: "+s.currentDirection);if(s.currentDirection==="sendrecv"||s.currentDirection==="recvonly"){if(s.receiver&&s.receiver.track){var r=s.receiver.track;if(r.kind==="audio"){if(e.trackList[s.mid]==="sharingAudio"){a=r}else{t=r}}else if(r.kind==="video"){if(e.trackList[s.mid]==="screen"){n=r}else{i=r}}}}}));this.incomingAudioTrack=t;this.incomingVideoTrack=i;this.incomingScreenTrack=n;this.incomingScreenAudioTrack=a}function Uo(){this.setSignalingConnected(false)}function Fo(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function Vo(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?Fo(Object(i),!0).forEach((function(t){babelHelpers.defineProperty(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):Fo(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}function Go(e,t){Xo(e,t);t.add(e)}function Wo(e,t,i){Xo(e,t);t.set(e,i)}function Xo(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}function zo(e,t,i){if(!t.has(e)){throw new TypeError("attempted to get private field on non-instance")}return i}var jo={invite:"call.Call.invite",decline:"call.Call.decline"};var qo={voiceStarted:"Call::voiceStarted",voiceStopped:"Call::voiceStopped",microphoneState:"Call::microphoneState",cameraState:"Call::cameraState",videoPaused:"Call::videoPaused",screenState:"Call::screenState",commonRecordState:"Call::commonRecordState",emotion:"Call::emotion",customMessage:"Call::customMessage",usersInvited:"Call::usersInvited",userInviteTimeout:"Call::userInviteTimeout",showUsers:"Call::showUsers",showAll:"Call::showAll",hideAll:"Call::hideAll"};var Yo={viewerJoined:"Call::viewerJoined",viewerLeft:"Call::viewerLeft"};var Qo={onCallConference:"BitrixCall::onCallConference"};var Jo=3e4;var Ko=5500;var Zo=new WeakMap;var $o=new WeakMap;var el=new WeakMap;var tl=new WeakMap;var il=new WeakMap;var nl=new WeakSet;var al=new WeakSet;var sl=new WeakSet;var rl=new WeakMap;var ol=new WeakMap;var ll=new WeakSet;var cl=new WeakMap;var ul=new WeakMap;var dl=new WeakMap;var hl=new WeakMap;var pl=new WeakMap;var vl=new WeakMap;var fl=new WeakMap;var ml=new WeakMap;var gl=new WeakMap;var bl=new WeakMap;var Cl=new WeakMap;var kl=new WeakMap;var yl=new WeakMap;var Sl=new WeakMap;var wl=new WeakMap;var Il=new WeakMap;var Tl=new WeakMap;var Pl=new WeakMap;var _l=new WeakMap;var El=new WeakMap;var Rl=new WeakMap;var Ml=new WeakMap;var Al=new WeakMap;var Ll=new WeakMap;var Bl=new WeakMap;var Dl=new WeakMap;var Hl=new WeakMap;var Nl=new WeakMap;var xl=new WeakMap;var Ol=new WeakMap;var Ul=new WeakMap;var Fl=new WeakMap;var Vl=new WeakMap;var Gl=new WeakMap;var Wl=new WeakMap;var Xl=new WeakMap;var zl=new WeakMap;var jl=new WeakMap;var ql=new WeakMap;var Yl=new WeakMap;var Ql=new WeakMap;var Jl=new WeakMap;var Kl=new WeakMap;var Zl=new WeakMap;var $l=new WeakMap;var ec=function(e){babelHelpers.inherits(t,e);function t(e){var i;babelHelpers.classCallCheck(this,t);i=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this,e));Go(babelHelpers.assertThisInitialized(i),ll);Go(babelHelpers.assertThisInitialized(i),sl);Go(babelHelpers.assertThisInitialized(i),al);Go(babelHelpers.assertThisInitialized(i),nl);Wo(babelHelpers.assertThisInitialized(i),Zo,{writable:true,value:void 0});Wo(babelHelpers.assertThisInitialized(i),$o,{writable:true,value:void 0});Wo(babelHelpers.assertThisInitialized(i),el,{writable:true,value:void 0});Wo(babelHelpers.assertThisInitialized(i),tl,{writable:true,value:void 0});Wo(babelHelpers.assertThisInitialized(i),il,{writable:true,value:void 0});babelHelpers.defineProperty(babelHelpers.assertThisInitialized(i),"setMuted",(function(e){if(i.muted===e.data.isMicrophoneMuted){return}i.muted=e.data.isMicrophoneMuted;if(i.BitrixCall){if(!e.data.calledProgrammatically&&i.muted){i.signaling.sendMicrophoneState(!i.muted)}if(i.muted){i.BitrixCall.disableAudio({calledFrom:"setMuted"})}else{if(!i.BitrixCall.isAudioPublished()){zo(babelHelpers.assertThisInitialized(i),nl,tc).call(babelHelpers.assertThisInitialized(i),ge.Microphone,true)}i.BitrixCall.enableAudio({calledFrom:"setMuted"})}}}));babelHelpers.defineProperty(babelHelpers.assertThisInitialized(i),"setVideoEnabled",(function(e){if(i.videoEnabled===e.data.isCameraOn){return}i.videoEnabled=e.data.isCameraOn;if(i.BitrixCall){if(!e.data.calledProgrammatically){i.signaling.sendCameraState(i.videoEnabled)}if(i.videoEnabled){if(!i.BitrixCall.isVideoPublished()){zo(babelHelpers.assertThisInitialized(i),nl,tc).call(babelHelpers.assertThisInitialized(i),ge.Camera,true)}i.localVideoShown=true;i.BitrixCall.enableVideo({calledFrom:"setVideoEnabled"})}else{if(i.localVideoShown){i.localVideoShown=false;i.BitrixCall.disableVideo({calledFrom:"setVideoEnabled"})}}}}));Wo(babelHelpers.assertThisInitialized(i),rl,{writable:true,value:function e(t){i.runCallback(Ac.onUserStateChanged,t);if(!i.ready){return}if(t.state===yc.Failed||t.state===yc.Unavailable||t.state===yc.Declined||t.state===yc.Idle){if(i.type==wc.Instant&&!i.isAnyoneParticipating());}}});Wo(babelHelpers.assertThisInitialized(i),ol,{writable:true,value:function e(t){if(!i.ready){return}i.signaling.sendUserInviteTimeout({userId:i.users,failedUserId:t.userId})}});Wo(babelHelpers.assertThisInitialized(i),cl,{writable:true,value:function e(t){var n=Number(t.senderId);if(n==i.userId){return i.__onPullEventAnswerSelf(t)}}});Wo(babelHelpers.assertThisInitialized(i),ul,{writable:true,value:function e(t){var n=t.senderId;var a=t.callInstanceId;var s=i.peers[n];if(i.userId===n&&a&&i.instanceId!==a){i.runCallback(Ac.onLeave,{local:false});return}if(t.code===603&&((s===null||s===void 0?void 0:s.calculatedState)===yc.Connected||(s===null||s===void 0?void 0:s.calculatedState)===yc.Connecting)){return}if(t.code===603&&i.userId!==n){i.runCallback(Ac.onUserStateChanged,{userId:n,callId:t.callId,state:yc.Declined})}if(!s||s.participant&&!a){return}Yf.sendLog({params:t,description:"GOT A #onPullEventHangup from user",pullEvent:"#onPullEventHangup"});if(!s.participant){if(t.code==486){s.setBusy(true);console.warn("user ".concat(n," is busy"))}if(i.ready&&i.type===wc.Instant&&!i.isAnyoneParticipating()){i.hangup()}}}});Wo(babelHelpers.assertThisInitialized(i),dl,{writable:true,value:function e(){i.destroy()}});Wo(babelHelpers.assertThisInitialized(i),hl,{writable:true,value:function e(t){i.runCallback(Ac.onSwitchTrackRecordStatus,{isTrackRecordOn:t.isTrackRecordOn,errorCode:t.errorCode})}});Wo(babelHelpers.assertThisInitialized(i),pl,{writable:true,value:function e(t){var n=Yf.MediaKind[t];if(!n){i.log("Wrong kind for local mediaRenderer: ".concat(t));return}i.log("__onLocalMediaRendererAdded",n);var a=Sn.isNotSupportDevicesListBeforeStream;var s=null;var r=null;switch(t){case ge.Camera:if(!i.videoEnabled){return}s=ae.getLocalStream(t);r=new yn({kind:n,track:s});i.runCallback(Ac.onLocalMediaReceived,{mediaRenderer:r,tag:"main",stream:r.stream});if(a){i.runCallback(Ac.onGetUserMediaEnded,{})}break;case ge.Screen:i.log("Screen shared");i.screenShared=true;i.waitingLocalScreenShare=false;s=ae.getLocalStream(t);r=new yn({kind:n,track:s});i.runCallback(Ac.onLocalMediaReceived,{mediaRenderer:r,tag:"screen",stream:r.stream});break;case ge.Microphone:i.signaling.sendMicrophoneState(true);zo(babelHelpers.assertThisInitialized(i),nl,tc).call(babelHelpers.assertThisInitialized(i),t,false);s=ae.getLocalStream(t);babelHelpers.classPrivateFieldGet(babelHelpers.assertThisInitialized(i),El).call(babelHelpers.assertThisInitialized(i),{result:true,stream:new MediaStream([s])});if(a){i.runCallback(Ac.onGetUserMediaEnded,{})}if(H.isMicrophoneMuted){var o;(o=i.BitrixCall)===null||o===void 0?void 0:o.disableAudio({calledFrom:"onLocalMediaRendererAdded"})}break;default:}}});Wo(babelHelpers.assertThisInitialized(i),vl,{writable:true,value:function e(t,n){if(t===ge.Microphone){zo(babelHelpers.assertThisInitialized(i),nl,tc).call(babelHelpers.assertThisInitialized(i),ge.Microphone,false);i.signaling.sendMicrophoneState(!n)}else if(t===ge.Camera){zo(babelHelpers.assertThisInitialized(i),nl,tc).call(babelHelpers.assertThisInitialized(i),ge.Camera,false)}}});Wo(babelHelpers.assertThisInitialized(i),fl,{writable:true,value:function e(t){var n=t?false:!H.isMicrophoneMuted;var a=t?false:H.isCameraOn;i.signaling.sendMicrophoneState(n);i.signaling.sendCameraState(a)}});Wo(babelHelpers.assertThisInitialized(i),ml,{writable:true,value:function e(t,n){var a=Yf.MediaKind[t];if(!a){i.log("Wrong kind for mediaRenderer: ".concat(t));return}if(!i.BitrixCall){return}switch(t){case ge.Camera:case ge.Microphone:if(!n){babelHelpers.classPrivateFieldGet(babelHelpers.assertThisInitialized(i),kl).call(babelHelpers.assertThisInitialized(i),t)}break;case ge.Screen:babelHelpers.classPrivateFieldGet(babelHelpers.assertThisInitialized(i),kl).call(babelHelpers.assertThisInitialized(i),t);break}}});Wo(babelHelpers.assertThisInitialized(i),gl,{writable:true,value:function e(t){i.getUserMediaFulfilled=false;if(t.video){i.signaling.sendCameraState(false)}if(t.audio){i.signaling.sendMicrophoneState(false)}}});Wo(babelHelpers.assertThisInitialized(i),bl,{writable:true,value:function e(t){if(t.video){i.signaling.sendCameraState(true)}}});Wo(babelHelpers.assertThisInitialized(i),Cl,{writable:true,value:function e(){i.getUserMediaFulfilled=true}});Wo(babelHelpers.assertThisInitialized(i),kl,{writable:true,value:function e(t){var n=Yf.MediaKind[t];if(!n){i.log("Wrong kind for mediaRenderer: ".concat(t));return}if(!i.BitrixCall){return}i.log("__onBeforeLocalMediaRendererRemoved",n);var a=new yn({kind:n});switch(t){case ge.Camera:i.runCallback(Ac.onLocalMediaReceived,{mediaRenderer:a,tag:"main",stream:new MediaStream,removed:true});break;case ge.Microphone:i.runCallback(Ac.onLocalMediaStopped,{kind:n});zo(babelHelpers.assertThisInitialized(i),nl,tc).call(babelHelpers.assertThisInitialized(i),ge.Microphone,false);i.signaling.sendMicrophoneState(false);break;case ge.Screen:i.BitrixCall.stopScreenShare();i.log("Screen is no longer shared");i.runCallback(Ac.onUserScreenState,{userId:i.userId,screenState:false});i.screenShared=false;i.waitingLocalScreenShare=false;i.runCallback(Ac.onLocalMediaReceived,{mediaRenderer:a,tag:"screen",stream:new MediaStream,removed:true});break}}});Wo(babelHelpers.assertThisInitialized(i),yl,{writable:true,value:function e(t,n){if(t&&n){var a=Yf.MediaKind[n.source];if(!a){i.log("Wrong kind for mediaRenderer: ".concat(n.source));return}var s={mediaRenderer:new yn({kind:a,track:n.track})};var r=i.peers[t.userId];if(r){if(!r.participant){r.participant=t;r.updateCalculatedState()}r.addMediaRenderer(s.mediaRenderer)}switch(n.source){case ge.Camera:i.runCallback(Ac.onUserCameraState,{userId:t.userId,cameraState:!t.isMutedVideo});break;case ge.Microphone:i.runCallback(Ac.onUserMicrophoneState,{userId:t.userId,microphoneState:!t.isMutedAudio});break}console.log("[RemoteMediaAdded]: UserId: ".concat(t.userId,", source: ").concat(Yf.MediaKind[n.source]));var o=n.source===ge.Camera?", cameraState: ".concat(!(t!==null&&t!==void 0&&t.isMutedVideo)):"";Yf.sendLog({description:"[RemoteMediaAdded]: UserId: ".concat(t.userId,", source: ").concat(Yf.MediaKind[n.source]).concat(o)})}}});Wo(babelHelpers.assertThisInitialized(i),Sl,{writable:true,value:function e(t,n){if(t&&n){var a=Yf.MediaKind[n.source];if(!a){i.log("Wrong kind for mediaRenderer: ".concat(n.source));return}var s={mediaRenderer:new yn({kind:a,track:n.track})};var r=i.peers[t.userId];if(r){r.removeMediaRenderer(s.mediaRenderer)}if(n.source===ge.Camera){i.runCallback(Ac.onUserCameraState,{userId:t.userId,cameraState:false})}console.log("[RemoteMediaRemoved]: UserId: ".concat(t.userId,", source: ").concat(Yf.MediaKind[n.source]));var o=n.source===ge.Camera?", cameraState: false":"";Yf.sendLog({description:"[RemoteMediaRemoved]: UserId: ".concat(t.userId,", source: ").concat(Yf.MediaKind[n.source]).concat(o)})}}});Wo(babelHelpers.assertThisInitialized(i),wl,{writable:true,value:function e(t,n){if(n.source===ge.Microphone){i.runCallback(Ac.onUserMicrophoneState,{userId:t.userId,microphoneState:!t.isMutedAudio})}}});Wo(babelHelpers.assertThisInitialized(i),Il,{writable:true,value:function e(t){i.log("__onUsersInvited",t);var n=t.users;var a=t.show;if(i.type===wc.Instant){i.addInvitedUsers(n,a)}}});Wo(babelHelpers.assertThisInitialized(i),Tl,{writable:true,value:function e(t){i.log("__onUserInviteTimeout",t);var n=t.failedUserId;if(i.peers[n]){i.peers[n].onInviteTimeout(false)}}});Wo(babelHelpers.assertThisInitialized(i),Pl,{writable:true,value:function e(t){clearTimeout(i.waitForAnswerTimeout);var n=i.peers[t.userId];if(!n){var a=parseInt(t.userId,10);if(!i.users.includes(a)){i.users.push(a)}n=i.createPeer(a);i.peers[a]=n}i.runCallback(Ac.onUserJoined,{userId:t.userId,userData:babelHelpers.defineProperty({},t.userId,{name:t.name,avatar_hr:t.image,avatar:t.image,gender:t.gender})});if(!t.audioEnabled||t.isMutedAudio){i.runCallback(Ac.onUserMicrophoneState,{userId:t.userId,microphoneState:false})}if(!t.videoEnabled||t.isMutedVideo){i.runCallback(Ac.onUserCameraState,{userId:t.userId,cameraState:false})}if(t.isHandRaised){i.runCallback(Ac.onUserFloorRequest,{userId:t.userId,requestActive:t.isHandRaised})}n.participant=t;n.setReady(true);if(i.commonRecordState.state!==Di.Stopped&&i.commonRecordState.userId===i.userId){i.signaling.sendLocalRecordState(i.userId,i.commonRecordState)}}});Wo(babelHelpers.assertThisInitialized(i),_l,{writable:true,value:function e(t){var n=i.peers[t.userId];if(n){for(var a in ge){var s=ge[a];var r=Yf.MediaKind[s];var o={mediaRenderer:new yn({kind:r})};n.removeMediaRenderer(o.mediaRenderer)}n.participant=null;n.setReady(false)}}});Wo(babelHelpers.assertThisInitialized(i),El,{writable:true,value:function e(t){if(t.result){if(t.stream.getAudioTracks().length>0){if(i.localVAD){i.localVAD.destroy()}i.localVAD=new ds({mediaStream:t.stream,onVoiceStarted:function e(){if(!H.isMicrophoneMuted){i.requestFloor(false)}babelHelpers.classPrivateFieldGet(babelHelpers.assertThisInitialized(i),Jl).call(babelHelpers.assertThisInitialized(i),{userId:i.userId})},onVoiceStopped:function e(){babelHelpers.classPrivateFieldGet(babelHelpers.assertThisInitialized(i),Kl).call(babelHelpers.assertThisInitialized(i),{userId:i.userId})}});clearInterval(i.microphoneLevelInterval);i.microphoneLevelInterval=setInterval((function(){return i.microphoneLevel=i.localVAD.currentVolume}),200)}}}});Wo(babelHelpers.assertThisInitialized(i),Rl,{writable:true,value:function e(t){if(i._reconnectionEventCount===0){t.reconnectionEventCount=i.reconnectionEventCount+1;i.runCallback(Ac.onReconnecting,t)}if(i.reconnectionEventCount++){return}for(var n in i.peers){if(n!==i.userId&&i.peers.hasOwnProperty(n)&&i.peers[n].calculatedState===yc.Connected){for(var a in ge){var s=ge[a];var r=Yf.MediaKind[s];var o={mediaRenderer:new yn({kind:r})};i.peers[n].removeMediaRenderer(o.mediaRenderer)}}}}});Wo(babelHelpers.assertThisInitialized(i),Ml,{writable:true,value:function e(){i.reconnectionEventCount=0;i.log("Call reconnected");i.sendTelemetryEvent("reconnect");i.localUserState=yc.Connected;if(!i.BitrixCall.isAudioPublished()){zo(babelHelpers.assertThisInitialized(i),nl,tc).call(babelHelpers.assertThisInitialized(i),ge.Microphone,true)}i.BitrixCall.enableAudio({calledFrom:"onCallConnected",disabled:H.isMicrophoneMuted});if(H.isCameraOn){if(!i.BitrixCall.isVideoPublished()){zo(babelHelpers.assertThisInitialized(i),nl,tc).call(babelHelpers.assertThisInitialized(i),ge.Camera,true)}i.BitrixCall.enableVideo({calledFrom:"onCallReconnected"})}if(i.screenShared||i.waitingLocalScreenShare){i.BitrixCall.startScreenShare()}if(i.videoAllowedFrom==Mc.none){i.signaling.sendHideAll()}else if(p.Type.isArray(i.videoAllowedFrom)){i.signaling.sendShowUsers(i.videoAllowedFrom)}if(i.commonRecordState.userId===i.userId){i.sendLocalRecordState({action:i.commonRecordState.state,userId:i.userId},true)}i.BitrixCall.raiseHand(i.floorRequestActive)}});Wo(babelHelpers.assertThisInitialized(i),Al,{writable:true,value:function e(t,n){i.runCallback(Ac.onReconnectingFailed,{error:n})}});Wo(babelHelpers.assertThisInitialized(i),Ll,{writable:true,value:function e(t){var n={};var a=t&&babelHelpers["typeof"](t)==="object"?t:{};var s=a.headers,r=a.leaveInformation;if(s){n=Vo(Vo({},n),{},{headers:s})}if(r){n=Vo(Vo({},n),{},{leaveInformation:r})}i.log("__onCallDisconnected",Object.keys(n).length?n:null);if(i.ready&&(r===null||r===void 0?void 0:r.reason)!==Rc.SecurityKeyChanged){i.hangup(r===null||r===void 0?void 0:r.code,r===null||r===void 0?void 0:r.reason)}i.sendTelemetryEvent("disconnect");i.localUserState=yc.Idle;i.ready=false;i.joinedAsViewer=false;i.reinitPeers();i.localVideoShown=false;i.removeCallEvents();i.unsubscribeHardwareChanges();i.state=kc.Proceeding;if((r===null||r===void 0?void 0:r.reason)===Rc.SecurityKeyChanged){babelHelpers.classPrivateFieldGet(babelHelpers.assertThisInitialized(i),Bl).call(babelHelpers.assertThisInitialized(i),r.reason);return}if((r===null||r===void 0?void 0:r.reason)===Rc.RoomClosed){i.destroy();return}i.runCallback(Ac.onLeave,{local:true})}});Wo(babelHelpers.assertThisInitialized(i),Bl,{writable:true,value:function e(t){if(t&&t.call){delete t.call}i.log("onFatalError",t);i.ready=false;i.localUserState=yc.Failed;i.reinitPeers();i.localVideoShown=false;if(i.BitrixCall){i.removeCallEvents();i.unsubscribeHardwareChanges();try{i.BitrixCall.hangup({"X-Reason":"Fatal error","X-Error":typeof t==="string"?t:t.code||t.name})}catch(e){i.log("Bitrix hangup error: ",e);console.error("Bitrix hangup error: ",e)}i.BitrixCall=null}if(typeof t==="string"){i.runCallback(Ac.onCallFailure,{name:t})}else if(t.name){i.runCallback(Ac.onCallFailure,t)}}});Wo(babelHelpers.assertThisInitialized(i),Dl,{writable:true,value:function e(t){i.runCallback(Ac.onTrackSubscriptionFailed,t)}});Wo(babelHelpers.assertThisInitialized(i),Hl,{writable:true,value:function e(t){var n={};var a={f:2,h:1,q:0};t.sender.forEach((function(e){if(e.userId&&(e.kind==="video"||e.kind==="audio")){if(!n[e.userId]){n[e.userId]={}}if(e.kind==="video"){if(!n[e.userId][e.source]){n[e.userId][e.source]=[]}var t=a[e.rid]||0;n[e.userId][e.source][t]=e}else if(e.kind==="audio"){n[e.userId][e.source]=e}}}));t.recipient.forEach((function(e){if(e.userId&&(e.kind==="video"||e.kind==="audio")){if(!n[e.userId]){n[e.userId]={}}n[e.userId][e.source]=e}}));for(var s in n){i.runCallback(Ac.onUserStatsReceived,{userId:s,report:n[s]})}}});Wo(babelHelpers.assertThisInitialized(i),Nl,{writable:true,value:function e(t){var n=new Set(babelHelpers.toConsumableArray(i.peersWithBadConnection.values()));t.forEach((function(e){var t=i.peers[e];if(t){if(!n.has(e)){i.peersWithBadConnection.add(e)}else{n["delete"](e)}}}))}});Wo(babelHelpers.assertThisInitialized(i),xl,{writable:true,value:function e(t){Object.keys(t).forEach((function(e){i.runCallback(Ac.onConnectionQualityChanged,{userId:Number(e),score:t[e]})}))}});Wo(babelHelpers.assertThisInitialized(i),Ol,{writable:true,value:function e(t){i.runCallback(Ac.onToggleRemoteParticipantVideo,{isVideoShown:t})}});Wo(babelHelpers.assertThisInitialized(i),Ul,{writable:true,value:function e(t){var n;var a;try{n=JSON.parse(t.text)}catch(e){i.log("Could not parse scenario message.",e);return}var s=n.eventName;if(s===qo.cameraState){i.runCallback(Ac.onUserCameraState,{userId:n.senderId,cameraState:n.cameraState==="Y"})}else if(s===qo.videoPaused){if(n.senderId===i.userId){return}i.runCallback(Ac.onUserVideoPaused,{userId:n.senderId,videoPaused:n.videoPaused==="Y"})}else if(s===qo.screenState){i.runCallback(Ac.onUserScreenState,{userId:n.senderId,screenState:n.screenState==="Y"})}else if(s===qo.commonRecordState){i.runCallback(Ac.onUserCommonRecordState,{userId:n.senderId,commonRecordState:n.commonRecordState})}else if(s===qo.emotion){i.runCallback(Ac.onUserEmotion,{userId:n.senderId,toUserId:n.toUserId,emotion:n.emotion})}else if(s===qo.usersInvited){babelHelpers.classPrivateFieldGet(babelHelpers.assertThisInitialized(i),Il).call(babelHelpers.assertThisInitialized(i),n)}else if(s===qo.userInviteTimeout){babelHelpers.classPrivateFieldGet(babelHelpers.assertThisInitialized(i),Tl).call(babelHelpers.assertThisInitialized(i),n)}else if(s===qo.customMessage){i.runCallback(Ac.onCustomMessage,{message:n.message})}else if(s===Yo.viewerJoined){console.log("viewer "+n.senderId+" joined");a=i.peers[n.senderId];if(a){a.setDirection(Sc.RecvOnly);a.setReady(true)}}else if(s===Yo.viewerLeft){console.log("viewer "+n.senderId+" left");a=i.peers[n.senderId];if(a){a.setReady(false)}}else if(s===qo.microphoneState);else{i.log("Unknown scenario event "+s)}}});Wo(babelHelpers.assertThisInitialized(i),Fl,{writable:true,value:function e(t){i.runCallback(Ac.onUserFloorRequest,{userId:t.userId,requestActive:t.isHandRaised})}});Wo(babelHelpers.assertThisInitialized(i),Vl,{writable:true,value:function e(t){i.runCallback(Ac.onAllParticipantsAudioMuted,{userId:t.fromUserId,reason:t.reason})}});Wo(babelHelpers.assertThisInitialized(i),Gl,{writable:true,value:function e(t){i.runCallback(Ac.onTurnOnCamera)}});Wo(babelHelpers.assertThisInitialized(i),Wl,{writable:true,value:function e(t){i.runCallback(Ac.onAllParticipantsVideoMuted,{userId:t.fromUserId,reason:t.reason})}});Wo(babelHelpers.assertThisInitialized(i),Xl,{writable:true,value:function e(t){i.runCallback(Ac.onAllParticipantsScreenshareMuted,{userId:t.fromUserId,reason:t.reason})}});Wo(babelHelpers.assertThisInitialized(i),zl,{writable:true,value:function e(t){i.runCallback(Ac.onYouMuteAllParticipants,{data:t})}});Wo(babelHelpers.assertThisInitialized(i),jl,{writable:true,value:function e(t){i.runCallback(Ac.onRoomSettingsChanged,{data:t})}});Wo(babelHelpers.assertThisInitialized(i),ql,{writable:true,value:function e(t){i.runCallback(Ac.onUserPermissionsChanged,{data:t})}});Wo(babelHelpers.assertThisInitialized(i),Yl,{writable:true,value:function e(t){i.runCallback(Ac.onUserRoleChanged,{data:t})}});Wo(babelHelpers.assertThisInitialized(i),Ql,{writable:true,value:function e(t){i.runCallback(Ac.onParticipantMuted,{data:t})}});Wo(babelHelpers.assertThisInitialized(i),Jl,{writable:true,value:function e(t){if(t.userId===i.userId){i.runCallback(Ac.onUserVoiceStarted,{userId:t.userId,local:true});if(H.isMicrophoneMuted){return}}i.runCallback(Ac.onUserVoiceStarted,{userId:t.userId})}});Wo(babelHelpers.assertThisInitialized(i),Kl,{writable:true,value:function e(t){i.runCallback(Ac.onUserVoiceStopped,{userId:t.userId})}});Wo(babelHelpers.assertThisInitialized(i),Zl,{writable:true,value:function e(t){var n=t.code,a=t.errMsg;var s=[Pe.DESTROYED,Pe.UNAVAILABLE].includes(n);var r=s?"":a;babelHelpers.classPrivateFieldSet(babelHelpers.assertThisInitialized(i),el,r?babelHelpers.classPrivateFieldGet(babelHelpers.assertThisInitialized(i),el):n);var o=babelHelpers.classPrivateFieldGet(babelHelpers.assertThisInitialized(i),el)===Pe.ENABLED;babelHelpers.classPrivateFieldSet(babelHelpers.assertThisInitialized(i),tl,true);i.runCallback(Ac.onRecorderStatusChanged,{code:n,error:r,isCopilotActive:o})}});Wo(babelHelpers.assertThisInitialized(i),$l,{writable:true,value:function e(t){var n;if(Yf.isCloudRecordLogEnabled()){console.warn("CloudRecord: videoRecorderStatus",t)}var a=t.code,s=t.errMsg,r=t.initiatorUserID,o=t.userID,l=t.kind,c=t.date,u=t.justJoined;var d=Number(o);var h=Number(r);var p=((n=c.pauses)!==null&&n!==void 0?n:[]).map((function(e){var t=e.start,i=e.end;return{start:new Date(t),finish:i?new Date(i):null}}));var v=l===1?Hi.Audio:Hi.Video;babelHelpers.classPrivateFieldSet(babelHelpers.assertThisInitialized(i),$o,s?babelHelpers.classPrivateFieldGet(babelHelpers.assertThisInitialized(i),$o):a);if(s){if(Yf.isCloudRecordLogEnabled()){console.error("CloudRecord: videoRecorderStatus errMsg",s)}i.runCallback(Ac.onCloudRecordStatusChanged,{code:_e.STOPPED,userId:d,initiatorId:h,justJoined:u,commonRecordState:Vo({},i.commonRecordState)})}else{switch(a){case _e.STARTED:case _e.PAUSED:{i.commonRecordState.state=a===_e.STARTED?Di.Started:Di.Paused;i.commonRecordState.type=v;i.commonRecordState.userId=h;i.commonRecordState.date.start=new Date(c.start);i.commonRecordState.date.pause=p;break}case _e.STOPPED:case _e.DESTROYED:{i.commonRecordState.state=a===_e.STOPPED?Di.Stopped:Di.Destroyed;i.commonRecordState.type=Hi.None;i.commonRecordState.userId=0;i.commonRecordState.date.start=null;i.commonRecordState.date.pause=[];break}default:{if(Yf.isCloudRecordLogEnabled()){console.error("Unknown record status: ".concat(t))}break}}i.runCallback(Ac.onCloudRecordStatusChanged,{code:a,userId:d,initiatorId:h,justJoined:u,commonRecordState:Vo({},i.commonRecordState)})}}});i.videoQuality=_c.VeryHigh;i.BitrixCall=null;i.signaling=new oc({call:babelHelpers.assertThisInitialized(i)});i.peers={};i.peersWithBadConnection=new Set;i.joinedAsViewer=false;i.localVideoShown=false;i._localUserState=yc.Idle;i.clientEventsBound=false;i._screenShared=false;i.videoAllowedFrom=Mc.all;i.direction=Sc.SendRecv;i.floorRequestActive=false;i.microphoneLevelInterval=null;i.initPeers();i.reinviteTimeout=null;i._reconnectionEventCount=0;i.waitForAnswerTimeout=null;i.pullEventHandlers={"Call::answer":babelHelpers.classPrivateFieldGet(babelHelpers.assertThisInitialized(i),cl),"Call::hangup":babelHelpers.classPrivateFieldGet(babelHelpers.assertThisInitialized(i),ul),"Call::finish":babelHelpers.classPrivateFieldGet(babelHelpers.assertThisInitialized(i),dl),"Call::switchTrackRecordStatus":babelHelpers.classPrivateFieldGet(babelHelpers.assertThisInitialized(i),hl)};babelHelpers.classPrivateFieldSet(babelHelpers.assertThisInitialized(i),Zo,true);babelHelpers.classPrivateFieldSet(babelHelpers.assertThisInitialized(i),el,Pe.UNAVAILABLE);babelHelpers.classPrivateFieldSet(babelHelpers.assertThisInitialized(i),tl,false);i._isCopilotFeaturesEnabled=true;i._isBoostExpired=false;babelHelpers.classPrivateFieldSet(babelHelpers.assertThisInitialized(i),il,BX.browser.IsFirefox());babelHelpers.classPrivateFieldSet(babelHelpers.assertThisInitialized(i),$o,_e.NONE);return i}babelHelpers.createClass(t,[{key:"initPeers",value:function e(){var t=this;this.users.forEach((function(e){e=Number(e);t.peers[e]=t.createPeer(e)}))}},{key:"reinitPeers",value:function e(){for(var t in this.peers){if(this.peers.hasOwnProperty(t)&&this.peers[t]){this.peers[t].destroy();this.peers[t]=null}}this.initPeers()}},{key:"createPeer",value:function e(t){var i=this;var n;if(this.videoAllowedFrom===Mc.all){n=true}else if(this.videoAllowedFrom===Mc.none){n=false}else if(p.Type.isArray(this.videoAllowedFrom)){n=this.videoAllowedFrom.some((function(e){return e==t}))}else{n=true}return new uc({call:this,userId:t,ready:t==this.initiatorId,isIncomingVideoAllowed:n,onMediaReceived:function e(n){i.runCallback(Ac.onRemoteMediaReceived,n);if(n.kind==="video"){i.runCallback(Ac.onUserVideoPaused,{userId:t,videoPaused:false})}},onMediaRemoved:function e(t){i.runCallback(Ac.onRemoteMediaStopped,t)},onStateChanged:babelHelpers.classPrivateFieldGet(this,rl),onInviteTimeout:babelHelpers.classPrivateFieldGet(this,ol)})}},{key:"getUsers",value:function e(){var t={};for(var i in this.peers){t[i]=this.peers[i].calculatedState}return t}},{key:"getUserCount",value:function e(){return Object.keys(this.peers).length}},{key:"canChangeMediaDevices",value:function e(){var t;return!((t=this.BitrixCall)!==null&&t!==void 0&&t.isMediaMutedBySystem)}},{key:"setCameraId",value:function e(t){var i=this;if(this.cameraId===t){return}var n=Boolean(this.cameraId);this.cameraId=t;if(this.BitrixCall){if(!t){babelHelpers.classPrivateFieldGet(this,kl).call(this,ge.Camera);return}if(!n){return}if(this.BitrixCall.isVideoPublished()){zo(this,nl,tc).call(this,ge.Camera,true)}this.BitrixCall.switchActiveVideoDevice(this.cameraId).then((function(){if(H.isCameraOn){i.runCallback("onUpdateLastUsedCameraId");if(i.BitrixCall.isVideoPublished()&&i.canChangeMediaDevices()){var e=ae.getLocalStream(ge.Camera);var t=Yf.MediaKind[ge.Camera];var n=new yn({kind:t,track:e});i.runCallback(Ac.onLocalMediaReceived,{mediaRenderer:n,tag:"main",stream:n.stream});if(i.BitrixCall.isVideoPublished()){zo(i,nl,tc).call(i,ge.Camera,false)}}else if(!i.canChangeMediaDevices()){i.runCallback(Ac.onNeedResetMediaDevicesState)}else{zo(i,nl,tc).call(i,ge.Camera,true);i.localVideoShown=true;i.BitrixCall.enableVideo({calledFrom:"switchActiveVideoDevice",skipUnpause:true})}}else{zo(i,nl,tc).call(i,ge.Camera,false)}}))["catch"]((function(e){i.log(e);console.error(e);babelHelpers.classPrivateFieldGet(i,kl).call(i,ge.Camera)}))}}},{key:"setMicrophoneId",value:function e(t){var i=this;if(this.microphoneId===t){return}var n=Boolean(this.microphoneId);this.microphoneId=t;if(this.BitrixCall){if(!t){babelHelpers.classPrivateFieldGet(this,kl).call(this,ge.Microphone);return}if(!n){return}zo(this,nl,tc).call(this,ge.Microphone,true);babelHelpers.classPrivateFieldGet(this,Kl).call(this,{userId:this.userId});this.BitrixCall.switchActiveAudioDevice(this.microphoneId).then((function(){var e=ae.getLocalStream(ge.Microphone);babelHelpers.classPrivateFieldGet(i,El).call(i,{result:true,stream:new MediaStream([e])})}))["catch"]((function(e){i.log(e);console.error(e);i.runCallback(Ac.onUserMicrophoneState,{userId:i.userId,microphoneState:false})}))["finally"]((function(){zo(i,nl,tc).call(i,ge.Microphone,false);if(H.isMicrophoneMuted&&!i.canChangeMediaDevices()){i.BitrixCall.disableAudio({calledFrom:"setMicrophoneId"})}}))}}},{key:"setRecorderState",value:function e(t){if(!this.BitrixCall||babelHelpers.classPrivateFieldGet(this,el)===t){return}this.BitrixCall.setRecorderState(t)}},{key:"setCloudRecordState",value:function e(t){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:null;if(!this.BitrixCall||babelHelpers.classPrivateFieldGet(this,$o)===t){return}this.BitrixCall.setCloudRecordState(t,i)}},{key:"useHdVideo",value:function e(t){this.videoHd=t===true}},{key:"setMainStream",value:function e(t){if(!this.BitrixCall){return}if(t.userId&&t.userId!==this.userId){var i;var n=(i=this.peers[t.userId])===null||i===void 0?void 0:i.participant;var a=n!==null&&n!==void 0&&n.screenSharingEnabled?ge.Screen:ge.Camera;this.BitrixCall.setMainStream(t,a)}else{this.BitrixCall.resetMainStream(t)}}},{key:"setVideoQualityForStreams",value:function e(t){if(!this.BitrixCall){return}this.BitrixCall.setVideoQualityForStreams(t)}},{key:"requestFloor",value:function e(t){if(this.floorRequestActive===t){return}this.floorRequestActive=t;this.BitrixCall.raiseHand(t)}},{key:"updateUserData",value:function e(t){this.BitrixCall.updateUserData(t)}},{key:"turnOffAllParticipansStream",value:function e(t){this.BitrixCall.turnOffAllParticipansStream(t)}},{key:"turnOffParticipantStream",value:function e(t){this.BitrixCall.turnOffParticipantStream(t)}},{key:"allowSpeakPermission",value:function e(t){this.BitrixCall.allowSpeakPermission(t)}},{key:"changeSettings",value:function e(t){this.BitrixCall.changeSettings(t)}},{key:"sendLocalRecordState",value:function e(t){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:false;if(!i&&!this.updateCommonRecordState(Vo(Vo({},t),{},{senderId:this.userId}))){return}this.signaling.sendLocalRecordState(this.userId,this.commonRecordState)}},{key:"sendCustomMessage",value:function e(t,i){this.signaling.sendCustomMessage(t,i)}},{key:"allowVideoFrom",value:function e(t){if(this.videoAllowedFrom==t){return}this.videoAllowedFrom=t;if(t===Mc.all){this.signaling.sendShowAll();t=Object.keys(this.peers)}else if(t===Mc.none){this.signaling.sendHideAll();t=[]}else if(p.Type.isArray(t)){this.signaling.sendShowUsers(t)}else{throw new Error("userList is in wrong format")}var i={};t.forEach((function(e){return i[e]=true}));for(var n in this.peers){if(!this.peers.hasOwnProperty(n)){continue}if(i[n]){this.peers[n].allowIncomingVideo(true)}else{this.peers[n].allowIncomingVideo(false)}}}},{key:"startScreenSharing",value:function e(){if(!this.BitrixCall){return}this.waitingLocalScreenShare=true;this.runCallback(Ac.onUserScreenState,{userId:this.userId,screenState:true});this.BitrixCall.startScreenShare()}},{key:"stopScreenSharing",value:function e(){babelHelpers.classPrivateFieldGet(this,kl).call(this,ge.Screen)}},{key:"isScreenSharingStarted",value:function e(){return this.screenShared||this.waitingLocalScreenShare}},{key:"isGetUserMediaFulfilled",value:function e(){return this.getUserMediaFulfilled}},{key:"inviteUsers",value:function e(){var t=this;var i=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};this.ready=true;var n=p.Type.isArray(i.users)?i.users:this.users;this.attachToConference().then((function(){if(t.type===wc.Instant){clearTimeout(t.waitForAnswerTimeout);t.waitForAnswerTimeout=setTimeout((function(){zo(t,ll,ac).call(t)}),Jo)}t.state=kc.Connected;t.runCallback(Ac.onJoin,{local:true});n.forEach((function(e){var i=parseInt(e,10);if(!t.users.includes(i)){t.users.push(i)}if(!t.peers[i]){t.peers[i]=t.createPeer(i)}if(t.type===wc.Instant){t.peers[i].onInvited()}}));if(i.userData&&i.show){var e={users:i.userData};t.signaling.sendUsersInvited(e)}if(i.show&&t.type===wc.Instant&&n.length>0){var a={users:n,video:H.isCameraOn?"Y":"N",repeated:"Y"};t.signaling.inviteUsers(a).then((function(){return t.scheduleRepeatInvite()}))}}))["catch"]((function(e){babelHelpers.classPrivateFieldGet(t,Bl).call(t,e)}))}},{key:"scheduleRepeatInvite",value:function e(){var t=this;clearTimeout(this.reinviteTimeout);this.reinviteTimeout=setTimeout((function(){return t.repeatInviteUsers()}),Ko)}},{key:"repeatInviteUsers",value:function e(){var t=this;clearTimeout(this.reinviteTimeout);if(!this.ready){return}var i=[];for(var n in this.peers){if(this.peers.hasOwnProperty(n)&&this.peers[n].calculatedState===yc.Calling){i.push(n)}}if(i.length===0){return}var a={users:i,video:H.isCameraOn?"Y":"N",repeated:"Y"};this.signaling.inviteUsers(a).then((function(){return t.scheduleRepeatInvite()}))}},{key:"answer",value:function e(){var t=this;var i=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};this.ready=true;var n=i.joinAsViewer===true;this.videoEnabled=H.isCameraOn;this.muted=H.isMicrophoneMuted;this.attachToConference({joinAsViewer:n}).then((function(){t.log("Attached to conference");t.state=kc.Connected;t.runCallback(Ac.onJoin,{local:true})}))["catch"]((function(e){babelHelpers.classPrivateFieldGet(t,Bl).call(t,e)}))}},{key:"decline",value:function e(t){this.ready=false;var i={callUuid:this.uuid,callInstanceId:this.instanceId};if(t){i.code=t}BX.ajax.runAction(jo.decline,{data:i})}},{key:"hangup",value:function e(t,i){var n=arguments.length>2&&arguments[2]!==undefined?arguments[2]:false;if(!this.ready){var a=new Error("Hangup in wrong state");this.log(a);return}var s=new Error;s.name="Call stack:";this.log("Hangup received \n"+s.stack);if(this.localVAD){this.localVAD.destroy();this.localVAD=null}clearInterval(this.microphoneLevelInterval);var r={};this.ready=false;if(typeof t!="undefined"){r.code=t}if(typeof i!="undefined"){r.reason=i}this.state=kc.Proceeding;this.runCallback(Ac.onLeave,{local:true});r.userId=this.users.slice(0).concat(this.userId);if(i!=="SIGNALING_DUPLICATE_PARTICIPANT"){this.reinitPeers()}if(this.BitrixCall){this.BitrixCall._replaceVideoSharing=false;this.BitrixCall.hangup(!!n);this.BitrixCall=null}else{this.log("Tried to hangup, but this.BitrixCall points nowhere");console.error("Tried to hangup, but this.BitrixCall points nowhere")}this.connectionData={};this.screenShared=false;this.localVideoShown=false;this.floorRequestActive=false}},{key:"attachToConference",value:function e(){var t=this;var i=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};var n=i.joinAsViewer===true;if(this.BitrixCall&&this.BitrixCall.getState()===ke.CONNECTED){if(this.joinedAsViewer===n){return Promise.resolve()}else{return Promise.reject("Already joined call in another mode")}}return new Promise((function(e,i){t.direction=n?Sc.RecvOnly:Sc.SendRecv;t.sendTelemetryEvent("call");try{t.localUserState=yc.Connecting;t.BitrixCall=new At(t.userId);t.joinedAsViewer=n;if(!t.BitrixCall){t.log("Error: could not create Bitrix call");return i({code:"BITRIX_NO_CALL"})}t.runCallback(Qo.onCallConference,{call:t});t.bindCallEvents();t.subscribeHardwareChanges();t.BitrixCall.on("Connected",(function(){zo(t,al,ic).call(t);e()}));t.BitrixCall.on("Failed",(function(e){zo(t,sl,nc).call(t,e);i(e)}));if(!t.ready){return i({code:"BITRIX_NO_CALL"})}t.BitrixCall.connect(Vo({roomId:t.uuid,userId:t.userId,userRole:t.userRole,videoBitrate:1e6,videoSimulcast:true,audioDeviceId:t.microphoneId,videoDeviceId:t.cameraId},t.connectionData))}catch(e){babelHelpers.classPrivateFieldGet(t,Bl).call(t,e)}}))}},{key:"bindCallEvents",value:function e(){this.BitrixCall.on("PublishSucceed",babelHelpers.classPrivateFieldGet(this,pl));this.BitrixCall.on("PublishPaused",babelHelpers.classPrivateFieldGet(this,vl));this.BitrixCall.on("MediaMutedBySystem",babelHelpers.classPrivateFieldGet(this,fl));this.BitrixCall.on("PublishFailed",babelHelpers.classPrivateFieldGet(this,ml));this.BitrixCall.on("PublishEnded",babelHelpers.classPrivateFieldGet(this,ml));this.BitrixCall.on("GetUserMediaStarted",babelHelpers.classPrivateFieldGet(this,gl).bind(this));this.BitrixCall.on("GetUserMediaEnded",babelHelpers.classPrivateFieldGet(this,Cl));this.BitrixCall.on("GetUserMediaSuccess",babelHelpers.classPrivateFieldGet(this,bl).bind(this));this.BitrixCall.on("RemoteMediaAdded",babelHelpers.classPrivateFieldGet(this,yl));this.BitrixCall.on("RemoteMediaRemoved",babelHelpers.classPrivateFieldGet(this,Sl));this.BitrixCall.on("RemoteMediaMuted",babelHelpers.classPrivateFieldGet(this,wl));this.BitrixCall.on("RemoteMediaUnmuted",babelHelpers.classPrivateFieldGet(this,wl));this.BitrixCall.on("ParticipantJoined",babelHelpers.classPrivateFieldGet(this,Pl));this.BitrixCall.on("ParticipantStateUpdated",(function(){return console.log("handleParticipantStateUpdated")}));this.BitrixCall.on("ParticipantLeaved",babelHelpers.classPrivateFieldGet(this,_l));this.BitrixCall.on("MessageReceived",babelHelpers.classPrivateFieldGet(this,Ul));this.BitrixCall.on("HandRaised",babelHelpers.classPrivateFieldGet(this,Fl));this.BitrixCall.on("VoiceStarted",babelHelpers.classPrivateFieldGet(this,Jl));this.BitrixCall.on("TurnOnCamera",babelHelpers.classPrivateFieldGet(this,Gl));this.BitrixCall.on("AllParticipantsAudioMuted",babelHelpers.classPrivateFieldGet(this,Vl));this.BitrixCall.on("AllParticipantsVideoMuted",babelHelpers.classPrivateFieldGet(this,Wl));this.BitrixCall.on("AllParticipantsScreenshareMuted",babelHelpers.classPrivateFieldGet(this,Xl));this.BitrixCall.on("YouMuteAllParticipants",babelHelpers.classPrivateFieldGet(this,zl));this.BitrixCall.on("RoomSettingsChanged",babelHelpers.classPrivateFieldGet(this,jl));this.BitrixCall.on("UserPermissionsChanged",babelHelpers.classPrivateFieldGet(this,ql));this.BitrixCall.on("UserRoleChanged",babelHelpers.classPrivateFieldGet(this,Yl));this.BitrixCall.on("ParticipantMuted",babelHelpers.classPrivateFieldGet(this,Ql));this.BitrixCall.on("VoiceEnded",babelHelpers.classPrivateFieldGet(this,Kl));this.BitrixCall.on("RecorderStatusChanged",babelHelpers.classPrivateFieldGet(this,Zl));this.BitrixCall.on("CloudRecordStatusChanged",babelHelpers.classPrivateFieldGet(this,$l));this.BitrixCall.on("Reconnecting",babelHelpers.classPrivateFieldGet(this,Rl));this.BitrixCall.on("Reconnected",babelHelpers.classPrivateFieldGet(this,Ml));this.BitrixCall.on("ReconnectingFailed",babelHelpers.classPrivateFieldGet(this,Al));this.BitrixCall.on("Disconnected",babelHelpers.classPrivateFieldGet(this,Ll));this.BitrixCall.on("CallStatsReceived",babelHelpers.classPrivateFieldGet(this,Hl));this.BitrixCall.on("UpdatePacketLoss",babelHelpers.classPrivateFieldGet(this,Nl));this.BitrixCall.on("ConnectionQualityChanged",babelHelpers.classPrivateFieldGet(this,xl));this.BitrixCall.on("ToggleRemoteParticipantVideo",babelHelpers.classPrivateFieldGet(this,Ol));this.BitrixCall.on("TrackSubscriptionFailed",babelHelpers.classPrivateFieldGet(this,Dl))}},{key:"removeCallEvents",value:function e(){if(this.BitrixCall){this.BitrixCall.on("Failed",BX.DoNothing);this.BitrixCall.on("PublishSucceed",BX.DoNothing);this.BitrixCall.on("PublishFailed",BX.DoNothing);this.BitrixCall.on("PublishEnded",BX.DoNothing);this.BitrixCall.on("GetUserMediaEnded",BX.DoNothing);this.BitrixCall.on("RemoteMediaAdded",BX.DoNothing);this.BitrixCall.on("RemoteMediaRemoved",BX.DoNothing);this.BitrixCall.on("ParticipantJoined",BX.DoNothing);this.BitrixCall.on("ParticipantStateUpdated",BX.DoNothing);this.BitrixCall.on("ParticipantLeaved",BX.DoNothing);this.BitrixCall.on("MessageReceived",BX.DoNothing);this.BitrixCall.on("HandRaised",BX.DoNothing);this.BitrixCall.on("AllParticipantsAudioMuted",BX.DoNothing);this.BitrixCall.on("AllParticipantsVideoMuted",BX.DoNothing);this.BitrixCall.on("AllParticipantsScreenshareMuted",BX.DoNothing);this.BitrixCall.on("YouMuteAllParticipants",BX.DoNothing);this.BitrixCall.on("VoiceStarted",BX.DoNothing);this.BitrixCall.on("VoiceEnded",BX.DoNothing);this.BitrixCall.on("RecorderStatusChanged",BX.DoNothing);this.BitrixCall.on("CloudRecordStatusChanged",BX.DoNothing);this.BitrixCall.on("Reconnecting",BX.DoNothing);this.BitrixCall.on("Reconnected",BX.DoNothing);this.BitrixCall.on("ReconnectingFailed",BX.DoNothing);this.BitrixCall.on("Disconnected",BX.DoNothing);this.BitrixCall.on("CallStatsReceived",BX.DoNothing);this.BitrixCall.on("UpdatePacketLoss",BX.DoNothing);this.BitrixCall.on("ConnectionQualityChanged",BX.DoNothing);this.BitrixCall.on("ToggleRemoteParticipantVideo",BX.DoNothing);this.BitrixCall.on("TrackSubscriptionFailed",BX.DoNothing)}}},{key:"subscribeHardwareChanges",value:function e(){H.subscribe(H.Events.onChangeMicrophoneMuted,this.setMuted);H.subscribe(H.Events.onChangeCameraOn,this.setVideoEnabled)}},{key:"unsubscribeHardwareChanges",value:function e(){H.unsubscribe(H.Events.onChangeMicrophoneMuted,this.setMuted);H.unsubscribe(H.Events.onChangeCameraOn,this.setVideoEnabled)}},{key:"addInvitedUsers",value:function e(t){for(var i in t){var n=Number(i);if(n==this.userId){continue}if(!this.peers[n]){this.peers[n]=this.createPeer(n);this.runCallback(Ac.onUserInvited,{userId:n,userData:babelHelpers.defineProperty({},n,t[i])})}if(this.type===wc.Instant&&this.peers[n].calculatedState!==yc.Calling){this.peers[n].onInvited()}if(!this.users.includes(n)){this.users.push(n)}}}},{key:"toggleRemoteParticipantVideo",value:function e(t,i){var n=arguments.length>2&&arguments[2]!==undefined?arguments[2]:false;if(this.BitrixCall){this.BitrixCall.toggleRemoteParticipantVideo(t,i,n)}}},{key:"isAnyoneParticipating",value:function e(){for(var t in this.peers){if(this.peers[t].isParticipating()){return true}}return false}},{key:"getParticipatingUsers",value:function e(){var t=[];for(var i in this.peers){if(this.peers[i].isParticipating()){t.push(i)}}return t}},{key:"__onPullEvent",value:function e(t,i,n){if(this.pullEventHandlers[t]){if(t!=="Call::ping"){this.log("Signaling: "+t+"; Parameters: "+JSON.stringify(i))}this.pullEventHandlers[t].call(this,i)}}},{key:"__onPullEventAnswerSelf",value:function e(t){if(t.callInstanceId===this.instanceId){return}this.runCallback(Ac.onJoin,{local:false})}},{key:"sendTelemetryEvent",value:function e(t){Yf.sendTelemetryEvent({call_id:this.id,user_id:this.userId,kind:"Bitrix",event:t})}},{key:"destroy",value:function e(){var i=arguments.length>0&&arguments[0]!==undefined?arguments[0]:false;this.ready=false;this.joinedAsViewer=false;this.localVideoShown=false;this.floorRequestActive=false;if(this.localVAD){this.localVAD.destroy();this.localVAD=null}clearInterval(this.microphoneLevelInterval);if(this.BitrixCall){this.removeCallEvents();this.unsubscribeHardwareChanges();this.BitrixCall.hangup(i);this.BitrixCall=null}for(var n in this.peers){if(this.peers.hasOwnProperty(n)&&this.peers[n]){this.peers[n].destroy()}}this.runCallback(Ac.onLeave,{local:true});return babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"destroy",this).call(this)}},{key:"provider",get:function e(){return Tc.Bitrix}},{key:"screenShared",get:function e(){return this._screenShared},set:function e(t){if(t!==this._screenShared){this._screenShared=t;this.signaling.sendScreenState(this._screenShared)}}},{key:"isCopilotInitialized",get:function e(){return babelHelpers.classPrivateFieldGet(this,el)!==Pe.UNAVAILABLE||babelHelpers.classPrivateFieldGet(this,tl)}},{key:"isCopilotActive",get:function e(){return babelHelpers.classPrivateFieldGet(this,el)===Pe.ENABLED}},{key:"isCopilotDisabled",get:function e(){return babelHelpers.classPrivateFieldGet(this,el)===Pe.DESTROYED}},{key:"isBoostExpired",get:function e(){return this._isBoostExpired},set:function e(t){if(t!==this._isBoostExpired){this._isBoostExpired=t}}},{key:"isCopilotFeaturesEnabled",get:function e(){return this._isCopilotFeaturesEnabled},set:function e(t){if(t!==this._isCopilotFeaturesEnabled){this._isCopilotFeaturesEnabled=t}}},{key:"isCloudRecordFeaturesEnabled",get:function e(){return babelHelpers.classPrivateFieldGet(this,Zo)},set:function e(t){if(t!==babelHelpers.classPrivateFieldGet(this,Zo)){babelHelpers.classPrivateFieldSet(this,Zo,t)}}},{key:"localUserState",get:function e(){return this._localUserState},set:function e(t){if(t===this._localUserState){return}this.runCallback(Ac.onUserStateChanged,{userId:this.userId,state:t,previousState:this._localUserState,direction:this.direction});this._localUserState=t}},{key:"reconnectionEventCount",get:function e(){return this._reconnectionEventCount},set:function e(t){if(t===0){this.runCallback(Ac.onReconnected)}this._reconnectionEventCount=t}},{key:"hasConnectionData",get:function e(){return Boolean(this.connectionData.mediaServerUrl&&this.connectionData.roomData)}}]);return t}(Oi);function tc(e,t){if(e===ge.Camera){this.runCallback(Ac.onCameraPublishing,{publishing:t})}else if(e===ge.Microphone){this.runCallback(Ac.onMicrophonePublishing,{publishing:t})}}function ic(){this.reconnectionEventCount=0;this.log("Call connected");this.sendTelemetryEvent("connect");this.localUserState=yc.Connected;var e=Yf.countDisableCameraNewJoinedUsersFeature();if(Yf.isDisableCameraNewJoinedUsersFeatureEnabled()&&this.BitrixCall.remoteParticipantsCount>=e){H.isCameraOn=false}if(!Yf.havePermissionToBroadcast("cam")){H.isCameraOn=false}if(!Yf.havePermissionToBroadcast("mic")){H.isMicrophoneMuted=true}this.BitrixCall.on("Failed",babelHelpers.classPrivateFieldGet(this,Ll));if(!this.BitrixCall.isAudioPublished()){zo(this,nl,tc).call(this,ge.Microphone,true)}this.BitrixCall.enableAudio({calledFrom:"onCallConnected",disabled:H.isMicrophoneMuted});if(H.isCameraOn){this.localVideoShown=true;if(!this.BitrixCall.isVideoPublished()){zo(this,nl,tc).call(this,ge.Camera,true)}this.BitrixCall.enableVideo({calledFrom:"onCallConnected"})}if(this.videoAllowedFrom==Mc.none){this.signaling.sendHideAll()}else if(p.Type.isArray(this.videoAllowedFrom)){this.signaling.sendShowUsers(this.videoAllowedFrom)}}function nc(e){this.log("Could not attach to conference",e);this.sendTelemetryEvent("connect_failure");this.localUserState=yc.Failed;this.BitrixCall.enableSilentLogging(false);this.BitrixCall.setLoggerCallback(null)}function ac(){if(this.ready&&!this.isAnyoneParticipating()){this.destroy(true)}}babelHelpers.defineProperty(ec,"Event",Qo);var sc=new WeakSet;var rc=new WeakSet;var oc=function(){function e(t){babelHelpers.classCallCheck(this,e);Go(this,rc);Go(this,sc);this.call=t.call}babelHelpers.createClass(e,[{key:"inviteUsers",value:function e(t){return zo(this,rc,cc).call(this,jo.invite,t)}},{key:"sendUsersInvited",value:function e(t){zo(this,sc,lc).call(this,qo.usersInvited,{users:t.userData})}},{key:"sendCameraState",value:function e(t){return zo(this,sc,lc).call(this,qo.cameraState,{cameraState:t?"Y":"N"})}},{key:"sendVideoPaused",value:function e(t){return zo(this,sc,lc).call(this,qo.videoPaused,{videoPaused:t?"Y":"N"})}},{key:"sendMicrophoneState",value:function e(t){return zo(this,sc,lc).call(this,qo.microphoneState,{microphoneState:t?"Y":"N"})}},{key:"sendScreenState",value:function e(t){return zo(this,sc,lc).call(this,qo.screenState,{screenState:t?"Y":"N"})}},{key:"sendLocalRecordState",value:function e(t,i){zo(this,sc,lc).call(this,qo.commonRecordState,{senderId:t,commonRecordState:i})}},{key:"sendCustomMessage",value:function e(t,i){return zo(this,sc,lc).call(this,qo.customMessage,{message:t,repeatOnConnect:!!i})}},{key:"sendShowUsers",value:function e(t){return zo(this,sc,lc).call(this,qo.showUsers,{users:t})}},{key:"sendShowAll",value:function e(){return zo(this,sc,lc).call(this,qo.showAll,{})}},{key:"sendHideAll",value:function e(){return zo(this,sc,lc).call(this,qo.hideAll,{})}},{key:"sendUserInviteTimeout",value:function e(t){return zo(this,sc,lc).call(this,qo.userInviteTimeout,{data:t})}}]);return e}();function lc(e,t){if(!this.call.BitrixCall){return}if(!p.Type.isPlainObject(t)){t={}}t.eventName=e;t.requestId=Yf.getUuidv4();t.senderId=this.call.userId;this.call.BitrixCall.sendMessage(JSON.stringify(t))}function cc(e,t){if(!p.Type.isPlainObject(t)){t={}}t.callUuid=this.call.uuid;t.callInstanceId=this.call.instanceId;t.requestId=Yf.getUuidv4();return BX.ajax.runAction(e,{data:t})}var uc=function(){function e(t){babelHelpers.classCallCheck(this,e);this.userId=t.userId;this.call=t.call;this.ready=!!t.ready;this.calling=false;this.declined=false;this.busy=false;this.inviteTimeout=false;this.direction=t.direction||Sc.SendRecv;this.stream=null;this.mediaRenderers=[];this.isIncomingVideoAllowed=t.isIncomingVideoAllowed!==false;this.callingTimeout=0;this.callbacks={onStateChanged:p.Type.isFunction(t.onStateChanged)?t.onStateChanged:BX.DoNothing,onInviteTimeout:p.Type.isFunction(t.onInviteTimeout)?t.onInviteTimeout:BX.DoNothing,onMediaReceived:p.Type.isFunction(t.onMediaReceived)?t.onMediaReceived:BX.DoNothing,onMediaRemoved:p.Type.isFunction(t.onMediaRemoved)?t.onMediaRemoved:BX.DoNothing};this.calculatedState=this.calculateState()}babelHelpers.createClass(e,[{key:"setReady",value:function e(t){t=!!t;if(this.ready===t){return}this.ready=t;if(this.calling){clearTimeout(this.callingTimeout);this.calling=false;this.inviteTimeout=false}if(this.ready){this.declined=false;this.busy=false}this.updateCalculatedState()}},{key:"setDirection",value:function e(t){if(this.direction===t){return}this.direction=t}},{key:"setDeclined",value:function e(t){this.declined=t;if(this.calling){clearTimeout(this.callingTimeout);this.calling=false}if(this.declined){this.ready=false;this.busy=false}this.updateCalculatedState()}},{key:"setBusy",value:function e(t){this.busy=t;if(this.calling){clearTimeout(this.callingTimeout);this.calling=false}if(this.busy){this.ready=false;this.declined=false}this.updateCalculatedState()}},{key:"allowIncomingVideo",value:function e(t){if(this.isIncomingVideoAllowed==t){return}this.isIncomingVideoAllowed=!!t}},{key:"addMediaRenderer",value:function e(t){this.log("Adding media renderer for user"+this.userId,t);this.mediaRenderers.push(t);this.callbacks.onMediaReceived({userId:this.userId,kind:t.kind,mediaRenderer:t});this.updateCalculatedState()}},{key:"removeMediaRenderer",value:function e(t){this.log("Removing media renderer for user"+this.userId,t);var i;this.mediaRenderers.forEach((function(e,n){if(e.kind===t.kind){i=n}}));if(i>=0){this.mediaRenderers.splice(i,1)}this.callbacks.onMediaRemoved({userId:this.userId,kind:t.kind,mediaRenderer:t});this.updateCalculatedState()}},{key:"calculateState",value:function e(){if(this.participant){return yc.Connected}if(this.calling){return yc.Calling}if(this.inviteTimeout){return yc.Unavailable}if(this.declined){return yc.Declined}if(this.busy){return yc.Busy}if(this.ready){return yc.Ready}return yc.Idle}},{key:"updateCalculatedState",value:function e(){var t=this.calculateState();if(this.calculatedState!==t){this.callbacks.onStateChanged({userId:this.userId,state:t,previousState:this.calculatedState,direction:this.direction});this.calculatedState=t}}},{key:"isParticipating",value:function e(){return(this.calling||this.ready||this.participant)&&!this.declined}},{key:"onInvited",value:function e(){var t=this;this.ready=false;this.inviteTimeout=false;this.declined=false;this.calling=true;if(this.callingTimeout){clearTimeout(this.callingTimeout)}this.callingTimeout=setTimeout((function(){return t.onInviteTimeout(true)}),Jo);this.updateCalculatedState()}},{key:"onInviteTimeout",value:function e(t){clearTimeout(this.callingTimeout);if(!this.calling){return}this.calling=false;this.inviteTimeout=true;if(t){this.callbacks.onInviteTimeout({userId:this.userId})}this.updateCalculatedState()}},{key:"log",value:function e(){this.call.log.apply(this.call,arguments)}},{key:"destroy",value:function e(){if(this.stream){Yf.sendLog({description:"Stop peer media stream"});Yf.stopMediaStream(this.stream);this.stream=null}this.callbacks.onStateChanged=BX.DoNothing;this.callbacks.onInviteTimeout=BX.DoNothing;this.callbacks.onMediaReceived=BX.DoNothing;this.callbacks.onMediaRemoved=BX.DoNothing;clearTimeout(this.callingTimeout);this.callingTimeout=null}}]);return e}();var dc=function(){function e(t){var i=this;babelHelpers.classCallCheck(this,e);this.callId=t.callId;this.lifetime=t.lifetime||120;this.callbacks={onDelete:p.Type.isFunction(t.onDelete)?t.onDelete:BX.DoNothing};this.deleteTimeout=setTimeout((function(){i.callbacks.onDelete({callId:i.callId})}),this.lifetime*1e3)}babelHelpers.createClass(e,[{key:"__onPullEvent",value:function e(t,i,n){}},{key:"isAnyoneParticipating",value:function e(){return false}},{key:"addEventListener",value:function e(){return false}},{key:"removeEventListener",value:function e(){return false}},{key:"addInvitedUsers",value:function e(){console.error("unexpected call to CallStub.addInvitedUsers")}},{key:"destroy",value:function e(){clearTimeout(this.deleteTimeout);this.callbacks.onDelete=BX.DoNothing}}]);return e}();function hc(){/*! regenerator-runtime -- Copyright (c) 2014-present, Facebook, Inc. -- license (MIT): https://github.com/facebook/regenerator/blob/main/LICENSE */hc=function t(){return e};var e={},t=Object.prototype,i=t.hasOwnProperty,n=Object.defineProperty||function(e,t,i){e[t]=i.value},a="function"==typeof Symbol?Symbol:{},s=a.iterator||"@@iterator",r=a.asyncIterator||"@@asyncIterator",o=a.toStringTag||"@@toStringTag";function l(e,t,i){return Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{l({},"")}catch(e){l=function e(t,i,n){return t[i]=n}}function c(e,t,i,a){var s=t&&t.prototype instanceof h?t:h,r=Object.create(s.prototype),o=new T(a||[]);return n(r,"_invoke",{value:y(e,i,o)}),r}function u(e,t,i){try{return{type:"normal",arg:e.call(t,i)}}catch(e){return{type:"throw",arg:e}}}e.wrap=c;var d={};function h(){}function p(){}function v(){}var f={};l(f,s,(function(){return this}));var m=Object.getPrototypeOf,g=m&&m(m(P([])));g&&g!==t&&i.call(g,s)&&(f=g);var b=v.prototype=h.prototype=Object.create(f);function C(e){["next","throw","return"].forEach((function(t){l(e,t,(function(e){return this._invoke(t,e)}))}))}function k(e,t){function a(n,s,r,o){var l=u(e[n],e,s);if("throw"!==l.type){var c=l.arg,d=c.value;return d&&"object"==babelHelpers["typeof"](d)&&i.call(d,"__await")?t.resolve(d.__await).then((function(e){a("next",e,r,o)}),(function(e){a("throw",e,r,o)})):t.resolve(d).then((function(e){c.value=e,r(c)}),(function(e){return a("throw",e,r,o)}))}o(l.arg)}var s;n(this,"_invoke",{value:function e(i,n){function r(){return new t((function(e,t){a(i,n,e,t)}))}return s=s?s.then(r,r):r()}})}function y(e,t,i){var n="suspendedStart";return function(a,s){if("executing"===n)throw new Error("Generator is already running");if("completed"===n){if("throw"===a)throw s;return _()}for(i.method=a,i.arg=s;;){var r=i.delegate;if(r){var o=S(r,i);if(o){if(o===d)continue;return o}}if("next"===i.method)i.sent=i._sent=i.arg;else if("throw"===i.method){if("suspendedStart"===n)throw n="completed",i.arg;i.dispatchException(i.arg)}else"return"===i.method&&i.abrupt("return",i.arg);n="executing";var l=u(e,t,i);if("normal"===l.type){if(n=i.done?"completed":"suspendedYield",l.arg===d)continue;return{value:l.arg,done:i.done}}"throw"===l.type&&(n="completed",i.method="throw",i.arg=l.arg)}}}function S(e,t){var i=t.method,n=e.iterator[i];if(undefined===n)return t.delegate=null,"throw"===i&&e.iterator["return"]&&(t.method="return",t.arg=undefined,S(e,t),"throw"===t.method)||"return"!==i&&(t.method="throw",t.arg=new TypeError("The iterator does not provide a '"+i+"' method")),d;var a=u(n,e.iterator,t.arg);if("throw"===a.type)return t.method="throw",t.arg=a.arg,t.delegate=null,d;var s=a.arg;return s?s.done?(t[e.resultName]=s.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=undefined),t.delegate=null,d):s:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,d)}function w(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function I(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function T(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(w,this),this.reset(!0)}function P(e){if(e){var t=e[s];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var n=-1,a=function t(){for(;++n<e.length;)if(i.call(e,n))return t.value=e[n],t.done=!1,t;return t.value=undefined,t.done=!0,t};return a.next=a}}return{next:_}}function _(){return{value:undefined,done:!0}}return p.prototype=v,n(b,"constructor",{value:v,configurable:!0}),n(v,"constructor",{value:p,configurable:!0}),p.displayName=l(v,o,"GeneratorFunction"),e.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===p||"GeneratorFunction"===(t.displayName||t.name))},e.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,v):(e.__proto__=v,l(e,o,"GeneratorFunction")),e.prototype=Object.create(b),e},e.awrap=function(e){return{__await:e}},C(k.prototype),l(k.prototype,r,(function(){return this})),e.AsyncIterator=k,e.async=function(t,i,n,a,s){void 0===s&&(s=Promise);var r=new k(c(t,i,n,a),s);return e.isGeneratorFunction(i)?r:r.next().then((function(e){return e.done?e.value:r.next()}))},C(b),l(b,o,"Generator"),l(b,s,(function(){return this})),l(b,"toString",(function(){return"[object Generator]"})),e.keys=function(e){var t=Object(e),i=[];for(var n in t)i.push(n);return i.reverse(),function e(){for(;i.length;){var n=i.pop();if(n in t)return e.value=n,e.done=!1,e}return e.done=!0,e}},e.values=P,T.prototype={constructor:T,reset:function e(t){if(this.prev=0,this.next=0,this.sent=this._sent=undefined,this.done=!1,this.delegate=null,this.method="next",this.arg=undefined,this.tryEntries.forEach(I),!t)for(var n in this)"t"===n.charAt(0)&&i.call(this,n)&&!isNaN(+n.slice(1))&&(this[n]=undefined)},stop:function e(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function e(t){if(this.done)throw t;var n=this;function a(e,i){return o.type="throw",o.arg=t,n.next=e,i&&(n.method="next",n.arg=undefined),!!i}for(var s=this.tryEntries.length-1;s>=0;--s){var r=this.tryEntries[s],o=r.completion;if("root"===r.tryLoc)return a("end");if(r.tryLoc<=this.prev){var l=i.call(r,"catchLoc"),c=i.call(r,"finallyLoc");if(l&&c){if(this.prev<r.catchLoc)return a(r.catchLoc,!0);if(this.prev<r.finallyLoc)return a(r.finallyLoc)}else if(l){if(this.prev<r.catchLoc)return a(r.catchLoc,!0)}else{if(!c)throw new Error("try statement without catch or finally");if(this.prev<r.finallyLoc)return a(r.finallyLoc)}}}},abrupt:function e(t,n){for(var a=this.tryEntries.length-1;a>=0;--a){var s=this.tryEntries[a];if(s.tryLoc<=this.prev&&i.call(s,"finallyLoc")&&this.prev<s.finallyLoc){var r=s;break}}r&&("break"===t||"continue"===t)&&r.tryLoc<=n&&n<=r.finallyLoc&&(r=null);var o=r?r.completion:{};return o.type=t,o.arg=n,r?(this.method="next",this.next=r.finallyLoc,d):this.complete(o)},complete:function e(t,i){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&i&&(this.next=i),d},finish:function e(t){for(var i=this.tryEntries.length-1;i>=0;--i){var n=this.tryEntries[i];if(n.finallyLoc===t)return this.complete(n.completion,n.afterLoc),I(n),d}},catch:function e(t){for(var i=this.tryEntries.length-1;i>=0;--i){var n=this.tryEntries[i];if(n.tryLoc===t){var a=n.completion;if("throw"===a.type){var s=a.arg;I(n)}return s}}throw new Error("illegal catch attempt")},delegateYield:function e(t,i,n){return this.delegate={iterator:P(t),resultName:i,nextLoc:n},"next"===this.method&&(this.arg=undefined),d}},e}var pc=function(){function e(t){var i=this;babelHelpers.classCallCheck(this,e);this.channel=new BroadcastChannel(t);this.senderId=Math.random().toString(36).slice(2);this.requests=new Map;this.channel.onmessage=function(e){var t=e.data,n=t.type,a=t.requestId,s=t.senderId,r=t.payload;if(n==="response"&&i.requests.has(a)){var o=i.requests.get(a);if(!o.responders.has(s)){o.responders.add(s);o.responses.push(r);if(Date.now()>o.deadline){o.resolve(o.responses);i.requests["delete"](a)}}}if(n==="request"&&s!==i.senderId){var l=i.handle?i.handle(r):undefined;if(l!==undefined){i.channel.postMessage({type:"response",requestId:a,senderId:i.senderId,payload:l})}}}}babelHelpers.createClass(e,[{key:"executer",value:function e(t){this.handle=t}},{key:"broadcastRequest",value:function(){var e=babelHelpers.asyncToGenerator(hc().mark((function e(t){var i=this;var n,a,s,r,o=arguments;return hc().wrap((function e(l){while(1)switch(l.prev=l.next){case 0:n=o.length>1&&o[1]!==undefined?o[1]:{},a=n.timeout,s=a===void 0?100:a;r=Math.random().toString(36).slice(2);return l.abrupt("return",new Promise((function(e){i.requests.set(r,{resolve:e,responses:[],responders:new Set,deadline:Date.now()+s});i.channel.postMessage({type:"request",requestId:r,senderId:i.senderId,payload:t});setTimeout((function(){if(i.requests.has(r)){e(i.requests.get(r).responses);i.requests["delete"](r)}}),s)})));case 3:case"end":return l.stop()}}),e)})));function t(t){return e.apply(this,arguments)}return t}()},{key:"destroy",value:function e(){this.channel.close();this.requests.clear()}}]);return e}();function vc(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function fc(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?vc(Object(i),!0).forEach((function(t){babelHelpers.defineProperty(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):vc(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}function mc(){/*! regenerator-runtime -- Copyright (c) 2014-present, Facebook, Inc. -- license (MIT): https://github.com/facebook/regenerator/blob/main/LICENSE */mc=function t(){return e};var e={},t=Object.prototype,i=t.hasOwnProperty,n=Object.defineProperty||function(e,t,i){e[t]=i.value},a="function"==typeof Symbol?Symbol:{},s=a.iterator||"@@iterator",r=a.asyncIterator||"@@asyncIterator",o=a.toStringTag||"@@toStringTag";function l(e,t,i){return Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{l({},"")}catch(e){l=function e(t,i,n){return t[i]=n}}function c(e,t,i,a){var s=t&&t.prototype instanceof h?t:h,r=Object.create(s.prototype),o=new T(a||[]);return n(r,"_invoke",{value:y(e,i,o)}),r}function u(e,t,i){try{return{type:"normal",arg:e.call(t,i)}}catch(e){return{type:"throw",arg:e}}}e.wrap=c;var d={};function h(){}function p(){}function v(){}var f={};l(f,s,(function(){return this}));var m=Object.getPrototypeOf,g=m&&m(m(P([])));g&&g!==t&&i.call(g,s)&&(f=g);var b=v.prototype=h.prototype=Object.create(f);function C(e){["next","throw","return"].forEach((function(t){l(e,t,(function(e){return this._invoke(t,e)}))}))}function k(e,t){function a(n,s,r,o){var l=u(e[n],e,s);if("throw"!==l.type){var c=l.arg,d=c.value;return d&&"object"==babelHelpers["typeof"](d)&&i.call(d,"__await")?t.resolve(d.__await).then((function(e){a("next",e,r,o)}),(function(e){a("throw",e,r,o)})):t.resolve(d).then((function(e){c.value=e,r(c)}),(function(e){return a("throw",e,r,o)}))}o(l.arg)}var s;n(this,"_invoke",{value:function e(i,n){function r(){return new t((function(e,t){a(i,n,e,t)}))}return s=s?s.then(r,r):r()}})}function y(e,t,i){var n="suspendedStart";return function(a,s){if("executing"===n)throw new Error("Generator is already running");if("completed"===n){if("throw"===a)throw s;return _()}for(i.method=a,i.arg=s;;){var r=i.delegate;if(r){var o=S(r,i);if(o){if(o===d)continue;return o}}if("next"===i.method)i.sent=i._sent=i.arg;else if("throw"===i.method){if("suspendedStart"===n)throw n="completed",i.arg;i.dispatchException(i.arg)}else"return"===i.method&&i.abrupt("return",i.arg);n="executing";var l=u(e,t,i);if("normal"===l.type){if(n=i.done?"completed":"suspendedYield",l.arg===d)continue;return{value:l.arg,done:i.done}}"throw"===l.type&&(n="completed",i.method="throw",i.arg=l.arg)}}}function S(e,t){var i=t.method,n=e.iterator[i];if(undefined===n)return t.delegate=null,"throw"===i&&e.iterator["return"]&&(t.method="return",t.arg=undefined,S(e,t),"throw"===t.method)||"return"!==i&&(t.method="throw",t.arg=new TypeError("The iterator does not provide a '"+i+"' method")),d;var a=u(n,e.iterator,t.arg);if("throw"===a.type)return t.method="throw",t.arg=a.arg,t.delegate=null,d;var s=a.arg;return s?s.done?(t[e.resultName]=s.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=undefined),t.delegate=null,d):s:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,d)}function w(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function I(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function T(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(w,this),this.reset(!0)}function P(e){if(e){var t=e[s];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var n=-1,a=function t(){for(;++n<e.length;)if(i.call(e,n))return t.value=e[n],t.done=!1,t;return t.value=undefined,t.done=!0,t};return a.next=a}}return{next:_}}function _(){return{value:undefined,done:!0}}return p.prototype=v,n(b,"constructor",{value:v,configurable:!0}),n(v,"constructor",{value:p,configurable:!0}),p.displayName=l(v,o,"GeneratorFunction"),e.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===p||"GeneratorFunction"===(t.displayName||t.name))},e.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,v):(e.__proto__=v,l(e,o,"GeneratorFunction")),e.prototype=Object.create(b),e},e.awrap=function(e){return{__await:e}},C(k.prototype),l(k.prototype,r,(function(){return this})),e.AsyncIterator=k,e.async=function(t,i,n,a,s){void 0===s&&(s=Promise);var r=new k(c(t,i,n,a),s);return e.isGeneratorFunction(i)?r:r.next().then((function(e){return e.done?e.value:r.next()}))},C(b),l(b,o,"Generator"),l(b,s,(function(){return this})),l(b,"toString",(function(){return"[object Generator]"})),e.keys=function(e){var t=Object(e),i=[];for(var n in t)i.push(n);return i.reverse(),function e(){for(;i.length;){var n=i.pop();if(n in t)return e.value=n,e.done=!1,e}return e.done=!0,e}},e.values=P,T.prototype={constructor:T,reset:function e(t){if(this.prev=0,this.next=0,this.sent=this._sent=undefined,this.done=!1,this.delegate=null,this.method="next",this.arg=undefined,this.tryEntries.forEach(I),!t)for(var n in this)"t"===n.charAt(0)&&i.call(this,n)&&!isNaN(+n.slice(1))&&(this[n]=undefined)},stop:function e(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function e(t){if(this.done)throw t;var n=this;function a(e,i){return o.type="throw",o.arg=t,n.next=e,i&&(n.method="next",n.arg=undefined),!!i}for(var s=this.tryEntries.length-1;s>=0;--s){var r=this.tryEntries[s],o=r.completion;if("root"===r.tryLoc)return a("end");if(r.tryLoc<=this.prev){var l=i.call(r,"catchLoc"),c=i.call(r,"finallyLoc");if(l&&c){if(this.prev<r.catchLoc)return a(r.catchLoc,!0);if(this.prev<r.finallyLoc)return a(r.finallyLoc)}else if(l){if(this.prev<r.catchLoc)return a(r.catchLoc,!0)}else{if(!c)throw new Error("try statement without catch or finally");if(this.prev<r.finallyLoc)return a(r.finallyLoc)}}}},abrupt:function e(t,n){for(var a=this.tryEntries.length-1;a>=0;--a){var s=this.tryEntries[a];if(s.tryLoc<=this.prev&&i.call(s,"finallyLoc")&&this.prev<s.finallyLoc){var r=s;break}}r&&("break"===t||"continue"===t)&&r.tryLoc<=n&&n<=r.finallyLoc&&(r=null);var o=r?r.completion:{};return o.type=t,o.arg=n,r?(this.method="next",this.next=r.finallyLoc,d):this.complete(o)},complete:function e(t,i){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&i&&(this.next=i),d},finish:function e(t){for(var i=this.tryEntries.length-1;i>=0;--i){var n=this.tryEntries[i];if(n.finallyLoc===t)return this.complete(n.completion,n.afterLoc),I(n),d}},catch:function e(t){for(var i=this.tryEntries.length-1;i>=0;--i){var n=this.tryEntries[i];if(n.tryLoc===t){var a=n.completion;if("throw"===a.type){var s=a.arg;I(n)}return s}}throw new Error("illegal catch attempt")},delegateYield:function e(t,i,n){return this.delegate={iterator:P(t),resultName:i,nextLoc:n},"next"===this.method&&(this.arg=undefined),d}},e}function gc(e,t){bc(e,t);t.add(e)}function bc(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}function Cc(e,t,i){if(!t.has(e)){throw new TypeError("attempted to get private field on non-instance")}return i}var kc={Idle:"Idle",Proceeding:"Proceeding",Connected:"Connected",Finished:"Finished"};var yc={Idle:"Idle",Busy:"Busy",Calling:"Calling",Unavailable:"Unavailable",Declined:"Declined",Ready:"Ready",Connecting:"Connecting",Connected:"Connected",Failed:"Failed"};var Sc={SendOnly:"send",RecvOnly:"recv",SendRecv:"sendrecv"};var wc={Instant:1,Permanent:2};var Ic={Small:1,Conference:2,Large:3,Personal:4};var Tc={Plain:"Plain",Bitrix:"Bitrix"};var Pc={Incoming:"Incoming",Outgoing:"Outgoing"};var _c={VeryHigh:"very_high",High:"high",Medium:"medium",Low:"low",VeryLow:"very_low"};var Ec={AuthorizeError:"AUTHORIZE_ERROR",BlankAnswer:"BLANK_ANSWER",BlankAnswerWithErrorCode:"BLANK_ANSWER_WITH_ERROR_CODE",ErrorUnexpectedAnswer:"ERROR_UNEXPECTED_ANSWER",AccessDenied:"ACCESS_DENIED",NetworkError:"NETWORK_ERROR",NoWebrtc:"NO_WEBRTC",NotAllowedError:"NotAllowedError",NotReadableError:"NotReadableError",UnknownError:"UNKNOWN_ERROR"};var Rc={SecurityKeyChanged:"SECURITY_KEY_CHANGED",RoomClosed:"ROOM_CLOSED"};var Mc={all:"all",none:"none"};var Ac={onUserInvited:"onUserInvited",onUserJoined:"onUserJoined",onUserStateChanged:"onUserStateChanged",onUserMicrophoneState:"onUserMicrophoneState",onUserCameraState:"onUserCameraState",onCameraPublishing:"onCameraPublishing",onMicrophonePublishing:"onMicrophonePublishing",onNeedResetMediaDevicesState:"onNeedResetMediaDevicesState",onUserVideoPaused:"onUserVideoPaused",onUserScreenState:"onUserScreenState",onUserCommonRecordState:"onUserCommonRecordState",onUserVoiceStarted:"onUserVoiceStarted",onUserVoiceStopped:"onUserVoiceStopped",onUserFloorRequest:"onUserFloorRequest",onTurnOnCamera:"onTurnOnCamera",onAllParticipantsAudioMuted:"onAllParticipantsAudioMuted",onAllParticipantsVideoMuted:"onAllParticipantsVideoMuted",onAllParticipantsScreenshareMuted:"onAllParticipantsScreenshareMuted",onYouMuteAllParticipants:"onYouMuteAllParticipants",onRoomSettingsChanged:"onRoomSettingsChanged",onUserPermissionsChanged:"onUserPermissionsChanged",onUserRoleChanged:"onUserRoleChanged",onParticipantMuted:"onParticipantMuted",onUserEmotion:"onUserEmotion",onTrackSubscriptionFailed:"onTrackSubscriptionFailed",onUserStatsReceived:"onUserStatsReceived",onCustomMessage:"onCustomMessage",onLocalMediaReceived:"onLocalMediaReceived",onLocalMediaStopped:"onLocalMediaStopped",onLocalScreenUpdated:"onLocalScreenUpdated",onMicrophoneLevel:"onMicrophoneLevel",onDeviceListUpdated:"onDeviceListUpdated",onRTCStatsReceived:"onRTCStatsReceived",onCallFailure:"onCallFailure",onRemoteMediaReceived:"onRemoteMediaReceived",onRemoteMediaStopped:"onRemoteMediaStopped",onBadNetworkIndicator:"onBadNetworkIndicator",onConnectionQualityChanged:"onConnectionQualityChanged",onNetworkProblem:"onNetworkProblem",onReconnecting:"onReconnecting",onReconnected:"onReconnected",onReconnectingFailed:"onReconnectingFailed",onJoin:"onJoin",onLeave:"onLeave",onJoinRoomOffer:"onJoinRoomOffer",onJoinRoom:"onJoinRoom",onLeaveRoom:"onLeaveRoom",onListRooms:"onListRooms",onUpdateRoom:"onUpdateRoom",onTransferRoomSpeakerRequest:"onTransferRoomSpeakerRequest",onTransferRoomSpeaker:"onTransferRoomSpeaker",onDestroy:"onDestroy",onGetUserMediaEnded:"onGetUserMediaEnded",onUpdateLastUsedCameraId:"onUpdateLastUsedCameraId",onToggleRemoteParticipantVideo:"onToggleRemoteParticipantVideo",onSwitchTrackRecordStatus:"onSwitchTrackRecordStatus",onRecorderStatusChanged:"onRecorderStatusChanged",onCloudRecordStatusChanged:"onCloudRecordStatusChanged"};var Lc={createCall:"im.call.create",createChatForChildCall:"call.Call.createChatForChildCall",getPublicChannels:"pull.channel.public.list",getCall:"im.call.get"};var Bc={classic:1,jwt:2};var Dc=new WeakSet;var Hc=new WeakSet;var Nc=new WeakSet;var xc=new WeakSet;var Oc=new WeakSet;var Uc=new WeakSet;var Fc=new WeakSet;var Vc=new WeakSet;var Gc=new WeakSet;var Wc=function(){function e(){babelHelpers.classCallCheck(this,e);gc(this,Gc);gc(this,Vc);gc(this,Fc);gc(this,Uc);gc(this,Oc);gc(this,xc);gc(this,Nc);gc(this,Hc);gc(this,Dc);babelHelpers.defineProperty(this,"handlers",{"Call::incoming":Cc(this,Hc,zc).bind(this)});babelHelpers.defineProperty(this,"jwtPullHandlers",{chatUserAdd:Cc(this,Nc,qc).bind(this),"Call::callTokenUpdate":Cc(this,Nc,qc).bind(this),"Call::clearCallTokens":Cc(this,xc,Yc).bind(this),"Call::callV2AvailabilityChanged":Cc(this,Oc,Qc).bind(this)});this.debugFlag=false;this.calls={};this.userId=Number(BX.message("USER_ID"));this.siteId="";this.unknownCalls={};this.restClient=null;this.pullClient=null;this.finishedCalls=new Set;this.multiBroadcastClient=new pc("call_engine_channel");this.init()}babelHelpers.createClass(e,[{key:"init",value:function e(){BX.addCustomEvent("onPullEvent-call",Cc(this,Dc,Xc).bind(this));BX.addCustomEvent("onPullEvent-im",Cc(this,Dc,Xc).bind(this))}},{key:"getSiteId",value:function e(){return this.siteId||BX.message("SITE_ID")||""}},{key:"setSiteId",value:function e(t){this.siteId=t}},{key:"getCurrentUserId",value:function e(){return this.userId}},{key:"setCurrentUserId",value:function e(t){this.userId=Number(t)}},{key:"setRestClient",value:function e(t){this.restClient=t}},{key:"setPullClient",value:function e(t){this.pullClient=t}},{key:"getRestClient",value:function e(){return this.restClient||BX.rest}},{key:"getPullClient",value:function e(){return this.pullClient||BX.PULL}},{key:"getLogService",value:function e(){return BX.message("call_log_service")}},{key:"onCallCreated",value:function e(t){BX.onCustomEvent(window,"CallEvents::callCreated",[{call:t}])}},{key:"createCall",value:function e(t){var i=this;return new Promise(function(){var e=babelHelpers.asyncToGenerator(mc().mark((function e(n,a){var s,r,o,l,c,u,d,h,v;var f,m,g,b,C,k,y,S,w;return mc().wrap((function e(I){while(1)switch(I.prev=I.next){case 0:f=t.type||wc.Instant;m=t.provider||i.getDefaultProvider();if(!t.joinExisting){I.next=15;break}I.t0=mc().keys(i.calls);case 4:if((I.t1=I.t0()).done){I.next=15;break}g=I.t1.value;if(!i.calls.hasOwnProperty(g)){I.next=13;break}b=i.calls[g];if(!(b.provider===t.provider&&b.associatedEntity.type===t.entityType&&b.associatedEntity.id===t.entityId)){I.next=13;break}i.log(g,"Found existing call, attaching to it");i.onCallCreated(b);H.isCameraOn=t.videoEnabled===true;return I.abrupt("return",n({call:b,isNew:false}));case 13:I.next=4;break;case 15:k=Yf.getUuidv4();I.prev=16;I.next=19;return Yf.getCallConnectionData({callToken:t.token,callType:f,provider:m,instanceId:k,isVideo:t.videoEnabled},t.chatInfo.chatId);case 19:C=I.sent;I.next=27;break;case 22:I.prev=22;I.t2=I["catch"](16);if(!(p.Type.isObject(I.t2)&&I.t2 instanceof Be)){I.next=26;break}return I.abrupt("return",a(I.t2));case 26:return I.abrupt("return",a({name:"MEDIA_SERVER_UNREACHABLE",message:"Reason: ".concat(I.t2===null||I.t2===void 0?void 0:I.t2.reason," ").concat(I.t2===null||I.t2===void 0?void 0:I.t2.data)}));case 27:if(!(!((s=C)!==null&&s!==void 0&&(r=s.result)!==null&&r!==void 0&&r.mediaServerUrl)||!((o=C)!==null&&o!==void 0&&(l=o.result)!==null&&l!==void 0&&l.roomData))){I.next=29;break}return I.abrupt("return",a({name:"MEDIA_SERVER_MISSING_PARAMS",message:"Incorrect signaling response"}));case 29:y=Yf.getAiSettings();if(y.serviceEnabled){kn.setup(y)}if(!i.calls[C.result.roomId]){I.next=38;break}if(!(i.calls[C.result.roomId]instanceof dc)){I.next=36;break}i.calls[C.result.roomId].destroy();I.next=38;break;case 36:console.warn("Call ".concat(C.result.roomId," already exists, returning it instead of creating a new one"));return I.abrupt("return",n({call:i.calls[C.result.roomId],isNew:false}));case 38:H.isCameraOn=t.videoEnabled===true;S=Cc(i,Vc,Kc).call(i,m);w=S.createCall({uuid:C.result.roomId,instanceId:k,direction:Pc.Outgoing,enableMicAutoParameters:t.enableMicAutoParameters!==false,associatedEntity:t.chatInfo,type:f,startDate:new Date(C.result.startDate*1e3),events:{onDestroy:Cc(i,Uc,Jc).bind(i)},debug:t.debug===true,connectionData:{mediaServerUrl:C.result.mediaServerUrl,roomData:C.result.roomData,roomType:C.result.roomType,monitoringServerUrl:(c=C.result.monitoring)===null||c===void 0?void 0:c.metricsServerUrl,monitoringLogsServerUrl:(u=C.result.monitoring)===null||u===void 0?void 0:u.logsServerUrl,monitoringJwtToken:(d=C.result.monitoring)===null||d===void 0?void 0:d.token,monitoringEnvironment:(h=C.result.monitoring)===null||h===void 0?void 0:h.env,monitoringRegion:(v=C.result.monitoring)===null||v===void 0?void 0:v.region},scheme:C.result.scheme});i.calls[w.uuid]=w;i.onCallCreated(w);n({call:w,isNew:C.result.isNew});case 44:case"end":return I.stop()}}),e,null,[[16,22]])})));return function(t,i){return e.apply(this,arguments)}}())}},{key:"createChildCall",value:function e(t,i,n,a){var s=this;return new Promise((function(e,r){var o={newProvider:i,callUuid:t.uuid,users:n};BX.ajax.runAction(Lc.createChatForChildCall,{data:o}).then((function(n){var o=n.data;var l=o.token;var c=o.chatId;var u=wc.Instant;var d=Cc(s,Vc,Kc).call(s,i);var h=Yf.getUuidv4();Yf.getCallConnectionData({instanceId:h,callType:u,callToken:l,provider:i,isVideo:a.videoEnabled,parentUuid:t.uuid},c).then((function(i){var n,l,c,p,v,f,m;if(!(i!==null&&i!==void 0&&(n=i.result)!==null&&n!==void 0&&n.mediaServerUrl)||!(i!==null&&i!==void 0&&(l=i.result)!==null&&l!==void 0&&l.roomData)){return r({name:"MEDIA_SERVER_MISSING_PARAMS",message:"Incorrect signaling response"})}var g=d.createCall({uuid:i.result.roomId,instanceId:h,initiatorId:s.userId,parentUuid:t.uuid,direction:Pc.Outgoing,enableMicAutoParameters:t.enableMicAutoParameters!==false,type:u,startDate:i.result.startDate,events:{onDestroy:Cc(s,Uc,Jc).bind(s)},logToken:o.logToken,connectionData:{mediaServerUrl:i.result.mediaServerUrl,roomData:i.result.roomData,roomType:i.result.roomType,monitoringServerUrl:(c=i.result.monitoring)===null||c===void 0?void 0:c.metricsServerUrl,monitoringLogsServerUrl:(p=i.result.monitoring)===null||p===void 0?void 0:p.logsServerUrl,monitoringJwtToken:(v=i.result.monitoring)===null||v===void 0?void 0:v.token,monitoringEnvironment:(f=i.result.monitoring)===null||f===void 0?void 0:f.env,monitoringRegion:(m=i.result.monitoring)===null||m===void 0?void 0:m.region},debug:a.debug,scheme:i.result.scheme});s.calls[g.uuid]=g;e({call:g,isNew:i.result.startDate})}))["catch"]((function(e){return r({name:"MEDIA_SERVER_UNREACHABLE",message:"Reason: ".concat(e.reason," ").concat(e.data)})}))}))["catch"]((function(e){return r({name:"MEDIA_SERVER_UNREACHABLE",message:"Reason: ".concat(e.reason," ").concat(e.data)})}))}))}},{key:"instantiateCall",value:function e(t,i,n,a){var s=t.UUID;if(this.calls[s]){console.warn("Call ".concat(s," already exists, returning it instead of creating a new one"));return this.calls[s]}var r=t["ASSOCIATED_ENTITY"];if(i){d.CallTokenManager.setToken(r.chatId,i)}var o=Cc(this,Vc,Kc).call(this,t["PROVIDER"]);var l=o.createCall({uuid:s,instanceId:Yf.getUuidv4(),initiatorId:parseInt(t["INITIATOR_ID"]),parentUuid:t["PARENT_UUID"],direction:t["INITIATOR_ID"]==this.userId?Pc.Outgoing:Pc.Incoming,associatedEntity:fc({userCounter:Object.keys(a).length},r),type:t["TYPE"],startDate:t["START_DATE"],logToken:n,scheme:t["SCHEME"],events:{onDestroy:Cc(this,Uc,Jc).bind(this)}});this.calls[l.uuid]=l;this.onCallCreated(l);return l}},{key:"getCallWithId",value:function e(t,i){var n=this;return new Promise((function(e,a){var s=n.calls[t];if(s&&s.hasConnectionData||s&&!i){e({call:s,isNew:false})}else if(i){n.createCall(i).then((function(t){e(t)}))["catch"]((function(e){a(e)}))}else{var r={name:"CALL_NOT_FOUND",message:"Call not found"};a(r)}}))}},{key:"getCallWithDialogId",value:function e(t){return Object.values(this.calls).find((function(e){var i;return((i=e.associatedEntity)===null||i===void 0?void 0:i.id)==t}))}},{key:"getDefaultProvider",value:function e(){return Tc.Plain}},{key:"getConferencePageTag",value:function e(t){return"conference-open-"+t}},{key:"debug",value:function e(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:true;this.debugFlag=!!t;return this.debugFlag}},{key:"log",value:function e(){var t=Yf.getLogMessage.call(Yf,arguments);if(r.DesktopApi.isDesktop()){r.DesktopApi.writeToLogFile(BX.message("USER_ID")+".video.log",t)}if(this.debugFlag){if(console){var i=["Call log ["+Yf.getTimeForLog()+"]: "];console.log.apply(this,i.concat(Array.prototype.slice.call(arguments)))}}}},{key:"getAllowedVideoQuality",value:function e(t){if(t<5){return _c.VeryHigh}else if(t<10){return _c.High}else if(t<16){return _c.Medium}else if(t<32){return _c.Low}else{return _c.VeryLow}}}]);return e}();function Xc(e,t,i){var n,a;if(this.jwtPullHandlers[e]){this.jwtPullHandlers[e].call(this,t,i);return}var s=(t===null||t===void 0?void 0:(n=t.call)===null||n===void 0?void 0:n.SCHEME)||(t===null||t===void 0?void 0:(a=t.call)===null||a===void 0?void 0:a.scheme);if(s!==Bc.jwt){return}if(this.handlers[e]){this.handlers[e].call(this,t,i)}else if(e.startsWith("Call::")&&t.call){var r,o;var l=((r=t.call)===null||r===void 0?void 0:r.UUID)||((o=t.call)===null||o===void 0?void 0:o.uuid);if(!l){return}var c=this.calls[l];if(!c&&e==="Call::finish"){this.log(l,'Got "Call::finish" before "Call::incoming"');this.finishedCalls.add(l);return}if(c&&!Cc(this,Gc,Zc).call(this,c)&&e==="Call::usersInvited"&&!this.finishedCalls.has(l)){c.addDialogInfo(t.call.ASSOCIATED_ENTITY);this.onCallCreated(c)}else if(!c&&e==="Call::usersInvited"&&!this.finishedCalls.has(l)){c=this.instantiateCall(t.call,t.callToken,t.logToken,t.userData)}if(c){c.__onPullEvent(e,t,i)}}}function zc(e,t){return jc.apply(this,arguments)}function jc(){jc=babelHelpers.asyncToGenerator(mc().mark((function e(t,i){var n,a,s,r,o,l,c;return mc().wrap((function e(u){while(1)switch(u.prev=u.next){case 0:console.log("#onPullIncomingCall",location.href);if(!(i.server_time_ago>30)){u.next=4;break}console.error("Call was started too long time ago");return u.abrupt("return");case 4:n=t.call;a=n.uuid;kn.setup(t.aiSettings);if(!this.finishedCalls.has(a)){u.next=10;break}this.log(a,'Got "Call::incoming" after "Call::finish"');return u.abrupt("return");case 10:d.CallTokenManager.setToken(n.associatedEntity.chatId,t.callToken);if(!(this.calls[a]instanceof dc)){u.next=13;break}return u.abrupt("return");case 13:if(this.calls[a]){s=this.calls[a];if(!Cc(this,Gc,Zc).call(this,s)){s.addDialogInfo(n.associatedEntity);this.onCallCreated(s)}}else{r=Cc(this,Vc,Kc).call(this,n.provider);o=Yf.getUuidv4();s=r.createCall({uuid:a,instanceId:o,parentId:n.parentId||null,parentUuid:n.parentUuid||null,callFromMobile:t.isLegacyMobile===true,direction:Pc.Incoming,initiatorId:n.initiatorId,associatedEntity:n.associatedEntity,type:n.type,startDate:n.startDate,logToken:n.logToken,events:{onDestroy:Cc(this,Uc,Jc).bind(this)},scheme:n.scheme});this.calls[a]=s;this.onCallCreated(s)}u.next=16;return this.multiBroadcastClient.broadcastRequest(a,{timeout:100});case 16:l=u.sent;c=l.some((function(e){return e}));if(s&&!c){BX.onCustomEvent(window,"CallEvents::incomingCall",[{call:s,video:t.video===true,isLegacyMobile:t.isLegacyMobile===true}])}this.log(s.uuid,"Incoming call "+s.uuid);case 20:case"end":return u.stop()}}),e,this)})));return jc.apply(this,arguments)}function qc(e,t){d.CallTokenManager.setToken(e.chatId,e.callToken)}function Yc(){d.CallTokenManager.clearTokenList()}function Qc(e,t){g.CallSettingsManager.jwtCallsEnabled=e.isJwtEnabled;g.CallSettingsManager.plainCallsUseJwt=e.isPlainUseJwt;if(e!==null&&e!==void 0&&e.callBalancerUrl){g.CallSettingsManager.callBalancerUrl=e.callBalancerUrl}}function Jc(e){var t=this;var i=e.call.uuid;this.calls[i]=new dc({callId:i,onDelete:function e(){if(t.calls[i]){delete t.calls[i]}}});BX.onCustomEvent(window,"CallEvents::callDestroyed",[{callId:e.call.uuid}])}function Kc(e){if(e==Tc.Plain){return $c}else if(e==Tc.Bitrix){return eu}throw new Error("Unknown call provider type "+e)}function Zc(e){return p.Type.isObject(e===null||e===void 0?void 0:e.associatedEntity)&&Object.keys(e.associatedEntity).length>0}var $c=function(){function e(){babelHelpers.classCallCheck(this,e)}babelHelpers.createClass(e,null,[{key:"createCall",value:function e(t){return new Mr(t)}}]);return e}();var eu=function(){function e(){babelHelpers.classCallCheck(this,e)}babelHelpers.createClass(e,null,[{key:"createCall",value:function e(t){return new ec(t)}}]);return e}();var tu=new Wc;function iu(){/*! regenerator-runtime -- Copyright (c) 2014-present, Facebook, Inc. -- license (MIT): https://github.com/facebook/regenerator/blob/main/LICENSE */iu=function t(){return e};var e={},t=Object.prototype,i=t.hasOwnProperty,n=Object.defineProperty||function(e,t,i){e[t]=i.value},a="function"==typeof Symbol?Symbol:{},s=a.iterator||"@@iterator",r=a.asyncIterator||"@@asyncIterator",o=a.toStringTag||"@@toStringTag";function l(e,t,i){return Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{l({},"")}catch(e){l=function e(t,i,n){return t[i]=n}}function c(e,t,i,a){var s=t&&t.prototype instanceof h?t:h,r=Object.create(s.prototype),o=new T(a||[]);return n(r,"_invoke",{value:y(e,i,o)}),r}function u(e,t,i){try{return{type:"normal",arg:e.call(t,i)}}catch(e){return{type:"throw",arg:e}}}e.wrap=c;var d={};function h(){}function p(){}function v(){}var f={};l(f,s,(function(){return this}));var m=Object.getPrototypeOf,g=m&&m(m(P([])));g&&g!==t&&i.call(g,s)&&(f=g);var b=v.prototype=h.prototype=Object.create(f);function C(e){["next","throw","return"].forEach((function(t){l(e,t,(function(e){return this._invoke(t,e)}))}))}function k(e,t){function a(n,s,r,o){var l=u(e[n],e,s);if("throw"!==l.type){var c=l.arg,d=c.value;return d&&"object"==babelHelpers["typeof"](d)&&i.call(d,"__await")?t.resolve(d.__await).then((function(e){a("next",e,r,o)}),(function(e){a("throw",e,r,o)})):t.resolve(d).then((function(e){c.value=e,r(c)}),(function(e){return a("throw",e,r,o)}))}o(l.arg)}var s;n(this,"_invoke",{value:function e(i,n){function r(){return new t((function(e,t){a(i,n,e,t)}))}return s=s?s.then(r,r):r()}})}function y(e,t,i){var n="suspendedStart";return function(a,s){if("executing"===n)throw new Error("Generator is already running");if("completed"===n){if("throw"===a)throw s;return _()}for(i.method=a,i.arg=s;;){var r=i.delegate;if(r){var o=S(r,i);if(o){if(o===d)continue;return o}}if("next"===i.method)i.sent=i._sent=i.arg;else if("throw"===i.method){if("suspendedStart"===n)throw n="completed",i.arg;i.dispatchException(i.arg)}else"return"===i.method&&i.abrupt("return",i.arg);n="executing";var l=u(e,t,i);if("normal"===l.type){if(n=i.done?"completed":"suspendedYield",l.arg===d)continue;return{value:l.arg,done:i.done}}"throw"===l.type&&(n="completed",i.method="throw",i.arg=l.arg)}}}function S(e,t){var i=t.method,n=e.iterator[i];if(undefined===n)return t.delegate=null,"throw"===i&&e.iterator["return"]&&(t.method="return",t.arg=undefined,S(e,t),"throw"===t.method)||"return"!==i&&(t.method="throw",t.arg=new TypeError("The iterator does not provide a '"+i+"' method")),d;var a=u(n,e.iterator,t.arg);if("throw"===a.type)return t.method="throw",t.arg=a.arg,t.delegate=null,d;var s=a.arg;return s?s.done?(t[e.resultName]=s.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=undefined),t.delegate=null,d):s:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,d)}function w(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function I(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function T(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(w,this),this.reset(!0)}function P(e){if(e){var t=e[s];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var n=-1,a=function t(){for(;++n<e.length;)if(i.call(e,n))return t.value=e[n],t.done=!1,t;return t.value=undefined,t.done=!0,t};return a.next=a}}return{next:_}}function _(){return{value:undefined,done:!0}}return p.prototype=v,n(b,"constructor",{value:v,configurable:!0}),n(v,"constructor",{value:p,configurable:!0}),p.displayName=l(v,o,"GeneratorFunction"),e.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===p||"GeneratorFunction"===(t.displayName||t.name))},e.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,v):(e.__proto__=v,l(e,o,"GeneratorFunction")),e.prototype=Object.create(b),e},e.awrap=function(e){return{__await:e}},C(k.prototype),l(k.prototype,r,(function(){return this})),e.AsyncIterator=k,e.async=function(t,i,n,a,s){void 0===s&&(s=Promise);var r=new k(c(t,i,n,a),s);return e.isGeneratorFunction(i)?r:r.next().then((function(e){return e.done?e.value:r.next()}))},C(b),l(b,o,"Generator"),l(b,s,(function(){return this})),l(b,"toString",(function(){return"[object Generator]"})),e.keys=function(e){var t=Object(e),i=[];for(var n in t)i.push(n);return i.reverse(),function e(){for(;i.length;){var n=i.pop();if(n in t)return e.value=n,e.done=!1,e}return e.done=!0,e}},e.values=P,T.prototype={constructor:T,reset:function e(t){if(this.prev=0,this.next=0,this.sent=this._sent=undefined,this.done=!1,this.delegate=null,this.method="next",this.arg=undefined,this.tryEntries.forEach(I),!t)for(var n in this)"t"===n.charAt(0)&&i.call(this,n)&&!isNaN(+n.slice(1))&&(this[n]=undefined)},stop:function e(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function e(t){if(this.done)throw t;var n=this;function a(e,i){return o.type="throw",o.arg=t,n.next=e,i&&(n.method="next",n.arg=undefined),!!i}for(var s=this.tryEntries.length-1;s>=0;--s){var r=this.tryEntries[s],o=r.completion;if("root"===r.tryLoc)return a("end");if(r.tryLoc<=this.prev){var l=i.call(r,"catchLoc"),c=i.call(r,"finallyLoc");if(l&&c){if(this.prev<r.catchLoc)return a(r.catchLoc,!0);if(this.prev<r.finallyLoc)return a(r.finallyLoc)}else if(l){if(this.prev<r.catchLoc)return a(r.catchLoc,!0)}else{if(!c)throw new Error("try statement without catch or finally");if(this.prev<r.finallyLoc)return a(r.finallyLoc)}}}},abrupt:function e(t,n){for(var a=this.tryEntries.length-1;a>=0;--a){var s=this.tryEntries[a];if(s.tryLoc<=this.prev&&i.call(s,"finallyLoc")&&this.prev<s.finallyLoc){var r=s;break}}r&&("break"===t||"continue"===t)&&r.tryLoc<=n&&n<=r.finallyLoc&&(r=null);var o=r?r.completion:{};return o.type=t,o.arg=n,r?(this.method="next",this.next=r.finallyLoc,d):this.complete(o)},complete:function e(t,i){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&i&&(this.next=i),d},finish:function e(t){for(var i=this.tryEntries.length-1;i>=0;--i){var n=this.tryEntries[i];if(n.finallyLoc===t)return this.complete(n.completion,n.afterLoc),I(n),d}},catch:function e(t){for(var i=this.tryEntries.length-1;i>=0;--i){var n=this.tryEntries[i];if(n.tryLoc===t){var a=n.completion;if("throw"===a.type){var s=a.arg;I(n)}return s}}throw new Error("illegal catch attempt")},delegateYield:function e(t,i,n){return this.delegate={iterator:P(t),resultName:i,nextLoc:n},"next"===this.method&&(this.arg=undefined),d}},e}function nu(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function au(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?nu(Object(i),!0).forEach((function(t){babelHelpers.defineProperty(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):nu(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}function su(e,t){ou(e,t);t.add(e)}function ru(e,t,i){ou(e,t);t.set(e,i)}function ou(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}function lu(e,t,i){if(!t.has(e)){throw new TypeError("attempted to get private field on non-instance")}return i}var cu={invite:"im.call.invite",cancel:"im.call.cancel",answer:"im.call.answer",decline:"im.call.decline",hangup:"im.call.hangup",ping:"im.call.ping",negotiationNeeded:"im.call.negotiationNeeded",connectionOffer:"im.call.connectionOffer",connectionAnswer:"im.call.connectionAnswer",iceCandidate:"im.call.iceCandidate"};var uu={ping:"Call::ping",answer:"Call::answer",negotiationNeeded:"Call::negotiationNeeded",connectionOffer:"Call::connectionOffer",connectionAnswer:"Call::connectionAnswer",iceCandidate:"Call::iceCandidate",voiceStarted:"Call::voiceStarted",voiceStopped:"Call::voiceStopped",commonRecordState:"Call::commonRecordState",microphoneState:"Call::microphoneState",cameraState:"Call::cameraState",videoPaused:"Call::videoPaused",customMessage:"Call::customMessage",hangup:"Call::hangup",userInviteTimeout:"Call::userInviteTimeout"};var du={offerToReceiveVideo:true,offerToReceiveAudio:true};var hu=3e4;var pu=1e4;var vu=5e3;var fu=25e3;var mu=5500;var gu=new WeakMap;var bu=new WeakSet;var Cu=new WeakSet;var ku=new WeakSet;var yu=new WeakSet;var Su=new WeakSet;var wu=new WeakSet;var Iu=new WeakSet;var Tu=new WeakSet;var Pu=new WeakSet;var _u=new WeakSet;var Eu=new WeakSet;var Ru=new WeakSet;var Mu=new WeakSet;var Au=new WeakSet;var Lu=new WeakSet;var Bu=new WeakSet;var Du=new WeakSet;var Hu=new WeakSet;var Nu=new WeakSet;var xu=new WeakSet;var Ou=new WeakSet;var Uu=new WeakSet;var Fu=new WeakSet;var Vu=new WeakSet;var Gu=new WeakSet;var Wu=new WeakSet;var Xu=new WeakSet;var zu=new WeakSet;var ju=function(e){babelHelpers.inherits(t,e);function t(e){var i;babelHelpers.classCallCheck(this,t);i=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this,e));su(babelHelpers.assertThisInitialized(i),zu);su(babelHelpers.assertThisInitialized(i),Xu);su(babelHelpers.assertThisInitialized(i),Wu);su(babelHelpers.assertThisInitialized(i),Gu);su(babelHelpers.assertThisInitialized(i),Vu);su(babelHelpers.assertThisInitialized(i),Fu);su(babelHelpers.assertThisInitialized(i),Uu);su(babelHelpers.assertThisInitialized(i),Ou);su(babelHelpers.assertThisInitialized(i),xu);su(babelHelpers.assertThisInitialized(i),Nu);su(babelHelpers.assertThisInitialized(i),Hu);su(babelHelpers.assertThisInitialized(i),Du);su(babelHelpers.assertThisInitialized(i),Bu);su(babelHelpers.assertThisInitialized(i),Lu);su(babelHelpers.assertThisInitialized(i),Au);su(babelHelpers.assertThisInitialized(i),Mu);su(babelHelpers.assertThisInitialized(i),Ru);su(babelHelpers.assertThisInitialized(i),Eu);su(babelHelpers.assertThisInitialized(i),_u);su(babelHelpers.assertThisInitialized(i),Pu);su(babelHelpers.assertThisInitialized(i),Tu);su(babelHelpers.assertThisInitialized(i),Iu);su(babelHelpers.assertThisInitialized(i),wu);su(babelHelpers.assertThisInitialized(i),Su);su(babelHelpers.assertThisInitialized(i),yu);su(babelHelpers.assertThisInitialized(i),ku);su(babelHelpers.assertThisInitialized(i),Cu);su(babelHelpers.assertThisInitialized(i),bu);ru(babelHelpers.assertThisInitialized(i),gu,{writable:true,value:void 0});babelHelpers.defineProperty(babelHelpers.assertThisInitialized(i),"setVideoEnabled",(function(e){if(i.videoEnabled==e.data.isCameraOn){return}i.videoEnabled=e.data.isCameraOn;var t=i.localStreams["main"]&&i.localStreams["main"].getVideoTracks().length>0;if(i.ready&&t!==i.videoEnabled){if(!i.videoEnabled){ae.stopStream(ge.Camera)}i.replaceLocalMediaStream().then((function(){i.signaling.sendCameraState(i.users,i.videoEnabled)}))["catch"]((function(){i.runCallback(Ac.onLocalMediaReceived,{tag:"main",stream:i.localStreams["main"]||new MediaStream})}))}}));babelHelpers.defineProperty(babelHelpers.assertThisInitialized(i),"setMuted",(function(e){if(i.muted==e.data.isMicrophoneMuted){return}i.muted=e.data.isMicrophoneMuted;if(i.localStreams["main"]){var t=i.localStreams["main"].getAudioTracks();if(t[0]){t[0].enabled=!i.muted}}i.signaling.sendMicrophoneState(i.users,!i.muted);i.sendTalkingState()}));i.callFromMobile=e.callFromMobile;i.state=e.state||"";i.peers=i.initPeers(i.users);i.signaling=new wd({call:babelHelpers.assertThisInitialized(i)});i.deviceList=[];i.turnServer=BX.message("turn_server");i.turnServerLogin=BX.message("turn_server_login")||"bitrix";i.turnServerPassword=BX.message("turn_server_password")||"bitrix";i.pingUsersInterval=setInterval(i.pingUsers.bind(babelHelpers.assertThisInitialized(i)),vu);i.pingBackendInterval=setInterval(i.pingBackend.bind(babelHelpers.assertThisInitialized(i)),fu);i.reinviteTimeout=null;i.userData=e.userData;i._onUnloadHandler=lu(babelHelpers.assertThisInitialized(i),Wu,bd).bind(babelHelpers.assertThisInitialized(i));i._onOnlineHandler=lu(babelHelpers.assertThisInitialized(i),Xu,Cd).bind(babelHelpers.assertThisInitialized(i));i.enableMicAutoParameters=e.enableMicAutoParameters!==false;i.microphoneLevelInterval=null;i.mediaMutedBySystem=false;i._reconnectionEventCount=0;babelHelpers.classPrivateFieldSet(babelHelpers.assertThisInitialized(i),gu,r.DesktopApi.isDesktop()||false);i.isCloudRecordActive=false;i._isCopilotActive=false;i._isCopilotFeaturesEnabled=false;i._isBoostExpired=false;window.addEventListener("unload",i._onUnloadHandler);window.addEventListener("online",i._onOnlineHandler);return i}babelHelpers.createClass(t,[{key:"initPeers",value:function e(t){var i={};for(var n=0;n<t.length;n++){var a=Number(t[n]);if(a==this.userId){continue}i[a]=this.createPeer(a)}return i}},{key:"createPeer",value:function e(t){var i=this;return new Od({call:this,userId:t,ready:t==this.initiatorId,signalingConnected:t==this.initiatorId,isLegacyMobile:t==this.initiatorId&&this.callFromMobile,onMediaReceived:function e(t){i.runCallback(Ac.onRemoteMediaReceived,t)},onMediaStopped:function e(t){i.runCallback(Ac.onRemoteMediaStopped,t)},onStateChanged:lu(this,Uu,vd).bind(this),onInviteTimeout:lu(this,Fu,fd).bind(this),onRTCStatsReceived:lu(this,Vu,md).bind(this),onRTCQualityChanged:lu(this,Gu,gd).bind(this),onNetworkProblem:function e(t){i.runCallback(Ac.onNetworkProblem,t)},onReconnecting:function e(t){i._reconnectionEventCount++;i.runCallback(Ac.onReconnecting,{reconnectionEventCount:i._reconnectionEventCount,reconnectionReason:t.reconnectionReason,reconnectionReasonInfo:t.reconnectionReasonInfo})},onReconnected:function e(){i._reconnectionEventCount=0;i.runCallback(Ac.onReconnected)},onUpdateLastUsedCameraId:function e(){i.runCallback(Ac.onUpdateLastUsedCameraId)}})}},{key:"getUsers",value:function e(){var t={};for(var i in this.peers){t[i]=this.peers[i].calculatedState}return t}},{key:"isReady",value:function e(){return this.ready}},{key:"canChangeMediaDevices",value:function e(){return!this.mediaMutedBySystem}},{key:"setCameraId",value:function e(t){if(this.cameraId==t){return}this.cameraId=t;if(this.ready&&this.mediaMutedBySystem){this.runCallback(Ac.onNeedResetMediaDevicesState);this.changedMediaMutedBySystem(false)}else if(this.ready&&H.isCameraOn){this.runCallback("onUpdateLastUsedCameraId");p.Runtime.debounce(this.replaceLocalMediaStream,100,this)()}}},{key:"setMicrophoneId",value:function e(t){if(this.microphoneId==t){return}this.microphoneId=t;if(this.ready){if(this.mediaMutedBySystem){return}p.Runtime.debounce(this.replaceLocalAudioStream,100,this)()}}},{key:"getCurrentMicrophoneId",value:function e(){if(!this.localStreams["main"]){return this.microphoneId}var t=this.localStreams["main"].getAudioTracks();if(t.length>0){var i=t[0].getSettings();return i.deviceId}else{return this.microphoneId}}},{key:"useHdVideo",value:function e(t){this.videoHd=t===true}},{key:"sendLocalRecordState",value:function e(t){if(!this.updateCommonRecordState(au(au({},t),{},{senderId:this.userId}))){return}var i=[this.userId].concat(babelHelpers.toConsumableArray(this.users));this.signaling.sendLocalRecordState(i,this.commonRecordState)}},{key:"stopSendingStream",value:function e(t){}},{key:"allowVideoFrom",value:function e(t){}},{key:"inviteUsers",value:function e(){var t=this;var i=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};var n=p.Type.isArray(i.users)?i.users:Object.keys(this.peers);this.ready=true;if(i.localStream instanceof MediaStream&&!this.localStreams["main"]){this.localStreams["main"]=i.localStream}this.getLocalMediaStream("main",true).then((function(){if(!t.ready){lu(t,zu,kd).call(t);return}t.subscribeHardwareChanges();return t.signaling.inviteUsers({userIds:n,video:H.isCameraOn?"Y":"N"})})).then((function(){t.state=kc.Connected;t.runCallback(Ac.onJoin,{local:true});for(var e=0;e<n.length;e++){var i=Number(n[e]);if(!t.peers[i]){t.peers[i]=t.createPeer(i);t.runCallback(Ac.onUserInvited,{userId:i})}t.peers[i].onInvited();t.scheduleRepeatInvite()}}))["catch"]((function(e){console.error(e);t.unsubscribeHardwareChanges();t.runCallback(Ac.onCallFailure,e)}))}},{key:"scheduleRepeatInvite",value:function e(){clearTimeout(this.reinviteTimeout);this.reinviteTimeout=setTimeout(this.repeatInviteUsers.bind(this),mu)}},{key:"repeatInviteUsers",value:function e(){var t=this;clearTimeout(this.reinviteTimeout);if(!this.ready){return}var i=[];for(var n in this.peers){if(this.peers.hasOwnProperty(n)&&this.peers[n].calculatedState===yc.Calling){i.push(n)}}if(i.length===0){return}this.signaling.inviteUsers({userIds:i,video:H.isCameraOn?"Y":"N",repeated:"Y"}).then((function(){return t.scheduleRepeatInvite()}))}},{key:"subscribeHardwareChanges",value:function e(){H.subscribe(H.Events.onChangeMicrophoneMuted,this.setMuted);H.subscribe(H.Events.onChangeCameraOn,this.setVideoEnabled)}},{key:"unsubscribeHardwareChanges",value:function e(){H.unsubscribe(H.Events.onChangeMicrophoneMuted,this.setMuted);H.unsubscribe(H.Events.onChangeCameraOn,this.setVideoEnabled)}},{key:"getMediaConstraints",value:function e(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};var i={};var n=t.videoEnabled?{}:false;var a=!!t.hdVideo;var s=navigator.mediaDevices.getSupportedConstraints?navigator.mediaDevices.getSupportedConstraints():{};if(this.microphoneId){i.deviceId={exact:this.microphoneId}}if(!this.enableMicAutoParameters){if(s.echoCancellation){i.echoCancellation=false}if(s.noiseSuppression){i.noiseSuppression=false}if(s.autoGainControl){i.autoGainControl=false}}if(n){if(this.cameraId){n.deviceId={exact:this.cameraId}}if(a){n.width={ideal:1280};n.height={ideal:720}}}return{audio:i,video:n}}},{key:"getUserMedia",value:function(){var e=babelHelpers.asyncToGenerator(iu().mark((function e(t){var i;return iu().wrap((function e(n){while(1)switch(n.prev=n.next){case 0:i=t[0];n.prev=1;n.next=4;return ae.getUserMedia(i);case 4:return n.abrupt("return",n.sent);case 7:n.prev=7;n.t0=n["catch"](1);this.log("getUserMedia error: ",n.t0);this.log("Current constraints",i);if(!(t.length>1)){n.next=13;break}return n.abrupt("return",this.getUserMedia(t.slice(1)));case 13:this.log("Last fallback constraints used, failing");throw n.t0;case 15:case"end":return n.stop()}}),e,this,[[1,7]])})));function t(t){return e.apply(this,arguments)}return t}()},{key:"getLocalMediaStream",value:function e(t,i){var n=this;if(!p.Type.isStringFilled(t)){t="main"}if(this.localStreams[t]){this.runCallback(Ac.onLocalMediaReceived,{tag:t,stream:this.localStreams[t]});return Promise.resolve(this.localStreams[t])}this.log("Requesting access to media devices");return new Promise((function(e,a){var s=[];if(H.isCameraOn){s.push(n.getMediaConstraints({videoEnabled:true,hdVideo:true}));s.push(n.getMediaConstraints({videoEnabled:true,hdVideo:false}));if(i){s.push(n.getMediaConstraints({videoEnabled:false}))}}else{s.push(n.getMediaConstraints({videoEnabled:false}))}n.getUserMedia(s).then((function(i){n.log("Local media stream received");var a=i.clone();n.localStreams[t]=a;a.getVideoTracks().forEach((function(e){e.addEventListener("ended",(function(){return n.onLocalVideoTrackEnded()}));e.addEventListener("mute",(function(){return n.onLocalVideoTrackMute()}));e.addEventListener("unmute",(function(){return n.onLocalVideoTrackUnmute()}))}));a.getAudioTracks().forEach((function(e){e.addEventListener("ended",(function(){return n.onLocalAudioTrackEnded()}))}));n.runCallback(Ac.onLocalMediaReceived,{tag:t,stream:a});n.setPublishingState(ge.Camera,true);if(t==="main"){n.attachVoiceDetection();if(H.isMicrophoneMuted){var s=a.getAudioTracks();if(s[0]){s[0].enabled=false}}}if(n.deviceList.length===0){H.getCurrentDeviceList().then((function(e){n.deviceList=e;n.runCallback(Ac.onDeviceListUpdated,{deviceList:n.deviceList})}))}e(n.localStreams[t])}))["catch"]((function(e){n.log("Could not get local media stream.",e);n.log("Request constraints: .",s);n.runCallback("onLocalMediaError",{tag:t,error:e});a(e)}))}))}},{key:"getLocalAudioStream",value:function e(t,i){var n=this;if(!p.Type.isStringFilled(t)){t="main"}if(this.localStreams[t]&&this.localStreams[t].getAudioTracks().length){return Promise.resolve(this.localStreams[t])}this.log("Requesting access to audio devices");return new Promise((function(e,i){var a=[n.getMediaConstraints({videoEnabled:false})];n.getUserMedia(a).then((function(i){n.log("Local audio stream received");if(!n.localStreams[t]){n.localStreams[t]=new MediaStream}n.localStreams[t].addTrack(i.getAudioTracks()[0]);i.getAudioTracks().forEach((function(e){e.addEventListener("ended",(function(){return n.onLocalAudioTrackEnded()}))}));if(t==="main"){n.attachVoiceDetection();if(n.muted){var a=i.getAudioTracks();if(a[0]){a[0].enabled=false}}}if(n.deviceList.length===0){H.getCurrentDeviceList().then((function(e){n.deviceList=e;n.runCallback(Ac.onDeviceListUpdated,{deviceList:n.deviceList})}))}e(n.localStreams[t])}))["catch"]((function(e){n.log("Could not get local audio stream.",e);n.log("Request constraints: .",a);n.runCallback("onLocalMediaError",{tag:t,error:e});i(e)}))}))}},{key:"setPublishingState",value:function e(t,i){if(t===ge.Camera){this.runCallback(Ac.onCameraPublishing,{publishing:i})}else if(t===ge.Microphone){this.runCallback(Ac.onMicrophonePublishing,{publishing:i})}}},{key:"startMediaCapture",value:function e(){return this.getLocalMediaStream()}},{key:"attachVoiceDetection",value:function e(){if(this.voiceDetection){this.voiceDetection.destroy()}if(this.microphoneLevelInterval){clearInterval(this.microphoneLevelInterval)}try{this.voiceDetection=new ds({mediaStream:this.localStreams["main"],onVoiceStarted:this.onLocalVoiceStarted.bind(this),onVoiceStopped:this.onLocalVoiceStopped.bind(this)});this.microphoneLevelInterval=setInterval(function(){this.microphoneLevel=this.voiceDetection.currentVolume}.bind(this),200)}catch(e){this.log("Could not attach voice detection to media stream")}}},{key:"getDisplayMedia",value:function e(){return new Promise((function(e,t){ae.getUserScreen().then((function(t){e(t)}))["catch"]((function(e){t(e)}))}))}},{key:"startScreenSharing",value:function e(t){var i=this;t=!!t;if(this.localStreams["screen"]&&!t){return}this.waitingLocalScreenShare=true;this.getDisplayMedia().then((function(e){var t;i.localStreams["screen"]=e;e.getVideoTracks().forEach((function(e){e.addEventListener("ended",(function(){return i.stopScreenSharing()}))}));i.runCallback(Ac.onUserScreenState,{userId:i.userId,screenState:true});i.runCallback(Ac.onLocalScreenUpdated,{track:((t=e.getVideoTracks())===null||t===void 0?void 0:t[0])||null});if(i.ready){for(var n in i.peers){if(i.peers[n].calculatedState===yc.Connected){i.peers[n].sendMedia()}}}}))["catch"]((function(e){i.log(e)}))["finally"]((function(){i.waitingLocalScreenShare=false}))}},{key:"onLocalVideoTrackEnded",value:function e(){if(!this.localStreams["main"]){return}Yf.stopMediaStreamVideoTracks(this.localStreams["main"]);this.runCallback(Ac.onLocalMediaReceived,{tag:"main",stream:this.localStreams["main"]});if(!this.localStreams["main"].getAudioTracks().length){this.localStreams["main"]=null}for(var t in this.peers){if(this.peers[t].calculatedState===yc.Connected){this.peers[t].sendMedia()}}}},{key:"onLocalAudioTrackEnded",value:function e(){if(!this.localStreams["main"]){return}Yf.stopMediaStreamAudioTracks(this.localStreams["main"]);this.runCallback(Ac.onLocalMediaReceived,{tag:"main",stream:this.localStreams["main"]});if(!this.localStreams["main"].getVideoTracks().length){this.localStreams["main"]=null}for(var t in this.peers){if(this.peers[t].calculatedState===yc.Connected){this.peers[t].sendMedia()}}}},{key:"onLocalVideoTrackMute",value:function e(){this.changedMediaMutedBySystem(true);this.prevMainStream=this.localStreams["main"];if(this.ready){this.localStreams["main"]=null;for(var t in this.peers){if(this.peers[t].isReady()){this.peers[t].replaceMediaStream("main")}}}}},{key:"onLocalVideoTrackUnmute",value:function e(){var t=this;this.changedMediaMutedBySystem(false);if(this.prevMainStream){Yf.stopMediaStream(this.prevMainStream);this.prevMainStream=null}this.replaceLocalMediaStream()["catch"]((function(){t.runCallback(Ac.onLocalMediaReceived,{tag:"main",stream:t.localStreams["main"]||new MediaStream})}))}},{key:"changedMediaMutedBySystem",value:function e(t){this.mediaMutedBySystem=t;var i=t?false:!H.isMicrophoneMuted;var n=t?false:H.isCameraOn;this.signaling.sendMicrophoneState(this.users,i);this.signaling.sendCameraState(this.users,n)}},{key:"stopScreenSharing",value:function e(){var t="screen";var i=this.localStreams[t];if(!i){return}Yf.stopMediaStream(i);ae.stopStream(ge.Screen);ae.stopStream(ge.ScreenAudio);this.localStreams[t]=null;this.runCallback(Ac.onUserScreenState,{userId:this.userId,screenState:false});this.runCallback(Ac.onLocalScreenUpdated,{track:null});for(var n in this.peers){if(this.peers[n].calculatedState===yc.Connected){this.peers[n].sendMedia()}}}},{key:"isScreenSharingStarted",value:function e(){return this.localStreams["screen"]instanceof MediaStream||this.waitingLocalScreenShare}},{key:"onLocalVoiceStarted",value:function e(){this.talking=true;this.sendTalkingState()}},{key:"onLocalVoiceStopped",value:function e(){this.talking=false;this.sendTalkingState()}},{key:"sendTalkingState",value:function e(){if(this.talking&&!H.isMicrophoneMuted){this.runCallback(Ac.onUserVoiceStarted,{userId:this.userId,local:true});this.signaling.sendVoiceStarted({userId:this.users})}else{this.runCallback(Ac.onUserVoiceStopped,{userId:this.userId,local:true});this.signaling.sendVoiceStopped({userId:this.users})}}},{key:"sendCustomMessage",value:function e(t){this.signaling.sendCustomMessage({userId:this.users,message:t})}},{key:"answer",value:function e(t){var i=this;if(!p.Type.isPlainObject(t)){t={}}this.ready=true;this.videoEnabled=H.isCameraOn;this.muted=H.isMicrophoneMuted;this.enableMicAutoParameters=t.enableMicAutoParameters!==false;if(t.localStream instanceof MediaStream){this.localStreams["main"]=t.localStream}return new Promise((function(e,t){i.getLocalMediaStream("main",true).then((function(){if(!i.ready){lu(i,zu,kd).call(i);return}i.subscribeHardwareChanges();i.state=kc.Connected;i.runCallback(Ac.onJoin,{local:true});return i.sendAnswer()})).then((function(){return e()}))["catch"]((function(e){i.runCallback(Ac.onCallFailure,e);t(e)}))}))}},{key:"sendAnswer",value:function e(){this.signaling.sendAnswer()}},{key:"decline",value:function e(t,i){var n=this;this.ready=false;var a={callId:this.id,callInstanceId:this.instanceId};if(typeof t!="undefined"){a.code=t}if(typeof i!="undefined"){a.reason=i}tu.getRestClient().callMethod(cu.decline,a).then((function(){n.destroy()}))}},{key:"hangup",value:function e(){var t=this;var i=arguments.length>0&&arguments[0]!==undefined?arguments[0]:false;if(!this.ready&&!i){var n=new Error("Hangup in wrong state");this.log(n);return Promise.reject(n)}var a=new Error;a.name="Call stack:";this.log("Hangup received \n"+a.stack);this.ready=false;this.state=kc.Proceeding;return new Promise((function(e,i){for(var n in t.peers){t.peers[n].disconnect()}lu(t,zu,kd).call(t);t.runCallback(Ac.onLeave,{local:true});t.signaling.sendHangup({userId:t.users}).then((function(){return e()}))["catch"]((function(e){return i(e)}))}))}},{key:"pingUsers",value:function e(){if(this.ready){this.signaling.sendPingToUsers({userId:this.users.concat(this.userId)})}}},{key:"pingBackend",value:function e(){if(this.ready){this.signaling.sendPingToBackend()}}},{key:"getState",value:function e(){}},{key:"replaceLocalMediaStream",value:function e(){var t=this;var i=arguments.length>0&&arguments[0]!==undefined?arguments[0]:"main";this.setPublishingState(ge.Camera,true);if(this.localStreams[i]){Yf.stopMediaStream(this.localStreams[i]);this.localStreams[i]=null}return new Promise((function(e,n){t.getLocalMediaStream(i).then((function(){if(t.ready){for(var n in t.peers){if(t.peers[n].isReady()){t.peers[n].replaceMediaStream(i);if(t.mediaMutedBySystem){t.changedMediaMutedBySystem(false)}}}}e()}))["catch"]((function(e){console.error("Could not get access to hardware; don't really know what to do. error:",e);n(e)}))}))}},{key:"replaceLocalAudioStream",value:function e(){var t=this;var i=arguments.length>0&&arguments[0]!==undefined?arguments[0]:"main";if(this.localStreams[i]){Yf.stopMediaStreamAudioTracks(this.localStreams[i])}return new Promise((function(e,n){t.getLocalAudioStream(i).then((function(){if(t.ready){for(var n in t.peers){if(t.peers[n].isReady()){t.peers[n].replaceMediaStream(i)}}}e()}))["catch"]((function(e){console.error("Could not get access to hardware; don't really know what to do. error:",e);n(e)}))}))}},{key:"sendAllStreams",value:function e(t){if(!this.peers[t]){return}if(!this.peers[t].isReady()){return}for(var i in this.localStreams){if(this.localStreams[i]){this.peers[t].sendMedia()}}}},{key:"isAnyoneParticipating",value:function e(){for(var t in this.peers){if(this.peers[t].isParticipating()){return true}}return false}},{key:"getParticipatingUsers",value:function e(){var t=[];for(var i in this.peers){if(this.peers[i].isParticipating()){t.push(i)}}return t}},{key:"addJoinedUsers",value:function e(t){for(var i=0;i<t.length;i++){var n=Number(t[i]);if(n==this.userId||this.peers[n]){continue}this.peers[n]=this.createPeer(n);if(!this.users.includes(n)){this.users.push(n)}}}},{key:"addInvitedUsers",value:function e(t){for(var i=0;i<t.length;i++){var n=Number(t[i]);if(n==this.userId){continue}if(!this.peers[n]){this.peers[n]=this.createPeer(n);this.runCallback(Ac.onUserInvited,{userId:n})}if(this.peers[n].calculatedState!==yc.Calling){this.peers[n].onInvited()}if(!this.users.includes(n)){this.users.push(n)}}}},{key:"__onPullEvent",value:function e(t,i,n){var a={"Call::answer":lu(this,yu,Ju).bind(this),"Call::hangup":lu(this,wu,Zu).bind(this),"Call::ping":lu(this,Iu,$u).bind(this),"Call::negotiationNeeded":lu(this,Tu,ed).bind(this),"Call::connectionOffer":lu(this,Pu,td).bind(this),"Call::connectionAnswer":lu(this,_u,id).bind(this),"Call::iceCandidate":lu(this,Eu,nd).bind(this),"Call::voiceStarted":lu(this,Ru,ad).bind(this),"Call::voiceStopped":lu(this,Mu,sd).bind(this),"Call::microphoneState":lu(this,Au,rd).bind(this),"Call::cameraState":lu(this,Lu,od).bind(this),"Call::videoPaused":lu(this,Bu,ld).bind(this),"Call::commonRecordState":lu(this,Du,cd).bind(this),"Call::usersJoined":lu(this,bu,qu).bind(this),"Call::usersInvited":lu(this,Cu,Yu).bind(this),"Call::userInviteTimeout":lu(this,ku,Qu).bind(this),"Call::associatedEntityReplaced":lu(this,Hu,ud).bind(this),"Call::finish":lu(this,Nu,dd).bind(this),"Call::repeatAnswer":lu(this,xu,hd).bind(this),"Call::customMessage":lu(this,Ou,pd).bind(this)};if(a[t]){if(t==="Call::ping"){if(i.senderId!=this.userId||i.instanceId!=this.instanceId){this.log("Signaling: ping from user "+i.senderId)}}else{this.log("Signaling: "+t+"; Parameters: "+JSON.stringify(i))}a[t].call(this,i)}}},{key:"destroy",value:function e(){this.ready=false;var i=new Error;i.name="Call stack:";this.log("Call destroy \n"+i.stack);for(var n in this.peers){if(this.peers[n]){this.peers[n].destroy()}}lu(this,zu,kd).call(this);this.runCallback(Ac.onLeave,{local:true});return babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"destroy",this).call(this)}},{key:"provider",get:function e(){return Tc.Plain}},{key:"isCopilotActive",get:function e(){return this._isCopilotActive},set:function e(t){if(t!==this._isCopilotActive){this._isCopilotActive=t}}},{key:"isBoostExpired",get:function e(){return this._isBoostExpired},set:function e(t){if(t!==this._isBoostExpired){this._isBoostExpired=t}}},{key:"isCopilotFeaturesEnabled",get:function e(){return this._isCopilotFeaturesEnabled},set:function e(t){if(t!==this._isCopilotFeaturesEnabled){this._isCopilotFeaturesEnabled=t}}},{key:"isCloudRecordFeaturesEnabled",get:function e(){return babelHelpers.classPrivateFieldGet(this,gu)},set:function e(t){if(t!==babelHelpers.classPrivateFieldGet(this,gu)){babelHelpers.classPrivateFieldSet(this,gu,t)}}}]);return t}(Oi);function qu(e){if(!this.ready){return}var t=e.users;this.addJoinedUsers(t)}function Yu(e){if(!this.ready){return}var t=e.users;this.addInvitedUsers(t)}function Qu(e){this.log("__onPullEventUserInviteTimeout",e);var t=e.failedUserId;if(this.peers[t]){this.peers[t].onInviteTimeout(false)}}function Ju(e){var t=Number(e.senderId);if(t==this.userId){return lu(this,Su,Ku).call(this,e)}if(!this.ready){return}if(!this.peers[t]){return}if(this.peers[t].isReady()){this.log("Received answer for user "+t+" in ready state, ignoring");return}this.peers[t].setSignalingConnected(true);this.peers[t].setReady(true);this.peers[t].isLegacyMobile=e.isLegacyMobile===true;if(this.ready){this.sendAllStreams(t)}}function Ku(e){this.runCallback("onGetUserMediaEnded",{});if(e.callInstanceId===this.instanceId){return}if(this.ready){this.log("Received remote self-answer in ready state, ignoring");return}this.log("Call was answered elsewhere");this.runCallback(Ac.onJoin,{local:false})}function Zu(e){var t=e.senderId;if(this.userId==t){if(this.instanceId!=e.callInstanceId){this.runCallback(Ac.onLeave,{local:false})}return}if(!this.peers[t]){return}this.peers[t].disconnect(e.code);this.peers[t].setReady(false);if(e.code==603){this.peers[t].setDeclined(true)}if(!this.isAnyoneParticipating()&&this.ready){this.hangup()}}function $u(e){if(e.callInstanceId==this.instanceId){return}var t=this.peers[e.senderId];if(!t){return}t.setSignalingConnected(true)}function ed(e){if(!this.ready){return}var t=this.peers[e.senderId];if(!t){return}t.setReady(true);if(e.restart){t.reconnect({reconnectionReason:"GOT_PULL_EVENT_NEGOTIATION_NEEDED"})}else{t.onNegotiationNeeded()}}function td(e){if(!this.ready){return}var t=this.peers[e.senderId];if(!t){return}t.setReady(true);t.setUserAgent(e.userAgent);t.setConnectionOffer(e.connectionId,e.sdp,e.tracks)}function id(e){if(!this.ready){return}var t=this.peers[e.senderId];if(!t){return}var i=e.connectionId;t.setUserAgent(e.userAgent);t.setConnectionAnswer(i,e.sdp,e.tracks)}function nd(e){if(!this.ready){return}var t=this.peers[e.senderId];var i;if(!t){return}try{i=e.candidates;for(var n=0;n<i.length;n++){t.addIceCandidate(e.connectionId,i[n])}}catch(e){this.log("Error parsing serialized candidate: ",e)}}function ad(e){this.runCallback(Ac.onUserVoiceStarted,{userId:e.senderId})}function sd(e){this.runCallback(Ac.onUserVoiceStopped,{userId:e.senderId})}function rd(e){this.runCallback(Ac.onUserMicrophoneState,{userId:e.senderId,microphoneState:e.microphoneState})}function od(e){this.runCallback(Ac.onUserCameraState,{userId:e.senderId,cameraState:e.cameraState})}function ld(e){var t=this.peers[e.senderId];if(!t){return}this.runCallback(Ac.onUserVideoPaused,{userId:e.senderId,videoPaused:e.videoPaused});t.holdOutgoingVideo(!!e.videoPaused)}function cd(e){this.runCallback(Ac.onUserCommonRecordState,{userId:e.senderId,commonRecordState:e.commonRecordState})}function ud(e){if(e.call&&e.call.ASSOCIATED_ENTITY){this.associatedEntity=e.call.ASSOCIATED_ENTITY}}function dd(){this.destroy()}function hd(){if(this.ready){this.signaling.sendAnswer({userId:this.userId},true)}}function pd(e){this.runCallback(Ac.onCustomMessage,{message:e.message})}function vd(e){var t=this;this.runCallback(Ac.onUserStateChanged,e);if(e.state==yc.Failed||e.state==yc.Unavailable){if(!this.isAnyoneParticipating()){this.hangup().then(this.destroy.bind(this))["catch"]((function(){t.destroy()}))}}else if(e.state==yc.Connected){this.signaling.sendMicrophoneState(e.userId,!H.isMicrophoneMuted);this.signaling.sendCameraState(e.userId,H.isCameraOn);this.wasConnected=true}}function fd(e){if(!this.ready){return}this.signaling.sendUserInviteTimeout({userId:this.users,failedUserId:e.userId})}function md(e){var t={};var i={};e.stats.forEach((function(e){if(e.type==="inbound-rtp"&&(e.kind==="video"||e.kind==="audio")&&e.source){t[e.source]=e}if(e.type==="outbound-rtp"&&(e.kind==="video"||e.kind==="audio")&&e.source){i[e.source]=e}}));this.runCallback(Ac.onUserStatsReceived,{userId:e.userId,report:t});this.runCallback(Ac.onUserStatsReceived,{userId:this.userId,report:i});this.runCallback(Ac.onRTCStatsReceived,e)}function gd(e){this.runCallback(Ac.onConnectionQualityChanged,{userId:e.userId,score:e.score})}function bd(){if(!this.ready){return}tu.getRestClient().callMethod(cu.hangup,{callId:this.id,callInstanceId:this.instanceId});for(var e in this.peers){this.peers[e].disconnect()}}function Cd(){var e=Object.values(this.peers);e.forEach((function(e){e.reconnect({reconnectionReason:"GOT_ONLINE_EVENT_FROM_BROWSER"})}))}function kd(){this.unsubscribeHardwareChanges();for(var e in this.localStreams){if(this.localStreams[e]){Yf.stopMediaStream(this.localStreams[e]);this.localStreams[e]=null}}if(this.prevMainStream){Yf.stopMediaStream(this.prevMainStream);this.prevMainStream=null}if(this.voiceDetection){this.voiceDetection.destroy();this.voiceDetection=null}window.removeEventListener("unload",this._onUnloadHandler);window.removeEventListener("online",this._onOnlineHandler);clearInterval(this.statsInterval);clearInterval(this.pingUsersInterval);clearInterval(this.pingBackendInterval);clearInterval(this.microphoneLevelInterval);clearTimeout(this.reinviteTimeout)}var yd=new WeakSet;var Sd=new WeakSet;var wd=function(){function e(t){babelHelpers.classCallCheck(this,e);su(this,Sd);su(this,yd);this.call=t.call}babelHelpers.createClass(e,[{key:"isIceTricklingAllowed",value:function e(){return tu.getPullClient().isPublishingSupported()}},{key:"inviteUsers",value:function e(t){return lu(this,Sd,Td).call(this,cu.invite,t)}},{key:"sendAnswer",value:function e(t,i){if(i&&tu.getPullClient().isPublishingSupported()){return lu(this,yd,Id).call(this,uu.answer,t)}else{return lu(this,Sd,Td).call(this,cu.answer,t)}}},{key:"sendConnectionOffer",value:function e(t){if(tu.getPullClient().isPublishingSupported()){return lu(this,yd,Id).call(this,uu.connectionOffer,t)}else{return lu(this,Sd,Td).call(this,cu.connectionOffer,t)}}},{key:"sendConnectionAnswer",value:function e(t){if(tu.getPullClient().isPublishingSupported()){return lu(this,yd,Id).call(this,uu.connectionAnswer,t)}else{return lu(this,Sd,Td).call(this,cu.connectionAnswer,t)}}},{key:"sendIceCandidate",value:function e(t){if(tu.getPullClient().isPublishingSupported()){return lu(this,yd,Id).call(this,uu.iceCandidate,t)}else{return lu(this,Sd,Td).call(this,cu.iceCandidate,t)}}},{key:"sendNegotiationNeeded",value:function e(t){if(tu.getPullClient().isPublishingSupported()){return lu(this,yd,Id).call(this,uu.negotiationNeeded,t)}else{return lu(this,Sd,Td).call(this,cu.negotiationNeeded,t)}}},{key:"sendVoiceStarted",value:function e(t){if(tu.getPullClient().isPublishingSupported()){return lu(this,yd,Id).call(this,uu.voiceStarted,t)}}},{key:"sendVoiceStopped",value:function e(t){if(tu.getPullClient().isPublishingSupported()){return lu(this,yd,Id).call(this,uu.voiceStopped,t)}}},{key:"sendMicrophoneState",value:function e(t,i){if(tu.getPullClient().isPublishingSupported()){return lu(this,yd,Id).call(this,uu.microphoneState,{userId:t,microphoneState:i},0)}}},{key:"sendCameraState",value:function e(t,i){if(tu.getPullClient().isPublishingSupported()){return lu(this,yd,Id).call(this,uu.cameraState,{userId:t,cameraState:i},0)}}},{key:"sendVideoPaused",value:function e(t,i){if(tu.getPullClient().isPublishingSupported()){return lu(this,yd,Id).call(this,uu.videoPaused,{userId:t,videoPaused:i},0)}}},{key:"sendLocalRecordState",value:function e(t,i){if(tu.getPullClient().isPublishingSupported()){lu(this,yd,Id).call(this,uu.commonRecordState,{userId:t,commonRecordState:i},0)}}},{key:"sendPingToUsers",value:function e(t){if(tu.getPullClient().isPublishingEnabled()){lu(this,yd,Id).call(this,uu.ping,t,5)}}},{key:"sendCustomMessage",value:function e(t){if(tu.getPullClient().isPublishingEnabled()){lu(this,yd,Id).call(this,uu.customMessage,t,5)}}},{key:"sendPingToBackend",value:function e(){var t=!tu.getPullClient().isPublishingEnabled();lu(this,Sd,Td).call(this,cu.ping,{retransmit:t})}},{key:"sendUserInviteTimeout",value:function e(t){if(tu.getPullClient().isPublishingEnabled()){lu(this,yd,Id).call(this,uu.userInviteTimeout,t,0)}}},{key:"sendHangup",value:function e(t){if(tu.getPullClient().isPublishingSupported()){lu(this,yd,Id).call(this,uu.hangup,t,3600);t.retransmit=false;return lu(this,Sd,Td).call(this,cu.hangup,t)}else{t.retransmit=true;return lu(this,Sd,Td).call(this,cu.hangup,t)}}}]);return e}();function Id(e,t,i){i=i||5;if(!t.userId){throw new Error("userId is not found in data")}if(!p.Type.isArray(t.userId)){t.userId=[t.userId]}t.callInstanceId=this.call.instanceId;t.senderId=this.call.userId;t.callId=this.call.id;t.requestId=Yf.getUuidv4();if(e=="Call::ping"){this.call.log("Sending p2p signaling event "+e)}else{this.call.log("Sending p2p signaling event "+e+"; "+JSON.stringify(t))}tu.getPullClient().sendMessage(t.userId,"im",e,t,i)}function Td(e,t){if(!p.Type.isPlainObject(t)){t={}}t.callId=this.call.id;t.callInstanceId=this.call.instanceId;t.requestId=Yf.getUuidv4();if(e=="Call::ping"){this.call.log("Sending ajax-based signaling event "+e)}else{this.call.log("Sending ajax-based signaling event "+e+"; "+JSON.stringify(t))}return tu.getRestClient().callMethod(e,t)["catch"]((function(e){console.error(e)}))}var Pd=new WeakSet;var _d=new WeakSet;var Ed=new WeakSet;var Rd=new WeakSet;var Md=new WeakSet;var Ad=new WeakSet;var Ld=new WeakSet;var Bd=new WeakSet;var Dd=new WeakSet;var Hd=new WeakSet;var Nd=new WeakSet;var xd=new WeakSet;var Od=function(){function e(t){babelHelpers.classCallCheck(this,e);su(this,xd);su(this,Nd);su(this,Hd);su(this,Dd);su(this,Bd);su(this,Ld);su(this,Ad);su(this,Md);su(this,Rd);su(this,Ed);su(this,_d);su(this,Pd);this.call=t.call;this.userId=t.userId;this.ready=t.ready===true;this.calling=false;this.inviteTimeout=false;this.declined=false;this.busy=false;this.signalingConnected=t.signalingConnected===true;this.failureReason="";this.userAgent="";this.isFirefox=false;this.isChrome=false;this.isLegacyMobile=t.isLegacyMobile===true;this.lastSuccessedLocaleCandidate="";this.lastSuccessedRemoteCandidate="";this.calculatedState=this.calculateState();this.localStreams={main:null,screen:null};this.pendingIceCandidates={};this.localIceCandidates=[];this.trackList={};this.callbacks={onStateChanged:p.Type.isFunction(t.onStateChanged)?t.onStateChanged:BX.DoNothing,onInviteTimeout:p.Type.isFunction(t.onInviteTimeout)?t.onInviteTimeout:BX.DoNothing,onMediaReceived:p.Type.isFunction(t.onMediaReceived)?t.onMediaReceived:BX.DoNothing,onMediaStopped:p.Type.isFunction(t.onMediaStopped)?t.onMediaStopped:BX.DoNothing,onRTCStatsReceived:p.Type.isFunction(t.onRTCStatsReceived)?t.onRTCStatsReceived:BX.DoNothing,onRTCQualityChanged:p.Type.isFunction(t.onRTCQualityChanged)?t.onRTCQualityChanged:BX.DoNothing,onNetworkProblem:p.Type.isFunction(t.onNetworkProblem)?t.onNetworkProblem:BX.DoNothing,onReconnecting:p.Type.isFunction(t.onReconnecting)?t.onReconnecting:BX.DoNothing,onReconnected:p.Type.isFunction(t.onReconnected)?t.onReconnected:BX.DoNothing,onUpdateLastUsedCameraId:p.Type.isFunction(t.onUpdateLastUsedCameraId)?t.onUpdateLastUsedCameraId:BX.DoNothing};this.answerTimeout=null;this.callingTimeout=null;this.connectionTimeout=null;this.signalingConnectionTimeout=null;this.candidatesTimeout=null;this.statsInterval=null;this.connectionOfferReplyTimeout=null;this.negotiationNeededReplyTimeout=null;this.reconnectAfterDisconnectTimeout=null;this.connectionAttempt=0;this.hasStun=false;this.hasTurn=false;this._outgoingVideoTrack=null;Object.defineProperty(this,"outgoingVideoTrack",{get:function e(){return this._outgoingVideoTrack},set:function e(t){if(this._outgoingVideoTrack){this._outgoingVideoTrack.stop()}this._outgoingVideoTrack=t;if(this._outgoingVideoTrack){this._outgoingVideoTrack.enabled=!this.outgoingVideoHoldState}}});this._outgoingScreenTrack=null;Object.defineProperty(this,"outgoingScreenTrack",{get:function e(){return this._outgoingScreenTrack},set:function e(t){if(this._outgoingScreenTrack){this._outgoingScreenTrack.stop()}this._outgoingScreenTrack=t;if(this._outgoingScreenTrack){this._outgoingScreenTrack.enabled=!this.outgoingVideoHoldState}}});this._incomingAudioTrack=null;this._incomingScreenAudioTrack=null;this._incomingVideoTrack=null;this._incomingScreenTrack=null;Object.defineProperty(this,"incomingAudioTrack",{get:this._mediaGetter("_incomingAudioTrack"),set:this._mediaSetter("_incomingAudioTrack","audio")});Object.defineProperty(this,"incomingVideoTrack",{get:this._mediaGetter("_incomingVideoTrack"),set:this._mediaSetter("_incomingVideoTrack","video")});Object.defineProperty(this,"incomingScreenTrack",{get:this._mediaGetter("_incomingScreenTrack"),set:this._mediaSetter("_incomingScreenTrack","screen")});Object.defineProperty(this,"incomingScreenAudioTrack",{get:this._mediaGetter("_incomingScreenAudioTrack"),set:this._mediaSetter("_incomingScreenAudioTrack","sharingAudio")});this.outgoingVideoHoldState=false;this._onPeerConnectionIceCandidateHandler=this._onPeerConnectionIceCandidate.bind(this);this._onPeerConnectionConnectionStateChangeHandler=lu(this,_d,Fd).bind(this);this._onPeerConnectionIceGatheringStateChangeHandler=lu(this,Ed,Vd).bind(this);this._onPeerConnectionSignalingStateChangeHandler=lu(this,Rd,Gd).bind(this);this._onPeerConnectionTrackHandler=lu(this,Ad,Wd).bind(this);this._onPeerConnectionRemoveStreamHandler=lu(this,Ld,Xd).bind(this);this._updateTracksDebounced=p.Runtime.debounce(lu(this,Nd,Yd).bind(this),50);this._waitTurnCandidatesTimeout=null;this.prevPercentPacketLostList={incomingPacketLost:[],outgoingPacketLost:[]};this.reportsForIncomingTracks={};this.reportsForOutgoingTracks={};this.packetLostThreshold=7;this.videoBitrate=1e6;this.screenShareBitrate=15e5;this.maxConnectionScore=5;this.incomingConnectionScore=0;this.outgoingConnectionScore=0}babelHelpers.createClass(e,[{key:"_mediaGetter",value:function e(t){return function(){return this[t]}.bind(this)}},{key:"_mediaSetter",value:function e(t,i){return function(e){if(this[t]!=e){this[t]=e;if(e){this.callbacks.onMediaReceived({userId:this.userId,kind:i,track:e})}else{this.callbacks.onMediaStopped({userId:this.userId,kind:i})}}}.bind(this)}},{key:"sendMedia",value:function e(t){if(!this.peerConnection){if(!this.isInitiator()){this.log("waiting for the other side to send connection offer");this.sendNegotiationNeeded(false);return}}if(!this.peerConnection){var i=Yf.getUuidv4();lu(this,Pd,Ud).call(this,i)}this.updateOutgoingTracks();if(!t){this.applyResolutionScale();this.createAndSendOffer()}}},{key:"updateOutgoingTracks",value:function e(){var t,i;if(!this.peerConnection){return}var n;var a;var s;var r;if(this.call.localStreams["main"]&&this.call.localStreams["main"].getAudioTracks().length>0&&((t=this.call.localStreams["main"].getAudioTracks()[0])===null||t===void 0?void 0:t.readyState)==="live"){n=this.call.localStreams["main"].getAudioTracks()[0]}if(this.call.localStreams["screen"]&&this.call.localStreams["screen"].getVideoTracks().length>0){s=this.call.localStreams["screen"].getVideoTracks()[0]}if(this.call.localStreams["screen"]&&this.call.localStreams["screen"].getAudioTracks().length>0){r=this.call.localStreams["screen"].getAudioTracks()[0]}if(this.call.localStreams["main"]&&this.call.localStreams["main"].getVideoTracks().length>0&&((i=this.call.localStreams["main"].getVideoTracks()[0])===null||i===void 0?void 0:i.readyState)==="live"){a=this.call.localStreams["main"].getVideoTracks()[0]}this.outgoingVideoTrack=a?a.clone():null;this.outgoingScreenTrack=s?s.clone():null;var o=[];if(n){o.push(n.id+" (audio)")}if(r){o.push(r.id+" (sharingAudio)")}if(a){o.push(a.id+" ("+a.kind+")")}if(s){o.push(s.id+" ("+s.kind+")")}console.log("User: "+this.userId+"; Sending media streams. Tracks: "+o.join("; "));if(this.videoSender&&this.outgoingVideoTrack){this.videoSender.replaceTrack(this.outgoingVideoTrack)}if(!this.videoSender&&this.outgoingVideoTrack){this.videoSender=this.peerConnection.addTrack(this.outgoingVideoTrack)}if(this.videoSender&&!this.outgoingVideoTrack){this.peerConnection.removeTrack(this.videoSender);this.videoSender=null}if(this.screenSender&&this.outgoingScreenTrack){this.screenSender.replaceTrack(this.outgoingScreenTrack)}if(!this.screenSender&&this.outgoingScreenTrack){this.screenSender=this.peerConnection.addTrack(this.outgoingScreenTrack)}if(this.screenSender&&!this.outgoingScreenTrack){this.peerConnection.removeTrack(this.screenSender);this.screenSender=null}if(this.screenAudioSender&&r){this.screenAudioSender.replaceTrack(r)}if(!this.screenAudioSender&&r){this.screenAudioSender=this.peerConnection.addTrack(r)}if(this.screenAudioSender&&!r){this.peerConnection.removeTrack(this.screenAudioSender);this.screenAudioSender=null}if(this.audioSender&&n){this.audioSender.replaceTrack(n)}if(!this.audioSender&&n){this.audioSender=this.peerConnection.addTrack(n)}if(this.audioSender&&!n){this.peerConnection.removeTrack(this.audioSender);this.audioSender=null}}},{key:"getSenderMid",value:function e(t){if(!t||!this.peerConnection){return null}var i=this.peerConnection.getTransceivers().find((function(e){if(e.sender.track&&t.track){return e.sender.track.id===t.track.id}return false}));return i?i.mid:null}},{key:"applyResolutionScale",value:function e(t){if(this.videoSender){var i=t||(this.screenSender?2:1);var n=this.videoBitrate/i;var a=this.videoSender.getParameters();if(a.encodings&&a.encodings.length>0){a.encodings[0].scaleResolutionDownBy=i;a.encodings[0].maxBitrate=n;this.videoSender.setParameters(a)}}if(this.screenSender){var s=this.screenSender.getParameters();if(s.encodings&&s.encodings.length>0){s.encodings[0].maxBitrate=this.screenShareBitrate;this.screenSender.setParameters(s)}}}},{key:"replaceMediaStream",value:function e(t){if(this.isRenegotiationSupported()){this.sendMedia()}else{this.localStreams[t]=this.call.getLocalStream(t);var i="Reconnect by replaceMediaStream";this.reconnect({reconnectionReasonInfo:i})}}},{key:"holdOutgoingVideo",value:function e(t){if(this.outgoingVideoHoldState==t){return}this.outgoingVideoHoldState=t;if(this._outgoingVideoTrack){this._outgoingVideoTrack.enabled=!this.outgoingVideoHoldState}}},{key:"isInitiator",value:function e(){return this.call.userId<this.userId}},{key:"isRenegotiationSupported",value:function e(){return true}},{key:"setReady",value:function e(t){this.ready=t;if(this.ready){this.declined=false;this.busy=false}if(this.calling){clearTimeout(this.callingTimeout);this.calling=false}this.updateCalculatedState()}},{key:"isReady",value:function e(){return this.ready}},{key:"onInvited",value:function e(){this.ready=false;this.inviteTimeout=false;this.declined=false;this.calling=true;if(this.callingTimeout){clearTimeout(this.callingTimeout)}this.callingTimeout=setTimeout(function(){this.onInviteTimeout(true)}.bind(this),3e4);this.updateCalculatedState()}},{key:"onInviteTimeout",value:function e(t){clearTimeout(this.callingTimeout);this.calling=false;this.inviteTimeout=true;if(t){this.callbacks.onInviteTimeout({userId:this.userId})}this.updateCalculatedState()}},{key:"setUserAgent",value:function e(t){this.userAgent=t;this.isFirefox=t.toLowerCase().indexOf("firefox")!=-1;this.isChrome=t.toLowerCase().indexOf("chrome")!=-1;this.isLegacyMobile=t==="Bitrix Legacy Mobile"}},{key:"getUserAgent",value:function e(){return this.userAgent}},{key:"isParticipating",value:function e(){if(this.calling){return true}if(this.declined||this.busy){return false}if(this.peerConnection){var t=this.peerConnection.iceConnectionState;if(t=="checking"||t=="connected"||t=="completed"){return true}}return false}},{key:"setSignalingConnected",value:function e(t){this.signalingConnected=t;this.updateCalculatedState();if(this.signalingConnected){this.refreshSignalingTimeout()}else{this.stopSignalingTimeout()}}},{key:"isSignalingConnected",value:function e(){return this.signalingConnected}},{key:"setDeclined",value:function e(t){this.declined=t;if(this.calling){clearTimeout(this.callingTimeout);this.calling=false}this.updateCalculatedState()}},{key:"setBusy",value:function e(t){this.busy=t;if(this.calling){clearTimeout(this.callingTimeout);this.calling=false}this.updateCalculatedState()}},{key:"isDeclined",value:function e(){return this.declined}},{key:"updateCalculatedState",value:function e(){var t=this.calculateState();if(this.calculatedState!=t){this.callbacks.onStateChanged({userId:this.userId,state:t,previousState:this.calculatedState,isLegacyMobile:this.isLegacyMobile,networkProblem:!this.hasStun||!this.hasTurn});this.calculatedState=t}}},{key:"calculateState",value:function e(){if(this.peerConnection){if(this.failureReason!==""){return yc.Failed}if(this.peerConnection.iceConnectionState==="connected"||this.peerConnection.iceConnectionState==="completed"){return yc.Connected}return yc.Connecting}if(this.calling){return yc.Calling}if(this.inviteTimeout){return yc.Unavailable}if(this.declined){return yc.Declined}if(this.busy){return yc.Busy}if(this.ready){return yc.Ready}return yc.Idle}},{key:"getSignaling",value:function e(){return this.call.signaling}},{key:"startStatisticsGathering",value:function e(){clearInterval(this.statsInterval);this.statsInterval=setInterval(function(){if(!this.peerConnection){return false}this.peerConnection.getStats().then(function(e){var t=this;var i=[];var n={};var a={};var s={};var r={};var o=0;var l=0;e.forEach((function(e){i.push(e);var c=(e===null||e===void 0?void 0:e.trackIdentifier)&&(e===null||e===void 0?void 0:e.type)==="inbound-rtp"&&e.hasOwnProperty("packetsLost")&&e.hasOwnProperty("packetsReceived");if(c||e.type==="outbound-rtp"){switch(t.trackList[e.mid]){case"video":e.source=ge.Camera;break;case"screen":e.source=ge.Screen;break;case"audio":e.source=ge.Microphone;break;default:return}}if(e.type==="candidate-pair"&&e.state==="succeeded"&&e.bytesReceived>0&&e.bytesSent>0&&t.lastSuccessedLocaleCandidateId!==e.localCandidateId&&t.lastSuccessedRemoteCandidateId!==e.remoteCandidateId){t.lastSuccessedLocaleCandidateId=e.localCandidateId;t.lastSuccessedRemoteCandidateId=e.remoteCandidateId;Yf.sendLog({description:"GOT a succeeded candidate-pair for user ".concat(t.userId),localCandidateId:e.localCandidateId,remoteCandidateId:e.remoteCandidateId})}if(c){e.bitrate=Yf.calcBitrate(e,t.reportsForIncomingTracks[e.source]);var u=Yf.calcRemotePacketsLost(e,t.reportsForIncomingTracks[e.source]);e.packetsLostExtended=Yf.formatPacketsLostData(u);if(!Yf.setCodecToReport(e,n,a)){Yf.saveReportWithoutCodecs(e,a)}t.reportsForIncomingTracks[e.source]=e;if(e.source===ge.Camera){o=u.currentPercentPacketLost}}if(e.type==="codec"){Yf.processReportsWithoutCodecs(e,n,a)}if(e.type==="remote-inbound-rtp"){var d=e.localId;if(r[d]){var h=Yf.calcLocalPacketsLost(r[d],t.reportsForOutgoingTracks[d],e);r[d].packetsLostData=h;r[d].packetsLost=h.totalPacketsLost;r[d].packetsLostExtended=Yf.formatPacketsLostData(h);t.reportsForOutgoingTracks[d]=r[d];delete r[d];if(t.reportsForOutgoingTracks[d].source===ge.Camera){l=e.packetsLost}return}s[d]=e}if(e.type==="outbound-rtp"){e.bitrate=Yf.calcBitrate(e,t.reportsForOutgoingTracks[e.id],true);e.userId=t.call.userId;if(!Yf.setCodecToReport(e,n,a)){Yf.saveReportWithoutCodecs(e,a)}if(Yf.setLocalPacketsLostOrSaveReport(e,s,r)){t.reportsForOutgoingTracks[e.id]=e;if(e.source===ge.Camera){l=e.packetsLostData.currentPercentPacketLost}}}}));if(this.prevPercentPacketLostList.incomingPacketLost.push(o)>10){this.prevPercentPacketLostList.incomingPacketLost.shift()}var c=this.prevPercentPacketLostList.incomingPacketLost.reduce((function(e,t){return e+t}),0)/this.prevPercentPacketLostList.incomingPacketLost.length;var u=this.calcNewConnectionScore(c);if(!this.incomingConnectionScore||this.incomingConnectionScore!==u){this.incomingConnectionScore=u;this.callbacks.onRTCQualityChanged({userId:this.userId,score:this.incomingConnectionScore})}if(this.prevPercentPacketLostList.outgoingPacketLost.push(l)>10){this.prevPercentPacketLostList.outgoingPacketLost.shift()}var d=this.prevPercentPacketLostList.outgoingPacketLost.reduce((function(e,t){return e+t}),0)/this.prevPercentPacketLostList.outgoingPacketLost.length;var h=this.calcNewConnectionScore(d);if(!this.outgoingConnectionScore||this.outgoingConnectionScore!==h){this.outgoingConnectionScore=h;this.callbacks.onRTCQualityChanged({userId:this.call.userId,score:this.outgoingConnectionScore})}this.callbacks.onRTCStatsReceived({userId:this.userId,stats:i})}.bind(this))}.bind(this),1e3)}},{key:"calcNewConnectionScore",value:function e(t){var i;if(t<10){i=4}if(t>10&&t<=20){i=3}if(t>20&&t<=30){i=2}if(t>30){i=1}return i}},{key:"stopStatisticsGathering",value:function e(){clearInterval(this.statsInterval);this.statsInterval=null}},{key:"updateCandidatesTimeout",value:function e(){if(this.candidatesTimeout){clearTimeout(this.candidatesTimeout)}this.candidatesTimeout=setTimeout(this.sendIceCandidates.bind(this),500)}},{key:"sendIceCandidates",value:function e(){this.log("User "+this.userId+": sending ICE candidates due to the timeout");this.candidatesTimeout=null;if(this.localIceCandidates.length>0){this.getSignaling().sendIceCandidate({userId:this.userId,connectionId:this.peerConnectionId,candidates:this.localIceCandidates});this.localIceCandidates=[]}else{this.log("User "+this.userId+": ICE candidates pool is empty")}}},{key:"_destroyPeerConnection",value:function e(){if(!this.peerConnection){return}clearTimeout(this.reconnectAfterDisconnectTimeout);this.log("User "+this.userId+": Destroying peer connection "+this.peerConnectionId);this.stopStatisticsGathering();this.peerConnection.removeEventListener("icecandidate",this._onPeerConnectionIceCandidateHandler);this.peerConnection.removeEventListener("connectionstatechange",this._onPeerConnectionConnectionStateChangeHandler);this.peerConnection.removeEventListener("icegatheringstatechange",this._onPeerConnectionIceGatheringStateChangeHandler);this.peerConnection.removeEventListener("signalingstatechange",this._onPeerConnectionSignalingStateChangeHandler);this.peerConnection.removeEventListener("track",this._onPeerConnectionTrackHandler);this.peerConnection.removeEventListener("removestream",this._onPeerConnectionRemoveStreamHandler);this.localIceCandidates=[];if(this.pendingIceCandidates[this.peerConnectionId]){delete this.pendingIceCandidates[this.peerConnectionId]}this.peerConnection.close();this.peerConnection=null;this.peerConnectionId=null;this.videoSender=null;this.audioSender=null;this.screenSender=null;this.screenAudioSender=null;this.incomingAudioTrack=null;this.incomingScreenAudioTrack=null;this.incomingVideoTrack=null;this.incomingScreenTrack=null}},{key:"_onPeerConnectionIceCandidate",value:function e(t){var i=t.candidate;this.log("User "+this.userId+": ICE candidate discovered. Candidate: "+(i?i.candidate:i));if(i){if(this.getSignaling().isIceTricklingAllowed()){this.getSignaling().sendIceCandidate({userId:this.userId,connectionId:this.peerConnectionId,candidates:[i.toJSON()]})}else{this.localIceCandidates.push(i.toJSON());this.updateCandidatesTimeout()}var n=i.candidate.match(/typ\s(\w+)?/);if(n){var a=n[1];if(a=="srflx"){this.hasStun=true}else if(a=="relay"){this.hasTurn=true}}}}},{key:"stopSignalingTimeout",value:function e(){clearTimeout(this.signalingConnectionTimeout)}},{key:"refreshSignalingTimeout",value:function e(){clearTimeout(this.signalingConnectionTimeout);this.signalingConnectionTimeout=setTimeout(lu(this,xd,Qd).bind(this),hu)}},{key:"_onConnectionOfferReplyTimeout",value:function e(t){var i="Did not receive connection answer for connection "+t;this.call.setPublishingState(ge.Camera,false);this.reconnect({reconnectionReasonInfo:i})}},{key:"_onNegotiationNeededReplyTimeout",value:function e(){var t="Did not receive connection offer in time";this.reconnect({reconnectionReasonInfo:t})}},{key:"setConnectionOffer",value:function e(t,i,n){this.log("User "+this.userId+": applying connection offer for connection "+t);clearTimeout(this.negotiationNeededReplyTimeout);this.negotiationNeededReplyTimeout=null;if(!this.call.isReady()){return}if(!this.isReady()){return}if(n){this.trackList=BX.util.array_flip(n)}if(this.peerConnection){if(this.peerConnectionId!==t){this._destroyPeerConnection();lu(this,Pd,Ud).call(this,t)}}else{lu(this,Pd,Ud).call(this,t)}this.applyOfferAndSendAnswer(i)}},{key:"createAndSendOffer",value:function e(t){var i=this;var n=du;for(var a in t){n[a]=t[a]}this.peerConnection.createOffer(n).then((function(e){i.log("User "+i.userId+": Created connection offer.");i.log("Applying local description");return i.peerConnection.setLocalDescription(e)})).then((function(){i.sendOffer()}))}},{key:"sendOffer",value:function e(){var t=this;clearTimeout(this.connectionOfferReplyTimeout);this.connectionOfferReplyTimeout=setTimeout((function(){return t._onConnectionOfferReplyTimeout(t.peerConnectionId)}),pu);this.getSignaling().sendConnectionOffer({userId:this.userId,connectionId:this.peerConnectionId,sdp:this.peerConnection.localDescription.sdp,tracks:{audio:this.getSenderMid(this.audioSender),video:this.getSenderMid(this.videoSender),screen:this.getSenderMid(this.screenSender),sharingAudio:this.getSenderMid(this.screenAudioSender)},userAgent:navigator.userAgent})}},{key:"sendNegotiationNeeded",value:function e(t){var i=this;t=t===true;clearTimeout(this.negotiationNeededReplyTimeout);this.negotiationNeededReplyTimeout=setTimeout((function(){return i._onNegotiationNeededReplyTimeout()}),pu);var n={userId:this.userId};if(t){n.restart=true}this.getSignaling().sendNegotiationNeeded(n)}},{key:"applyOfferAndSendAnswer",value:function e(t){var i=this;var n=new RTCSessionDescription({type:"offer",sdp:t});if(this.pendingRemoteSdpDelay){this.pendingRemoteSdp=t;return}this.log("User: "+this.userId+"; Applying remote offer");this.log("User: "+this.userId+"; Peer ice connection state ",this.peerConnection.iceConnectionState);this.pendingRemoteSdpDelay=true;this.peerConnection.setRemoteDescription(n).then((function(){if(i.peerConnection.iceConnectionState==="new"){i.sendMedia(true)}return i.peerConnection.createAnswer()})).then((function(e){i.log("Created connection answer.");i.log("Applying local description.");return i.peerConnection.setLocalDescription(e)})).then((function(){i.applyResolutionScale();i.applyPendingIceCandidates();i.getSignaling().sendConnectionAnswer({userId:i.userId,connectionId:i.peerConnectionId,sdp:i.peerConnection.localDescription.sdp,tracks:{audio:i.getSenderMid(i.audioSender),video:i.getSenderMid(i.videoSender),screen:i.getSenderMid(i.screenSender),sharingAudio:i.getSenderMid(i.screenAudioSender)},userAgent:navigator.userAgent})}))["catch"]((function(e){i.failureReason=e.toString();i.updateCalculatedState();i.log("Could not apply remote offer",e);console.error("Could not apply remote offer",e)}))["finally"]((function(){var e;i.pendingRemoteSdpDelay=false;if(i.pendingRemoteSdp){i.applyOfferAndSendAnswer(i.pendingRemoteSdp);i.pendingRemoteSdp=null}var t=(e=i.peerConnection)===null||e===void 0?void 0:e.getTransceivers().reduce((function(e,t){return t.mid===null?e:e+1}),0);var n=0;Object.values(i.call.localStreams).forEach((function(e){e===null||e===void 0?void 0:e.getTracks().forEach((function(e){if(e.readyState==="live"){n++}}))}));if(t<n){Object.values(i.call.peers).forEach((function(e){e.sendMedia()}))}}))}},{key:"setConnectionAnswer",value:function e(t,i,n){var a=this;if(!this.peerConnection||this.peerConnectionId!=t){this.log("Could not apply answer, for unknown connection "+t);return}if(this.peerConnection.signalingState!=="have-local-offer"){this.log("Could not apply answer, wrong peer connection signaling state "+this.peerConnection.signalingState);return}if(n){this.trackList=BX.util.array_flip(n)}var s=new RTCSessionDescription({type:"answer",sdp:i});clearTimeout(this.connectionOfferReplyTimeout);this.log("User: "+this.userId+"; Applying remote answer");this.peerConnection.setRemoteDescription(s).then((function(){a.applyPendingIceCandidates()}))["catch"]((function(e){a.failureReason=e.toString();a.updateCalculatedState();a.log(e)}))["finally"]((function(){a.call.setPublishingState(ge.Camera,false)}))}},{key:"addIceCandidate",value:function e(t,i){var n=this;if(!this.peerConnection){return}if(this.peerConnectionId!=t){this.log("Error: Candidate for unknown connection "+t);return}if(this.peerConnection.remoteDescription&&this.peerConnection.remoteDescription.type){this.peerConnection.addIceCandidate(i).then((function(){n.log("User: "+n.userId+"; Added remote ICE candidate: "+(i?i.candidate:i))}))["catch"]((function(e){n.log(e)}))}else{if(!this.pendingIceCandidates[t]){this.pendingIceCandidates[t]=[]}this.pendingIceCandidates[t].push(i)}}},{key:"applyPendingIceCandidates",value:function e(){var t=this;if(!this.peerConnection||!this.peerConnection.remoteDescription.type){return}if(p.Type.isArray(this.pendingIceCandidates[this.peerConnectionId])){this.pendingIceCandidates[this.peerConnectionId].forEach((function(e){t.peerConnection.addIceCandidate(e).then((function(){t.log("User: "+t.userId+"; Added remote ICE candidate: "+(e?e.candidate:e))}))}));this.pendingIceCandidates[this.peerConnectionId]=[]}}},{key:"onNegotiationNeeded",value:function e(){if(this.peerConnection){if(this.peerConnection.signalingState=="have-local-offer"){this.sendOffer()}else{this.createAndSendOffer({iceRestart:true})}}else{this.sendMedia()}}},{key:"reconnect",value:function e(t){clearTimeout(this.reconnectAfterDisconnectTimeout);this.connectionAttempt++;if(this.connectionAttempt>3){this.log("Error: Too many reconnection attempts, giving up");this.failureReason="Could not connect to user in time";this.updateCalculatedState();return}this.callbacks.onReconnecting({reconnectionReason:(t===null||t===void 0?void 0:t.reconnectionReason)||"TRYING_RESTORE_ICE_CONNECTION",reconnectionReasonInfo:(t===null||t===void 0?void 0:t.reconnectionReasonInfo)||""});if(t&&t.reconnectionReasonInfo){this.log(t.reconnectionReasonInfo)}this.log("Trying to restore ICE connection. Attempt "+this.connectionAttempt);if(this.isInitiator()){this._destroyPeerConnection();this.sendMedia()}}},{key:"disconnect",value:function e(){this._destroyPeerConnection();this.outgoingVideoTrack=null;this.outgoingScreenTrack=null;this.outgoingVideoHoldState=false;this.incomingAudioTrack=null;this.incomingScreenAudioTrack=null;this.incomingVideoTrack=null;this.incomingScreenTrack=null}},{key:"log",value:function e(){this.call.log.apply(this.call,arguments)}},{key:"destroy",value:function e(){this.disconnect();if(this.voiceDetection){this.voiceDetection.destroy();this.voiceDetection=null}for(var t in this.localStreams){this.localStreams[t]=null}clearTimeout(this.answerTimeout);this.answerTimeout=null;clearTimeout(this.connectionTimeout);this.connectionTimeout=null;clearTimeout(this.signalingConnectionTimeout);this.signalingConnectionTimeout=null;this.callbacks.onStateChanged=BX.DoNothing;this.callbacks.onMediaReceived=BX.DoNothing;this.callbacks.onMediaStopped=BX.DoNothing}}]);return e}();function Ud(e){this.log("User "+this.userId+": Creating peer connection");var t={iceServers:[{urls:"stun:"+this.call.turnServer},{urls:"turn:"+this.call.turnServer,username:this.call.turnServerLogin,credential:this.call.turnServerPassword}]};this.localIceCandidates=[];this.peerConnection=new RTCPeerConnection(t);this.peerConnectionId=e;this.peerConnection.addEventListener("icecandidate",this._onPeerConnectionIceCandidateHandler);this.peerConnection.addEventListener("connectionstatechange",this._onPeerConnectionConnectionStateChangeHandler);this.peerConnection.addEventListener("icegatheringstatechange",this._onPeerConnectionIceGatheringStateChangeHandler);this.peerConnection.addEventListener("signalingstatechange",this._onPeerConnectionSignalingStateChangeHandler);this.peerConnection.addEventListener("track",this._onPeerConnectionTrackHandler);this.peerConnection.addEventListener("removestream",this._onPeerConnectionRemoveStreamHandler);this.failureReason="";this.hasStun=false;this.hasTurn=false;this.updateCalculatedState();this.startStatisticsGathering()}function Fd(){this.log("User "+this.userId+": peer connection state changed. New state: "+this.peerConnection.connectionState);if(this.peerConnection.connectionState==="connected"||this.peerConnection.connectionState==="completed"){this.connectionAttempt=0;this.callbacks.onReconnected();clearTimeout(this.reconnectAfterDisconnectTimeout);this._updateTracksDebounced()}else if(this.peerConnection.connectionState==="failed"){var e="Peer connection failed. Trying to restore connection immediately";this.reconnect({reconnectionReason:"PEER_CONNECTION_FAILED",reconnectionReasonInfo:e})}this.updateCalculatedState()}function Vd(e){var t=e.target;this.log("User "+this.userId+": ICE gathering state changed to : "+t.iceGatheringState);if(t.iceGatheringState==="complete"){this.log("User "+this.userId+": ICE gathering complete");if(!this.hasStun||!this.hasTurn){var i=[];if(!this.hasTurn){i.push("TURN")}if(!this.hasStun){i.push("STUN")}this.log("Connectivity problem detected: no ICE candidates from "+i.join(" and ")+" servers");console.error("Connectivity problem detected: no ICE candidates from "+i.join(" and ")+" servers");this.callbacks.onNetworkProblem()}if(!this.getSignaling().isIceTricklingAllowed()){if(this.localIceCandidates.length>0){this.getSignaling().sendIceCandidate({userId:this.userId,connectionId:this.peerConnectionId,candidates:this.localIceCandidates});this.localIceCandidates=[]}else{this.log("User "+this.userId+": ICE candidates already sent")}}}}function Gd(){this.log("User "+this.userId+" PC signalingState: "+this.peerConnection.signalingState);if(this.peerConnection.signalingState==="stable"){this._updateTracksDebounced()}}function Wd(e){this.log("User "+this.userId+": media track received: ",e.track.id+" ("+e.track.kind+")");if(e.track.kind==="video"){e.track.addEventListener("mute",lu(this,Bd,zd).bind(this));e.track.addEventListener("unmute",lu(this,Dd,jd).bind(this));e.track.addEventListener("ended",lu(this,Hd,qd).bind(this));if(this.trackList[e.track.id]==="screen"){this.incomingScreenTrack=e.track}else{this.incomingVideoTrack=e.track}}else if(e.track.kind==="audio"){if(this.trackList[e.track.id]==="screenAudio"){this.incomingScreenAudioTrack=e.track}else{this.incomingAudioTrack=e.track}}}function Xd(e){this.log("User: "+this.userId+"_onPeerConnectionRemoveStream: ",e)}function zd(){console.log("Video track muted")}function jd(){console.log("Video track unmuted")}function qd(){console.log("Video track ended")}function Yd(){var e=this;if(!this.peerConnection){return null}var t=null;var i=null;var n=null;var a=null;this.peerConnection.getTransceivers().forEach((function(s){e.call.log("[debug] tr direction: "+s.direction+" currentDirection: "+s.currentDirection);if(s.currentDirection==="sendrecv"||s.currentDirection==="recvonly"){if(s.receiver&&s.receiver.track){var r=s.receiver.track;if(r.kind==="audio"){if(e.trackList[s.mid]==="sharingAudio"){a=r}else{t=r}}else if(r.kind==="video"){if(e.trackList[s.mid]==="screen"){n=r}else{i=r}}}}}));this.incomingAudioTrack=t;this.incomingVideoTrack=i;this.incomingScreenTrack=n;this.incomingScreenAudioTrack=a}function Qd(){this.setSignalingConnected(false)}var Jd;function Kd(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function Zd(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?Kd(Object(i),!0).forEach((function(t){babelHelpers.defineProperty(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):Kd(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}function $d(e,t,i){th(e,t);t.set(e,i)}function eh(e,t){th(e,t);t.add(e)}function th(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}function ih(e,t,i){if(!t.has(e)){throw new TypeError("attempted to get private field on non-instance")}return i}var nh={invite:"im.call.invite",answer:"im.call.answer",decline:"im.call.decline",hangup:"im.call.hangup",ping:"im.call.ping",finish:"im.call.finish"};var ah={ping:"Call::ping",answer:"Call::answer",hangup:"Call::hangup",userInviteTimeout:"Call::userInviteTimeout",repeatAnswer:"Call::repeatAnswer"};var sh={voiceStarted:"Call::voiceStarted",voiceStopped:"Call::voiceStopped",microphoneState:"Call::microphoneState",cameraState:"Call::cameraState",videoPaused:"Call::videoPaused",screenState:"Call::screenState",commonRecordState:"Call::commonRecordState",emotion:"Call::emotion",customMessage:"Call::customMessage",showUsers:"Call::showUsers",showAll:"Call::showAll",hideAll:"Call::hideAll"};var rh={viewerJoined:"Call::viewerJoined",viewerLeft:"Call::viewerLeft"};var oh={onCallConference:"BitrixCall::onCallConference"};var lh=(Jd={},babelHelpers.defineProperty(Jd,ge.Camera,"video"),babelHelpers.defineProperty(Jd,ge.Microphone,"audio"),babelHelpers.defineProperty(Jd,ge.Screen,"sharing"),babelHelpers.defineProperty(Jd,ge.ScreenAudio,"sharingAudio"),Jd);var ch=5e3;var uh=25e3;var dh=5500;var hh=new WeakSet;var ph=new WeakSet;var vh=new WeakSet;var fh=new WeakMap;var mh=new WeakMap;var gh=new WeakMap;var bh=new WeakMap;var Ch=new WeakMap;var kh=new WeakMap;var yh=new WeakMap;var Sh=new WeakMap;var wh=new WeakMap;var Ih=new WeakMap;var Th=new WeakMap;var Ph=new WeakMap;var _h=new WeakMap;var Eh=new WeakMap;var Rh=new WeakMap;var Mh=new WeakMap;var Ah=new WeakMap;var Lh=new WeakMap;var Bh=new WeakMap;var Dh=new WeakMap;var Hh=new WeakMap;var Nh=new WeakMap;var xh=new WeakMap;var Oh=new WeakMap;var Uh=new WeakMap;var Fh=new WeakMap;var Vh=new WeakMap;var Gh=new WeakMap;var Wh=new WeakMap;var Xh=new WeakMap;var zh=new WeakMap;var jh=new WeakMap;var qh=new WeakMap;var Yh=new WeakMap;var Qh=new WeakMap;var Jh=new WeakMap;var Kh=new WeakMap;var Zh=new WeakMap;var $h=new WeakMap;var ep=new WeakMap;var tp=new WeakMap;var ip=new WeakMap;var np=new WeakMap;var ap=new WeakMap;var sp=new WeakMap;var rp=new WeakMap;var op=new WeakMap;var lp=new WeakMap;var cp=new WeakMap;var up=function(e){babelHelpers.inherits(t,e);function t(e){var i;babelHelpers.classCallCheck(this,t);i=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this,e));eh(babelHelpers.assertThisInitialized(i),vh);eh(babelHelpers.assertThisInitialized(i),ph);eh(babelHelpers.assertThisInitialized(i),hh);babelHelpers.defineProperty(babelHelpers.assertThisInitialized(i),"setMuted",(function(e){if(i.muted===e.data.isMicrophoneMuted){return}i.muted=e.data.isMicrophoneMuted;if(i.BitrixCall){if(!e.data.calledProgrammatically){i.signaling.sendMicrophoneState(!i.muted)}if(i.muted){i.BitrixCall.disableAudio({calledFrom:"setMuted"})}else{if(!i.BitrixCall.isAudioPublished()){ih(babelHelpers.assertThisInitialized(i),hh,dp).call(babelHelpers.assertThisInitialized(i),ge.Microphone,true)}i.BitrixCall.enableAudio({calledFrom:"setMuted"})}}}));babelHelpers.defineProperty(babelHelpers.assertThisInitialized(i),"setVideoEnabled",(function(e){if(i.videoEnabled===e.data.isCameraOn){return}i.videoEnabled=e.data.isCameraOn;if(i.BitrixCall){if(!e.data.calledProgrammatically){i.signaling.sendCameraState(i.videoEnabled)}if(i.videoEnabled){if(!i.BitrixCall.isVideoPublished()){ih(babelHelpers.assertThisInitialized(i),hh,dp).call(babelHelpers.assertThisInitialized(i),ge.Camera,true)}i.localVideoShown=true;i.BitrixCall.enableVideo()}else{if(i.localVideoShown){i.localVideoShown=false;i.BitrixCall.disableVideo()}}}}));$d(babelHelpers.assertThisInitialized(i),fh,{writable:true,value:function e(t){i.runCallback(Ac.onUserStateChanged,t);if(!i.ready){return}if(t.state===yc.Failed||t.state===yc.Unavailable||t.state===yc.Declined||t.state===yc.Idle){if(i.type==wc.Instant&&!i.isAnyoneParticipating()){i.hangup()}}}});$d(babelHelpers.assertThisInitialized(i),mh,{writable:true,value:function e(t){if(!i.ready){return}i.signaling.sendUserInviteTimeout({userId:i.users,failedUserId:t.userId})}});$d(babelHelpers.assertThisInitialized(i),gh,{writable:true,value:function e(t){var n=Number(t.senderId);if(n==i.userId){return i.__onPullEventAnswerSelf(t)}if(!i.peers[n]){i.peers[n]=i.createPeer(n);i.runCallback(Ac.onUserInvited,{userId:n})}if(!i.users.includes(n)){i.users.push(n)}i.peers[n].setReady(true)}});$d(babelHelpers.assertThisInitialized(i),bh,{writable:true,value:function e(t){var n=t.senderId;if(i.userId===n&&t.callInstanceId&&i.instanceId!==t.callInstanceId){i.runCallback(Ac.onLeave,{local:false});return}if(!i.peers[n]){return}Yf.sendLog({description:"GOT A #onPullEventHangup from user",pullEvent:"#onPullEventHangup",params:t});i.peers[n].participant=null;i.peers[n].setReady(false);if(t.code==603){i.peers[n].setDeclined(true)}else if(t.code==486){i.peers[n].setBusy(true);console.error("user "+n+" is busy")}if(i.ready&&i.type==wc.Instant&&!i.isAnyoneParticipating()){i.hangup()}}});$d(babelHelpers.assertThisInitialized(i),Ch,{writable:true,value:function e(t){i.log("__onPullEventUsersJoined",t);var n=t.users;i.addJoinedUsers(n)}});$d(babelHelpers.assertThisInitialized(i),kh,{writable:true,value:function e(t){i.log("__onPullEventUsersInvited",t);var n=t.users;var a=t.show;if(i.type===wc.Instant){i.addInvitedUsers(n,a)}}});$d(babelHelpers.assertThisInitialized(i),yh,{writable:true,value:function e(t){i.log("__onPullEventUserInviteTimeout",t);var n=t.failedUserId;if(i.peers[n]){i.peers[n].onInviteTimeout(false)}}});$d(babelHelpers.assertThisInitialized(i),Sh,{writable:true,value:function e(t){if(t.callInstanceId===i.instanceId){return}var n=Number(t.senderId);if(n==i.userId){if(!i.joinedElsewhere){i.runCallback(Ac.onJoin,{local:false});i.joinedElsewhere=true}clearTimeout(i.lastSelfPingReceivedTimeout);i.lastSelfPingReceivedTimeout=setTimeout(babelHelpers.classPrivateFieldGet(babelHelpers.assertThisInitialized(i),Ih),ch*2.1)}clearTimeout(i.lastPingReceivedTimeout);i.lastPingReceivedTimeout=setTimeout(babelHelpers.classPrivateFieldGet(babelHelpers.assertThisInitialized(i),wh),ch*2.1);if(i.peers[n]){i.peers[n].setReady(true)}}});$d(babelHelpers.assertThisInitialized(i),wh,{writable:true,value:function e(){if(!i.ready){i.destroy()}}});$d(babelHelpers.assertThisInitialized(i),Ih,{writable:true,value:function e(){i.runCallback(Ac.onLeave,{local:false});i.joinedElsewhere=false}});$d(babelHelpers.assertThisInitialized(i),Th,{writable:true,value:function e(){i.destroy()}});$d(babelHelpers.assertThisInitialized(i),Ph,{writable:true,value:function e(){if(i.ready){i.signaling.sendAnswer({userId:i.userId},true)}}});$d(babelHelpers.assertThisInitialized(i),_h,{writable:true,value:function e(t){i.runCallback(Ac.onSwitchTrackRecordStatus,{isTrackRecordOn:t.isTrackRecordOn,errorCode:t.errorCode})}});$d(babelHelpers.assertThisInitialized(i),Eh,{writable:true,value:function e(t){var n=lh[t];if(!n){i.log("Wrong kind for local mediaRenderer: ".concat(t));return}i.log("__onLocalMediaRendererAdded",n);var a=null;var s=null;switch(t){case ge.Camera:if(!i.videoEnabled){return}a=ae.getLocalStream(t);s=new yn({kind:n,track:a});i.runCallback(Ac.onLocalMediaReceived,{mediaRenderer:s,tag:"main",stream:s.stream});break;case ge.Screen:i.log("Screen shared");i.screenShared=true;i.waitingLocalScreenShare=false;a=ae.getLocalStream(t);s=new yn({kind:n,track:a});i.runCallback(Ac.onLocalMediaReceived,{mediaRenderer:s,tag:"screen",stream:s.stream});break;case ge.Microphone:i.signaling.sendMicrophoneState(true);ih(babelHelpers.assertThisInitialized(i),hh,dp).call(babelHelpers.assertThisInitialized(i),t,false);a=ae.getLocalStream(t);babelHelpers.classPrivateFieldGet(babelHelpers.assertThisInitialized(i),Vh).call(babelHelpers.assertThisInitialized(i),{result:true,stream:new MediaStream([a])});break;default:}}});$d(babelHelpers.assertThisInitialized(i),Rh,{writable:true,value:function e(t,n){if(t===ge.Microphone){ih(babelHelpers.assertThisInitialized(i),hh,dp).call(babelHelpers.assertThisInitialized(i),ge.Microphone,false);i.signaling.sendMicrophoneState(!n)}else if(t===ge.Camera){ih(babelHelpers.assertThisInitialized(i),hh,dp).call(babelHelpers.assertThisInitialized(i),ge.Camera,false)}}});$d(babelHelpers.assertThisInitialized(i),Mh,{writable:true,value:function e(t){var n=t?false:!H.isMicrophoneMuted;var a=t?false:H.isCameraOn;i.signaling.sendMicrophoneState(n);i.signaling.sendCameraState(a)}});$d(babelHelpers.assertThisInitialized(i),Ah,{writable:true,value:function e(t,n){var a=lh[t];if(!a){i.log("Wrong kind for mediaRenderer: ".concat(t));return}if(!i.BitrixCall){return}switch(t){case ge.Camera:case ge.Microphone:if(!n){babelHelpers.classPrivateFieldGet(babelHelpers.assertThisInitialized(i),Hh).call(babelHelpers.assertThisInitialized(i),t)}break;case ge.Screen:babelHelpers.classPrivateFieldGet(babelHelpers.assertThisInitialized(i),Hh).call(babelHelpers.assertThisInitialized(i),t);break}}});$d(babelHelpers.assertThisInitialized(i),Lh,{writable:true,value:function e(t){i.getUserMediaFulfilled=false;if(t.video){i.signaling.sendCameraState(false)}if(t.audio){i.signaling.sendMicrophoneState(false)}}});$d(babelHelpers.assertThisInitialized(i),Bh,{writable:true,value:function e(t){if(t.video){i.signaling.sendCameraState(true)}if(t.audio){i.signaling.sendMicrophoneState(!H.isMicrophoneMuted)}}});$d(babelHelpers.assertThisInitialized(i),Dh,{writable:true,value:function e(){i.getUserMediaFulfilled=true}});$d(babelHelpers.assertThisInitialized(i),Hh,{writable:true,value:function e(t){var n=lh[t];if(!n){i.log("Wrong kind for mediaRenderer: ".concat(t));return}if(!i.BitrixCall){return}i.log("__onBeforeLocalMediaRendererRemoved",n);var a=new yn({kind:n});switch(t){case ge.Camera:i.runCallback(Ac.onLocalMediaReceived,{mediaRenderer:a,tag:"main",stream:new MediaStream,removed:true});break;case ge.Microphone:ih(babelHelpers.assertThisInitialized(i),hh,dp).call(babelHelpers.assertThisInitialized(i),ge.Microphone,false);i.signaling.sendMicrophoneState(false);break;case ge.Screen:i.BitrixCall.stopScreenShare();i.log("Screen is no longer shared");i.runCallback(Ac.onUserScreenState,{userId:i.userId,screenState:false});i.screenShared=false;i.waitingLocalScreenShare=false;i.runCallback(Ac.onLocalMediaReceived,{mediaRenderer:a,tag:"screen",stream:new MediaStream,removed:true});break}}});$d(babelHelpers.assertThisInitialized(i),Nh,{writable:true,value:function e(t,n){var a=lh[n.source];if(!a){i.log("Wrong kind for mediaRenderer: ".concat(n.source));return}var s={mediaRenderer:new yn({kind:a,track:n.track})};var r=i.peers[t.userId];if(r){if(!r.participant){r.participant=t;r.updateCalculatedState()}r.addMediaRenderer(s.mediaRenderer)}switch(n.source){case ge.Camera:i.runCallback(Ac.onUserCameraState,{userId:t.userId,cameraState:!t.isMutedVideo});break;case ge.Microphone:i.runCallback(Ac.onUserMicrophoneState,{userId:t.userId,microphoneState:!t.isMutedAudio});break}console.log("[RemoteMediaAdded]: UserId: ".concat(t.userId,", source: ").concat(lh[n.source]))}});$d(babelHelpers.assertThisInitialized(i),xh,{writable:true,value:function e(t,n){var a=lh[n.source];if(!a){i.log("Wrong kind for mediaRenderer: ".concat(n.source));return}var s={mediaRenderer:new yn({kind:a,track:n.track})};var r=i.peers[t.userId];if(r){r.removeMediaRenderer(s.mediaRenderer)}if(n.source===ge.Camera){i.runCallback(Ac.onUserCameraState,{userId:t.userId,cameraState:false})}console.log("[RemoteMediaRemoved]: UserId: ".concat(t.userId,", source: ").concat(lh[n.source]))}});$d(babelHelpers.assertThisInitialized(i),Oh,{writable:true,value:function e(t,n){if(n.source===ge.Microphone){i.runCallback(Ac.onUserMicrophoneState,{userId:t.userId,microphoneState:!t.isMutedAudio})}}});$d(babelHelpers.assertThisInitialized(i),Uh,{writable:true,value:function e(t){var n=i.peers[t.userId];if(n){if(!t.audioEnabled||t.isMutedAudio){i.runCallback(Ac.onUserMicrophoneState,{userId:t.userId,microphoneState:false})}if(!t.videoEnabled||t.isMutedVideo){i.runCallback(Ac.onUserCameraState,{userId:t.userId,cameraState:false})}if(t.isHandRaised){i.runCallback(Ac.onUserFloorRequest,{userId:t.userId,requestActive:t.isHandRaised})}n.participant=t;n.updateCalculatedState();if(i.commonRecordState.state!==Di.Stopped&&i.commonRecordState.userId===i.userId){i.signaling.sendLocalRecordState(i.userId,i.commonRecordState)}}}});$d(babelHelpers.assertThisInitialized(i),Fh,{writable:true,value:function e(t){var n=i.peers[t.userId];if(n){n.participant=null;for(var a in ge){var s=ge[a];var r=lh[s];var o={mediaRenderer:new yn({kind:r})};n.removeMediaRenderer(o.mediaRenderer)}n.updateCalculatedState()}}});$d(babelHelpers.assertThisInitialized(i),Vh,{writable:true,value:function e(t){if(t.result){if(t.stream.getAudioTracks().length>0){if(i.localVAD){i.localVAD.destroy()}i.localVAD=new ds({mediaStream:t.stream,onVoiceStarted:function e(){if(!H.isMicrophoneMuted){i.requestFloor(false)}babelHelpers.classPrivateFieldGet(babelHelpers.assertThisInitialized(i),lp).call(babelHelpers.assertThisInitialized(i),{userId:i.userId})},onVoiceStopped:function e(){babelHelpers.classPrivateFieldGet(babelHelpers.assertThisInitialized(i),cp).call(babelHelpers.assertThisInitialized(i),{userId:i.userId})}});clearInterval(i.microphoneLevelInterval);i.microphoneLevelInterval=setInterval((function(){return i.microphoneLevel=i.localVAD.currentVolume}),200)}}}});$d(babelHelpers.assertThisInitialized(i),Gh,{writable:true,value:function e(){if(i.reconnectionEventCount++){return}for(var t in i.peers){if(t!==i.userId&&i.peers.hasOwnProperty(t)&&i.peers[t].calculatedState===yc.Connected){for(var n in ge){var a=ge[n];var s=lh[a];var r={mediaRenderer:new yn({kind:s})};i.peers[t].removeMediaRenderer(r.mediaRenderer)}}}}});$d(babelHelpers.assertThisInitialized(i),Wh,{writable:true,value:function e(){i.reconnectionEventCount=0;i.log("Call reconnected");i.sendTelemetryEvent("reconnect");i.localUserState=yc.Connected;i.signaling.sendMicrophoneState(!H.isMicrophoneMuted);if(!i.BitrixCall.isAudioPublished()){ih(babelHelpers.assertThisInitialized(i),hh,dp).call(babelHelpers.assertThisInitialized(i),ge.Microphone,true)}i.BitrixCall.enableAudio({calledFrom:"onCallReconnected",disabled:H.isMicrophoneMuted});i.signaling.sendCameraState(H.isCameraOn);if(H.isCameraOn){if(!i.BitrixCall.isVideoPublished()){ih(babelHelpers.assertThisInitialized(i),hh,dp).call(babelHelpers.assertThisInitialized(i),ge.Camera,true)}i.BitrixCall.enableVideo()}if(i.screenShared||i.waitingLocalScreenShare){i.BitrixCall.startScreenShare()}if(i.videoAllowedFrom==Mc.none){i.signaling.sendHideAll()}else if(p.Type.isArray(i.videoAllowedFrom)){i.signaling.sendShowUsers(i.videoAllowedFrom)}if(i.recordState.userId===i.userId){i.sendLocalRecordState({action:i.commonRecordState.state,userId:i.userId},true)}i.BitrixCall.raiseHand(i.floorRequestActive)}});$d(babelHelpers.assertThisInitialized(i),Xh,{writable:true,value:function e(t){var n={};var a=t&&babelHelpers["typeof"](t)==="object"?t:{};var s=a.headers,r=a.leaveInformation;if(s){n=Zd(Zd({},n),{},{headers:s})}if(r){n=Zd(Zd({},n),{},{leaveInformation:r})}i.log("__onCallDisconnected",Object.keys(n).length?n:null);if(i.ready&&r){i.hangup(r.code,r.reason)}i.sendTelemetryEvent("disconnect");i.localUserState=yc.Idle;i.ready=false;i.joinedAsViewer=false;i.reinitPeers();i.localVideoShown=false;i.removeCallEvents();i.unsubscribeHardwareChanges();i.state=kc.Proceeding;i.runCallback(Ac.onLeave,{local:true})}});$d(babelHelpers.assertThisInitialized(i),zh,{writable:true,value:function e(){if(i.ready&&i.BitrixCall){i.signaling.sendHangup({userId:i.users})}}});$d(babelHelpers.assertThisInitialized(i),jh,{writable:true,value:function e(t){if(t&&t.call){delete t.call}i.log("onFatalError",t);i.ready=false;i.localUserState=yc.Failed;i.reinitPeers();i.localVideoShown=false;if(i.BitrixCall){i.removeCallEvents();i.unsubscribeHardwareChanges();try{i.BitrixCall.hangup({"X-Reason":"Fatal error","X-Error":typeof t==="string"?t:t.code||t.name})}catch(e){i.log("Bitrix hangup error: ",e);console.error("Bitrix hangup error: ",e)}i.BitrixCall=null}if(typeof t==="string"){i.runCallback(Ac.onCallFailure,{name:t})}else if(t.name){i.runCallback(Ac.onCallFailure,t)}}});$d(babelHelpers.assertThisInitialized(i),qh,{writable:true,value:function e(t){i.runCallback(Ac.onTrackSubscriptionFailed,t)}});$d(babelHelpers.assertThisInitialized(i),Yh,{writable:true,value:function e(t){var n={};var a={f:2,h:1,q:0};t.sender.forEach((function(e){if(e.userId&&(e.kind==="video"||e.kind==="audio")){if(!n[e.userId]){n[e.userId]={}}if(e.kind==="video"){if(!n[e.userId][e.source]){n[e.userId][e.source]=[]}var t=a[e.rid]||0;n[e.userId][e.source][t]=e}else if(e.kind==="audio"){n[e.userId][e.source]=e}}}));t.recipient.forEach((function(e){if(e.userId&&(e.kind==="video"||e.kind==="audio")){if(!n[e.userId]){n[e.userId]={}}n[e.userId][e.source]=e}}));for(var s in n){i.runCallback(Ac.onUserStatsReceived,{userId:s,report:n[s]})}}});$d(babelHelpers.assertThisInitialized(i),Qh,{writable:true,value:function e(t){var n=new Set(babelHelpers.toConsumableArray(i.peersWithBadConnection.values()));t.forEach((function(e){var t=i.peers[e];if(t){if(!n.has(e)){i.peersWithBadConnection.add(e)}else{n["delete"](e)}}}))}});$d(babelHelpers.assertThisInitialized(i),Jh,{writable:true,value:function e(t){Object.keys(t).forEach((function(e){i.runCallback(Ac.onConnectionQualityChanged,{userId:Number(e),score:t[e]})}))}});$d(babelHelpers.assertThisInitialized(i),Kh,{writable:true,value:function e(t){i.runCallback(Ac.onToggleRemoteParticipantVideo,{isVideoShown:t})}});$d(babelHelpers.assertThisInitialized(i),Zh,{writable:true,value:function e(t){var n;var a;try{n=JSON.parse(t.text)}catch(e){i.log("Could not parse scenario message.",e);return}var s=n.eventName;if(s===sh.cameraState){i.runCallback(Ac.onUserCameraState,{userId:n.senderId,cameraState:n.cameraState==="Y"})}else if(s===sh.videoPaused){if(n.senderId===i.userId){return}i.runCallback(Ac.onUserVideoPaused,{userId:n.senderId,videoPaused:n.videoPaused==="Y"})}else if(s===sh.screenState){i.runCallback(Ac.onUserScreenState,{userId:n.senderId,screenState:n.screenState==="Y"})}else if(s===sh.commonRecordState){i.runCallback(Ac.onUserCommonRecordState,{userId:n.senderId,commonRecordState:n.commonRecordState})}else if(s===sh.emotion){i.runCallback(Ac.onUserEmotion,{userId:n.senderId,toUserId:n.toUserId,emotion:n.emotion})}else if(s===sh.customMessage){i.runCallback(Ac.onCustomMessage,{message:n.message})}else if(s===rh.viewerJoined){console.log("viewer "+n.senderId+" joined");a=i.peers[n.senderId];if(a){a.setDirection(Sc.RecvOnly);a.setReady(true)}}else if(s===rh.viewerLeft){console.log("viewer "+n.senderId+" left");a=i.peers[n.senderId];if(a){a.setReady(false)}}else{i.log("Unknown scenario event "+s)}}});$d(babelHelpers.assertThisInitialized(i),$h,{writable:true,value:function e(t){i.runCallback(Ac.onUserFloorRequest,{userId:t.userId,requestActive:t.isHandRaised})}});$d(babelHelpers.assertThisInitialized(i),ep,{writable:true,value:function e(t){i.runCallback(Ac.onAllParticipantsAudioMuted,{userId:t.fromUserId,reason:t.reason})}});$d(babelHelpers.assertThisInitialized(i),tp,{writable:true,value:function e(t){i.runCallback(Ac.onAllParticipantsVideoMuted,{userId:t.fromUserId,reason:t.reason})}});$d(babelHelpers.assertThisInitialized(i),ip,{writable:true,value:function e(t){i.runCallback(Ac.onAllParticipantsScreenshareMuted,{userId:t.fromUserId,reason:t.reason})}});$d(babelHelpers.assertThisInitialized(i),np,{writable:true,value:function e(t){i.runCallback(Ac.onYouMuteAllParticipants,{data:t})}});$d(babelHelpers.assertThisInitialized(i),ap,{writable:true,value:function e(t){i.runCallback(Ac.onRoomSettingsChanged,{data:t})}});$d(babelHelpers.assertThisInitialized(i),sp,{writable:true,value:function e(t){i.runCallback(Ac.onUserPermissionsChanged,{data:t})}});$d(babelHelpers.assertThisInitialized(i),rp,{writable:true,value:function e(t){i.runCallback(Ac.onUserRoleChanged,{data:t})}});$d(babelHelpers.assertThisInitialized(i),op,{writable:true,value:function e(t){i.runCallback(Ac.onParticipantMuted,{data:t})}});$d(babelHelpers.assertThisInitialized(i),lp,{writable:true,value:function e(t){if(t.userId===i.userId){i.runCallback(Ac.onUserVoiceStarted,{userId:t.userId,local:true});if(H.isMicrophoneMuted){return}}i.runCallback(Ac.onUserVoiceStarted,{userId:t.userId})}});$d(babelHelpers.assertThisInitialized(i),cp,{writable:true,value:function e(t){i.runCallback(Ac.onUserVoiceStopped,{userId:t.userId})}});i.videoQuality=_c.VeryHigh;i.BitrixCall=null;i.signaling=new gp({call:babelHelpers.assertThisInitialized(i)});i.peers={};i.peersWithBadConnection=new Set;i.joinedElsewhere=false;i.joinedAsViewer=false;i.localVideoShown=false;i._localUserState=yc.Idle;i.clientEventsBound=false;i._screenShared=false;i.videoAllowedFrom=Mc.all;i.direction=Sc.SendRecv;i.floorRequestActive=false;i.microphoneLevelInterval=null;window.addEventListener("unload",babelHelpers.classPrivateFieldGet(babelHelpers.assertThisInitialized(i),zh));i.initPeers();i.pingUsersInterval=setInterval(i.pingUsers.bind(babelHelpers.assertThisInitialized(i)),ch);i.pingBackendInterval=setInterval(i.pingBackend.bind(babelHelpers.assertThisInitialized(i)),uh);i.lastPingReceivedTimeout=null;i.lastSelfPingReceivedTimeout=null;i.reinviteTimeout=null;i._reconnectionEventCount=0;i.pullEventHandlers={"Call::answer":babelHelpers.classPrivateFieldGet(babelHelpers.assertThisInitialized(i),gh),"Call::hangup":babelHelpers.classPrivateFieldGet(babelHelpers.assertThisInitialized(i),bh),"Call::usersJoined":babelHelpers.classPrivateFieldGet(babelHelpers.assertThisInitialized(i),Ch),"Call::usersInvited":babelHelpers.classPrivateFieldGet(babelHelpers.assertThisInitialized(i),kh),"Call::userInviteTimeout":babelHelpers.classPrivateFieldGet(babelHelpers.assertThisInitialized(i),yh),"Call::ping":babelHelpers.classPrivateFieldGet(babelHelpers.assertThisInitialized(i),Sh),"Call::finish":babelHelpers.classPrivateFieldGet(babelHelpers.assertThisInitialized(i),Th),"Call::repeatAnswer":babelHelpers.classPrivateFieldGet(babelHelpers.assertThisInitialized(i),Ph),"Call::switchTrackRecordStatus":babelHelpers.classPrivateFieldGet(babelHelpers.assertThisInitialized(i),_h)};i._isCopilotActive=e.isCopilotActive;i._isCopilotFeaturesEnabled=true;i._isRecordWhenCopilotActivePopupAlreadyShow=false;i._isBoostExpired=false;return i}babelHelpers.createClass(t,[{key:"initPeers",value:function e(){var t=this;this.users.forEach((function(e){e=Number(e);t.peers[e]=t.createPeer(e)}))}},{key:"reinitPeers",value:function e(){for(var t in this.peers){if(this.peers.hasOwnProperty(t)&&this.peers[t]){this.peers[t].destroy();this.peers[t]=null}}this.initPeers()}},{key:"pingUsers",value:function e(){if(this.ready){var t=this.users.concat(this.userId);this.signaling.sendPingToUsers({userId:t},true)}}},{key:"pingBackend",value:function e(){if(this.ready){this.signaling.sendPingToBackend()}}},{key:"createPeer",value:function e(t){var i=this;var n;if(this.videoAllowedFrom===Mc.all){n=true}else if(this.videoAllowedFrom===Mc.none){n=false}else if(p.Type.isArray(this.videoAllowedFrom)){n=this.videoAllowedFrom.some((function(e){return e==t}))}else{n=true}return new yp({call:this,userId:t,ready:t==this.initiatorId,isIncomingVideoAllowed:n,onMediaReceived:function e(n){i.runCallback(Ac.onRemoteMediaReceived,n);if(n.kind==="video"){i.runCallback(Ac.onUserVideoPaused,{userId:t,videoPaused:false})}},onMediaRemoved:function e(t){i.runCallback(Ac.onRemoteMediaStopped,t)},onStateChanged:babelHelpers.classPrivateFieldGet(this,fh),onInviteTimeout:babelHelpers.classPrivateFieldGet(this,mh)})}},{key:"getUsers",value:function e(){var t={};for(var i in this.peers){t[i]=this.peers[i].calculatedState}return t}},{key:"getUserCount",value:function e(){return Object.keys(this.peers).length}},{key:"canChangeMediaDevices",value:function e(){var t;return!((t=this.BitrixCall)!==null&&t!==void 0&&t.isMediaMutedBySystem)}},{key:"setCameraId",value:function e(t){var i=this;if(this.cameraId===t){return}this.cameraId=t;if(this.BitrixCall){if(!t){babelHelpers.classPrivateFieldGet(this,Hh).call(this,ge.Camera);return}if(this.BitrixCall.isVideoPublished()){ih(this,hh,dp).call(this,ge.Camera,true)}this.BitrixCall.switchActiveVideoDevice(this.cameraId).then((function(){if(H.isCameraOn){i.runCallback("onUpdateLastUsedCameraId");if(i.BitrixCall.isVideoPublished()&&i.canChangeMediaDevices()){var e=ae.getLocalStream(ge.Camera);var t=Yf.MediaKind[ge.Camera];var n=new yn({kind:t,track:e});i.runCallback(Ac.onLocalMediaReceived,{mediaRenderer:n,tag:"main",stream:n.stream});if(i.BitrixCall.isVideoPublished()){ih(i,hh,dp).call(i,ge.Camera,false)}}else if(!i.canChangeMediaDevices()){i.runCallback(Ac.onNeedResetMediaDevicesState)}else{ih(i,hh,dp).call(i,ge.Camera,true);i.localVideoShown=true;i.BitrixCall.enableVideo({calledFrom:"switchActiveVideoDevice",skipUnpause:true})}}else{ih(i,hh,dp).call(i,ge.Camera,false)}}))["catch"]((function(e){i.log(e);console.error(e);babelHelpers.classPrivateFieldGet(i,Hh).call(i,ge.Camera)}))}}},{key:"setMicrophoneId",value:function e(t){var i=this;if(this.microphoneId===t){return}this.microphoneId=t;if(this.BitrixCall){if(!t){babelHelpers.classPrivateFieldGet(this,Hh).call(this,ge.Microphone);return}ih(this,hh,dp).call(this,ge.Microphone,true);babelHelpers.classPrivateFieldGet(this,cp).call(this,{userId:this.userId});this.BitrixCall.switchActiveAudioDevice(this.microphoneId).then((function(){var e=ae.getLocalStream(ge.Microphone);babelHelpers.classPrivateFieldGet(i,Vh).call(i,{result:true,stream:new MediaStream([e])})}))["catch"]((function(e){i.log(e);console.error(e);i.runCallback(Ac.onUserMicrophoneState,{userId:i.userId,microphoneState:false})}))["finally"]((function(){ih(i,hh,dp).call(i,ge.Microphone,false);if(H.isMicrophoneMuted&&!i.canChangeMediaDevices()){i.BitrixCall.disableAudio({calledFrom:"setMicrophoneId"})}}))}}},{key:"useHdVideo",value:function e(t){this.videoHd=t===true}},{key:"setMainStream",value:function e(t){if(t&&t!==this.userId){var i;var n=(i=this.peers[t])===null||i===void 0?void 0:i.participant;var a=n!==null&&n!==void 0&&n.screenSharingEnabled?ge.Screen:ge.Camera;this.BitrixCall.setMainStream(t,a)}else{this.BitrixCall.resetMainStream()}}},{key:"requestFloor",value:function e(t){if(this.floorRequestActive===t){return}this.floorRequestActive=t;this.BitrixCall.raiseHand(t)}},{key:"turnOffAllParticipansStream",value:function e(t){this.BitrixCall.turnOffAllParticipansStream(t)}},{key:"turnOffParticipantStream",value:function e(t){this.BitrixCall.turnOffParticipantStream(t)}},{key:"allowSpeakPermission",value:function e(t){this.BitrixCall.allowSpeakPermission(t)}},{key:"changeSettings",value:function e(t){this.BitrixCall.changeSettings(t)}},{key:"sendLocalRecordState",value:function e(t){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:false;if(!i&&!this.updateCommonRecordState(Zd(Zd({},t),{},{senderId:this.userId}))){return}this.signaling.sendLocalRecordState(this.userId,this.commonRecordState)}},{key:"sendCustomMessage",value:function e(t,i){this.signaling.sendCustomMessage(t,i)}},{key:"allowVideoFrom",value:function e(t){if(this.videoAllowedFrom==t){return}this.videoAllowedFrom=t;if(t===Mc.all){this.signaling.sendShowAll();t=Object.keys(this.peers)}else if(t===Mc.none){this.signaling.sendHideAll();t=[]}else if(p.Type.isArray(t)){this.signaling.sendShowUsers(t)}else{throw new Error("userList is in wrong format")}var i={};t.forEach((function(e){return i[e]=true}));for(var n in this.peers){if(!this.peers.hasOwnProperty(n)){continue}if(i[n]){this.peers[n].allowIncomingVideo(true)}else{this.peers[n].allowIncomingVideo(false)}}}},{key:"startScreenSharing",value:function e(){if(!this.BitrixCall){return}this.waitingLocalScreenShare=true;this.runCallback(Ac.onUserScreenState,{userId:this.userId,screenState:true});this.BitrixCall.startScreenShare()}},{key:"stopScreenSharing",value:function e(){babelHelpers.classPrivateFieldGet(this,Hh).call(this,ge.Screen)}},{key:"isScreenSharingStarted",value:function e(){return this.screenShared||this.waitingLocalScreenShare}},{key:"isGetUserMediaFulfilled",value:function e(){return this.getUserMediaFulfilled}},{key:"inviteUsers",value:function e(){var t=this;var i=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};this.ready=true;var n=p.Type.isArray(i.users)?i.users:this.users;this.attachToConference().then((function(){t.signaling.sendPingToUsers({userId:n});if(n.length>0){return t.signaling.inviteUsers({userIds:n,video:H.isCameraOn?"Y":"N",show:i.show===true?"Y":"N"})}})).then((function(){t.state=kc.Connected;t.runCallback(Ac.onJoin,{local:true});for(var e=0;e<n.length;e++){var i=parseInt(n[e]);if(!t.users.includes(i)){t.users.push(i)}if(!t.peers[i]){t.peers[i]=t.createPeer(i);if(t.type===wc.Instant){t.runCallback(Ac.onUserInvited,{userId:i})}}if(t.type===wc.Instant){t.peers[i].onInvited();t.scheduleRepeatInvite()}}}))["catch"]((function(e){babelHelpers.classPrivateFieldGet(t,jh).call(t,e)}))}},{key:"scheduleRepeatInvite",value:function e(){var t=this;clearTimeout(this.reinviteTimeout);this.reinviteTimeout=setTimeout((function(){return t.repeatInviteUsers()}),dh)}},{key:"repeatInviteUsers",value:function e(){var t=this;clearTimeout(this.reinviteTimeout);if(!this.ready){return}var i=[];for(var n in this.peers){if(this.peers.hasOwnProperty(n)&&this.peers[n].calculatedState===yc.Calling){i.push(n)}}if(i.length===0){return}var a={userIds:i,video:H.isCameraOn?"Y":"N",repeated:"Y"};this.signaling.inviteUsers(a).then((function(){return t.scheduleRepeatInvite()}))}},{key:"answer",value:function e(){var t=this;var i=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};this.ready=true;var n=i.joinAsViewer===true;this.videoEnabled=H.isCameraOn;this.muted=H.isMicrophoneMuted;clearTimeout(this.lastSelfPingReceivedTimeout);if(!n){this._outgoingAnswer=this.signaling.sendAnswer()}this.attachToConference({joinAsViewer:n}).then((function(){t.log("Attached to conference");t.state=kc.Connected;t.runCallback(Ac.onJoin,{local:true})}))["catch"]((function(e){babelHelpers.classPrivateFieldGet(t,jh).call(t,e)}))}},{key:"decline",value:function e(t){this.ready=false;var i={callId:this.id,callInstanceId:this.instanceId};if(t){i.code=t}Jp.getRestClient().callMethod(nh.decline,i)}},{key:"hangup",value:function e(t,i){var n=this;var a=arguments.length>2&&arguments[2]!==undefined?arguments[2]:false;if(!this.ready){var s=new Error("Hangup in wrong state");this.log(s);return}var r=new Error;r.name="Call stack:";this.log("Hangup received \n"+r.stack);if(this.localVAD){this.localVAD.destroy();this.localVAD=null}clearInterval(this.microphoneLevelInterval);var o={};this.ready=false;if(typeof t!="undefined"){o.code=t}if(typeof i!="undefined"){o.reason=i}this.state=kc.Proceeding;this.runCallback(Ac.onLeave,{local:true});o.userId=this.users.slice(0).concat(this.userId);if(this._outgoingAnswer&&!a){this._outgoingAnswer.then((function(){return n.signaling.sendHangup(o)}))}else if(a){this.signaling.sendFinish(o)}else if(i!=="SIGNALING_DUPLICATE_PARTICIPANT"){this.signaling.sendHangup(o)}if(i!=="SIGNALING_DUPLICATE_PARTICIPANT"){this.reinitPeers()}if(this.BitrixCall){this.BitrixCall._replaceVideoSharing=false;this.BitrixCall.hangup();this.BitrixCall=null}else{this.log("Tried to hangup, but this.BitrixCall points nowhere");console.error("Tried to hangup, but this.BitrixCall points nowhere")}this.screenShared=false;this.localVideoShown=false;this.floorRequestActive=false}},{key:"attachToConference",value:function e(){var t=this;var i=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};var n=i.joinAsViewer===true;if(this.BitrixCall&&this.BitrixCall.getState()===ke.CONNECTED){if(this.joinedAsViewer===n){return Promise.resolve()}else{return Promise.reject("Already joined call in another mode")}}return new Promise((function(e,i){t.direction=n?Sc.RecvOnly:Sc.SendRecv;t.sendTelemetryEvent("call");try{t.localUserState=yc.Connecting;t.BitrixCall=new At(t.userId);t.joinedAsViewer=n;if(!t.BitrixCall){t.log("Error: could not create Bitrix call");return i({code:"BITRIX_NO_CALL"})}t.runCallback(oh.onCallConference,{call:t});t.bindCallEvents();t.subscribeHardwareChanges();t.BitrixCall.on("Connected",(function(){ih(t,ph,hp).call(t);e()}));t.BitrixCall.on("Failed",(function(e){ih(t,vh,pp).call(t,e);i(e)}));if(!t.ready){return i({code:"BITRIX_NO_CALL"})}t.BitrixCall.connect({roomId:t.id,userId:t.userId,isLegacy:true,endpoint:t.connectionData.endpoint,jwt:t.connectionData.jwt,videoBitrate:1e6,videoSimulcast:true,audioDeviceId:t.microphoneId,videoDeviceId:t.cameraId})}catch(e){babelHelpers.classPrivateFieldGet(t,jh).call(t,e)}}))}},{key:"bindCallEvents",value:function e(){this.BitrixCall.on("PublishSucceed",babelHelpers.classPrivateFieldGet(this,Eh));this.BitrixCall.on("PublishPaused",babelHelpers.classPrivateFieldGet(this,Rh));this.BitrixCall.on("MediaMutedBySystem",babelHelpers.classPrivateFieldGet(this,Mh));this.BitrixCall.on("PublishFailed",babelHelpers.classPrivateFieldGet(this,Ah));this.BitrixCall.on("PublishEnded",babelHelpers.classPrivateFieldGet(this,Ah));this.BitrixCall.on("GetUserMediaStarted",babelHelpers.classPrivateFieldGet(this,Lh).bind(this));this.BitrixCall.on("GetUserMediaEnded",babelHelpers.classPrivateFieldGet(this,Dh));this.BitrixCall.on("GetUserMediaSuccess",babelHelpers.classPrivateFieldGet(this,Bh).bind(this));this.BitrixCall.on("RemoteMediaAdded",babelHelpers.classPrivateFieldGet(this,Nh));this.BitrixCall.on("RemoteMediaRemoved",babelHelpers.classPrivateFieldGet(this,xh));this.BitrixCall.on("RemoteMediaMuted",babelHelpers.classPrivateFieldGet(this,Oh));this.BitrixCall.on("RemoteMediaUnmuted",babelHelpers.classPrivateFieldGet(this,Oh));this.BitrixCall.on("ParticipantJoined",babelHelpers.classPrivateFieldGet(this,Uh));this.BitrixCall.on("ParticipantStateUpdated",(function(){return console.log("handleParticipantStateUpdated")}));this.BitrixCall.on("ParticipantLeaved",babelHelpers.classPrivateFieldGet(this,Fh));this.BitrixCall.on("MessageReceived",babelHelpers.classPrivateFieldGet(this,Zh));this.BitrixCall.on("HandRaised",babelHelpers.classPrivateFieldGet(this,$h));this.BitrixCall.on("VoiceStarted",babelHelpers.classPrivateFieldGet(this,lp));this.BitrixCall.on("AllParticipantsAudioMuted",babelHelpers.classPrivateFieldGet(this,ep));this.BitrixCall.on("AllParticipantsVideoMuted",babelHelpers.classPrivateFieldGet(this,tp));this.BitrixCall.on("AllParticipantsScreenshareMuted",babelHelpers.classPrivateFieldGet(this,ip));this.BitrixCall.on("YouMuteAllParticipants",babelHelpers.classPrivateFieldGet(this,np));this.BitrixCall.on("RoomSettingsChanged",babelHelpers.classPrivateFieldGet(this,ap));this.BitrixCall.on("UserPermissionsChanged",babelHelpers.classPrivateFieldGet(this,sp));this.BitrixCall.on("UserRoleChanged",babelHelpers.classPrivateFieldGet(this,rp));this.BitrixCall.on("ParticipantMuted",babelHelpers.classPrivateFieldGet(this,op));this.BitrixCall.on("VoiceEnded",babelHelpers.classPrivateFieldGet(this,cp));this.BitrixCall.on("Reconnecting",babelHelpers.classPrivateFieldGet(this,Gh));this.BitrixCall.on("Reconnected",babelHelpers.classPrivateFieldGet(this,Wh));this.BitrixCall.on("Disconnected",babelHelpers.classPrivateFieldGet(this,Xh));this.BitrixCall.on("CallStatsReceived",babelHelpers.classPrivateFieldGet(this,Yh));this.BitrixCall.on("UpdatePacketLoss",babelHelpers.classPrivateFieldGet(this,Qh));this.BitrixCall.on("ConnectionQualityChanged",babelHelpers.classPrivateFieldGet(this,Jh));this.BitrixCall.on("ToggleRemoteParticipantVideo",babelHelpers.classPrivateFieldGet(this,Kh));this.BitrixCall.on("TrackSubscriptionFailed",babelHelpers.classPrivateFieldGet(this,qh))}},{key:"removeCallEvents",value:function e(){if(this.BitrixCall){this.BitrixCall.on("Failed",BX.DoNothing);this.BitrixCall.on("PublishSucceed",BX.DoNothing);this.BitrixCall.on("PublishFailed",BX.DoNothing);this.BitrixCall.on("PublishEnded",BX.DoNothing);this.BitrixCall.on("GetUserMediaEnded",BX.DoNothing);this.BitrixCall.on("RemoteMediaAdded",BX.DoNothing);this.BitrixCall.on("RemoteMediaRemoved",BX.DoNothing);this.BitrixCall.on("ParticipantJoined",BX.DoNothing);this.BitrixCall.on("ParticipantStateUpdated",BX.DoNothing);this.BitrixCall.on("ParticipantLeaved",BX.DoNothing);this.BitrixCall.on("MessageReceived",BX.DoNothing);this.BitrixCall.on("HandRaised",BX.DoNothing);this.BitrixCall.on("AllParticipantsAudioMuted",BX.DoNothing);this.BitrixCall.on("AllParticipantsVideoMuted",BX.DoNothing);this.BitrixCall.on("AllParticipantsScreenshareMuted",BX.DoNothing);this.BitrixCall.on("YouMuteAllParticipants",BX.DoNothing);this.BitrixCall.on("RoomSettingsChanged",BX.DoNothing);this.BitrixCall.on("UserPermissionsChanged",BX.DoNothing);this.BitrixCall.on("ParticipantMuted",BX.DoNothing);this.BitrixCall.on("VoiceStarted",BX.DoNothing);this.BitrixCall.on("VoiceEnded",BX.DoNothing);this.BitrixCall.on("Reconnecting",BX.DoNothing);this.BitrixCall.on("Reconnected",BX.DoNothing);this.BitrixCall.on("Disconnected",BX.DoNothing);this.BitrixCall.on("CallStatsReceived",BX.DoNothing);this.BitrixCall.on("UpdatePacketLoss",BX.DoNothing);this.BitrixCall.on("ConnectionQualityChanged",BX.DoNothing);this.BitrixCall.on("ToggleRemoteParticipantVideo",BX.DoNothing);this.BitrixCall.on("TrackSubscriptionFailed",BX.DoNothing)}}},{key:"subscribeHardwareChanges",value:function e(){H.subscribe(H.Events.onChangeMicrophoneMuted,this.setMuted);H.subscribe(H.Events.onChangeCameraOn,this.setVideoEnabled)}},{key:"unsubscribeHardwareChanges",value:function e(){H.unsubscribe(H.Events.onChangeMicrophoneMuted,this.setMuted);H.unsubscribe(H.Events.onChangeCameraOn,this.setVideoEnabled)}},{key:"addJoinedUsers",value:function e(t){for(var i=0;i<t.length;i++){var n=Number(t[i]);if(n==this.userId||this.peers[n]){continue}this.peers[n]=this.createPeer(n);if(!this.users.includes(n)){this.users.push(n)}this.runCallback(Ac.onUserInvited,{userId:n})}}},{key:"addInvitedUsers",value:function e(t,i){for(var n=0;n<t.length;n++){var a=Number(t[n]);if(a==this.userId){continue}if(!this.peers[a]){this.peers[a]=this.createPeer(a);this.runCallback(Ac.onUserInvited,{userId:a})}if(this.type===wc.Instant&&this.peers[a].calculatedState!==yc.Calling){this.peers[a].onInvited(i)}if(!this.users.includes(a)){this.users.push(a)}}}},{key:"toggleRemoteParticipantVideo",value:function e(t,i){var n=arguments.length>2&&arguments[2]!==undefined?arguments[2]:false;if(this.BitrixCall){this.BitrixCall.toggleRemoteParticipantVideo(t,i,n)}}},{key:"isAnyoneParticipating",value:function e(){for(var t in this.peers){if(this.peers[t].isParticipating()){return true}}return false}},{key:"getParticipatingUsers",value:function e(){var t=[];for(var i in this.peers){if(this.peers[i].isParticipating()){t.push(i)}}return t}},{key:"__onPullEvent",value:function e(t,i,n){if(this.pullEventHandlers[t]){if(t!=="Call::ping"){this.log("Signaling: "+t+"; Parameters: "+JSON.stringify(i))}this.pullEventHandlers[t].call(this,i)}}},{key:"__onPullEventAnswerSelf",value:function e(t){if(t.callInstanceId===this.instanceId){return}this.joinedElsewhere=true;this.runCallback(Ac.onJoin,{local:false})}},{key:"sendTelemetryEvent",value:function e(t){Yf.sendTelemetryEvent({call_id:this.id,user_id:this.userId,kind:"Bitrix",event:t})}},{key:"destroy",value:function e(){this.ready=false;this.joinedAsViewer=false;this.localVideoShown=false;this.floorRequestActive=false;if(this.localVAD){this.localVAD.destroy();this.localVAD=null}clearInterval(this.microphoneLevelInterval);if(this.BitrixCall){this.removeCallEvents();this.unsubscribeHardwareChanges();this.BitrixCall.hangup();this.BitrixCall=null}for(var i in this.peers){if(this.peers.hasOwnProperty(i)&&this.peers[i]){this.peers[i].destroy()}}clearTimeout(this.lastPingReceivedTimeout);clearTimeout(this.lastSelfPingReceivedTimeout);clearInterval(this.pingUsersInterval);clearInterval(this.pingBackendInterval);window.removeEventListener("unload",babelHelpers.classPrivateFieldGet(this,zh));return babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"destroy",this).call(this)}},{key:"provider",get:function e(){return Tc.Bitrix}},{key:"screenShared",get:function e(){return this._screenShared},set:function e(t){if(t!==this._screenShared){this._screenShared=t;this.signaling.sendScreenState(this._screenShared)}}},{key:"isCopilotActive",get:function e(){return this._isCopilotActive},set:function e(t){if(t!==this._isCopilotActive){this._isCopilotActive=t}}},{key:"isBoostExpired",get:function e(){return this._isBoostExpired},set:function e(t){if(t!==this._isBoostExpired){this._isBoostExpired=t}}},{key:"isCopilotFeaturesEnabled",get:function e(){return this._isCopilotFeaturesEnabled},set:function e(t){if(t!==this._isCopilotFeaturesEnabled){this._isCopilotFeaturesEnabled=t}}},{key:"isRecordWhenCopilotActivePopupAlreadyShow",get:function e(){return this._isRecordWhenCopilotActivePopupAlreadyShow},set:function e(t){if(t!==this._isRecordWhenCopilotActivePopupAlreadyShow){this._isRecordWhenCopilotActivePopupAlreadyShow=t}}},{key:"localUserState",get:function e(){return this._localUserState},set:function e(t){if(t===this._localUserState){return}this.runCallback(Ac.onUserStateChanged,{userId:this.userId,state:t,previousState:this._localUserState,direction:this.direction});this._localUserState=t}},{key:"reconnectionEventCount",get:function e(){return this._reconnectionEventCount},set:function e(t){if(this._reconnectionEventCount===0&&t>0){this.runCallback(Ac.onReconnecting,{reconnectionEventCount:t})}if(t===0){this.runCallback(Ac.onReconnected)}this._reconnectionEventCount=t}}]);return t}(Oi);function dp(e,t){if(e===ge.Camera){this.runCallback(Ac.onCameraPublishing,{publishing:t})}else if(e===ge.Microphone){this.runCallback(Ac.onMicrophonePublishing,{publishing:t})}}function hp(){this.reconnectionEventCount=0;this.log("Call connected");this.sendTelemetryEvent("connect");this.localUserState=yc.Connected;var e=Yf.countDisableCameraNewJoinedUsersFeature();if(Yf.isDisableCameraNewJoinedUsersFeatureEnabled()&&this.BitrixCall.remoteParticipantsCount>=e){H.isCameraOn=false}this.BitrixCall.on("Failed",babelHelpers.classPrivateFieldGet(this,Xh));this.signaling.sendMicrophoneState(!H.isMicrophoneMuted);this.signaling.sendCameraState(H.isCameraOn);if(!this.BitrixCall.isAudioPublished()){ih(this,hh,dp).call(this,ge.Microphone,true)}this.BitrixCall.enableAudio({calledFrom:"onCallConnected",disabled:H.isMicrophoneMuted});if(H.isCameraOn){this.localVideoShown=true;if(!this.BitrixCall.isVideoPublished()){ih(this,hh,dp).call(this,ge.Camera,true)}this.BitrixCall.enableVideo({calledFrom:"onCallConnected"})}if(this.videoAllowedFrom==Mc.none){this.signaling.sendHideAll()}else if(p.Type.isArray(this.videoAllowedFrom)){this.signaling.sendShowUsers(this.videoAllowedFrom)}}function pp(e){this.log("Could not attach to conference",e);this.sendTelemetryEvent("connect_failure");this.localUserState=yc.Failed;this.BitrixCall.enableSilentLogging(false);this.BitrixCall.setLoggerCallback(null)}babelHelpers.defineProperty(up,"Event",oh);var vp=new WeakSet;var fp=new WeakSet;var mp=new WeakSet;var gp=function(){function e(t){babelHelpers.classCallCheck(this,e);eh(this,mp);eh(this,fp);eh(this,vp);this.call=t.call}babelHelpers.createClass(e,[{key:"inviteUsers",value:function e(t){return ih(this,mp,kp).call(this,nh.invite,t)}},{key:"sendAnswer",value:function e(t,i){if(i&&Jp.getPullClient().isPublishingEnabled()){ih(this,vp,bp).call(this,ah.answer,t)}else{return ih(this,mp,kp).call(this,nh.answer,t)}}},{key:"sendHangup",value:function e(t){if(Jp.getPullClient().isPublishingEnabled()){ih(this,vp,bp).call(this,ah.hangup,t);t.retransmit=false;ih(this,mp,kp).call(this,nh.hangup,t)}else{t.retransmit=true;ih(this,mp,kp).call(this,nh.hangup,t)}}},{key:"sendFinish",value:function e(t){if(Jp.getPullClient().isPublishingEnabled()){ih(this,vp,bp).call(this,ah.hangup,t);t.retransmit=false;ih(this,mp,kp).call(this,nh.finish,t)}else{t.retransmit=true;ih(this,mp,kp).call(this,nh.finish,t)}}},{key:"sendCameraState",value:function e(t){return ih(this,fp,Cp).call(this,sh.cameraState,{cameraState:t?"Y":"N"})}},{key:"sendVideoPaused",value:function e(t){return ih(this,fp,Cp).call(this,sh.videoPaused,{videoPaused:t?"Y":"N"})}},{key:"sendMicrophoneState",value:function e(t){return ih(this,fp,Cp).call(this,sh.microphoneState,{microphoneState:t?"Y":"N"})}},{key:"sendScreenState",value:function e(t){return ih(this,fp,Cp).call(this,sh.screenState,{screenState:t?"Y":"N"})}},{key:"sendLocalRecordState",value:function e(t,i){ih(this,fp,Cp).call(this,sh.commonRecordState,{senderId:t,commonRecordState:i})}},{key:"sendCustomMessage",value:function e(t,i){return ih(this,fp,Cp).call(this,sh.customMessage,{message:t,repeatOnConnect:!!i})}},{key:"sendShowUsers",value:function e(t){return ih(this,fp,Cp).call(this,sh.showUsers,{users:t})}},{key:"sendShowAll",value:function e(){return ih(this,fp,Cp).call(this,sh.showAll,{})}},{key:"sendHideAll",value:function e(){return ih(this,fp,Cp).call(this,sh.hideAll,{})}},{key:"sendPingToUsers",value:function e(t){if(Jp.getPullClient().isPublishingEnabled()){ih(this,vp,bp).call(this,ah.ping,t,0)}}},{key:"sendPingToBackend",value:function e(){ih(this,mp,kp).call(this,nh.ping,{retransmit:false})}},{key:"sendUserInviteTimeout",value:function e(t){if(Jp.getPullClient().isPublishingEnabled()){ih(this,vp,bp).call(this,ah.userInviteTimeout,t,0)}}}]);return e}();function bp(e,t,i){i=i||5;if(!t.userId){throw new Error("userId is not found in data")}if(!p.Type.isArray(t.userId)){t.userId=[t.userId]}if(t.userId.length===0){return}t.callInstanceId=this.call.instanceId;t.senderId=this.call.userId;t.callId=this.call.id;t.requestId=Yf.getUuidv4();this.call.log("Sending p2p signaling event "+e+"; "+JSON.stringify(t));Jp.getPullClient().sendMessage(t.userId,"im",e,t,i)}function Cp(e,t){if(!this.call.BitrixCall){return}if(!p.Type.isPlainObject(t)){t={}}t.eventName=e;t.requestId=Yf.getUuidv4();t.senderId=this.call.userId;this.call.BitrixCall.sendMessage(JSON.stringify(t))}function kp(e,t){if(!p.Type.isPlainObject(t)){t={}}t.callId=this.call.id;t.callInstanceId=this.call.instanceId;t.requestId=Yf.getUuidv4();return Jp.getRestClient().callMethod(e,t)}var yp=function(){function e(t){babelHelpers.classCallCheck(this,e);this.userId=t.userId;this.call=t.call;this.ready=!!t.ready;this.calling=false;this.backgroundCalling=false;this.declined=false;this.busy=false;this.inviteTimeout=false;this.direction=t.direction||Sc.SendRecv;this.stream=null;this.mediaRenderers=[];this.isIncomingVideoAllowed=t.isIncomingVideoAllowed!==false;this.callingTimeout=0;this.callbacks={onStateChanged:p.Type.isFunction(t.onStateChanged)?t.onStateChanged:BX.DoNothing,onInviteTimeout:p.Type.isFunction(t.onInviteTimeout)?t.onInviteTimeout:BX.DoNothing,onMediaReceived:p.Type.isFunction(t.onMediaReceived)?t.onMediaReceived:BX.DoNothing,onMediaRemoved:p.Type.isFunction(t.onMediaRemoved)?t.onMediaRemoved:BX.DoNothing};this.calculatedState=this.calculateState()}babelHelpers.createClass(e,[{key:"setReady",value:function e(t){t=!!t;if(this.ready===t){return}this.ready=t;if(this.calling||this.backgroundCalling){clearTimeout(this.callingTimeout);this.calling=false;this.backgroundCalling=false;this.inviteTimeout=false}if(this.ready){this.declined=false;this.busy=false}this.updateCalculatedState()}},{key:"setDirection",value:function e(t){if(this.direction===t){return}this.direction=t}},{key:"setDeclined",value:function e(t){this.declined=t;if(this.calling||this.backgroundCalling){clearTimeout(this.callingTimeout);this.calling=false;this.backgroundCalling=false}if(this.declined){this.ready=false;this.busy=false}this.updateCalculatedState()}},{key:"setBusy",value:function e(t){this.busy=t;if(this.calling||this.backgroundCalling){clearTimeout(this.callingTimeout);this.calling=false;this.backgroundCalling=false}if(this.busy){this.ready=false;this.declined=false}this.updateCalculatedState()}},{key:"allowIncomingVideo",value:function e(t){if(this.isIncomingVideoAllowed==t){return}this.isIncomingVideoAllowed=!!t}},{key:"addMediaRenderer",value:function e(t){this.log("Adding media renderer for user"+this.userId,t);this.mediaRenderers.push(t);this.callbacks.onMediaReceived({userId:this.userId,kind:t.kind,mediaRenderer:t});this.updateCalculatedState()}},{key:"removeMediaRenderer",value:function e(t){this.log("Removing media renderer for user"+this.userId,t);var i;this.mediaRenderers.forEach((function(e,n){if(e.kind===t.kind){i=n}}));if(i>=0){this.mediaRenderers.splice(i,1)}this.callbacks.onMediaRemoved({userId:this.userId,kind:t.kind,mediaRenderer:t});this.updateCalculatedState()}},{key:"calculateState",value:function e(){if(this.participant){return yc.Connected}if(this.calling){return yc.Calling}if(this.inviteTimeout){return yc.Unavailable}if(this.declined){return yc.Declined}if(this.busy){return yc.Busy}if(this.ready){return yc.Ready}return yc.Idle}},{key:"updateCalculatedState",value:function e(){var t=this.calculateState();if(this.calculatedState!==t){this.callbacks.onStateChanged({userId:this.userId,state:t,previousState:this.calculatedState,direction:this.direction});this.calculatedState=t}}},{key:"isParticipating",value:function e(){return(this.calling||this.backgroundCalling||this.ready||this.participant)&&!this.declined}},{key:"onInvited",value:function e(){var t=this;var i=arguments.length>0&&arguments[0]!==undefined?arguments[0]:false;this.ready=false;this.inviteTimeout=false;this.declined=false;if(i){this.calling=true}else{this.backgroundCalling=true}if(this.callingTimeout){clearTimeout(this.callingTimeout)}this.callingTimeout=setTimeout((function(){return t.onInviteTimeout(true)}),3e4);this.updateCalculatedState()}},{key:"onInviteTimeout",value:function e(t){clearTimeout(this.callingTimeout);if(!(this.calling||this.backgroundCalling)){return}this.calling=false;this.backgroundCalling=false;this.inviteTimeout=true;if(t){this.callbacks.onInviteTimeout({userId:this.userId})}this.updateCalculatedState()}},{key:"log",value:function e(){this.call.log.apply(this.call,arguments)}},{key:"destroy",value:function e(){if(this.stream){Yf.stopMediaStream(this.stream);this.stream=null}this.callbacks.onStateChanged=BX.DoNothing;this.callbacks.onInviteTimeout=BX.DoNothing;this.callbacks.onMediaReceived=BX.DoNothing;this.callbacks.onMediaRemoved=BX.DoNothing;clearTimeout(this.callingTimeout);this.callingTimeout=null}}]);return e}();function Sp(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function wp(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?Sp(Object(i),!0).forEach((function(t){babelHelpers.defineProperty(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):Sp(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}function Ip(e,t){Tp(e,t);t.add(e)}function Tp(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}function Pp(e,t,i){if(!t.has(e)){throw new TypeError("attempted to get private field on non-instance")}return i}var _p={Instant:1,Permanent:2};var Ep={Plain:"Plain",Bitrix:"Bitrix"};var Rp={Incoming:"Incoming",Outgoing:"Outgoing"};var Mp={VeryHigh:"very_high",High:"high",Medium:"medium",Low:"low",VeryLow:"very_low"};var Ap={createCall:"im.call.create",createChildCall:"im.call.createChildCall",getPublicChannels:"pull.channel.public.list",getCall:"im.call.get"};var Lp={classic:1,jwt:2};var Bp=new WeakSet;var Dp=new WeakSet;var Hp=new WeakSet;var Np=new WeakSet;var xp=new WeakSet;var Op=new WeakSet;var Up=new WeakSet;var Fp=function(){function e(){babelHelpers.classCallCheck(this,e);Ip(this,Up);Ip(this,Op);Ip(this,xp);Ip(this,Np);Ip(this,Hp);Ip(this,Dp);Ip(this,Bp);babelHelpers.defineProperty(this,"handlers",{"Call::incoming":Pp(this,Hp,Wp).bind(this)});this.debugFlag=false;this.calls={};this.userId=Number(BX.message("USER_ID"));this.siteId="";this.unknownCalls={};this.restClient=null;this.pullClient=null;this.finishedCalls=new Set;this.init()}babelHelpers.createClass(e,[{key:"init",value:function e(){BX.addCustomEvent("onPullEvent-call",Pp(this,Bp,Vp).bind(this));BX.addCustomEvent("onPullEvent-im",Pp(this,Bp,Vp).bind(this));BX.addCustomEvent("onPullClientEvent-im",Pp(this,Dp,Gp).bind(this))}},{key:"getSiteId",value:function e(){return this.siteId||BX.message("SITE_ID")||""}},{key:"setSiteId",value:function e(t){this.siteId=t}},{key:"getCurrentUserId",value:function e(){return this.userId}},{key:"setCurrentUserId",value:function e(t){this.userId=Number(t)}},{key:"setRestClient",value:function e(t){this.restClient=t}},{key:"setPullClient",value:function e(t){this.pullClient=t}},{key:"getRestClient",value:function e(){return this.restClient||BX.rest}},{key:"getPullClient",value:function e(){return this.pullClient||BX.PULL}},{key:"getLogService",value:function e(){return BX.message("call_log_service")}},{key:"createCall",value:function e(t){var i=this;return new Promise((function(e,n){var a=t.type||_p.Instant;var s=t.provider||i.getDefaultProvider();if(t.joinExisting){for(var r in i.calls){if(i.calls.hasOwnProperty(r)){var o=i.calls[r];if(o.provider==t.provider&&o.associatedEntity.type==t.entityType&&o.associatedEntity.id==t.entityId){i.log(r,"Found existing call, attaching to it");BX.onCustomEvent(window,"CallEvents::callCreated",[{call:o}]);H.isCameraOn=t.videoEnabled===true;return e({call:o,isNew:false})}}}}var l={type:a,provider:s,entityType:t.entityType,entityId:t.entityId,joinExisting:!!t.joinExisting,userIds:p.Type.isArray(t.userIds)?t.userIds:[]};i.getRestClient().callMethod(Ap.createCall,l).then((function(a){if(a.error()){var s=a.error().getError();return n({code:s.error,message:s.error_description})}var r=a.data();if(r.userData){Yf.setUserData(r.userData)}if(r.publicChannels){i.getPullClient().setPublicIds(Object.values(r.publicChannels))}if(r.ai){kn.setup(r.ai)}var o=r.call;if(i.calls[o["ID"]]){if(i.calls[o["ID"]]instanceof dc){i.calls[o["ID"]].destroy()}else{console.error("Call "+o["ID"]+" already exists");return e({call:i.calls[o["ID"]],isNew:false})}}var l=Pp(i,Up,qp).call(i,o["PROVIDER"]);H.isCameraOn=t.videoEnabled===true;var c=l.createCall({id:parseInt(o["ID"]),uuid:o["UUID"],instanceId:Yf.getUuidv4(),direction:Rp.Outgoing,users:r.users,userData:r.userData,enableMicAutoParameters:t.enableMicAutoParameters!==false,type:o.TYPE,startDate:o.START_DATE,events:{onDestroy:Pp(i,xp,zp).bind(i)},debug:t.debug===true,logToken:r.logToken,connectionData:r.connectionData,isCopilotActive:o["RECORD_AUDIO"],scheme:o["SCHEME"]});c.addDialogInfo(o.ASSOCIATED_ENTITY);i.calls[o["ID"]]=c;if(r.isNew){i.log(c.id,"Creating new call")}else{i.log(c.id,"Server returned existing call, attaching to it")}BX.onCustomEvent(window,"CallEvents::callCreated",[{call:c}]);e({call:c,userData:r.userData,isNew:r.isNew})}))["catch"]((function(e){if(p.Type.isFunction(e.error)){e=e.error().getError()}n({code:e.error,message:e.error_description})}))}))}},{key:"createChildCall",value:function e(t,i,n,a){var s=this;if(!this.calls[t]){return Promise.reject("Parent call is not found")}return new Promise((function(e){var r=s.calls[t];var o={parentId:t,newProvider:i,newUsers:n};s.getRestClient().callMethod(Ap.createChildCall,o,(function(t){var i=t.data();var n=i.call;var o=Pp(s,Up,qp).call(s,n["PROVIDER"]);var l=o.createCall({id:parseInt(n["ID"]),uuid:n["UUID"],instanceId:Yf.getUuidv4(),parentId:n["PARENT_ID"],direction:Rp.Outgoing,users:i.users,userData:i.userData,enableMicAutoParameters:r.enableMicAutoParameters!==false,associatedEntity:n.ASSOCIATED_ENTITY,type:n.TYPE,startDate:n.START_DATE,events:{onDestroy:Pp(s,xp,zp).bind(s)},logToken:i.logToken,connectionData:i.connectionData,debug:a.debug,isCopilotActive:n["RECORD_AUDIO"],scheme:n["SCHEME"]});s.calls[n["ID"]]=l;BX.onCustomEvent(window,"CallEvents::callCreated",[{call:l}]);e({call:l,isNew:i.isNew})}))}))}},{key:"instantiateCall",value:function e(t,i,n,a,s){if(this.calls[t["ID"]]){console.error("Call "+t["ID"]+" already exists");return this.calls[t["ID"]]}var r=Pp(this,Up,qp).call(this,t["PROVIDER"]);var o=r.createCall({id:parseInt(t["ID"]),uuid:t["UUID"],instanceId:Yf.getUuidv4(),initiatorId:parseInt(t["INITIATOR_ID"]),parentId:t["PARENT_ID"],direction:t["INITIATOR_ID"]==this.userId?Rp.Outgoing:Rp.Incoming,users:i,userData:s,associatedEntity:wp({userCounter:Object.keys(s).length},t.ASSOCIATED_ENTITY),type:t.TYPE,startDate:t["START_DATE"],logToken:n,connectionData:a,isCopilotActive:t["RECORD_AUDIO"],scheme:t["SCHEME"],events:{onDestroy:Pp(this,xp,zp).bind(this)}});this.calls[t["ID"]]=o;BX.onCustomEvent(window,"CallEvents::callCreated",[{call:o}]);return o}},{key:"getCallWithId",value:function e(t){var i=this;if(this.calls[t]){return Promise.resolve({call:this.calls[t],isNew:false})}return new Promise((function(e,n){i.getRestClient().callMethod(Ap.getCall,{callId:t}).then((function(t){var n=t.data();e({call:i.instantiateCall(n.call,n.users,n.logToken,n.connectionData,n.userData),isNew:false})}))["catch"]((function(e){console.error(e);if(p.Type.isFunction(e.error)){e=e.error().getError()}n({code:e.error,message:e.error_description})}))}))}},{key:"getCallWithDialogId",value:function e(t){return Object.values(this.calls).find((function(e){var i;return((i=e.associatedEntity)===null||i===void 0?void 0:i.id)==t}))}},{key:"getDefaultProvider",value:function e(){return Ep.Plain}},{key:"getConferencePageTag",value:function e(t){return"conference-open-"+t}},{key:"debug",value:function e(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:true;this.debugFlag=!!t;return this.debugFlag}},{key:"log",value:function e(){var t=Yf.getLogMessage.call(Yf,arguments);if(r.DesktopApi.isDesktop()){r.DesktopApi.writeToLogFile(BX.message("USER_ID")+".video.log",t)}if(this.debugFlag){if(console){var i=["Call log ["+Yf.getTimeForLog()+"]: "];console.log.apply(this,i.concat(Array.prototype.slice.call(arguments)))}}}},{key:"getAllowedVideoQuality",value:function e(t){if(t<5){return Mp.VeryHigh}else if(t<10){return Mp.High}else if(t<16){return Mp.Medium}else if(t<32){return Mp.Low}else{return Mp.VeryLow}}}]);return e}();function Vp(e,t,i){var n,a=this;if((t===null||t===void 0?void 0:(n=t.call)===null||n===void 0?void 0:n.SCHEME)!==Lp.classic){return}if(e.startsWith("Call::")){if(t.publicIds){this.getPullClient().setPublicIds(Object.values(t.publicIds))}if(t.userData){Yf.setUserData(t.userData)}}if(this.handlers[e]){this.handlers[e].call(this,t,i)}else if(e.startsWith("Call::")&&(t["call"]||t["callId"])){var s=t["call"]?t["call"]["ID"]:t["callId"];if(this.calls[s]){this.calls[s].__onPullEvent(e,t,i)}else if(e==="Call::finish"){this.log(s,'Got "Call::finish" before "Call::incoming"');this.finishedCalls.add(s)}else if(e==="Call::ping"){Pp(this,Np,Xp).call(this,t,i).then((function(n){if(n&&a.calls[s]){a.calls[s].__onPullEvent(e,t,i)}}))}}}function Gp(e,t,i){var n=this;if(e.startsWith("Call::")&&t["callId"]){var a=t["callId"];if(this.calls[a]){this.calls[a].__onPullEvent(e,t,i)}else if(e==="Call::ping"){Pp(this,Np,Xp).call(this,t,i).then((function(s){if(s&&n.calls[a]){n.calls[a].__onPullEvent(e,t,i)}}))}}}function Wp(e,t){console.log("#onPullIncomingCall",location.href);if(t.server_time_ago>30){console.error("Call was started too long time ago");return}var i=e.call;var n=parseInt(i.ID);var a;if(this.finishedCalls.has(n)){this.log(n,'Got "Call::incoming" after "Call::finish"');return}if(e.publicIds){this.getPullClient().setPublicIds(Object.values(e.publicIds))}if(e.userData){Yf.setUserData(e.userData)}if(this.calls[n]){a=this.calls[n]}else{var s=Pp(this,Up,qp).call(this,i.PROVIDER);a=s.createCall({id:n,uuid:i.UUID,instanceId:Yf.getUuidv4(),parentId:i.PARENT_ID||null,callFromMobile:e.isLegacyMobile===true,direction:Rp.Incoming,users:e.users,userData:e.userData,initiatorId:e.senderId,associatedEntity:i.ASSOCIATED_ENTITY,type:i.TYPE,startDate:i.START_DATE,logToken:e.logToken,connectionData:e.connectionData,events:{onDestroy:Pp(this,xp,zp).bind(this)},isCopilotActive:i["RECORD_AUDIO"],scheme:i["SCHEME"]});this.calls[n]=a;BX.onCustomEvent(window,"CallEvents::callCreated",[{call:a}])}if(a){a.addInvitedUsers(e.invitedUsers);BX.onCustomEvent(window,"CallEvents::incomingCall",[{call:a,video:e.video===true,isLegacyMobile:e.isLegacyMobile===true}])}this.log(a.id,"Incoming call "+a.id)}function Xp(e,t){var i=this;var n=Number(e.callId);if(t.server_time_ago>10){this.log(n,"Error: Ping was sent too long time ago");return Promise.resolve(false)}if(!Pp(this,Op,jp).call(this)){return Promise.resolve(false)}if(this.unknownCalls[n]){return Promise.resolve(false)}this.unknownCalls[n]=true;if(e.userData){Yf.setUserData(e.userData)}return new Promise((function(e){i.getCallWithId(n).then((function(){i.unknownCalls[n]=false;e(true)}))["catch"]((function(t){i.unknownCalls[n]=false;i.log(n,"Error: Could not instantiate call",t);e(false)}))}))}function zp(e){var t=this;var i=e.call.id;this.calls[i]=new dc({callId:i,onDelete:function e(){if(t.calls[i]){delete t.calls[i]}}});BX.onCustomEvent(window,"CallEvents::callDestroyed",[{callId:e.call.id}])}function jp(){if("BXIM"in window&&"init"in window.BXIM){return BXIM.init}else if(BX.Messenger&&BX.Messenger.Application&&BX.Messenger.Application.conference){return BX.Messenger.Application.conference.inited}return true}function qp(e){if(e==Ep.Plain){return Yp}else if(e==Ep.Bitrix){return Qp}throw new Error("Unknown call provider type "+e)}var Yp=function(){function e(){babelHelpers.classCallCheck(this,e)}babelHelpers.createClass(e,null,[{key:"createCall",value:function e(t){return new ju(t)}}]);return e}();var Qp=function(){function e(){babelHelpers.classCallCheck(this,e)}babelHelpers.createClass(e,null,[{key:"createCall",value:function e(t){return new up(t)}}]);return e}();var Jp=new Fp;var Kp;function Zp(){/*! regenerator-runtime -- Copyright (c) 2014-present, Facebook, Inc. -- license (MIT): https://github.com/facebook/regenerator/blob/main/LICENSE */Zp=function t(){return e};var e={},t=Object.prototype,i=t.hasOwnProperty,n=Object.defineProperty||function(e,t,i){e[t]=i.value},a="function"==typeof Symbol?Symbol:{},s=a.iterator||"@@iterator",r=a.asyncIterator||"@@asyncIterator",o=a.toStringTag||"@@toStringTag";function l(e,t,i){return Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{l({},"")}catch(e){l=function e(t,i,n){return t[i]=n}}function c(e,t,i,a){var s=t&&t.prototype instanceof h?t:h,r=Object.create(s.prototype),o=new T(a||[]);return n(r,"_invoke",{value:y(e,i,o)}),r}function u(e,t,i){try{return{type:"normal",arg:e.call(t,i)}}catch(e){return{type:"throw",arg:e}}}e.wrap=c;var d={};function h(){}function p(){}function v(){}var f={};l(f,s,(function(){return this}));var m=Object.getPrototypeOf,g=m&&m(m(P([])));g&&g!==t&&i.call(g,s)&&(f=g);var b=v.prototype=h.prototype=Object.create(f);function C(e){["next","throw","return"].forEach((function(t){l(e,t,(function(e){return this._invoke(t,e)}))}))}function k(e,t){function a(n,s,r,o){var l=u(e[n],e,s);if("throw"!==l.type){var c=l.arg,d=c.value;return d&&"object"==babelHelpers["typeof"](d)&&i.call(d,"__await")?t.resolve(d.__await).then((function(e){a("next",e,r,o)}),(function(e){a("throw",e,r,o)})):t.resolve(d).then((function(e){c.value=e,r(c)}),(function(e){return a("throw",e,r,o)}))}o(l.arg)}var s;n(this,"_invoke",{value:function e(i,n){function r(){return new t((function(e,t){a(i,n,e,t)}))}return s=s?s.then(r,r):r()}})}function y(e,t,i){var n="suspendedStart";return function(a,s){if("executing"===n)throw new Error("Generator is already running");if("completed"===n){if("throw"===a)throw s;return _()}for(i.method=a,i.arg=s;;){var r=i.delegate;if(r){var o=S(r,i);if(o){if(o===d)continue;return o}}if("next"===i.method)i.sent=i._sent=i.arg;else if("throw"===i.method){if("suspendedStart"===n)throw n="completed",i.arg;i.dispatchException(i.arg)}else"return"===i.method&&i.abrupt("return",i.arg);n="executing";var l=u(e,t,i);if("normal"===l.type){if(n=i.done?"completed":"suspendedYield",l.arg===d)continue;return{value:l.arg,done:i.done}}"throw"===l.type&&(n="completed",i.method="throw",i.arg=l.arg)}}}function S(e,t){var i=t.method,n=e.iterator[i];if(undefined===n)return t.delegate=null,"throw"===i&&e.iterator["return"]&&(t.method="return",t.arg=undefined,S(e,t),"throw"===t.method)||"return"!==i&&(t.method="throw",t.arg=new TypeError("The iterator does not provide a '"+i+"' method")),d;var a=u(n,e.iterator,t.arg);if("throw"===a.type)return t.method="throw",t.arg=a.arg,t.delegate=null,d;var s=a.arg;return s?s.done?(t[e.resultName]=s.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=undefined),t.delegate=null,d):s:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,d)}function w(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function I(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function T(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(w,this),this.reset(!0)}function P(e){if(e){var t=e[s];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var n=-1,a=function t(){for(;++n<e.length;)if(i.call(e,n))return t.value=e[n],t.done=!1,t;return t.value=undefined,t.done=!0,t};return a.next=a}}return{next:_}}function _(){return{value:undefined,done:!0}}return p.prototype=v,n(b,"constructor",{value:v,configurable:!0}),n(v,"constructor",{value:p,configurable:!0}),p.displayName=l(v,o,"GeneratorFunction"),e.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===p||"GeneratorFunction"===(t.displayName||t.name))},e.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,v):(e.__proto__=v,l(e,o,"GeneratorFunction")),e.prototype=Object.create(b),e},e.awrap=function(e){return{__await:e}},C(k.prototype),l(k.prototype,r,(function(){return this})),e.AsyncIterator=k,e.async=function(t,i,n,a,s){void 0===s&&(s=Promise);var r=new k(c(t,i,n,a),s);return e.isGeneratorFunction(i)?r:r.next().then((function(e){return e.done?e.value:r.next()}))},C(b),l(b,o,"Generator"),l(b,s,(function(){return this})),l(b,"toString",(function(){return"[object Generator]"})),e.keys=function(e){var t=Object(e),i=[];for(var n in t)i.push(n);return i.reverse(),function e(){for(;i.length;){var n=i.pop();if(n in t)return e.value=n,e.done=!1,e}return e.done=!0,e}},e.values=P,T.prototype={constructor:T,reset:function e(t){if(this.prev=0,this.next=0,this.sent=this._sent=undefined,this.done=!1,this.delegate=null,this.method="next",this.arg=undefined,this.tryEntries.forEach(I),!t)for(var n in this)"t"===n.charAt(0)&&i.call(this,n)&&!isNaN(+n.slice(1))&&(this[n]=undefined)},stop:function e(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function e(t){if(this.done)throw t;var n=this;function a(e,i){return o.type="throw",o.arg=t,n.next=e,i&&(n.method="next",n.arg=undefined),!!i}for(var s=this.tryEntries.length-1;s>=0;--s){var r=this.tryEntries[s],o=r.completion;if("root"===r.tryLoc)return a("end");if(r.tryLoc<=this.prev){var l=i.call(r,"catchLoc"),c=i.call(r,"finallyLoc");if(l&&c){if(this.prev<r.catchLoc)return a(r.catchLoc,!0);if(this.prev<r.finallyLoc)return a(r.finallyLoc)}else if(l){if(this.prev<r.catchLoc)return a(r.catchLoc,!0)}else{if(!c)throw new Error("try statement without catch or finally");if(this.prev<r.finallyLoc)return a(r.finallyLoc)}}}},abrupt:function e(t,n){for(var a=this.tryEntries.length-1;a>=0;--a){var s=this.tryEntries[a];if(s.tryLoc<=this.prev&&i.call(s,"finallyLoc")&&this.prev<s.finallyLoc){var r=s;break}}r&&("break"===t||"continue"===t)&&r.tryLoc<=n&&n<=r.finallyLoc&&(r=null);var o=r?r.completion:{};return o.type=t,o.arg=n,r?(this.method="next",this.next=r.finallyLoc,d):this.complete(o)},complete:function e(t,i){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&i&&(this.next=i),d},finish:function e(t){for(var i=this.tryEntries.length-1;i>=0;--i){var n=this.tryEntries[i];if(n.finallyLoc===t)return this.complete(n.completion,n.afterLoc),I(n),d}},catch:function e(t){for(var i=this.tryEntries.length-1;i>=0;--i){var n=this.tryEntries[i];if(n.tryLoc===t){var a=n.completion;if("throw"===a.type){var s=a.arg;I(n)}return s}}throw new Error("illegal catch attempt")},delegateYield:function e(t,i,n){return this.delegate={iterator:P(t),resultName:i,nextLoc:n},"next"===this.method&&(this.arg=undefined),d}},e}function $p(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function ev(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?$p(Object(i),!0).forEach((function(t){babelHelpers.defineProperty(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):$p(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}var tv=(Kp={},babelHelpers.defineProperty(Kp,ge.Camera,"video"),babelHelpers.defineProperty(Kp,ge.Microphone,"audio"),babelHelpers.defineProperty(Kp,ge.Screen,"sharing"),babelHelpers.defineProperty(Kp,ge.ScreenAudio,"sharingAudio"),Kp);var iv="/bitrix/js/im/images/blank.gif";var nv={};var av={};var sv=null;var rv={AudioEnabled:false,VideoEnabled:false,ScreenShareEnabled:false};var ov={ask:false,audio:true,can_approve:false,change_role:false,change_settings:false,end_call:false,give_permissions:false,invite:false,join_call:false,kick_user:false,mute:false,mute_others:false,record_call:false,screen_share:true,update:false,video:true,view_users:false};var lv={ADMIN:"ADMIN",MANAGER:"MANAGER",USER:"USER"};var cv=[lv.USER];var uv=lv.USER;function dv(e){if(e){uv=e.toUpperCase()}}function hv(e){if(!p.Type.isPlainObject(e)){return}rv=e}function pv(e){if(this.isRegularUser(this.getCurrentUserRole())){var t=this.getUserPermissions();for(var i in e){if(e.hasOwnProperty(i)){switch(i){case"AudioEnabled":t.audio=e[i];break;case"VideoEnabled":t.video=e[i];break;case"ScreenShareEnabled":t.screen_share=e[i];break}}}this.setUserPermissions(t)}}function vv(e,t){if(this.isRegularUser(this.getCurrentUserRole())){var i=this.getUserPermissions();switch(e){case"audio":i.audio=t;break;case"video":i.video=t;break;case"screen_share":i.screen_share=t;break}this.setUserPermissions(i)}}function fv(e){return cv.includes(e)}function mv(){return rv}function gv(e){if(p.Type.isPlainObject(e)){for(var t in e){if(ov.hasOwnProperty(t)){ov[t]=e[t]}}}}function bv(){return ov}function Cv(){return uv}function kv(e){var t=false;switch(e){case"mic":t=ov.audio;break;case"cam":t=ov.video;break;case"screenshare":t=ov.screen_share;break}return t}function yv(){return!!(ov.change_settings&&df())}function Sv(){return!!ov.give_permissions}function wv(e){if(nv.hasOwnProperty(e)){return nv[e].role}}function Iv(e,t){var i=[];for(var n=0;n<t.length;n++){if(nv.hasOwnProperty(t[n])){continue}i.push(t[n])}var a=new Promise((function(n,a){if(i.length===0||!e){n();return}BX.ajax.runAction("im.call.getUsers",{data:{callId:e,userIds:i}}).then((function(e){var i=p.Type.isPlainObject(e.data)?e.data:{};t.forEach((function(e){if(i[e]){nv[e]=i[e]}delete av[e]}));n()}))["catch"]((function(e){a(e.answer)}))}));for(var s=0,r=i;s<r.length;s++){var o=r[s];av[o]=a}return a}function Tv(e){for(var t in e){nv[t]=e[t]}}var Pv=function e(){var t=new Date;return t.getFullYear()+"-"+Ev(t.getMonth()+1,2,"0")+"-"+Ev(t.getDate(),2,"0")+" "+Ev(t.getHours(),2,"0")+":"+Ev(t.getMinutes(),2,"0")+":"+Ev(t.getSeconds(),2,"0")+"."+t.getMilliseconds()};var _v=function e(){var t=new Date;return Ev(t.getHours(),2,"0")+":"+Ev(t.getMinutes(),2,"0")+":"+Ev(t.getSeconds(),2,"0")+"."+t.getMilliseconds()};function Ev(e,t,i){e=e.toString();i=i||" ";if(e.length>t){return e}var n="";for(var a=0;a<t-e.length;a++){n+=i}return n+e}function Rv(e,t){return new Promise((function(i,n){if(nv.hasOwnProperty(t)){return i(nv[t])}else if(av.hasOwnProperty(t)){av[t].then((function(){return i(nv[t])}))}else{Iv(e,[t]).then((function(){return i(nv[t])}))}}))}function Mv(e){return nv.hasOwnProperty(e)?nv[e]:null}function Av(e,t){return new Promise((function(i,n){Iv(e,t).then((function(){var e={};t.forEach((function(t){return e[t]=nv[t]||{}}));return i(e)}))}))}function Lv(e,t){return new Promise((function(i,n){if(nv.hasOwnProperty(t)){return i(nv[t].name?nv[t].name:"")}else if(av.hasOwnProperty(t)){av[t].then((function(){return i(nv[t].name?nv[t].name:"")}))}else{Iv(e,[t]).then((function(){return i(nv[t].name?nv[t].name:"")}))}}))}function Bv(e,t){return new Promise((function(i,n){if(nv.hasOwnProperty(t)){return i(nv[t].avatar_hr&&!rf(nv[t].avatar_hr)?nv[t].avatar_hr:"")}else if(av.hasOwnProperty(t)){av[t].then((function(){return i(nv[t].avatar_hr&&!rf(nv[t].avatar_hr)?nv[t].avatar_hr:"")}))}else{Iv(e,[t]).then((function(){return i(nv[t].avatar_hr&&!rf(nv[t].avatar_hr)?nv[t].avatar_hr:"")}))}}))}function Dv(e,t){return new Promise((function(i,n){Iv(e,t).then((function(){var e={};t.forEach((function(t){e[t]=nv[t].avatar_hr&&!rf(nv[t].avatar_hr)?nv[t].avatar_hr:""}));return i(e)}))}))}function Hv(e){return rf(e)}function Nv(e,t){var i;if(!p.Type.isPlainObject(t)){t={}}if(t.gender&&BX.message.hasOwnProperty(e+"_"+t.gender)){i=BX.message(e+"_"+t.gender)}else{i=BX.message(e)}t=xv(t);return i.replace(/#.+?#/gm,(function(e){var i=e.substr(1,e.length-2);return t.hasOwnProperty(i)?t[i]:e}))}function xv(e){var t=BX.util.objectClone(e);for(var i in t){var n=i.toUpperCase();if(n!=i){t[n]=t[i];delete t[i]}}return t}function Ov(e,t){t.forEach((function(t){return e.appendChild(t)}))}function Uv(e){if(!(e instanceof MediaStream)){return false}return e.getVideoTracks().length>0}function Fv(e){if(!(e instanceof MediaStream)||e.getVideoTracks().length===0){return false}var t=e.getVideoTracks()[0];var i=t.getSettings();return i.width>=1280}function Vv(e,t,i,n,a){n=n||0;a=a||0;var s=0;for(var r=1;r<=i;r++){var o=Gv(e,t,i,r);if(o.area>s&&o.elementWidth>n&&o.elementHeight>a){s=o.area;var l=o.elementWidth;var c=o.elementHeight}if(o.area<s){break}}if(s===0){l=n;c=a}return{width:l,height:c}}function Gv(e,t,i,n){var a=Math.ceil(i/n);var s=Math.floor(e/a);var r=Math.floor(t/n);var o=r/s;var l=9/16;var c;var u;if(o<l){c=r;u=Math.floor(s*(o/l))}else{u=s;c=Math.floor(r*(l/o))}var d=u*c*i;return{area:d,elementWidth:u,elementHeight:c}}var Wv=function e(){return typeof webkitRTCPeerConnection!="undefined"||typeof mozRTCPeerConnection!="undefined"||typeof RTCPeerConnection!="undefined"};var Xv=function e(){return BX.message("call_server_enabled")==="Y"};var zv=function e(){return BX.message("call_allow_feedback")==="Y"};var jv=function e(){return BX.message("call_collect_stats")==="Y"};var qv=function e(){return BX.message("call_docs_status")!=="N"||BX.message("call_resumes_status")!=="N"};var Yv=function e(){if(!BX.message("call_docs_status").startsWith("L")){return false}return BX.message("call_docs_status").substr(2)};var Qv=function e(){if(!BX.message("call_resumes_status").startsWith("L")){return false}return BX.message("call_resumes_status").substr(2)};var Jv=function e(){if(Xv()){return parseInt(BX.message("call_server_max_users"))}return parseInt(BX.message("turn_server_max_users"))};var Kv=function e(){var t;return(t=BX.message("call_client_selftest_url"))!==null&&t!==void 0?t:""};var Zv=function e(){return BX.message("call_features")};function $v(){var e=Pv();for(var t=0;t<arguments.length;t++){if(arguments[t]instanceof Error){e=arguments[t].message+"\n"+arguments[t].stack}else{try{e=e+" | "+(babelHelpers["typeof"](arguments[t])=="object"?JSON.stringify(arguments[t]):arguments[t])}catch(t){e=e+" | (circular structure)"}}}return e}var ef=function e(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){var t=Math.random()*16|0,i=e=="x"?t:t&3|8;return i.toString(16)}))};function tf(e,t){BX.ajax.runAction("im.call.reportConnection",{data:{callId:e,connectionResult:t}})}function nf(e){}var af=function e(){return typeof BXDesktopSystem!="undefined"||typeof BXDesktopWindow!="undefined"};var sf=function e(){if(BX.browser.IsOpera()){return"opera"}if(BX.browser.IsChrome()){return"chrome"}if(BX.browser.IsFirefox()){return"firefox"}if(BX.browser.IsSafari()){return"safari"}return"other"};function rf(e){return typeof e!=="string"||e==""||e.endsWith(iv)}function of(e){if(!e instanceof MediaStream){return}e.getAudioTracks().forEach((function(t){if(t.kind==="audio"){t.stop();e.removeTrack(t)}}))}function lf(e){if(!e instanceof MediaStream){return}e.getTracks().forEach((function(t){if(t.kind==="video"){t.stop();e.removeTrack(t)}}))}function cf(e){if(!e instanceof MediaStream){return}e.getTracks().forEach((function(e){e.stop()}))}function uf(){if(Xv()){return Tc.Bitrix}return Tc.Plain}function df(){for(var e in tu.calls){if(tu.calls[e].BitrixCall){return tu.calls[e];break}}for(var t in Jp.calls){if(Jp.calls[t].BitrixCall){return Jp.calls[t];break}}return false}function hf(e,t,i){if(t[e.codecId]){e.codecName=t[e.codecId];return true}return false}function pf(e,t){if(t[e.codecId]){t[e.codecId].push(e)}else{t[e.codecId]=[e]}}function vf(e,t,i){t[e.id]=e.mimeType;if(i[e.id]){i[e.id].forEach((function(t){t.codecName=e.mimeType}));delete i[e.id]}}function ff(e,t,i){if(t[e.id]){var n=gf(e,t[e.id]);e.packetsLostData=n;e.packetsLost=n.totalPacketsLost;e.packetsLostExtended=Cf(n);delete t[e.id];return true}else if(!e.packetsLostExtended){i[e.id]=e;return false}}function mf(e,t,i){t=t||{};var n=i?e.bytesSent-(t.bytesSent||0):e.bytesReceived-(t.bytesReceived||0);var a=e.timestamp-(t.timestamp||0);var s=8*n/(a/1e3);return s<0?0:Math.trunc(s)}function gf(e,t,i){t=t||{};var n=Math.abs(i.packetsLost);var a=e.packetsSent-(t.packetsSent||0);var s=n-(t.packetsLost||0);var r=s/a*100||0;var o=n/e.packetsSent*100||0;return{currentPacketsLost:s,currentPercentPacketLost:r>=0?Math.trunc(r):0,totalPacketsLost:n,totalPercentPacketLost:Math.trunc(o)}}function bf(e,t){t=t||{};var i=Math.abs(e.packetsLost);var n=e.packetsReceived-(t.packetsReceived||0);var a=i-(t.packetsLost||0);var s=a/(n+a)*100||0;var r=i/(e.packetsReceived+i)*100||0;return{currentPacketsLost:a,currentPercentPacketLost:s>=0?Math.trunc(s):0,totalPacketsLost:i,totalPercentPacketLost:Math.trunc(r)}}function Cf(e){return"".concat(e.currentPacketsLost," - ").concat(e.currentPercentPacketLost,"% (total: ").concat(e.totalPacketsLost," - ").concat(e.totalPercentPacketLost,"%)")}function kf(){var e=["#0154C8","#1BCE7B","#B15EF5","#55D0E0","#F85E9E","#0075FF","#00A94E"];return e[Math.floor(Math.random()*e.length)]}function yf(e){var t=arguments.length>1&&arguments[1]!==undefined?arguments[1]:false;if(!e){return""}var i=new Date;var n=new Date(e.date.start);if(n>i){n=i}var a=e.date.pause.map((function(e){var t=e.start,n=e.finish;var a=new Date(t);var s=n?new Date(n):i;return s-a})).reduce((function(e,t){return e+t}),0);var s=i-n-a;if(s<0){s=0}var r=Math.round(s/1e3);if(t){return r}var o=Math.floor(r/3600);r%=3600;var l=Math.floor(r/60);r%=60;return o>0?"".concat(o,":").concat(String(l).padStart(2,"0"),":").concat(String(r).padStart(2,"0")):"".concat(l,":").concat(String(r).padStart(2,"0"))}function Sf(e){if(!e){return""}var t=new Date;var i=new Date(e);if(i.getTime()<t.getTime()){i=t}var n=t-i;if(n<=0){n=0}var a=Math.floor(n/1e3);var s=Math.floor(a/60/60);if(s>0){a-=s*60*60}var r=Math.floor(a/60);if(r>0){a-=r*60}return(s>0?s+":":"")+(s>0?r.toString().padStart(2,"0")+":":r+":")+a.toString().padStart(2,"0")}function wf(e){if(!e){return""}var t=new Date;var i=new Date(e);if(i.getTime()<t.getDate()){i=t}var n=t-i;if(n<=0){n=0}return Math.floor(n/1e3)}var If=function e(){return BX.message("conference_chat_enabled")};var Tf=function(){var e=babelHelpers.asyncToGenerator(Zp().mark((function e(t,i){var n,a=arguments;return Zp().wrap((function e(s){while(1)switch(s.prev=s.next){case 0:n=a.length>2&&a[2]!==undefined?a[2]:true;if(!p.Type.isPlainObject(t)){t={}}return s.abrupt("return",new Promise(function(){var e=babelHelpers.asyncToGenerator(Zp().mark((function e(a,s){var r,o,l,c,u,h,p;return Zp().wrap((function e(v){while(1)switch(v.prev=v.next){case 0:sv=new AbortController;r=g.CallSettingsManager.callBalancerUrl;o="".concat(r,"/v2/join?mustCreate=").concat(Boolean(n));v.next=5;return d.CallTokenManager.getUserToken(i);case 5:l=v.sent;c=t.provider===Tc.Plain;u=Ic.Small;h=JSON.stringify(ev({userToken:l,roomType:u,isOneToOne:c,clientVersion:me,clientPlatform:fe},t));p=null;fetch(o,{method:"POST",body:h,signal:sv.signal}).then((function(e){p={status:e===null||e===void 0?void 0:e.status,ok:e===null||e===void 0?void 0:e.ok};return e.json()}))["catch"]((function(e){if(e instanceof SyntaxError){throw new Be(e.message,Me.JsonParsingError)}else{throw e}})).then((function(e){var t;if(!((t=p)!==null&&t!==void 0&&t.ok)){if(e!==null&&e!==void 0&&e.error){var i,n;throw new Be(e===null||e===void 0?void 0:(i=e.error)===null||i===void 0?void 0:i.message,e===null||e===void 0?void 0:(n=e.error)===null||n===void 0?void 0:n.code)}else{throw new Be("Response status: ".concat(p.status),Me.UnexpectedResponse)}}a(e)}))["catch"]((function(e){try{var t;if(e!==null&&e!==void 0&&(t=e.xhr)!==null&&t!==void 0&&t.responseText){var i=JSON.parse(e.xhr.responseText);if(i.error){s(i)}}}catch(e){s(e)}s(e)}))["finally"]((function(){sv=null}));case 11:case"end":return v.stop()}}),e)})));return function(t,i){return e.apply(this,arguments)}}()));case 3:case"end":return s.stop()}}),e)})));return function t(i,n){return e.apply(this,arguments)}}();var Pf=function(){var e=babelHelpers.asyncToGenerator(Zp().mark((function e(t){var i;return Zp().wrap((function e(n){while(1)switch(n.prev=n.next){case 0:n.next=2;return tu.getCallWithId(t);case 2:i=n.sent;return n.abrupt("return",Tf({callType:i.call.type,instanceId:i.call.instanceId,provider:i.call.provider,callToken:d.CallTokenManager.getTokenCached(i.call.associatedEntity.chatId)},i.call.associatedEntity.chatId,false));case 4:case"end":return n.stop()}}),e)})));return function t(i){return e.apply(this,arguments)}}();var _f=function e(){var t;(t=sv)===null||t===void 0?void 0:t.abort()};function Ef(){var e=BX.Call.Util.getClientSelfTestUrl();if(af()){window.open(e,"_blank","popup");return}window.open(e,"_blank")}var Rf=function e(){return BX.message("call_use_tcp_sdp")==="Y"};function Mf(e){var t=BX.UI.InfoHelper;if(t.isOpen()){t.close()}t.show(e)}var Af=function e(){var t;return((t=p.Extension.getSettings("call.core"))===null||t===void 0?void 0:t.ai)||{}};var Lf=function e(){var t;return((t=p.Extension.getSettings("call.core"))===null||t===void 0?void 0:t.cloudRecord)||{}};var Bf=function e(){var t;return(t=p.Extension.getSettings("call.core"))===null||t===void 0?void 0:t.isUserControlFeatureEnabled};var Df=function e(){var t;return(t=p.Extension.getSettings("call.core"))===null||t===void 0?void 0:t.isDisableCameraNewJoinedUsersFeatureEnabled};var Hf=function e(){var t;return(t=p.Extension.getSettings("call.core"))===null||t===void 0?void 0:t.countDisableCameraNewJoinedUsersFeature};var Nf=function e(){var t;return(t=p.Extension.getSettings("call.core"))===null||t===void 0?void 0:t.isStreamQualityFeatureEnabled};var xf=function e(){var t;return(t=p.Extension.getSettings("call.core"))===null||t===void 0?void 0:t.isPictureInPictureFeatureEnabled};var Of=function e(){var t;return(t=p.Extension.getSettings("call.core"))===null||t===void 0?void 0:t.isMetricsEnabled};var Uf=function e(){var t;return(t=p.Extension.getSettings("call.core"))===null||t===void 0?void 0:t.isMetricsLogsEnabled};var Ff=function e(){var t;return(t=p.Extension.getSettings("call.core"))===null||t===void 0?void 0:t.isKibanaLogsEnabled};var Vf=function e(){var t,i;return((t=p.Extension.getSettings("call.core"))===null||t===void 0?void 0:t.isAirDesignEnabled)&&((i=p.Extension.getSettings("call.core"))===null||i===void 0?void 0:i.shouldHideQuickAccess)};var Gf=function e(){var t;return(t=p.Extension.getSettings("call.core"))===null||t===void 0?void 0:t.isCloudRecordEnabled};var Wf=function e(){var t;return(t=p.Extension.getSettings("call.core"))===null||t===void 0?void 0:t.isCloudRecordTariffEnabled};var Xf=function e(){var t;return(t=p.Extension.getSettings("call.core"))===null||t===void 0?void 0:t.isCloudRecordLogEnabled};var zf=function e(t){return[Di.Stopped,Di.Destroyed].includes(t)};function jf(e){var t=new p.Event.BaseEvent({data:e});p.Event.EventEmitter.emit("BX.Call.Logger:sendLog",t)}function qf(e){if(typeof e==="string"){try{var t=JSON.parse(e);if(babelHelpers["typeof"](t)==="object"&&t!==null){return qf(t)}return t}catch(t){return e}}else if(Array.isArray(e)){return e.map((function(e){return qf(e)}))}else if(babelHelpers["typeof"](e)==="object"&&e!==null){var i={};Object.keys(e).forEach((function(t){i[t]=qf(e[t])}));return i}else{return e}}var Yf={MediaKind:tv,updateUserData:Iv,setUserData:Tv,getDateForLog:Pv,getTimeForLog:_v,lpad:Ev,getUser:Rv,getUserCached:Mv,getUsers:Av,getUserName:Lv,getUserAvatar:Bv,getUserAvatars:Dv,isAvatarBlank:Hv,getCustomMessage:Nv,convertKeysToUpper:xv,appendChildren:Ov,containsVideoTrack:Uv,hasHdVideo:Fv,findBestElementSize:Vv,getFilledArea:Gv,isWebRTCSupported:Wv,isCallServerAllowed:Xv,isFeedbackAllowed:zv,shouldCollectStats:jv,shouldShowDocumentButton:qv,getDocumentsArticleCode:Yv,getResumesArticleCode:Qv,getUserLimit:Jv,getClientSelfTestUrl:Kv,getLogMessage:$v,getUuidv4:ef,reportConnectionResult:tf,sendTelemetryEvent:nf,isDesktop:af,getBrowserForStatistics:sf,isBlank:rf,stopMediaStream:cf,stopMediaStreamVideoTracks:lf,stopMediaStreamAudioTracks:of,getConferenceProvider:uf,getCurrentBitrixCall:df,setCodecToReport:hf,saveReportWithoutCodecs:pf,processReportsWithoutCodecs:vf,setLocalPacketsLostOrSaveReport:ff,calcBitrate:mf,calcLocalPacketsLost:gf,calcRemotePacketsLost:bf,formatPacketsLostData:Cf,getCallFeatures:Zv,getAvatarBackground:kf,getRecordTimeText:yf,getTimeText:Sf,getTimeInSeconds:wf,isConferenceChatEnabled:If,getCallConnectionData:Tf,getCallConnectionDataById:Pf,abortGetCallConnectionData:_f,startSelfTest:Ef,useTcpSdp:Rf,openArticle:Mf,getAiSettings:Af,isStreamQualityFeatureEnabled:Nf,getCloudRecordSettings:Lf,isUserControlFeatureEnabled:Bf,isPictureInPictureFeatureEnabled:xf,isMetricsEnabled:Of,isMetricsLogsEnabled:Uf,sendLog:jf,isChatMountInPage:Vf,roomPermissions:rv,getCurrentUserRole:Cv,havePermissionToBroadcast:kv,setRoomPermissions:hv,getRoomPermissions:mv,setUserPermissions:gv,getUserPermissions:bv,updateUserPermissionByNewRoomPermission:vv,setUserPermissionsByRoomPermissions:pv,canControlChangeSettings:yv,canControlGiveSpeakPermission:Sv,setCurrentUserRole:dv,UsersRoles:lv,isRegularUser:fv,getUserRoleByUserId:wv,isDisableCameraNewJoinedUsersFeatureEnabled:Df,countDisableCameraNewJoinedUsersFeature:Hf,isKibanaLogsEnabled:Ff,deepParseJSON:qf,isCloudRecordEnabled:Gf,isCloudRecordTariffEnabled:Wf,isCommonRecordStateInactive:zf,isCloudRecordLogEnabled:Xf};function Qf(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function Jf(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?Qf(Object(i),!0).forEach((function(t){babelHelpers.defineProperty(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):Qf(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}function Kf(e,t){Zf(e,t);t.add(e)}function Zf(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}function $f(e,t,i){if(!t.has(e)){throw new TypeError("attempted to get private field on non-instance")}return i}var em={onClose:"onClose",onDestroy:"onDestroy",onButtonClick:"onButtonClick"};var tm={setHasCamera:"CallNotification::setHasCamera",contentReady:"CallNotification::contentReady",onButtonClick:"CallNotification::onButtonClick"};var im=76;var nm="IncomingNotification";var am=new WeakSet;var sm=new WeakSet;var rm=new WeakSet;var om=new WeakSet;var lm=function(e){babelHelpers.inherits(t,e);function t(e){var i;babelHelpers.classCallCheck(this,t);i=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this));Kf(babelHelpers.assertThisInitialized(i),om);Kf(babelHelpers.assertThisInitialized(i),rm);Kf(babelHelpers.assertThisInitialized(i),sm);Kf(babelHelpers.assertThisInitialized(i),am);i.setEventNamespace("BX.Call.IncomingNotification");i.popup=null;i.window=null;i.callerAvatar=p.Type.isStringFilled(e.callerAvatar)?e.callerAvatar:"";if(Yf.isAvatarBlank(i.callerAvatar)){i.callerAvatar=""}i.callerName=e.callerName;i.callerType=e.callerType;i.callerColor=e.callerColor;i.video=e.video;i.hasCamera=e.hasCamera===true;i.zIndex=e.zIndex;i.isMessengerOpen=e.isMessengerOpen;i.contentReady=false;i.postponedEvents=[];i.microphoneState=e.microphoneState;i.cameraState=e.cameraState;$f(babelHelpers.assertThisInitialized(i),am,cm).call(babelHelpers.assertThisInitialized(i),e);if(r.DesktopApi.isDesktop()){i.onButtonClickHandler=$f(babelHelpers.assertThisInitialized(i),rm,dm).bind(babelHelpers.assertThisInitialized(i));i.onContentReadyHandler=$f(babelHelpers.assertThisInitialized(i),om,hm).bind(babelHelpers.assertThisInitialized(i));r.DesktopApi.subscribe(tm.onButtonClick,i.onButtonClickHandler);r.DesktopApi.subscribe(tm.contentReady,i.onContentReadyHandler)}var n=new BroadcastChannel(nm);n.onmessage=function(e){if(e.data.desktopWindowIsReady){$f(babelHelpers.assertThisInitialized(i),sm,um).call(babelHelpers.assertThisInitialized(i))}};return i}babelHelpers.createClass(t,[{key:"show",value:function e(){var t=this;console.log("incoming notification : SHOW");var i={video:this.video,hasCamera:this.hasCamera,callerAvatar:this.callerAvatar,callerName:this.callerName,callerType:this.callerType,callerColor:this.callerColor,microphoneState:this.microphoneState,cameraState:this.cameraState,isMessengerOpen:this.isMessengerOpen};if(r.DesktopApi.isChatWindow()){console.log("incoming notification : ISDESKTOP");if(this.window){this.window.BXDesktopWindow.ExecuteCommand("show")}else{this.content=new km(Jf({},i));var n="\n\t\t\t\t\tconst broadcastChannel = new BroadcastChannel('".concat(nm,"');\n\t\t\t\t\tbroadcastChannel.postMessage({ desktopWindowIsReady: true });\n\t\t\t\t");var a=r.DesktopApi.prepareHtml("",n);this.window=r.DesktopApi.createTopmostWindow(a)}}else{console.log("incoming notification : ISNOTDESKTOP");this.content=new km(Jf(Jf({},i),{},{onClose:function e(){return t.emit(em.onClose)},onDestroy:function e(){return t.emit(em.onDestroy)},onButtonClick:function e(i){return t.emit(em.onButtonClick,Jf({},i.data))}}));this.createPopup(this.content.render());this.popup.show();window.addEventListener("resize",(function(){t.onResize()}))}}},{key:"onResize",value:function e(){if(this.popup){this.popup.setMaxHeight(document.body.clientHeight)}}},{key:"createPopup",value:function e(t){var i=this;this.popup=new v.Popup({id:"bx-messenger-call-notify",bindElement:null,targetContainer:document.body,content:t,closeIcon:false,noAllPaddings:true,zIndex:this.zIndex,disableScroll:true,maxHeight:document.body.clientHeight,offsetLeft:0,offsetTop:0,closeByEsc:false,draggable:{restrict:false},borderRadius:"25px",overlay:{backgroundColor:"black",opacity:30},events:{onPopupClose:function e(){window.removeEventListener("resize",(function(){i.onResize()}));i.emit(em.onClose)},onPopupDestroy:function e(){return i.popup=null}}})}},{key:"setHasCamera",value:function e(t){if(this.window){if(this.contentReady){r.DesktopApi.emit(tm.setHasCamera,[t])}else{this.postponedEvents.push({name:tm.setHasCamera,params:[t]})}}else if(this.content){this.content.setHasCamera(t)}}},{key:"sendPostponedEvents",value:function e(){this.postponedEvents.forEach((function(e){r.DesktopApi.emit(e.name,e.params)}));this.postponedEvents=[]}},{key:"close",value:function e(){if(this.popup){this.popup.close()}if(this.window){var t,i;var n=(t=window.BXDesktopSystem)===null||t===void 0?void 0:(i=t.ApiVersion)===null||i===void 0?void 0:i.call(t);this.window.BXDesktopWindow.ExecuteCommand("hide");if(n>=im){this.window.BXDesktopWindow.ExecuteCommand("close");this.window=null}}this.emit(em.onClose)}},{key:"destroy",value:function e(){if(this.popup){this.popup.destroy();this.popup=null}if(this.window){this.window.BXDesktopWindow.ExecuteCommand("close");this.window=null}if(this.content){this.content.destroy();this.content=null}if(r.DesktopApi.isDesktop()){r.DesktopApi.unsubscribe(tm.onButtonClick,this.onButtonClickHandler);r.DesktopApi.unsubscribe(tm.contentReady,this.onContentReadyHandler)}this.emit(em.onDestroy);this.unsubscribeAll(em.onButtonClick);this.unsubscribeAll(em.onClick);this.unsubscribeAll(em.onDestroy)}}]);return t}(f.EventEmitter);function cm(e){var t=Object.keys(em);for(var i=0,n=t;i<n.length;i++){var a=n[i];if(p.Type.isFunction(e[a])){this.subscribe(em[a],e[a])}}}function um(){var e,t;if(!this.window){return}if((e=this.window.opener.BXIM)!==null&&e!==void 0&&e.callController&&!this.window.opener.BXIM.callController.callNotification){console.log("Workaround to prevent incoming call window from hanging");this.window.BXDesktopWindow.ExecuteCommand("close");return}var i=352;var n=495;p.Dom.append(this.content.render(),this.window.document.body);(t=this.window.BXDesktopWindow)===null||t===void 0?void 0:t.SetProperty("position",{X:"STP_CENTER",Y:"STP_VCENTER",Width:i,Height:n})}function dm(e){this.emit(em.onButtonClick,e)}function hm(){this.contentReady=true;this.sendPostponedEvents()}babelHelpers.defineProperty(lm,"Events",em);var pm=new WeakSet;var vm=new WeakSet;var fm=new WeakSet;var mm=new WeakSet;var gm=new WeakSet;var bm=new WeakSet;var Cm=new WeakSet;var km=function(e){babelHelpers.inherits(t,e);function t(e){var i;babelHelpers.classCallCheck(this,t);i=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this));Kf(babelHelpers.assertThisInitialized(i),Cm);Kf(babelHelpers.assertThisInitialized(i),bm);Kf(babelHelpers.assertThisInitialized(i),gm);Kf(babelHelpers.assertThisInitialized(i),mm);Kf(babelHelpers.assertThisInitialized(i),fm);Kf(babelHelpers.assertThisInitialized(i),vm);Kf(babelHelpers.assertThisInitialized(i),pm);i.setEventNamespace("BX.Call.IncomingNotificationContent");i.video=Boolean(e.video);i.hasCamera=Boolean(e.hasCamera);i.callerAvatar=e.callerAvatar||"";i.callerName=e.callerName||BX.message("IM_M_CALL_VIDEO_HD");i.callerType=e.callerType||"chat";i.callerColor=e.callerColor||"";i.microphoneState=e.microphoneState;i.cameraState=e.cameraState;i.isMessengerOpen=e.isMessengerOpen;i.elements={root:null,avatar:null,buttons:{answerVideo:null}};$f(babelHelpers.assertThisInitialized(i),pm,ym).call(babelHelpers.assertThisInitialized(i),e);if(r.DesktopApi.isDesktop()){i.onHasCameraHandler=$f(babelHelpers.assertThisInitialized(i),vm,Sm).bind(babelHelpers.assertThisInitialized(i));r.DesktopApi.subscribe(tm.setHasCamera,i.onHasCameraHandler);r.DesktopApi.emitToMainWindow(tm.contentReady,[])}return i}babelHelpers.createClass(t,[{key:"render",value:function e(){var t=BX.message("IM_M_VIDEO_CALL_FROM_MSGVER_1");var i="";var n;var a="";if(this.callerAvatar){n={backgroundImage:"url('".concat(Fi(this.callerAvatar),"')"),backgroundSize:"cover"}}else{var s=this.callerType==="private"?"user":this.callerType;i="bx-messenger-panel-avatar-".concat(s);n={backgroundColor:this.callerColor||"#525252",backgroundSize:"40px",backgroundPosition:"center center"};a=u.Utils.text.getFirstLetters(this.callerName).toUpperCase()}this.elements.root=p.Dom.create("div",{props:{className:"bx-messenger-call-window".concat(r.DesktopApi.isDesktop()?" desktop":"")},children:[p.Dom.create("div",{props:{className:"bx-messenger-call-window-body"},children:[p.Dom.create("div",{props:{className:"bx-messenger-call-window-top"},children:[p.Dom.create("div",{props:{className:"bx-messenger-call-window-title"},children:[p.Dom.create("div",{props:{className:"bx-messenger-call-overlay-title-caller-prefix"},children:[p.Dom.create("div",{props:{className:"bx-messenger-call-overlay-title-caller-prefix-icon"}}),p.Dom.create("div",{props:{className:"bx-messenger-call-overlay-title-caller-prefix-text"},text:t})]}),p.Dom.create("div",{props:{className:"bx-messenger-call-overlay-title-caller"},text:p.Text.decode(this.callerName)})]}),p.Dom.create("div",{props:{className:"bx-messenger-call-window-photo bx-messenger-videocall-incoming-call-avatar-pulse"},children:[p.Dom.create("div",{props:{className:"bx-messenger-videocall-incoming-call-pulse-element"}}),p.Dom.create("div",{props:{className:"bx-messenger-videocall-incoming-call-pulse-element"}}),p.Dom.create("div",{props:{className:"bx-messenger-call-window-photo-left ".concat(i)},children:[this.elements.avatar=p.Dom.create("div",{props:{className:"bx-messenger-call-window-photo-block"},style:n,text:a})]})]})]}),this.elements.windowBottom=p.Dom.create("div",{props:{className:"bx-messenger-call-window-bottom"},children:[p.Dom.create("div",{props:{className:"bx-messenger-call-window-buttons"},children:[this.elements.buttonsBlock=p.Dom.create("div",{props:{className:"bx-messenger-call-window-buttons-block"},children:[]})]})]})]})]});this.elements.windowBottom.prepend(p.Dom.create("div",{props:{className:"bx-messenger-call-window-settings-buttons-block"},children:[p.Dom.create("div",{props:{className:"bx-messenger-call-window-settings-button"},children:[this.elements.buttons.toggleMicrophoneIcon=p.Dom.create("div",{props:{className:"bx-messenger-call-window-settings-icon microphone-".concat(this.microphoneState?"on":"off")}}),p.Dom.create("div",{props:{className:"bx-messenger-call-window-settings-text microphone"},text:BX.message("IM_M_CALL_BTN_MIC")})],events:{click:$f(this,fm,wm).bind(this)}}),p.Dom.create("div",{props:{className:"bx-messenger-call-window-settings-button".concat(this.hasCamera?"":" bx-messenger-call-window-button-disabled")},children:[this.elements.buttons.toggleCameraIcon=p.Dom.create("div",{props:{className:"bx-messenger-call-window-settings-icon camera-".concat(this.cameraState&&this.hasCamera?"on":"off")}}),p.Dom.create("div",{props:{className:"bx-messenger-call-window-settings-text camera"},text:BX.message("IM_M_CALL_BTN_CAMERA")})],events:{click:$f(this,mm,Im).bind(this)}})]}));this.elements.buttonsBlock.append(p.Dom.create("div",{props:{className:"bx-messenger-call-window-button-container"},children:[p.Dom.create("div",{props:{className:"bx-messenger-call-window-button bx-messenger-call-window-button-danger"},children:[p.Dom.create("div",{props:{className:"bx-messenger-call-window-button-icon bx-messenger-call-window-button-icon-phone-down"}})]})],events:{click:$f(this,Cm,Pm).bind(this)}}),this.elements.buttons.answer=p.Dom.create("div",{props:{className:"bx-messenger-call-window-button-container"},children:[p.Dom.create("div",{props:{className:"bx-messenger-call-window-button".concat(this.withBlur?" with-blur":"")},children:[p.Dom.create("div",{props:{className:"bx-messenger-call-window-button-icon bx-messenger-call-window-button-icon-phone-up"}})]})],events:{click:$f(this,gm,Tm).bind(this)}}));return this.elements.root}},{key:"setHasCamera",value:function e(t){this.hasCamera=Boolean(t)}},{key:"destroy",value:function e(){if(r.DesktopApi.isDesktop()){r.DesktopApi.unsubscribe(tm.setHasCamera,this.onHasCameraHandler)}this.unsubscribeAll(em.onButtonClick);this.unsubscribeAll(em.onClick);this.unsubscribeAll(em.onDestroy)}}]);return t}(f.EventEmitter);function ym(e){var t=Object.keys(em);for(var i=0,n=t;i<n.length;i++){var a=n[i];if(p.Type.isFunction(e[a])){this.subscribe(em[a],e[a])}}}function Sm(){}function wm(){this.microphoneState=!this.microphoneState;if(this.microphoneState){this.elements.buttons.toggleMicrophoneIcon.classList.add("microphone-on");this.elements.buttons.toggleMicrophoneIcon.classList.remove("microphone-off")}else{this.elements.buttons.toggleMicrophoneIcon.classList.add("microphone-off");this.elements.buttons.toggleMicrophoneIcon.classList.remove("microphone-on")}}function Im(){this.cameraState=!this.cameraState;if(this.cameraState){this.elements.buttons.toggleCameraIcon.classList.add("camera-on");this.elements.buttons.toggleCameraIcon.classList.remove("camera-off")}else{this.elements.buttons.toggleCameraIcon.classList.add("camera-off");this.elements.buttons.toggleCameraIcon.classList.remove("camera-on")}}function Tm(){if(!this.hasCamera){this.cameraState=false;this.microphoneState=true}if(r.DesktopApi.isDesktop()){r.DesktopApi.closeWindow();r.DesktopApi.emitToMainWindow(tm.onButtonClick,[{button:"answer",mediaParams:{audio:this.microphoneState,video:this.cameraState}}])}else{this.emit(em.onButtonClick,{button:"answer",mediaParams:{audio:this.microphoneState,video:this.cameraState}})}}function Pm(){if(r.DesktopApi.isDesktop()){r.DesktopApi.closeWindow();r.DesktopApi.emitToMainWindow(tm.onButtonClick,[{button:"decline"}])}else{this.emit(em.onButtonClick,{button:"decline"})}}var _m={onButtonClick:"ConferenceNotification::onButtonClick"};var Em=function(){function e(t){babelHelpers.classCallCheck(this,e);this.popup=null;this.window=null;this.callerAvatar=p.Type.isStringFilled(t.callerAvatar)?t.callerAvatar:"";this.zIndex=t.zIndex;if(Yf.isAvatarBlank(this.callerAvatar)){this.callerAvatar=""}this.callerName=t.callerName;this.callerColor=t.callerColor;this.callbacks={onClose:p.Type.isFunction(t.onClose)?t.onClose:BX.DoNothing,onDestroy:p.Type.isFunction(t.onDestroy)?t.onDestroy:BX.DoNothing,onButtonClick:p.Type.isFunction(t.onButtonClick)?t.onButtonClick:BX.DoNothing};this._onContentButtonClickHandler=this._onContentButtonClick.bind(this);if(r.DesktopApi.isDesktop()){r.DesktopApi.subscribe(_m.onButtonClick,this._onContentButtonClickHandler)}}babelHelpers.createClass(e,[{key:"show",value:function e(){var t=this;if(r.DesktopApi.isChatWindow()){var i={callerAvatar:this.callerAvatar,callerName:this.callerName,callerColor:this.callerColor};if(this.window){this.window.BXDesktopWindow.ExecuteCommand("show")}else{var n="\n\t\t\t\t\twindow.conferenceNotification = new BX.Call.NotificationConferenceContent(".concat(JSON.stringify(i),");\n\t\t\t\t\twindow.conferenceNotification.showInDesktop();\n\t\t\t\t");var a=r.DesktopApi.prepareHtml("",n);this.window=r.DesktopApi.createTopmostWindow(a)}}else{this.content=new Rm({callerAvatar:this.callerAvatar,callerName:this.callerName,callerColor:this.callerColor,onClose:this.callbacks.onClose,onDestroy:this.callbacks.onDestroy,onButtonClick:this.callbacks.onButtonClick});this.createPopup(this.content.render());this.popup.show();window.addEventListener("resize",(function(){t.onResize()}))}}},{key:"onResize",value:function e(){if(this.popup){this.popup.setMaxHeight(document.body.clientHeight)}}},{key:"createPopup",value:function e(t){this.popup=new v.Popup({id:"bx-messenger-call-notify",targetContainer:document.body,content:t,closeIcon:false,noAllPaddings:true,zIndex:this.zIndex,offsetLeft:0,offsetTop:0,closeByEsc:false,draggable:{restrict:false},borderRadius:"25px",disableScroll:true,maxHeight:document.body.clientHeight,overlay:{backgroundColor:"black",opacity:30},events:{onPopupClose:function(){var e=this;window.removeEventListener("resize",(function(){e.onResize()}));this.callbacks.onClose()}.bind(this),onPopupDestroy:function(){this.popup=null}.bind(this)}})}},{key:"close",value:function e(){if(this.popup){this.popup.close()}if(this.window){this.window.BXDesktopWindow.ExecuteCommand("hide")}this.callbacks.onClose()}},{key:"destroy",value:function e(){if(this.popup){this.popup.destroy();this.popup=null}if(this.window){this.window.BXDesktopWindow.ExecuteCommand("close");this.window=null}if(r.DesktopApi.isDesktop()){r.DesktopApi.unsubscribe(_m.onButtonClick,this._onContentButtonClickHandler)}this.callbacks.onDestroy()}},{key:"_onContentButtonClick",value:function e(t){this.callbacks.onButtonClick(t)}}]);return e}();var Rm=function(){function e(t){babelHelpers.classCallCheck(this,e);this.callerAvatar=t.callerAvatar||"";this.callerName=t.callerName||BX.message("IM_CL_USER");this.callerColor=t.callerColor||"#525252";this.elements={root:null,avatar:null};this.callbacks={onClose:p.Type.isFunction(t.onClose)?t.onClose:BX.DoNothing,onDestroy:p.Type.isFunction(t.onDestroy)?t.onDestroy:BX.DoNothing,onButtonClick:p.Type.isFunction(t.onButtonClick)?t.onButtonClick:BX.DoNothing}}babelHelpers.createClass(e,[{key:"render",value:function e(){var t;var i="";if(this.callerAvatar){t={backgroundImage:"url('".concat(this.callerAvatar,"')"),backgroundSize:"cover"}}else{t={backgroundImage:"none",backgroundColor:this.callerColor,backgroundSize:"80px",backgroundRepeat:"no-repeat",backgroundPosition:"center center"};i=u.Utils.text.getFirstLetters(this.callerName).toUpperCase()}this.elements.root=p.Dom.create("div",{props:{className:"bx-messenger-call-window".concat(r.DesktopApi.isDesktop()?" desktop":"")},children:[p.Dom.create("div",{props:{className:"bx-messenger-call-window-body"},children:[p.Dom.create("div",{props:{className:"bx-messenger-call-window-top center"},children:[p.Dom.create("div",{props:{className:"bx-messenger-call-window-title"},children:[p.Dom.create("div",{props:{className:"bx-messenger-call-overlay-title-caller-prefix"},children:[p.Dom.create("div",{props:{className:"bx-messenger-call-overlay-title-caller-prefix-icon"}}),p.Dom.create("div",{props:{className:"bx-messenger-call-overlay-title-caller-prefix-text"},text:BX.message("IM_M_VIDEO_CALL_FROM_MSGVER_1")})]}),p.Dom.create("div",{text:p.Text.encode(this.callerName),props:{className:"bx-messenger-call-overlay-title-caller"}})]}),p.Dom.create("div",{props:{className:"bx-messenger-call-window-photo bx-messenger-videocall-incoming-call-avatar-pulse"},children:[p.Dom.create("div",{props:{className:"bx-messenger-videocall-incoming-call-pulse-element"}}),p.Dom.create("div",{props:{className:"bx-messenger-videocall-incoming-call-pulse-element"}}),p.Dom.create("div",{props:{className:"bx-messenger-call-window-photo-left"},children:[this.elements.avatar=p.Dom.create("div",{props:{className:"bx-messenger-call-window-photo-block"},style:t,text:i})]})]})]}),p.Dom.create("div",{props:{className:"bx-messenger-call-window-bottom"},children:[p.Dom.create("div",{props:{className:"bx-messenger-call-window-buttons"},children:[this.elements.buttonsBlock=p.Dom.create("div",{props:{className:"bx-messenger-call-window-buttons-block"},children:[]})]})]})]})]});this.elements.buttonsBlock.append(p.Dom.create("div",{props:{className:"bx-messenger-call-window-button-container"},children:[p.Dom.create("div",{props:{className:"bx-messenger-call-window-button bx-messenger-call-window-button-danger"},children:[p.Dom.create("div",{props:{className:"bx-messenger-call-window-button-icon bx-messenger-call-window-button-icon-phone-down"}})]})],events:{click:this._onSkipConferenceButtonClick.bind(this)}}),p.Dom.create("div",{props:{className:"bx-messenger-call-window-button-container"},children:[p.Dom.create("div",{props:{className:"bx-messenger-call-window-button".concat(this.withBlur?" with-blur":"")},children:[p.Dom.create("div",{props:{className:"bx-messenger-call-window-button-icon bx-messenger-call-window-button-icon-phone-up"}})]})],events:{click:this._onAnswerConferenceButtonClick.bind(this)}}));return this.elements.root}},{key:"showInDesktop",value:function e(){var t=352;var i=495;this.render();document.body.appendChild(this.elements.root);r.DesktopApi.setWindowPosition({x:STP_CENTER,y:STP_VCENTER,width:t,height:i})}},{key:"_onAnswerConferenceButtonClick",value:function e(t){if(r.DesktopApi.isDesktop()){r.DesktopApi.closeWindow();r.DesktopApi.emitToMainWindow(_m.onButtonClick,[{button:"answerConference"}])}else{this.callbacks.onButtonClick({button:"answerConference"})}}},{key:"_onSkipConferenceButtonClick",value:function e(t){if(r.DesktopApi.isDesktop()){r.DesktopApi.closeWindow();r.DesktopApi.emitToMainWindow(_m.onButtonClick,[{button:"skipConference"}])}else{this.callbacks.onButtonClick({button:"skipConference"})}}}]);return e}();var Mm={onBackToCallClick:"FloatingScreenshare::onBackToCallClick",onStopSharingClick:"FloatingScreenshare::onStopSharingClick",onChangeScreenClick:"FloatingScreenshare::onChangeScreenClick"};var Am=291;var Lm=81;var Bm=80;var Dm=80;var Hm=function(){function e(t){babelHelpers.classCallCheck(this,e);if(babelHelpers["typeof"](t)!=="object"){t={}}this.darkMode=t.darkMode||false;this.window=null;this.sharedWindowX=null;this.sharedWindowY=null;this.sharedWindowHeight=null;this.sharedWindowWidth=null;this.title="";this.app="";this.screens=[];this.screenToUse=null;this.callbacks={onBackToCallClick:p.Type.isFunction(t.onBackToCallClick)?t.onBackToCallClick:BX.DoNothing,onStopSharingClick:p.Type.isFunction(t.onStopSharingClick)?t.onStopSharingClick:BX.DoNothing,onChangeScreenClick:p.Type.isFunction(t.onChangeScreenClick)?t.onChangeScreenClick:BX.DoNothing};this._onBackToCallClickHandler=this._onBackToCallClick.bind(this);this._onStopSharingClickHandler=this._onStopSharingClick.bind(this);this._onChangeScreenClickHandler=this._onChangeScreenClick.bind(this);this.bindEventHandlers()}babelHelpers.createClass(e,[{key:"bindEventHandlers",value:function e(){r.DesktopApi.subscribe(Mm.onBackToCallClick,this._onBackToCallClickHandler);r.DesktopApi.subscribe(Mm.onStopSharingClick,this._onStopSharingClickHandler);r.DesktopApi.subscribe(Mm.onChangeScreenClick,this._onChangeScreenClickHandler)}},{key:"saveExistingScreens",value:function e(){var t=this;return new Promise((function(e,i){if(t.screens.length>0){return e()}BXDesktopSystem.ListScreenMedia((function(i){i.forEach((function(e){if(e.id.slice(0,6)==="screen"){t.screens.push({id:e.id,x:e.x,y:e.y,width:e.width,height:e.height})}}));return e()}))}))}},{key:"_onBackToCallClick",value:function e(){this.callbacks.onBackToCallClick()}},{key:"_onStopSharingClick",value:function e(){this.close();this.callbacks.onStopSharingClick()}},{key:"_onChangeScreenClick",value:function e(){this.callbacks.onChangeScreenClick()}},{key:"setSharingData",value:function e(t){var i=this;return this.saveExistingScreens().then((function(){i.sharedWindowX=t.x+10;i.sharedWindowY=t.y+10;i.sharedWindowWidth=t.width;i.sharedWindowHeight=t.height;i.title=t.title;i.app=t.app;for(var e=0;e<i.screens.length;e++){if(i.sharedWindowX>=i.screens[e].x&&i.sharedWindowX<=i.screens[e].x+i.screens[e].width&&i.sharedWindowY>=i.screens[e].y&&i.sharedWindowY<=i.screens[e].y+i.screens[e].height){i.screenToUse=i.screens[e];break}}if(!i.screenToUse&&i.screens.length>0){i.screenToUse=i.screens[0]}}))["catch"]((function(e){console.log("save existing screens error",e)}))}},{key:"show",value:function e(){if(!r.DesktopApi.isDesktop()||r.DesktopApi.getApiVersion()>74){return}if(this.window){this.window.BXDesktopWindow.ExecuteCommand("show")}else{var t={title:this.title,app:this.app,sharedWindowX:this.sharedWindowX,sharedWindowY:this.sharedWindowY,sharedWindowWidth:this.sharedWindowWidth,sharedWindowHeight:this.sharedWindowHeight,screenToUse:this.screenToUse,darkMode:this.darkMode};var i="window.FSSC = new BX.Call.FloatingScreenShareContent(".concat(JSON.stringify(t),");");var n=r.DesktopApi.prepareHtml("",i);this.window=r.DesktopApi.createTopmostWindow(n)}}},{key:"hide",value:function e(){if(!this.window||!this.window.document){return false}this.window.BXDesktopWindow.ExecuteCommand("hide")}},{key:"close",value:function e(){if(!this.window||!this.window.document){return false}this.window.BXDesktopWindow.ExecuteCommand("close");this.window=null;this.visible=false}},{key:"destroy",value:function e(){if(this.window){r.DesktopApi.closeWindow();this.window=null}r.DesktopApi.unsubscribe(Mm.onBackToCallClick,this._onBackToCallClickHandler);r.DesktopApi.unsubscribe(Mm.onStopSharingClick,this._onStopSharingClickHandler);r.DesktopApi.unsubscribe(Mm.onChangeScreenClick,this._onChangeScreenClickHandler)}}]);return e}();var Nm=function(){function e(t){babelHelpers.classCallCheck(this,e);this.title=t.title||"";this.app=t.app||"";this.sharedWindowX=t.sharedWindowX||0;this.sharedWindowY=t.sharedWindowY||0;this.sharedWindowHeight=t.sharedWindowHeight||0;this.sharedWindowWidth=t.sharedWindowWidth||0;this.screenToUse=t.screenToUse||null;this.darkMode=t.darkMode||false;this.elements={container:null};this.render();this.adjustWindow(Am,Lm)}babelHelpers.createClass(e,[{key:"render",value:function e(){var t=this.app?this.app+" - "+this.title:this.title;this.elements.container=p.Dom.create("div",{props:{className:"bx-messenger-call-floating-screenshare-wrap"+(this.darkMode?" dark-mode":"")},children:[p.Dom.create("div",{props:{className:"bx-messenger-call-floating-screenshare-top"},children:[p.Dom.create("div",{props:{className:"bx-messenger-call-floating-screenshare-top-icon"}}),p.Dom.create("div",{props:{className:"bx-messenger-call-floating-screenshare-top-text",title:t},text:t})]}),p.Dom.create("div",{props:{className:"bx-messenger-call-floating-screenshare-bottom"},children:[p.Dom.create("div",{props:{className:"bx-messenger-call-floating-screenshare-bottom-left"},children:[p.Dom.create("div",{props:{className:"bx-messenger-call-floating-screenshare-back-icon"}}),p.Dom.create("div",{props:{className:"bx-messenger-call-floating-screenshare-back-text"},text:BX.message("IM_M_CALL_SCREENSHARE_BACK_TO_CALL")})],events:{click:this.onBackToCallClick.bind(this)}}),p.Dom.create("div",{props:{className:"bx-messenger-call-floating-screenshare-bottom-center"},children:[p.Dom.create("div",{props:{className:"bx-messenger-call-floating-screenshare-change-screen-icon"}}),p.Dom.create("div",{props:{className:"bx-messenger-call-floating-screenshare-change-screen-text"},text:BX.message("IM_M_CALL_SCREENSHARE_CHANGE_SCREEN")})],events:{click:this.onChangeScreenClick.bind(this)}}),p.Dom.create("div",{props:{className:"bx-messenger-call-floating-screenshare-bottom-right"},children:[p.Dom.create("div",{props:{className:"bx-messenger-call-floating-screenshare-stop-icon"}}),p.Dom.create("div",{props:{className:"bx-messenger-call-floating-screenshare-stop-text"},text:BX.message("IM_M_CALL_SCREENSHARE_STOP")})],events:{click:this.onStopSharingClick.bind(this)}})]})]});document.body.appendChild(this.elements.container);document.body.classList.add("bx-messenger-call-floating-screenshare")}},{key:"onBackToCallClick",value:function e(){this.dispatchEvent(Mm.onBackToCallClick,[])}},{key:"onChangeScreenClick",value:function e(){this.dispatchEvent(Mm.onChangeScreenClick,[])}},{key:"onStopSharingClick",value:function e(){this.dispatchEvent(Mm.onStopSharingClick,[])}},{key:"adjustWindow",value:function e(t,i){if(!this.screenToUse){return}var n=22;var a=22;var s=document.querySelector(".bx-messenger-call-floating-screenshare-bottom-left").scrollWidth;var r=document.querySelector(".bx-messenger-call-floating-screenshare-bottom-center").scrollWidth;var o=document.querySelector(".bx-messenger-call-floating-screenshare-bottom-right").scrollWidth;var l=s+r+o+2*n+2*a;if(l>Am){t=l}this.elements.container.style.width=t+"px";this.elements.container.style.height=i+"px";BXDesktopWindow.SetProperty("minClientSize",{Width:t,Height:i});BXDesktopWindow.SetProperty("resizable",false);BXDesktopWindow.SetProperty("closable",false);BXDesktopWindow.SetProperty("title",BX.message("IM_M_CALL_SCREENSHARE_TITLE"));BXDesktopWindow.SetProperty("position",{X:this.screenToUse.x+this.screenToUse.width-t-Bm,Y:this.screenToUse.y+Dm,Width:t,Height:i,Mode:STP_FRONT})}},{key:"dispatchEvent",value:function e(t,i){var n={};for(var a=0;a<i.length;a++){n[a]=i[a]}var s=opener?opener:top;s.BXWindows.forEach((function(e){if(e&&e.name!==""&&e.BXDesktopWindow&&e.BXDesktopWindow.DispatchCustomEvent){e.BXDesktopWindow.DispatchCustomEvent(t,n)}}));s.BXDesktopWindow.DispatchCustomEvent(t,n)}}]);return e}();var xm=function(){function e(t){babelHelpers.classCallCheck(this,e);this.popup=null;this.title=BX.prop.getString(t,"title",p.Text.encode(BX.message("IM_CALL_MIC_MUTED_WHILE_TALKING")));this.icon=BX.prop.getString(t,"icon","mic");this.bindElement=BX.prop.getElementNode(t,"bindElement",null);this.targetContainer=BX.prop.getElementNode(t,"targetContainer",null);this.callFolded=BX.prop.getBoolean(t,"callFolded",false);this.showAngle=BX.prop.getBoolean(t,"showAngle",false);this.autoCloseDelay=BX.prop.getInteger(t,"autoCloseDelay",5e3);this.maxWidth=BX.prop.getInteger(t,"maxWidth",600);this.customClassName=BX.prop.getString(t,"customClassName","");this.initiatorName=BX.prop.getString(t,"initiatorName","");this.customRender=BX.prop.getFunction(t,"customRender",false);this.buttonsLayout=BX.prop.getString(t,"buttonsLayout","right");this.buttons=BX.prop.getArray(t,"buttons",[]);this.callbacks={onClose:BX.prop.getFunction(t,"onClose",BX.DoNothing),onAskSpeakButtonClicked:BX.prop.getFunction(t,"onAskSpeakButtonClicked",BX.DoNothing)};this.autoCloseTimeout=0}babelHelpers.createClass(e,[{key:"show",value:function e(){var t=this;clearTimeout(this.autoCloseTimeout);if(this.autoCloseDelay>0){this.autoCloseTimeout=setTimeout((function(){return t.onAutoClose()}),this.autoCloseDelay)}if(this.popup){this.popup.show();return}this.popup=new v.Popup({bindElement:this.bindElement,targetContainer:this.targetContainer,content:this.render(),padding:0,contentPadding:0,className:"bx-call-view-popup-call-hint "+this.customClassName,background:"#00428F",contentBackground:"#00428F",darkMode:true,contentBorderRadius:"27px",borderRadius:"27px",angle:this.showAngle&&this.bindElement,events:{onClose:function e(){return t.popup.destroy()},onDestroy:function e(){return t.popup=null}}});this.popup.show()}},{key:"render",value:function e(){var t=this;return p.Dom.create("div",{props:{className:"bx-call-view-popup-call-hint-body layout-"+this.buttonsLayout},children:[p.Dom.create("div",{props:{className:"bx-call-view-popup-call-hint-icon "+this.icon}}),this.customRender?this.customRender():this.renderPopupMessage(),this.buttonsLayout==="right"?this.renderButtons():null,p.Dom.create("div",{props:{className:"bx-call-view-popup-call-hint-close"},events:{click:function e(){t.callbacks.onClose();if(t.popup){t.popup.close()}}}})]})}},{key:"createAskSpeakButton",value:function e(){var t=this;return new BX.UI.Button({baseClass:"ui-btn",text:BX.message("CALL_RISE_YOU_HAND_IN_HINT"),size:BX.UI.Button.Size.EXTRA_SMALL,color:BX.UI.Button.Color.LIGHT_BORDER,noCaps:true,round:true,events:{click:function e(){t.callbacks.onAskSpeakButtonClicked()}}})}},{key:"renderButtons",value:function e(){return p.Dom.create("div",{props:{className:"bx-call-view-popup-call-hint-buttons-container"},children:this.buttons.map((function(e){return e.render()}))})}},{key:"renderPopupMessage",value:function e(){return p.Dom.create("div",{props:{className:"bx-call-view-popup-call-hint-middle-block"},children:[p.Dom.create("div",{props:{className:"bx-call-view-popup-call-hint-text"},html:this.getPopupMessage()}),this.buttonsLayout==="bottom"?this.renderButtons():null]})}},{key:"getPopupMessage",value:function e(){if(!Yf.isDesktop()){return this.title}var t=BX.message("IM_CALL_MIC_MUTED_WHILE_TALKING_HOTKEY");if(this.callFolded){var i=BX.browser.IsMac()?"Shift + &#8984; + A":"Ctrl + Shift + A";t=BX.message("IM_CALL_MIC_MUTED_WHILE_TALKING_FOLDED_CALL_HOTKEY").replace("#HOTKEY#",i)}t='<span class="bx-call-view-popup-call-hint-text-hotkey">'+t+"</span>";return this.title+(this.buttonsLayout==="bottom"?"":"<br>")+t}},{key:"getPopupHeight",value:function e(){return Yf.isDesktop()?60:54}},{key:"close",value:function e(){if(this.popup){this.popup.close();this.callbacks.onClose()}}},{key:"onAutoClose",value:function e(){this.close()}},{key:"destroy",value:function e(){if(this.popup){this.popup.destroy()}clearTimeout(this.autoCloseTimeout)}}]);return e}();var Om={onActionClick:"onActionClick",onClose:"onClose"};var Um=function(){function e(t){babelHelpers.classCallCheck(this,e);t=p.Type.isPlainObject(t)?t:{};this.promoCode=p.Type.isStringFilled(t.promoCode)?t.promoCode:"";this.bindElement=t.bindElement;this.elements={root:null};this.popup=null;this.dontShowAgain=false;this.eventEmitter=new f.EventEmitter(this,"BX.Call.PromoPopup");if(t.events){this.subscribeToEvents(t.events)}}babelHelpers.createClass(e,[{key:"subscribeToEvents",value:function e(t){for(var i in t){if(t.hasOwnProperty(i)){this.eventEmitter.subscribe(i,t[i])}}}},{key:"render",value:function e(){this.elements.root=p.Dom.create("div",{props:{className:"bx-call-promo-container"},children:[p.Dom.create("div",{props:{className:"bx-call-promo-content"},children:[p.Dom.create("div",{props:{className:"bx-call-promo-icon-section"},children:[p.Dom.create("div",{props:{className:"bx-call-promo-icon"}})]}),p.Dom.create("div",{props:{className:"bx-call-promo-text-section"},children:[p.Dom.create("div",{props:{className:"bx-call-promo-title"},text:BX.message("IM_CALL_DOCUMENT_PROMO_TITLE_MSGVER_2")}),p.Dom.create("div",{props:{className:"bx-call-promo-text"},html:BX.message("IM_CALL_DOCUMENT_PROMO_TEXT")}),p.Dom.create("div",{props:{className:"bx-call-promo-refuse"},children:[p.Dom.create("input",{attrs:{type:"checkbox"},props:{className:"bx-call-promo-refuse-checkbox",id:"bx-call-promo-refuse-checkbox"},events:{change:this.onCheckboxChange.bind(this)}}),p.Dom.create("label",{attrs:{for:"bx-call-promo-refuse-checkbox"},props:{className:"bx-call-promo-refuse-text"},text:BX.message("IM_CALL_DOCUMENT_PROMO_DONT_SHOW_AGAIN")})]})]}),p.Dom.create("div",{props:{className:"bx-call-promo-button-section"},children:[p.Dom.create("button",{props:{className:"bx-call-promo-button bx-call-promo-button-action ui-btn ui-btn-round"},text:BX.message("IM_CALL_DOCUMENT_PROMO_ACTION"),events:{click:this.onActionClick.bind(this)}}),p.Dom.create("button",{props:{className:"bx-call-promo-button bx-call-promo-button-action-close ui-btn ui-btn-round"},text:BX.message("IM_CALL_DOCUMENT_PROMO_ACTION_CLOSE"),events:{click:this.close.bind(this)}})]})]})]})}},{key:"show",value:function e(){if(!this.elements.root){this.render()}this.createPopup();this.popup.show()}},{key:"close",value:function e(){if(!this.popup){return false}this.popup.close()}},{key:"createPopup",value:function e(){this.popup=new v.Popup({id:"bx-call-promo-popup",bindElement:this.bindElement,targetContainer:document.body,content:this.elements.root,cacheable:false,closeIcon:true,bindOptions:{position:"top"},angle:{position:"bottom",offset:49},className:"bx-call-promo-popup",contentBackground:"unset",events:{onPopupClose:this.onPopupClose.bind(this)}})}},{key:"onPopupClose",value:function e(){this.popup.destroy();this.destroy()}},{key:"onCheckboxChange",value:function e(t){this.dontShowAgain=t.currentTarget.checked}},{key:"onActionClick",value:function e(){this.eventEmitter.emit(Om.onActionClick)}},{key:"destroy",value:function e(){this.eventEmitter.emit(Om.onClose,{dontShowAgain:this.dontShowAgain});this.eventEmitter.unsubscribeAll(Om.onClose);this.eventEmitter=null;this.elements=null}}]);return e}();Um.Events=Om;var Fm=function(){function e(t){babelHelpers.classCallCheck(this,e);t=p.Type.isPlainObject(t)?t:{};this.callView=t.callView;this.bindElement=t.bindElement;this.popup=null;t.events=p.Type.isPlainObject(t.events)?t.events:{};this.events={onActionClick:t.events.onActionClick?t.events.onActionClick:function(){},onClose:t.events.onClose?t.events.onClose:function(){}}}babelHelpers.createClass(e,[{key:"show",value:function e(){this.createPopup();this.popup.show();BX.bind(BX("promo-popup-3d-button"),"click",this.openWindow.bind(this))}},{key:"openWindow",value:function e(){var t=this;T.open({tab:"mask"});setTimeout((function(){return t.close()}),100)}},{key:"openLearningPopup",value:function e(){var t=this;var i=BX("bx-messenger-videocall-panel-item-with-arrow-camera");if(!i){return true}var n=BX.message("IM_PROMO_3DAVATAR_30112022_LEARNING_TITLE");var a=BX.message("IM_PROMO_3DAVATAR_30112022_LEARNING_TEXT");var s='\n\t\t\t<div class="promo-popup-3d-learning-content">\n\t\t\t\t<h4 class="ui-typography-heading-h4 promo-popup-3d-learning-content__title">'.concat(n,'</h4>\n\t\t\t\t<p class="promo-popup-3d-learning-content__description">').concat(a,"</p>\n\t\t\t</div>\n\t\t");this.popup=new v.Popup({id:"bx-call-promo-learning-popup",bindElement:i,targetContainer:document.body,content:s,cacheable:false,closeIcon:true,autoHide:true,closeByEsc:true,bindOptions:{position:"top",forceTop:-100,forceLeft:100,forceBindPosition:true},angle:{position:"top",offset:49},className:"bx-call-promo-popup-learn",contentBackground:"unset",events:{onPopupClose:function e(){t.events.onClose()}}});this.popup.show();this.callView.subscribe(es.Event.onDeviceSelectorShow,(function(){return t.popup?t.popup.close():""}))}},{key:"close",value:function e(){if(!this.popup){return false}this.popup.close()}},{key:"createPopup",value:function e(){var t=BX.message("IM_PROMO_3DAVATAR_30112022_TITLE");var i=BX.message("IM_PROMO_3DAVATAR_30112022_TEXT");var n=BX.message("IM_PROMO_3DAVATAR_30112022_BUTTON");var a='\n\t\t\t<div class="promo-popup-3d-content">\n\t\t\t\t<div class="promo-popup-3d-content__masks-container">\n\t\t\t\t\t<div class="promo-popup-3d-content__mask --left-2 --bear"></div>\n\t\t\t\t\t<div class="promo-popup-3d-content__mask --left-1 --pole-bear"></div>\n\t\t\t\t\t<div class="promo-popup-3d-content__mask --center --fox"></div>\n\t\t\t\t\t<div class="promo-popup-3d-content__mask --right-1 --santa"></div>\n\t\t\t\t\t<div class="promo-popup-3d-content__mask --right-2 --owl"></div>\n\t\t\t\t</div>\n\t\t\t\t<h3 class="ui-typography-heading-h2 promo-popup-3d-content__title">'.concat(t,'</h3>\n\t\t\t\t<p class="promo-popup-3d-content__description">').concat(i,'</p>\n\t\t\t\t<div class="promo-popup-3d-content__actions-btn">\n\t\t\t\t\t<span class="ui-btn btn-primary ui-btn-lg ui-btn-round ui-btn-primary" id="promo-popup-3d-button">').concat(n,"</span>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t");this.popup=new v.Popup({id:"bx-call-promo-popup-3d",bindElement:this.bindElement,targetContainer:document.body,content:a,cacheable:false,closeIcon:true,overlay:{backgroundColor:"#000",opacity:40},width:531,minHeight:481,bindOptions:{position:"top"},className:"bx-call-promo-popup-3d-masks",events:{onPopupClose:this.onPopupClose.bind(this)}})}},{key:"onPopupClose",value:function e(){this.popup.destroy();this.openLearningPopup()}}]);return e}();Fm.Events=Om;var Vm={onClose:"onClose",onDestroy:"onDestroy",onCloseClicked:"onCloseClicked"};var Gm=function(e){babelHelpers.inherits(t,e);function t(e){var i;babelHelpers.classCallCheck(this,t);i=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this));i.setEventNamespace("BX.Call.SideBar");i.container=e.container;i.width=BX.prop.getInteger(e,"width",200);i.elements={root:null,close:null,contentContainer:null};if(e.events){for(var n in e.events){if(e.events.hasOwnProperty(n)){i.subscribe(n,e.events[n])}}}return i}babelHelpers.createClass(t,[{key:"render",value:function e(){var t=this;if(this.elements.root){return this.elements.root}this.elements.root=p.Dom.create("div",{props:{className:"bx-messenger-call-sidebar-root"},children:[p.Dom.create("div",{props:{className:"bx-messenger-call-sidebar-labels"},style:{top:"39px"},children:[p.Dom.create("div",{props:{className:"bx-messenger-call-sidebar-label"},style:{maxWidth:"40px"},children:[p.Dom.create("div",{props:{className:"bx-messenger-call-sidebar-label-icon-box"},attrs:{title:BX.message("IM_M_CALL_BTN_CLOSE")},children:[p.Dom.create("div",{props:{className:"bx-messenger-call-sidebar-label-icon bx-messenger-call-sidebar-label-icon-close"}})]})],events:{click:function e(){return t.emit(Vm.onCloseClicked)}}})]}),this.elements.contentContainer=p.Dom.create("div",{props:{className:"bx-messenger-call-sidebar-content-container"}})]});this.elements.root.style.setProperty("--sidebar-width",this.width+"px");return this.elements.root}},{key:"setWidth",value:function e(t){if(this.width==t){return}this.width=t;this.elements.root.style.setProperty("--sidebar-width",this.width+"px")}},{key:"open",value:function e(t){var i=this;t=t!==false;return new Promise((function(e){i.container.appendChild(i.render());if(t){i.elements.root.classList.add("opening");i.elements.root.addEventListener("animationend",(function(){i.elements.root.classList.remove("opening");e()}),{once:true})}else{e()}}))}},{key:"close",value:function e(t){var i=this;t=t!==false;return new Promise((function(e){if(t){i.elements.root.classList.add("closing");i.elements.root.addEventListener("animationend",(function(){i.container.removeChild(i.elements.root);i.emit(Vm.onClose);e()}),{once:true})}else{i.container.removeChild(i.elements.root);i.emit(Vm.onClose);e()}}))}},{key:"toggleHidden",value:function e(t){this.elements.root.classList.toggle("hidden",t)}},{key:"destroy",value:function e(){this.emit(Vm.onDestroy);this.unsubscribeAll(Vm.onClose);this.unsubscribeAll(Vm.onDestroy);this.eventEmitter=null;this.elements=null;this.container=null}}]);return t}(f.EventEmitter);var Wm=function(){function e(t){babelHelpers.classCallCheck(this,e);this.popup=null;this.options=t||{};this.callbacks={onClose:p.Type.isFunction(this.options.onClose)?this.options.onClose:BX.DoNothing,onStopSharingClick:p.Type.isFunction(this.options.onStopSharingClick)?this.options.onStopSharingClick:BX.DoNothing}}babelHelpers.createClass(e,[{key:"show",value:function e(){var t=this;if(this.popup){this.popup.show();return}var i=400;this.popup=new v.Popup({bindElement:this.options.bindElement,targetContainer:this.options.targetContainer,content:this.render(),padding:0,contentPadding:0,height:38,width:i,offsetTop:-135,offsetLeft:this.options.bindElement.offsetWidth/2-i/2+this.options.bindElement.offsetWidth/2,className:"bx-call-view-popup-web-screenshare",background:"#00428F",contentBackground:"#00428F",darkMode:true,contentBorderRadius:"27px",borderRadius:"27px",angle:false,cacheable:false,events:{onDestroy:function e(){return t.popup=null}}});this.popup.show()}},{key:"render",value:function e(){var t=this;return p.Dom.create("div",{props:{className:"bx-call-view-popup-web-screenshare-body"},children:[p.Dom.create("div",{props:{className:"bx-call-view-popup-web-screenshare-left"},children:[p.Dom.create("div",{props:{className:"bx-call-view-popup-web-screenshare-icon-screen"}}),p.Dom.create("div",{props:{className:"bx-call-view-popup-web-screenshare-text"},text:BX.message("IM_CALL_WEB_SCREENSHARE_STATUS")})]}),p.Dom.create("div",{props:{className:"bx-call-view-popup-web-screenshare-right"},children:[p.Dom.create("div",{props:{className:"bx-call-view-popup-web-screenshare-stop"},children:[p.Dom.create("div",{props:{className:"bx-call-view-popup-web-screenshare-stop-icon"}}),p.Dom.create("div",{props:{className:"bx-call-view-popup-web-screenshare-stop-text"},text:BX.message("IM_CALL_WEB_SCREENSHARE_STOP")})],events:{click:function e(){return t.callbacks.onStopSharingClick()}}}),p.Dom.create("div",{props:{className:"bx-call-view-popup-web-screenshare-close"},events:{click:function e(){t.popup.close();t.callbacks.onClose()}}})]})]})}},{key:"close",value:function e(){if(this.popup){this.popup.close()}}},{key:"destroy",value:function e(){if(this.popup){this.popup.destroy()}}}]);return e}();function Xm(e,t,i){jm(e,t);t.set(e,i)}function zm(e,t){jm(e,t);t.add(e)}function jm(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}function qm(e,t,i){if(!t.has(e)){throw new TypeError("attempted to get private field on non-instance")}return i}var Ym={invite:"im.call.invite",cancel:"im.call.cancel",answer:"im.call.answer",decline:"im.call.decline",hangup:"im.call.hangup",ping:"im.call.ping"};var Qm={ping:"Call::ping",answer:"Call::answer",hangup:"Call::hangup",userInviteTimeout:"Call::userInviteTimeout",repeatAnswer:"Call::repeatAnswer"};var Jm={voiceStarted:"Call::voiceStarted",voiceStopped:"Call::voiceStopped",microphoneState:"Call::microphoneState",cameraState:"Call::cameraState",videoPaused:"Call::videoPaused",screenState:"Call::screenState",recordState:"Call::recordState",floorRequest:"Call::floorRequest",emotion:"Call::emotion",customMessage:"Call::customMessage",showUsers:"Call::showUsers",showAll:"Call::showAll",hideAll:"Call::hideAll",joinRoom:"Call::joinRoom",leaveRoom:"Call::leaveRoom",listRooms:"Call::listRooms",requestRoomSpeaker:"Call::requestRoomSpeaker"};var Km={viewerJoined:"Call::viewerJoined",viewerLeft:"Call::viewerLeft",joinRoomOffer:"Call::joinRoomOffer",transferRoomHost:"Call::transferRoomHost",listRoomsResponse:"Call::listRoomsResponse",roomUpdated:"Call::roomUpdated"};var Zm={onCallConference:"VoximplantCall::onCallConference"};var $m=5e3;var eg=25e3;var tg=5500;var ig=15e3;var ng=new WeakSet;var ag=new WeakSet;var sg=new WeakSet;var rg=new WeakSet;var og=new WeakMap;var lg=new WeakMap;var cg=new WeakMap;var ug=new WeakMap;var dg=new WeakMap;var hg=new WeakMap;var pg=new WeakMap;var vg=new WeakMap;var fg=new WeakMap;var mg=new WeakMap;var gg=new WeakMap;var bg=new WeakMap;var Cg=new WeakMap;var kg=new WeakMap;var yg=new WeakMap;var Sg=new WeakMap;var wg=new WeakMap;var Ig=new WeakMap;var Tg=new WeakMap;var Pg=new WeakMap;var _g=new WeakMap;var Eg=new WeakMap;var Rg=new WeakSet;var Mg=new WeakMap;var Ag=new WeakMap;var Lg=new WeakMap;var Bg=new WeakMap;var Dg=new WeakMap;var Hg=function(e){babelHelpers.inherits(t,e);function t(e){var i;babelHelpers.classCallCheck(this,t);i=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this,e));zm(babelHelpers.assertThisInitialized(i),Rg);zm(babelHelpers.assertThisInitialized(i),rg);zm(babelHelpers.assertThisInitialized(i),sg);zm(babelHelpers.assertThisInitialized(i),ag);zm(babelHelpers.assertThisInitialized(i),ng);babelHelpers.defineProperty(babelHelpers.assertThisInitialized(i),"setMuted",(function(e){if(i.muted==e.data.isMicrophoneMuted){return}i.muted=e.data.isMicrophoneMuted;if(i.voximplantCall){if(i.muted){i.voximplantCall.muteMicrophone()}else{i.voximplantCall.unmuteMicrophone()}i.signaling.sendMicrophoneState(!i.muted)}}));babelHelpers.defineProperty(babelHelpers.assertThisInitialized(i),"setVideoEnabled",(function(e){if(i.videoEnabled==e.data.isCameraOn){return}i.videoEnabled=e.data.isCameraOn;if(i.voximplantCall){if(i.videoEnabled){qm(babelHelpers.assertThisInitialized(i),ng,Ng).call(babelHelpers.assertThisInitialized(i))}else{if(i.localVideoShown){VoxImplant.Hardware.StreamManager.get().hideLocalVideo().then((function(){i.localVideoShown=false;i.runCallback(Ac.onLocalMediaReceived,{tag:"main",stream:new MediaStream})}))}}i.voximplantCall.sendVideo(i.videoEnabled);i.signaling.sendCameraState(i.videoEnabled)}}));Xm(babelHelpers.assertThisInitialized(i),og,{writable:true,value:function e(t){i.runCallback(Ac.onUserStateChanged,t);if(!i.ready){return}if(t.state==yc.Failed||t.state==yc.Unavailable||t.state==yc.Declined||t.state==yc.Idle){if(i.type==wc.Instant&&!i.isAnyoneParticipating()){i.hangup()}}}});Xm(babelHelpers.assertThisInitialized(i),lg,{writable:true,value:function e(t){if(!i.ready){return}i.signaling.sendUserInviteTimeout({userId:i.users,failedUserId:t.userId})}});Xm(babelHelpers.assertThisInitialized(i),cg,{writable:true,value:function e(t){var n=Number(t.senderId);if(n==i.userId){return i.__onPullEventAnswerSelf(t)}if(!i.peers[n]){i.peers[n]=i.createPeer(n);i.runCallback(Ac.onUserInvited,{userId:n})}if(!i.users.includes(n)){i.users.push(n)}i.peers[n].setReady(true)}});Xm(babelHelpers.assertThisInitialized(i),ug,{writable:true,value:function e(t){var n=t.senderId;if(i.userId==n&&i.instanceId!=t.callInstanceId){i.runCallback(Ac.onLeave,{local:false});return}if(!i.peers[n]){return}i.peers[n].setReady(false);if(t.code==603){i.peers[n].setDeclined(true)}else if(t.code==486){i.peers[n].setBusy(true);console.error("user "+n+" is busy")}if(i.ready&&i.type==wc.Instant&&!i.isAnyoneParticipating()){i.hangup()}}});Xm(babelHelpers.assertThisInitialized(i),dg,{writable:true,value:function e(t){i.log("__onPullEventUsersJoined",t);var n=t.users;i.addJoinedUsers(n)}});Xm(babelHelpers.assertThisInitialized(i),hg,{writable:true,value:function e(t){i.log("__onPullEventUsersInvited",t);var n=t.users;if(i.type===wc.Instant){i.addInvitedUsers(n)}}});Xm(babelHelpers.assertThisInitialized(i),pg,{writable:true,value:function e(t){i.log("__onPullEventUserInviteTimeout",t);var n=t.failedUserId;if(i.peers[n]){i.peers[n].onInviteTimeout(false)}}});Xm(babelHelpers.assertThisInitialized(i),vg,{writable:true,value:function e(t){if(t.callInstanceId==i.instanceId){return}var n=Number(t.senderId);if(n==i.userId){if(!i.joinedElsewhere){i.runCallback(Ac.onJoin,{local:false});i.joinedElsewhere=true}clearTimeout(i.lastSelfPingReceivedTimeout);i.lastSelfPingReceivedTimeout=setTimeout(babelHelpers.classPrivateFieldGet(babelHelpers.assertThisInitialized(i),mg),$m*2.1)}clearTimeout(i.lastPingReceivedTimeout);i.lastPingReceivedTimeout=setTimeout(babelHelpers.classPrivateFieldGet(babelHelpers.assertThisInitialized(i),fg),$m*2.1);if(i.peers[n]){i.peers[n].setReady(true)}}});Xm(babelHelpers.assertThisInitialized(i),fg,{writable:true,value:function e(){if(!i.ready){i.destroy()}}});Xm(babelHelpers.assertThisInitialized(i),mg,{writable:true,value:function e(){i.runCallback(Ac.onLeave,{local:false});i.joinedElsewhere=false}});Xm(babelHelpers.assertThisInitialized(i),gg,{writable:true,value:function e(){i.destroy()}});Xm(babelHelpers.assertThisInitialized(i),bg,{writable:true,value:function e(){if(i.ready){i.signaling.sendAnswer({userId:i.userId},true)}}});Xm(babelHelpers.assertThisInitialized(i),Cg,{writable:true,value:function e(t){var n=t.renderer;var a=n.stream.getVideoTracks().length>0?n.stream.getVideoTracks()[0].label:"";i.log("__onLocalMediaRendererAdded",n.kind,a);if(n.kind==="video"){var s;if(a.match(/^screen|window|tab|web-contents-media-stream/i)){s="screen"}else{s="main"}i.screenShared=s==="screen";i.runCallback(Ac.onLocalMediaReceived,{tag:s,stream:n.stream})}else if(n.kind==="sharing"){i.runCallback(Ac.onLocalMediaReceived,{tag:"screen",stream:n.stream});i.screenShared=true}}});Xm(babelHelpers.assertThisInitialized(i),kg,{writable:true,value:function e(t){var n=t.renderer;i.log("__onBeforeLocalMediaRendererRemoved",n.kind);if(n.kind==="sharing"&&!H.isCameraOn){i.runCallback(Ac.onLocalMediaReceived,{tag:"main",stream:new MediaStream});i.screenShared=false}}});Xm(babelHelpers.assertThisInitialized(i),yg,{writable:true,value:function e(t){if(i.ready&&t.result){if(t.stream.getAudioTracks().length>0){if(i.localVAD){i.localVAD.destroy()}i.localVAD=new ds({mediaStream:t.stream,onVoiceStarted:function e(){i.runCallback(Ac.onUserVoiceStarted,{userId:i.userId,local:true})},onVoiceStopped:function e(){i.runCallback(Ac.onUserVoiceStopped,{userId:i.userId,local:true})}});clearInterval(i.microphoneLevelInterval);i.microphoneLevelInterval=setInterval((function(){return i.microphoneLevel=i.localVAD.currentVolume}),200)}}}});Xm(babelHelpers.assertThisInitialized(i),Sg,{writable:true,value:function e(){i.reconnectionEventCount++}});Xm(babelHelpers.assertThisInitialized(i),wg,{writable:true,value:function e(){i.reconnectionEventCount--}});Xm(babelHelpers.assertThisInitialized(i),Ig,{writable:true,value:function e(){i.reconnectionEventCount++}});Xm(babelHelpers.assertThisInitialized(i),Tg,{writable:true,value:function e(){i.reconnectionEventCount--}});Xm(babelHelpers.assertThisInitialized(i),Pg,{writable:true,value:function e(t){i.log("__onCallDisconnected",t&&t.headers?{headers:t.headers}:null);i.sendTelemetryEvent("disconnect");i.localUserState=yc.Idle;i.ready=false;i.joinedAsViewer=false;i.reinitPeers();qm(babelHelpers.assertThisInitialized(i),ag,xg).call(babelHelpers.assertThisInitialized(i));i.removeCallEvents();i.unsubscribeHardwareChanges();i.voximplantCall=null;var n=VoxImplant.getInstance();n.enableSilentLogging(false);n.setLoggerCallback(null);i.state=kc.Proceeding;i.runCallback(Ac.onLeave,{local:true})}});Xm(babelHelpers.assertThisInitialized(i),_g,{writable:true,value:function e(){if(i.ready&&i.voximplantCall){i.signaling.sendHangup({userId:i.users})}}});Xm(babelHelpers.assertThisInitialized(i),Eg,{writable:true,value:function e(t){if(t&&t.call){delete t.call}i.log("onFatalError",t);i.ready=false;i.localUserState=yc.Failed;i.reinitPeers();qm(babelHelpers.assertThisInitialized(i),ag,xg).call(babelHelpers.assertThisInitialized(i)).then((function(){if(i.voximplantCall){i.removeCallEvents();i.unsubscribeHardwareChanges();try{i.voximplantCall.hangup({"X-Reason":"Fatal error","X-Error":typeof t==="string"?t:t.code||t.name})}catch(e){i.log("Voximplant hangup error: ",e);console.error("Voximplant hangup error: ",e)}i.voximplantCall=null}if(typeof VoxImplant!=="undefined"){var e=VoxImplant.getInstance();e.enableSilentLogging(false);e.setLoggerCallback(null)}if(typeof t==="string"){i.runCallback(Ac.onCallFailure,{name:t})}else if(t.name){i.runCallback(Ac.onCallFailure,t)}}))}});Xm(babelHelpers.assertThisInitialized(i),Mg,{writable:true,value:function e(t){var n=t.endpoint;var a=n.userName;i.log("__onCallEndpointAdded ("+a+")",t.endpoint);console.log("__onCallEndpointAdded ("+a+")",t.endpoint);if(p.Type.isStringFilled(a)&&a.startsWith("user")){qm(babelHelpers.assertThisInitialized(i),Rg,Fg).call(babelHelpers.assertThisInitialized(i),a,n)}else{n.addEventListener(VoxImplant.EndpointEvents.InfoUpdated,(function(e){var t=e.endpoint;var n=t.userName;i.log("VoxImplant.EndpointEvents.InfoUpdated ("+n+")",e.endpoint);if(p.Type.isStringFilled(n)&&n.startsWith("user")){qm(babelHelpers.assertThisInitialized(i),Rg,Fg).call(babelHelpers.assertThisInitialized(i),n,t)}}));i.log("Unknown endpoint "+a);console.warn("Unknown endpoint "+a)}}});Xm(babelHelpers.assertThisInitialized(i),Ag,{writable:true,value:function e(t){if(i.logger){i.logger.sendStat(ib(t.stats,i.voximplantCall))}}});Xm(babelHelpers.assertThisInitialized(i),Lg,{writable:true,value:function e(t){console.warn("__onJoinRoomOffer",t);i.updateRoom({id:t.roomId,users:t.users,speaker:t.speaker});i.runCallback(Ac.onJoinRoomOffer,{roomId:t.roomId,users:t.users,initiator:t.initiator,speaker:t.speaker})}});Xm(babelHelpers.assertThisInitialized(i),Bg,{writable:true,value:function e(t){var n=t.roomId===i._currentRoomId&&i.rooms[t.roomId]&&i.rooms[t.roomId].speaker!=t.speaker;var a=n&&i.rooms[t.roomId].speaker;console.log("__onRoomUpdated; speakerChanged: ",n);i.updateRoom({id:t.roomId,users:t.users,speaker:t.speaker});if(t.roomId===i._currentRoomId&&t.users.indexOf(i.userId)===-1){i._currentRoomId=null;i.runCallback(Ac.onLeaveRoom,{roomId:t.roomId})}else if(t.roomId!==i._currentRoomId&&t.users.indexOf(i.userId)!==-1){i._currentRoomId=t.roomId;i.runCallback(Ac.onJoinRoom,{roomId:t.roomId,speaker:i.currentRoom().speaker,users:i.currentRoom().users})}else if(n){i.runCallback(Ac.onTransferRoomSpeaker,{roomId:t.roomId,speaker:t.speaker,previousSpeaker:a,initiator:t.initiator})}}});Xm(babelHelpers.assertThisInitialized(i),Dg,{writable:true,value:function e(t){var n;var a;try{n=JSON.parse(t.text)}catch(e){i.log("Could not parse scenario message.",e);return}var s=n.eventName;if(s===Jm.voiceStarted){i.runCallback(Ac.onUserVoiceStarted,{userId:n.senderId})}else if(s===Jm.voiceStopped){i.runCallback(Ac.onUserVoiceStopped,{userId:n.senderId})}else if(s===Jm.microphoneState){i.runCallback(Ac.onUserMicrophoneState,{userId:n.senderId,microphoneState:n.microphoneState==="Y"})}else if(s===Jm.cameraState){i.runCallback(Ac.onUserCameraState,{userId:n.senderId,cameraState:n.cameraState==="Y"})}else if(s===Jm.videoPaused){i.runCallback(Ac.onUserVideoPaused,{userId:n.senderId,videoPaused:n.videoPaused==="Y"})}else if(s===Jm.screenState){i.runCallback(Ac.onUserScreenState,{userId:n.senderId,screenState:n.screenState==="Y"})}else if(s===Jm.recordState){i.runCallback(Ac.onUserCommonRecordState,{userId:n.senderId,recordState:n.recordState})}else if(s===Jm.floorRequest){i.runCallback(Ac.onUserFloorRequest,{userId:n.senderId,requestActive:n.requestActive==="Y"})}else if(s===Jm.emotion){i.runCallback(Ac.onUserEmotion,{userId:n.senderId,toUserId:n.toUserId,emotion:n.emotion})}else if(s===Jm.customMessage){i.runCallback(Ac.onCustomMessage,{message:n.message})}else if(s==="scenarioLogUrl"){console.warn("scenario log url: "+n.logUrl)}else if(s===Km.joinRoomOffer){console.log(n);babelHelpers.classPrivateFieldGet(babelHelpers.assertThisInitialized(i),Lg).call(babelHelpers.assertThisInitialized(i),n)}else if(s===Km.roomUpdated){babelHelpers.classPrivateFieldGet(babelHelpers.assertThisInitialized(i),Bg).call(babelHelpers.assertThisInitialized(i),n)}else if(s===Km.listRoomsResponse){if(i.__resolveListRooms){i.__resolveListRooms(n.rooms);delete i.__resolveListRooms}}else if(s===Km.viewerJoined){console.log("viewer "+n.senderId+" joined");a=i.peers[n.senderId];if(a){a.setDirection(Sc.RecvOnly);a.setReady(true)}}else if(s===Km.viewerLeft){console.log("viewer "+n.senderId+" left");a=i.peers[n.senderId];if(a){a.setReady(false)}}else{i.log("Unknown scenario event "+s)}}});i.debug=e.debug;i.videoQuality=_c.VeryHigh;i.voximplantCall=null;i.signaling=new Xg({call:babelHelpers.assertThisInitialized(i)});i.peers={};i.joinedElsewhere=false;i.joinedAsViewer=false;i.localVideoShown=false;i._localUserState=yc.Idle;i.clientEventsBound=false;i._screenShared=false;i.videoAllowedFrom=Mc.all;i.direction=Sc.SendRecv;i.microphoneLevelInterval=null;i.rooms={};window.addEventListener("unload",babelHelpers.classPrivateFieldGet(babelHelpers.assertThisInitialized(i),_g));i.initPeers();i.pingUsersInterval=setInterval(i.pingUsers.bind(babelHelpers.assertThisInitialized(i)),$m);i.pingBackendInterval=setInterval(i.pingBackend.bind(babelHelpers.assertThisInitialized(i)),eg);i.lastPingReceivedTimeout=null;i.lastSelfPingReceivedTimeout=null;i.reinviteTimeout=null;i._reconnectionEventCount=0;i.pullEventHandlers={"Call::answer":babelHelpers.classPrivateFieldGet(babelHelpers.assertThisInitialized(i),cg),"Call::hangup":babelHelpers.classPrivateFieldGet(babelHelpers.assertThisInitialized(i),ug),"Call::usersJoined":babelHelpers.classPrivateFieldGet(babelHelpers.assertThisInitialized(i),dg),"Call::usersInvited":babelHelpers.classPrivateFieldGet(babelHelpers.assertThisInitialized(i),hg),"Call::userInviteTimeout":babelHelpers.classPrivateFieldGet(babelHelpers.assertThisInitialized(i),pg),"Call::ping":babelHelpers.classPrivateFieldGet(babelHelpers.assertThisInitialized(i),vg),"Call::finish":babelHelpers.classPrivateFieldGet(babelHelpers.assertThisInitialized(i),gg),"Call::repeatAnswer":babelHelpers.classPrivateFieldGet(babelHelpers.assertThisInitialized(i),bg)};return i}babelHelpers.createClass(t,[{key:"initPeers",value:function e(){var t=this;this.users.forEach((function(e){e=Number(e);t.peers[e]=t.createPeer(e)}))}},{key:"reinitPeers",value:function e(){for(var t in this.peers){if(this.peers.hasOwnProperty(t)&&this.peers[t]){this.peers[t].destroy();this.peers[t]=null}}this.initPeers()}},{key:"pingUsers",value:function e(){if(this.ready){var t=this.users.concat(this.userId);this.signaling.sendPingToUsers({userId:t},true)}}},{key:"pingBackend",value:function e(){if(this.ready){this.signaling.sendPingToBackend()}}},{key:"createPeer",value:function e(t){var i=this;var n;if(this.videoAllowedFrom===Mc.all){n=true}else if(this.videoAllowedFrom===Mc.none){n=false}else if(p.Type.isArray(this.videoAllowedFrom)){n=this.videoAllowedFrom.some((function(e){return e==t}))}else{n=true}return new tb({call:this,userId:t,ready:t==this.initiatorId,isIncomingVideoAllowed:n,onMediaReceived:function e(n){i.runCallback(Ac.onRemoteMediaReceived,n);if(n.kind==="video"){i.runCallback(Ac.onUserVideoPaused,{userId:t,videoPaused:false})}},onMediaRemoved:function e(t){i.runCallback(Ac.onRemoteMediaStopped,t)},onMediaRenderEnabled:function e(t){var n=t.endpoint;var a=n.userName;var s=parseInt(a.substring(4));if(i.peers[s]){i.runCallback(Ac.onBadNetworkIndicator,{userId:s,badNetworkIndicator:false})}},onMediaRenderDisabled:function e(t){var n=t.endpoint;var a=n.userName;if(p.Type.isStringFilled(a)&&a.startsWith("user")){var s=parseInt(a.substring(4));if(i.peers[s]&&t.reason==="disabledByServer"){i.runCallback(Ac.onBadNetworkIndicator,{userId:s,badNetworkIndicator:true})}}},onVoiceStarted:function e(){},onVoiceEnded:function e(){},onStateChanged:babelHelpers.classPrivateFieldGet(this,og),onInviteTimeout:babelHelpers.classPrivateFieldGet(this,lg)})}},{key:"getUsers",value:function e(){var t={};for(var i in this.peers){t[i]=this.peers[i].calculatedState}return t}},{key:"getUserCount",value:function e(){return Object.keys(this.peers).length}},{key:"getClient",value:function e(){var t=this;return new Promise((function(e,i){BX.Voximplant.getClient({debug:t.debug,restClient:tu.getRestClient()}).then((function(i){i.enableSilentLogging();i.setLoggerCallback((function(e){return t.log(e.label+": "+e.message)}));t.log("User agent: "+navigator.userAgent);t.log("Voximplant SDK version: "+VoxImplant.version);t.bindClientEvents();e(i)}))["catch"](i)}))}},{key:"bindClientEvents",value:function e(){var t=VoxImplant.Hardware.StreamManager.get();if(!this.clientEventsBound){VoxImplant.getInstance().on(VoxImplant.Events.MicAccessResult,babelHelpers.classPrivateFieldGet(this,yg));if(VoxImplant.Events.Reconnecting){VoxImplant.getInstance().on(VoxImplant.Events.Reconnecting,babelHelpers.classPrivateFieldGet(this,Ig));VoxImplant.getInstance().on(VoxImplant.Events.Reconnected,babelHelpers.classPrivateFieldGet(this,Tg))}t.on(VoxImplant.Hardware.HardwareEvents.MediaRendererAdded,babelHelpers.classPrivateFieldGet(this,Cg));t.on(VoxImplant.Hardware.HardwareEvents.MediaRendererUpdated,babelHelpers.classPrivateFieldGet(this,Cg));t.on(VoxImplant.Hardware.HardwareEvents.BeforeMediaRendererRemoved,babelHelpers.classPrivateFieldGet(this,kg));this.clientEventsBound=true}}},{key:"removeClientEvents",value:function e(){if(!("VoxImplant"in window)){return}VoxImplant.getInstance().off(VoxImplant.Events.MicAccessResult,babelHelpers.classPrivateFieldGet(this,yg));if(VoxImplant.Events.Reconnecting){VoxImplant.getInstance().off(VoxImplant.Events.Reconnecting,babelHelpers.classPrivateFieldGet(this,Ig));VoxImplant.getInstance().off(VoxImplant.Events.Reconnected,babelHelpers.classPrivateFieldGet(this,Tg))}var t=VoxImplant.Hardware.StreamManager.get();t.off(VoxImplant.Hardware.HardwareEvents.MediaRendererAdded,babelHelpers.classPrivateFieldGet(this,Cg));t.off(VoxImplant.Hardware.HardwareEvents.BeforeMediaRendererRemoved,babelHelpers.classPrivateFieldGet(this,kg));this.clientEventsBound=false}},{key:"setCameraId",value:function e(t){var i=this;if(this.cameraId==t){return}this.cameraId=t;if(this.voximplantCall){VoxImplant.Hardware.CameraManager.get().getInputDevices().then((function(){VoxImplant.Hardware.CameraManager.get().setCallVideoSettings(i.voximplantCall,i.constructCameraParams())}))}}},{key:"setMicrophoneId",value:function e(t){var i=this;if(this.microphoneId==t){return}this.microphoneId=t;if(this.voximplantCall){VoxImplant.Hardware.AudioDeviceManager.get().getInputDevices().then((function(){VoxImplant.Hardware.AudioDeviceManager.get().setCallAudioSettings(i.voximplantCall,{inputId:i.microphoneId})}))}}},{key:"getCurrentMicrophoneId",value:function e(){if(this.voximplantCall.peerConnection.impl.getTransceivers){var t=this.voximplantCall.peerConnection.impl.getTransceivers();if(t.length>0){var i=t[0].sender.track;var n=i.getSettings();return n.deviceId}}return this.microphoneId}},{key:"constructCameraParams",value:function e(){var t={};if(this.cameraId){t.cameraId=this.cameraId}t.videoQuality=this.videoHd?VoxImplant.Hardware.VideoQuality.VIDEO_SIZE_HD:VoxImplant.Hardware.VideoQuality.VIDEO_SIZE_nHD;t.facingMode=true;return t}},{key:"useHdVideo",value:function e(t){this.videoHd=t===true}},{key:"requestFloor",value:function e(t){this.signaling.sendFloorRequest(t)}},{key:"sendLocalRecordState",value:function e(t){this.signaling.sendLocalRecordState(t)}},{key:"sendEmotion",value:function e(t,i){this.signaling.sendEmotion(t,i)}},{key:"sendCustomMessage",value:function e(t,i){this.signaling.sendCustomMessage(t,i)}},{key:"allowVideoFrom",value:function e(t){if(this.videoAllowedFrom==t){return}this.videoAllowedFrom=t;if(t===Mc.all){this.signaling.sendShowAll();t=Object.keys(this.peers)}else if(t===Mc.none){this.signaling.sendHideAll();t=[]}else if(p.Type.isArray(t)){this.signaling.sendShowUsers(t)}else{throw new Error("userList is in wrong format")}var i={};t.forEach((function(e){return i[e]=true}));for(var n in this.peers){if(!this.peers.hasOwnProperty(n)){continue}if(i[n]){this.peers[n].allowIncomingVideo(true)}else{this.peers[n].allowIncomingVideo(false)}}}},{key:"startScreenSharing",value:function e(){var t=this;if(!this.voximplantCall){return}var i=!H.isCameraOn;var n=H.isCameraOn||this.screenShared;this.voximplantCall.shareScreen(i,n).then((function(){t.log("Screen shared");t.screenShared=true}))["catch"]((function(e){console.error(e);t.log("Screen sharing error:",e)}))}},{key:"stopScreenSharing",value:function e(){var t=this;if(!this.voximplantCall){return}this.voximplantCall.stopSharingScreen().then((function(){t.log("Screen is no longer shared");t.screenShared=false}))}},{key:"isScreenSharingStarted",value:function e(){return this.screenShared}},{key:"inviteUsers",value:function e(){var t=this;var i=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};this.ready=true;var n=p.Type.isArray(i.users)?i.users:this.users;this.attachToConference().then((function(){t.signaling.sendPingToUsers({userId:n});if(n.length>0){return t.signaling.inviteUsers({userIds:n,video:H.isCameraOn?"Y":"N"})}})).then((function(){t.state=kc.Connected;t.runCallback(Ac.onJoin,{local:true});for(var e=0;e<n.length;e++){var i=parseInt(n[e]);if(!t.users.includes(i)){t.users.push(i)}if(!t.peers[i]){t.peers[i]=t.createPeer(i);if(t.type===wc.Instant){t.runCallback(Ac.onUserInvited,{userId:i})}}if(t.type===wc.Instant){t.peers[i].onInvited();t.scheduleRepeatInvite()}}}))["catch"]((function(e){babelHelpers.classPrivateFieldGet(t,Eg).call(t,e)}))}},{key:"scheduleRepeatInvite",value:function e(){var t=this;clearTimeout(this.reinviteTimeout);this.reinviteTimeout=setTimeout((function(){return t.repeatInviteUsers()}),tg)}},{key:"repeatInviteUsers",value:function e(){var t=this;clearTimeout(this.reinviteTimeout);if(!this.ready){return}var i=[];for(var n in this.peers){if(this.peers.hasOwnProperty(n)&&this.peers[n].calculatedState===yc.Calling){i.push(n)}}if(i.length===0){return}var a={userIds:i,video:H.isCameraOn?"Y":"N",repeated:"Y"};this.signaling.inviteUsers(a).then((function(){return t.scheduleRepeatInvite()}))}},{key:"answer",value:function e(){var t=this;var i=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};this.ready=true;var n=i.joinAsViewer===true;this.videoEnabled=H.isCameraOn;this.muted=H.isMicrophoneMuted;if(!n){this.signaling.sendAnswer()}this.attachToConference({joinAsViewer:n}).then((function(){t.log("Attached to conference");t.state=kc.Connected;t.runCallback(Ac.onJoin,{local:true})}))["catch"]((function(e){babelHelpers.classPrivateFieldGet(t,Eg).call(t,e)}))}},{key:"decline",value:function e(t){this.ready=false;var i={callId:this.id,callInstanceId:this.instanceId};if(t){i.code=t}tu.getRestClient().callMethod(Ym.decline,i)}},{key:"hangup",value:function e(t,i){if(!this.ready){var n=new Error("Hangup in wrong state");this.log(n);return}var a=new Error;a.name="Call stack:";this.log("Hangup received \n"+a.stack);if(this.localVAD){this.localVAD.destroy();this.localVAD=null}clearInterval(this.microphoneLevelInterval);var s={};this.ready=false;if(typeof t!="undefined"){s.code=t}if(typeof i!="undefined"){s.reason=i}this.state=kc.Proceeding;this.runCallback(Ac.onLeave,{local:true});s.userId=this.users.slice(0).concat(this.userId);this.signaling.sendHangup(s);this.reinitPeers();if(this.voximplantCall){this.voximplantCall._replaceVideoSharing=false;try{this.voximplantCall.hangup()}catch(e){this.log("Voximplant hangup error: ",e);console.error("Voximplant hangup error: ",e)}}else{this.log("Tried to hangup, but this.voximplantCall points nowhere");console.error("Tried to hangup, but this.voximplantCall points nowhere")}this.screenShared=false;qm(this,ag,xg).call(this)}},{key:"attachToConference",value:function e(){var t=this;var i=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};var n=i.joinAsViewer===true;if(this.voximplantCall&&this.voximplantCall.state()==="CONNECTED"){if(this.joinedAsViewer===n){return Promise.resolve()}else{return Promise.reject("Already joined call in another mode")}}return new Promise((function(e,i){t.direction=n?Sc.RecvOnly:Sc.SendRecv;t.sendTelemetryEvent("call");t.getClient().then((function(a){t.localUserState=yc.Connecting;VoxImplant.Hardware.CameraManager.get().setDefaultVideoSettings(t.constructCameraParams());if(t.microphoneId){VoxImplant.Hardware.AudioDeviceManager.get().setDefaultAudioSettings({inputId:t.microphoneId})}if(H.isCameraOn){qm(t,ng,Ng).call(t)}try{if(!t.ready){t.log("Error: trying to attach after hangup");return i({code:"VOX_NO_CALL"})}if(n){t.voximplantCall=a.joinAsViewer("bx_conf_"+t.id,{"X-Direction":Sc.RecvOnly})}else{t.voximplantCall=a.callConference({number:"bx_conf_"+t.id,video:{sendVideo:H.isCameraOn,receiveVideo:true},customData:JSON.stringify({cameraState:H.isCameraOn})})}}catch(e){console.error(e);return i(e)}t.joinedAsViewer=n;if(!t.voximplantCall){t.log("Error: could not create voximplant call");return i({code:"VOX_NO_CALL"})}t.runCallback(Zm.onCallConference,{call:t});t.bindCallEvents();t.subscribeHardwareChanges();t.voximplantCall.on(VoxImplant.CallEvents.Connected,(function(){qm(t,sg,Og).call(t);e()}),{once:true});t.voximplantCall.on(VoxImplant.CallEvents.Failed,(function(e){qm(t,rg,Ug).call(t,e);i(e)}),{once:true})}))["catch"](babelHelpers.classPrivateFieldGet(t,Eg).bind(t))}))}},{key:"bindCallEvents",value:function e(){this.voximplantCall.on(VoxImplant.CallEvents.Disconnected,babelHelpers.classPrivateFieldGet(this,Pg));this.voximplantCall.on(VoxImplant.CallEvents.MessageReceived,babelHelpers.classPrivateFieldGet(this,Dg));if(Yf.shouldCollectStats()){this.voximplantCall.on(VoxImplant.CallEvents.CallStatsReceived,babelHelpers.classPrivateFieldGet(this,Ag))}this.voximplantCall.on(VoxImplant.CallEvents.EndpointAdded,babelHelpers.classPrivateFieldGet(this,Mg));if(VoxImplant.CallEvents.Reconnecting){this.voximplantCall.on(VoxImplant.CallEvents.Reconnecting,babelHelpers.classPrivateFieldGet(this,Sg));this.voximplantCall.on(VoxImplant.CallEvents.Reconnected,babelHelpers.classPrivateFieldGet(this,wg))}}},{key:"removeCallEvents",value:function e(){if(this.voximplantCall){this.voximplantCall.removeEventListener(VoxImplant.CallEvents.Disconnected,babelHelpers.classPrivateFieldGet(this,Pg));this.voximplantCall.removeEventListener(VoxImplant.CallEvents.MessageReceived,babelHelpers.classPrivateFieldGet(this,Dg));if(Yf.shouldCollectStats()){this.voximplantCall.removeEventListener(VoxImplant.CallEvents.CallStatsReceived,babelHelpers.classPrivateFieldGet(this,Ag))}this.voximplantCall.removeEventListener(VoxImplant.CallEvents.EndpointAdded,babelHelpers.classPrivateFieldGet(this,Mg));if(VoxImplant.CallEvents.Reconnecting){this.voximplantCall.removeEventListener(VoxImplant.CallEvents.Reconnecting,babelHelpers.classPrivateFieldGet(this,Sg));this.voximplantCall.removeEventListener(VoxImplant.CallEvents.Reconnected,babelHelpers.classPrivateFieldGet(this,wg))}}}},{key:"subscribeHardwareChanges",value:function e(){H.subscribe(H.Events.onChangeMicrophoneMuted,this.setMuted);H.subscribe(H.Events.onChangeCameraOn,this.setVideoEnabled)}},{key:"unsubscribeHardwareChanges",value:function e(){H.unsubscribe(H.Events.onChangeMicrophoneMuted,this.setMuted);H.unsubscribe(H.Events.onChangeCameraOn,this.setVideoEnabled)}},{key:"addJoinedUsers",value:function e(t){for(var i=0;i<t.length;i++){var n=Number(t[i]);if(n==this.userId||this.peers[n]){continue}this.peers[n]=this.createPeer(n);if(!this.users.includes(n)){this.users.push(n)}this.runCallback(Ac.onUserInvited,{userId:n})}}},{key:"addInvitedUsers",value:function e(t){for(var i=0;i<t.length;i++){var n=Number(t[i]);if(n==this.userId){continue}if(this.peers[n]){if(this.peers[n].calculatedState===yc.Failed||this.peers[n].calculatedState===yc.Idle){if(this.type===wc.Instant){this.peers[n].onInvited()}}}else{this.peers[n]=this.createPeer(n);if(this.type===wc.Instant){this.peers[n].onInvited()}}if(!this.users.includes(n)){this.users.push(n)}this.runCallback(Ac.onUserInvited,{userId:n})}}},{key:"isAnyoneParticipating",value:function e(){for(var t in this.peers){if(this.peers[t].isParticipating()){return true}}return false}},{key:"getParticipatingUsers",value:function e(){var t=[];for(var i in this.peers){if(this.peers[i].isParticipating()){t.push(i)}}return t}},{key:"updateRoom",value:function e(t){if(!this.rooms[t.id]){this.rooms[t.id]={id:t.id,users:t.users,speaker:t.speaker}}else{this.rooms[t.id].users=t.users;this.rooms[t.id].speaker=t.speaker}}},{key:"currentRoom",value:function e(){return this._currentRoomId?this.rooms[this._currentRoomId]:null}},{key:"isRoomSpeaker",value:function e(){return this.currentRoom()?this.currentRoom().speaker==this.userId:false}},{key:"joinRoom",value:function e(t){this.signaling.sendJoinRoom(t)}},{key:"requestRoomSpeaker",value:function e(){this.signaling.sendRequestRoomSpeaker(this._currentRoomId)}},{key:"leaveCurrentRoom",value:function e(){this.signaling.sendLeaveRoom(this._currentRoomId)}},{key:"listRooms",value:function e(){var t=this;return new Promise((function(e){t.signaling.sendListRooms();t.__resolveListRooms=e}))}},{key:"__onPullEvent",value:function e(t,i,n){if(this.pullEventHandlers[t]){if(t!="Call::ping"){this.log("Signaling: "+t+"; Parameters: "+JSON.stringify(i))}this.pullEventHandlers[t].call(this,i)}}},{key:"__onPullEventAnswerSelf",value:function e(t){if(t.callInstanceId===this.instanceId){return}this.joinedElsewhere=true;this.runCallback(Ac.onJoin,{local:false})}},{key:"sendTelemetryEvent",value:function e(t){Yf.sendTelemetryEvent({call_id:this.id,user_id:this.userId,kind:"voximplant",event:t})}},{key:"destroy",value:function e(){this.ready=false;this.joinedAsViewer=false;qm(this,ag,xg).call(this);if(this.localVAD){this.localVAD.destroy();this.localVAD=null}clearInterval(this.microphoneLevelInterval);if(this.voximplantCall){this.removeCallEvents();this.unsubscribeHardwareChanges();if(this.voximplantCall.state()!="ENDED"){this.voximplantCall.hangup()}this.voximplantCall=null}for(var i in this.peers){if(this.peers.hasOwnProperty(i)&&this.peers[i]){this.peers[i].destroy()}}this.removeClientEvents();clearTimeout(this.lastPingReceivedTimeout);clearTimeout(this.lastSelfPingReceivedTimeout);clearInterval(this.pingUsersInterval);clearInterval(this.pingBackendInterval);window.removeEventListener("unload",babelHelpers.classPrivateFieldGet(this,_g));return babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"destroy",this).call(this)}},{key:"provider",get:function e(){return Tc.Voximplant}},{key:"screenShared",get:function e(){return this._screenShared},set:function e(t){if(t!=this._screenShared){this._screenShared=t;this.signaling.sendScreenState(this._screenShared)}}},{key:"localUserState",get:function e(){return this._localUserState},set:function e(t){if(t==this._localUserState){return}this.runCallback(Ac.onUserStateChanged,{userId:this.userId,state:t,previousState:this._localUserState,direction:this.direction});this._localUserState=t}},{key:"reconnectionEventCount",get:function e(){return this._reconnectionEventCount},set:function e(t){if(this._reconnectionEventCount===0&&t>0){this.runCallback(Ac.onReconnecting)}if(t===0){this.runCallback(Ac.onReconnected)}this._reconnectionEventCount=t}}]);return t}(Oi);function Ng(){var e=this;return new Promise((function(t){VoxImplant.Hardware.StreamManager.get().showLocalVideo(false).then((function(){e.localVideoShown=true;t()}),(function(){e.localVideoShown=true;t()}))}))}function xg(){var e=this;return new Promise((function(t){if(!("VoxImplant"in window)){t();return}VoxImplant.Hardware.StreamManager.get().hideLocalVideo().then((function(){e.localVideoShown=false;t()}),(function(){e.localVideoShown=false;t()}))}))}function Og(){this.log("Call connected");this.sendTelemetryEvent("connect");this.localUserState=yc.Connected;this.voximplantCall.on(VoxImplant.CallEvents.Failed,babelHelpers.classPrivateFieldGet(this,Pg));if(H.isMicrophoneMuted){this.voximplantCall.muteMicrophone()}this.signaling.sendMicrophoneState(!H.isMicrophoneMuted);this.signaling.sendCameraState(H.isCameraOn);if(this.videoAllowedFrom==Mc.none){this.signaling.sendHideAll()}else if(p.Type.isArray(this.videoAllowedFrom)){this.signaling.sendShowUsers(this.videoAllowedFrom)}}function Ug(e){this.log("Could not attach to conference",e);this.sendTelemetryEvent("connect_failure");this.localUserState=yc.Failed;var t=VoxImplant.getInstance();t.enableSilentLogging(false);t.setLoggerCallback(null)}function Fg(e,t){var i=parseInt(e.substring(4));if(this.peers[i]){this.peers[i].setEndpoint(t)}this.wasConnected=true}babelHelpers.defineProperty(Hg,"Event",Zm);var Vg=new WeakSet;var Gg=new WeakSet;var Wg=new WeakSet;var Xg=function(){function e(t){babelHelpers.classCallCheck(this,e);zm(this,Wg);zm(this,Gg);zm(this,Vg);this.call=t.call}babelHelpers.createClass(e,[{key:"inviteUsers",value:function e(t){return qm(this,Wg,qg).call(this,Ym.invite,t)}},{key:"sendAnswer",value:function e(t,i){if(i&&tu.getPullClient().isPublishingEnabled()){qm(this,Vg,zg).call(this,Qm.answer,t)}else{return qm(this,Wg,qg).call(this,Ym.answer,t)}}},{key:"sendCancel",value:function e(t){return qm(this,Wg,qg).call(this,Ym.cancel,t)}},{key:"sendHangup",value:function e(t){if(tu.getPullClient().isPublishingEnabled()){qm(this,Vg,zg).call(this,Qm.hangup,t);t.retransmit=false;qm(this,Wg,qg).call(this,Ym.hangup,t)}else{t.retransmit=true;qm(this,Wg,qg).call(this,Ym.hangup,t)}}},{key:"sendVoiceStarted",value:function e(t){return qm(this,Gg,jg).call(this,Jm.voiceStarted,t)}},{key:"sendVoiceStopped",value:function e(t){return qm(this,Gg,jg).call(this,Jm.voiceStopped,t)}},{key:"sendMicrophoneState",value:function e(t){return qm(this,Gg,jg).call(this,Jm.microphoneState,{microphoneState:t?"Y":"N"})}},{key:"sendCameraState",value:function e(t){return qm(this,Gg,jg).call(this,Jm.cameraState,{cameraState:t?"Y":"N"})}},{key:"sendScreenState",value:function e(t){return qm(this,Gg,jg).call(this,Jm.screenState,{screenState:t?"Y":"N"})}},{key:"sendLocalRecordState",value:function e(t){return qm(this,Gg,jg).call(this,Jm.recordState,t)}},{key:"sendFloorRequest",value:function e(t){return qm(this,Gg,jg).call(this,Jm.floorRequest,{requestActive:t?"Y":"N"})}},{key:"sendEmotion",value:function e(t,i){return qm(this,Gg,jg).call(this,Jm.emotion,{toUserId:t,emotion:i})}},{key:"sendCustomMessage",value:function e(t,i){return qm(this,Gg,jg).call(this,Jm.customMessage,{message:t,repeatOnConnect:!!i})}},{key:"sendShowUsers",value:function e(t){return qm(this,Gg,jg).call(this,Jm.showUsers,{users:t})}},{key:"sendShowAll",value:function e(){return qm(this,Gg,jg).call(this,Jm.showAll,{})}},{key:"sendHideAll",value:function e(){return qm(this,Gg,jg).call(this,Jm.hideAll,{})}},{key:"sendPingToUsers",value:function e(t){if(tu.getPullClient().isPublishingEnabled()){qm(this,Vg,zg).call(this,Qm.ping,t,0)}}},{key:"sendPingToBackend",value:function e(){qm(this,Wg,qg).call(this,Ym.ping,{retransmit:false})}},{key:"sendUserInviteTimeout",value:function e(t){if(tu.getPullClient().isPublishingEnabled()){qm(this,Vg,zg).call(this,Qm.userInviteTimeout,t,0)}}},{key:"sendJoinRoom",value:function e(t){return qm(this,Gg,jg).call(this,Jm.joinRoom,{roomId:t})}},{key:"sendLeaveRoom",value:function e(t){return qm(this,Gg,jg).call(this,Jm.leaveRoom,{roomId:t})}},{key:"sendListRooms",value:function e(){return qm(this,Gg,jg).call(this,Jm.listRooms)}},{key:"sendRequestRoomSpeaker",value:function e(t){return qm(this,Gg,jg).call(this,Jm.requestRoomSpeaker,{roomId:t})}}]);return e}();function zg(e,t,i){i=i||5;if(!t.userId){throw new Error("userId is not found in data")}if(!p.Type.isArray(t.userId)){t.userId=[t.userId]}if(t.userId.length===0){return}t.callInstanceId=this.call.instanceId;t.senderId=this.call.userId;t.callId=this.call.id;t.requestId=Yf.getUuidv4();this.call.log("Sending p2p signaling event "+e+"; "+JSON.stringify(t));tu.getPullClient().sendMessage(t.userId,"im",e,t,i)}function jg(e,t){if(!this.call.voximplantCall){return}if(!p.Type.isPlainObject(t)){t={}}t.eventName=e;t.requestId=Yf.getUuidv4();this.call.voximplantCall.sendMessage(JSON.stringify(t))}function qg(e,t){if(!p.Type.isPlainObject(t)){t={}}t.callId=this.call.id;t.callInstanceId=this.call.instanceId;t.requestId=Yf.getUuidv4();return tu.getRestClient().callMethod(e,t)}var Yg=new WeakMap;var Qg=new WeakMap;var Jg=new WeakMap;var Kg=new WeakMap;var Zg=new WeakMap;var $g=new WeakMap;var eb=new WeakMap;var tb=function(){function e(t){var i=this;babelHelpers.classCallCheck(this,e);Xm(this,Yg,{writable:true,value:function e(t){i.log("VoxImplant.EndpointEvents.RemoteMediaAdded",t.mediaRenderer);if(t.mediaRenderer.element){t.mediaRenderer.element.volume=0;t.mediaRenderer.element.srcObject=null}i.addMediaRenderer(t.mediaRenderer)}});Xm(this,Qg,{writable:true,value:function e(t){console.log("VoxImplant.EndpointEvents.RemoteMediaRemoved, ",t.mediaRenderer);i.removeMediaRenderer(t.mediaRenderer)}});Xm(this,Jg,{writable:true,value:function e(){i.callbacks.onVoiceStarted()}});Xm(this,Kg,{writable:true,value:function e(){i.callbacks.onVoiceEnded()}});Xm(this,Zg,{writable:true,value:function e(t){i.log("VoxImplant.EndpointEvents.Removed",t);if(i.endpoint){i.removeEndpointEventHandlers();i.endpoint=null}if(i.stream){i.stream=null}if(i.ready){i.waitForConnectionRestore()}i.updateCalculatedState()}});Xm(this,$g,{writable:true,value:function e(t){i.callbacks.onMediaRenderEnabled(t)}});Xm(this,eb,{writable:true,value:function e(t){i.callbacks.onMediaRenderDisabled(t)}});this.userId=t.userId;this.call=t.call;this.ready=!!t.ready;this.calling=false;this.declined=false;this.busy=false;this.inviteTimeout=false;this.endpoint=null;this.direction=t.direction||Sc.SendRecv;this.stream=null;this.mediaRenderers=[];this.isIncomingVideoAllowed=t.isIncomingVideoAllowed!==false;this.callingTimeout=0;this.connectionRestoreTimeout=0;this.callbacks={onStateChanged:p.Type.isFunction(t.onStateChanged)?t.onStateChanged:BX.DoNothing,onInviteTimeout:p.Type.isFunction(t.onInviteTimeout)?t.onInviteTimeout:BX.DoNothing,onMediaReceived:p.Type.isFunction(t.onMediaReceived)?t.onMediaReceived:BX.DoNothing,onMediaRemoved:p.Type.isFunction(t.onMediaRemoved)?t.onMediaRemoved:BX.DoNothing,onVoiceStarted:p.Type.isFunction(t.onVoiceStarted)?t.onVoiceStarted:BX.DoNothing,onVoiceEnded:p.Type.isFunction(t.onVoiceEnded)?t.onVoiceEnded:BX.DoNothing,onMediaRenderEnabled:p.Type.isFunction(t.onMediaRenderEnabled)?t.onMediaRenderEnabled:BX.DoNothing,onMediaRenderDisabled:p.Type.isFunction(t.onMediaRenderDisabled)?t.onMediaRenderDisabled:BX.DoNothing};this.calculatedState=this.calculateState()}babelHelpers.createClass(e,[{key:"setReady",value:function e(t){t=!!t;if(this.ready==t){return}this.ready=t;this.readyStack=(new Error).stack;if(this.calling){clearTimeout(this.callingTimeout);this.calling=false;this.inviteTimeout=false}if(this.ready){this.declined=false;this.busy=false}else{clearTimeout(this.connectionRestoreTimeout)}this.updateCalculatedState()}},{key:"setDirection",value:function e(t){if(this.direction==t){return}this.direction=t}},{key:"setDeclined",value:function e(t){this.declined=t;if(this.calling){clearTimeout(this.callingTimeout);this.calling=false}if(this.declined){this.ready=false;this.busy=false}clearTimeout(this.connectionRestoreTimeout);this.updateCalculatedState()}},{key:"setBusy",value:function e(t){this.busy=t;if(this.calling){clearTimeout(this.callingTimeout);this.calling=false}if(this.busy){this.ready=false;this.declined=false}clearTimeout(this.connectionRestoreTimeout);this.updateCalculatedState()}},{key:"setEndpoint",value:function e(t){this.log("Adding endpoint with "+t.mediaRenderers.length+" media renderers");this.setReady(true);this.inviteTimeout=false;this.declined=false;clearTimeout(this.connectionRestoreTimeout);if(this.endpoint){this.removeEndpointEventHandlers();this.endpoint=null}this.endpoint=t;for(var i=0;i<this.endpoint.mediaRenderers.length;i++){this.addMediaRenderer(this.endpoint.mediaRenderers[i]);if(this.endpoint.mediaRenderers[i].element);}this.bindEndpointEventHandlers()}},{key:"allowIncomingVideo",value:function e(t){if(this.isIncomingVideoAllowed==t){return}this.isIncomingVideoAllowed=!!t}},{key:"addMediaRenderer",value:function e(t){this.log("Adding media renderer for user"+this.userId,t);this.mediaRenderers.push(t);this.callbacks.onMediaReceived({userId:this.userId,kind:t.kind,mediaRenderer:t});this.updateCalculatedState()}},{key:"removeMediaRenderer",value:function e(t){this.log("Removing media renderer for user"+this.userId,t);var i=this.mediaRenderers.indexOf(t);if(i>=0){this.mediaRenderers.splice(i,1)}this.callbacks.onMediaRemoved({userId:this.userId,kind:t.kind,mediaRenderer:t});this.updateCalculatedState()}},{key:"bindEndpointEventHandlers",value:function e(){this.endpoint.addEventListener(VoxImplant.EndpointEvents.RemoteMediaAdded,babelHelpers.classPrivateFieldGet(this,Yg));this.endpoint.addEventListener(VoxImplant.EndpointEvents.RemoteMediaRemoved,babelHelpers.classPrivateFieldGet(this,Qg));this.endpoint.addEventListener(VoxImplant.EndpointEvents.VoiceStart,babelHelpers.classPrivateFieldGet(this,Jg));this.endpoint.addEventListener(VoxImplant.EndpointEvents.VoiceEnd,babelHelpers.classPrivateFieldGet(this,Kg));this.endpoint.addEventListener(VoxImplant.EndpointEvents.Removed,babelHelpers.classPrivateFieldGet(this,Zg));this.endpoint.addEventListener(VoxImplant.EndpointEvents.MediaRenderEnabled,babelHelpers.classPrivateFieldGet(this,$g));this.endpoint.addEventListener(VoxImplant.EndpointEvents.MediaRenderDisabled,babelHelpers.classPrivateFieldGet(this,eb))}},{key:"removeEndpointEventHandlers",value:function e(){this.endpoint.removeEventListener(VoxImplant.EndpointEvents.RemoteMediaAdded,babelHelpers.classPrivateFieldGet(this,Yg));this.endpoint.removeEventListener(VoxImplant.EndpointEvents.RemoteMediaRemoved,babelHelpers.classPrivateFieldGet(this,Qg));this.endpoint.removeEventListener(VoxImplant.EndpointEvents.VoiceStart,babelHelpers.classPrivateFieldGet(this,Jg));this.endpoint.removeEventListener(VoxImplant.EndpointEvents.VoiceEnd,babelHelpers.classPrivateFieldGet(this,Kg));this.endpoint.removeEventListener(VoxImplant.EndpointEvents.Removed,babelHelpers.classPrivateFieldGet(this,Zg));this.endpoint.removeEventListener(VoxImplant.EndpointEvents.MediaRenderEnabled,babelHelpers.classPrivateFieldGet(this,$g));this.endpoint.removeEventListener(VoxImplant.EndpointEvents.MediaRenderDisabled,babelHelpers.classPrivateFieldGet(this,eb))}},{key:"calculateState",value:function e(){if(this.endpoint){return yc.Connected}if(this.calling){return yc.Calling}if(this.inviteTimeout){return yc.Unavailable}if(this.declined){return yc.Declined}if(this.busy){return yc.Busy}if(this.ready){return yc.Ready}return yc.Idle}},{key:"updateCalculatedState",value:function e(){var t=this.calculateState();if(this.calculatedState!=t){this.callbacks.onStateChanged({userId:this.userId,state:t,previousState:this.calculatedState,direction:this.direction});this.calculatedState=t}}},{key:"isParticipating",value:function e(){return(this.calling||this.ready||this.endpoint)&&!this.declined}},{key:"waitForConnectionRestore",value:function e(){clearTimeout(this.connectionRestoreTimeout);this.connectionRestoreTimeout=setTimeout(this.onConnectionRestoreTimeout.bind(this),ig)}},{key:"onInvited",value:function e(){var t=this;this.ready=false;this.inviteTimeout=false;this.declined=false;this.calling=true;clearTimeout(this.connectionRestoreTimeout);if(this.callingTimeout){clearTimeout(this.callingTimeout)}this.callingTimeout=setTimeout((function(){return t.onInviteTimeout(true)}),3e4);this.updateCalculatedState()}},{key:"onInviteTimeout",value:function e(t){clearTimeout(this.callingTimeout);if(!this.calling){return}this.calling=false;this.inviteTimeout=true;if(t){this.callbacks.onInviteTimeout({userId:this.userId})}this.updateCalculatedState()}},{key:"onConnectionRestoreTimeout",value:function e(){if(this.endpoint||!this.ready){return}this.log("Done waiting for connection restoration");this.setReady(false)}},{key:"log",value:function e(){this.call.log.apply(this.call,arguments)}},{key:"destroy",value:function e(){if(this.stream){Yf.stopMediaStream(this.stream);this.stream=null}if(this.endpoint){this.removeEndpointEventHandlers();this.endpoint=null}this.callbacks.onStateChanged=BX.DoNothing;this.callbacks.onInviteTimeout=BX.DoNothing;this.callbacks.onMediaReceived=BX.DoNothing;this.callbacks.onMediaRemoved=BX.DoNothing;clearTimeout(this.callingTimeout);clearTimeout(this.connectionRestoreTimeout);this.callingTimeout=null;this.connectionRestoreTimeout=null}}]);return e}();var ib=function e(t,i){var n={connection:t.connection,outboundAudio:[],outboundVideo:[],inboundAudio:[],inboundVideo:[]};var a={};if(i.getEndpoints){i.getEndpoints().forEach((function(e){return a[e.id]=e}))}if(!n.connection.timestamp){n.connection.timestamp=Date.now()}for(var s in t.outbound){if(!t.outbound.hasOwnProperty(s)){continue}var r=t.outbound[s];for(var o=0;o<r.length;o++){var l=r[o];l.trackId=s;if("audioLevel"in l){n.outboundAudio.push(l)}else{n.outboundVideo.push(l)}}}var c=function e(){if(!t.inbound.hasOwnProperty(u)){return"continue"}var i=t.inbound[u];if(!("endpoint"in i)){return"continue"}i.trackId=u;if("audioLevel"in i){n.inboundAudio.push(i)}else{if(a[i.endpoint]){var s=a[i.endpoint].mediaRenderers.find((function(e){return e.id==i.trackId}));if(s&&s.element){i.actualHeight=s.element.videoHeight;i.actualWidth=s.element.videoWidth}}n.inboundVideo.push(i)}};for(var u in t.inbound){var d=c();if(d==="continue")continue}return n};var nb={AllowAll:"AllowAll",AllowNone:"AllowNone",OnlySpeaker:"OnlySpeaker",CurrentlyTalking:"CurrentlyTalking"};var ab=20;var sb=function(){function e(t){babelHelpers.classCallCheck(this,e);this.call=t.call;this.callView=t.callView;this.strategyType=t.strategyType||nb.AllowAll;this.onCallUserVoiceStartedHandler=this.onCallUserVoiceStarted.bind(this);this.onCallUserVoiceStoppedHandler=this.onCallUserVoiceStopped.bind(this);this.onCallViewSetCentralUserHandler=this.onCallViewSetCentralUser.bind(this);this.onCallViewLayoutChangeHandler=this.onCallViewLayoutChange.bind(this);this.users={};this.init()}babelHelpers.createClass(e,[{key:"init",value:function e(){if(this.strategyType===nb.AllowAll){this.call.allowVideoFrom(Mc.all)}else if(this.strategyType===nb.AllowNone){this.call.allowVideoFrom(Mc.none)}this.bindEvents()}},{key:"bindEvents",value:function e(){this.call.addEventListener(Ac.onUserVoiceStarted,this.onCallUserVoiceStartedHandler);this.call.addEventListener(Ac.onUserVoiceStopped,this.onCallUserVoiceStoppedHandler);this.callView.subscribe(es.Event.onSetCentralUser,this.onCallViewSetCentralUserHandler);this.callView.subscribe(es.Event.onLayoutChange,this.onCallViewLayoutChangeHandler)}},{key:"removeEvents",value:function e(){if(this.call){this.call.removeEventListener(Ac.onUserVoiceStarted,this.onCallUserVoiceStartedHandler);this.call.removeEventListener(Ac.onUserVoiceStopped,this.onCallUserVoiceStoppedHandler)}if(this.callView){this.callView.unsubscribe(es.Event.onSetCentralUser,this.onCallViewSetCentralUserHandler);this.callView.unsubscribe(es.Event.onLayoutChange,this.onCallViewLayoutChangeHandler)}}},{key:"setType",value:function e(t){if(t==this.strategyType){return}this.strategyType=t;this.applyVideoLimit()}},{key:"applyVideoLimit",value:function e(){if(this.strategyType===nb.AllowAll){this.call.allowVideoFrom(Mc.all)}else if(this.strategyType===nb.AllowNone){this.call.allowVideoFrom(Mc.none)}else if(this.strategyType===nb.CurrentlyTalking){var t=this.getActiveUsers();if(t.length===0){this.call.allowVideoFrom(Mc.none)}else{this.call.allowVideoFrom(this.getActiveUsers())}}}},{key:"getActiveUsers",value:function e(){var t=[];for(var i in this.users){var n=this.users[i];if(n.active){t.push(n.id)}}return t}},{key:"onUserActiveChanged",value:function e(){if(this.strategyType==nb.CurrentlyTalking){this.applyVideoLimit()}}},{key:"onCallUserVoiceStarted",value:function e(t){var i=t.userId;if(!this.users[i]){this.users[i]=new rb({id:i,onActiveChanged:this.onUserActiveChanged.bind(this)})}this.users[i].setTalking(true)}},{key:"onCallUserVoiceStopped",value:function e(t){var i=t.userId;if(!this.users[i]){this.users[i]=new rb({id:i,onActiveChanged:this.onUserActiveChanged.bind(this)})}this.users[i].setTalking(false)}},{key:"onCallViewSetCentralUser",value:function e(t){var i=t.data.userId;if(this.strategyType===nb.OnlySpeaker){this.call.allowVideoFrom([i])}}},{key:"onCallViewLayoutChange",value:function e(t){}},{key:"destroy",value:function e(){this.removeEvents();this.call=null;this.callView=null;for(var t in this.users){if(this.users.hasOwnProperty(t)){this.users[t].destroy()}}this.users={}}}]);return e}();babelHelpers.defineProperty(sb,"Type",nb);var rb=function(){function e(t){babelHelpers.classCallCheck(this,e);babelHelpers.defineProperty(this,"talking",false);babelHelpers.defineProperty(this,"sharing",false);babelHelpers.defineProperty(this,"active",false);this.id=t.id;this.callbacks={onActiveChanged:p.Type.isFunction(t.onActiveChanged)?t.onActiveChanged:BX.DoNothing};this.turnOffVideoTimeout=null}babelHelpers.createClass(e,[{key:"setTalking",value:function e(t){if(this.talking==t){return}this.talking=t;if(this.talking){this.cancelTurnOffVideo();this.updateActive()}else{this.scheduleTurnOffVideo()}}},{key:"setSharing",value:function e(t){if(this.sharing==t){return}this.sharing=t;if(this.sharing){this.cancelTurnOffVideo();this.updateActive()}else{this.scheduleTurnOffVideo()}}},{key:"updateActive",value:function e(){var t=!!(this.sharing||this.talking||this.turnOffVideoTimeout);if(t!==this.active){this.active=t}this.callbacks.onActiveChanged({userId:this.id,active:this.active})}},{key:"scheduleTurnOffVideo",value:function e(){var t=this;clearTimeout(this.turnOffVideoTimeout);this.turnOffVideoTimeout=setTimeout((function(){t.turnOffVideoTimeout=null;t.updateActive()}),ab*1e3)}},{key:"cancelTurnOffVideo",value:function e(){clearTimeout(this.turnOffVideoTimeout);this.turnOffVideoTimeout=null}},{key:"destroy",value:function e(){this.callbacks.onActiveChanged=BX.DoNothing;clearTimeout(this.turnOffVideoTimeout)}}]);return e}();var ob=function(){function e(t){babelHelpers.classCallCheck(this,e);this.popup=null;this.popupTemplate=null;this.isCopilotActive=t.isCopilotActive;this.isCopilotFeaturesEnabled=t.isCopilotFeaturesEnabled;this.callId=t.callId;this.callbacks={updateCopilotState:BX.type.isFunction(t.updateCopilotState)?t.updateCopilotState:BX.DoNothing,onClose:BX.type.isFunction(t.onClose)?t.onClose:BX.DoNothing}}babelHelpers.createClass(e,[{key:"getPopupTemplate",value:function e(){var t=this;var i=function e(){if(!t.isCopilotFeaturesEnabled){t.sendAnalytics("private_coming_soon");return{props:{className:"bx-call-copilot-popup__button coming_soon"},text:BX.message("CALL_COPILOT_POPUP_BUTTON_COMING_SOON")}}if(!kn.settingsEnabled){t.sendAnalytics("error_turnedoff");return{props:{className:"bx-call-copilot-popup__button bx-call-copilot-popup__button_transparent"},text:p.Loc.getMessage("CALL_COPILOT_POPUP_SETTINGS_DISABLED")}}if(!kn.tariffAvailable){t.sendAnalytics("tariff_limit");return{props:{className:"bx-call-copilot-popup__button tariff_up"},events:{click:function e(){Yf.openArticle(kn.helpSlider);t.close()}},children:[p.Dom.create("div",{props:{className:"bx-call-copilot-popup__button_wrapper"},children:[p.Dom.create("div",{props:{className:"bx-call-copilot-popup__button_icon"}}),p.Dom.create("div",{props:{className:"bx-call-copilot-popup__button_text"},text:BX.message("CALL_COPILOT_POPUP_TARIFF_UP")})]})]}}if(!kn.agreementAccepted){t.sendAnalytics("agreement_limit");return{props:{className:"bx-call-copilot-popup__button bx-call-copilot-popup__button_transparent"},text:BX.message("CALL_COPILOT_POPUP_CONCERN_NOT_ACCEPTED")}}if(t.isCopilotActive){return{props:{className:"bx-call-copilot-popup__button turn_off"},text:BX.message("CALL_COPILOT_POPUP_BUTTON_DISABLE"),events:{click:function e(){t.callbacks.updateCopilotState();t.close()}}}}if(!kn.baasAvailable){t.sendAnalytics("baas_limit");return{props:{className:"bx-call-copilot-popup__button --secondary buy_boost"},children:[p.Dom.create("div",{props:{className:"bx-call-copilot-popup__button_wrapper"},children:[p.Dom.create("div",{props:{className:"bx-call-copilot-popup__button_icon"}}),p.Dom.create("div",{props:{className:"bx-call-copilot-popup__button_text"},text:BX.message("CALL_COPILOT_POPUP_BUTTON_BUY_BOOST")})]})],events:{click:function e(){Yf.openArticle(kn.baasPromoSlider);t.close()}}}}return{props:{className:"bx-call-copilot-popup__button turn_on"},text:BX.message("CALL_COPILOT_POPUP_BUTTON_ENABLE"),events:{click:function e(){t.callbacks.updateCopilotState();t.close()}}}};this.popupTemplate=p.Dom.create("div",{props:{className:"bx-call-copilot-popup__wrapper"},children:[p.Dom.create("div",{props:{className:"bx-call-copilot-popup__content"},children:[p.Dom.create("div",{props:{className:"bx-call-copilot-popup__title"},children:[p.Dom.create("div",{props:{className:"bx-call-copilot-popup__title-icon-background"},children:[p.Dom.create("div",{props:{className:"bx-call-copilot-popup__title-icon-image"}})]}),p.Dom.create("div",{props:{className:"bx-call-copilot-popup__title-text"},text:BX.message("CALL_COPILOT_POPUP_TITLE")})]}),p.Dom.create("div",{props:{className:"bx-call-copilot-popup__description"},text:BX.message("CALL_COPILOT_POPUP_LIST_TITLE")}),p.Dom.create("ul",{props:{className:"bx-call-copilot-popup__list"},children:[p.Dom.create("li",{props:{className:"bx-call-copilot-popup__list-item"},children:[p.Dom.create("div",{props:{className:"bx-call-copilot-popup__list-item-icon bx-call-copilot-popup__list-item-icon_ai"}}),p.Dom.create("div",{props:{className:"bx-call-copilot-popup__list-item-text"},text:BX.message("CALL_COPILOT_POPUP_LIST_ITEM_AGENDA")})]}),p.Dom.create("li",{props:{className:"bx-call-copilot-popup__list-item"},children:[p.Dom.create("div",{props:{className:"bx-call-copilot-popup__list-item-icon bx-call-copilot-popup__list-item-icon_pen"}}),p.Dom.create("div",{props:{className:"bx-call-copilot-popup__list-item-text"},text:BX.message("CALL_COPILOT_POPUP_LIST_ITEM_AGREEMENTS_V2")})]}),p.Dom.create("li",{props:{className:"bx-call-copilot-popup__list-item"},children:[p.Dom.create("div",{props:{className:"bx-call-copilot-popup__list-item-icon bx-call-copilot-popup__list-item-icon_magic-pen"}}),p.Dom.create("div",{props:{className:"bx-call-copilot-popup__list-item-text"},text:BX.message("CALL_COPILOT_POPUP_LIST_ITEM_GRADE")})]}),p.Dom.create("li",{props:{className:"bx-call-copilot-popup__list-item"},children:[p.Dom.create("div",{props:{className:"bx-call-copilot-popup__list-item-icon bx-call-copilot-popup__list-item-icon_list"}}),p.Dom.create("div",{props:{className:"bx-call-copilot-popup__list-item-text"},text:BX.message("CALL_COPILOT_POPUP_LIST_ITEM_TRANSCRIPT_V2")})]})]})]}),p.Dom.create("div",{props:{className:"bx-call-copilot-popup__actions"},children:[p.Dom.create("button",i())]})]})}},{key:"close",value:function e(){if(this.popup){this.popup.close()}}},{key:"create",value:function e(){var t=document.querySelector(".bx-messenger-videocall-panel-background-copilot");var i=this;if(!t){return}this.getPopupTemplate();this.popup=new v.Popup({className:"bx-call-copilot-popup",bindElement:t,targetContainer:document.body,content:this.popupTemplate,bindOptions:{position:"top"},autoHide:true,closeByEsc:true,background:"#190A37",contentBackground:"#190A37",darkMode:true,contentNoPaddings:true,animation:"fading",width:364,padding:0,angle:{offset:162,position:"bottom"},offsetLeft:-118,contentBorderRadius:"18px",events:{onPopupClose:function e(){i.callbacks.onClose();this.destroy()},onPopupDestroy:function e(){i.popup=null}}})}},{key:"show",value:function e(){this.create();this.popup.show()}},{key:"toggle",value:function e(){if(!this.popup){this.show();return}this.close()}},{key:"sendAnalytics",value:function e(t){h.Analytics.getInstance().copilot.onAIRestrictionsPopupShow({callId:this.callId,popupType:t})}}]);return e}();var lb=function(){function e(t){babelHelpers.classCallCheck(this,e);this.popup=null;this.roomPermissions=t.roomPermissions;this.elements={root:null,roomPermissions:null,roomSettings:null,allParticipantsDeviceControl:null};this.roomSettingsElements={mic:null,cam:null,screenshare:null};this.callbacks={turnOffAllParticipansStream:BX.type.isFunction(t.turnOffAllParticipansStream)?t.turnOffAllParticipansStream:BX.DoNothing,onPermissionChanged:BX.type.isFunction(t.onPermissionChanged)?t.onPermissionChanged:BX.DoNothing,onPermissionCollapseStateChanged:BX.type.isFunction(t.onPermissionCollapseStateChanged)?t.onPermissionCollapseStateChanged:BX.DoNothing,onClose:BX.type.isFunction(t.onClose)?t.onClose:BX.DoNothing,onOpen:BX.type.isFunction(t.onOpen)?t.onOpen:BX.DoNothing};this.eventEmitter=new f.EventEmitter(this,"ParticipantsPermissionPopup");this.currentBitrixCall=Yf.getCurrentBitrixCall();this.isShowPopup=Yf.isUserControlFeatureEnabled()&&this.currentBitrixCall&&this.currentBitrixCall.provider!==Tc.Plain;this.isShowRoomSettings=BX.prop.getObject(t,"showRoomSettings",false);if(!Yf.getRoomPermissions().ScreenShareEnabled||!Yf.getRoomPermissions().AudioEnabled||!Yf.getRoomPermissions().VideoEnabled){this.isShowRoomSettings=true}var i=BX.prop.getObject(t,"events",{});for(var n in i){if(!i.hasOwnProperty(n)){continue}this.eventEmitter.subscribe(n,i[n])}}babelHelpers.createClass(e,[{key:"renderSettingsElements",value:function e(){this.roomSettingsElements.screenshare=hb.create({typeOfSetting:"screenshare",canControlPermission:true,settingEnabled:Yf.getRoomPermissions().ScreenShareEnabled,label:BX.message("CALL_CONTROL_PERMISSIONS_IN_CALL_LABEL_SCREENSHARE"),events:{onSwitch:this.onPermissionChanged.bind(this)}});this.roomSettingsElements.mic=hb.create({typeOfSetting:"mic",canControlPermission:true,settingEnabled:Yf.getRoomPermissions().AudioEnabled,label:BX.message("CALL_CONTROL_PERMISSIONS_IN_CALL_LABEL_MIC"),events:{onSwitch:this.onPermissionChanged.bind(this)}});this.roomSettingsElements.cam=hb.create({typeOfSetting:"cam",canControlPermission:true,settingEnabled:Yf.getRoomPermissions().VideoEnabled,label:BX.message("CALL_CONTROL_PERMISSIONS_IN_CALL_LABEL_CAM"),events:{onSwitch:this.onPermissionChanged.bind(this)}});return[this.roomSettingsElements.screenshare.render(),this.roomSettingsElements.mic.render(),this.roomSettingsElements.cam.render()]}},{key:"updateStatePermissions",value:function e(){if(this.elements.roomSettings){var t;var i=this.renderSettingsElements();this.elements.roomSettings.innerHTML="";(t=this.elements.roomSettings).append.apply(t,babelHelpers.toConsumableArray(i))}}},{key:"toggleRoomSettings",value:function e(t){this.isShowRoomSettings=!this.isShowRoomSettings;if(this.isShowRoomSettings){this.elements.roomPermissions.classList.add("permissions-uncollapsed")}else{this.elements.roomPermissions.classList.remove("permissions-uncollapsed")}this.callbacks.onPermissionCollapseStateChanged(this.isShowRoomSettings)}},{key:"getPopupTemplate",value:function e(){var t=this;return p.Dom.create("div",{props:{className:"bx-call-participants-permission-popup__wrapper"},children:[p.Dom.create("div",{props:{className:"bx-call-participants-permission-popup__content"},children:[this.elements.roomPermissions=p.Dom.create("div",{props:{className:"bx-call-participants-permission-popup__permissions-wrapper"},children:[p.Dom.create("div",{props:{className:"bx-call-participants-permission-popup__permissions-title-wrapper"},events:{click:function e(){t.toggleRoomSettings()}},children:[p.Dom.create("span",{props:{className:"bx-call-participants-permission-popup__permissions-title"},text:BX.message("CALL_CONTROL_PERMISSIONS_IN_CALL_TITLE")}),p.Dom.create("div",{props:{className:"bx-call-participants-permission-popup__permissions-title-arrow"}})]}),this.elements.roomSettings=p.Dom.create("div",{props:{className:"bx-call-participants-permission-popup__permissions"}})]}),p.Dom.create("div",{props:{className:"bx-call-participants-permission-popup__control-buttons-label"},text:BX.message("CALL_ADMIN_TURN_OFF_FOR_ALL_LABEL")}),p.Dom.create("div",{props:{className:"bx-call-participants-permission-popup__control-buttons"},children:[this.turnOffMicContainer=ub.create({typeOfStream:"mic",label:BX.message("CALL_TURN_OFF_MIC_FOR_ALL_PARTICIPANTS_MSGVER_1"),events:{onTurnOffStreamForAll:this.onTurnOffStreamForAll.bind(this)}}).render(),this.turnOffMicContainer=ub.create({typeOfStream:"cam",label:BX.message("CALL_TURN_OFF_CAM_FOR_ALL_PARTICIPANTS_MSGVER_1"),events:{onTurnOffStreamForAll:this.onTurnOffStreamForAll.bind(this)}}).render(),this.turnOffMicContainer=ub.create({typeOfStream:"screenshare",label:BX.message("CALL_TURN_OFF_SCREENSHARE_FOR_ALL_PARTICIPANTS_MSGVER_1"),events:{onTurnOffStreamForAll:this.onTurnOffStreamForAll.bind(this)}}).render()]})]})]})}},{key:"onPermissionChanged",value:function e(t){this.callbacks.onPermissionChanged(t.data)}},{key:"onTurnOffStreamForAll",value:function e(t){this.callbacks.turnOffAllParticipansStream(t);this.close()}},{key:"close",value:function e(){if(this.popup){this.popup.close()}}},{key:"create",value:function e(){var t;var i=document.querySelector(".bx-messenger-videocall-top-button-text.callcontrol");var n=this;if(!i){return}if(!this.isShowPopup){return}this.elements.root=this.getPopupTemplate();var a=this.renderSettingsElements();this.elements.roomSettings.innerHTML="";(t=this.elements.roomSettings).append.apply(t,babelHelpers.toConsumableArray(a));if(this.isShowRoomSettings){var s;(s=this.elements.roomPermissions)===null||s===void 0?void 0:s.classList.add("permissions-uncollapsed")}else{var r;(r=this.elements.roomPermissions)===null||r===void 0?void 0:r.classList.remove("permissions-uncollapsed")}this.popup=new v.Popup({className:"bx-call-participants-permission-popup",bindElement:i,targetContainer:document.body,content:this.elements.root,offsetTop:10,bindOptions:{position:"bottom"},autoHide:true,closeByEsc:true,angle:{position:"top"},contentNoPaddings:true,animation:"fading",events:{onPopupClose:function e(){n.callbacks.onClose();this.destroy()},onPopupShow:function e(){n.callbacks.onOpen()},onPopupDestroy:function e(){n.popup=null}}})}},{key:"show",value:function e(){var t;this.create();(t=this.popup)===null||t===void 0?void 0:t.show()}},{key:"toggle",value:function e(){if(!this.popup){this.show();return}this.close()}}]);return e}();var cb={onTurnOffStreamForAll:"onTurnOffStreamForAll"};var ub=function(){function e(t){babelHelpers.classCallCheck(this,e);t=BX.type.isObject(t)?t:{};this.label=t.label||"";this.typeOfStream=t.typeOfStream||"";this.eventEmitter=new f.EventEmitter(this,"ParticipantsStreamControl");var i=BX.prop.getObject(t,"events",{});for(var n in i){if(!i.hasOwnProperty(n)){continue}this.eventEmitter.subscribe(n,i[n])}}babelHelpers.createClass(e,[{key:"render",value:function e(){var t=this;return p.Dom.create("div",{props:{className:"bx-call-view-participants-control-stream-button"},children:[p.Dom.create("div",{props:{className:"bx-call-view-participants-control-stream-button-icon bx-call-view-participants-control-stream-button-icon-"+this.typeOfStream}}),p.Dom.create("div",{props:{className:"bx-call-view-participants-control-stream-button-action"},text:this.label})],events:{click:function e(i){t.eventEmitter.emit(cb.onTurnOffStreamForAll,{typeOfStream:t.typeOfStream})}}})}}],[{key:"create",value:function t(i){return new e(i)}}]);return e}();var db={onSwitch:"onSwitch"};var hb=function(){function e(t){babelHelpers.classCallCheck(this,e);t=BX.type.isObject(t)?t:{};this.label=t.label||"";this.typeOfSetting=t.typeOfSetting||"";this.canControlPermission=t.canControlPermission||false;this.settingEnabled=t.settingEnabled||false;this.eventEmitter=new f.EventEmitter(this,"ParticipantsPermissionSwitcher");var i=BX.prop.getObject(t,"events",{});for(var n in i){if(!i.hasOwnProperty(n)){continue}this.eventEmitter.subscribe(n,i[n])}}babelHelpers.createClass(e,[{key:"onSwitchToggled",value:function e(t){if(!this.canControlPermission){return}this.settingEnabled=!this.settingEnabled;this.eventEmitter.emit(db.onSwitch,{settingEnabled:this.settingEnabled,typeOfSetting:this.typeOfSetting})}},{key:"render",value:function e(){return p.Dom.create("div",{props:{className:"bx-call-view-participants-permissions-switch-wrapper"},dataset:{id:"call-participants-permissions-switch-"+this.typeOfSetting},children:[p.Dom.create("span",{props:{className:"bx-call-view-participants-permissions-label"},text:this.label}),p.Dom.create("div",{props:{className:"bx-call-view-participants-permissions-switch"},children:[new BX.UI.Switcher({size:"small",checked:this.settingEnabled,handlers:{toggled:this.onSwitchToggled.bind(this)},disabled:!this.canControlPermission}).getNode()]})]})}}],[{key:"create",value:function t(i){return new e(i)}}]);return e}();function pb(){/*! regenerator-runtime -- Copyright (c) 2014-present, Facebook, Inc. -- license (MIT): https://github.com/facebook/regenerator/blob/main/LICENSE */pb=function t(){return e};var e={},t=Object.prototype,i=t.hasOwnProperty,n=Object.defineProperty||function(e,t,i){e[t]=i.value},a="function"==typeof Symbol?Symbol:{},s=a.iterator||"@@iterator",r=a.asyncIterator||"@@asyncIterator",o=a.toStringTag||"@@toStringTag";function l(e,t,i){return Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{l({},"")}catch(e){l=function e(t,i,n){return t[i]=n}}function c(e,t,i,a){var s=t&&t.prototype instanceof h?t:h,r=Object.create(s.prototype),o=new T(a||[]);return n(r,"_invoke",{value:y(e,i,o)}),r}function u(e,t,i){try{return{type:"normal",arg:e.call(t,i)}}catch(e){return{type:"throw",arg:e}}}e.wrap=c;var d={};function h(){}function p(){}function v(){}var f={};l(f,s,(function(){return this}));var m=Object.getPrototypeOf,g=m&&m(m(P([])));g&&g!==t&&i.call(g,s)&&(f=g);var b=v.prototype=h.prototype=Object.create(f);function C(e){["next","throw","return"].forEach((function(t){l(e,t,(function(e){return this._invoke(t,e)}))}))}function k(e,t){function a(n,s,r,o){var l=u(e[n],e,s);if("throw"!==l.type){var c=l.arg,d=c.value;return d&&"object"==babelHelpers["typeof"](d)&&i.call(d,"__await")?t.resolve(d.__await).then((function(e){a("next",e,r,o)}),(function(e){a("throw",e,r,o)})):t.resolve(d).then((function(e){c.value=e,r(c)}),(function(e){return a("throw",e,r,o)}))}o(l.arg)}var s;n(this,"_invoke",{value:function e(i,n){function r(){return new t((function(e,t){a(i,n,e,t)}))}return s=s?s.then(r,r):r()}})}function y(e,t,i){var n="suspendedStart";return function(a,s){if("executing"===n)throw new Error("Generator is already running");if("completed"===n){if("throw"===a)throw s;return _()}for(i.method=a,i.arg=s;;){var r=i.delegate;if(r){var o=S(r,i);if(o){if(o===d)continue;return o}}if("next"===i.method)i.sent=i._sent=i.arg;else if("throw"===i.method){if("suspendedStart"===n)throw n="completed",i.arg;i.dispatchException(i.arg)}else"return"===i.method&&i.abrupt("return",i.arg);n="executing";var l=u(e,t,i);if("normal"===l.type){if(n=i.done?"completed":"suspendedYield",l.arg===d)continue;return{value:l.arg,done:i.done}}"throw"===l.type&&(n="completed",i.method="throw",i.arg=l.arg)}}}function S(e,t){var i=t.method,n=e.iterator[i];if(undefined===n)return t.delegate=null,"throw"===i&&e.iterator["return"]&&(t.method="return",t.arg=undefined,S(e,t),"throw"===t.method)||"return"!==i&&(t.method="throw",t.arg=new TypeError("The iterator does not provide a '"+i+"' method")),d;var a=u(n,e.iterator,t.arg);if("throw"===a.type)return t.method="throw",t.arg=a.arg,t.delegate=null,d;var s=a.arg;return s?s.done?(t[e.resultName]=s.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=undefined),t.delegate=null,d):s:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,d)}function w(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function I(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function T(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(w,this),this.reset(!0)}function P(e){if(e){var t=e[s];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var n=-1,a=function t(){for(;++n<e.length;)if(i.call(e,n))return t.value=e[n],t.done=!1,t;return t.value=undefined,t.done=!0,t};return a.next=a}}return{next:_}}function _(){return{value:undefined,done:!0}}return p.prototype=v,n(b,"constructor",{value:v,configurable:!0}),n(v,"constructor",{value:p,configurable:!0}),p.displayName=l(v,o,"GeneratorFunction"),e.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===p||"GeneratorFunction"===(t.displayName||t.name))},e.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,v):(e.__proto__=v,l(e,o,"GeneratorFunction")),e.prototype=Object.create(b),e},e.awrap=function(e){return{__await:e}},C(k.prototype),l(k.prototype,r,(function(){return this})),e.AsyncIterator=k,e.async=function(t,i,n,a,s){void 0===s&&(s=Promise);var r=new k(c(t,i,n,a),s);return e.isGeneratorFunction(i)?r:r.next().then((function(e){return e.done?e.value:r.next()}))},C(b),l(b,o,"Generator"),l(b,s,(function(){return this})),l(b,"toString",(function(){return"[object Generator]"})),e.keys=function(e){var t=Object(e),i=[];for(var n in t)i.push(n);return i.reverse(),function e(){for(;i.length;){var n=i.pop();if(n in t)return e.value=n,e.done=!1,e}return e.done=!0,e}},e.values=P,T.prototype={constructor:T,reset:function e(t){if(this.prev=0,this.next=0,this.sent=this._sent=undefined,this.done=!1,this.delegate=null,this.method="next",this.arg=undefined,this.tryEntries.forEach(I),!t)for(var n in this)"t"===n.charAt(0)&&i.call(this,n)&&!isNaN(+n.slice(1))&&(this[n]=undefined)},stop:function e(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function e(t){if(this.done)throw t;var n=this;function a(e,i){return o.type="throw",o.arg=t,n.next=e,i&&(n.method="next",n.arg=undefined),!!i}for(var s=this.tryEntries.length-1;s>=0;--s){var r=this.tryEntries[s],o=r.completion;if("root"===r.tryLoc)return a("end");if(r.tryLoc<=this.prev){var l=i.call(r,"catchLoc"),c=i.call(r,"finallyLoc");if(l&&c){if(this.prev<r.catchLoc)return a(r.catchLoc,!0);if(this.prev<r.finallyLoc)return a(r.finallyLoc)}else if(l){if(this.prev<r.catchLoc)return a(r.catchLoc,!0)}else{if(!c)throw new Error("try statement without catch or finally");if(this.prev<r.finallyLoc)return a(r.finallyLoc)}}}},abrupt:function e(t,n){for(var a=this.tryEntries.length-1;a>=0;--a){var s=this.tryEntries[a];if(s.tryLoc<=this.prev&&i.call(s,"finallyLoc")&&this.prev<s.finallyLoc){var r=s;break}}r&&("break"===t||"continue"===t)&&r.tryLoc<=n&&n<=r.finallyLoc&&(r=null);var o=r?r.completion:{};return o.type=t,o.arg=n,r?(this.method="next",this.next=r.finallyLoc,d):this.complete(o)},complete:function e(t,i){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&i&&(this.next=i),d},finish:function e(t){for(var i=this.tryEntries.length-1;i>=0;--i){var n=this.tryEntries[i];if(n.finallyLoc===t)return this.complete(n.completion,n.afterLoc),I(n),d}},catch:function e(t){for(var i=this.tryEntries.length-1;i>=0;--i){var n=this.tryEntries[i];if(n.tryLoc===t){var a=n.completion;if("throw"===a.type){var s=a.arg;I(n)}return s}}throw new Error("illegal catch attempt")},delegateYield:function e(t,i,n){return this.delegate={iterator:P(t),resultName:i,nextLoc:n},"next"===this.method&&(this.arg=undefined),d}},e}function vb(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function fb(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?vb(Object(i),!0).forEach((function(t){babelHelpers.defineProperty(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):vb(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}function mb(e,t){bb(e,t);t.add(e)}function gb(e,t,i){bb(e,t);t.set(e,i)}function bb(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}function Cb(e,t,i){if(!t.has(e)){throw new TypeError("attempted to get private field on non-instance")}return i}var kb={onViewStateChanged:"onViewStateChanged",onOpenVideoConference:"onOpenVideoConference",onPromoViewed:"onPromoViewed",onCallJoined:"onCallJoined",onCallLeft:"onCallLeft",onCallDestroyed:"onCallDestroyed"};var yb={Opened:"Opened",Closed:"Closed",Folded:"Folded"};var Sb={Resume:"resume",Blank:"blank"};var wb={Enabled:"enabled",Disabled:"disabled",Limited:"limited"};var Ib=961;var Tb=328;var Pb="CallController::documentCreated";var _b="im:call-document:16102021:web";var Eb=5*60*1e3;var Rb="docx";var Mb="xlsx";var Ab="pptx";var Lb="bx-call-control-notification-right-offset";var Bb="im:mask:06122022:desktop";var Db=5*60*1e3;var Hb="M";var Nb=new WeakMap;var xb=new WeakMap;var Ob=new WeakMap;var Ub=new WeakMap;var Fb=new WeakSet;var Vb=new WeakSet;var Gb=new WeakSet;var Wb=new WeakSet;var Xb=new WeakSet;var zb=new WeakSet;var jb=new WeakSet;var qb=new WeakSet;var Yb=new WeakSet;var Qb=new WeakSet;var Jb=new WeakSet;var Kb=new WeakSet;var Zb=new WeakSet;var $b=new WeakSet;var eC=new WeakSet;var tC=new WeakSet;var iC=new WeakSet;var nC=new WeakSet;var aC=new WeakSet;var sC=new WeakSet;var rC=new WeakSet;var oC=new WeakSet;var lC=new WeakSet;var cC=new WeakSet;var uC=new WeakSet;var dC=new WeakSet;var hC=new WeakSet;var pC=new WeakSet;var vC=function(e){babelHelpers.inherits(t,e);function t(e){var i;babelHelpers.classCallCheck(this,t);i=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this));mb(babelHelpers.assertThisInitialized(i),pC);mb(babelHelpers.assertThisInitialized(i),hC);mb(babelHelpers.assertThisInitialized(i),dC);mb(babelHelpers.assertThisInitialized(i),uC);mb(babelHelpers.assertThisInitialized(i),cC);mb(babelHelpers.assertThisInitialized(i),lC);mb(babelHelpers.assertThisInitialized(i),oC);mb(babelHelpers.assertThisInitialized(i),rC);mb(babelHelpers.assertThisInitialized(i),sC);mb(babelHelpers.assertThisInitialized(i),aC);mb(babelHelpers.assertThisInitialized(i),nC);mb(babelHelpers.assertThisInitialized(i),iC);mb(babelHelpers.assertThisInitialized(i),tC);mb(babelHelpers.assertThisInitialized(i),eC);mb(babelHelpers.assertThisInitialized(i),$b);mb(babelHelpers.assertThisInitialized(i),Zb);mb(babelHelpers.assertThisInitialized(i),Kb);mb(babelHelpers.assertThisInitialized(i),Jb);mb(babelHelpers.assertThisInitialized(i),Qb);mb(babelHelpers.assertThisInitialized(i),Yb);mb(babelHelpers.assertThisInitialized(i),qb);mb(babelHelpers.assertThisInitialized(i),jb);mb(babelHelpers.assertThisInitialized(i),zb);mb(babelHelpers.assertThisInitialized(i),Xb);mb(babelHelpers.assertThisInitialized(i),Wb);mb(babelHelpers.assertThisInitialized(i),Gb);mb(babelHelpers.assertThisInitialized(i),Vb);mb(babelHelpers.assertThisInitialized(i),Fb);gb(babelHelpers.assertThisInitialized(i),Nb,{writable:true,value:void 0});gb(babelHelpers.assertThisInitialized(i),xb,{writable:true,value:void 0});gb(babelHelpers.assertThisInitialized(i),Ob,{writable:true,value:void 0});gb(babelHelpers.assertThisInitialized(i),Ub,{writable:true,value:void 0});i.setEventNamespace("BX.Call.Controller");var n=BX.prop.getBoolean(e,"init",true);i.language=e.language||"en";i.incomingVideoStrategyType=e.incomingVideoStrategyType||sb.Type.AllowAll;i.formatRecordDate=e.formatRecordDate||"d.m.Y";i.messengerFacade=e.messengerFacade;i.inited=false;i.debug=false;i.container=null;i.docEditor=null;i.docEditorIframe=null;i.maxEditorWidth=Tb;i.docCreatedForCurrentCall=false;i.folded=false;i.localStream=null;i.audioRingtone=l.SoundType.ringtoneModern;i.lastUsedCameraId=null;i.reconnectingCameraId=null;i.childCall=null;i.invitePopup=null;i.videoStrategy=null;i.isHttps=window.location.protocol==="https:";i.callWithLegacyMobile=false;i.featureScreenSharing=wb.Enabled;i.screenShareStartTime=null;i.commonRecord=Cb(babelHelpers.assertThisInitialized(i),Jb,TC).call(babelHelpers.assertThisInitialized(i));i.autoCloseCallView=true;i.talkingUsers={};i.promotedToAdminTimeoutValue=10*1e3;i.promotedToAdminTimeout=null;i.clickLinkInterceptor=null;i._callViewState=yb.Closed;i.answeredOrDeclinedCalls=new Set;i._onCallUserInvitedHandler=i._onCallUserInvited.bind(babelHelpers.assertThisInitialized(i));i._onCallUserJoinedHandler=i._onCallUserJoined.bind(babelHelpers.assertThisInitialized(i));i._onCallDestroyHandler=i._onCallDestroy.bind(babelHelpers.assertThisInitialized(i));i._onCallUserStateChangedHandler=i._onCallUserStateChanged.bind(babelHelpers.assertThisInitialized(i));i._onCallUserMicrophoneStateHandler=i._onCallUserMicrophoneState.bind(babelHelpers.assertThisInitialized(i));i._onCallUserCameraStateHandler=i._onCallUserCameraState.bind(babelHelpers.assertThisInitialized(i));i._onNeedResetMediaDevicesStateHandler=i._onNeedResetMediaDevicesState.bind(babelHelpers.assertThisInitialized(i));i._onCameraPublishingHandler=i._onCameraPublishing.bind(babelHelpers.assertThisInitialized(i));i._onMicrophonePublishingdHandler=i._onMicrophonePublishingd.bind(babelHelpers.assertThisInitialized(i));i._onCallUserVideoPausedHandler=i._onCallUserVideoPaused.bind(babelHelpers.assertThisInitialized(i));i._onCallLocalMediaReceivedHandler=i._onCallLocalMediaReceived.bind(babelHelpers.assertThisInitialized(i));i._onCallLocalMediaStoppedHandler=i._onCallLocalMediaStopped.bind(babelHelpers.assertThisInitialized(i));i._onCallLocalScreenUpdatedHandler=i._onCallLocalScreenUpdated.bind(babelHelpers.assertThisInitialized(i));i._onCallLocalCameraFlipHandler=i._onCallLocalCameraFlip.bind(babelHelpers.assertThisInitialized(i));i._onCallLocalCameraFlipInDesktopHandler=i._onCallLocalCameraFlipInDesktop.bind(babelHelpers.assertThisInitialized(i));i._onCallRemoteMediaReceivedHandler=i._onCallRemoteMediaReceived.bind(babelHelpers.assertThisInitialized(i));i._onCallRemoteMediaStoppedHandler=i._onCallRemoteMediaStopped.bind(babelHelpers.assertThisInitialized(i));i._onCallBadNetworkIndicatorHandler=i._onCallBadNetworkIndicator.bind(babelHelpers.assertThisInitialized(i));i._onCallConnectionQualityChangedHandler=i._onCallConnectionQualityChanged.bind(babelHelpers.assertThisInitialized(i));i._onCallToggleRemoteParticipantVideoHandler=i._onCallToggleRemoteParticipantVideo.bind(babelHelpers.assertThisInitialized(i));i._onCallUserVoiceStartedHandler=i._onCallUserVoiceStarted.bind(babelHelpers.assertThisInitialized(i));i._onCallUserVoiceStoppedHandler=i._onCallUserVoiceStopped.bind(babelHelpers.assertThisInitialized(i));i._onAllParticipantsAudioMutedHandler=i._onAllParticipantsAudioMuted.bind(babelHelpers.assertThisInitialized(i));i._onAllParticipantsVideoMutedHandler=i._onAllParticipantsVideoMuted.bind(babelHelpers.assertThisInitialized(i));i._onTurnOnCameraHandler=i._onTurnOnCamera.bind(babelHelpers.assertThisInitialized(i));i._onAllParticipantsScreenshareHandler=i._onAllParticipantsScreenshareMuted.bind(babelHelpers.assertThisInitialized(i));i._onYouMuteAllParticipantsHandler=i._onYouMuteAllParticipants.bind(babelHelpers.assertThisInitialized(i));i._onRoomSettingsChangedHandler=i._onRoomSettingsChanged.bind(babelHelpers.assertThisInitialized(i));i._onUserPermissionsChangedHandler=i._onUserPermissionsChanged.bind(babelHelpers.assertThisInitialized(i));i._onUserRoleChangedHandler=i._onUserRoleChanged.bind(babelHelpers.assertThisInitialized(i));i._onParticipantMutedHandler=i._onParticipantMuted.bind(babelHelpers.assertThisInitialized(i));i._onUserStatsReceivedHandler=i._onUserStatsReceived.bind(babelHelpers.assertThisInitialized(i));i._onTrackSubscriptionFailedHandler=i._onTrackSubscriptionFailed.bind(babelHelpers.assertThisInitialized(i));i._onCallUserScreenStateHandler=i._onCallUserScreenState.bind(babelHelpers.assertThisInitialized(i));babelHelpers.classPrivateFieldSet(babelHelpers.assertThisInitialized(i),Nb,Cb(babelHelpers.assertThisInitialized(i),dC,FC).bind(babelHelpers.assertThisInitialized(i)));babelHelpers.classPrivateFieldSet(babelHelpers.assertThisInitialized(i),xb,Cb(babelHelpers.assertThisInitialized(i),rC,HC).bind(babelHelpers.assertThisInitialized(i)));i.onCallUserFloorRequestHandler=i._onCallUserFloorRequest.bind(babelHelpers.assertThisInitialized(i));i._onCallFailureHandler=i._onCallFailure.bind(babelHelpers.assertThisInitialized(i));i._onNetworkProblemHandler=i._onNetworkProblem.bind(babelHelpers.assertThisInitialized(i));i._onMicrophoneLevelHandler=i._onMicrophoneLevel.bind(babelHelpers.assertThisInitialized(i));i._onReconnectingHandler=i._onReconnecting.bind(babelHelpers.assertThisInitialized(i));i._onReconnectedHandler=i._onReconnected.bind(babelHelpers.assertThisInitialized(i));i._onReconnectingFailedHandler=i._onReconnectingFailed.bind(babelHelpers.assertThisInitialized(i));i._onCustomMessageHandler=i._onCustomMessage.bind(babelHelpers.assertThisInitialized(i));i._onJoinRoomOfferHandler=i._onJoinRoomOffer.bind(babelHelpers.assertThisInitialized(i));i._onJoinRoomHandler=i._onJoinRoom.bind(babelHelpers.assertThisInitialized(i));i._onLeaveRoomHandler=i._onLeaveRoom.bind(babelHelpers.assertThisInitialized(i));i._onTransferRoomSpeakerHandler=i._onTransferRoomSpeaker.bind(babelHelpers.assertThisInitialized(i));i._onCallLeaveHandler=i._onCallLeave.bind(babelHelpers.assertThisInitialized(i));i._onCallJoinHandler=i._onCallJoin.bind(babelHelpers.assertThisInitialized(i));i._onGetUserMediaEndedHandler=Cb(babelHelpers.assertThisInitialized(i),hC,VC).bind(babelHelpers.assertThisInitialized(i));i._onUpdateLastUsedCameraIdHandler=i._onUpdateLastUsedCameraId.bind(babelHelpers.assertThisInitialized(i));babelHelpers.classPrivateFieldSet(babelHelpers.assertThisInitialized(i),Ob,Cb(babelHelpers.assertThisInitialized(i),aC,BC).bind(babelHelpers.assertThisInitialized(i)));babelHelpers.classPrivateFieldSet(babelHelpers.assertThisInitialized(i),Ub,Cb(babelHelpers.assertThisInitialized(i),sC,DC).bind(babelHelpers.assertThisInitialized(i)));i._onBeforeUnloadHandler=i._onBeforeUnload.bind(babelHelpers.assertThisInitialized(i));i._onImTabChangeHandler=i._onImTabChange.bind(babelHelpers.assertThisInitialized(i));i._onUpdateChatCounterHandler=i._onUpdateChatCounter.bind(babelHelpers.assertThisInitialized(i));i._onChildCallFirstMediaHandler=Cb(babelHelpers.assertThisInitialized(i),Vb,mC).bind(babelHelpers.assertThisInitialized(i));i._onChildCallFirstUserJoinedHandler=Cb(babelHelpers.assertThisInitialized(i),Gb,gC).bind(babelHelpers.assertThisInitialized(i));i._onWindowFocusHandler=i._onWindowFocus.bind(babelHelpers.assertThisInitialized(i));i._onWindowBlurHandler=i._onWindowBlur.bind(babelHelpers.assertThisInitialized(i));i._onDocumentBodyClickHandler=i._onDocumentBodyClick.bind(babelHelpers.assertThisInitialized(i));if(r.DesktopApi.isDesktop()&&false){i.floatingWindow=new FloatingVideo({onMainAreaClick:i._onFloatingVideoMainAreaClick.bind(babelHelpers.assertThisInitialized(i)),onButtonClick:i._onFloatingVideoButtonClick.bind(babelHelpers.assertThisInitialized(i))});i.floatingWindowUser=0}i.showFloatingWindowTimeout=0;i.hideIncomingCallTimeout=0;i.ignoreDeclinedCallsTimeout={};i.ignoreIncomingNotificationTimeouts={};if(r.DesktopApi.isDesktop()){i.floatingScreenShareWindow=new Hm({darkMode:i.messengerFacade.isThemeDark(),onBackToCallClick:i._onFloatingScreenShareBackToCallClick.bind(babelHelpers.assertThisInitialized(i)),onStopSharingClick:i._onFloatingScreenShareStopClick.bind(babelHelpers.assertThisInitialized(i)),onChangeScreenClick:i._onFloatingScreenShareChangeScreenClick.bind(babelHelpers.assertThisInitialized(i))})}i.showFloatingScreenShareWindowTimeout=0;i.mutePopup=null;i.riseYouHandToTalkPopup=null;i.allowMutePopup=true;i.webScreenSharePopup=null;i.feedbackPopup=null;i.resizeObserver=new BX.ResizeObserver(i._onResize.bind(babelHelpers.assertThisInitialized(i)));i.loopTimers={};i.lastCalledChangeSettingsUserName=BX.message("CALL_DEFAULT_NAME_OF_MODERATOR");i.isFileChooserActive=false;i.pictureInPictureDebounceForOpen=null;i.isWindowFocus=true;i.isCallHangupButtonPressed=false;i.callMultiBroadcastClient=null;if(n){i.init();Cb(babelHelpers.assertThisInitialized(i),Fb,fC).call(babelHelpers.assertThisInitialized(i),e)}return i}babelHelpers.createClass(t,[{key:"init",value:function e(){var t=this;BX.addCustomEvent(window,"CallEvents::incomingCall",this.onIncomingCall.bind(this));H.subscribe(H.Events.deviceChanged,this._onDeviceChange.bind(this));H.subscribe(H.Events.onChangeMirroringVideo,this._onCallLocalCameraFlipHandler);window.addEventListener("blur",this._onWindowBlurHandler);window.addEventListener("focus",this._onWindowFocusHandler);document.body.addEventListener("click",this._onDocumentBodyClickHandler);if(r.DesktopApi.isDesktop()&&this.floatingWindow){window.addEventListener("blur",this._onWindowBlurHandler);window.addEventListener("focus",this._onWindowFocusHandler);r.DesktopApi.subscribe("BXForegroundChanged",(function(e){if(e){t._onWindowDesktopFocus()}else{t._onWindowDesktopBlur()}}))}if(r.DesktopApi.isDesktop()&&this.floatingScreenShareWindow){r.DesktopApi.subscribe("BXScreenMediaSharing",(function(e,i,n,a,s,r,o){t.floatingScreenShareWindow.close();t.floatingScreenShareWindow.setSharingData({title:i,x:n,y:a,width:s,height:r,app:o}).then((function(){t.floatingScreenShareWindow.show()}))["catch"]((function(e){console.error("setSharingData error",e)}))}));window.addEventListener("blur",this._onWindowBlurHandler);window.addEventListener("focus",this._onWindowFocusHandler);r.DesktopApi.subscribe("BXForegroundChanged",(function(e){if(e){t._onWindowDesktopFocus()}else{t._onWindowDesktopBlur()}}))}if(r.DesktopApi.isDesktop()){r.DesktopApi.subscribe(H.Events.onChangeMirroringVideo,this._onCallLocalCameraFlipInDesktopHandler)}if(r.DesktopApi.isDesktop()){r.DesktopApi.subscribe("BXVpnStatusChange",(function(e){if(e){t.showVpnIsActiveNotification()}}))}if(window["VoxImplant"]){VoxImplant.getInstance().addEventListener(VoxImplant.Events.MicAccessResult,this.voxMicAccessResult.bind(this))}window.addEventListener("beforeunload",this._onBeforeUnloadHandler);BX.addCustomEvent("OnDesktopTabChange",this._onImTabChangeHandler);BX.addCustomEvent(window,"onImUpdateCounterMessage",this._onUpdateChatCounter.bind(this));BX.garbage(this.destroy,this);if(r.DesktopApi.isDesktop()){this.callMultiBroadcastClient=new pc("call_controller_multi_channel");this.callMultiBroadcastClient.executer((function(e){var i;var n=(i=t.currentCall)===null||i===void 0?void 0:i.uuid;var a=Boolean(t.callView);var s=n===e&&a;if(s){BXDesktopSystem.SetActiveTab()}return s}))}tu.multiBroadcastClient.executer((function(){return Boolean(t.callView)}));this.inited=true}},{key:"voxMicAccessResult",value:function e(t){if(t.stream&&t.stream.getAudioTracks().length>0&&this.callView){this.callView.microphoneId=t.stream.getAudioTracks()[0].getSettings().deviceId}}},{key:"getCallType",value:function e(){var t;var i=arguments.length>0&&arguments[0]!==undefined?arguments[0]:"";var n=i||((t=this.currentCall)===null||t===void 0?void 0:t.provider);if(!n){return}return n===Tc.Plain?h.Analytics.AnalyticsType["private"]:h.Analytics.AnalyticsType.group}},{key:"getCallUsers",value:function e(t){var i=Object.keys(this.currentCall.getUsers());if(t){i.push(this.currentCall.userId)}return i}},{key:"getActiveCallUsers",value:function e(){var t=this.currentCall.getUsers();var i=[];for(var n in t){if(t.hasOwnProperty(n)){if(t[n]===yc.Connected||t[n]===yc.Connecting||t[n]===yc.Calling){i.push(n)}}}return i}},{key:"getMaxActiveCallUsers",value:function e(){var t=this.currentCall.getUsers();var i=[];for(var n in t){if(t.hasOwnProperty(n)){if(t[n]!==yc.Declined&&t[n]!==yc.Busy&&t[n]!==yc.Unavailable){i.push(n)}}}return i}},{key:"updateFloatingWindowContent",value:function e(){var t=this;if(!this.floatingWindow||!this.currentCall){return}this.floatingWindow.setTitle(this.currentCall.associatedEntity.name);Yf.getUserAvatars(this.currentCall.id,this.getActiveCallUsers()).then((function(e){t.floatingWindow.setAvatars(e)}))}},{key:"updateDeviceIdInChildCall",value:function e(){if(!this.childCall||!this.currentCall){return}if(this.currentCall.microphoneId){this.childCall.setMicrophoneId(this.currentCall.microphoneId)}if(this.currentCall.cameraId){this.childCall.setCameraId(this.currentCall.cameraId)}}},{key:"onIncomingCall",value:function e(t){var i=this;console.warn("incoming.call",t);var n=t.call;var a=this.currentCall&&(this.callView||this.callNotification);this.callWithLegacyMobile=t.isLegacyMobile===true;var s=this._getCallIdentifier(n);var r=this._getCallIdentifier(this.currentCall);if(!a){if(n.initiatorId==this.userId||Jp.calls[n.parentId]){return}if(this.ignoreDeclinedCallsTimeout[s]){clearTimeout(this.ignoreDeclinedCallsTimeout[s]);this.ignoreDeclinedCallsTimeout[s]=setTimeout((function(){return i.answeredOrDeclinedCalls["delete"](s)}),15e3)}if(this.callView||this.answeredOrDeclinedCalls.has(s)||window.BXShowedIncomingCallNotification===s){return}this.checkDesktop().then((function(){i.prepareIncomingCall(t)}),(function(e){if(i.currentCall){i.removeVideoStrategy();i.removeCallEvents();i.currentCall=null}if(i.promotedToAdminTimeout){clearTimeout(i.promotedToAdminTimeout)}console.error(e);i.log(e);if(!i.isHttps){i.showNotification(BX.message("IM_CALL_INCOMING_ERROR_HTTPS_REQUIRED"))}else{i.showNotification(BX.message("IM_CALL_INCOMING_UNSUPPORTED_BROWSER"))}}))}else{if(s===r);else if(n.parentUuid===this.currentCall.uuid||this.currentCall.id&&n.parentId===this.currentCall.id){var o;if(this.currentCall.isScreenSharingStarted()){this.currentCall.stopScreenSharing()}if(!this.childCall){this.childCall=n}this.callView.removeScreenUsers();if(this.isLegacyCall(this.childCall.provider,this.childCall.scheme)){this.childCall.users.forEach((function(e){return i.callView.addUser(e,yc.Calling)}));this.updateCallViewUsers(n.id,this.childCall.users)}this.callView.updateCopilotFeatureState((o=this.childCall)===null||o===void 0?void 0:o.isCopilotFeaturesEnabled);this.updateDeviceIdInChildCall();this.answerChildCall()}else{n.decline(486);var l=n.associatedEntity.type==="chat"&&n.associatedEntity.advanced["chatType"]==="videoconf";var c=n.provider===Tc.Plain?h.Analytics.AnalyticsType["private"]:h.Analytics.AnalyticsType.group;h.Analytics.getInstance().onJoinCall({callId:s,callType:l?h.Analytics.AnalyticsType.videoconf:c,status:h.Analytics.AnalyticsStatus.busy,associatedEntity:n.associatedEntity});return false}}}},{key:"prepareIncomingCall",value:function e(t){var i=this;var n=t.call;var a=this._getCallIdentifier(n);H.init();if(this.currentCall||n.state==kc.Finished){return}this.currentCall=n;if(!(this.currentCall instanceof ju)){var s=BX.Messenger.v2.Lib.CallManager.getInstance().getCurrentUser();Yf.setUserData(babelHelpers.defineProperty({},this.userId,s))}this.bindCallEvents();this.updateFloatingWindowContent();window.BXShowedIncomingCallNotification=a;this.ignoreIncomingNotificationTimeouts[a]=setTimeout((function(){return window.BXShowedIncomingCallNotification=null}),1e4);if(this.currentCall.associatedEntity.type==="chat"&&this.currentCall.associatedEntity.advanced["chatType"]==="videoconf"){if(this.isConferencePageOpened(this.currentCall.associatedEntity.id)){this.removeCallEvents();this.currentCall=null}else{this.showIncomingConference()}}else{var r=t.video===true;this.showIncomingCall({video:r});H.init().then((function(){if(!H.hasCamera()){if(r){i.showNotification(BX.message("IM_CALL_ERROR_NO_CAMERA"))}if(i.callNotification){i.callNotification.setHasCamera(false)}}}))}}},{key:"bindCallEvents",value:function e(){this.currentCall.addEventListener(Ac.onUserInvited,this._onCallUserInvitedHandler);this.currentCall.addEventListener(Ac.onUserJoined,this._onCallUserJoinedHandler);this.currentCall.addEventListener(Ac.onDestroy,this._onCallDestroyHandler);this.currentCall.addEventListener(Ac.onUserStateChanged,this._onCallUserStateChangedHandler);this.currentCall.addEventListener(Ac.onUserMicrophoneState,this._onCallUserMicrophoneStateHandler);this.currentCall.addEventListener(Ac.onUserCameraState,this._onCallUserCameraStateHandler);this.currentCall.addEventListener(Ac.onNeedResetMediaDevicesState,this._onNeedResetMediaDevicesStateHandler);this.currentCall.addEventListener(Ac.onCameraPublishing,this._onCameraPublishingHandler);this.currentCall.addEventListener(Ac.onMicrophonePublishing,this._onMicrophonePublishingdHandler);this.currentCall.addEventListener(Ac.onUserVideoPaused,this._onCallUserVideoPausedHandler);this.currentCall.addEventListener(Ac.onUserScreenState,this._onCallUserScreenStateHandler);p.Event.bind(this.currentCall,Ac.onUserCommonRecordState,babelHelpers.classPrivateFieldGet(this,Nb));p.Event.bind(this.currentCall,Ac.onCloudRecordStatusChanged,babelHelpers.classPrivateFieldGet(this,xb));this.currentCall.addEventListener(Ac.onUserFloorRequest,this.onCallUserFloorRequestHandler);this.currentCall.addEventListener(Ac.onLocalMediaReceived,this._onCallLocalMediaReceivedHandler);this.currentCall.addEventListener(Ac.onLocalMediaStopped,this._onCallLocalMediaStoppedHandler);this.currentCall.addEventListener(Ac.onLocalScreenUpdated,this._onCallLocalScreenUpdatedHandler);this.currentCall.addEventListener(Ac.onRemoteMediaReceived,this._onCallRemoteMediaReceivedHandler);this.currentCall.addEventListener(Ac.onRemoteMediaStopped,this._onCallRemoteMediaStoppedHandler);this.currentCall.addEventListener(Ac.onBadNetworkIndicator,this._onCallBadNetworkIndicatorHandler);this.currentCall.addEventListener(Ac.onConnectionQualityChanged,this._onCallConnectionQualityChangedHandler);this.currentCall.addEventListener(Ac.onToggleRemoteParticipantVideo,this._onCallToggleRemoteParticipantVideoHandler);this.currentCall.addEventListener(Ac.onUserVoiceStarted,this._onCallUserVoiceStartedHandler);this.currentCall.addEventListener(Ac.onUserVoiceStopped,this._onCallUserVoiceStoppedHandler);this.currentCall.addEventListener(Ac.onTurnOnCamera,this._onTurnOnCameraHandler);this.currentCall.addEventListener(Ac.onAllParticipantsAudioMuted,this._onAllParticipantsAudioMutedHandler);this.currentCall.addEventListener(Ac.onAllParticipantsVideoMuted,this._onAllParticipantsVideoMutedHandler);this.currentCall.addEventListener(Ac.onAllParticipantsScreenshareMuted,this._onAllParticipantsScreenshareHandler);this.currentCall.addEventListener(Ac.onRoomSettingsChanged,this._onRoomSettingsChangedHandler);this.currentCall.addEventListener(Ac.onUserPermissionsChanged,this._onUserPermissionsChangedHandler);this.currentCall.addEventListener(Ac.onUserRoleChanged,this._onUserRoleChangedHandler);this.currentCall.addEventListener(Ac.onYouMuteAllParticipants,this._onYouMuteAllParticipantsHandler);this.currentCall.addEventListener(Ac.onParticipantMuted,this._onParticipantMutedHandler);this.currentCall.addEventListener(Ac.onUserStatsReceived,this._onUserStatsReceivedHandler);this.currentCall.addEventListener(Ac.onTrackSubscriptionFailed,this._onTrackSubscriptionFailedHandler);this.currentCall.addEventListener(Ac.onCallFailure,this._onCallFailureHandler);this.currentCall.addEventListener(Ac.onNetworkProblem,this._onNetworkProblemHandler);this.currentCall.addEventListener(Ac.onMicrophoneLevel,this._onMicrophoneLevelHandler);this.currentCall.addEventListener(Ac.onReconnecting,this._onReconnectingHandler);this.currentCall.addEventListener(Ac.onReconnected,this._onReconnectedHandler);this.currentCall.addEventListener(Ac.onReconnectingFailed,this._onReconnectingFailedHandler);this.currentCall.addEventListener(Ac.onCustomMessage,this._onCustomMessageHandler);this.currentCall.addEventListener(Ac.onJoinRoomOffer,this._onJoinRoomOfferHandler);this.currentCall.addEventListener(Ac.onJoinRoom,this._onJoinRoomHandler);this.currentCall.addEventListener(Ac.onLeaveRoom,this._onLeaveRoomHandler);this.currentCall.addEventListener(Ac.onTransferRoomSpeaker,this._onTransferRoomSpeakerHandler);this.currentCall.addEventListener(Ac.onJoin,this._onCallJoinHandler);this.currentCall.addEventListener(Ac.onLeave,this._onCallLeaveHandler);this.currentCall.addEventListener(Ac.onGetUserMediaEnded,this._onGetUserMediaEndedHandler);this.currentCall.addEventListener(Ac.onUpdateLastUsedCameraId,this._onUpdateLastUsedCameraIdHandler);p.Event.bind(this.currentCall,Ac.onSwitchTrackRecordStatus,babelHelpers.classPrivateFieldGet(this,Ob));p.Event.bind(this.currentCall,Ac.onRecorderStatusChanged,babelHelpers.classPrivateFieldGet(this,Ub))}},{key:"removeCallEvents",value:function e(){this.currentCall.removeEventListener(Ac.onUserInvited,this._onCallUserInvitedHandler);this.currentCall.removeEventListener(Ac.onUserJoined,this._onCallUserJoinedHandler);this.currentCall.removeEventListener(Ac.onDestroy,this._onCallDestroyHandler);this.currentCall.removeEventListener(Ac.onUserStateChanged,this._onCallUserStateChangedHandler);this.currentCall.removeEventListener(Ac.onUserMicrophoneState,this._onCallUserMicrophoneStateHandler);this.currentCall.removeEventListener(Ac.onUserCameraState,this._onCallUserCameraStateHandler);this.currentCall.removeEventListener(Ac.onNeedResetMediaDevicesState,this._onNeedResetMediaDevicesStateHandler);this.currentCall.removeEventListener(Ac.onCameraPublishing,this._onCameraPublishingHandler);this.currentCall.removeEventListener(Ac.onMicrophonePublishing,this._onMicrophonePublishingdHandler);this.currentCall.removeEventListener(Ac.onUserVideoPaused,this._onCallUserVideoPausedHandler);this.currentCall.removeEventListener(Ac.onUserScreenState,this._onCallUserScreenStateHandler);p.Event.unbind(this.currentCall,Ac.onUserCommonRecordState,babelHelpers.classPrivateFieldGet(this,Nb));p.Event.unbind(this.currentCall,Ac.onCloudRecordStatusChanged,babelHelpers.classPrivateFieldGet(this,xb));this.currentCall.removeEventListener(Ac.onUserFloorRequest,this.onCallUserFloorRequestHandler);this.currentCall.removeEventListener(Ac.onLocalMediaReceived,this._onCallLocalMediaReceivedHandler);this.currentCall.removeEventListener(Ac.onLocalMediaStopped,this._onCallLocalMediaStoppedHandler);this.currentCall.removeEventListener(Ac.onLocalScreenUpdated,this._onCallLocalScreenUpdatedHandler);this.currentCall.removeEventListener(Ac.onRemoteMediaReceived,this._onCallRemoteMediaReceivedHandler);this.currentCall.removeEventListener(Ac.onRemoteMediaStopped,this._onCallRemoteMediaStoppedHandler);this.currentCall.removeEventListener(Ac.onBadNetworkIndicator,this._onCallBadNetworkIndicatorHandler);this.currentCall.removeEventListener(Ac.onConnectionQualityChanged,this._onCallConnectionQualityChangedHandler);this.currentCall.removeEventListener(Ac.onToggleRemoteParticipantVideo,this._onCallToggleRemoteParticipantVideoHandler);this.currentCall.removeEventListener(Ac.onUserVoiceStarted,this._onCallUserVoiceStartedHandler);this.currentCall.removeEventListener(Ac.onUserVoiceStopped,this._onCallUserVoiceStoppedHandler);this.currentCall.removeEventListener(Ac.onTurnOnCamera,this._onTurnOnCameraHandler);this.currentCall.removeEventListener(Ac.onAllParticipantsAudioMuted,this._onAllParticipantsAudioMutedHandler);this.currentCall.removeEventListener(Ac.onAllParticipantsVideoMuted,this._onAllParticipantsVideoMutedHandler);this.currentCall.removeEventListener(Ac.onAllParticipantsScreenshareMuted,this._onAllParticipantsScreenshareMutedHandler);this.currentCall.removeEventListener(Ac.onRoomSettingsChanged,this._onRoomSettingsChangedHandler);this.currentCall.removeEventListener(Ac.onUserPermissionsChanged,this._onUserPermissionsChangedHandler);this.currentCall.removeEventListener(Ac.onUserRoleChanged,this._onUserRoleChangedHandler);this.currentCall.removeEventListener(Ac.onYouMuteAllParticipants,this._onYouMuteAllParticipantsHandler);this.currentCall.removeEventListener(Ac.onParticipantMuted,this._onParticipantMutedHandler);this.currentCall.removeEventListener(Ac.onUserStatsReceived,this._onUserStatsReceivedHandler);this.currentCall.removeEventListener(Ac.onTrackSubscriptionFailed,this._onTrackSubscriptionFailedHandler);this.currentCall.removeEventListener(Ac.onCallFailure,this._onCallFailureHandler);this.currentCall.removeEventListener(Ac.onNetworkProblem,this._onNetworkProblemHandler);this.currentCall.removeEventListener(Ac.onMicrophoneLevel,this._onMicrophoneLevelHandler);this.currentCall.removeEventListener(Ac.onReconnecting,this._onReconnectingHandler);this.currentCall.removeEventListener(Ac.onReconnected,this._onReconnectedHandler);this.currentCall.removeEventListener(Ac.onReconnectingFailed,this._onReconnectingFailedHandler);this.currentCall.removeEventListener(Ac.onCustomMessage,this._onCustomMessageHandler);this.currentCall.removeEventListener(Ac.onJoin,this._onCallJoinHandler);this.currentCall.removeEventListener(Ac.onLeave,this._onCallLeaveHandler);this.currentCall.removeEventListener(Ac.onGetUserMediaEnded,this._onGetUserMediaEndedHandler);this.currentCall.removeEventListener(Ac.onUpdateLastUsedCameraId,this._onUpdateLastUsedCameraIdHandler);p.Event.unbind(this.currentCall,Ac.onSwitchTrackRecordStatus,babelHelpers.classPrivateFieldGet(this,Ob));p.Event.unbind(this.currentCall,Ac.onRecorderStatusChanged,babelHelpers.classPrivateFieldGet(this,Ub))}},{key:"bindCallViewEvents",value:function e(){this.callView.setCallback(es.Event.onShow,this._onCallViewShow.bind(this));this.callView.setCallback(es.Event.onClose,this._onCallViewClose.bind(this));this.callView.setCallback(es.Event.onDestroy,this._onCallViewDestroy.bind(this));this.callView.setCallback(es.Event.onButtonClick,this._onCallViewButtonClick.bind(this));this.callView.setCallback(es.Event.onBodyClick,this._onCallViewBodyClick.bind(this));this.callView.setCallback(es.Event.onReplaceCamera,this._onCallViewReplaceCamera.bind(this));this.callView.setCallback(es.Event.onReplaceMicrophone,this._onCallViewReplaceMicrophone.bind(this));this.callView.setCallback(es.Event.onSetCentralUser,this._onCallViewSetCentralUser.bind(this));this.callView.setCallback(es.Event.onChangeHdVideo,this._onCallViewChangeHdVideo.bind(this));this.callView.setCallback(es.Event.onChangeMicAutoParams,this._onCallViewChangeMicAutoParams.bind(this));this.callView.setCallback(es.Event.onChangeFaceImprove,this._onCallViewChangeFaceImprove.bind(this));this.callView.setCallback(es.Event.onOpenAdvancedSettings,this._onCallViewOpenAdvancedSettings.bind(this));this.callView.setCallback(es.Event.onReplaceSpeaker,this._onCallViewReplaceSpeaker.bind(this));this.callView.setCallback(es.Event.onHasMainStream,this._onCallViewHasMainStream.bind(this));this.callView.setCallback(es.Event.onTurnOffParticipantMic,this._onCallViewTurnOffParticipantMic.bind(this));this.callView.setCallback(es.Event.onTurnOffParticipantCam,this._onCallViewTurnOffParticipantCam.bind(this));this.callView.setCallback(es.Event.onTurnOffParticipantScreenshare,this._onCallViewTurnOffParticipantScreenshare.bind(this));this.callView.setCallback(es.Event.onAllowSpeakPermission,this._onCallViewAllowSpeakPermission.bind(this));this.callView.setCallback(es.Event.onDisallowSpeakPermission,this._onCallViewDisallowSpeakPermission.bind(this));this.callView.setCallback(es.Event.onToggleSubscribe,this._onCallToggleSubscribe.bind(this));this.callView.setCallback(es.Event.onUserClick,this._onCallUserClick.bind(this));this.callView.setCallback(es.Event.onPiPClose,this._onPipClose.bind(this));this.callView.setCallback(es.Event.onCommonRecordMenu,Cb(this,eC,RC).bind(this));this.callView.setCallback(es.Event.onPiPBodyClick,Cb(this,$b,EC).bind(this));this.callView.setCallback(es.Event.onChangeVideoQuality,this._onChangeVideoQuality.bind(this))}},{key:"updateCallViewUsers",value:function e(t,i){var n=this;if(!this.callView){return}var a=function e(t){return Array.from(t,(function(e){return parseFloat(e)}))};var s=a(i);var r=[];var o=[];if(this.currentCall.userData){this.callView.updateUserData(this.currentCall.userData);r=a(Object.keys(this.currentCall.userData));o=s.filter((function(e){return r.indexOf(e)===-1}))}if(this.currentCall.userData&&!o.length){return}Yf.getUsers(t,s).then((function(e){n.callView.updateUserData(e)}))}},{key:"createVideoStrategy",value:function e(){if(this.videoStrategy){this.videoStrategy.destroy()}var t=this.incomingVideoStrategyType;this.videoStrategy=new sb({call:this.currentCall,callView:this.callView,strategyType:t})}},{key:"removeVideoStrategy",value:function e(){if(this.videoStrategy){this.videoStrategy.destroy()}this.videoStrategy=null}},{key:"setFeatureScreenSharing",value:function e(t){this.featureScreenSharing=t}},{key:"setVideoStrategyType",value:function e(t){if(this.videoStrategy){this.videoStrategy.setType(t)}}},{key:"getExternalContainer",value:function e(){var t=document.querySelector(".".concat(BX.Messenger.v2.Lib.CallManager.viewContainerClass));if(!t){t=BX.create("div",{props:{className:BX.Messenger.v2.Lib.CallManager.viewContainerClass}});document.body.appendChild(t)}return t}},{key:"createContainer",value:function e(){this.container=BX.create("div",{props:{className:"bx-messenger-call-overlay ".concat(Yf.isChatMountInPage()?"--fixed":"")}});var t=this.getExternalContainer();t.insertBefore(this.container,t.firstChild);p.ZIndexManager.getOrAddStack(document.body).register(this.container);t.classList.add("bx-messenger-call")}},{key:"removeContainer",value:function e(){if(this.container){p.ZIndexManager.getStack(document.body).unregister(this.container);p.Dom.remove(this.container);this.container=null;this.getExternalContainer().classList.remove("bx-messenger-call")}}},{key:"answerChildCall",value:function e(){this.removeCallEvents();this.removeVideoStrategy();this.childCall.addEventListener(Ac.onUserJoined,this._onChildCallFirstUserJoinedHandler);this.childCall.addEventListener(Ac.onRemoteMediaReceived,this._onChildCallFirstMediaHandler);this.childCall.addEventListener(Ac.onLocalMediaReceived,this._onCallLocalMediaReceivedHandler);this.childCall.answer()}},{key:"setReconnectingCameraId",value:function e(t){this.reconnectingCameraId=t;if(t){this.updateCameraSettingsInCurrentCallAfterReconnecting(t)}}},{key:"updateCameraSettingsInCurrentCallAfterReconnecting",value:function e(t){if(this.currentCall.cameraId===t){return}var i=H.getCameraList();if(!i.find((function(e){return e.deviceId===t}))){return}this.currentCall.setCameraId(t);this.setReconnectingCameraId(null)}},{key:"checkDesktop",value:function e(){if(p.Reflection.getClass("BX.Messenger.v2.Lib.DesktopManager")){return new Promise((function(e){var t=BX.Messenger.v2.Lib.DesktopManager.getInstance();t.checkStatusInDifferentContext().then((function(t){if(t===false){e()}}))}))}if(p.Reflection.getClass("BX.desktopUtils")){return new Promise((function(e){BX.desktopUtils.runningCheck((function(){}),(function(){return e()}))}))}return Promise.resolve()}},{key:"isMutedPopupAllowed",value:function e(){if(!this.allowMutePopup||!this.currentCall){return false}var t=this.currentCall.currentRoom&&this.currentCall.currentRoom();return!t||t.speaker==this.userId}},{key:"isConferencePageOpened",value:function e(t){var i=w.LocalStorage.get(tu.getSiteId(),tu.getCurrentUserId(),tu.getConferencePageTag(t),"N");return i==="Y"}},{key:"showIncomingCall",value:function e(t){if(!p.Type.isPlainObject(t)){t={}}t.video=t.video===true;if(this.feedbackPopup){this.feedbackPopup.close()}var i=this.callWithLegacyMobile?t.video===true:true;this.callNotification=new lm({callerName:this.currentCall.associatedEntity.name,callerAvatar:this.currentCall.associatedEntity.avatar,callerType:this.currentCall.associatedEntity.advanced.chatType,callerColor:this.currentCall.associatedEntity.avatarColor,video:t.video,hasCamera:i,cameraState:i,microphoneState:!(this.currentCall.associatedEntity.userCounter>this.getMaxActiveMicrophonesCount()),zIndex:this.messengerFacade.getDefaultZIndex()+200,onClose:this._onCallNotificationClose.bind(this),onDestroy:this._onCallNotificationDestroy.bind(this),onButtonClick:this._onCallNotificationButtonClick.bind(this),isMessengerOpen:this.messengerFacade.isMessengerOpen()});this.callNotification.show();this.scheduleCancelNotification(false);this.messengerFacade.repeatSound(this.audioRingtone,3500,true)}},{key:"showIncomingConference",value:function e(){this.callNotification=new Em({zIndex:this.messengerFacade.getDefaultZIndex()+200,callerName:this.currentCall.associatedEntity.name,callerAvatar:this.currentCall.associatedEntity.avatar,callerColor:this.currentCall.associatedEntity.avatarColor,onClose:this._onCallNotificationClose.bind(this),onDestroy:this._onCallNotificationDestroy.bind(this),onButtonClick:this._onCallConferenceNotificationButtonClick.bind(this)});this.callNotification.show();this.scheduleCancelNotification(true);this.messengerFacade.repeatSound(this.audioRingtone,3500,true)}},{key:"scheduleCancelNotification",value:function e(){var t=this;var i=arguments.length>0&&arguments[0]!==undefined?arguments[0]:false;clearTimeout(this.hideIncomingCallTimeout);this.hideIncomingCallTimeout=setTimeout((function(){h.Analytics.getInstance().onJoinCall({callId:t._getCallIdentifier(t.currentCall),callType:i?h.Analytics.AnalyticsType.videoconf:t.getCallType(),status:h.Analytics.AnalyticsStatus.noAnswer,associatedEntity:t.currentCall.associatedEntity});if(t.callNotification){t.callNotification.close()}if(t.currentCall){t.removeVideoStrategy();t.removeCallEvents();t.currentCall=null}if(t.promotedToAdminTimeout){clearTimeout(t.promotedToAdminTimeout)}}),30*1e3)}},{key:"showNotification",value:function e(t,i){if(!i){i=[]}BX.UI.Notification.Center.notify({content:p.Text.encode(t),position:"top-right",autoHideDelay:5e3,closeButton:true,actions:i})}},{key:"checkVpnStatus",value:function e(){var t;if(r.DesktopApi.isDesktop()&&typeof((t=BXDesktopSystem)===null||t===void 0?void 0:t.IsVpnConnected)==="function"&&BXDesktopSystem.IsVpnConnected()){this.showVpnIsActiveNotification()}}},{key:"showVpnIsActiveNotification",value:function e(){if(this.callView){BX.UI.Notification.Center.notify({content:p.Text.encode(p.Loc.getMessage("CALL_MESSAGE_VPN_IS_ACTIVE")),position:"top-right",autoHideDelay:1e4,closeButton:true,category:"vpnIsActive"})}}},{key:"showNetworkProblemNotification",value:function e(t){BX.UI.Notification.Center.notify({content:p.Text.encode(t),position:"top-right",autoHideDelay:5e3,closeButton:true,actions:[{title:BX.message("IM_M_CALL_HELP"),events:{click:function e(t,i){top.BX.Helper.show("redirect=detail&code=12723718");i.close()}}}]})}},{key:"showUnsupportedNotification",value:function e(){var t;if(r.DesktopApi.isDesktop()){t=new a.MessageBox({message:BX.message("IM_CALL_DESKTOP_TOO_OLD"),buttons:a.MessageBoxButtons.OK_CANCEL,okCaption:BX.message("IM_M_CALL_BTN_UPDATE"),cancelCaption:BX.message("IM_NOTIFY_CONFIRM_CLOSE"),onOk:function e(){var t=c.DesktopDownload.getLinkForCurrentUser();window.open(t,"desktopApp");return true}})}else{t=new a.MessageBox({message:BX.message("IM_CALL_WEBRTC_USE_CHROME_OR_DESKTOP"),buttons:a.MessageBoxButtons.OK_CANCEL,okCaption:BX.message("IM_CALL_DETAILS"),cancelCaption:BX.message("IM_NOTIFY_CONFIRM_CLOSE"),onOk:function e(){top.BX.Helper.show("redirect=detail&code=11387752");return true}})}t.show()}},{key:"isUserAgentSupported",value:function e(){if(r.DesktopApi.isDesktop()){return r.DesktopApi.getApiVersion()>48}if("VoxImplant"in window){return VoxImplant.getInstance().isRTCsupported()}return Yf.isWebRTCSupported()}},{key:"getBlockedButtons",value:function e(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:false;var i=["record","copilot"];if(!this.messengerFacade.showUserSelector||t){i.push("add")}return i}},{key:"prepareCall",value:function e(t){this.preparedCall=t}},{key:"startCall",value:function e(t,i,n){var a,s=this;if(!this.isUserAgentSupported()){this.showUnsupportedNotification();return}if(this.callView||this.currentCall){this.unfold();return}if(this.initCallPromise){return}this.onConnectToCallClick=Date.now();if(this.feedbackPopup){this.feedbackPopup.close()}var o=Jp.getCallWithDialogId(t)||tu.getCallWithDialogId(t);if(o){this.joinCall(o.id,o.uuid,i,{chatInfo:o.associatedEntity,mustCreate:true});return}var l=Tc.Plain;if(t.toString().startsWith("chat")){l=Yf.getConferenceProvider()}var c=l===Tc.Plain;var u=this.isLegacyCall(l);var v=u?Promise.resolve():d.CallTokenManager.getToken(n.chatId);var f=((a=this.preparedCall)===null||a===void 0?void 0:a.dialogId)===t;var m=+new Date;this.initCallPromise=this.messengerFacade.openMessenger(t).then((function(){return H.init()})).then((function(){if(i&&f){Cb(s,lC,xC).call(s,l)}s.createContainer();var e=[];if(c){e.push("floorRequest");e.push("callconrol");e.push("hangupOptions")}if(!Yf.shouldShowDocumentButton()){e.push("document")}H.isCameraOn=i;var n=c&&g.CallSettingsManager.plainCallFollowUpEnabled||!c;var a=r.DesktopApi.isDesktop()||c&&g.CallSettingsManager.plainCallCloudRecordingEnabled||!c;s.callView=new es({hiddenButtons:e,isCopilotFeaturesEnabled:n,isCloudRecordFeaturesEnabled:a,container:s.container,baseZIndex:s.messengerFacade.getDefaultZIndex(),showChatButtons:true,showUsersButton:false,userLimit:Yf.getUserLimit(),language:s.language,layout:t.toString().startsWith("chat")?es.Layout.Grid:es.Layout.Centered,microphoneId:H.defaultMicrophone,showShareButton:s.featureScreenSharing!==wb.Disabled,showRecordButton:true,blockedButtons:s.getBlockedButtons(c),showAddUserButtonInList:c,isCopilotActive:false,isWindowFocus:s.isWindowFocus});s.bindCallViewEvents();if(f){s.callView.isPreparing=true;if(s.preparedCall.user){s.callView.appendUsers(babelHelpers.defineProperty({},s.preparedCall.user,yc.Calling))}s.callView.updateUserData(s.preparedCall.userData);Yf.setUserData(s.preparedCall.userData);if(s.localStream){Cb(s,cC,OC).call(s,l)}var o="background-color: #AA00AA; color: white;";console.log("%c[debug] Time from click 'Start call' to show call card: ".concat(Date.now()-s.onConnectToCallClick," ms"),o);s.onCallViewRenderToMediaReceived=Date.now();s.callView.show()}if(i&&!H.hasCamera()){s.showNotification(BX.message("IM_CALL_ERROR_NO_CAMERA"));i=false}return v})).then((function(e){if(!s.isLegacyCall(l)&&!e){throw new Error("Empty callToken")}var a=u?Jp:tu;return a.createCall({entityType:"chat",entityId:t,provider:l,videoEnabled:!!i,enableMicAutoParameters:H.enableMicAutoParameters,joinExisting:true,debug:s.debug,token:e,chatInfo:n})})).then((function(e){if(!s.initCallPromise){return}var t=Date.now();s.currentCall=e.call;s.currentCallIsNew=e.isNew;if(s.promotedToAdminTimeout){clearTimeout(s.promotedToAdminTimeout)}if(!s.callView){s.leaveCurrentCall(true);return}if(u){Cb(s,nC,LC).call(s,s.currentCall.isCopilotActive)}s.log("Call creation time: "+(t-m)/1e3+" seconds");if(s.currentCall.isCopilotActive&&u){s.sendStartCopilotRecordAnalytics({isAutostart:true})}s.currentCall.useHdVideo(H.preferHdQuality);if(H.defaultMicrophone){s.currentCall.setMicrophoneId(H.defaultMicrophone)}if(H.defaultCamera){s.currentCall.setCameraId(H.defaultCamera)}s.autoCloseCallView=true;s.bindCallEvents();s.createVideoStrategy();if(f){s.callView.isPreparing=false}if(s.isLegacyCall(s.currentCall.provider,s.currentCall.scheme)){s.callView.appendUsers(s.currentCall.getUsers());s.updateCallViewUsers(s.currentCall.id,s.getCallUsers(true))}if(!f){var i="background-color: #AA00AA; color: white;";console.log("%c[debug] Time from click 'Start call' to show call card: ".concat(Date.now()-s.onConnectToCallClick," ms"),i);s.onCallViewRenderToMediaReceived=Date.now()}s.callView.show();s.showCopilotNotify(true);s.showDocumentPromo();s.showMaskPromo();Cb(s,Qb,IC).call(s);if(s.currentCallIsNew){s.log("Inviting users");h.Analytics.getInstance().onStartCall({callId:s._getCallIdentifier(s.currentCall),callType:s.getCallType(),mediaParams:{video:H.isCameraOn,audio:!H.isMicrophoneMuted},status:h.Analytics.AnalyticsStatus.success,associatedEntity:s.currentCall.associatedEntity,isCopilotActive:false});s.currentCall.inviteUsers({users:u?s.getCallUsers():[]});s.messengerFacade.repeatSound("dialtone",5e3,true)}else{s.log("Joining existing call");h.Analytics.getInstance().onJoinCall({callId:s._getCallIdentifier(s.currentCall),callType:s.getCallType(),mediaParams:{video:H.isCameraOn,audio:!H.isMicrophoneMuted},section:h.Analytics.AnalyticsSection.chatWindow,element:h.Analytics.AnalyticsElement.videocall,status:h.Analytics.AnalyticsStatus.success,associatedEntity:s.currentCall.associatedEntity});if(s.currentCall.associatedEntity.userCounter>s.getMaxActiveMicrophonesCount()){H.isMicrophoneMuted=true;s.showAutoMicMuteNotification()}s.currentCall.answer()}s.checkVpnStatus();s._onUpdateLastUsedCameraId()}))["catch"]((function(e){if(!s.initCallPromise){return}console.error(e);var t;if(typeof e=="string"){t=e}else if(p.Type.isObject(e)&&e instanceof Be){t=e.name}else if(babelHelpers["typeof"](e)=="object"&&e.code){t=e.code=="access_denied"?"ACCESS_DENIED":e.code}else{t="UNKNOWN_ERROR"}if(t==="user_is_busy"){s.leaveCurrentCall()}else{h.Analytics.getInstance().onStartCallError({callType:s.getCallType(l),errorCode:t,errorMessage:e===null||e===void 0?void 0:e.message});s._onCallFailure({code:t,message:e.message||""});Cb(s,uC,UC).call(s)}}))["finally"]((function(){s.initCallPromise=null;s.preparedCall=null}))}},{key:"closeCallNotification",value:function e(){if(this.callNotification){this.callNotification.close()}}},{key:"joinCall",value:function e(t,i,n,a){var s,r=this;var o=BX.prop.getBoolean(a,"joinAsViewer",false);if(!this.isUserAgentSupported()){this.showUnsupportedNotification();return}var l=this.callView&&this.currentCall;if(l&&this.currentCall.uuid===i){this.unfold();return}if(l&&this.currentCall.uuid!==i){this.leaveCurrentCall()}if(this.initCallPromise){return}this.onConnectToCallClick=Date.now();var c=((s=this.preparedCall)===null||s===void 0?void 0:s.dialogId)===a.chatInfo.id;var u=a.chatInfo.id.toString().startsWith("chat");var v=Jp.calls[t]||tu.calls[i];var f=u?Yf.getConferenceProvider():Tc.Plain;var m=(v===null||v===void 0?void 0:v.provider)||f;var g=this.isLegacyCall(m,v===null||v===void 0?void 0:v.scheme);this.log("Joining call "+i);this.initCallPromise=g?Promise.resolve():d.CallTokenManager.getToken(a.chatInfo.chatId);this.initCallPromise.then((function(e){var s=null;if(a!==null&&a!==void 0&&a.mustCreate){s={provider:m,entityType:"chat",entityId:a.chatInfo.id,videoEnabled:Boolean(n),enableMicAutoParameters:H.enableMicAutoParameters,joinExisting:true,roomId:i,debug:r.debug,token:e,chatInfo:a.chatInfo}}return g?Jp.getCallWithId(t):tu.getCallWithId(i,s)})).then((function(e){if(!r.currentCall||r.currentCall.uuid!==i){Yf.setUserData(e.call.userData);r.currentCall=e.call}if(r.promotedToAdminTimeout){clearTimeout(r.promotedToAdminTimeout)}return r.messengerFacade.openMessenger(a.chatInfo.id)})).then((function(){return H.init()})).then((function(){r.createContainer();var e=[];if(r.currentCall.provider===Tc.Plain){e.push("floorRequest");e.push("hangupOptions");e.push("callconrol")}if(!Yf.shouldShowDocumentButton()){e.push("document")}H.isCameraOn=!!n;r.callView=new es({container:r.container,baseZIndex:r.messengerFacade.getDefaultZIndex(),showChatButtons:true,showUsersButton:false,userLimit:Yf.getUserLimit(),language:r.language,layout:u?es.Layout.Grid:es.Layout.Centered,showRecordButton:true,microphoneId:H.defaultMicrophone,hiddenButtons:e,blockedButtons:r.getBlockedButtons(r.currentCall.provider===Tc.Plain),showAddUserButtonInList:r.currentCall.provider===Tc.Plain,isCloudRecordFeaturesEnabled:r.currentCall.isCloudRecordFeaturesEnabled,isCopilotFeaturesEnabled:r.currentCall.isCopilotFeaturesEnabled,isCopilotActive:r.currentCall.isCopilotActive,isWindowFocus:r.isWindowFocus});r.autoCloseCallView=true;r.bindCallViewEvents();if(c){r.callView.isPreparing=true;if(r.preparedCall.user){r.callView.appendUsers(babelHelpers.defineProperty({},r.preparedCall.user,yc.Calling))}r.callView.updateUserData(r.preparedCall.userData);Yf.setUserData(r.preparedCall.userData)}if(r.isLegacyCall(r.currentCall.provider,r.currentCall.scheme)){r.callView.appendUsers(r.currentCall.getUsers());r.updateCallViewUsers(r.currentCall.id,r.getCallUsers(true))}var t="background-color: #AA00AA; color: white;";console.log("%c[debug] Time from click 'Join call' to show call card: ".concat(Date.now()-r.onConnectToCallClick," ms"),t);r.onCallViewRenderToMediaReceived=Date.now();r.callView.show();r.showDocumentPromo();r.showCopilotNotify();Cb(r,Qb,IC).call(r);r.checkVpnStatus();r.currentCall.useHdVideo(H.preferHdQuality);if(H.defaultMicrophone){r.currentCall.setMicrophoneId(H.defaultMicrophone)}if(H.defaultCamera){r.currentCall.setCameraId(H.defaultCamera)}r.bindCallEvents();r.createVideoStrategy();if(n&&!H.hasCamera()){r.showNotification(BX.message("IM_CALL_ERROR_NO_CAMERA"));n=false}if(r.currentCall.associatedEntity.userCounter>r.getMaxActiveMicrophonesCount()){H.isMicrophoneMuted=true;r.showAutoMicMuteNotification()}r.currentCall.answer({joinAsViewer:o});r._onUpdateLastUsedCameraId();h.Analytics.getInstance().onJoinCall({callId:r._getCallIdentifier(r.currentCall),callType:r.getCallType(),mediaParams:{video:H.isCameraOn,audio:!H.isMicrophoneMuted},section:h.Analytics.AnalyticsSection.chatList,element:h.Analytics.AnalyticsElement.joinButton,status:h.Analytics.AnalyticsStatus.success,associatedEntity:r.currentCall.associatedEntity});if(c&&r.callView){r.callView.isPreparing=false}r.initCallPromise=null}))["catch"]((function(e){r.initCallPromise=null;var t="UNKNOWN_ERROR";if(p.Type.isString(e)){t=e}else if(p.Type.isObject(e)&&e instanceof Be){t=e.name}else if(p.Type.isObject(e)&&e.code){t=e.code==="access_denied"?"ACCESS_DENIED":e.code}h.Analytics.getInstance().onJoinCallError({callType:r.getCallType(),errorCode:t,callId:r._getCallIdentifier(r.currentCall),errorMessage:e===null||e===void 0?void 0:e.message})}))}},{key:"leaveCurrentCall",value:function e(t){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:false;this.initCallPromise=null;Yf.abortGetCallConnectionData();if(Cb(this,qb,SC).call(this)){h.Analytics.getInstance().onRecordStop({callId:this._getCallIdentifier(this.currentCall),callType:this.getCallType(),subSection:i?h.Analytics.AnalyticsSubSection.contextMenu:h.Analytics.AnalyticsSubSection.window,element:i?h.Analytics.AnalyticsElement.finishForAllButton:h.Analytics.AnalyticsElement.disconnectButton,recordTime:Yf.getRecordTimeText(this.commonRecord.info,true)})}Cb(this,Zb,_C).call(this);if(this.callView){this.callView.releaseLocalMedia()}if(this.currentCall){this.answeredOrDeclinedCalls["delete"](this._getCallIdentifier(this.currentCall));this.currentCall.hangup(t,"",i);if(t){this.currentCall=null}if(this.promotedToAdminTimeout){clearTimeout(this.promotedToAdminTimeout)}}if(this.childCall){this.childCall.removeEventListener(Ac.onUserJoined,this._onChildCallFirstMediaHandler);this.childCall.removeEventListener(Ac.onRemoteMediaReceived,this._onChildCallFirstUserJoinedHandler);this.childCall.removeEventListener(Ac.onLocalMediaReceived,this._onCallLocalMediaReceivedHandler);this.childCall.removeEventListener(Ac.onUserStateChanged,this._onCallUserStateChangedHandler);this.childCall.hangup(t,"",i);this.childCall=null}if(this.callView){this.callView.close()}for(var n=0,a=Object.values(ge);n<a.length;n++){var s=a[n];ae.stopStream(s)}this.hasStreamFromCall=false;Cb(this,uC,UC).call(this)}},{key:"hasActiveCall",value:function e(){return!!(this.currentCall&&this.currentCall.isAnyoneParticipating()||this.callView)}},{key:"hasVisibleCall",value:function e(){return!!(this.callView&&this.callView.visible&&this.callView.size==es.Size.Full)}},{key:"useDevicesInCurrentCall",value:function e(t){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:false;if(!this.currentCall||!this.currentCall.ready){return}for(var n=0;n<t.length;n++){var a=t[n];switch(a.kind){case"audioinput":if(a.deviceId==="default"||i){var s=H.getDefaultDeviceIdByGroupId(a.groupId,"audioinput");this.currentCall.setMicrophoneId(s);this.callView.setMicrophoneId(s)}break;case"videoinput":if(a.deviceId==="default"||i){this.currentCall.setCameraId(a.deviceId)}if(this.reconnectingCameraId===a.deviceId&&!H.isCameraOn){this.updateCameraSettingsInCurrentCallAfterReconnecting(a.deviceId)}break;case"audiooutput":if(this.callView&&a.deviceId==="default"||i){var r=H.getDefaultDeviceIdByGroupId(a.groupId,"audiooutput");this.callView.setSpeakerId(r)}break}}}},{key:"removeDevicesFromCurrentCall",value:function e(t){if(!this.currentCall||!this.currentCall.ready){return}for(var i=0;i<t.length;i++){var n=t[i];switch(n.kind){case"audioinput":if(this.currentCall.microphoneId==n.deviceId){var a=Object.keys(H.microphoneList);var s=void 0;if(a.includes("default")){var r=H.getDeviceGroupIdByDeviceId("default","audioinput");s=H.getDefaultDeviceIdByGroupId(r,"audioinput")}if(!s){s=a.length>0?a[0]:""}this.currentCall.setMicrophoneId(s);if(this.currentCall.provider===Tc.Bitrix){this.callView.setMicrophoneId(s)}}break;case"videoinput":if(this.currentCall.cameraId==n.deviceId){var o=Object.keys(H.cameraList);this.currentCall.setCameraId(o.length>0?o[0]:"")}break;case"audiooutput":if(this.callView&&this.callView.speakerId==n.deviceId){var l=Object.keys(H.audioOutputList);var c=void 0;if(l.includes("default")){var u=H.getDeviceGroupIdByDeviceId("default","audiooutput");c=H.getDefaultDeviceIdByGroupId(u,"audiooutput")}if(!c){c=l.length>0?l[0]:""}this.callView.setSpeakerId(c)}break}}}},{key:"showChat",value:function e(){var t=this;if(r.DesktopApi.isDesktop()&&this.floatingWindow){this.detached=true;this.callView.hide();this.floatingWindow.setTitle(this.currentCall.associatedEntity.name);Yf.getUserAvatars(this.currentCall.id,this.getActiveCallUsers()).then((function(e){t.floatingWindow.setAvatars(e);t.floatingWindow.show()}));this.container.style.width=0}else{this.fold(p.Text.decode(this.currentCall.associatedEntity.name))}}},{key:"togglePictureInPictureCallWindow",value:function e(){var t;var i=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};var n=Boolean(this.currentCall);var a=this.folded;var s=n&&this.currentCall.isScreenSharingStarted();var r=i.isForceOpen;var o=i.isForceClose;var l=a||s||r||((t=this.callView)===null||t===void 0?void 0:t.enableAutoPip);var c=l&&!o;var u=n&&c;if(!this.callView){return}this.callView.talkingService.refreshQueue();this.callView.isActivePiPFromController=u;this.callView.toggleStatePictureInPictureCallWindow(u)}},{key:"fold",value:function e(t){if(this.folded||r.DesktopApi.isDesktop()&&this.floatingWindow){return}if(!t&&this.currentCall){t=p.Text.decode(this.currentCall.associatedEntity.name)}this.folded=true;if(this.resizeObserver){this.resizeObserver.unobserve(this.container)}this.container.classList.add("bx-messenger-call-overlay-folded");this.callView.setTitle(t);this.callView.setSize(es.Size.Folded);this.callViewState=yb.Folded;if(this.sidebar){this.sidebar.toggleHidden(true)}this.closePromo();this.callView.closeCopilotNotify();BX.onCustomEvent(this,"CallController::onFold",{});this.togglePictureInPictureCallWindow()}},{key:"setCallEditorMaxWidth",value:function e(t){if(t!=this.maxEditorWidth){this.maxEditorWidth=t;this._onResize()}}},{key:"findCallEditorWidth",value:function e(){var t=this.container.clientWidth;var i=t<this.maxEditorWidth+es.MIN_WIDTH?t-es.MIN_WIDTH:this.maxEditorWidth;var n=t-i;return{callWidth:n,editorWidth:i}}},{key:"showDocumentsMenu",value:function e(){var t=this;if(this.documentsMenu){this.documentsMenu.destroy();return}h.Analytics.getInstance().onDocumentBtnClick({callId:this._getCallIdentifier(this.currentCall),callType:this.getCallType()});var i=this.callView.buttons.document.elements.root.offsetWidth;var n=Yf.getResumesArticleCode();var a=Yf.getDocumentsArticleCode();var s=[{text:BX.message("IM_M_CALL_MENU_CREATE_RESUME_MSGVER_2"),onclick:function e(){t.documentsMenu.close();t.onDocumentCreateAnalyticsEvent(h.Analytics.AnalyticsType.resume);t.maybeShowDocumentEditor({type:Sb.Resume},n)}},{text:BX.message("IM_M_CALL_MENU_CREATE_FILE"),items:[{text:BX.message("IM_M_CALL_MENU_CREATE_FILE_DOC"),onclick:function e(){t.documentsMenu.close();t.onDocumentCreateAnalyticsEvent(h.Analytics.AnalyticsType.doc);t.maybeShowDocumentEditor({type:Sb.Blank,typeFile:Rb},a)}},{text:BX.message("IM_M_CALL_MENU_CREATE_FILE_XLS"),onclick:function e(){t.documentsMenu.close();t.onDocumentCreateAnalyticsEvent(h.Analytics.AnalyticsType.sheet);t.maybeShowDocumentEditor({type:Sb.Blank,typeFile:Mb},a)}},{text:BX.message("IM_M_CALL_MENU_CREATE_FILE_PPT"),onclick:function e(){t.documentsMenu.close();t.onDocumentCreateAnalyticsEvent(h.Analytics.AnalyticsType.presentation);t.maybeShowDocumentEditor({type:Sb.Blank,typeFile:Ab},a)}}]}];if(!n){s.push({text:BX.message("IM_M_CALL_MENU_OPEN_LAST_RESUME_MSGVER_2"),cacheable:true,items:[{id:"loading",text:BX.message("IM_M_CALL_MENU_LOADING_RESUME_LIST")}],events:{onSubMenuShow:function e(i){return t.buildPreviousResumesSubmenu(i.target)}}})}var r={className:"bx-messenger-videocall-document-options-container",background:"#00428F",contentBackground:"#00428F",borderRadius:"6px",darkMode:true,contentBorderRadius:"6px"};this.documentsMenu=new BX.PopupMenuWindow(fb(fb({},r),{},{angle:false,bindElement:this.callView.buttons.document.elements.root,targetContainer:this.container,offsetTop:-15,bindOptions:{position:"top"},cacheable:false,subMenuOptions:{maxWidth:450},events:{onShow:function e(t){var n=t.getTarget();n.getPopupContainer().style.display="block";var a=i/2-n.getPopupContainer().offsetWidth/2;n.setOffset({offsetLeft:a+40,offsetTop:0});n.setAngle({offset:n.getPopupContainer().offsetWidth/2-17})},onDestroy:function e(){return t.documentsMenu=null}},items:s}));this.documentsMenu.show()}},{key:"onDocumentCreateAnalyticsEvent",value:function e(t){h.Analytics.getInstance().onDocumentCreate({callId:this._getCallIdentifier(this.currentCall),callType:this.getCallType(),type:t})}},{key:"buildPreviousResumesSubmenu",value:function e(t){var i=this;BX.ajax.runAction("disk.api.integration.messengerCall.listResumesInChatByCall",{data:{callUuid:this.currentCall.uuid}}).then((function(e){var n=e.data.resumes;if(n.length>0){n.forEach((function(e){t.getSubMenu().addMenuItem({id:e.id,text:e.object.createDate+": "+e.object.name,onclick:function t(){i.documentsMenu.close();h.Analytics.getInstance().onLastResumeOpen({callId:i._getCallIdentifier(i.currentCall),callType:i.getCallType()});i.viewDocumentByLink(e.links.view)}})}))}else{t.getSubMenu().addMenuItem({id:"nothing",text:BX.message("IM_M_CALL_MENU_NO_RESUME_MSGVER_2"),disabled:true})}t.getSubMenu().removeMenuItem("loading");t.adjustSubMenu()}))}},{key:"maybeShowDocumentEditor",value:function e(t,i){if(i){if(i){BX.UI.InfoHelper.show(i);return}}this.showDocumentEditor(t)}},{key:"showDocumentEditor",value:function e(t){var i=this;t=t||{};var n=true;if(this.sidebar){if(t.force){this.sidebar.close(false);this.sidebar.destroy();this.sidebar=null;n=false}else{return}}if(this.callView){this.callView.setButtonActive("document",true)}clearTimeout(this.showPromoPopupTimeout);this._createAndOpenSidebarWithIframe("about:blank",n);BX.loadExt("disk.onlyoffice-im-integration").then((function(){var e;var n=new BX.Disk.OnlyOfficeImIntegration.CreateDocument({dialog:{id:i.currentCall.associatedEntity.id},call:{uuid:i.currentCall.uuid},delegate:{setMaxWidth:i.setCallEditorMaxWidth.bind(i),onDocumentCreated:i._onDocumentCreated.bind(i)},type:t.type,typeFile:(e=t)===null||e===void 0?void 0:e.typeFile});var a;if(t.type===Sb.Resume){a=n.getIframeUrlForTemplates()}else if(t.type===Sb.Blank){a=n.getIframeUrlForCreate({typeFile:t.typeFile})}else{a=n.getIframeUrl({viewerItem:t.viewerItem})}a.then((function(e){i.docEditorIframe.src=e}))["catch"]((function(e){console.error(e);i.closeDocumentEditor();alert(BX.message("IM_F_ERROR"))}));i.docEditor=n}))["catch"]((function(e){console.error(e);i.closeDocumentEditor();alert(BX.message("IM_F_ERROR"))}));if(this.resizeObserver){this.resizeObserver.observe(this.container)}}},{key:"closeDocumentEditor",value:function e(){var t=this;h.Analytics.getInstance().onDocumentClose({callId:this._getCallIdentifier(this.currentCall),callType:this.getCallType(),type:this.getDocumentType()});return new Promise((function(e){if(t.docEditor&&t.docEditorIframe){t.docEditor.onCloseIframe(t.docEditorIframe)}if(t.container&&t.resizeObserver){t.resizeObserver.unobserve(t.container)}if(t.callView){t.callView.setButtonActive("document",false);t.callView.removeMaxWidth()}if(!t.sidebar){return e()}var i=t.sidebar;t.sidebar=null;i.close().then((function(){t.docEditor=null;t.docEditorIframe=null;i.destroy();t.maxEditorWidth=t.docCreatedForCurrentCall?Ib:Tb;if(!t.callView){t.removeContainer();e()}}))}))}},{key:"clearPictureInPictureDebounceForOpen",value:function e(){if(this.pictureInPictureDebounceForOpen){clearTimeout(this.pictureInPictureDebounceForOpen);this.pictureInPictureDebounceForOpen=null}}},{key:"onInputFileOpenedStateUpdate",value:function e(t){var i=this;if(t){this.clearPictureInPictureDebounceForOpen();this.togglePictureInPictureCallWindow({isForceClose:true});this.isFileChooserActive=true}if(!t&&!this.pictureInPictureDebounceForOpen){this.pictureInPictureDebounceForOpen=setTimeout((function(){i.togglePictureInPictureCallWindow();i.isFileChooserActive=false;i.pictureInPictureDebounceForOpen=null}),1e3)}}},{key:"updateWindowFocusState",value:function e(t){if(t===this.isWindowFocus){return}this.isWindowFocus=t;if(this.callView){this.callView.setWindowFocusState(this.isWindowFocus)}}},{key:"viewDocumentByLink",value:function e(t){if(this.sidebar){return}if(this.callView){this.callView.setButtonActive("document",true)}this.maxEditorWidth=Ib;this._createAndOpenSidebarWithIframe(t)}},{key:"_createAndOpenSidebarWithIframe",value:function e(t,i){var n=this;i=i===true;var a=this.findCallEditorWidth();var s=a.callWidth;var r=a.editorWidth;this.callView.setMaxWidth(s);this.sidebar=new Gm({container:this.container,width:r,events:{onCloseClicked:this.onSideBarCloseClicked.bind(this)}});this.sidebar.open(i);var o=new BX.Loader({target:this.sidebar.elements.contentContainer});o.show();var l=BX.create("iframe",{attrs:{src:t,frameborder:"0"},style:{display:"none",border:"0",margin:"0",width:"100%",height:"100%"}});l.addEventListener("load",(function(){o.destroy();l.style.display="block"}),{once:true});l.addEventListener("error",(function(e){console.error(e);n.closeDocumentEditor();alert(BX.message("IM_F_ERROR"))}));this.sidebar.elements.contentContainer.appendChild(l);this.docEditorIframe=l}},{key:"_onDocumentCreated",value:function e(){this.docCreatedForCurrentCall=true;if(this.currentCall){this.currentCall.sendCustomMessage(Pb,true)}h.Analytics.getInstance().onDocumentUpload({callId:this._getCallIdentifier(this.currentCall),callType:this.getCallType(),type:this.getDocumentType()})}},{key:"onSideBarCloseClicked",value:function e(){this.closeDocumentEditor()}},{key:"_ensureDocumentEditorClosed",value:function e(){var t=this;return new Promise((function(e,i){if(!t.sidebar){return e()}var n=new a.MessageBox({message:BX.message("IM_CALL_CLOSE_DOCUMENT_EDITOR_TO_ANSWER"),buttons:a.MessageBoxButtons.OK_CANCEL,okCaption:BX.message("IM_CALL_CLOSE_DOCUMENT_EDITOR_YES"),cancelCaption:BX.message("IM_CALL_CLOSE_DOCUMENT_EDITOR_NO"),onOk:function i(){t.closeDocumentEditor().then((function(){return e()}));return true},onCancel:function e(){i();return true}});n.show()}))}},{key:"onDocumentPromoActionClicked",value:function e(){this.closePromo();var t=Yf.getResumesArticleCode();if(t){BX.UI.InfoHelper.show(t);return}this.showDocumentEditor({type:Sb.Resume})}},{key:"onDocumentPromoClosed",value:function e(t){var i=t.getData();if(i.dontShowAgain){this.emit(kb.onPromoViewed,{code:_b})}this.documentPromoPopup=null}},{key:"getDocumentType",value:function e(){var t,i,n,a;if(((t=this.docEditor)===null||t===void 0?void 0:(i=t.options)===null||i===void 0?void 0:i.type)===Sb.Resume){return h.Analytics.AnalyticsType.resume}switch((n=this.docEditor)===null||n===void 0?void 0:(a=n.options)===null||a===void 0?void 0:a.typeFile){case Rb:return h.Analytics.AnalyticsType.doc;case Mb:return h.Analytics.AnalyticsType.sheet;case Ab:return h.Analytics.AnalyticsType.presentation}return""}},{key:"unfold",value:function e(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};var i=t.fromPiP,n=i===void 0?false:i;if(this.detached){this.container.style.removeProperty("width");this.callView.show();this.detached=false;if(this.floatingWindow){this.floatingWindow.hide()}}if(this.folded){this.folded=false;this.container.classList.remove("bx-messenger-call-overlay-folded");this.callView.setSize(es.Size.Full);this.callViewState=yb.Opened;p.ZIndexManager.getStack(document.body).bringToFront(this.container);if(this.sidebar){this.sidebar.toggleHidden(false);if(this.resizeObserver){this.resizeObserver.observe(this.container)}}this.togglePictureInPictureCallWindow({isForceClose:n})}BX.onCustomEvent(this,"CallController::onUnfold",{})}},{key:"isFullScreen",value:function e(){if("webkitFullscreenElement"in document){return!!document.webkitFullscreenElement}else if("fullscreenElement"in document){return!!document.fullscreenElement}return false}},{key:"toggleFullScreen",value:function e(){if(this.isFullScreen()){this.exitFullScreen()}else{this.enterFullScreen()}}},{key:"enterFullScreen",value:function e(){if(!this.callView){return}var t=this.callView.elements.root;try{var i=t.requestFullscreen||t.webkitRequestFullscreen||t.mozRequestFullScreen||t.msRequestFullscreen;if(i){i.call(t)["catch"]((function(e){console.error("Failed to enter fullscreen mode:",e)}))}else{console.warn("Fullscreen API is not supported in this browser")}}catch(e){console.error("Error attempting to enable fullscreen mode:",e)}}},{key:"exitFullScreen",value:function e(){try{var t=document.exitFullscreen||document.mozCancelFullScreen||document.webkitExitFullscreen||document.msExitFullscreen||document.cancelFullScreen;if(t){t.call(document)["catch"]((function(e){console.error("Failed to exit fullscreen mode:",e)}))}else{console.warn("Fullscreen API is not fully supported in this browser")}}catch(e){console.error("Error attempting to exit fullscreen mode:",e)}}},{key:"showDocumentPromo",value:function e(){var t=this;if(!this.callView||!this.currentCall||!Yf.shouldShowDocumentButton()){return false}if(!this.messengerFacade.isPromoRequired(_b)){return false}var i=this.callView.buttons.document.elements.root;var n=i.querySelector(".bx-messenger-videocall-panel-icon");if(!n){return false}this.documentPromoPopup=new Um({bindElement:n,promoCode:_b,events:{onActionClick:this.onDocumentPromoActionClicked.bind(this),onClose:this.onDocumentPromoClosed.bind(this)}});this.showPromoPopupTimeout=setTimeout((function(){if(t.folded){return false}t.documentPromoPopup.show()}),Eb)}},{key:"showMaskPromo",value:function e(){var t=this;if(!this.callView||!this.currentCall||!T.isMaskAvailable()){return false}if(!this.messengerFacade.isPromoRequired(Bb)){return false}this.maskPromoPopup=new Fm({callView:this.callView,events:{onClose:function e(i){t.emit(kb.onPromoViewed,{code:Bb});t.maskPromoPopup=null}}});this.showPromoPopup3dTimeout=setTimeout((function(){if(!t.folded){t.maskPromoPopup.show()}}),Db)}},{key:"closePromo",value:function e(){if(this.documentPromoPopup){this.documentPromoPopup.close()}if(this.maskPromoPopup){this.maskPromoPopup.close()}clearTimeout(this.showPromoPopupTimeout);clearTimeout(this.showPromoPopup3dTimeout)}},{key:"_onCallNotificationClose",value:function e(){clearTimeout(this.hideIncomingCallTimeout);this.messengerFacade.stopRepeatSound(this.audioRingtone);if(this.callNotification){this.callNotification.destroy()}}},{key:"_onCallNotificationDestroy",value:function e(){this.messengerFacade.stopRepeatSound(this.audioRingtone);this.callNotification=null}},{key:"_onCallNotificationButtonClick",value:function(){var e=babelHelpers.asyncToGenerator(pb().mark((function e(t){var i=this;var n,a,s,c,u,d;return pb().wrap((function e(p){while(1)switch(p.prev=p.next){case 0:n=t.data;clearTimeout(this.hideIncomingCallTimeout);this.callNotification.close();p.t0=n.button;p.next=p.t0==="answer"?6:p.t0==="decline"?22:24;break;case 6:if(!(this.currentCall&&!this.answeredOrDeclinedCalls.has(this._getCallIdentifier(this.currentCall)))){p.next=21;break}this.answeredOrDeclinedCalls.add(this._getCallIdentifier(this.currentCall));u={id:(a=this.currentCall)===null||a===void 0?void 0:a.id,uuid:(s=this.currentCall)===null||s===void 0?void 0:s.uuid,scheme:((c=this.currentCall)===null||c===void 0?void 0:c.scheme)||Bc.classic};if(r.DesktopApi.isDesktop()){p.next=12;break}this.onAnswerButtonClick(n.mediaParams,u);return p.abrupt("return");case 12:p.next=14;return r.DesktopApi.showBrowserWindow();case 14:if(!r.DesktopApi.isFeatureSupported(r.DesktopFeature.portalTabActivation.id)){p.next=17;break}p.next=17;return r.DesktopApi.handlePortalTabActivation();case 17:if(!r.DesktopApi.shouldActivateTabWithChatPage()){p.next=20;break}p.next=20;return r.DesktopApi.setTabWithChatPageActive();case 20:o.DesktopBroadcastManager.getInstance().sendActionMessage({action:l.DesktopBroadcastAction.answerButtonClick,params:{mediaParams:n.mediaParams,callParams:u}});case 21:return p.abrupt("break",24);case 22:if(this.currentCall){d=this._getCallIdentifier(this._getCallIdentifier(this.currentCall));this.answeredOrDeclinedCalls.add(d);this.ignoreDeclinedCallsTimeout[d]=setTimeout((function(){return i.answeredOrDeclinedCalls["delete"](d)}),15e3);this.removeVideoStrategy();this.removeCallEvents();h.Analytics.getInstance().onJoinCall({callId:d,callType:this.getCallType(),mediaParams:{video:H.isCameraOn,audio:!H.isMicrophoneMuted},section:h.Analytics.AnalyticsSection.callPopup,element:h.Analytics.AnalyticsElement.answerButton,status:h.Analytics.AnalyticsStatus.decline,associatedEntity:this.currentCall.associatedEntity});this.currentCall.decline(603);this.currentCall=null;if(this.promotedToAdminTimeout){clearTimeout(this.promotedToAdminTimeout)}}return p.abrupt("break",24);case 24:case"end":return p.stop()}}),e,this)})));function t(t){return e.apply(this,arguments)}return t}()},{key:"onAnswerButtonClick",value:function e(t,i){var n=this;var a=i.scheme===Bc.classic;var s=a?Jp.getCallWithId(i.id):tu.getCallWithId(i.uuid);s.then((function(e){if(!n.currentCall){n.currentCall=e.call;n.bindCallEvents()}if(r.DesktopApi.isDesktop()){r.DesktopApi.activateWindow()}if(!n.isUserAgentSupported()){n.log("Error: unsupported user agent");n.removeVideoStrategy();n.removeCallEvents();n.currentCall.decline();n.currentCall=null;if(n.promotedToAdminTimeout){clearTimeout(n.promotedToAdminTimeout)}n.showUnsupportedNotification();return}h.Analytics.getInstance().onJoinCall({callId:n._getCallIdentifier(n.currentCall),callType:n.getCallType(),mediaParams:t,section:h.Analytics.AnalyticsSection.callPopup,element:h.Analytics.AnalyticsElement.answerButton,status:h.Analytics.AnalyticsStatus.success,associatedEntity:n.currentCall.associatedEntity});if(n.callView){n.callView.destroy()}var i=n.currentCall.associatedEntity&&n.currentCall.associatedEntity.id?n.currentCall.associatedEntity.id:false;var a=i.toString().startsWith("chat");n._ensureDocumentEditorClosed().then((function(){return n.messengerFacade.openMessenger(i,true)})).then((function(){return H.init()})).then((function(){if(!n.currentCall){n.log("The call was destroyed while being answered");return}n.createContainer();var e=[];if(n.currentCall.provider===Tc.Plain){e.push("floorRequest");e.push("hangupOptions");e.push("callconrol")}if(!Yf.shouldShowDocumentButton()){e.push("document")}H.isCameraOn=t.video&&H.hasCamera();n.callView=new es({container:n.container,baseZIndex:n.messengerFacade.getDefaultZIndex(),users:n.currentCall.users,userStates:n.currentCall.getUsers(),showChatButtons:true,showUsersButton:false,showRecordButton:true,userLimit:Yf.getUserLimit(),layout:a?es.Layout.Grid:es.Layout.Centered,microphoneId:H.defaultMicrophone,blockedButtons:n.getBlockedButtons(n.currentCall.provider===Tc.Plain),hiddenButtons:e,language:n.language,showAddUserButtonInList:n.currentCall.provider===Tc.Plain,isCloudRecordFeaturesEnabled:n.currentCall.isCloudRecordFeaturesEnabled,isCopilotFeaturesEnabled:n.currentCall.isCopilotFeaturesEnabled,isCopilotActive:n.currentCall.isCopilotActive,isWindowFocus:n.isWindowFocus});n.autoCloseCallView=true;if(n.callWithLegacyMobile){n.callView.blockAddUser()}n.bindCallViewEvents();if(n.isLegacyCall(n.currentCall.provider,n.currentCall.scheme)){n.updateCallViewUsers(n.currentCall.id,n.getCallUsers(true))}else{if(p.Reflection.getClass("BX.Messenger.v2.Lib.CallManager")){var i=BX.Messenger.v2.Lib.CallManager.getInstance().getCurrentUser();n.callView.updateUserData(babelHelpers.defineProperty({},n.userId,i))}if(!a){var s=n.currentCall.associatedEntity,r=s.id,o=s.name,l=s.avatar;var c={name:o,avatar_hr:l};n.callView.updateUserData(babelHelpers.defineProperty({},r,c));n.callView.addUser(r,yc.Connected)}}n.callView.show();n.showDocumentPromo();n.showMaskPromo();n.showCopilotNotify();Cb(n,Qb,IC).call(n);n.checkVpnStatus();n.currentCall.useHdVideo(H.preferHdQuality);if(H.defaultMicrophone){n.currentCall.setMicrophoneId(H.defaultMicrophone)}if(H.defaultCamera){n.currentCall.setCameraId(H.defaultCamera)}H.isMicrophoneMuted=!t.audio;n.currentCall.answer({enableMicAutoParameters:H.enableMicAutoParameters});n.createVideoStrategy();n._onUpdateLastUsedCameraId()}))["catch"]((function(e){var t="UNKNOWN_ERROR";if(p.Type.isString(e)){t=e}else if(p.Type.isObject(e)&&e instanceof Be){t=e.name}else if(p.Type.isObject(e)&&e.code){t=e.code==="access_denied"?"ACCESS_DENIED":e.code}h.Analytics.getInstance().onJoinCallError({callType:n.getCallType(),errorCode:t,callId:n._getCallIdentifier(n.currentCall),errorMessage:e===null||e===void 0?void 0:e.message})}))}))}},{key:"_onCallConferenceNotificationButtonClick",value:function e(t){clearTimeout(this.hideIncomingCallTimeout);this.callNotification.close();switch(t.button){case"answerConference":if(this.currentCall&&"id"in this.currentCall.associatedEntity){h.Analytics.getInstance().onAnswerConference({callId:this._getCallIdentifier(this.currentCall)});this.answeredOrDeclinedCalls.add(this._getCallIdentifier(this.currentCall));var i=this.currentCall.associatedEntity.id.toString();if(i.startsWith("chat")){i=i.substring(4)}this.emit(kb.onOpenVideoConference,{dialogId:i})}break;case"skipConference":if(this.currentCall){h.Analytics.getInstance().onDeclineConference({callId:this._getCallIdentifier(this.currentCall)});this.answeredOrDeclinedCalls.add(this._getCallIdentifier(this.currentCall));this.removeVideoStrategy();this.removeCallEvents();this.currentCall.decline();this.currentCall=null;if(this.promotedToAdminTimeout){clearTimeout(this.promotedToAdminTimeout)}}break}}},{key:"_onCallViewShow",value:function e(){p.ZIndexManager.getStack(document.body).bringToFront(this.container);if(Number.isNaN(parseInt(this.messengerFacade.getMessageCount(),10))){Yf.sendLog("[call] setButtonCounter chat: this.messengerFacade.getMessageCount() = ".concat(this.messengerFacade.getMessageCount()," (NaN)"))}this.callView.setButtonCounter("chat",this.messengerFacade.getMessageCount());this.callViewState=yb.Opened}},{key:"_onCallViewClose",value:function e(){this.callView.destroy();this.callViewState=yb.Closed;if(this.floatingWindow){this.floatingWindow.close()}if(this.floatingScreenShareWindow){this.floatingScreenShareWindow.close()}if(this.documentsMenu){this.documentsMenu.close()}if(r.DesktopApi.isDesktop()){r.DesktopApi.closeWindow(r.DesktopApi.findWindow("callBackground"))}this.closePromo();if(this.mediaDevicesResetStateHintBaloon){this.mediaDevicesResetStateHintBaloon.close();this.mediaDevicesResetStateHintBaloon=null}this._closeReconnectionBaloon();this._closeParticipantsVideoBaloon();if(this.copilotPopup){this.copilotPopup.close()}if(this.riseYouHandToTalkPopup){this.riseYouHandToTalkPopup.close();this.riseYouHandToTalkPopup=null}}},{key:"_onCallViewDestroy",value:function e(){this.callView=null;this.folded=false;this.autoCloseCallView=true;if(this.sidebar){BX.adjust(this.container,{style:{backgroundColor:"rgba(0, 0, 0, 0.5)",backdropFilter:"blur(5px)"}})}else{this.removeContainer();this.maxEditorWidth=Tb}}},{key:"_onCallViewBodyClick",value:function e(){if(this.folded){this.unfold()}}},{key:"_onPipClose",value:function e(){var t=this.callView.viewVisibility.getCurrentVisibility()===es.DocumentVisibilityState.hidden;if(this.folded&&t){this.unfold({fromPiP:true})}}},{key:"_onCallViewButtonClick",value:function e(t){var i=t.buttonName;var n={hangup:this._onCallViewHangupButtonClick.bind(this),hangupOptions:this._onCallViewHangupOptionsButtonClick.bind(this),close:this._onCallViewCloseButtonClick.bind(this),toggleUsers:this._onCallViewUsersListButtonClick.bind(this),inviteUser:this._onCallViewInviteUserButtonClick.bind(this),toggleMute:this._onCallViewToggleMuteButtonClick.bind(this),toggleScreenSharing:this._onCallViewToggleScreenSharingButtonClick.bind(this),record:Cb(this,tC,MC).bind(this),toggleVideo:this._onCallViewToggleVideoButtonClick.bind(this),toggleSpeaker:this._onCallViewToggleSpeakerButtonClick.bind(this),showChat:this._onCallViewShowChatButtonClick.bind(this),floorRequest:this._onCallViewFloorRequestButtonClick.bind(this),showHistory:this._onCallViewShowHistoryButtonClick.bind(this),fullscreen:this._onCallViewFullScreenButtonClick.bind(this),document:this._onCallViewDocumentButtonClick.bind(this),microphoneSideIcon:this._onCallViewMicrophoneSideIconClick.bind(this),feedback:this._onCallViewFeedbackButtonClick.bind(this),callcontrol:this._onCallcontrolButtonClick.bind(this),copilot:this._onCallViewCopilotButtonClick.bind(this)};if(p.Type.isFunction(n[i])){n[i].call(this,t)}}},{key:"_onCallViewHangupButtonClick",value:function e(){h.Analytics.getInstance().onDisconnectCall({callId:this._getCallIdentifier(this.currentCall),callType:this.getCallType(),subSection:h.Analytics.AnalyticsSubSection.finishButton,mediaParams:{video:H.isCameraOn,audio:!H.isMicrophoneMuted}});this.leaveCurrentCall()}},{key:"_onCallViewHangupOptionsButtonClick",value:function e(){var t=this;if(this.hangupOptionsMenu){this.hangupOptionsMenu.destroy();return}var i=this.callView.buttons.hangupOptions.elements.root.offsetWidth;var n=[{text:BX.message("CALL_M_BTN_HANGUP_OPTION_FINISH"),onclick:function e(){var i;h.Analytics.getInstance().onFinishCall({callId:t._getCallIdentifier(t.currentCall),callType:t.getCallType(),status:h.Analytics.AnalyticsStatus.finishedForAll,chatId:t.currentCall.associatedEntity.id,callUsersCount:t.getMaxActiveCallUsers().length,callLength:Yf.getTimeInSeconds(t.currentCall.startDate)});t.isCallHangupButtonPressed=true;(i=t.hangupOptionsMenu)===null||i===void 0?void 0:i.destroy();t.leaveCurrentCall(false,true)}},{text:BX.message("CALL_M_BTN_HANGUP_OPTION_LEAVE"),onclick:function e(){var i;h.Analytics.getInstance().onDisconnectCall({callId:t._getCallIdentifier(t.currentCall),callType:t.getCallType(),subSection:h.Analytics.AnalyticsSubSection.contextMenu,mediaParams:{video:H.isCameraOn,audio:!H.isMicrophoneMuted}});(i=t.hangupOptionsMenu)===null||i===void 0?void 0:i.destroy();t.leaveCurrentCall()}}];this.hangupOptionsMenu=new BX.PopupMenuWindow({className:"bx-messenger-videocall-hangup-options-container",background:"#00428F",contentBackground:"#00428F",darkMode:true,contentBorderRadius:"6px",borderRadius:"6px",angle:false,bindElement:this.callView.buttons.hangupOptions.elements.root,targetContainer:this.container,offsetTop:-15,bindOptions:{position:"top"},cacheable:false,subMenuOptions:{maxWidth:450},events:{onShow:function e(t){var n=t.getTarget();n.getPopupContainer().style.display="block";var a=i/2-n.getPopupContainer().offsetWidth/2;n.setOffset({offsetLeft:a+40,offsetTop:0});n.setAngle({offset:n.getPopupContainer().offsetWidth/2-17})},onDestroy:function e(){return t.hangupOptionsMenu=null}},items:n});this.hangupOptionsMenu.show()}},{key:"_onCallViewCloseButtonClick",value:function e(){if(this.callView){this.callView.close()}}},{key:"_onCallViewShowChatButtonClick",value:function e(){if(!this.currentCall){return}h.Analytics.getInstance().onShowChat({callId:this._getCallIdentifier(this.currentCall),callType:this.getCallType()});this.messengerFacade.openMessenger(this.currentCall.associatedEntity.id);this.showChat()}},{key:"_onCallViewFloorRequestButtonClick",value:function e(){var t=this;h.Analytics.getInstance().onFloorRequest({callId:this._getCallIdentifier(this.currentCall),callType:this.getCallType()});var i=this.callView.getUserFloorRequestState(tu.getCurrentUserId());var n=this.callView.getUserTalking(tu.getCurrentUserId());this.callView.setUserFloorRequestState(tu.getCurrentUserId(),!i);if(this.currentCall){this.currentCall.requestFloor(!i)}clearTimeout(this.callViewFloorRequestTimeout);if(n&&!i){this.callViewFloorRequestTimeout=setTimeout((function(){if(t.currentCall){t.currentCall.requestFloor(false)}}),1500)}if(this.riseYouHandToTalkPopup&&!i){this.riseYouHandToTalkPopup.close();this.riseYouHandToTalkPopup=null}}},{key:"_onCallViewTurnOffAllParticipansStreamButtonClick",value:function e(t){if(this.currentCall){this.currentCall.turnOffAllParticipansStream(t)}}},{key:"_getDisconnectedUsers",value:function e(){var t=[];var i=this.currentCall.getUsers();for(var n in i){if(i[n]!==yc.Connected){var a=Yf.getUserCached(n);if(a){t.push(a)}}}return t}},{key:"_closeReconnectionBaloon",value:function e(){if(this.reconnectionBaloon){this.reconnectionBaloon.close();this.reconnectionBaloon=null}}},{key:"_onCallViewUsersListButtonClick",value:function e(t){}},{key:"_onCallcontrolButtonClick",value:function e(t){var i=this;if(!Yf.canControlChangeSettings()){return}if(this.participantsPermissionPopup){this.participantsPermissionPopup.close();return}this.participantsPermissionPopup=new lb({turnOffAllParticipansStream:function e(t){var n;i._onCallViewTurnOffAllParticipansStreamButtonClick(t);h.Analytics.getInstance().onTurnOffAllParticipansStream({callId:i._getCallIdentifier(i.currentCall),callType:i.getCallType(),typeOfStream:(n=t.data)===null||n===void 0?void 0:n.typeOfStream})},onPermissionChanged:function e(t){i.currentCall.changeSettings(t);if(!t.settingEnabled){h.Analytics.getInstance().onCallSettingsChanged({callId:i._getCallIdentifier(i.currentCall),callType:i.getCallType(),typeOfSetting:t.typeOfSetting,settingEnabled:t.settingEnabled})}},onClose:function e(){i.participantsPermissionPopup=null;i._afterCloseParticipantsPermissionPopup()},onOpen:function e(){i._afterOpenParticipantsPermissionPopup();h.Analytics.getInstance().onOpenCallSettings({callId:i._getCallIdentifier(i.currentCall),callType:i.getCallType()})}});if(this.participantsPermissionPopup){this.participantsPermissionPopup.toggle()}}},{key:"_onCallViewInviteUserButtonClick",value:function e(t){var i=this;if(!this.messengerFacade.showUserSelector){return}var n=this.currentCall?this.currentCall.getUsers():{};var a=this.currentCall?this._getDisconnectedUsers():[];this.messengerFacade.showUserSelector({viewElement:this.callView.container,bindElement:t.node,zIndex:this.messengerFacade.getDefaultZIndex()+200,darkMode:this.messengerFacade.isThemeDark(),idleUsers:a,allowNewUsers:Object.keys(n).length<Yf.getUserLimit()-1,onDestroy:this._onInvitePopupDestroy.bind(this),onSelect:this._onInvitePopupSelect.bind(this)}).then((function(e){i.invitePopup=e;i.callView.setHotKeyTemporaryBlock(true)}))}},{key:"_onCallViewToggleMuteHandler",value:function e(t){var i,n;if(!t.muted&&!(H!==null&&H!==void 0&&H.hasMicrophone())){return}var a=(i=this.currentCall)===null||i===void 0?void 0:(n=i.currentRoom)===null||n===void 0?void 0:n.call(i);if(a&&a.speaker!=this.userId&&!t.muted){this.currentCall.requestRoomSpeaker();return}if(this.currentCall&&!this.currentCall.microphoneId&&!t.muted){this.currentCall.setMicrophoneId(H.defaultMicrophone)}H.setIsMicrophoneMuted({isMicrophoneMuted:t.muted,calledProgrammatically:!!t.calledProgrammatically});if(this.floatingWindow){this.floatingWindow.setAudioMuted(t.muted)}if(this.mutePopup){this.mutePopup.close()}if(!t.muted){if(!Yf.havePermissionToBroadcast("mic")){this.showRiseYouHandToTalkNotification({initiatorName:this.lastCalledChangeSettingsUserName})}else{this.allowMutePopup=true}}if(this.currentCall&&Cb(this,Yb,wC).call(this)&&Cb(this,Xb,CC).call(this)){BXDesktopSystem.CallRecordMute(t.muted)}}},{key:"_onCallViewToggleMuteButtonClick",value:function e(t){h.Analytics.getInstance().onToggleMicrophone({muted:t.muted,callId:this._getCallIdentifier(this.currentCall),callType:this.getCallType()});this._onCallViewToggleMuteHandler(t)}},{key:"_onChangeStateCopilot",value:function e(){var t=this;if(this.currentCall.isCopilotActive){h.Analytics.getInstance().copilot.onClickAIOff({callId:this._getCallIdentifier(this.currentCall),callType:this.getCallType()});this.callView.showConfirmModal({title:p.Loc.getMessage("CALL_AI_RECORD_STOP_TITLE"),message:p.Loc.getMessage("CALL_AI_RECORD_STOP_MESSAGE"),yesButtonText:p.Loc.getMessage("CALL_AI_RECORD_STOP_YES_BUTTON"),noButtonText:p.Loc.getMessage("CALL_AI_RECORD_STOP_NO_BUTTON")}).then((function(e){if(e==="yes"){h.Analytics.getInstance().copilot.onSelectAIOff({callId:t._getCallIdentifier(t.currentCall),callType:t.getCallType()});Cb(t,iC,AC).call(t,Pe.PAUSED)}if(e==="no"){h.Analytics.getInstance().copilot.onSelectAIDelete({callId:t._getCallIdentifier(t.currentCall),callType:t.getCallType()});Cb(t,iC,AC).call(t,Pe.DESTROYED)}}))["catch"]((function(e){return console.error("Unspecified error in callView.showConfirmModal:",e)}));return}Cb(this,iC,AC).call(this,Pe.ENABLED)}},{key:"_onCallViewCopilotButtonClick",value:function e(){var t=this;if(this.copilotPopup){this.copilotPopup.close();return}var i=this.currentCall.provider===Tc.Plain;var n=this.currentCall.provider===Tc.Bitrix;var a=i&&this.currentCall.isCopilotFeaturesEnabled||n;if(a&&kn.settingsEnabled&&!kn.tariffAvailable){Yf.openArticle(kn.helpSlider);return}this.copilotPopup=new ob({isCopilotActive:this.currentCall.isCopilotActive,isCopilotFeaturesEnabled:this.currentCall.isCopilotFeaturesEnabled,callId:this.currentCall.id,updateCopilotState:function e(){t._onChangeStateCopilot()},onClose:function e(){t.copilotPopup=null}});if(this.copilotPopup){this.callView.closeCopilotNotify();this.copilotPopup.toggle()}}},{key:"showCopilotNotify",value:function e(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:false;var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:"";if((this.currentCall.isCopilotActive||t)&&this.currentCall.provider!==Tc.Plain&&this.callView){this.callView.showCopilotNotify(this._getCallIdentifier(this.currentCall),i)}}},{key:"showCopilotResultNotify",value:function e(){if(this.callView){this.callView.showCopilotResultNotify()}}},{key:"closeCopilotNotify",value:function e(){if(this.callView){this.callView.closeCopilotNotify()}}},{key:"sendStartCopilotRecordAnalytics",value:function e(t){var i;var n=t.errorCode,a=n===void 0?null:n,s=t.isAutostart;var r={callId:this._getCallIdentifier(this.currentCall),callType:this.getCallType(),errorCode:a,chatUserCount:(i=this.currentCall)===null||i===void 0?void 0:i.associatedEntity.userCounter,isAutostart:s};var o=this.getActiveCallUsers().length;if(o){r.userCount=o+1}h.Analytics.getInstance().copilot.onAIRecordStart(r)}},{key:"_onCallViewToggleScreenSharingButtonClick",value:function e(){h.Analytics.getInstance().onScreenShareBtnClick({callId:this._getCallIdentifier(this.currentCall),callType:this.getCallType()});if(this.featureScreenSharing===wb.Limited){this.messengerFacade.openHelpArticle("call_screen_sharing");return}if(this.featureScreenSharing===wb.Disabled){return}if(this.currentCall.isScreenSharingStarted()){if(this.floatingScreenShareWindow){this.floatingScreenShareWindow.close()}if(this.webScreenSharePopup){this.webScreenSharePopup.close()}if(this.documentPromoPopup){this.documentPromoPopup.close()}this.currentCall.stopScreenSharing();if(Cb(this,Yb,wC).call(this)&&Cb(this,Xb,CC).call(this)){BXDesktopSystem.CallRecordStopSharing()}}else{this.currentCall.startScreenSharing();this.togglePictureInPictureCallWindow();BX.ajax.runAction("call.Call.onShareScreen",{data:{callId:this.currentCall.id,callUuid:this.currentCall.uuid}})}}},{key:"_onCallViewToggleVideoButtonClickHandler",value:function e(t){if(!H.initialized){return}if(t.video&&Object.values(H.cameraList).length===0){this.showNotification(BX.message("IM_CALL_CAMERA_ERROR_FALLBACK_TO_MIC"));return}H.setIsCameraOn({isCameraOn:t.video,calledProgrammatically:!!t.calledProgrammatically});if(!t.video&&!this.currentCall.isScreenSharingStarted()){this.callView.releaseLocalMedia()}if(!this.currentCall.cameraId&&t.video){this.currentCall.setCameraId(H.defaultCamera)}}},{key:"_onCallViewToggleVideoButtonClick",value:function e(t){h.Analytics.getInstance().onToggleCamera({video:t.video,callId:this._getCallIdentifier(this.currentCall),callType:this.getCallType()});this._onCallViewToggleVideoButtonClickHandler(t)}},{key:"_onCallViewToggleSpeakerButtonClick",value:function e(t){var i,n;var a=(i=this.currentCall)===null||i===void 0?void 0:(n=i.currentRoom)===null||n===void 0?void 0:n.call(i);if(a&&a.speaker!=this.userId){alert("only room speaker can turn on sound");return}this.callView.muteSpeaker(!t.speakerMuted);if(t.fromHotKey){BX.UI.Notification.Center.notify({content:BX.message(this.callView.speakerMuted?"IM_M_CALL_MUTE_SPEAKERS_OFF":"IM_M_CALL_MUTE_SPEAKERS_ON"),position:"top-right",autoHideDelay:3e3,closeButton:true})}}},{key:"_onCallViewMicrophoneSideIconClick",value:function e(){var t,i;var n=(t=this.currentCall)===null||t===void 0?void 0:(i=t.currentRoom)===null||i===void 0?void 0:i.call(t);if(n){this.toggleRoomMenu(this.callView.buttons.microphone.elements.icon)}else{this.toggleRoomListMenu(this.callView.buttons.microphone.elements.icon)}}},{key:"_onCallViewFeedbackButtonClick",value:function e(){var t=this;BX.loadExt("ui.feedback.form").then((function(){BX.UI.Feedback.Form.open({id:"call_feedback_".concat(t._getCallIdentifier(t.currentCall),"-").concat(t.currentCall.instanceId,"-").concat(Math.random()),forms:[{zones:["ru","by","kz"],id:406,sec:"9lhjhn",lang:"ru"},{zones:["de"],id:754,sec:"6upe49",lang:"de"},{zones:["es"],id:750,sec:"whk4la",lang:"es"},{zones:["com.br"],id:752,sec:"is01cs",lang:"com.br"},{zones:["en"],id:748,sec:"pds0h6",lang:"en"}],presets:{sender_page:"call",call_type:t.currentCall.provider,call_amount:t.currentCall.users.length+1,call_id:"id: ".concat(t._getCallIdentifier(t.currentCall),", instanceId: ").concat(t.currentCall.instanceId),id_of_user:t.currentCall.userId,from_domain:location.origin}})}))}},{key:"_onCallViewShowHistoryButtonClick",value:function e(){this.messengerFacade.openHistory(this.currentCall.associatedEntity.id)}},{key:"_onCallViewFullScreenButtonClick",value:function e(){if(this.folded){this.unfold()}this.toggleFullScreen()}},{key:"_onCallViewDocumentButtonClick",value:function e(){this.sidebar?this.closeDocumentEditor():this.showDocumentsMenu()}},{key:"_onCallViewReplaceCamera",value:function e(t){if(this.reconnectingCameraId){this.setReconnectingCameraId(null)}if(this.currentCall){this.currentCall.setCameraId(t.deviceId)}H.defaultCamera=t.deviceId}},{key:"_onCallViewReplaceMicrophone",value:function e(t){if(this.currentCall){this.currentCall.setMicrophoneId(t.deviceId);this.callView.setMicrophoneId(t.deviceId)}H.defaultMicrophone=t.deviceId}},{key:"_onCallViewReplaceSpeaker",value:function e(t){H.defaultSpeaker=t.deviceId}},{key:"_onCallViewHasMainStream",value:function e(t){if(!this.currentCall){return}var i=this.currentCall.provider;var n=i===Tc.Bitrix;var a=i===Tc.Plain;var s=a&&!this.isLegacyCall(i,this.currentCall.scheme);if(n||s){this.currentCall.setMainStream(t)}}},{key:"_onCallViewTurnOffParticipantMic",value:function e(t){this.currentCall.turnOffParticipantStream({typeOfStream:"mic",userId:t.userId,fromUserId:tu.getCurrentUserId()});h.Analytics.getInstance().onTurnOffParticipantStream({callId:this._getCallIdentifier(this.currentCall),callType:this.getCallType(),typeOfSetting:"mic"})}},{key:"_onCallViewTurnOffParticipantCam",value:function e(t){this.currentCall.turnOffParticipantStream({typeOfStream:"cam",userId:t.userId,fromUserId:tu.getCurrentUserId()});h.Analytics.getInstance().onTurnOffParticipantStream({callId:this._getCallIdentifier(this.currentCall),callType:this.getCallType(),typeOfSetting:"cam"})}},{key:"_onCallViewTurnOffParticipantScreenshare",value:function e(t){this.currentCall.turnOffParticipantStream({typeOfStream:"screenshare",userId:t.userId,fromUserId:tu.getCurrentUserId()});h.Analytics.getInstance().onTurnOffParticipantStream({callId:this._getCallIdentifier(this.currentCall),callType:this.getCallType(),typeOfSetting:"screenshare"})}},{key:"_onCallViewAllowSpeakPermission",value:function e(t){this.currentCall.allowSpeakPermission({allow:true,userId:t.userId});h.Analytics.getInstance().onAllowPermissionToSpeakResponse({callId:this._getCallIdentifier(this.currentCall),callType:this.getCallType()})}},{key:"_onCallViewDisallowSpeakPermission",value:function e(t){this.currentCall.allowSpeakPermission({allow:false,userId:t.userId});h.Analytics.getInstance().onDisallowPermissionToSpeakResponse({callId:this._getCallIdentifier(this.currentCall),callType:this.getCallType()})}},{key:"_onCallViewChangeHdVideo",value:function e(t){H.preferHdQuality=t.allowHdVideo}},{key:"_onCallViewChangeMicAutoParams",value:function e(t){H.enableMicAutoParameters=t.allowMicAutoParams}},{key:"_onCallViewChangeFaceImprove",value:function e(t){if(!r.DesktopApi.isDesktop()){return}r.DesktopApi.setCameraSmoothingStatus(t.faceImproveEnabled)}},{key:"_onCallViewOpenAdvancedSettings",value:function e(){this.messengerFacade.openSettings({onlyPanel:"hardware"})}},{key:"_onCallViewSetCentralUser",value:function e(t){if(t.stream&&this.floatingWindow){this.floatingWindowUser=t.userId}}},{key:"_onCallUserInvited",value:function e(t){if(this.callView){if(this.isLegacyCall(this.currentCall.provider,this.currentCall.scheme)){this.updateCallViewUsers(this.currentCall.id,[t.userId])}else{Yf.setUserData(t.userData);this.callView.updateUserData(t.userData)}this.callView.addUser(t.userId)}}},{key:"_onCallUserJoined",value:function e(t){Yf.setUserData(t.userData);setTimeout(this.updateFloatingWindowContent.bind(this),100);if(this.callView){this.callView.updateUserData(t.userData);this.callView.addUser(t.userId,yc.Connected)}}},{key:"_onCallDestroy",value:function e(){var t;if(this.currentCall){this.removeVideoStrategy();this.removeCallEvents();t=Cb(this,pC,GC).call(this,this.currentCall);this.currentCall=null}if(this.promotedToAdminTimeout){clearTimeout(this.promotedToAdminTimeout)}if(this.childCall){this.childCall.removeEventListener(Ac.onUserJoined,this._onChildCallFirstMediaHandler);this.childCall.removeEventListener(Ac.onRemoteMediaReceived,this._onChildCallFirstUserJoinedHandler);this.childCall.removeEventListener(Ac.onLocalMediaReceived,this._onCallLocalMediaReceivedHandler);this.childCall.removeEventListener(Ac.onUserStateChanged,this._onCallUserStateChangedHandler);this.childCall.hangup(false,"",true);this.childCall=null}this.callWithLegacyMobile=false;if(this.callNotification){this.callNotification.close()}if(this.participantsPermissionPopup){this.participantsPermissionPopup.close()}if(this.invitePopup){this.invitePopup.close()}Cb(this,Zb,_C).call(this);if(this.callView&&this.autoCloseCallView){this.callView.close()}for(var i=0,n=Object.values(ge);i<n.length;i++){var a=n[i];ae.stopStream(a)}this.hasStreamFromCall=false;Cb(this,uC,UC).call(this);if(this.floatingWindow){this.floatingWindow.close()}if(this.floatingScreenShareWindow){this.floatingScreenShareWindow.close()}if(this.webScreenSharePopup){this.webScreenSharePopup.close()}if(this.mutePopup){this.mutePopup.close()}if(r.DesktopApi.isDesktop()){r.DesktopApi.closeWindow(r.DesktopApi.findWindow("callBackground"))}if(this.riseYouHandToTalkPopup){this.riseYouHandToTalkPopup.close();this.riseYouHandToTalkPopup=null}this.closePromo();this.allowMutePopup=true;this.docCreatedForCurrentCall=false;this._closeReconnectionBaloon();this._closeParticipantsVideoBaloon();this.messengerFacade.stopRepeatSound("dialtone");this.messengerFacade.stopRepeatSound(this.audioRingtone);this.emit(kb.onCallDestroyed,{callDetails:t})}},{key:"loopConnectionQuality",value:function e(t,i){var n=this;var a=arguments.length>2&&arguments[2]!==undefined?arguments[2]:200;this.loopTimers[t]=setTimeout((function(){if(n.callView){n.callView.setUserConnectionQuality(t,i);var e=i>=4?1:i+1;n.loopConnectionQuality(t,e,a)}}),a)}},{key:"clearConnectionQualityTimer",value:function e(t){if(this.loopTimers[t]!==undefined){clearTimeout(this.loopTimers[t]);delete this.loopTimers[t]}}},{key:"_onCallUserStateChanged",value:function e(t){var i=this;setTimeout(this.updateFloatingWindowContent.bind(this),100);if(this.callView){this.callView.setUserState(t.userId,t.state);if(t.isLegacyMobile){this.callView.blockAddUser();this.callView.blockSwitchCamera();this.callView.blockScreenSharing();this.callView.disableMediaSelection();this.callView.updateButtons()}}if(t.state!==yc.Connected&&this.loopTimers[t.userId]===undefined){this.loopConnectionQuality(t.userId,1)}if(t.state==yc.Connecting||t.state==yc.Connected){this.messengerFacade.stopRepeatSound("dialtone")}if(t.state==yc.Connected){this.clearConnectionQualityTimer(t.userId);this.callView.setUserConnectionQuality(t.userId,5);var n=[];var a=(this.currentCall.provider===Tc.Bitrix&&this.currentCall.isGetUserMediaFulfilled()||this.currentCall.provider===Tc.Plain)&&H.hasCamera();if(!t.isLegacyMobile){n.push("floorRequest","screen")}if(!t.isLegacyMobile&&this.isLegacyCall(this.currentCall.provider,this.currentCall.scheme)&&kn.serviceEnabled){n.push("copilot")}if(!t.isLegacyMobile&&a){n.push("camera")}if(!!n.length){this.callView.unblockButtons(n)}if(Yf.isCommonRecordStateInactive(this.commonRecord.state)){this.callView.unblockButtons(["record"])}if(this.currentCall.provider===Tc.Plain){this.callView.unblockAddUser()}}else if(t.state==yc.Idle&&t.previousState==yc.Connected){if(!Cb(this,zb,kC).call(this)&&t.userId===this.commonRecord.initiatorId){Cb(this,Zb,_C).call(this)}}else if(t.state==yc.Failed){if(t.networkProblem){this.showNetworkProblemNotification(BX.message("IM_M_CALL_TURN_UNAVAILABLE"))}else if(this.currentCall instanceof ju){Yf.getUser(this.currentCall.id,t.userId).then((function(e){i.showNotification(Yf.getCustomMessage("IM_M_CALL_USER_FAILED",{gender:e.gender||Hb,name:e.name}))}))}}else if(t.state==yc.Declined){var s=this.isLegacyCall(this.currentCall.provider,this.currentCall.scheme);var r=this.currentCall.provider===Tc.Bitrix;var o=s||!r?this.currentCall.id:t.callId;if(this.callView){babelHelpers.asyncToGenerator(pb().mark((function e(){var n,a;return pb().wrap((function e(s){while(1)switch(s.prev=s.next){case 0:s.prev=0;s.next=3;return Yf.getUser(o,t.userId);case 3:n=s.sent;a=Yf.getCustomMessage("IM_M_CALL_USER_DECLINED",{gender:n.gender||Hb,name:n.name});i.showNotification(a);s.next=11;break;case 8:s.prev=8;s.t0=s["catch"](0);console.warn("not found userData:",s.t0);case 11:case"end":return s.stop()}}),e,null,[[0,8]])})))()}}else if(t.state===yc.Busy&&this.isLegacyCall(this.currentCall.provider,this.currentCall.scheme)){Yf.getUser(this.currentCall.id,t.userId).then((function(e){i.showNotification(Yf.getCustomMessage("IM_M_CALL_USER_BUSY",{gender:e.gender||Hb,name:e.name}))}))}}},{key:"_onCallUserMicrophoneState",value:function e(t){if(!this.callView){return}if(t.userId==this.userId){Yf.sendLog({description:"Set microphone muted ".concat(!t.microphoneState," on MicrophoneState event")});H.isMicrophoneMuted=!t.microphoneState}else{this.callView.setUserMicrophoneState(t.userId,t.microphoneState)}}},{key:"_onCallUserCameraState",value:function e(t){if(!this.callView){return}this.callView.setUserCameraState(t.userId,t.cameraState)}},{key:"_onNeedResetMediaDevicesState",value:function e(t){console.log("_onNeedResetMediaDevicesState");Yf.sendLog({description:"Set microphone muted true in _onNeedResetMediaDevicesState"});H.isMicrophoneMuted=true;H.isCameraOn=false;if(this.mediaDevicesResetStateHintBaloon){return}this.mediaDevicesResetStateHintBaloon=BX.UI.Notification.Center.notify({content:p.Text.encode(BX.message("CALL_MEDIA_DEVICES_RESET_STATE_HINT")),autoHide:false,position:"top-right",closeButton:true})}},{key:"_onBlockCameraButton",value:function e(){if(!this.callView){return}this.callView.blockSwitchCamera()}},{key:"_onUnblockCameraButton",value:function e(){if(!this.callView){return}this.callView.unblockSwitchCamera()}},{key:"_onBlockMicrophoneButton",value:function e(){if(!this.callView){return}this.callView.blockSwitchMicrophone()}},{key:"_onUnblockMicrophoneButton",value:function e(){if(!this.callView){return}this.callView.unblockSwitchMicrophone()}},{key:"_onCameraPublishing",value:function e(t){if(t.publishing){this._onBlockCameraButton()}else{this._onUnblockCameraButton()}if(this.callView){this.callView.updateButtons()}}},{key:"_onMicrophonePublishingd",value:function e(t){if(!this.callView){return}if(t.publishing){this._onBlockMicrophoneButton()}else{this._onUnblockMicrophoneButton()}if(this.callView){this.callView.updateButtons()}}},{key:"_onCallUserVideoPaused",value:function e(t){if(!this.callView){return}this.callView.setUserVideoPaused(t.userId,t.videoPaused)}},{key:"_onCallLocalScreenUpdated",value:function e(t){var i=t.track;if(this.callView){this.callView.setLocalStreamVideoTrack(i)}}},{key:"_onCallLocalMediaReceived",value:function e(t){this.log("Received local media stream "+t.tag);this.hasStreamFromCall=true;if(this.callView){var i=t.tag==="main"||t.mediaRenderer?H.enableMirroring:false;this.callView.setLocalStream(t);this.callView.flipLocalVideo(i);this.callView.setButtonActive("screen",this.currentCall.isScreenSharingStarted());if(this.currentCall.isScreenSharingStarted()){this.screenShareStartTime=new Date;h.Analytics.getInstance().onScreenShareStarted({callId:this._getCallIdentifier(this.currentCall),callType:this.getCallType()});this.togglePictureInPictureCallWindow();if(!r.DesktopApi.isDesktop()){this.showWebScreenSharePopup()}this.callView.updateButtons()}else{h.Analytics.getInstance().onScreenShareStopped({callId:this._getCallIdentifier(this.currentCall),callType:this.getCallType(),status:h.Analytics.AnalyticsStatus.success,screenShareLength:Yf.getTimeInSeconds(this.screenShareStartTime)});this.screenShareStartTime=null;this.togglePictureInPictureCallWindow();if(this.floatingScreenShareWindow){this.floatingScreenShareWindow.close()}if(this.webScreenSharePopup){this.webScreenSharePopup.close()}if(Cb(this,Yb,wC).call(this)&&Cb(this,Xb,CC).call(this)){BXDesktopSystem.CallRecordStopSharing()}}if(!this.currentCall.callFromMobile){this.callView.unblockSwitchCamera();this.callView.updateButtons()}}if(this.currentCall&&H.isCameraOn&&t.tag==="main"&&t.stream.getVideoTracks().length===0){if(this.currentCall.canChangeMediaDevices()){this.showNotification(BX.message("IM_CALL_CAMERA_ERROR_FALLBACK_TO_MIC"))}H.isCameraOn=false}}},{key:"_onCallLocalCameraFlip",value:function e(t){this._onCallLocalCameraFlipInDesktop(t.data.enableMirroring)}},{key:"_onCallLocalCameraFlipInDesktop",value:function e(t){console.error("FLIPPING LOCAL VIDEO");if(this.callView){this.callView.flipLocalVideo(t)}}},{key:"_onCallLocalMediaStopped",value:function e(t){if(this.callView&&t.kind==="audio"){H.isMicrophoneMuted=true;this.showNotification(p.Loc.getMessage("CALL_ERROR_MICROPHONE_STREAM_STOPPED"))}}},{key:"_onCallRemoteMediaReceived",value:function e(t){if(this.onCallViewRenderToMediaReceived){var i="background-color: #00F; color: white;";console.log("%c[debug] Time from view render to the first media received: ".concat(Date.now()-this.onCallViewRenderToMediaReceived," ms"),i);this.onCallViewRenderToMediaReceived=null}if(this.onConnectToCallClick){var n="background-color: #AA00AA; color: white;";console.log("%c[debug] Time from click to the first media received: ".concat(Date.now()-this.onConnectToCallClick," ms"),n);this.onConnectToCallClick=null}Cb(this,oC,NC).call(this,t)}},{key:"_onCallRemoteMediaStopped",value:function e(t){if(this.callView){if("mediaRenderer"in t){if(t.kind==="video"||t.kind==="sharing"){t.mediaRenderer.stream=null;this.callView.setVideoRenderer(t.userId,t.mediaRenderer)}}else{this.callView.setUserMedia(t.userId,t.kind,null)}}}},{key:"isLegacyCall",value:function e(t){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:null;if(i){return i===Bc.classic}var n=t===Tc.Plain&&!g.CallSettingsManager.isJwtInPlainCallsEnabled();var a=t===Tc.Bitrix&&!g.CallSettingsManager.jwtCallsEnabled;return n||a}},{key:"_getCallIdentifier",value:function e(t){if(!t){return null}return this.isLegacyCall(t.provider,t.scheme)?t.id:t.uuid}},{key:"_onCallBadNetworkIndicator",value:function e(t){if(this.callView){this.callView.setBadNetworkIndicator(t.userId,t.badNetworkIndicator)}}},{key:"_onCallConnectionQualityChanged",value:function e(t){this.clearConnectionQualityTimer(t.userId);this.callView.setUserConnectionQuality(t.userId,t.score)}},{key:"_onCallToggleRemoteParticipantVideo",value:function e(t){if(this.toogleParticipantsVideoBaloon){if(t.isVideoShown){this._closeParticipantsVideoBaloon()}return}if(!t.isVideoShown){this.toogleParticipantsVideoBaloon=BX.UI.Notification.Center.notify({content:p.Text.encode(BX.message("IM_M_CALL_REMOTE_PARTICIPANTS_VIDEO_MUTED")),autoHide:false,position:"top-right",closeButton:false})}}},{key:"_closeParticipantsVideoBaloon",value:function e(){if(this.toogleParticipantsVideoBaloon){this.toogleParticipantsVideoBaloon.close();this.toogleParticipantsVideoBaloon=null}}},{key:"_onCallUserVoiceStarted",value:function e(t){if(t.local){if(this.currentCall.muted&&this.isMutedPopupAllowed()){this.showMicMutedNotification()}if(this.currentCall.muted){return}}this.talkingUsers[t.userId]=true;if(this.callView){this.callView.setUserTalking(t.userId,true);if(t.userId==this.callView.localUser.id){this.callView.setUserFloorRequestState(t.userId,false)}}if(this.floatingWindow){this.floatingWindow.setTalking(Object.keys(this.talkingUsers).map((function(e){return Number(e)})))}}},{key:"_onCallUserVoiceStopped",value:function e(t){if(this.talkingUsers[t.userId]){delete this.talkingUsers[t.userId]}if(this.callView){this.callView.setUserTalking(t.userId,false)}if(this.floatingWindow){this.floatingWindow.setTalking(Object.keys(this.talkingUsers).map((function(e){return Number(e)})))}}},{key:"_onBlockUnblockCamMicButtons",value:function e(){if(Yf.havePermissionToBroadcast("cam")){this._onUnblockCameraButton()}else{this._onBlockCameraButton()}if(Yf.havePermissionToBroadcast("mic")){this._onUnblockMicrophoneButton()}else{this._onBlockMicrophoneButton()}}},{key:"_onTurnOnCamera",value:function e(t){this._onCallViewToggleVideoButtonClickHandler({video:true,calledProgrammatically:true})}},{key:"_onAllParticipantsAudioMuted",value:function e(t){var i=this.callView.userRegistry.get(t.userId);var n='<div class = "bx-call-view-participants-control-stream-notify-icon bx-call-view-mic-muted"></div>'+p.Text.encode(Yf.getCustomMessage("CALL_USER_TURNED_OFF_MIC_FOR_ALL_MSGVER_1",{gender:i.data.gender?i.data.gender.toUpperCase():Hb,name:i.data.name}));if(n&&(!t.reason||t.reason!=="settings")){this.createCallControlNotify({content:n,isAllow:false})}if(Yf.isRegularUser(Yf.getCurrentUserRole())){this._onCallViewToggleMuteHandler({muted:true,calledProgrammatically:true})}}},{key:"_onAllParticipantsVideoMuted",value:function e(t){var i=this.callView.userRegistry.get(t.userId);var n='<div class = "bx-call-view-participants-control-stream-notify-icon bx-call-view-cam-muted"></div>'+p.Text.encode(Yf.getCustomMessage("CALL_USER_TURNED_OFF_CAM_FOR_ALL_MSGVER_1",{gender:i.data.gender?i.data.gender.toUpperCase():Hb,name:i.data.name}));if(n&&(!t.reason||t.reason!=="settings")){this.createCallControlNotify({content:n,isAllow:false})}if(Yf.isRegularUser(Yf.getCurrentUserRole())){this._onCallViewToggleVideoButtonClickHandler({video:false,calledProgrammatically:true})}}},{key:"_onAllParticipantsScreenshareMuted",value:function e(t){var i=this.callView.userRegistry.get(t.userId);var n='<div class = "bx-call-view-participants-control-stream-notify-icon bx-call-view-cam-muted"></div>'+p.Text.encode(Yf.getCustomMessage("CALL_USER_TURNED_OFF_SCREENSHARE_FOR_ALL_MSGVER_1",{gender:i.data.gender?i.data.gender.toUpperCase():Hb,name:i.data.name}));if(n&&(!t.reason||t.reason!=="settings")){this.createCallControlNotify({content:n,isAllow:false})}if(this.currentCall.isScreenSharingStarted()&&Yf.isRegularUser(Yf.getCurrentUserRole())){this._onCallViewToggleScreenSharingButtonClick()}}},{key:"_onParticipantMuted",value:function e(t){var i;if((i=t.data)!==null&&i!==void 0&&i.track.muted){var n="mic";var a="";var s=this.callView.userRegistry.get(t.data.fromUserId);var r=this.callView.userRegistry.get(t.data.toUserId);var o=s.data.gender?s.data.gender.toUpperCase():Hb;if(t.data.toUserId==tu.getCurrentUserId()){if(t.data.track.type===0){a="CALL_CONTROL_MODERATOR_TURNED_OFF_YOUR_MIC_MSGVER_1"+"_"+o;this._onCallViewToggleMuteHandler({muted:true,calledProgrammatically:true})}else if(t.data.track.type===1){n="cam";a="CALL_CONTROL_MODERATOR_TURNED_OFF_YOUR_CAM_MSGVER_1"+"_"+o;this._onCallViewToggleVideoButtonClickHandler({video:false,calledProgrammatically:true})}else if(t.data.track.type===2){n="screenshare";a="CALL_CONTROL_MODERATOR_TURNED_OFF_YOUR_SCREENSHARE"+"_"+o;if(this.currentCall.isScreenSharingStarted()){this._onCallViewToggleScreenSharingButtonClick()}}}else{if(t.data.fromUserId==tu.getCurrentUserId()){if(t.data.track.type===0){a="CALL_CONTROL_YOU_TURNED_OFF_USER_MIC"}else if(t.data.track.type===1){n="cam";a="CALL_CONTROL_YOU_TURNED_OFF_USER_CAM"}else if(t.data.track.type===2){n="screenshare";a="CALL_CONTROL_YOU_TURNED_OFF_USER_SCREENSHARE"}}else{if(t.data.track.type===0){a="CALL_CONTROL_MODERATOR_TURNED_OFF_USER_MIC_MSGVER_1"+"_"+o}else if(t.data.track.type===1){n="cam";a="CALL_CONTROL_MODERATOR_TURNED_OFF_USER_CAM_MSGVER_1"+"_"+o}else if(t.data.track.type===2){n="screenshare";a="CALL_CONTROL_MODERATOR_TURNED_OFF_USER_SCREENSHARE"+"_"+o}}}var l='<div class = "bx-call-view-participants-control-stream-notify-icon bx-call-view-'+n+'-muted"></div>'+p.Text.encode(Yf.getCustomMessage(a,{gender:o,initiator_name:s.data.name,target_name:r.data.name}));this.createCallControlNotify({content:l,isAllow:false})}}},{key:"_onYouMuteAllParticipants",value:function e(t){var i={0:"mic",1:"cam",2:"screenshare"};var n={0:"CALL_YOU_TURNED_OFF_MIC_FOR_ALL_MSGVER_1",1:"CALL_YOU_TURNED_OFF_CAM_FOR_ALL_MSGVER_1",2:"CALL_YOU_TURNED_OFF_SCREENSHARE_FOR_ALL_MSGVER_1"};var a='<div class = "bx-call-view-participants-control-stream-notify-icon bx-call-view-'+i[t.data.track.type]+'-muted"></div>'+BX.message[n[t.data.track.type]];this.createCallControlNotify({content:a,isAllow:false})}},{key:"_onUserPermissionsChanged",value:function e(t){var i=this.callView.userRegistry.get(t.data.fromUserId);var n=i.data.gender?i.data.gender.toUpperCase():Hb;var a="CALL_ADMIN_ALLOWED_TURN_ON_ALL_FOR_YOU_BY_HANDRAISE_"+n;if(!t.data.allow){a="CALL_ADMIN_NOT_ALLOWED_TURN_ON_ALL_FOR_YOU_BY_HANDRAISE_"+n;var s=this.callView.getUserFloorRequestState(tu.getCurrentUserId());if(s){this._onCallViewFloorRequestButtonClick()}}var r=p.Text.encode(Yf.getCustomMessage(a,{gender:n,initiator_name:i.data.name}));if(r){this.createCallControlNotify({content:r,isAllow:t.data.allow})}if(this.callView){this.callView.setUserPermissionToSpeakState(t.data.toUserId,t.data.allow)}this.callView.updateButtons();this._onBlockUnblockCamMicButtons()}},{key:"_onUserRoleChanged",value:function e(t){var i=this;if(t.data.toUserId==tu.getCurrentUserId()){var n=BX.message("CALL_YOU_HAVE_BEEN_APPOINTED_AS_ADMIN");if(n){this.promotedToAdminTimeout=setTimeout((function(){return i.createCallControlNotify({content:n,isAllow:true})}),this.promotedToAdminTimeoutValue)}if(this.riseYouHandToTalkPopup){this.riseYouHandToTalkPopup.close();this.riseYouHandToTalkPopup=null}if(this.callView){this.callView.updateButtons();this.callView.updateFloorRequestNotification()}this._onBlockUnblockCamMicButtons()}}},{key:"_onRoomSettingsChanged",value:function e(t){var i={audio:"mic",video:"cam",screen_share:"screenshare"};var n="";var a=false;var s=this.callView.userRegistry.get(t.data.fromUserId);var r=s.data.gender?s.data.gender.toUpperCase():Hb;if(t.data.eft===true){if(t.data.fromUserId==this.currentCall.userId){var o={audio:"CALL_YOU_PROHIBITED_MIC_FOR_ALL_BY_SETTINGS",video:"CALL_YOU_PROHIBITED_CAM_FOR_ALL_BY_SETTINGS",screen_share:"CALL_YOU_PROHIBITED_SCREENSHARE_FOR_ALL_BY_SETTINGS"};n='<div class = "bx-call-view-participants-control-stream-notify-icon bx-call-view-'+i[t.data.act]+'-muted"></div>'+BX.message[o[t.data.act]]}else{var l={audio:"CALL_ADMIN_PROHIBITED_MIC_FOR_ALL_BY_SETTINGS",video:"CALL_ADMIN_PROHIBITED_CAM_FOR_ALL_BY_SETTINGS",screen_share:"CALL_ADMIN_PROHIBITED_SCREENSHARE_FOR_ALL_BY_SETTINGS"};var c=l[t.data.act]+"_"+r;n='<div class = "bx-call-view-participants-control-stream-notify-icon bx-call-view-'+i[t.data.act]+'-muted"></div>'+p.Text.encode(Yf.getCustomMessage(c,{gender:r,initiator_name:s.data.name}))}}else{a=true;if(t.data.fromUserId==this.currentCall.userId){if(this.riseYouHandToTalkPopup){this.riseYouHandToTalkPopup.close();this.riseYouHandToTalkPopup=null}var u={audio:"CALL_YOU_ALLOWED_MIC_FOR_ALL_BY_SETTINGS",video:"CALL_YOU_ALLOWED_CAM_FOR_ALL_BY_SETTINGS",screen_share:"CALL_YOU_ALLOWED_SCREENSHARE_FOR_ALL_BY_SETTINGS"};n='<div class = "bx-call-view-participants-control-stream-notify-icon bx-call-view-'+i[t.data.act]+'-unmuted"></div>'+BX.message[u[t.data.act]]}else{var d={audio:"CALL_ADMIN_ALLOWED_MIC_FOR_ALL_BY_SETTINGS",video:"CALL_ADMIN_ALLOWED_CAM_FOR_ALL_BY_SETTINGS",screen_share:"CALL_ADMIN_ALLOWED_SCREENSHARE_FOR_ALL_BY_SETTINGS"};var h=d[t.data.act]+"_"+r;n='<div class = "bx-call-view-participants-control-stream-notify-icon bx-call-view-'+i[t.data.act]+'-unmuted"></div>'+p.Text.encode(Yf.getCustomMessage(h,{gender:r,initiator_name:s.data.name}));if(this.riseYouHandToTalkPopup&&t.data.act==="audio"){this.riseYouHandToTalkPopup.close();this.riseYouHandToTalkPopup=null}}}if(this.callView&&!a){this.callView.setAllUserPermissionToSpeakState(false)}if(n){this.createCallControlNotify({content:n,isAllow:a})}if(this.participantsPermissionPopup){this.participantsPermissionPopup.updateStatePermissions()}if(t.data.eft===true&&t.data.act==="audio"&&!Yf.havePermissionToBroadcast("mic")){this.lastCalledChangeSettingsUserName=s.data.name;this.showRiseYouHandToTalkNotification({initiatorName:this.lastCalledChangeSettingsUserName})}this.callView.updateButtons();this._onBlockUnblockCamMicButtons()}},{key:"_afterOpenParticipantsPermissionPopup",value:function e(){if(this.participantsPermissionPopup){var t=BX.UI.Notification.Center.balloons;for(var i in t){var n;(n=t[i].container)===null||n===void 0?void 0:n.classList.add(Lb);t[i].offsetClassNameSetted=true}}}},{key:"_afterCloseParticipantsPermissionPopup",value:function e(){var t=BX.UI.Notification.Center.balloons;for(var i in t){var n;(n=t[i].container)===null||n===void 0?void 0:n.classList.remove(Lb);t[i].offsetClassNameSetted=false}}},{key:"createCallControlNotify",value:function e(t){if(!this.callView){return}var i="ui-notification-balloon-content bx-call-control-notification ";if(t.isAllow===false){i+="bx-call-control-notification-disallow "}else{i+="bx-call-control-notification-allow "}BX.UI.Notification.Center.notify({content:t.content,position:"top-right",autoHideDelay:8e3,category:t.category||"",closeButton:true,render:function e(){var t=this.getActions().map((function(e){return e.getContainer()}));return BX.create("div",{props:{className:i},children:[BX.create("div",{props:{className:"ui-notification-balloon-message"},html:this.getContent()}),BX.create("div",{props:{className:"ui-notification-balloon-actions"},children:t}),this.isCloseButtonVisible()?this.getCloseButton():null]})}});this._afterOpenParticipantsPermissionPopup()}},{key:"_onUserStatsReceived",value:function e(t){if(this.callView){this.callView.setUserStats(t.userId,t.report)}}},{key:"_onTrackSubscriptionFailed",value:function e(t){if(this.callView){this.callView.setTrackSubscriptionFailed(t)}}},{key:"_onCallUserScreenState",value:function e(t){if(this.callView){this.callView.setUserScreenState(t.userId,t.screenState)}if(t.userId==tu.getCurrentUserId()){this.callView.setButtonActive("screen",t.screenState);if(t.screenState){if(!r.DesktopApi.isDesktop()){this.showWebScreenSharePopup()}}else{if(this.floatingScreenShareWindow){this.floatingScreenShareWindow.close()}if(this.webScreenSharePopup){this.webScreenSharePopup.close()}if(Cb(this,Yb,wC).call(this)&&Cb(this,Xb,CC).call(this)){BXDesktopSystem.CallRecordStopSharing()}}if(this.currentCall&&this.currentCall.provider==="Plain"){this.togglePictureInPictureCallWindow()}this.callView.updateButtons()}}},{key:"_onCallUserFloorRequest",value:function e(t){if(this.callView){this.callView.setUserFloorRequestState(t.userId,t.requestActive)}}},{key:"_onCallFailure",value:function e(t){var i=t.code||t.name||t.error;var n="";var a=false;if(t.name==="VoxConnectionError"||t.name==="AuthResult"){Yf.reportConnectionResult(t.call.id,false)}switch(i){case Ec.ErrorUnexpectedAnswer:n=p.Loc.getMessage("IM_CALL_ERROR_UNEXPECTED_ANSWER");break;case Ec.BlankAnswerWithErrorCode:n=p.Loc.getMessage("IM_CALL_ERROR_BLANK_ANSWER");break;case Ec.BlankAnswer:n=p.Loc.getMessage("IM_CALL_ERROR_BLANK_ANSWER");break;case Ec.AccessDenied:n=p.Loc.getMessage("IM_CALL_ERROR_ACCESS_DENIED");break;case Ec.NoWebrtc:n=p.Loc.getMessage(this.isHttps?"IM_CALL_NO_WEBRT":"IM_CALL_ERROR_HTTPS_REQUIRED");break;case Ec.UnknownError:a=true;n=p.Loc.getMessage("IM_CALL_ERROR_UNKNOWN");break;case Ec.NetworkError:n=p.Loc.getMessage("IM_CALL_ERROR_NETWORK");break;case Ec.NotAllowedError:n=p.Loc.getMessage("IM_CALL_ERROR_HARDWARE_ACCESS_DENIED");break;case Ec.NotReadableError:n=p.Loc.getMessage("IM_CALL_ERROR_HARDWARE");break;default:if(i===Ec.AuthorizeError||t.name==="AuthResult"){n=p.Loc.getMessage("IM_CALL_ERROR_AUTHORIZATION")}else if(i==403&&t.name==="Failed"){n=p.Loc.getMessage("IM_CALL_ERROR_HARDWARE_ACCESS_DENIED")}else{a=true;n=p.Loc.getMessage("IM_CALL_ERROR_UNKNOWN_WITH_CODE",{"#ERROR_CODE#":i})}}if(this.callView){if(a){this.callView.showSelfTest()}else if(i===Rc.SecurityKeyChanged){this.callView.showSecurityKeyError()}else{this.callView.showFatalError({text:n})}}else{this.showNotification(n)}this.messengerFacade.stopRepeatSound("dialtone");this.autoCloseCallView=false;if(this.currentCall){this.removeVideoStrategy();this.removeCallEvents();if(this.currentCallIsNew&&this.isLegacyCall(this.currentCall.provider,this.currentCall.scheme)){BX.ajax.runAction("im.call.interrupt",{data:{callId:this.currentCall.id}})}this.currentCall.destroy();this.currentCall=null;this.currentCallIsNew=false}if(this.promotedToAdminTimeout){clearTimeout(this.promotedToAdminTimeout)}H.isMicrophoneMuted=false}},{key:"_onNetworkProblem",value:function e(){this.showNetworkProblemNotification(BX.message("IM_M_CALL_TURN_UNAVAILABLE"))}},{key:"_onMicrophoneLevel",value:function e(t){if(this.callView){this.callView.setMicrophoneLevel(t.level)}}},{key:"_onReconnecting",value:function e(t){h.Analytics.getInstance().onReconnect({callId:this._getCallIdentifier(this.currentCall),callType:this.getCallType(),reconnectionReason:t.reconnectionReason,reconnectionReasonInfo:t.reconnectionReasonInfo,reconnectionEventCount:t.reconnectionEventCount});if(this.reconnectionBaloon){return}this.reconnectionBaloon=BX.UI.Notification.Center.notify({content:p.Text.encode(BX.message("IM_CALL_RECONNECTING")),autoHide:false,position:"top-right",closeButton:false})}},{key:"_onReconnected",value:function e(){this.setReconnectingCameraId(this.lastUsedCameraId);this._closeReconnectionBaloon()}},{key:"_onReconnectingFailed",value:function e(t){var i,n;h.Analytics.getInstance().onReconnectError({callId:this._getCallIdentifier(this.currentCall),callType:this.getCallType(),errorCode:t===null||t===void 0?void 0:(i=t.error)===null||i===void 0?void 0:i.code,errorMessage:t===null||t===void 0?void 0:(n=t.error)===null||n===void 0?void 0:n.message})}},{key:"_onCustomMessage",value:function e(t){if(t.message===Pb){this.docCreatedForCurrentCall=true;this.maxEditorWidth=Ib}}},{key:"_onJoinRoomOffer",value:function e(t){console.log("_onJoinRoomOffer",t);if(!t.initiator&&!this.currentCall.currentRoom()){this.currentCall.joinRoom(t.roomId);this.showRoomJoinedPopup(true,t.speaker==this.userId,t.users)}}},{key:"_onJoinRoom",value:function e(t){console.log("_onJoinRoom",t);if(t.speaker==this.userId){this.callView.setRoomState(es.RoomState.Speaker)}else{H.isMicrophoneMuted=true;this.callView.muteSpeaker(true);this.callView.setRoomState(es.RoomState.NonSpeaker)}}},{key:"_onLeaveRoom",value:function e(){this.callView.setRoomState(es.RoomState.Speaker);this.callView.muteSpeaker(false)}},{key:"_onTransferRoomSpeaker",value:function e(t){console.log("_onTransferRoomSpeaker",t);if(t.speaker==this.userId){H.isMicrophoneMuted=false;this.callView.setRoomState(es.RoomState.Speaker);if(t.initiator==this.userId){this.callView.muteSpeaker(false);this.showMicTakenFromPopup(t.previousSpeaker)}}else{H.isMicrophoneMuted=true;this.callView.muteSpeaker(true);this.callView.setRoomState(es.RoomState.NonSpeaker);this.showMicTakenByPopup(t.speaker)}}},{key:"_onCallJoin",value:function e(t){if(this.callView&&!this.clickLinkInterceptor){this.clickLinkInterceptor=this.getClickLinkInterceptor();this.clickLinkInterceptor.startIntercepting()}if(t.local){if(this.currentCall&&this.currentCall instanceof Hg){Yf.reportConnectionResult(this.currentCall.id,true)}return}if(this.currentCall){this.removeVideoStrategy();this.removeCallEvents();this.currentCall=null}if(this.promotedToAdminTimeout){clearTimeout(this.promotedToAdminTimeout)}if(this.callView){this.callView.close()}if(this.callNotification){this.callNotification.close()}if(this.participantsPermissionPopup){this.participantsPermissionPopup.close()}if(this.invitePopup){this.invitePopup.close()}if(this.floatingWindow){this.floatingWindow.close()}if(this.mutePopup){this.mutePopup.close()}this.messengerFacade.stopRepeatSound("dialtone");this.messengerFacade.stopRepeatSound(this.audioRingtone)}},{key:"_onCallLeave",value:function e(t){var i;console.log("_onCallLeave",t);if(!t.local&&this.currentCall&&this.currentCall.ready){this.log(new Error("received remote leave with active call!"));return}H.isMicrophoneMuted=false;Cb(this,Zb,_C).call(this);this.docCreatedForCurrentCall=false;var n;if(!this.getActiveCallUsers().length&&Boolean(this.callView)&&!this.isCallHangupButtonPressed){h.Analytics.getInstance().onFinishCall({callId:this._getCallIdentifier(this.currentCall),callType:this.getCallType(),status:h.Analytics.AnalyticsStatus.lastUserLeft,chatId:this.currentCall.associatedEntity.id,callUsersCount:this.getMaxActiveCallUsers().length,callLength:Yf.getTimeInSeconds(this.currentCall.startDate)});this.isCallHangupButtonPressed=false}if(this.currentCall&&this.currentCall.associatedEntity){this.removeVideoStrategy();this.removeCallEvents();n=Cb(this,pC,GC).call(this,this.currentCall);this.currentCall=null}if(this.promotedToAdminTimeout){clearTimeout(this.promotedToAdminTimeout)}if(this.childCall){this.childCall.removeEventListener(Ac.onUserJoined,this._onChildCallFirstMediaHandler);this.childCall.removeEventListener(Ac.onRemoteMediaReceived,this._onChildCallFirstUserJoinedHandler);this.childCall.removeEventListener(Ac.onLocalMediaReceived,this._onCallLocalMediaReceivedHandler);this.childCall.removeEventListener(Ac.onUserStateChanged,this._onCallUserStateChangedHandler);this.childCall.hangup(false,"",true);this.childCall=null}if(this.callView){this.callView.close()}for(var a=0,s=Object.values(ge);a<s.length;a++){var o=s[a];ae.stopStream(o)}this.hasStreamFromCall=false;Cb(this,uC,UC).call(this);if(this.invitePopup){this.invitePopup.close()}if(this.floatingWindow){this.floatingWindow.close()}if(this.floatingScreenShareWindow){this.floatingScreenShareWindow.close()}if(this.webScreenSharePopup){this.webScreenSharePopup.close()}if(this.callNotification){this.callNotification.close()}if(this.participantsPermissionPopup){this.participantsPermissionPopup.close()}if(this.mutePopup){this.mutePopup.close()}this.togglePictureInPictureCallWindow({isForceClose:true});this.allowMutePopup=true;if(r.DesktopApi.isDesktop()){r.DesktopApi.closeWindow(r.DesktopApi.findWindow("callBackground"))}this.closePromo();this._closeReconnectionBaloon();this._closeParticipantsVideoBaloon();this.messengerFacade.stopRepeatSound("dialtone");this.messengerFacade.stopRepeatSound(this.audioRingtone);(i=this.hangupOptionsMenu)===null||i===void 0?void 0:i.destroy();if(this.clickLinkInterceptor){this.clickLinkInterceptor.stopIntercepting();this.clickLinkInterceptor=null}this.emit(kb.onCallLeft,{callDetails:n})}},{key:"_onUpdateLastUsedCameraId",value:function e(){var t=this.currentCall.cameraId;if(t){this.lastUsedCameraId=t}}},{key:"_onInvitePopupDestroy",value:function e(){this.invitePopup=null;this.callView.setHotKeyTemporaryBlock(false)}},{key:"_onInvitePopupSelect",value:function e(t){var i=this;this.invitePopup.close();if(!this.currentCall||!t.users.length){return}h.Analytics.getInstance().onInviteUser({callId:this._getCallIdentifier(this.currentCall),callType:this.getCallType(),chatId:this.currentCall.associatedEntity.id});var n=this.currentCall.getUsers();var a=[];var s={};var r=Object.keys(n).length;var o=Yf.getConferenceProvider();var l=this.isLegacyCall(o);t.users.forEach((function(e){var t=e.id;s[t]=e;if(r<Yf.getUserLimit()-1||n.hasOwnProperty(t)){r++;a.push(t);i.callView.addUser(t,yc.Calling)}}));Yf.setUserData(s);this.callView.updateUserData(s);if(Yf.isCallServerAllowed()&&this.currentCall.provider===Tc.Plain){this.removeVideoStrategy();this.removeCallEvents();if(this.currentCall.isScreenSharingStarted()){this.currentCall.stopScreenSharing()}var c=function e(t){var n;i.childCall=t;i.childCall.addEventListener(Ac.onUserJoined,i._onChildCallFirstUserJoinedHandler);i.childCall.addEventListener(Ac.onRemoteMediaReceived,i._onChildCallFirstMediaHandler);i.childCall.addEventListener(Ac.onLocalMediaReceived,i._onCallLocalMediaReceivedHandler);i.childCall.addEventListener(Ac.onUserStateChanged,i._onCallUserStateChangedHandler);i.updateDeviceIdInChildCall();var s={users:l?i.childCall.users:a,show:l};i.childCall.inviteUsers(s);i.callView.updateCopilotFeatureState((n=i.childCall)===null||n===void 0?void 0:n.isCopilotFeaturesEnabled)};var u=function e(t){i.log("Can't invite users",t);i.bindCallEvents();a.forEach((function(e){i.callView.setUserState(e,yc.Idle)}))};var d=l?Jp.createChildCall(this.currentCall.id,o,a,{debug:this.debug}):tu.createChildCall(this.currentCall,o,a,{debug:this.debug,videoEnabled:H.isCameraOn});d.then((function(e){return c(e.call)}))["catch"]((function(e){return u(e)}));this.callView.removeScreenUsers()}else if(a.length>0){this.currentCall.inviteUsers({userData:s,users:a,show:true})}}},{key:"_onDocumentBodyClick",value:function e(t){var i=t.target;if(i.matches('input[type="file"]')){this.onInputFileOpenedStateUpdate(true)}}},{key:"_onWindowFocus",value:function e(){if(r.DesktopApi.isDesktop()){this._onWindowDesktopFocus()}if(r.DesktopApi.isDesktop()&&this.isFileChooserActive){this.onInputFileOpenedStateUpdate(false)}this.updateWindowFocusState(true)}},{key:"_onWindowBlur",value:function e(){if(r.DesktopApi.isDesktop()){this._onWindowDesktopBlur()}this.updateWindowFocusState(false)}},{key:"_onWindowDesktopFocus",value:function e(){if(!this.detached){clearTimeout(this.showFloatingWindowTimeout);clearTimeout(this.showFloatingScreenShareWindowTimeout);if(this.floatingWindow){this.floatingWindow.hide()}if(this.floatingScreenShareWindow){this.floatingScreenShareWindow.hide()}}}},{key:"_onWindowDesktopBlur",value:function e(){var t=this;clearTimeout(this.showFloatingWindowTimeout);clearTimeout(this.showFloatingScreenShareWindowTimeout);if(this.currentCall&&this.floatingWindow&&this.callView){this.showFloatingWindowTimeout=setTimeout((function(){if(t.currentCall&&t.floatingWindow&&t.callView){t.floatingWindow.setTitle(t.currentCall.associatedEntity.name);Yf.getUserAvatars(t.currentCall.id,t.getActiveCallUsers()).then((function(e){t.floatingWindow.setAvatars(e);t.floatingWindow.show()}))}}),300)}if(this.currentCall&&this.floatingScreenShareWindow&&this.callView&&this.currentCall.isScreenSharingStarted()){this.showFloatingScreenShareWindowTimeout=setTimeout((function(){if(t.currentCall&&t.floatingScreenShareWindow&&t.callView&&t.currentCall.isScreenSharingStarted()){t.floatingScreenShareWindow.show()}}),300)}}},{key:"_onBeforeUnload",value:function e(t){if(this.floatingWindow){this.floatingWindow.close()}if(this.callNotification){this.callNotification.close()}if(this.floatingScreenShareWindow){this.floatingScreenShareWindow.close()}if(this.participantsPermissionPopup){this.participantsPermissionPopup.close()}if(this.hasActiveCall()){t.preventDefault();t.returnValue=""}}},{key:"_onImTabChange",value:function e(t){if(t==="notify"&&this.currentCall&&this.callView){this.fold(p.Text.decode(this.currentCall.associatedEntity.name))}}},{key:"_onUpdateChatCounter",value:function e(t){if(!this.currentCall||!this.currentCall.associatedEntity||!this.currentCall.associatedEntity.id||!this.callView){return}if(Number.isNaN(parseInt(t,10))){Yf.sendLog("[call] setButtonCounter chat: counter = ".concat(t," (NaN)"))}this.callView.setButtonCounter("chat",t)}},{key:"_onDeviceChange",value:function e(t){var i=this;if(!this.currentCall||!this.currentCall.ready){return}var n=t.data.added;var a=t.data.removed;var s=H.getRemovedUsedDevices(t.data.removed,{microphoneId:this.currentCall.microphoneId,cameraId:this.currentCall.cameraId,speakerId:this.callView.speakerId});this.log("New devices: ",n);if(n){setTimeout((function(){return i.useDevicesInCurrentCall(n)}),500)}this.log("Removed devices: ",a);if(s.length>0){this.log("Removed devices: ",s);BX.UI.Notification.Center.notify({content:BX.message("IM_CALL_DEVICES_DETACHED")+"<br><ul>"+s.map((function(e){return"<li>"+e.label}))+"</ul>",position:"top-right",autoHideDelay:1e4,closeButton:true,actions:[{title:BX.message("IM_CALL_DEVICES_CLOSE"),events:{click:function e(t,i){i.close()}}}]})}if(a){setTimeout((function(){return i.removeDevicesFromCurrentCall(a)}),500)}}},{key:"_onFloatingVideoMainAreaClick",value:function e(){r.DesktopApi.activateWindow();r.DesktopApi.changeTab("im");if(!this.currentCall){return}if(this.currentCall.associatedEntity&&this.currentCall.associatedEntity.id){this.messengerFacade.openMessenger(this.currentCall.associatedEntity.id)}else if(!this.messengerFacade.isMessengerOpen()){this.messengerFacade.openMessenger()}if(this.detached){this.container.style.removeProperty("width");this.callView.show();this.detached=false}}},{key:"_onFloatingVideoButtonClick",value:function e(t){switch(t.buttonName){case"toggleMute":this._onCallViewToggleMuteButtonClick(t);break;case"hangup":this._onCallViewHangupButtonClick();break}}},{key:"_onFloatingScreenShareBackToCallClick",value:function e(){r.DesktopApi.activateWindow();r.DesktopApi.changeTab("im");if(this.floatingScreenShareWindow){this.floatingScreenShareWindow.hide()}}},{key:"_onFloatingScreenShareStopClick",value:function e(){r.DesktopApi.activateWindow();r.DesktopApi.changeTab("im");this.currentCall.stopScreenSharing();if(this.floatingScreenShareWindow){this.floatingScreenShareWindow.close()}if(Cb(this,Yb,wC).call(this)&&Cb(this,Xb,CC).call(this)){BXDesktopSystem.CallRecordStopSharing()}}},{key:"_onFloatingScreenShareChangeScreenClick",value:function e(){if(this.currentCall){this.currentCall.startScreenSharing(true)}}},{key:"_onResize",value:function e(){if(this.sidebar&&this.callView){var t=this.findCallEditorWidth();var i=t.callWidth;var n=t.editorWidth;this.callView.setMaxWidth(i);this.sidebar.setWidth(n)}}},{key:"destroy",value:function e(){if(this.floatingWindow){this.floatingWindow.destroy();this.floatingWindow=null}if(this.floatingScreenShareWindow){this.floatingScreenShareWindow.destroy();this.floatingScreenShareWindow=null}if(this.resizeObserver){this.resizeObserver.disconnect();this.resizeObserver=null}this.callMultiBroadcastClient&&this.callMultiBroadcastClient.destroy();H.unsubscribe(H.Events.onChangeMirroringVideo,this._onCallLocalCameraFlipHandler)}},{key:"log",value:function e(){if(this.currentCall){var t=[this._getCallIdentifier(this.currentCall)];tu.log.apply(tu,t.concat(Array.prototype.slice.call(arguments)))}else{tu.log.apply(tu,arguments)}}},{key:"test",value:function e(){var t=this;var i=arguments.length>0&&arguments[0]!==undefined?arguments[0]:[473,464];var n=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{width:320,height:180};var a=arguments.length>2&&arguments[2]!==undefined?arguments[2]:false;this.messengerFacade.openMessenger().then((function(){return n||a?H.init():null})).then((function(){t.createContainer();var e=["floorRequest"];if(!Yf.shouldShowDocumentButton()){e.push("document")}t.callView=new es({container:t.container,baseZIndex:t.messengerFacade.getDefaultZIndex(),showChatButtons:true,showUsersButton:true,userLimit:48,language:t.language,layout:es.Layout.Grid,hiddenButtons:e,blockedButtons:t.getBlockedButtons(),isWindowFocus:t.isWindowFocus});t.lastUserId=1;t.callView.setCallback("onButtonClick",(function(e){return t._onTestCallViewButtonClick(e)}));t.callView.setCallback(es.Event.onUserClick,(function(e){if(!e.stream){t.callView.setUserState(e.userId,yc.Connected);t.callView.setUserMedia(e.userId,"video",t.stream2.getVideoTracks()[0])}}));t.callView.setUiState(es.UiState.Connected);t.callView.setCallback(es.Event.onBodyClick,t._onCallViewBodyClick.bind(t));t.callView.setCallback("onShow",t._onCallViewShow.bind(t));t.callView.setCallback("onClose",t._onCallViewClose.bind(t));t.callView.setCallback("onReplaceMicrophone",(function(e){console.log("onReplaceMicrophone",e)}));t.callView.setCallback("onReplaceCamera",(function(e){console.log("onReplaceCamera",e)}));t.callView.setCallback("onReplaceSpeaker",(function(e){console.log("onReplaceSpeaker",e)}));t.callView.setCallback(es.Event.onOpenAdvancedSettings,(function(e){console.log("onOpenAdvancedSettings",e);t._onCallViewOpenAdvancedSettings()}));t.callView.show();if(a||n){return ae.getUserMedia({audio:a,video:n})}return new MediaStream})).then((function(e){t.stream=e;var s={stream:t.stream};t.callView.setLocalStream(s);i.forEach((function(e){return t.callView.addUser(e,yc.Connected)}));if(a!==false){t.vad=new ds({mediaStream:t.stream});setInterval((function(){return t.callView.setMicrophoneLevel(t.vad.currentVolume)}),100)}if(n){return ae.getUserMedia({audio:false,video:{width:320,height:180}})}return new MediaStream})).then((function(e){t.stream2=e;t.callView.setUserMedia(i[0],"video",t.stream2.getVideoTracks()[0]);BX.rest.callMethod("im.user.list.get",{ID:i.concat(t.userId),AVATAR_HR:"Y"}).then((function(e){return t.callView.updateUserData(e.data())}))}))}},{key:"_onTestCallViewButtonClick",value:function e(t){console.log(t.buttonName);switch(t.buttonName){case"hangup":case"close":this.callView.close();break;case"inviteUser":this._onCallViewInviteUserButtonClick(t);break;case"fullscreen":this.toggleFullScreen();break;case"record":Cb(this,tC,MC).call(this,t);break;case"floorRequest":this._onCallViewFloorRequestButtonClick(t);break;case"showChat":this.fold('asd "asd"');break;case"toggleScreenSharing":this.callView.setUserMedia(464,"screen",this.stream2.getVideoTracks()[0]);break;case"returnToCall":break;case"document":this._onCallViewDocumentButtonClick();break}}},{key:"testIncoming",value:function e(t){var i=this;this.callNotification=new lm({callerName:"this.currentCall.associatedEntity.name",callerAvatar:"this.currentCall.associatedEntity.avatar",callerType:"this.currentCall.associatedEntity.advanced.chatType",callerColor:"",video:true,hasCamera:!!t,zIndex:this.messengerFacade.getDefaultZIndex()+200,onClose:this._onCallNotificationClose.bind(this),onDestroy:this._onCallNotificationDestroy.bind(this),onButtonClick:function e(t){console.log("button pressed",t.data);i.callNotification.close()}});this.callNotification.show()}},{key:"getMaxActiveMicrophonesCount",value:function e(){return 4}},{key:"showRiseYouHandToTalkNotification",value:function e(t){var i=this;if(!this.callView){return}if(this.riseYouHandToTalkPopup){return}if(this.mutePopup){this.mutePopup.close();this.mutePopup=null}this.riseYouHandToTalkPopup=new xm({callFolded:this.folded,bindElement:this.folded?null:this.callView.buttons.microphone.elements.icon,targetContainer:this.folded?this.getExternalContainer():this.callView.container,icon:"mic",showAngle:false,initiatorName:t.initiatorName,customClassName:"bx-call-view-popup-call-hint-rise-hand-to-talk",autoCloseDelay:30*60*1e3,customRender:function e(){var t=p.Dom.create("div",{props:{className:"bx-call-view-popup-call-hint-rise-block"},children:[p.Loc.getMessage("CALL_ADMIN_PROHIBITED_TURN_ON_PARTICIPANTS_MICROPHONES_HINT",{"#INITIATOR_NAME#":this.initiatorName,"[hint-label]":'<div class="bx-call-view-popup-call-hint-text">',"[/hint-label]":"</div>","#RISE_HAND_ICON#":'<div class="ui-btn bx-call-view-popup-call-hint-hand-raise-icon"></div>',"[label-or]":'<div class="bx-call-view-popup-call-hint-hand-raise-or-label">',"[/label-or]":"</div>","#REQUEST_NOW_BUTTON#":'<div class = "bx-call-view-popup-call-hint-button-placeholder"></div>'})]});var i=t.getElementsByClassName("bx-call-view-popup-call-hint-button-placeholder")[0];i.replaceWith(this.createAskSpeakButton().render());return t},buttons:[],onClose:function e(){i.riseYouHandToTalkPopup.close();i.riseYouHandToTalkPopup=null},onAskSpeakButtonClicked:function e(){i._onCallViewFloorRequestButtonClick();if(i.riseYouHandToTalkPopup){i.riseYouHandToTalkPopup.close();i.riseYouHandToTalkPopup=null}}});this.riseYouHandToTalkPopup.show()}},{key:"showMicMutedNotification",value:function e(){var t=this;if(this.mutePopup||!this.callView||this.riseYouHandToTalkPopup||!Yf.havePermissionToBroadcast("mic")){return}this.mutePopup=new xm({callFolded:this.folded,bindElement:this.callView.buttons.microphone.elements.icon,targetContainer:this.folded?this.getExternalContainer():this.callView.container,icon:"mic-off",buttons:[this.createUnmuteButton()],onClose:function e(){t.allowMutePopup=false;t.mutePopup.destroy();t.mutePopup=null}});this.mutePopup.show()}},{key:"showAutoMicMuteNotification",value:function e(){var t=this;if(this.mutePopup||!this.callView||this.riseYouHandToTalkPopup||!Yf.havePermissionToBroadcast("mic")){return}this.mutePopup=new xm({callFolded:this.folded,bindElement:this.callView.buttons.microphone.elements.icon,targetContainer:this.folded?this.getExternalContainer():this.callView.container,title:p.Text.encode(BX.message("IM_CALL_MIC_AUTO_MUTED")),icon:"mic-off",buttons:[this.createUnmuteButton()],onClose:function e(){t.mutePopup.destroy();t.mutePopup=null}});this.mutePopup.show()}},{key:"createUnmuteButton",value:function e(){var t=this;return new BX.UI.Button({baseClass:"ui-btn bx-call-view-popup-call-hint-unmute",text:BX.message("IM_CALL_UNMUTE_MIC"),size:BX.UI.Button.Size.EXTRA_SMALL,color:BX.UI.Button.Color.LIGHT_BORDER,noCaps:true,round:true,events:{click:function e(){t._onCallViewToggleMuteButtonClick({muted:false});if(t.mutePopup){t.mutePopup.destroy();t.mutePopup=null}}}})}},{key:"_onCallToggleSubscribe",value:function e(t){if(this.currentCall&&this.currentCall.provider===Tc.Bitrix){this.currentCall.toggleRemoteParticipantVideo(t.participants,t.showVideo,true)}}},{key:"_onChangeVideoQuality",value:function e(t){if(this.currentCall&&this.currentCall.provider===Tc.Bitrix){var i={isCameraWasEnabledBeforeQualityChanged:t.isCameraWasEnabledBeforeQualityChanged,videoQuality:t.videoQuality,otherUsers:this.currentCall.users};this.currentCall.setVideoQualityForStreams(i)}}},{key:"_onCallUserClick",value:function e(t){h.Analytics.getInstance().onClickUser({callId:this._getCallIdentifier(this.currentCall),callType:this.getCallType(),layout:Object.keys(es.Layout).find((function(e){return es.Layout[e]===t.layout}))})}},{key:"toggleRoomMenu",value:function e(t){var i=this;if(this.roomMenu){this.roomMenu.destroy();return}var n=this.currentCall.currentRoom().speaker;var a=this.callView.userRegistry.get(n);var s="";if(!a){s=u.Utils.text.getFirstLetters(a.name).toUpperCase()}this.roomMenu=new v.Menu({targetContainer:this.container,bindElement:t,items:[{text:BX.message("IM_CALL_SOUND_PLAYS_VIA"),disabled:true},{html:'<div class="bx-messenger-videocall-room-menu-avatar" style="--avatar: url(\''.concat(p.Text.encode(a.avatar),"')\">").concat(s,"</div>").concat(p.Text.encode(a.name))},{delimiter:true},{text:BX.message("IM_CALL_LEAVE_ROOM"),onclick:function e(){i.currentCall.leaveCurrentRoom();i.roomMenu.close()}},{delimiter:true},{text:BX.message("IM_CALL_HELP"),onclick:function e(){i.showRoomHelp();i.roomMenu.close()}}],events:{onDestroy:function e(){return i.roomMenu=null}}});this.roomMenu.show()}},{key:"toggleRoomListMenu",value:function e(t){var i,n=this;if(this.roomListMenu){this.roomListMenu.destroy();return}if((i=this.currentCall)!==null&&i!==void 0&&i.listRooms){return}this.currentCall.listRooms().then((function(e){n.roomListMenu=new BX.PopupMenuWindow({className:"bx-call-context-menu-options-container",background:"#00428F",contentBackground:"#00428F",darkMode:true,contentBorderRadius:"6px",borderRadius:"6px",targetContainer:n.container,bindElement:t,items:n.prepareRoomListMenuItems(e),events:{onDestroy:function e(){return n.roomListMenu=null}}});n.roomListMenu.show()}))}},{key:"prepareRoomListMenuItems",value:function e(t){var i,n=this;var a=[{text:BX.message("IM_CALL_JOIN_ROOM"),disabled:true},{delimiter:true}];a=(i=a).concat.apply(i,babelHelpers.toConsumableArray(t.map((function(e){return{text:n.getRoomDescription(e),onclick:function t(){if(n.currentCall&&n.currentCall.joinRoom){n.currentCall.joinRoom(e.id)}n.roomListMenu.destroy()}}}))));a.push({delimiter:true});a.push({text:BX.message("IM_CALL_HELP"),onclick:function e(){n.showRoomHelp();n.roomMenu.close()}});return a}},{key:"showRoomHelp",value:function e(){BX.loadExt("ui.dialogs.messagebox").then((function(){BX.UI.Dialogs.MessageBox.alert(BX.message("IM_CALL_HELP_TEXT"),BX.message("IM_CALL_HELP"))}))}},{key:"getRoomDescription",value:function e(t){var i=this;var n=t.userList.map((function(e){var t=i.callView.userRegistry.get(e);return t.name}));var a=BX.message("IM_CALL_ROOM_DESCRIPTION");a=a.replace("#ROOM_ID#",t.id);a=a.replace("#PARTICIPANTS_LIST#",n.join(", "));return a}},{key:"showRoomJoinedPopup",value:function e(t,i,n){var a=this;if(this.roomJoinedPopup||!this.callView){return}var r;if(!t){r=BX.message("IM_CALL_ROOM_JOINED_MANUALLY")+"<p>"+BX.message("IM_CALL_ROOM_JOINED_P2")+"</p>"}else{var o=n.filter((function(e){return e!=a.userId})).map((function(e){var t=a.callView.userRegistry.get(e);return t.name}));var l=o.join(", ");if(i){r=BX.Text.encode(BX.message("IM_CALL_ROOM_JOINED_AUTO_SPEAKER").replace("#PARTICIPANTS_LIST#",l))}else{r=BX.Text.encode(BX.message("IM_CALL_ROOM_JOINED_AUTO").replace("#PARTICIPANTS_LIST#",l));r+="<p>"+BX.Text.encode(BX.message("IM_CALL_ROOM_JOINED_P2"))+"</p>"}}this.roomJoinedPopup=new xm({callFolded:this.folded,bindElement:this.callView.buttons.microphone.elements.icon,targetContainer:this.folded?this.getExternalContainer():this.callView.container,title:r,buttonsLayout:"bottom",autoCloseDelay:0,buttons:[new s.Button({baseClass:"ui-btn",text:BX.message("IM_CALL_ROOM_JOINED_UNDERSTOOD"),size:s.Button.Size.EXTRA_SMALL,color:s.Button.Color.LIGHT_BORDER,noCaps:true,round:true,events:{click:function e(){a.roomJoinedPopup.destroy();a.roomJoinedPopup=null}}}),new s.Button({text:BX.message("IM_CALL_ROOM_WRONG_ROOM"),size:s.Button.Size.EXTRA_SMALL,color:s.Button.Color.LINK,noCaps:true,round:true,events:{click:function e(){a.roomJoinedPopup.destroy();a.roomJoinedPopup=null;a.currentCall.leaveCurrentRoom()}}})],onClose:function e(){a.roomJoinedPopup.destroy();a.roomJoinedPopup=null}});this.roomJoinedPopup.show()}},{key:"showMicTakenFromPopup",value:function e(t){var i=this;if(this.micTakenFromPopup||!this.callView){return}var n=this.callView.userRegistry.get(t);var a=BX.message("IM_CALL_ROOM_MIC_TAKEN_FROM").replace("#USER_NAME#",n.name);this.micTakenFromPopup=new xm({callFolded:this.folded,bindElement:this.callView.buttons.microphone.elements.icon,targetContainer:this.folded?this.getExternalContainer():this.callView.container,title:BX.Text.encode(a),buttonsLayout:"right",autoCloseDelay:5e3,buttons:[],onClose:function e(){i.micTakenFromPopup.destroy();i.micTakenFromPopup=null}});this.micTakenFromPopup.show()}},{key:"showMicTakenByPopup",value:function e(t){var i=this;if(this.micTakenByPopup||!this.callView){return}var n=this.callView.userRegistry.get(t);this.micTakenByPopup=new xm({callFolded:this.folded,bindElement:this.callView.buttons.microphone.elements.icon,targetContainer:this.folded?this.getExternalContainer():this.callView.container,title:BX.Text.encode(BX.message("IM_CALL_ROOM_MIC_TAKEN_BY").replace("#USER_NAME#",n.name)),buttonsLayout:"right",autoCloseDelay:5e3,buttons:[],onClose:function e(){i.micTakenByPopup.destroy();i.micTakenByPopup=null}});this.micTakenByPopup.show()}},{key:"showWebScreenSharePopup",value:function e(){var t=this;if(this.webScreenSharePopup){this.webScreenSharePopup.show();return}this.webScreenSharePopup=new Wm({bindElement:this.callView.buttons.screen.elements.root,targetContainer:this.callView.container,onClose:function e(){t.webScreenSharePopup.destroy();t.webScreenSharePopup=null},onStopSharingClick:function e(){t._onCallViewToggleScreenSharingButtonClick();t.webScreenSharePopup.destroy();t.webScreenSharePopup=null}});this.webScreenSharePopup.show()}},{key:"showFeedbackPopup",value:function e(t){if(!t){if(this.lastCallDetails){t=this.lastCallDetails}else{console.error("Could not show feedback without call ")}}BX.loadExt("ui.feedback.form").then((function(){BX.UI.Feedback.Form.open({id:"call_feedback_"+Math.random(),forms:[{zones:["ru"],id:406,sec:"9lhjhn",lang:"ru"}],presets:{call_id:t.id||0,call_amount:t.userCount||0}})}))}},{key:"showFeedbackPopup_",value:function e(t){var i=this;if(this.feedbackPopup){return}if(!t){t=this.lastCallDetails}var n=this.messengerFacade.isThemeDark();if(!p.Type.isPlainObject(t)){return}BX.loadExt("im.component.call-feedback").then((function(){var e;i.feedbackPopup=new v.Popup({id:"im-call-feedback",content:"",titleBar:BX.message("IM_CALL_QUALITY_FEEDBACK"),closeIcon:true,noAllPaddings:true,cacheable:false,background:n?"#3A414B":null,darkMode:n,closeByEsc:true,autoHide:true,events:{onPopupDestroy:function t(){if(e){e.$destroy()}i.feedbackPopup=null}}});var a="<bx-im-component-call-feedback "+'@feedbackSent="onFeedbackSent" '+':darkMode="darkMode" '+':callDetails="callDetails" />';e=BX.Vue.createApp({template:a,data:function e(){return{darkMode:n,callDetails:t}},methods:{onFeedbackSent:function e(){setTimeout((function(){if(i.feedbackPopup){i.feedbackPopup.close()}}),1500)}}});e.mount("#"+i.feedbackPopup.getContentContainer().id);i.feedbackPopup.show()}))}},{key:"getClickLinkInterceptor",value:function e(){var t=function e(t){var i=t.target.closest("a");if(!i){return}var n=i.getAttribute("href");if(!n){return}if(t.defaultPrevented){return}window.open(n,"_blank");t.preventDefault()};var i=function e(){document.addEventListener("click",t,{capture:true})};var n=function e(){document.removeEventListener("click",t,{capture:true})};return{startIntercepting:i,stopIntercepting:n}}},{key:"userId",get:function e(){return Number(BX.message("USER_ID"))}},{key:"callViewState",get:function e(){return this._callViewState},set:function e(t){if(this.callViewState==t){return}this._callViewState=t;this.emit(kb.onViewStateChanged,{callViewState:t})}}]);return t}(f.EventEmitter);function fC(e){var t=Object.keys(kb);for(var i=0,n=t;i<n.length;i++){var a=n[i];if(p.Type.isFunction(e.events[a])){this.subscribe(kb[a],e.events[a])}}}function mC(e){if(!this.childCall){return}Cb(this,Wb,bC).call(this);Cb(this,oC,NC).call(this,e)}function gC(e){if(!this.childCall){return}Cb(this,Wb,bC).call(this);this._onCallUserJoined(e)}function bC(){if(!this.childCall){return}this.log("Finishing one-to-one call, switching to group call");var e=this.childCall;this.childCall=null;var t=Hi.None;if(Cb(this,Yb,wC).call(this)){t=this.commonRecord.type;Cb(this,Zb,_C).call(this)}this.callView.showButtons(["floorRequest","hangupOptions"]);e.removeEventListener(Ac.onUserJoined,this._onChildCallFirstMediaHandler);e.removeEventListener(Ac.onRemoteMediaReceived,this._onChildCallFirstUserJoinedHandler);e.removeEventListener(Ac.onLocalMediaReceived,this._onCallLocalMediaReceivedHandler);e.removeEventListener(Ac.onUserStateChanged,this._onCallUserStateChangedHandler);this.removeCallEvents();var i=this.currentCall;h.Analytics.getInstance().onFinishCall({callId:this._getCallIdentifier(this.currentCall),callType:this.getCallType(),status:h.Analytics.AnalyticsStatus.privateToGroup,chatId:this.currentCall.associatedEntity.id,callUsersCount:this.getMaxActiveCallUsers().length,callLength:Yf.getTimeInSeconds(this.currentCall.startDate)});i.hangup();this.currentCall=e;if(this.currentCall.associatedEntity&&this.currentCall.associatedEntity.id&&this.folded){this.messengerFacade.openMessenger(this.currentCall.associatedEntity.id)}this.bindCallEvents();this.createVideoStrategy();if(i.isCopilotActive&&i.isCopilotInitiator){Cb(this,iC,AC).call(this,Pe.ENABLED)}if(t!==Hi.None){Cb(this,Kb,PC).call(this,t)}}function CC(){var e=r.DesktopApi.isDesktop();var t=r.DesktopApi.getApiVersion()>=54;if(!e||!t){return false}if(!xi.serviceEnabled){return true}if(!xi.tariffAvailable){return true}return this.currentCall.provider===Tc.Plain}function kC(){var e=this.currentCall.provider===Tc.Plain;var t=e&&g.CallSettingsManager.plainCallCloudRecordingEnabled||!e;return xi.serviceEnabled&&xi.tariffAvailable&&t}function yC(){return Cb(this,Xb,CC).call(this)||Cb(this,zb,kC).call(this)}function SC(){return Cb(this,Xb,CC).call(this)&&this.commonRecord.state!=Di.Stopped&&this.commonRecord.state!=Di.Destroyed}function wC(){return Cb(this,jb,yC).call(this)&&this.commonRecord.state!=Di.Stopped&&this.commonRecord.state!=Di.Destroyed}function IC(){var e=this.currentCall.provider===Tc.Plain;var t=this.currentCall.provider===Tc.Bitrix;var i=e&&this.currentCall.isCloudRecordFeaturesEnabled||t;if(this.hasActiveCall()&&xi.serviceEnabled&&i){this.callView.showCloudRecordPromo(this.currentCall.isCloudRecordFeaturesEnabled,this.currentCall.id)}}function TC(){return{state:Di.Stopped,type:Hi.None,initiatorId:null,info:null,notifyShowed:false}}function PC(e){var t=this.currentCall.provider===Tc.Plain;var i=this.currentCall.provider===Tc.Bitrix;var n=t&&this.currentCall.isCloudRecordFeaturesEnabled||i;this.commonRecord.type=e;if(xi.serviceEnabled&&n){var a=e==="audio"?Ee.AUDIO:Ee.VIDEO;this.callView.blockButtons(["record"]);this.currentCall.setCloudRecordState(_e.STARTED,a);return}this.callView.setButtonActive("record",true);this.currentCall.sendLocalRecordState({action:Di.Started,type:this.commonRecord.type,date:new Date});this.commonRecord.state=Di.Started}function _C(){var e=this.commonRecord.initiatorId;var t=this.commonRecord.state;this.commonRecord=Cb(this,Jb,TC).call(this);if(Cb(this,Xb,CC).call(this)){BXDesktopSystem.CallRecordStop()}if(this.callView){this.callView.setCommonRecordState(this.callView.getDefaultCommonRecordState());this.callView.setButtonActive("record",false)}if(t!==Di.Stopped&&e===this.userId&&this.currentCall&&this.currentCall.isAnyoneParticipating()){this.currentCall.sendLocalRecordState({action:Di.Stopped,userId:this.userId})}}function EC(){this.togglePictureInPictureCallWindow({isForceClose:false});if(this.folded){this.unfold()}}function RC(e){var t=this;var i=e.state,n=e.kind,a=e.hotkey;switch(i){case Di.Started:{if(a){Cb(this,Kb,PC).call(this,Hi.Video);return}if(n===Hi.Audio){if(this.currentCall&&this.currentCall.isCopilotActive){this.callView.showConfirmModal({title:p.Loc.getMessage("CALL_RECORD_AUDIO_WITH_COPILOT_TITLE"),message:p.Loc.getMessage("CALL_RECORD_AUDIO_WITH_COPILOT_MESSAGE"),yesButtonText:p.Loc.getMessage("CALL_RECORD_AUDIO_WITH_COPILOT_YES_BUTTON"),noButtonText:p.Loc.getMessage("CALL_RECORD_AUDIO_WITH_COPILOT_NO_BUTTON")}).then((function(e){if(e==="no"){Cb(t,Kb,PC).call(t,Hi.Audio)}}))["catch"]((function(e){return console.error("Unspecified error in callView.showConfirmModal:",e)}));return}Cb(this,Kb,PC).call(this,Hi.Audio)}if(n===Hi.Video){Cb(this,Kb,PC).call(this,Hi.Video)}return}case Di.Paused:case Di.Resumed:{if(Cb(this,zb,kC).call(this)){var s=i===Di.Paused?_e.PAUSED:_e.STARTED;this.currentCall.setCloudRecordState(s);this.commonRecord.state=i;return}if(Cb(this,Xb,CC).call(this)){BXDesktopSystem.CallRecordPause(i===Di.Paused)}break}case Di.Stopped:{if(Cb(this,zb,kC).call(this)){this.callView.blockButtons(["record"]);this.currentCall.setCloudRecordState(_e.STOPPED);this.commonRecord.state=Di.Stopped;return}this.callView.setButtonActive("record",false);break}case Di.Destroyed:{if(Cb(this,zb,kC).call(this)){this.callView.showConfirmModal({title:p.Loc.getMessage("CALL_CLOUD_RECORD_DESTROY_TITLE"),message:p.Loc.getMessage("CALL_CLOUD_RECORD_DESTROY_MESSAGE"),yesButtonText:p.Loc.getMessage("CALL_CLOUD_RECORD_DESTROY_RESUME_BUTTON"),noButtonText:p.Loc.getMessage("CALL_CLOUD_RECORD_DESTROY_DELETE_BUTTON")}).then((function(e){if(e==="no"){t.callView.blockButtons(["record"]);t.currentCall.setCloudRecordState(_e.DESTROYED);t.commonRecord.state=Di.Destroyed}}))["catch"]((function(e){return console.error("Unspecified error in callView.showConfirmModal:",e)}));return}break}default:{console.error("Unknown recording state",i);break}}this.currentCall.sendLocalRecordState({action:i,type:this.commonRecord.type,date:new Date});this.commonRecord.state=i}function MC(){if(Yf.isCommonRecordStateInactive(this.commonRecord.state)){h.Analytics.getInstance().onRecordBtnClick({callId:this._getCallIdentifier(this.currentCall),callType:this.getCallType()})}if(xi.serviceEnabled){if(!xi.tariffAvailable){Yf.openArticle(xi.tariffSlider);return}var e=this.isLegacyCall(this.currentCall.provider,this.currentCall.scheme);var t=this.currentCall.isCloudRecordFeaturesEnabled&&!e;if(!t&&!r.DesktopApi.isDesktop()){this.callView.showCloudRecordInfoPopup(this.currentCall.isCloudRecordFeaturesEnabled,this.currentCall.id);return}this.callView.showCommonRecordMenuPopup(t&&r.DesktopApi.isDesktop());return}if(!Cb(this,jb,yC).call(this)){if(window.BX.Helper){window.BX.Helper.show("redirect=detail&code=22079566")}return}this.callView.showCommonRecordMenuPopup(true)}function AC(e){var t=this;var i="";switch(e){case Pe.ENABLED:i="call.Track.start";break;case Pe.PAUSED:i="call.Track.stop";break;case Pe.DESTROYED:i="call.Track.destroy";break;default:}if(this.isLegacyCall(this.currentCall.provider,this.currentCall.scheme)){BX.ajax.runAction(i,{data:{callId:this.currentCall.id,callUuid:this.currentCall.uuid}}).then((function(){var e=!t.currentCall.isCopilotActive;Cb(t,nC,LC).call(t,e);h.Analytics.getInstance().copilot.onAIRecordStatusChanged({isAIOn:e,callId:t._getCallIdentifier(t.currentCall),callType:t.getCallType()});if(e){t.sendStartCopilotRecordAnalytics({isAutostart:false})}else{t.showCopilotResultNotify()}}))["catch"]((function(e){var i=e.errors[0].code;kn.handleCopilotError(i);if(t.callView){t.callView.showCopilotErrorNotify(i)}var n=!t.currentCall.isCopilotActive;h.Analytics.getInstance().copilot.onAIRecordStatusChanged({isAIOn:n,callId:t._getCallIdentifier(t.currentCall),callType:t.getCallType(),error:i});t.sendStartCopilotRecordAnalytics({errorCode:i,isAutostart:false})}))}else{var n=!this.currentCall.isCopilotActive;Cb(this,nC,LC).call(this,n);this.currentCall.setRecorderState(e);BX.ajax.runAction(i,{data:{callId:this.currentCall.id,callUuid:this.currentCall.uuid}});if(n){this.sendStartCopilotRecordAnalytics({isAutostart:false})}else{this.showCopilotResultNotify()}}}function LC(e){if(this.isLegacyCall(this.currentCall.provider,this.currentCall.scheme)){this.currentCall.isCopilotActive=e}if(this.callView){this.callView.updateCopilotState(e)}}function BC(e){var t=e.isTrackRecordOn,i=e.errorCode;Cb(this,nC,LC).call(this,t);if(i){this.showCopilotNotify(true,i);return}if(t){this.showCopilotNotify()}else{this.closeCopilotNotify();this.showCopilotResultNotify()}}function DC(e){var t=e.code,i=e.error,n=e.isCopilotActive;Cb(this,nC,LC).call(this,n);if(!kn.tariffAvailable){this.callView.unblockButtons(["copilot"]);return}if(this.currentCall.isCopilotInitialized){if(!this.currentCall.initiatorId&&n){this.sendStartCopilotRecordAnalytics({isAutostart:true})}this.callView.unblockButtons(["copilot"])}if(i){kn.handleCopilotError(i);if(this.callView){var a=n?mn.DISABLE_AI_INTERNAL_ERROR:mn.ENABLE_AI_INTERNAL_ERROR;this.callView.showCopilotErrorNotify(a)}this.sendStartCopilotRecordAnalytics({error:i,isAutostart:false})}if(t===Pe.DISABLED){this.showCopilotResultNotify();return}if(![Pe.PAUSED,Pe.DESTROYED].includes(t)){this.showCopilotNotify()}}function HC(e){if(this.userId===e.userId){var t=e.commonRecordState.state;var i=this._getCallIdentifier(this.currentCall);var n=this.getCallType();switch(t){case Di.Started:{if(this.commonRecord.state===Di.Resumed){h.Analytics.getInstance().onRecordResumed({callId:i,callType:n,errorCode:null})}else{h.Analytics.getInstance().onRecordStart({callId:i,callType:n,recordType:e.commonRecordState.type,errorCode:null})}break}case Di.Paused:{h.Analytics.getInstance().onRecordPaused({callId:i,callType:n,errorCode:null});break}case Di.Stopped:{h.Analytics.getInstance().onRecordStop({callId:i,callType:n,subSection:h.Analytics.AnalyticsSubSection.window,element:h.Analytics.AnalyticsElement.recordButton,recordTime:Yf.getRecordTimeText(this.commonRecord.info,true)});break}case Di.Destroyed:{h.Analytics.getInstance().onRecordDelete({callId:i,callType:n,errorCode:null});break}default:{if(Yf.isCloudRecordLogEnabled()){console.error("Unknown record state: ".concat(status))}}}}if(e.userId&&e.userId!==this.userId){if(e.justJoined){if(e.commonRecordState.state===Di.Started){if(xi.isCisRegion){this.callView.showCommonRecordStartNotify(e.userId,Di.Started)}else{this.callView.showCommonRecordStartModal()}}}else{this.callView.showCommonRecordStartNotify(e.userId,e.commonRecordState.state)}}this.commonRecord.state=e.commonRecordState.state;this.callView.setCommonRecordState(e.commonRecordState);this.commonRecord.initiatorId=e.initiatorId;if(Yf.isCommonRecordStateInactive(e.commonRecordState.state)){this.commonRecord.info=null;this.commonRecord.initiatorId=null}else{this.commonRecord.info=structuredClone(e.commonRecordState)}this.callView.unblockButtons(["record"]);this.callView.setButtonActive("record",[_e.STARTED,_e.PAUSED].includes(e.code))}function NC(e){if(!this.callView){Yf.sendLog({description:"trying to do #setUserMedia, but callView is not initialized yet",userId:e.userId,kind:e.kind});return}if("track"in e){this.callView.setUserMedia(e.userId,e.kind,e.track);return}if("mediaRenderer"in e){var t,i,n,a;var s=e.mediaRenderer.kind;var r=(t=e.mediaRenderer.stream)===null||t===void 0?void 0:(i=t.getAudioTracks())===null||i===void 0?void 0:i[0];var o=(n=e.mediaRenderer.stream)===null||n===void 0?void 0:(a=n.getVideoTracks())===null||a===void 0?void 0:a[0];if((s==="audio"||s==="sharingAudio")&&r){this.callView.setUserMedia(e.userId,s,r)}else if((s==="video"||s==="sharing")&&o){this.callView.setVideoRenderer(e.userId,e.mediaRenderer)}}}function xC(e){var t=this;var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:false;var n={};if(H.defaultCamera){n.deviceId={exact:H.defaultCamera}}if(!i){n.width={ideal:1280};n.height={ideal:720}}var a=Sn.isNotSupportDevicesListBeforeStream;var s={audio:a,video:n};ae.getUserMedia(s).then((function(i){t.localStream=i;if(!t.currentCall&&!t.initCallPromise){Cb(t,uC,UC).call(t)}else if(t.callView){Cb(t,cC,OC).call(t,e)}if(a){Cb(t,hC,VC).call(t)}}))["catch"]((function(n){t.log("Attempt to get video (fallback: ".concat(Boolean(i),") for call before it has been created failed"),n);if(!i){Cb(t,lC,xC).call(t,e,true)}}))}function OC(e){var t=this.isLegacyCall(e);var i={stream:this.localStream,tag:"main",flipVideo:H.enableMirroring};if(e!==Tc.Plain||!t){var n=new yn({track:this.localStream.getVideoTracks()[0],kind:"video"});i.mediaRenderer=n;i.stream=n.stream}this.callView.setLocalStream(i)}function UC(){if(this.localStream){Yf.sendLog({description:"Stop local media stream"});Yf.stopMediaStream(this.localStream);this.localStream=null}}function FC(e){if(Cb(this,zb,kC).call(this)){return}var t=e.commonRecordState,i=e.userId;var n=t.state,a=t.userId;this.commonRecord.state=n;this.callView.setCommonRecordState(t);this.commonRecord.initiatorId=a;if(Yf.isCommonRecordStateInactive(n)){this.commonRecord.info=null;this.commonRecord.initiatorId=null}else{this.commonRecord.info=t}if(!this.commonRecord.notifyShowed&&n===Di.Started&&a!==this.userId){this.commonRecord.notifyShowed=true;this.callView.showCommonRecordStartNotify(a)}if(Yf.isCommonRecordStateInactive(n)&&a!==this.userId){this.commonRecord.notifyShowed=false}if(!Cb(this,Xb,CC).call(this)||i!==this.userId){return}var s=n===Di.Started&&a===this.userId;var r=n===Di.Stopped;if(s){var o;var l=this.getCallType();var c=this._getCallIdentifier(this.currentCall);var u=this.currentCall.associatedEntity,d=u.id,v=u.name;var f=((o=BX)===null||o===void 0?void 0:o.date.format(this.formatRecordDate))||BX.Main.Date.format(this.formatRecordDate);var m=p.Loc.getMessage("IM_CALL_RECORD_NAME");if(m){m=m.replace("#CHAT_TITLE#",v).replace("#CALL_ID#",c).replace("#DATE#",f)}else{m="call_record_".concat(c)}BX.ajax.runAction("call.Call.onStartRecord",{data:{callId:this.currentCall.id,callUuid:this.currentCall.uuid}});h.Analytics.getInstance().onRecordStart({callId:c,callType:l,recordType:this.commonRecord.type,errorCode:null});BXDesktopSystem.CallRecordStart({windowId:es.RecordSource.Chat,fileName:m,callId:c,callDate:f,dialogId:d,dialogName:v,video:this.commonRecord.type!==Hi.Audio,muted:H.isMicrophoneMuted,cropTop:72,cropBottom:90,shareMethod:"im.disk.record.share",callType:l});return}if(r){h.Analytics.getInstance().onRecordStop({callId:this._getCallIdentifier(this.currentCall),callType:this.getCallType(),subSection:h.Analytics.AnalyticsSubSection.window,element:h.Analytics.AnalyticsElement.recordButton,recordTime:Yf.getRecordTimeText(this.commonRecord.info,true)});Cb(this,Zb,_C).call(this)}}function VC(){H.getCurrentDeviceList()}function GC(e){return{id:this._getCallIdentifier(e),provider:e.provider,chatId:e.associatedEntity.id,userCount:e.users.length,browser:Yf.getBrowserForStatistics(),isMobile:p.Browser.isMobile(),isConference:false,wasConnected:e.wasConnected}}babelHelpers.defineProperty(vC,"FeatureState",wb);babelHelpers.defineProperty(vC,"Events",kb);babelHelpers.defineProperty(vC,"ViewState",yb);babelHelpers.defineProperty(vC,"DocumentType",Sb);I();BX.CallEngine=tu;e.UserListPopup=b.UserListPopup;e.UserList=C.UserList;e.JoinResponseError=Be;e.BackgroundDialog=T;e.Controller=vC;e.Engine=tu;e.Event=Ac;e.Hint=xm;e.State=kc;e.EngineLegacy=Jp;e.EndpointDirection=Sc;e.StartCallErrorCode=Ec;e.DisconnectReason=Rc;e.FloatingScreenShare=Hm;e.FloatingScreenShareContent=Nm;e.IncomingNotificationContent=km;e.NotificationConferenceContent=Rm;e.Hardware=H;e.Provider=Tc;e.Type=wc;e.UserState=yc;e.Util=Yf;e.VideoStrategy=sb;e.View=es;e.WebScreenSharePopup=Wm;e.CopilotPopup=ob;e.CallAI=kn;e.CallScheme=Bc;e.ParticipantsPermissionPopup=lb;e.CallMultiChannel=pc;e.CallCloudRecord=xi;e.CallCommonRecordType=Hi;e.CallCommonRecordState=Di;e.CloudRecordKind=Ee;e.CloudRecordStatus=_e})(this.BX.Call=this.BX.Call||{},BX.Messenger.Lib,BX.Call,BX.Messenger.v2.Lib,BX.UI.Dialogs,BX.UI,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX.Messenger.v2.Const,BX.Intranet,BX.Messenger.v2.Lib,BX.Call.Lib,BX.Call.Lib,BX,BX.Main,BX.Event,BX.UI,BX.Call.Lib,BX.Call.Component,BX.Call.Component,BX,BX,BX,BX.Messenger.Lib);
//# sourceMappingURL=call.bundle.map.js