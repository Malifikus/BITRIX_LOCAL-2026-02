{"version":3,"file":"clickable-user.bundle.js","sources":["../src/clickable-user.js"],"sourcesContent":["import { Type, Tag, Event, Dom, html } from 'main.core';\nimport './style.css';\nimport 'ui.icons';\n\ntype ClickableUserOptions = {\n\tid: number,\n\tname: string,\n\tphotoUrl: string,\n\tisSelected: boolean,\n\tisSingleUserColumn: boolean,\n\tfilterFieldId: string,\n\tgridId: string,\n\trootNodeId: string,\n};\n\nexport class ClickableUser\n{\n\t#id: number;\n\t#name: string;\n\t#photoUrl: string;\n\t#isSelected: boolean;\n\t#filterFieldName: string;\n\t#isSingleUserColumn: boolean;\n\t#isDisabled: boolean;\n\t#filterOptions: {};\n\t#filterManager: BX.Main.Filter;\n\t#rootNode: HTMLElement;\n\n\tconstructor(options: ClickableUserOptions)\n\t{\n\t\tconst rootNode = document.getElementById(options.rootNodeId);\n\t\tif (!rootNode)\n\t\t{\n\t\t\tthrow new Error(`Root node with id \"${options.rootNodeId}\" not found.`);\n\t\t}\n\n\t\tthis.#rootNode = rootNode;\n\n\t\tthis.#id = options.id;\n\t\tthis.#name = options.name;\n\t\tthis.#photoUrl = options.photoUrl;\n\t\tthis.#isSelected = options.isSelected;\n\n\t\tthis.#filterFieldName = options.filterFieldId;\n\t\tthis.#isSingleUserColumn = options.isSingleUserColumn;\n\n\t\tthis.#filterOptions = {\n\t\t\t[options.filterFieldId]: [options.id],\n\t\t\t[`${options.filterFieldId}_label`]: [options.name],\n\t\t};\n\n\t\tthis.#filterManager = BX.Main?.filterManager?.getById(options.gridId) ?? null;\n\n\t\tthis.#isDisabled = !this.#isSingleUserColumn || Type.isNull(this.#filterManager);\n\t}\n\n\trender(): void\n\t{\n\t\tconst imageStyle = this.#photoUrl === '' ? '' : `background-image: url(${this.#photoUrl});`;\n\n\t\tconst content = Tag.render`\n\t\t\t<span class=\"crm-grid-user-avatar ui-icon ui-icon-common-user\">\n\t\t\t\t<i style=\"${imageStyle}\"></i>\n\t\t\t</span>\n\t\t\t<span class=\"crm-grid-username-inner\">${this.#name}</span>\n\t\t\t<span class=\"crm-grid-filter-remove\"></span>\n\t\t`;\n\n\t\tlet contentClass = this.#isSelected ? 'crm-grid-username crm-grid-filter-active' : 'crm-grid-username';\n\t\tif (this.#isDisabled)\n\t\t{\n\t\t\tcontentClass = 'crm-grid-username--disabled';\n\t\t}\n\n\t\tconst wrapper = Tag.render`\n\t\t\t<a\n\t\t\t\tclass=\"${contentClass}\"\n\t\t\t\thref=\"\"\n\t\t\t\tbx-tooltip-user-id=\"${this.#id}\"\n\t\t\t\tbx-tooltip-context=\"b24\"\n\t\t\t>\n\t\t\t\t${content}\n\t\t\t</a>\n\t\t`;\n\n\t\tEvent.bind(wrapper, 'click', this.#onClick.bind(this));\n\n\t\tDom.append(wrapper, this.#rootNode);\n\t}\n\n\t#onClick(event: Event): void\n\t{\n\t\tevent.preventDefault();\n\t\tevent.stopPropagation();\n\n\t\tif (this.#isDisabled)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tthis.#toggleFilter();\n\t}\n\n\t#toggleFilter(): void\n\t{\n\t\tif (!this.#filterManager)\n\t\t{\n\t\t\tconsole.log('BX.Main.filterManager not initialized');\n\n\t\t\treturn;\n\t\t}\n\n\t\tif (this.#isSelected)\n\t\t{\n\t\t\tthis.#reduceFilter();\n\t\t}\n\t\telse\n\t\t{\n\t\t\tthis.#extendFilter();\n\t\t}\n\t}\n\n\t#reduceFilter(): void\n\t{\n\t\tconst reducedFields = this.#reduceCurrentFieldsValues();\n\n\t\tthis.#filterManager.getApi().setFields(reducedFields);\n\t\tthis.#filterManager.getSearch().apply();\n\t}\n\n\t#reduceCurrentFieldsValues(): Object\n\t{\n\t\tconst reducedOptions = this.#filterOptions;\n\t\tconst filterFieldsValues = this.#filterManager.getFilterFieldsValues();\n\n\t\tObject.entries(filterFieldsValues).forEach(([key, values]) => {\n\t\t\tif (Type.isArray(values) && key in reducedOptions)\n\t\t\t{\n\t\t\t\tif (this.#isSingleUserColumn)\n\t\t\t\t{\n\t\t\t\t\tfilterFieldsValues[key] = [];\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\tconst index = values.indexOf(reducedOptions[key][0].toString());\n\t\t\t\t\tfilterFieldsValues[key].splice(index, 1);\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\n\t\treturn filterFieldsValues;\n\t}\n\n\tasync #extendFilter(): void\n\t{\n\t\tconst extendedOptions = this.#extendCurrentFieldsValues();\n\n\t\tthis.#filterManager.showGridAnimation();\n\t\tawait this.#registerFieldToFilter();\n\n\t\tthis.#filterManager.getApi().extendFilter(extendedOptions);\n\t}\n\n\t#extendCurrentFieldsValues(): Object\n\t{\n\t\tconst extendedOptions = this.#filterOptions;\n\t\tconst filterFieldsValues = this.#filterManager.getFilterFieldsValues();\n\n\t\tObject.entries(this.#filterOptions).forEach(([key, values]) => {\n\t\t\tconst currentValues = filterFieldsValues[key];\n\n\t\t\tif (Type.isArray(currentValues) && Type.isArray(values))\n\t\t\t{\n\t\t\t\tif (this.#isSingleUserColumn)\n\t\t\t\t{\n\t\t\t\t\textendedOptions[key] = values;\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\tvalues.forEach((value) => {\n\t\t\t\t\t\tif (!currentValues.includes(value))\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tcurrentValues.push(value);\n\t\t\t\t\t\t\textendedOptions[key] = currentValues;\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\n\t\treturn extendedOptions;\n\t}\n\n\tasync #registerFieldToFilter(): void\n\t{\n\t\tconst presetFields = this.#filterManager.getPreset().getFields();\n\t\tconst oldFields = [];\n\n\t\tpresetFields.forEach((field) => {\n\t\t\toldFields.push(field.dataset.name);\n\t\t});\n\n\t\tconst newFields = oldFields.slice(this.#filterManager.params.FIELDS);\n\t\tnewFields.push(this.#filterFieldName);\n\n\t\tconst fieldsData = await this.#filterManager.fetchFields([this.#filterFieldName], oldFields);\n\n\t\tfieldsData.forEach((field) => this.#filterManager.params.FIELDS.push(field));\n\n\t\tconst fieldsForAdd = newFields.filter((field) => !oldFields.includes(field));\n\n\t\tconst disableSaveFieldsSort = true;\n\n\t\tfieldsForAdd.forEach((fieldId) => {\n\t\t\tconst field = fieldsData.find((item) => item.NAME === fieldId);\n\t\t\tif (field)\n\t\t\t{\n\t\t\t\tthis.#filterManager.getPreset().addField(field, disableSaveFieldsSort);\n\t\t\t\tif (Type.isString(field.HTML))\n\t\t\t\t{\n\t\t\t\t\tconst wrap = Tag.render`<div></div>`;\n\t\t\t\t\tDom.append(this.#filterManager.getHiddenElement(), wrap);\n\t\t\t\t\thtml(wrap, field.HTML);\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\n\t\tthis.#filterManager.saveFieldsSort();\n\t}\n}\n"],"names":["ClickableUser","options","rootNode","document","getElementById","rootNodeId","Error","id","name","photoUrl","isSelected","filterFieldId","isSingleUserColumn","BX","Main","filterManager","getById","gridId","Type","isNull","imageStyle","content","Tag","render","contentClass","wrapper","Event","bind","Dom","append","event","preventDefault","stopPropagation","console","log","reducedFields","getApi","setFields","getSearch","apply","reducedOptions","filterFieldsValues","getFilterFieldsValues","Object","entries","forEach","key","values","isArray","index","indexOf","toString","splice","extendedOptions","showGridAnimation","extendFilter","currentValues","value","includes","push","presetFields","getPreset","getFields","oldFields","field","dataset","newFields","slice","params","FIELDS","fetchFields","fieldsData","fieldsForAdd","filter","disableSaveFieldsSort","fieldId","find","item","NAME","addField","isString","HTML","wrap","getHiddenElement","html","saveFieldsSort"],"mappings":";;;;;;;;;CACA;CAAA;CAAA;CAAA;AADA,CAEkB;CAAA;CAAA;CAAA;CAAA;CAAA;CAAA;CAAA;CAAA;CAAA;CAAA;CAAA;CAAA;CAAA;CAAA;CAAA;CAAA;AAalB,KAAaA,aAAa;GAazB,uBAAYC,OAA6B,EACzC;KAAA;KAAA;KAAA;KAAA;KAAA;KAAA;KAAA;KAAA;KAAA;KAAA;OAAA;OAAA;;KAAA;OAAA;OAAA;;KAAA;OAAA;OAAA;;KAAA;OAAA;OAAA;;KAAA;OAAA;OAAA;;KAAA;OAAA;OAAA;;KAAA;OAAA;OAAA;;KAAA;OAAA;OAAA;;KAAA;OAAA;OAAA;;KAAA;OAAA;OAAA;;KACC,IAAMC,QAAQ,GAAGC,QAAQ,CAACC,cAAc,CAACH,OAAO,CAACI,UAAU,CAAC;KAC5D,IAAI,CAACH,QAAQ,EACb;OACC,MAAM,IAAII,KAAK,+BAAuBL,OAAO,CAACI,UAAU,mBAAe;;KAGxE,sCAAI,aAAaH,QAAQ;KAEzB,sCAAI,OAAOD,OAAO,CAACM,EAAE;KACrB,sCAAI,SAASN,OAAO,CAACO,IAAI;KACzB,sCAAI,aAAaP,OAAO,CAACQ,QAAQ;KACjC,sCAAI,eAAeR,OAAO,CAACS,UAAU;KAErC,sCAAI,oBAAoBT,OAAO,CAACU,aAAa;KAC7C,sCAAI,uBAAuBV,OAAO,CAACW,kBAAkB;KAErD,sCAAI,kGACFX,OAAO,CAACU,aAAa,EAAG,CAACV,OAAO,CAACM,EAAE,CAAC,gEACjCN,OAAO,CAACU,aAAa,aAAW,CAACV,OAAO,CAACO,IAAI,CAAC;KAGnD,sCAAI,uDAAkBK,EAAE,CAACC,IAAI,uEAAP,SAASC,aAAa,2DAAtB,uBAAwBC,OAAO,CAACf,OAAO,CAACgB,MAAM,CAAC,yEAAI,IAAI;KAE7E,sCAAI,eAAe,mCAAC,IAAI,sBAAoB,IAAIC,cAAI,CAACC,MAAM,mCAAC,IAAI,kBAAgB;;GAChF;KAAA;KAAA,yBAGD;OACC,IAAMC,UAAU,GAAG,sCAAI,iBAAe,EAAE,GAAG,EAAE,qEAA4B,IAAI,mBAAc;OAE3F,IAAMC,OAAO,GAAGC,aAAG,CAACC,MAAM,iUAEZH,UAAU,oCAEiB,IAAI,SAE5C;OAED,IAAII,YAAY,GAAG,sCAAI,iBAAe,0CAA0C,GAAG,mBAAmB;OACtG,sCAAI,IAAI,gBACR;SACCA,YAAY,GAAG,6BAA6B;;OAG7C,IAAMC,OAAO,GAAGH,aAAG,CAACC,MAAM,2PAEfC,YAAY,oCAEC,IAAI,QAGxBH,OAAO,CAEV;OAEDK,eAAK,CAACC,IAAI,CAACF,OAAO,EAAE,OAAO,EAAE,2BAAI,uBAAUE,IAAI,CAAC,IAAI,CAAC,CAAC;OAEtDC,aAAG,CAACC,MAAM,CAACJ,OAAO,oCAAE,IAAI,aAAW;;;GACnC;CAAA;CA6ID,mBA3ISK,KAAY,EACrB;GACCA,KAAK,CAACC,cAAc,EAAE;GACtBD,KAAK,CAACE,eAAe,EAAE;GAEvB,sCAAI,IAAI,gBACR;KACC;;GAGD,2BAAI,sCAAJ,IAAI;CACL;CAAC,0BAGD;GACC,IAAI,mCAAC,IAAI,iBAAe,EACxB;KACCC,OAAO,CAACC,GAAG,CAAC,uCAAuC,CAAC;KAEpD;;GAGD,sCAAI,IAAI,gBACR;KACC,2BAAI,sCAAJ,IAAI;IACJ,MAED;KACC,2BAAI,sCAAJ,IAAI;;CAEN;CAAC,0BAGD;GACC,IAAMC,aAAa,0BAAG,IAAI,gEAAJ,IAAI,CAA6B;GAEvD,sCAAI,kBAAgBC,MAAM,EAAE,CAACC,SAAS,CAACF,aAAa,CAAC;GACrD,sCAAI,kBAAgBG,SAAS,EAAE,CAACC,KAAK,EAAE;CACxC;CAAC,uCAGD;GAAA;GACC,IAAMC,cAAc,qCAAG,IAAI,iBAAe;GAC1C,IAAMC,kBAAkB,GAAG,sCAAI,kBAAgBC,qBAAqB,EAAE;GAEtEC,MAAM,CAACC,OAAO,CAACH,kBAAkB,CAAC,CAACI,OAAO,CAAC,gBAAmB;KAAA;OAAjBC,GAAG;OAAEC,MAAM;KACvD,IAAI7B,cAAI,CAAC8B,OAAO,CAACD,MAAM,CAAC,IAAID,GAAG,IAAIN,cAAc,EACjD;OACC,sCAAI,KAAI,wBACR;SACCC,kBAAkB,CAACK,GAAG,CAAC,GAAG,EAAE;QAC5B,MAED;SACC,IAAMG,KAAK,GAAGF,MAAM,CAACG,OAAO,CAACV,cAAc,CAACM,GAAG,CAAC,CAAC,CAAC,CAAC,CAACK,QAAQ,EAAE,CAAC;SAC/DV,kBAAkB,CAACK,GAAG,CAAC,CAACM,MAAM,CAACH,KAAK,EAAE,CAAC,CAAC;;;IAG1C,CAAC;GAEF,OAAOR,kBAAkB;CAC1B;CAAC;GAAA;CAAA;CAAA;GAAA;KAAA;KAAA;OAAA;SAAA;WAIMY,eAAe,0BAAG,IAAI,gEAAJ,IAAI;WAE5B,sCAAI,kBAAgBC,iBAAiB,EAAE;WAAC;WAAA,8BAClC,IAAI,wDAAJ,IAAI;SAAA;WAEV,sCAAI,kBAAgBlB,MAAM,EAAE,CAACmB,YAAY,CAACF,eAAe,CAAC;SAAC;SAAA;WAAA;;;;GAAA;CAAA;CAAA,uCAI5D;GAAA;GACC,IAAMA,eAAe,qCAAG,IAAI,iBAAe;GAC3C,IAAMZ,kBAAkB,GAAG,sCAAI,kBAAgBC,qBAAqB,EAAE;GAEtEC,MAAM,CAACC,OAAO,mCAAC,IAAI,kBAAgB,CAACC,OAAO,CAAC,iBAAmB;KAAA;OAAjBC,GAAG;OAAEC,MAAM;KACxD,IAAMS,aAAa,GAAGf,kBAAkB,CAACK,GAAG,CAAC;KAE7C,IAAI5B,cAAI,CAAC8B,OAAO,CAACQ,aAAa,CAAC,IAAItC,cAAI,CAAC8B,OAAO,CAACD,MAAM,CAAC,EACvD;OACC,sCAAI,MAAI,wBACR;SACCM,eAAe,CAACP,GAAG,CAAC,GAAGC,MAAM;QAC7B,MAED;SACCA,MAAM,CAACF,OAAO,CAAC,UAACY,KAAK,EAAK;WACzB,IAAI,CAACD,aAAa,CAACE,QAAQ,CAACD,KAAK,CAAC,EAClC;aACCD,aAAa,CAACG,IAAI,CAACF,KAAK,CAAC;aACzBJ,eAAe,CAACP,GAAG,CAAC,GAAGU,aAAa;;UAErC,CAAC;;;IAGJ,CAAC;GAEF,OAAOH,eAAe;CACvB;CAAC;GAAA;CAAA;CAAA;GAAA;KAAA;KAAA;KAAA;OAAA;SAAA;WAIMO,YAAY,GAAG,sCAAI,kBAAgBC,SAAS,EAAE,CAACC,SAAS,EAAE;WAC1DC,SAAS,GAAG,EAAE;WAEpBH,YAAY,CAACf,OAAO,CAAC,UAACmB,KAAK,EAAK;aAC/BD,SAAS,CAACJ,IAAI,CAACK,KAAK,CAACC,OAAO,CAACzD,IAAI,CAAC;YAClC,CAAC;WAEI0D,SAAS,GAAGH,SAAS,CAACI,KAAK,CAAC,sCAAI,kBAAgBC,MAAM,CAACC,MAAM,CAAC;WACpEH,SAAS,CAACP,IAAI,mCAAC,IAAI,oBAAkB;WAAC;WAAA,OAEb,sCAAI,kBAAgBW,WAAW,CAAC,mCAAC,IAAI,oBAAkB,EAAEP,SAAS,CAAC;SAAA;WAAtFQ,UAAU;WAEhBA,UAAU,CAAC1B,OAAO,CAAC,UAACmB,KAAK;aAAA,OAAK,wCAAI,kBAAgBI,MAAM,CAACC,MAAM,CAACV,IAAI,CAACK,KAAK,CAAC;aAAC;WAEtEQ,YAAY,GAAGN,SAAS,CAACO,MAAM,CAAC,UAACT,KAAK;aAAA,OAAK,CAACD,SAAS,CAACL,QAAQ,CAACM,KAAK,CAAC;aAAC;WAEtEU,qBAAqB,GAAG,IAAI;WAElCF,YAAY,CAAC3B,OAAO,CAAC,UAAC8B,OAAO,EAAK;aACjC,IAAMX,KAAK,GAAGO,UAAU,CAACK,IAAI,CAAC,UAACC,IAAI;eAAA,OAAKA,IAAI,CAACC,IAAI,KAAKH,OAAO;eAAC;aAC9D,IAAIX,KAAK,EACT;eACC,wCAAI,kBAAgBH,SAAS,EAAE,CAACkB,QAAQ,CAACf,KAAK,EAAEU,qBAAqB,CAAC;eACtE,IAAIxD,cAAI,CAAC8D,QAAQ,CAAChB,KAAK,CAACiB,IAAI,CAAC,EAC7B;iBACC,IAAMC,IAAI,GAAG5D,aAAG,CAACC,MAAM,8FAAa;iBACpCK,aAAG,CAACC,MAAM,CAAC,wCAAI,kBAAgBsD,gBAAgB,EAAE,EAAED,IAAI,CAAC;iBACxDE,cAAI,CAACF,IAAI,EAAElB,KAAK,CAACiB,IAAI,CAAC;;;YAGxB,CAAC;WAEF,sCAAI,kBAAgBI,cAAc,EAAE;SAAC;SAAA;WAAA;;;;GAAA;CAAA;;;;;;;;"}