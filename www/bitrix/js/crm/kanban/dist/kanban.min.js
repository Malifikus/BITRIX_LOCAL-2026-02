this.BX=this.BX||{};this.BX.Crm=this.BX.Crm||{};(function(e,t,i,a,s,n,r,l,o){"use strict";function c(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,a)}return i}function u(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?c(Object(i),!0).forEach((function(t){babelHelpers.defineProperty(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):c(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}function d(e,t){h(e,t);t.add(e)}function p(e,t,i){h(e,t);t.set(e,i)}function h(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}function v(e,t,i){if(!t.has(e)){throw new TypeError("attempted to get private field on non-instance")}return i}var f=r.Reflection.namespace("BX.CRM.Kanban.Actions");var b=new WeakMap;var m=new WeakMap;var S=new WeakMap;var g=new WeakMap;var E=new WeakMap;var y=new WeakMap;var T=new WeakSet;var P=new WeakSet;var A=new WeakSet;var C=new WeakSet;var I=new WeakSet;var F=new WeakSet;var w=new WeakSet;var D=new WeakSet;var k=new WeakSet;var H=new WeakSet;var _=new WeakSet;var M=function(){function e(t,i){babelHelpers.classCallCheck(this,e);d(this,_);d(this,H);d(this,k);d(this,D);d(this,w);d(this,F);d(this,I);d(this,C);d(this,A);d(this,P);d(this,T);p(this,b,{writable:true,value:void 0});p(this,m,{writable:true,value:void 0});p(this,S,{writable:true,value:true});p(this,g,{writable:true,value:false});p(this,E,{writable:true,value:false});p(this,y,{writable:true,value:null});babelHelpers.classPrivateFieldSet(this,b,t);babelHelpers.classPrivateFieldSet(this,m,i)}babelHelpers.createClass(e,[{key:"showNotify",value:function e(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:true;babelHelpers.classPrivateFieldSet(this,S,t);return this}},{key:"applyFilterAfterAction",value:function e(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:false;babelHelpers.classPrivateFieldSet(this,g,t);return this}},{key:"setIgnorePostfixForCode",value:function e(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:true;babelHelpers.classPrivateFieldSet(this,E,t);return this}},{key:"execute",value:function e(){var t=this;v(this,T,N).call(this);if(babelHelpers.classPrivateFieldGet(this,m).action==="status"){v(this,k,x).call(this)}return new Promise((function(e,i){babelHelpers.classPrivateFieldGet(t,b).ajax(babelHelpers.classPrivateFieldGet(t,m),(function(i){return v(t,P,O).call(t,i,e)}),(function(e){return v(t,D,W).call(t,e,i)}))}))}}]);return e}();function N(){if(babelHelpers.classPrivateFieldGet(this,b).isMultiSelectMode()){babelHelpers.classPrivateFieldGet(this,b).resetMultiSelectMode()}if(!r.Type.isStringFilled(babelHelpers.classPrivateFieldGet(this,m).eventId)&&s.QueueManager){babelHelpers.classPrivateFieldGet(this,m).eventId=s.QueueManager.registerRandomEventId()}}function O(e,t){if(!e||e.error){v(this,_,K).call(this,o.Dictionary.STATUS_ERROR);v(this,A,G).call(this,e,t)}else{v(this,_,K).call(this,o.Dictionary.STATUS_SUCCESS);v(this,C,L).call(this,e,t)}babelHelpers.classPrivateFieldSet(this,y,null)}function G(e,t){var i=babelHelpers.classPrivateFieldGet(this,b);var a=i.getData();var s=babelHelpers.classPrivateFieldGet(this,m);if(s.action==="status"){i.stopActionPanel();i.onApplyFilter();if(i.getTypeInfoParam("showPersonalSetStatusNotCompletedText")){var n=a.isDynamicEntity?"CRM_KANBAN_SET_STATUS_NOT_COMPLETED_TEXT_DYNAMIC_MSGVER_1":null;if(!n){var l="CRM_KANBAN_SET_STATUS_NOT_COMPLETED_TEXT_".concat(a.entityType);var o="".concat(l,"_MSGVER_1");var c="".concat(l,"_MSGVER_2");n=BX.Loc.hasMessage(c)?c:o}BX.Kanban.Utils.showErrorDialog(r.Loc.getMessage(n));t(new Error(r.Loc.getMessage(n)))}else{BX.Kanban.Utils.showErrorDialog(e.error,e.fatal);t(new Error(e.error))}}else{BX.Kanban.Utils.showErrorDialog(e.error,e.fatal);t(new Error(e.error))}}function L(e,t){var i=babelHelpers.classPrivateFieldGet(this,b);var a=babelHelpers.classPrivateFieldGet(this,m);if(babelHelpers.classPrivateFieldGet(this,g)){i.onApplyFilter()}i.stopActionPanel();if(babelHelpers.classPrivateFieldGet(this,S)){var s=i.getData().entityType;if(s.startsWith("DYNAMIC")){s="DYNAMIC"}if(a.action==="delete"&&a.ignore==="Y"){s="".concat(s,"_IGNORE")}else{s="".concat(s,"_").concat(a.action.toUpperCase())}v(this,I,B).call(this,s)}t(e)}function B(e){e=v(this,F,R).call(this,e);var i=v(this,w,U).call(this,e);if(r.Type.isStringFilled(i)){t.UI.Notification.Center.notify({content:i})}}function R(e){if(e==="DEAL_CHANGECATEGORY"){e="DEAL_CHANGECATEGORY_LINK2"}else if(e==="DYNAMIC_CHANGECATEGORY"){e="DYNAMIC_CHANGECATEGORY_LINK2"}e="CRM_KANBAN_NOTIFY_".concat(e);var t=["CRM_KANBAN_NOTIFY_LEAD_STATUS","CRM_KANBAN_NOTIFY_DYNAMIC_STATUS","CRM_KANBAN_NOTIFY_INVOICE_STATUS","CRM_KANBAN_NOTIFY_QUOTE_DELETE","CRM_KANBAN_NOTIFY_QUOTE_SETASSIGNED"];if(t.includes(e)){e="".concat(e,"_MSGVER_1")}var i=["CRM_KANBAN_NOTIFY_QUOTE_STATUS"];if(i.includes(e)){e="".concat(e,"_MSGVER_2")}return e}function U(e){var t=r.Loc.getMessage(e);if(!r.Type.isStringFilled(t)){return null}var i=babelHelpers.classPrivateFieldGet(this,m);if(r.Type.isPlainObject(i)){Object.entries(i).forEach((function(e){t=t.replace("#".concat(e[0],"#"),e[1])}))}return t}function W(e,t){v(this,_,K).call(this,o.Dictionary.STATUS_ERROR);babelHelpers.classPrivateFieldSet(this,y,null);BX.Kanban.Utils.showErrorDialog("Error: ".concat(e),true);t(new Error(e))}function x(){var e;var t=(e=babelHelpers.classPrivateFieldGet(this,b).getColumn(babelHelpers.classPrivateFieldGet(this,m).status))!==null&&e!==void 0?e:babelHelpers.classPrivateFieldGet(this,b).getDropZoneArea().getDropZone(babelHelpers.classPrivateFieldGet(this,m).status);var i=t?t.getData().type:babelHelpers.classPrivateFieldGet(this,m).type;if(i==="PROGRESS"){babelHelpers.classPrivateFieldSet(this,y,o.Builder.Entity.ChangeStageEvent.createDefault(babelHelpers.classPrivateFieldGet(this,m).entity_type,babelHelpers.classPrivateFieldGet(this,m).entity_id.length).setSubSection(o.Dictionary.SUB_SECTION_KANBAN).setElement(o.Dictionary.ELEMENT_GRID_ROW_CONTEXT_MENU).buildData())}else{v(this,H,X).call(this)}}function X(){var e;var t=babelHelpers.slicedToArray(babelHelpers.classPrivateFieldGet(this,m).entity_id,1),i=t[0];var a=babelHelpers.classPrivateFieldGet(this,b).getItem(i);var s=(e=babelHelpers.classPrivateFieldGet(this,b).getColumn(babelHelpers.classPrivateFieldGet(this,m).status))!==null&&e!==void 0?e:babelHelpers.classPrivateFieldGet(this,b).getDropZoneArea().getDropZone(babelHelpers.classPrivateFieldGet(this,m).status);var n=s?s.getData().type:babelHelpers.classPrivateFieldGet(this,m).type;babelHelpers.classPrivateFieldSet(this,y,babelHelpers.classPrivateFieldGet(this,b).getDefaultAnalyticsCloseEvent(a,n,babelHelpers.classPrivateFieldGet(this,m).entity_id.toString()));babelHelpers.classPrivateFieldGet(this,y).c_element=o.Dictionary.ELEMENT_WON_TOP_ACTIONS;if(n==="LOOSE"){babelHelpers.classPrivateFieldGet(this,y).c_element=o.Dictionary.ELEMENT_LOSE_TOP_ACTIONS}}function K(e){if(!babelHelpers.classPrivateFieldGet(this,y)){return}BX.UI.Analytics.sendData(u(u({},babelHelpers.classPrivateFieldGet(this,y)),{},{status:e}))}f.SimpleAction=M;function j(e,t){V(e,t);t.add(e)}function Y(e,t,i){V(e,t);t.set(e,i)}function V(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}function Q(e,t,i){if(!t.has(e)){throw new TypeError("attempted to get private field on non-instance")}return i}var z=r.Reflection.namespace("BX.CRM.Kanban.Actions");var q=new WeakMap;var Z=new WeakMap;var J=new WeakMap;var $=new WeakMap;var ee=new WeakMap;var te=new WeakMap;var ie=new WeakMap;var ae=new WeakSet;var se=new WeakSet;var ne=new WeakSet;var re=new WeakSet;var le=new WeakSet;var oe=new WeakSet;var ce=new WeakSet;var ue=new WeakSet;var de=new WeakSet;var pe=new WeakSet;var he=new WeakSet;var ve=function(){function e(t,i){babelHelpers.classCallCheck(this,e);j(this,he);j(this,pe);j(this,de);j(this,ue);j(this,ce);j(this,oe);j(this,le);j(this,re);j(this,ne);j(this,se);j(this,ae);Y(this,q,{writable:true,value:void 0});Y(this,Z,{writable:true,value:void 0});Y(this,J,{writable:true,value:null});Y(this,$,{writable:true,value:[]});Y(this,ee,{writable:true,value:void 0});Y(this,te,{writable:true,value:void 0});Y(this,ie,{writable:true,value:M});babelHelpers.classPrivateFieldSet(this,q,t);if(!r.Type.isArrayFilled(i.ids)){throw new Error("Param ids must be filled array")}babelHelpers.classPrivateFieldSet(this,$,i.ids);babelHelpers.classPrivateFieldSet(this,ee,r.Type.isBoolean(i.showNotify)?i.showNotify:true);babelHelpers.classPrivateFieldSet(this,te,r.Type.isBoolean(i.applyFilterAfterAction)?i.applyFilterAfterAction:false)}babelHelpers.createClass(e,[{key:"setDropZone",value:function e(t){babelHelpers.classPrivateFieldSet(this,Z,t);return this}},{key:"execute",value:function e(){var t=this;var i={action:"delete",id:babelHelpers.classPrivateFieldGet(this,$)};new(babelHelpers.classPrivateFieldGet(this,ie))(babelHelpers.classPrivateFieldGet(this,q),i).showNotify(babelHelpers.classPrivateFieldGet(this,ee)).applyFilterAfterAction(babelHelpers.classPrivateFieldGet(this,te)).execute().then((function(e){return Q(t,ae,fe).call(t,e)}),(function(e){return Q(t,he,Ce).call(t,e)}))["catch"]((function(){Q(t,de,Pe).call(t)}))}}]);return e}();function fe(e){var t=babelHelpers.classPrivateFieldGet(this,Z);if(t){Q(this,ne,me).call(this)}Q(this,re,Se).call(this);Q(this,le,ge).call(this,e);Q(this,oe,Ee).call(this,e)}function be(){var e=this;if(babelHelpers.classPrivateFieldGet(this,J)===null){var t=babelHelpers.classPrivateFieldGet(this,q);var i=babelHelpers.classPrivateFieldGet(this,$);i.forEach((function(i){var a=t.getItem(i);if(a){if(babelHelpers.classPrivateFieldGet(e,J)===null){babelHelpers.classPrivateFieldSet(e,J,[])}babelHelpers.classPrivateFieldGet(e,J).push(a)}}))}return babelHelpers.classPrivateFieldGet(this,J)}function me(){var e=babelHelpers.classPrivateFieldGet(this,Z);e.empty();e.getDropZoneArea().hide();e.droppedItems=[]}function Se(){var e=babelHelpers.classPrivateFieldGet(this,q);e.dropZonesShow=false;e.resetMultiSelectMode();e.resetActionPanel();e.resetDragMode()}function ge(e){var i=this;var a=Q(this,se,be).call(this);var s=e.deletedIds,n=e.errors;var l=a.filter((function(e){return!s.includes(Number(e.getId()))}));if(r.Type.isArrayFilled(l)){l.forEach((function(e){return Q(i,pe,Ae).call(i,e)}));n.forEach((function(e){var a=e.message,s=e.data.id;t.UI.Notification.Center.notify({content:a,actions:[{title:r.Loc.getMessage("CRM_KANBAN_OPEN_ITEM"),events:{click:function e(){BX.fireEvent(babelHelpers.classPrivateFieldGet(i,q).getItem(s).link,"click")}}}]})}))}}function Ee(e){var i=this;var a=Q(this,se,be).call(this);var s=e.deletedIds;var n=a.filter((function(e){return s.includes(Number(e.getId()))}));if(!r.Type.isArrayFilled(n)){return}var l={content:Q(this,ce,ye).call(this,n)};var o=babelHelpers.classPrivateFieldGet(this,q);if(o.getTypeInfoParam("isRecyclebinEnabled")){l.actions=[{title:r.Loc.getMessage("CRM_KANBAN_DELETE_CANCEL"),events:{click:function e(){return Q(i,ue,Te).call(i,c,n)}}}]}var c=t.UI.Notification.Center.notify(l)}function ye(e){var t=babelHelpers.classPrivateFieldGet(this,$);if(t.length===1){return r.Loc.getMessage("CRM_KANBAN_DELETE_SUCCESS",{"#ELEMENT_NAME#":e[0].getData().name})}var i=t.length-e.length;if(i===0){return r.Loc.getMessage("CRM_KANBAN_DELETE_SUCCESS_MULTIPLE")}return r.Loc.getMessage("CRM_KANBAN_DELETE_SUCCESS_MULTIPLE_WITH_ERRORS",{"#COUNT#":i})}function Te(e,i){var a=this;e.close();var s=babelHelpers.classPrivateFieldGet(this,q);var n=babelHelpers.classPrivateFieldGet(this,$);var l=s.getData(),o=l.entityTypeInt;r.ajax.runComponentAction("bitrix:crm.kanban","restore",{mode:"ajax",data:{entityIds:n,entityTypeId:o}}).then((function(e){var i=e.data;if(!r.Type.isPlainObject(i)){return}var s=Object.values(i).filter((function(e){return r.Type.isNumber(e)}));if(r.Type.isArrayFilled(s)){babelHelpers.classPrivateFieldGet(a,q).loadNew(s,false,true,true,true).then((function(e){var i=6e3;t.UI.Notification.Center.notify({content:r.Loc.getMessage("CRM_KANBAN_DELETE_RESTORE_SUCCESS"),autoHideDelay:i})}),(function(){Q(a,de,Pe).call(a)}))["catch"]((function(){Q(a,de,Pe).call(a)}))}}),(function(e){return Q(a,he,Ce).call(a,e)}))["catch"]((function(){Q(a,de,Pe).call(a)}))}function Pe(){t.UI.Notification.Center.notify({content:r.Loc.getMessage("CRM_KANBAN_ACTION_ERROR")})}function Ae(e){var t=e.getLastPosition();if(!t.columnId){return}var i=e.getData();i.columnId=t.columnId;i.targetId=t.targetId;var a=babelHelpers.classPrivateFieldGet(this,q);var s=parseFloat(i.price);a.getColumn(e.columnId).incPrice(s);a.updateItem(e.getId(),i);a.unhideItem(e)}function Ce(e){var i=e.errors[0].message;t.UI.Notification.Center.notify({content:i})}z.DeleteAction=ve;var Ie,Fe,we,De,ke,He,_e,Me,Ne,Oe;var Ge="view";var Le="edit";var Be=function(){function e(t){var i,a;babelHelpers.classCallCheck(this,e);this.popup=null;this.fields=null;this.fieldsPopupItems=null;this.options=t;this.type=this.options.hasOwnProperty("type")?this.options.type:Ge;this.selectedFields=this.options.hasOwnProperty("selectedFields")?this.options.selectedFields.slice(0):[];this.enableHeadersSections=Boolean(this.options.headersSections);this.headersSections=(i=this.options.headersSections)!==null&&i!==void 0?i:{};this.defaultHeaderSectionId=(a=this.options.defaultHeaderSectionId)!==null&&a!==void 0?a:null;this.fieldVisibleClass="crm-kanban-popup-field-search-list-item-visible";this.fieldHiddenClass="crm-kanban-popup-field-search-list-item-hidden"}babelHelpers.createClass(e,[{key:"show",value:function e(){if(!this.popup){this.popup=this.createPopup()}if(this.fields){this.popup.setContent(this.getFieldsLayout())}else{this.loadPopupContent(this.popup)}this.popup.show()}},{key:"createPopup",value:function e(){var a=this;return i.PopupManager.create({id:"kanban_custom_fields_"+this.type,className:"crm-kanban-popup-field",titleBar:r.Loc.getMessage("CRM_KANBAN_CUSTOM_FIELDS_"+this.type.toUpperCase()),cacheable:false,closeIcon:true,lightShadow:true,overlay:true,draggable:true,closeByEsc:true,contentColor:"white",maxHeight:window.innerHeight-50,events:{onClose:function e(){a.fieldsPopupItems=null;a.popup=null}},buttons:[new BX.UI.SaveButton({color:BX.UI.Button.Color.PRIMARY,state:this.fields?"":BX.UI.Button.State.DISABLED,onclick:function e(){var i=a.fields?a.fields.filter((function(e){return a.selectedFields.indexOf(e.NAME)>=0})):[];if(i.length){a.popup.close();a.executeCallback(i)}else{t.UI.Notification.Center.notify({content:r.Loc.getMessage("CRM_KANBAN_POPUP_AT_LEAST_ONE_FIELD"),autoHide:true,autoHideDelay:2e3})}}}),new BX.UI.CancelButton({onclick:function e(){a.popup.close()}})]})}},{key:"loadPopupContent",value:function e(t){var i=this;var a=r.Tag.render(Ie||(Ie=babelHelpers.taggedTemplateLiteral(['<div class="crm-kanban-popup-field-loader"></div>'])));var s=new BX.Loader({target:a,size:80});s.show();t.setContent(a);BX.ajax.runComponentAction("bitrix:crm.kanban","getFields",{mode:"ajax",data:{entityType:this.options.entityTypeName,viewType:this.type}}).then((function(e){s.destroy();i.fields=e.data;t.setContent(i.getFieldsLayout());t.getButtons().forEach((function(e){return e.setDisabled(false)}));t.adjustPosition()}))["catch"]((function(e){BX.Kanban.Utils.showErrorDialog(e.errors.pop().message)}));return t}},{key:"getFieldsLayout",value:function e(){var t=this;var i=this.distributeFieldsBySections(this.fields);var a=r.Tag.render(Fe||(Fe=babelHelpers.taggedTemplateLiteral(['<div class="crm-kanban-popup-field"></div>'])));var s=r.Tag.render(we||(we=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="crm-kanban-popup-field-search-header-wrapper">\n\t\t\t\t<div class="ui-form-row-inline"></div>\n\t\t\t</div>\n\t\t'])));a.prepend(s);this.preparePopupContentHeaderSections(s);this.preparePopupContentHeaderSearch(s);this.getSections().map((function(e){var s=t.getSectionWrapperNameBySectionName(e.name);var n=r.Tag.render(De||(De=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<div \n\t\t\t\t\tclass="crm-kanban-popup-field-search-section" \n\t\t\t\t\tdata-crm-kanban-popup-field-search-section="','">\n\t\t\t\t</div>\n\t\t\t'])),s);r.Dom.append(n,a);var l=e.name;if(i.hasOwnProperty(l)&&i[l].length){r.Dom.append(r.Tag.render(ke||(ke=babelHelpers.taggedTemplateLiteral(['<div class="crm-kanban-popup-field-title">',"</div>"])),r.Text.encode(e.title)),n);r.Dom.append(r.Tag.render(He||(He=babelHelpers.taggedTemplateLiteral(['<div class="crm-kanban-popup-field-wrapper">\n\t\t\t\t\t\t',"\n\t\t\t\t\t</div>"])),i[l].map((function(i){var a=i.LABEL;if(!a.length&&e["elements"]&&e["elements"][i.NAME]&&e["elements"][i.NAME]["title"]&&e["elements"][i.NAME]["title"].length){a=e["elements"][i.NAME]["title"]}var s=r.Text.encode(a);return r.Tag.render(_e||(_e=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t\t\t\t\t<div class="crm-kanban-popup-field-item" title="','">\n\t\t\t\t\t\t\t\t\t<input \n\t\t\t\t\t\t\t\t\t\tid="cf_','" \n\t\t\t\t\t\t\t\t\t\ttype="checkbox" \n\t\t\t\t\t\t\t\t\t\tname="','"\n\t\t\t\t\t\t\t\t\t\tclass="crm-kanban-popup-field-item-input"\n\t\t\t\t\t\t\t\t\t\tdata-label="','"\n\t\t\t\t\t\t\t\t\t\t','\n\t\t\t\t\t\t\t\t\t\tonclick="','"\n\t\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t\t<label for="cf_','" class="crm-kanban-popup-field-item-label">\n\t\t\t\t\t\t\t\t\t\t',"\n\t\t\t\t\t\t\t\t\t</label>\n\t\t\t\t\t\t\t\t</div>"])),s,r.Text.encode(i.ID),r.Text.encode(i.NAME),s,t.selectedFields.indexOf(i.NAME)>=0?"checked":"",t.onFieldClick.bind(t),r.Text.encode(i.ID),s)}))),n)}}));return a}},{key:"preparePopupContentHeaderSections",value:function e(t){if(!this.enableHeadersSections){return}var i=r.Tag.render(Me||(Me=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="ui-form-row">\n\t\t\t\t<div class="ui-form-content crm-kanban-popup-field-search-section-wrapper"></div>\n\t\t\t</div>\n\t\t'])));t.firstElementChild.appendChild(i);var a=this.getHeadersSections();for(var s in a){var n="crm-kanban-popup-field-search-section-item-icon"+(a[s].selected?" crm-kanban-popup-field-search-section-item-icon-active":"");var l=r.Tag.render(Ne||(Ne=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<div class="crm-kanban-popup-field-search-section-item" data-kanban-popup-filter-section-button="','">\n\t\t\t\t\t<div class="','">\n\t\t\t\t\t\t',"\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t"])),s,n,r.Text.encode(a[s].name));i.firstElementChild.appendChild(l);if(this.type!==Ge){break}r.Event.bind(l,"click",this.onFilterSectionClick.bind(this,l))}}},{key:"onFilterSectionClick",value:function e(t){var i="crm-kanban-popup-field-search-section-item-icon-active";var a=t.dataset.kanbanPopupFilterSectionButton;var s=document.querySelectorAll('[data-crm-kanban-popup-field-search-section="'.concat(a,'"]'));if(r.Dom.hasClass(t.firstElementChild,i)){r.Dom.removeClass(t.firstElementChild,i);this.filterSectionsToggle(s,"hide")}else{r.Dom.addClass(t.firstElementChild,i);this.filterSectionsToggle(s,"show")}}},{key:"filterSectionsToggle",value:function e(t,i){Array.from(t).map((function(e){i==="show"?r.Dom.show(e):r.Dom.hide(e)}))}},{key:"preparePopupContentHeaderSearch",value:function e(t){var i=r.Tag.render(Oe||(Oe=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="ui-form-row">\n\t\t\t\t<div class="ui-form-content crm-kanban-popup-field-search-input-wrapper">\n\t\t\t\t\t<div class="ui-ctl ui-ctl-textbox ui-ctl-before-icon ui-ctl-after-icon">\n\t\t\t\t\t\t<div class="ui-ctl-before ui-ctl-icon-search"></div>\n\t\t\t\t\t\t<button class="ui-ctl-after ui-ctl-icon-clear"></button>\n\t\t\t\t\t\t<input type="text" class="ui-ctl-element crm-kanban-popup-field-search-section-input">\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t'])));t.firstElementChild.appendChild(i);var a=i.getElementsByClassName("crm-kanban-popup-field-search-section-input");if(a.length){var s=a[0];r.Event.bind(s,"input",this.onFilterSectionSearchInput.bind(this,s));r.Event.bind(s.previousElementSibling,"click",this.onFilterSectionSearchInputClear.bind(this,s))}}},{key:"onFilterSectionSearchInput",value:function e(t){var i=this;var a=t.value;if(a.length){a=a.toLowerCase()}this.getFieldsPopupItems().map((function(e){var t=e.innerText.toLowerCase();if(a.length&&t.indexOf(a)===-1){r.Dom.removeClass(e,i.fieldVisibleClass);r.Dom.addClass(e,i.fieldHiddenClass)}else{r.Dom.removeClass(e,i.fieldHiddenClass);r.Dom.addClass(e,i.fieldVisibleClass);e.style.display="block"}}))}},{key:"getFieldsPopupItems",value:function e(){if(!r.Type.isArray(this.fieldsPopupItems)){this.fieldsPopupItems=Array.from(this.popup.getPopupContainer().querySelectorAll(".crm-kanban-popup-field-item"));this.prepareAnimation()}return this.fieldsPopupItems}},{key:"prepareAnimation",value:function e(){var t=this;this.fieldsPopupItems.map((function(e){r.Event.bind(e,"animationend",t.onAnimationEnd.bind(t,e))}))}},{key:"onAnimationEnd",value:function e(t){t.style.display=r.Dom.hasClass(t,this.fieldHiddenClass)?"none":"block"}},{key:"onFilterSectionSearchInputClear",value:function e(t){if(t.value.length){t.value="";this.onFilterSectionSearchInput(t)}}},{key:"getSectionWrapperNameBySectionName",value:function e(t){var i=this.getHeadersSections();for(var a in i){if(this.headersSections[a].sections&&this.headersSections[a].sections.includes(t)){return this.headersSections[a].id}}return this.headersSections[this.defaultHeaderSectionId]&&this.defaultHeaderSectionId?this.headersSections[this.defaultHeaderSectionId].id:null}},{key:"getHeadersSections",value:function e(){var t;return(t=this.headersSections)!==null&&t!==void 0?t:{}}},{key:"distributeFieldsBySections",value:function e(t){var i=this.getIgnoredFields();t=t.filter((function(e){return!(i.hasOwnProperty(e.NAME)&&i[e.NAME])}));var a={};var s="";var n=this.options.hasOwnProperty("sections")?this.options.sections:[];for(var l=0;l<n.length;l++){var o=n[l];var c=o.name;a[c]=[];if(r.Type.isPlainObject(o.elements)){a[c]=this.filterFieldsByList(t,o.elements)}else if(o.hasOwnProperty("elementsRule")){a[c]=this.filterFieldsByRule(t,new RegExp(o.elementsRule))}else if(o.elements==="*"){s=c}}if(s!==""){a[s]=this.filterNotUsedFields(t,a)}return a}},{key:"filterFieldsByList",value:function e(t,i){return t.filter((function(e){return i.hasOwnProperty(e.NAME)}))}},{key:"filterFieldsByRule",value:function e(t,i){return t.filter((function(e){return e.NAME.match(i)}))}},{key:"filterNotUsedFields",value:function e(t,i){var a=Object.values(i).reduce((function(e,t){return e.concat(t.map((function(e){return e.NAME})))}),[]);return t.filter((function(e){return a.indexOf(e.NAME)<0}))}},{key:"getSections",value:function e(){return this.options.hasOwnProperty("sections")?this.options.sections:[]}},{key:"getIgnoredFields",value:function e(){var t=Object.assign({},this.options.ignoredFields);var i=[];if(this.type===Le){i=["ID","CLOSED","DATE_CREATE","DATE_MODIFY","COMMENTS","OPPORTUNITY"]}else{i=["PHONE","EMAIL","WEB","IM"]}i.forEach((function(e){return t[e]=true}));return t}},{key:"executeCallback",value:function e(t){if(!this.options.hasOwnProperty("onSelect")||!r.Type.isFunction(this.options.onSelect)){return}var i={};t.forEach((function(e){i[e.NAME]=e.LABEL?e.LABEL:""}));this.options.onSelect(i)}},{key:"onFieldClick",value:function e(t){var i=t.target.name;if(t.target.checked&&this.selectedFields.indexOf(i)<0){this.selectedFields.push(i)}if(!t.target.checked&&this.selectedFields.indexOf(i)>=0){this.selectedFields.splice(this.selectedFields.indexOf(i),1)}}}]);return e}();var Re={MODE_STAGES:"STAGES",MODE_ACTIVITIES:"ACTIVITIES",MODE_DEADLINES:"DEADLINES",getDefault:function e(){return this.MODE_STAGES},getAll:function e(){return[this.MODE_STAGES,this.MODE_ACTIVITIES,this.MODE_DEADLINES]},normalize:function e(t){return this.getAll().includes(t)?t:this.getDefault()}};Object.freeze(Re);var Ue=function(){babelHelpers.createClass(e,null,[{key:"createInstance",value:function t(i){return new e(i.grid).setItemId(i.itemId).setAction(i.action).setActionParams(i.actionParams)}}]);function e(t){babelHelpers.classCallCheck(this,e);this.grid=t}babelHelpers.createClass(e,[{key:"setItemId",value:function e(t){this.itemId=t;return this}},{key:"getItemId",value:function e(){return this.itemId}},{key:"setAction",value:function e(t){this.action=t;return this}},{key:"getAction",value:function e(){return this.action}},{key:"setActionParams",value:function e(t){this.actionParams=t;return this}},{key:"getActionParams",value:function e(){return this.actionParams}},{key:"execute",value:function e(){var t=this.getAction();if(t==="updateItem"){this.updateItem();return}if(t==="addItem"){this.addItem()}}},{key:"updateItem",value:function e(){var t,i,a;var s=this.getActionParams();var n=this.grid.getItem(s.item.id);var l=s.item;if(!n){return}var o=this.grid.getData(),c=o.viewMode;if([Re.MODE_ACTIVITIES,Re.MODE_DEADLINES].includes(c)){n.useAnimation=false;this.grid.insertItem(n);return}var u={};var d=l.data,p=d.lastActivity,h=d.columnId,v=d.price;if(r.Type.isObjectLike(p)&&p.timestamp!==n.data.lastActivity.timestamp){u.canShowLastActivitySortTour=true}var f=parseFloat(n.data.price);var b=n.columnId;for(var m in l.data){if(m in n.data){n.data[m]=l.data[m]}}n.rawData=l.rawData;n.setActivityExistInnerHtml();n.useAnimation=true;n.setChangedInPullRequest();this.grid.resetMultiSelectMode();var S=this.grid.getColumn(h);var g=parseFloat(v);u.newColumnId=h;this.grid.insertItem(n,u);n.columnId=h;if(!this.grid.getTypeInfoParam("showTotalPrice")){return}if(b===h){if(f<g){S.incPrice(g-f);S.renderSubTitle()}else if(f>g){S.decPrice(f-g);S.renderSubTitle()}return}var E=(t=(i=this.grid.itemMoving)===null||i===void 0?void 0:(a=i.dropEvent)===null||a===void 0?void 0:a.groupIds)!==null&&t!==void 0?t:[];if(!E.includes(n.id)){var y=this.grid.getColumn(b);y.decPrice(f);y.renderSubTitle()}if(S){S.incPrice(g);S.renderSubTitle()}}},{key:"addItem",value:function e(){var t=this.getActionParams();var i=this.grid.getItem(t.item.id);if(i){return}var a=this.grid.getColumn(t.item.data.columnId);if(!a){return}var s=n.Sorter.createWithCurrentSortType(a.getItems());var r=s.calcBeforeItemByParams(t.item.data.sort);if(r){t.item.targetId=r.getId()}this.grid.addItem(t.item)}}]);return e}();function We(e,t){xe(e,t);t.add(e)}function xe(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}function Xe(e,t,i){if(!t.has(e)){throw new TypeError("attempted to get private field on non-instance")}return i}var Ke={itemUpdated:"ITEMUPDATED",itemAdded:"ITEMADDED",itemDeleted:"ITEMDELETED",stageAdded:"STAGEADDED",stageUpdated:"STAGEUPDATED",stageDeleted:"STAGEDELETED"};var je=new WeakSet;var Ye=new WeakSet;var Ve=new WeakSet;var Qe=new WeakSet;var ze=new WeakSet;var qe=new WeakSet;var Ze=new WeakSet;var Je=new WeakSet;var $e=new WeakSet;var et=new WeakSet;var tt=new WeakSet;var it=function e(t){var i,a=this;babelHelpers.classCallCheck(this,e);We(this,tt);We(this,et);We(this,$e);We(this,Je);We(this,Ze);We(this,qe);We(this,ze);We(this,Qe);We(this,Ve);We(this,Ye);We(this,je);if(!BX.PULL){console.info("BX.PULL is not initialized");return}this.grid=t;var n=t.getData();var r={moduleId:n.moduleId,pullTag:n.pullTag,additionalPullTags:(i=n.additionalPullTags)!==null&&i!==void 0?i:[],userId:n.userId,additionalData:{viewMode:n.viewMode},events:{onBeforePull:function e(t){Xe(a,Qe,rt).call(a,t)},onPull:function e(t){Xe(a,ze,lt).call(a,t)}},callbacks:{onBeforeQueueExecute:function e(t){return Xe(a,je,at).call(a,t)},onQueueExecute:function e(t){return Xe(a,Ye,st).call(a,t)},onReload:function e(){Xe(a,Ve,nt).call(a)}}};this.queueManager=new s.QueueManager(r)};function at(e){var t=this;e.forEach((function(e){var i=e.data;var a=Ue.createInstance({grid:t.grid,itemId:i.id,action:i.action,actionParams:i.actionParams});a.execute()}));return Promise.resolve()}function st(e){var t=[];e.forEach((function(e){var i=e.id,a=e.data.action;if(a==="addItem"||a==="updateItem"){t.push(parseInt(i,10))}}));if(t.length===0){return Promise.resolve()}return this.grid.loadNew(t,false,true,true,true)}function nt(){this.grid.reload()}function rt(e){var t=e.data,i=t.options,a=t.pullData;if(!a.command.startsWith(i.pullTag)&&i.additionalData.viewMode!==Re.MODE_ACTIVITIES){e.preventDefault()}}function lt(e){var t=e.data.pullData.params;if(t.eventName===Ke.itemUpdated){Xe(this,qe,ot).call(this,e);return}if(t.eventName===Ke.itemAdded){Xe(this,Ze,ct).call(this,e);return}if(t.eventName===Ke.itemDeleted){Xe(this,$e,dt).call(this,e);return}if(t.eventName===Ke.stageAdded){Xe(this,et,pt).call(this,e);return}if(t.eventName===Ke.stageUpdated){Xe(this,et,pt).call(this,e);return}if(t.eventName===Ke.stageDeleted){Xe(this,tt,ht).call(this,e)}}function ot(e){var t=e.data,i=t.pullData.params,a=t.promises;var s=this.grid.getItem(i.item.id);if(s){a.push(Promise.resolve({data:Xe(this,Je,ut).call(this,"updateItem",i)}));return}i.eventName=Ke.itemAdded;Xe(this,Ze,ct).call(this,e)}function ct(e){var t=e.data,i=t.pullData.params,a=t.promises;var s=i.item.id;var n=this.grid.getItem(s);if(n){e.preventDefault();return}a.push(Promise.resolve({data:Xe(this,Je,ut).call(this,"addItem",i)}))}function ut(e,t){var i=t.item.id;return{id:i,action:e,actionParams:t}}function dt(e){var t=this;var i=e.data.pullData.params;if(!r.Type.isPlainObject(i.item)){return}var a=i.item,s=a.id,n=a.data.columnId;var l=this.queueManager.hasInQueue(s)?this.queueManager.getLoadItemsDelay():0;setTimeout((function(){t.queueManager.deleteFromQueue(s);var e=t.grid;var i=e.getItem(s);if(!i){return}e.removeItem(s);if(e.getTypeInfoParam("showTotalPrice")){var a=e.getColumn(n);a.decPrice(i.data.price);a.renderSubTitle()}}),l);e.preventDefault()}function pt(e){e.preventDefault();this.grid.onApplyFilter()}function ht(e){e.preventDefault();var t=e.data.pullData.params;this.grid.removeColumn(t.stage.id)}function vt(e,t,i){ft(e,t);t.set(e,i)}function ft(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}var bt=r.Reflection.namespace("BX.CRM.Kanban.Analytics");var mt=new WeakMap;var St=new WeakMap;var gt=new WeakMap;var Et=new WeakMap;var yt=function(){function e(t){babelHelpers.classCallCheck(this,e);vt(this,mt,{writable:true,value:void 0});vt(this,St,{writable:true,value:void 0});vt(this,gt,{writable:true,value:void 0});vt(this,Et,{writable:true,value:void 0});babelHelpers.classPrivateFieldSet(this,mt,t.createStageLabel);babelHelpers.classPrivateFieldSet(this,St,t.renameStageLabel);babelHelpers.classPrivateFieldSet(this,gt,t.deleteStageLabel);babelHelpers.classPrivateFieldSet(this,Et,t.updateStageLabel)}babelHelpers.createClass(e,[{key:"sendCreateSuccess",value:function e(){babelHelpers.classPrivateFieldGet(this,mt).status=o.Dictionary.STATUS_SUCCESS;l.sendData(babelHelpers.classPrivateFieldGet(this,mt))}},{key:"sendCreateFailure",value:function e(){babelHelpers.classPrivateFieldGet(this,mt).status=o.Dictionary.STATUS_ERROR;l.sendData(babelHelpers.classPrivateFieldGet(this,mt))}},{key:"sendRenameSuccess",value:function e(){babelHelpers.classPrivateFieldGet(this,St).status=o.Dictionary.STATUS_SUCCESS;l.sendData(babelHelpers.classPrivateFieldGet(this,St))}},{key:"sendRenameFailure",value:function e(){babelHelpers.classPrivateFieldGet(this,St).status=o.Dictionary.STATUS_ERROR;l.sendData(babelHelpers.classPrivateFieldGet(this,St))}},{key:"sendDeleteSuccess",value:function e(){babelHelpers.classPrivateFieldGet(this,gt).status=o.Dictionary.STATUS_SUCCESS;l.sendData(babelHelpers.classPrivateFieldGet(this,gt))}},{key:"sendDeleteFailure",value:function e(){babelHelpers.classPrivateFieldGet(this,gt).status=o.Dictionary.STATUS_ERROR;l.sendData(babelHelpers.classPrivateFieldGet(this,gt))}},{key:"sendUpdateSuccess",value:function e(){babelHelpers.classPrivateFieldGet(this,Et).status=o.Dictionary.STATUS_SUCCESS;l.sendData(babelHelpers.classPrivateFieldGet(this,Et))}},{key:"sendUpdateFailure",value:function e(){babelHelpers.classPrivateFieldGet(this,Et).status=o.Dictionary.STATUS_ERROR;l.sendData(babelHelpers.classPrivateFieldGet(this,Et))}}]);return e}();bt.StageLabels=yt;e.DeleteAction=ve;e.SimpleAction=M;e.FieldsSelector=Be;e.PullManager=it;e.ViewMode=Re;e.StageLabels=yt})(this.BX.Crm.Kanban=this.BX.Crm.Kanban||{},BX,BX.Main,BX.Event,BX.Pull,BX.CRM.Kanban,BX,BX.UI.Analytics,BX.Crm.Integration.Analytics);
//# sourceMappingURL=kanban.map.js