BX.namespace("BX.Crm");if(BX.Type.isUndefined(BX.Crm.EntityEditorRecurringV2)){BX.Crm.EntityEditorRecurringV2=function(){BX.Crm.EntityEditorRecurringV2.superclass.constructor.apply(this)};BX.extend(BX.Crm.EntityEditorRecurringV2,BX.Crm.EntityEditorSubsection);BX.Crm.EntityEditorRecurringV2.prototype.initialize=function(t,e){BX.Crm.EntityEditorRecurringV2.superclass.initialize.call(this,t,e);const i=this._schemeElement.getData();this._schemeFieldData=BX.prop.getObject(i,"fieldData",{});this.enableRecurring=BX.prop.getBoolean(this._schemeElement._settings,"enableRecurring",true);this.recurringModel=this._model.getField(this.getName());const{_entityTypeId:n,_entityId:r}=e.editor;const o=t=>{const e=this.getRecurringModel();this.setChangedValue(t.name,t.value,e);this._changeHandler()};this.recurringField=BX.Crm.Field.Recurring.create(n,r,o,{isCategoriesEnabled:i.isCategoriesEnabled??false,categories:i.categories??[]})};BX.Crm.EntityEditorRecurringV2.prototype.initializeFromModel=function(){BX.Crm.EntityEditorRecurringV2.superclass.initializeFromModel.call(this);if(this.recurringModel){const t=this._model.getField(this.getName());Object.keys(this.recurringModel).forEach((e=>{this.recurringModel[e]=t[e]}))}};BX.Crm.EntityEditorRecurringV2.prototype.getRecurringModel=function(){return this.recurringModel};BX.Crm.EntityEditorRecurringV2.prototype.isContextMenuEnabled=function(){return BX.Crm.EntityEditorSubsection.superclass.isContextMenuEnabled.call(this)};BX.Crm.EntityEditorRecurringV2.prototype.isNeedToDisplay=function(){return false};BX.Crm.EntityEditorRecurringV2.prototype.isRequired=function(){return this._schemeElement?.isRequired()};BX.Crm.EntityEditorRecurringV2.prototype.prepareContextMenuItems=function(){const t=[];t.push({value:"hide",text:this.getMessage("hide")});return t};BX.Crm.EntityEditorRecurringV2.prototype.processContextMenuCommand=function(t,e){if(e==="hide"){window.setTimeout(BX.delegate(this.hide,this),500)}else if(this._parent?.hasAdditionalMenu()){this._parent.processChildAdditionalMenuCommand(this,e)}this.closeContextMenu()};BX.Crm.EntityEditorRecurringV2.prototype.isDragEnabled=function(){return BX.Crm.EntityEditorSubsection.superclass.isDragEnabled.call(this)};BX.Crm.EntityEditorRecurringV2.prototype.getDragObjectType=function(){return BX.UI.EditorDragObjectType.field};BX.Crm.EntityEditorRecurringV2.prototype.hasContentToDisplay=function(){return true};BX.Crm.EntityEditorRecurringV2.prototype.getRecurringMode=function(){return this.getRecurringFieldValue("RECURRING[MODE]")};BX.Crm.EntityEditorRecurringV2.prototype.getMessage=function(t){return BX.Crm.EntityEditorRecurringV2.messages[t]??t};BX.Crm.EntityEditorRecurringV2.prototype.setChangedValue=function(t,e,i){if(BX.Type.isArray(e)||!BX.Type.isObject(e)){i[t]=e}else{Object.keys(e).forEach((t=>{if(Object.hasOwn(e,t)){this.setChangedValue(t,e[t],i)}}))}};BX.Crm.EntityEditorRecurringV2.prototype.layout=function(t){this.contentContainer=BX.Tag.render`<div class="crm-entity-widget-content"></div>`;const e=this._mode===BX.UI.EntityEditorMode.view;this.ensureWrapperCreated();this.layoutTitle();BX.Dom.append(this.contentContainer,this._wrapper);if(!this.enableRecurring){const t=BX.Tag.render`
				<div class="crm-entity-widget-content-block">
					${this.createTitleNode(this.getMessage("modeTitle"))}
					<div class="crm-entity-widget-content-block-inner">
						<div class="crm-entity-widget-content-input" disabled="disabled" onclick="${this.showLicencePopup.bind(this)}">
							${this.getMessage("notRepeat")}
						</div>
					</div>
					<button class="crm-entity-widget-content-block-locked-icon" onclick="${this.showLicencePopup.bind(this)}"></button>
				</div>
			`;BX.Dom.append(t,this.contentContainer)}else if(e){const t=BX.Tag.render`
				<div class="crm-entity-widget-content-block crm-entity-widget-content-block-click-editable">
					${this.createTitleNode(this.getTitle())}
				</div>
			`;BX.Dom.append(t,this.contentContainer);const e=BX.Tag.render`<div></div>`;BX.Dom.append(e,t);const i=this._schemeElement.getData();if(this._schemeElement._promise instanceof BX.Promise){this.loadViewText();void this._schemeElement._promise.then((()=>{BX.Dom.addClass(e,"crm-entity-widget-content-block-inner");e.innerHTML=BX.util.htmlspecialchars(i.view.text);this._schemeElement._promise=null}))}else if(BX.type.isNotEmptyString(i.view.text)){BX.Dom.addClass(e,"crm-entity-widget-content-block-inner");e.innerHTML=i.view.text}BX.Event.bind(e,"click",this.toggle.bind(this));if(this.isContextMenuEnabled()){BX.Dom.append(this.createContextMenuButton(),t)}if(this.isDragEnabled()){BX.Dom.append(this.createDragButton(),t);this.initializeDragDropAbilities()}}else{this.recurringField.setData(this.getRecurringModel());this.innerWrapper=this.recurringField.getLayout();BX.Dom.append(this.innerWrapper,this.contentContainer)}this._addChildButton=null;this._createChildButton=null;this._hasLayout=true;this.registerLayout(t)};BX.Crm.EntityEditorRecurringV2.prototype.createTitleNode=function(t){return BX.Tag.render`
			<div class="crm-entity-widget-content-block-title">
				<span class="crm-entity-widget-content-block-title-text">${t}</span>
			</div>
		`};BX.Crm.EntityEditorRecurringV2.prototype.getRecurringFieldValue=function(t){return BX.prop.get(this.getRecurringModel(),t)};BX.Crm.EntityEditorRecurringV2.prototype.isEditMode=function(){return this._mode===BX.UI.EntityEditorMode.edit};BX.Crm.EntityEditorRecurringV2.prototype.getSchemeFieldValue=function(t){return BX.prop.get(this._schemeFieldData,t,"")};BX.Crm.EntityEditorRecurringV2.prototype.onBeforeSubmit=function(){const t=this._model.getStringField("IS_RECURRING")==="Y"?"Y":"N";const e=BX.Tag.render`
			<input type="hidden" name="IS_RECURRING" value="${t}">
		`;BX.Dom.append(e,this._wrapper)};BX.Crm.EntityEditorRecurringV2.prototype.save=function(){this._schemeElement._promise=new BX.Promise};BX.Crm.EntityEditorRecurringV2.prototype.loadViewText=function(){const t=this._schemeElement.getData();if(BX.type.isPlainObject(t.loaders)&&BX.type.isNotEmptyString(t.loaders.url)){BX.ajax({url:t.loaders.url,method:"POST",dataType:"json",data:{sessid:BX.bitrix_sessid(),entityId:this._model.getField("ID"),entityTypeId:this._model.getEntityTypeId()},onsuccess:this.onEntityHintLoad.bind(this)})}};BX.Crm.EntityEditorRecurringV2.prototype.onEntityHintLoad=function(t){const e=t.data??null;if(!e){return}const{hint:i}=e;if(BX.type.isNotEmptyString(i)){this._schemeElement._data.view.text=i}if(this._schemeElement._promise instanceof BX.Promise){this._schemeElement._promise.fulfill();this._schemeElement._promise=null}};BX.Crm.EntityEditorRecurringV2.prototype.showLicencePopup=function(e){e.preventDefault();if(!top.BX||!top.BX.UI||!top.BX.UI.InfoHelper){return}const layoutData=this._schemeElement.getData();const restrictionScript=layoutData.restrictScript;if(BX.type.isNotEmptyString(restrictionScript)){eval(restrictionScript)}};BX.Crm.EntityEditorRecurringV2.create=function(t,e){const i=new BX.Crm.EntityEditorRecurringV2;i.initialize(t,e);return i}}
//# sourceMappingURL=recurring-v2.map.js