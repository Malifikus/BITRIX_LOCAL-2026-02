{"version":3,"file":"bp-entity-selector.bundle.js","sources":["../src/index.js"],"sourcesContent":["import { Type, Tag, Dom } from 'main.core';\nimport { TagSelector } from 'ui.entity-selector';\n\nexport type EntitySelectorOptions = {\n\tcontainerId: string,\n\tconfig?: Record<string, any>,\n\tinputName: string,\n\tproperty: Record<string, any>,\n\tinitialValue?: string;\n};\n\nexport class EntitySelector\n{\n\tstatic selectors: WeakMap<HTMLElement, EntitySelector> | null = null;\n\n\t#containerId: string;\n\t#config: Record<string, any>;\n\t#inputName: string;\n\t#property: Record<string, any>;\n\t#initialValue: string | Array;\n\n\t#container: HTMLElement | null = null;\n\t#selector: TagSelector | null = null;\n\n\t#hiddenInputsContainer: HTMLElement | null = null;\n\n\tconstructor(options: EntitySelectorOptions)\n\t{\n\t\tthis.#containerId = options.containerId;\n\t\tthis.#config = options.config || {};\n\t\tthis.#inputName = options.inputName;\n\t\tthis.#property = options.property;\n\t\tthis.#initialValue = options.initialValue || '';\n\t}\n\n\tinit(): void\n\t{\n\t\tthis.#container = document.getElementById(this.#containerId);\n\t\tif (!this.#container)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tthis.#createSelector();\n\t\tthis.#createHiddenInputsContainer();\n\t\tthis.#renderHiddenInputs(this.#parseInitialValue(this.#initialValue));\n\t\tthis.#bindEvents();\n\t}\n\n\t#isMultiple(): boolean\n\t{\n\t\tconst multiple = this.#property.Multiple;\n\n\t\treturn multiple === true;\n\t}\n\n\t#createSelector(): void\n\t{\n\t\tthis.#selector = new TagSelector(this.#config);\n\t\tthis.#selector.renderTo(this.#container);\n\t}\n\n\t#createHiddenInputsContainer(): void\n\t{\n\t\tthis.#hiddenInputsContainer = Tag.render`<div></div>`;\n\t\tDom.hide(this.#hiddenInputsContainer);\n\t\tDom.append(this.#hiddenInputsContainer, this.#container);\n\t}\n\n\t#bindEvents(): void\n\t{\n\t\tif (!this.#selector?.dialog)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tthis.#selector.dialog.subscribe('Item:onSelect', (event) => {\n\t\t\tthis.#updateInputValues();\n\t\t});\n\n\t\tthis.#selector.dialog.subscribe('Item:onDeselect', (event) => {\n\t\t\tthis.#updateInputValues();\n\t\t});\n\t}\n\n\t#updateInputValues(): void\n\t{\n\t\tif (!this.#selector)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tconst dialog = this.#selector.getDialog();\n\t\tif (!dialog)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tconst selectedItems = dialog.getSelectedItems();\n\t\tconst values = selectedItems.map((item) => String(item.getId()));\n\n\t\tthis.#renderHiddenInputs(values);\n\t}\n\n\t#renderHiddenInputs(values: Array): void\n\t{\n\t\tif (!this.#hiddenInputsContainer)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tDom.clean(this.#hiddenInputsContainer);\n\n\t\tif (values.length === 0)\n\t\t{\n\t\t\tthis.#appendInput('');\n\n\t\t\treturn;\n\t\t}\n\n\t\tvalues.forEach((value) => {\n\t\t\tthis.#appendInput(value);\n\t\t});\n\t}\n\n\t#appendInput(value: string): void\n\t{\n\t\tif (!this.#hiddenInputsContainer)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tconst input = Tag.render`<input type=\"hidden\" />`;\n\t\tinput.name = this.#isMultiple() ? `${this.#inputName}[]` : this.#inputName;\n\t\tinput.value = value;\n\n\t\tDom.append(input, this.#hiddenInputsContainer);\n\t}\n\n\t#parseInitialValue(value): Array\n\t{\n\t\tif (!value)\n\t\t{\n\t\t\treturn [];\n\t\t}\n\n\t\tif (this.#isMultiple() && Type.isArray(value))\n\t\t{\n\t\t\treturn value;\n\t\t}\n\n\t\treturn [value];\n\t}\n\n\tstatic create(options: EntitySelectorOptions): EntitySelector\n\t{\n\t\tconst instance = new EntitySelector(options);\n\t\tinstance.init();\n\n\t\treturn instance;\n\t}\n\n\tstatic decorateNode(container: ?HTMLElement, options: Object): ?EntitySelector\n\t{\n\t\tif (!container)\n\t\t{\n\t\t\treturn null;\n\t\t}\n\n\t\tif (!EntitySelector.selectors)\n\t\t{\n\t\t\tEntitySelector.selectors = new WeakMap();\n\t\t}\n\n\t\tlet selector = EntitySelector.selectors.get(container);\n\t\tif (!selector)\n\t\t{\n\t\t\tconst config = JSON.parse(container.dataset.config || '{}');\n\t\t\tconfig.containerId = container.id;\n\t\t\tconst configs = Type.isPlainObject(options) ? options : {};\n\t\t\tconfig.config = { ...config.config, ...configs };\n\n\t\t\tselector = BX.Bizproc.EntitySelector.create(config);\n\t\t\tEntitySelector.selectors.set(container, selector);\n\t\t}\n\n\t\treturn selector;\n\t}\n\n\tdestroy(): void\n\t{\n\t\tthis.#container = null;\n\t\tthis.#selector = null;\n\t\tthis.#hiddenInputsContainer = null;\n\t}\n}\n\nBX.Bizproc.EntitySelector = EntitySelector;\n"],"names":["EntitySelector","options","containerId","config","inputName","property","initialValue","document","getElementById","instance","init","container","selectors","WeakMap","selector","get","JSON","parse","dataset","id","configs","Type","isPlainObject","BX","Bizproc","create","set","multiple","Multiple","TagSelector","renderTo","Tag","render","Dom","hide","append","dialog","subscribe","event","getDialog","selectedItems","getSelectedItems","values","map","item","String","getId","clean","length","forEach","value","input","name","isArray"],"mappings":"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"}