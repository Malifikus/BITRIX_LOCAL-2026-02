this.BX=this.BX||{};(function(e,t,s,i,r){"use strict";class a{constructor(e){this.data=e}getId(){return parseInt(this.data.id)}getTitle(){return this.data.title}getPublicUrl(){return this.data.publicUrl}static create(e){if(r.Type.isPlainObject(e)&&parseInt(e.id)>0&&r.Type.isString(e.title)){return new a(e)}return null}}class o{constructor(e){this.data=e}getId(){return parseInt(this.data.id)}getName(){return this.data.name}static create(e){if(r.Type.isPlainObject(e)&&parseInt(e.id)>0&&r.Type.isString(e.name)){return new o(e)}return null}}class n{constructor(e){this.progress=false;this.templates=null;this.documents=null;this.analyticsLabelPrefix="documentgeneratorSelector";this.isDocumentsLimitReached=false;if(r.Type.isPlainObject(e)){if(r.Type.isDomNode(e.node)){this.node=e.node}if(r.Type.isString(e.moduleId)){this.moduleId=e.moduleId}if(r.Type.isString(e.provider)){this.provider=e.provider}if(r.Type.isString(e.analyticsLabelPrefix)){this.analyticsLabelPrefix=e.analyticsLabelPrefix}if(r.Type.isString(e.value)||r.Type.isNumber(e.value)){this.value=e.value}}}isValid(){return r.Type.isString(this.moduleId)&&this.moduleId.length>0&&r.Type.isString(this.provider)&&this.provider.length>0&&!r.Type.isNil(this.value)}createDocument(e){return new Promise(((s,i)=>{if(this.progress){i("loading")}if(this.isValid()&&e instanceof o){this.progress=true;this.showLoader();t.Document.askAboutUsingPreviousDocumentNumber(this.provider,e.getId(),this.value,(t=>{const o={templateId:e.getId(),providerClassName:this.provider,value:this.value,values:{}};if(t){o.values.DocumentNumber=t}r.ajax.runAction("documentgenerator.document.add",{data:o,analyticsLabel:this.analyticsLabelPrefix+"CreateDocument"}).then((e=>{this.progress=false;this.hideLoader();const t=a.create(e.data.document);if(t){if(r.Type.isArray(this.documents)){this.documents.unshift(t)}s(t)}else{i("error trying create document object")}})).catch((e=>{this.progress=false;this.hideLoader();i(this.getErrorMessageFromResponse(e))}))}),(()=>{this.progress=false;this.hideLoader();s()}))}else{i("error trying generate document")}}))}getDocumentPublicUrl(e){return new Promise(((t,s)=>{if(!(e instanceof a)){s("wrong document");return}if(r.Type.isString(e.getPublicUrl())&&e.getPublicUrl().length>0){t(e.getPublicUrl())}else{if(this.progress){s("loading")}else{this.progress=true;this.showLoader();r.ajax.runAction("documentgenerator.document.enablePublicUrl",{data:{id:e.getId(),status:1},analyticsLabel:this.analyticsLabelPrefix+"GetPublicUrl"}).then((s=>{this.progress=false;this.hideLoader();e.data.publicUrl=s.data.publicUrl;t(e.getPublicUrl())})).catch((e=>{this.progress=false;this.hideLoader();s(this.getErrorMessageFromResponse(e))}))}}}))}show(e=null){return new Promise(((t,s)=>{if(!e){e=this.node}this.getTemplates().then((s=>{i.PopupMenu.show(this.getPopupMenuId(),e,this.prepareTemplatesList(s,(e=>{const s=i.PopupMenu.getMenuById(this.getPopupMenuId());if(s){s.destroy()}t(e)})),{offsetLeft:0,offsetTop:0,closeByEsc:true,cacheable:false,events:{onClose:()=>t()}})})).catch((e=>{if(e!=="loading"){s(e)}}))}))}getTemplates(){return new Promise(((e,t)=>{if(!this.isValid()){t("wrong data");return}if(this.templates===null){if(this.progress){t("loading");return}this.progress=true;this.showLoader();r.ajax.runAction("documentgenerator.api.document.getButtonTemplates",{data:{moduleId:this.moduleId,provider:this.provider,value:this.value},analyticsLabel:this.analyticsLabelPrefix+"LoadTemplates"}).then((t=>{this.progress=false;this.hideLoader();this.parseButtonResponse(t);e(this.templates)})).catch((e=>{this.progress=false;this.hideLoader();t(this.getErrorMessageFromResponse(e))}))}else{e(this.templates)}}))}getDocuments(e){return new Promise(((t,s)=>{if(this.progress){s("loading");return}if(this.documents===null){this.documents=[];this.progress=true;this.showLoader(e);r.ajax.runAction("documentgenerator.document.list",{data:{select:["id","number","title"],filter:{"=provider":this.provider.toLowerCase(),"=value":this.value},order:{id:"desc"}},analyticsLabel:this.analyticsLabelPrefix+"LoadDocuments"}).then((e=>{this.progress=false;this.hideLoader();e.data.documents.forEach((e=>{let t=a.create(e);if(t){this.documents.push(t)}}));t(this.documents)})).catch((e=>{this.progress=false;this.hideLoader();s(this.getErrorMessageFromResponse(e))}))}else{t(this.documents)}}))}prepareTemplatesList(e,t){const s=[];if(this.isDocumentsLimitReached){s.push({text:r.Loc.getMessage("DOCGEN_SELECTOR_MENU_DOCUMENTS_LIMIT_REACHED_ADD"),className:"documentgenerator-selector-menu-item-with-lock",onclick:()=>{this.showTariffPopup();t(null)}})}else if(r.Type.isArray(e)&&r.Type.isFunction(t)){e.forEach((e=>{s.push({text:e.getName(),onclick:()=>{t(e)}})}))}if(s.length>0){s.push({delimiter:true})}const i=this;s.push({text:r.Loc.getMessage("DOCGEN_SELECTOR_MENU_DOCUMENTS"),cacheable:true,events:{onSubMenuShow:function(){if(this.isSubmenuLoaded){return}this.isSubmenuLoaded=true;const e=this.getSubMenu();const s=e.getMenuItem("loading");i.getDocuments(s.getLayout().text).then((i=>{if(i.length<=0){if(s){s.getLayout().text.innerText=r.Loc.getMessage("DOCGEN_SELECTOR_MENU_DOCUMENTS_EMPTY")}}else{e.removeMenuItem("loading");const s=[];i.forEach((e=>{s.push({text:e.getTitle(),onclick:()=>{t(e)}})}));this.addSubMenu(s);this.showSubMenu()}})).catch((e=>{if(s){s.getLayout().text.innerText=e}}))}},items:[{id:"loading",text:r.Loc.getMessage("DOCGEN_SELECTOR_MENU_DOCUMENTS_LOADING")}]});return s}parseButtonResponse(e){this.templates=[];if(e.data&&e.data.isDocumentsLimitReached){this.isDocumentsLimitReached=e.data.isDocumentsLimitReached}if(e.data&&e.data.templates&&r.Type.isArray(e.data.templates)){e.data.templates.forEach((e=>{let t=o.create(e);if(t){this.templates.push(t)}}))}return this.templates}getErrorMessageFromResponse(e){let t="";if(e.errors&&r.Type.isArray(e.errors)){e.errors.forEach((({message:e})=>{if(t.length>0){t+=", "}t+=e}))}return t}getLoader(){if(!this.loader){this.loader=new s.Loader({size:50})}return this.loader}showLoader(e){if(!r.Type.isDomNode(e)){e=this.node}if(e&&!this.getLoader().isShown()){this.getLoader().show(e)}}hideLoader(){if(this.getLoader().isShown()){this.getLoader().hide()}}getPopupMenuId(){return"documentgenerator-selector-popup-menu"}showTariffPopup(){this.getFeatureContent().then((e=>{this.getFeaturePopup(e).show()})).catch((e=>{console.error(e)}))}getFeaturePopup(e){if(this.featurePopup!=null){return this.featurePopup}this.featurePopup=new i.PopupWindow("bx-popup-documentgenerator-popup",null,{zIndex:200,autoHide:true,closeByEsc:true,closeIcon:true,overlay:true,events:{onPopupDestroy:()=>{this.featurePopup=null}},content:e,contentColor:"white"});return this.featurePopup}getFeatureContent(){return new Promise(((e,t)=>{if(this.featureContent){e(this.featureContent);return}r.ajax.runAction("documentgenerator.document.getFeature").then((t=>{this.featureContent=document.createElement("div");this.getFeaturePopup(this.featureContent);r.Runtime.html(this.featureContent,t.data.html,{htmlFirst:true}).then((()=>{e(this.featureContent)}))})).catch((e=>{t(this.getErrorMessageFromResponse(e))}))}))}}const u={Menu:n,Template:o,Document:a};e.Selector=u})(this.BX.DocumentGenerator=this.BX.DocumentGenerator||{},BX.DocumentGenerator,BX,BX.Main,BX);
//# sourceMappingURL=selector.bundle.map.js