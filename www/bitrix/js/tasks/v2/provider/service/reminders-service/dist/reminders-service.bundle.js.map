{"version":3,"file":"reminders-service.bundle.js","sources":["../src/mappers.js","../src/reminders-service.js","../src/index.js"],"sourcesContent":["import { Type } from 'main.core';\nimport type { ReminderModel } from 'tasks.v2.model.reminders';\nimport type { ReminderDto } from './types';\n\nexport function mapModelToDto(reminder: ReminderModel): ReminderDto\n{\n\treturn {\n\t\tid: reminder.id,\n\t\ttaskId: reminder.taskId,\n\t\tuserId: reminder.userId,\n\t\tnextRemindTs: mapValue(reminder.nextRemindTs, Math.floor(reminder.nextRemindTs / 1000)),\n\t\tremindBy: reminder.remindBy,\n\t\tremindVia: reminder.remindVia,\n\t\trecipient: reminder.recipient,\n\t\tbefore: mapValue(reminder.before, Math.floor(reminder.before / 1000)),\n\t};\n}\n\nexport function mapDtoToModel(reminderDto: ReminderDto): ReminderModel\n{\n\treturn {\n\t\tid: reminderDto.id,\n\t\ttaskId: reminderDto.taskId,\n\t\tuserId: reminderDto.userId,\n\t\tnextRemindTs: mapValue(reminderDto.nextRemindTs, reminderDto.nextRemindTs * 1000),\n\t\tremindBy: reminderDto.remindBy,\n\t\tremindVia: reminderDto.remindVia,\n\t\trecipient: reminderDto.recipient,\n\t\tbefore: mapValue(reminderDto.before ?? undefined, reminderDto.before * 1000),\n\t};\n}\n\nfunction mapValue(value: any, mappedValue: any): any | undefined\n{\n\treturn Type.isUndefined(value) ? undefined : mappedValue;\n}\n","import type { Store } from 'ui.vue3.vuex';\n\nimport { Core } from 'tasks.v2.core';\nimport { Endpoint, Model } from 'tasks.v2.const';\nimport { idUtils } from 'tasks.v2.lib.id-utils';\nimport { apiClient } from 'tasks.v2.lib.api-client';\nimport { taskService, TaskMappers } from 'tasks.v2.provider.service.task-service';\nimport type { ReminderModel } from 'tasks.v2.model.reminders';\n\nimport { mapDtoToModel, mapModelToDto } from './mappers';\n\nexport class RemindersService\n{\n\t#cache: { [taskId: number]: boolean } = {};\n\n\tasync list(taskId: number): Promise<void>\n\t{\n\t\tif (this.#cache[taskId] || !Number.isInteger(taskId))\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tthis.#cache[taskId] = true;\n\n\t\ttry\n\t\t{\n\t\t\tconst data = await apiClient.post(Endpoint.TaskReminderList, { taskId });\n\n\t\t\tawait this.$store.dispatch(`${Model.Reminders}/upsertMany`, data.map((it) => mapDtoToModel(it)));\n\t\t}\n\t\tcatch (error)\n\t\t{\n\t\t\tconsole.error('Reminder.list', error);\n\t\t}\n\t}\n\n\tasync set(taskId: number, reminders: ReminderModel[]): Promise<void>\n\t{\n\t\tvoid taskService.updateStoreTask(taskId, { numberOfReminders: reminders.length });\n\t\tvoid this.$store.dispatch(`${Model.Reminders}/upsertMany`, reminders.map((reminder: ReminderModel) => ({\n\t\t\t...reminder,\n\t\t\ttaskId,\n\t\t})));\n\n\t\ttry\n\t\t{\n\t\t\tconst task = TaskMappers.mapModelToDto({ id: taskId, reminders });\n\n\t\t\tawait apiClient.post(Endpoint.TaskReminderSet, { task });\n\n\t\t\tawait this.$store.dispatch(`${Model.Reminders}/deleteMany`, reminders.map(({ id }) => id));\n\t\t}\n\t\tcatch (error)\n\t\t{\n\t\t\tconsole.error('Reminder.set', error);\n\t\t}\n\t}\n\n\tasync add(reminder: ReminderModel): Promise<void>\n\t{\n\t\tconst task = taskService.getStoreTask(reminder.taskId);\n\t\tvoid taskService.updateStoreTask(reminder.taskId, { numberOfReminders: task.numberOfReminders + 1 });\n\t\tvoid this.$store.dispatch(`${Model.Reminders}/upsert`, reminder);\n\n\t\tif (!idUtils.isReal(reminder.taskId))\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\ttry\n\t\t{\n\t\t\tconst data = await apiClient.post(Endpoint.TaskReminderAdd, { reminder: mapModelToDto(reminder) });\n\n\t\t\tvoid this.$store.dispatch(`${Model.Reminders}/update`, {\n\t\t\t\tid: reminder.id,\n\t\t\t\tfields: mapDtoToModel(data),\n\t\t\t});\n\t\t}\n\t\tcatch (error)\n\t\t{\n\t\t\tconsole.error('Reminder.add', error);\n\t\t}\n\t}\n\n\tasync update(reminder: ReminderModel): Promise<void>\n\t{\n\t\tconst { id, ...fields } = reminder;\n\n\t\tconst reminderBefore = this.$store.getters[`${Model.Reminders}/getById`](id);\n\t\tif (JSON.stringify(reminderBefore) === JSON.stringify(reminder))\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tvoid this.$store.dispatch(`${Model.Reminders}/update`, { id, fields });\n\n\t\tif (!idUtils.isReal(id))\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\ttry\n\t\t{\n\t\t\tawait apiClient.post(Endpoint.TaskReminderUpdate, { reminder: mapModelToDto(reminder) });\n\t\t}\n\t\tcatch (error)\n\t\t{\n\t\t\tconsole.error('Reminder.add', error);\n\t\t}\n\t}\n\n\tasync delete(id: number): Promise<void>\n\t{\n\t\tconst reminder = this.$store.getters[`${Model.Reminders}/getById`](id);\n\t\tconst task = taskService.getStoreTask(reminder.taskId);\n\t\tvoid taskService.updateStoreTask(reminder.taskId, { numberOfReminders: task.numberOfReminders - 1 });\n\t\tvoid this.$store.dispatch(`${Model.Reminders}/delete`, id);\n\n\t\tif (!idUtils.isReal(reminder.taskId))\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\ttry\n\t\t{\n\t\t\tawait apiClient.post(Endpoint.TaskReminderDelete, { reminder: { id } });\n\t\t}\n\t\tcatch (error)\n\t\t{\n\t\t\tconsole.error('Reminder.delete', error);\n\t\t}\n\t}\n\n\tget $store(): Store\n\t{\n\t\treturn Core.getStore();\n\t}\n}\n","import { mapModelToDto, mapDtoToModel } from './mappers';\nimport { RemindersService } from './reminders-service';\n\nexport const remindersService = new RemindersService();\nexport const RemindersMappers = { mapModelToDto, mapDtoToModel };\n"],"names":["mapModelToDto","reminder","id","taskId","userId","nextRemindTs","mapValue","Math","floor","remindBy","remindVia","recipient","before","mapDtoToModel","reminderDto","undefined","value","mappedValue","Type","isUndefined","RemindersService","list","Number","isInteger","data","apiClient","post","Endpoint","TaskReminderList","$store","dispatch","Model","Reminders","map","it","error","console","set","reminders","taskService","updateStoreTask","numberOfReminders","length","task","TaskMappers","TaskReminderSet","add","getStoreTask","idUtils","isReal","TaskReminderAdd","fields","update","reminderBefore","getters","JSON","stringify","TaskReminderUpdate","delete","TaskReminderDelete","Core","getStore","remindersService","RemindersMappers"],"mappings":"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"}