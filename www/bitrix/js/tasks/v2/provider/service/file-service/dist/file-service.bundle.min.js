this.BX=this.BX||{};this.BX.Tasks=this.BX.Tasks||{};this.BX.Tasks.V2=this.BX.Tasks.V2||{};this.BX.Tasks.V2.Provider=this.BX.Tasks.V2.Provider||{};(function(e,s,i,a,t,l,r,o,d,b,c,n){"use strict";function v(e){return{serverFileId:e.id,serverId:e.serverId,type:e.type,name:e.name,size:e.size,width:e.width,height:e.height,isImage:e.isImage,isVideo:e.isVideo,treatImageAsFile:e.treatImageAsFile,downloadUrl:e.downloadUrl,previewUrl:e.serverPreviewUrl,serverPreviewUrl:e.serverPreviewUrl,serverPreviewWidth:e.serverPreviewWidth,serverPreviewHeight:e.serverPreviewHeight,customData:e.customData,viewerAttrs:e.viewerAttrs}}const p=e=>{if(!Array.isArray(e)){return[]}return e.reduce(((e,s)=>{if(n.Type.isObjectLike(s)&&"id"in s&&"fileId"in s){e.push({id:s.id,fileId:s.fileId})}else if(n.Type.isString(s)&&s.startsWith("n")){e.push({id:s,fileId:s})}return e}),[])};const h=Object.freeze({Task:"task",CheckListItem:"checkListItem",Result:"result"});var F=babelHelpers.classPrivateFieldLooseKey("entityId");var P=babelHelpers.classPrivateFieldLooseKey("entityType");var u=babelHelpers.classPrivateFieldLooseKey("loadedIds");var L=babelHelpers.classPrivateFieldLooseKey("objectsIds");var H=babelHelpers.classPrivateFieldLooseKey("promises");var B=babelHelpers.classPrivateFieldLooseKey("adapter");var f=babelHelpers.classPrivateFieldLooseKey("fileBrowserClosed");var y=babelHelpers.classPrivateFieldLooseKey("filesToAttach");var m=babelHelpers.classPrivateFieldLooseKey("filesToDetach");var I=babelHelpers.classPrivateFieldLooseKey("isDetachedErrorMode");var w=babelHelpers.classPrivateFieldLooseKey("browseElement");var g=babelHelpers.classPrivateFieldLooseKey("saveAttachedFilesDebounced");var k=babelHelpers.classPrivateFieldLooseKey("saveDetachedFilesDebounced");var T=babelHelpers.classPrivateFieldLooseKey("bindEvents");var O=babelHelpers.classPrivateFieldLooseKey("unbindEvents");var j=babelHelpers.classPrivateFieldLooseKey("handleLoadedFiles");var E=babelHelpers.classPrivateFieldLooseKey("addLoadedIds");var S=babelHelpers.classPrivateFieldLooseKey("addLoadedObjectsIds");var A=babelHelpers.classPrivateFieldLooseKey("removeLoadedObjectsIds");var U=babelHelpers.classPrivateFieldLooseKey("getIdsByObjectId");var C=babelHelpers.classPrivateFieldLooseKey("attachFiles");var K=babelHelpers.classPrivateFieldLooseKey("detachFiles");var D=babelHelpers.classPrivateFieldLooseKey("getEntityFileIds");var R=babelHelpers.classPrivateFieldLooseKey("processCheckListFileIds");var X=babelHelpers.classPrivateFieldLooseKey("isObjectId");var V=babelHelpers.classPrivateFieldLooseKey("saveAttachedFiles");var $=babelHelpers.classPrivateFieldLooseKey("saveDetachedFiles");var _=babelHelpers.classPrivateFieldLooseKey("entityFileIds");class M extends s.EventEmitter{constructor(e,s=h.Task){super();Object.defineProperty(this,_,{get:te,set:void 0});Object.defineProperty(this,$,{value:ae});Object.defineProperty(this,V,{value:ie});Object.defineProperty(this,X,{value:se});Object.defineProperty(this,R,{value:ee});Object.defineProperty(this,D,{value:Z});Object.defineProperty(this,K,{value:J});Object.defineProperty(this,C,{value:Q});Object.defineProperty(this,U,{value:q});Object.defineProperty(this,A,{value:Y});Object.defineProperty(this,S,{value:G});Object.defineProperty(this,E,{value:z});Object.defineProperty(this,j,{value:W});Object.defineProperty(this,O,{value:N});Object.defineProperty(this,T,{value:x});Object.defineProperty(this,F,{writable:true,value:void 0});Object.defineProperty(this,P,{writable:true,value:void 0});Object.defineProperty(this,u,{writable:true,value:new Set});Object.defineProperty(this,L,{writable:true,value:{}});Object.defineProperty(this,H,{writable:true,value:[]});Object.defineProperty(this,B,{writable:true,value:null});Object.defineProperty(this,f,{writable:true,value:false});Object.defineProperty(this,y,{writable:true,value:[]});Object.defineProperty(this,m,{writable:true,value:[]});Object.defineProperty(this,I,{writable:true,value:false});Object.defineProperty(this,w,{writable:true,value:void 0});Object.defineProperty(this,g,{writable:true,value:void 0});Object.defineProperty(this,k,{writable:true,value:void 0});this.handleSave=async()=>{await babelHelpers.classPrivateFieldLooseBase(this,V)[V]();await babelHelpers.classPrivateFieldLooseBase(this,$)[$]()};this.setEventNamespace("Tasks.V2.Provider.Service.FileService");this.setEntityId(e,s);this.initAdapter(e,s);babelHelpers.classPrivateFieldLooseBase(this,T)[T]();babelHelpers.classPrivateFieldLooseBase(this,g)[g]=n.Runtime.debounce(babelHelpers.classPrivateFieldLooseBase(this,V)[V],3e3,this);babelHelpers.classPrivateFieldLooseBase(this,k)[k]=n.Runtime.debounce(babelHelpers.classPrivateFieldLooseBase(this,$)[$],3e3,this)}initAdapter(e,s){babelHelpers.classPrivateFieldLooseBase(this,B)[B]=new a.VueUploaderAdapter({id:re(e,s),controller:r.Core.getParams().features.disk?"disk.uf.integration.diskUploaderController":null,imagePreviewHeight:1200,imagePreviewWidth:1200,imagePreviewQuality:.85,ignoreUnknownImageTypes:true,treatOversizeImageAsFile:true,multiple:true,maxFileSize:null});babelHelpers.classPrivateFieldLooseBase(this,B)[B].subscribeFromOptions({"Item:onAdd":e=>{const{item:s}=e.getData();babelHelpers.classPrivateFieldLooseBase(this,E)[E]([s.serverFileId]);this.emit("onFileAdd")},"Item:onComplete":e=>{const{item:s}=e.getData();babelHelpers.classPrivateFieldLooseBase(this,S)[S]([s]);const i=new Set(babelHelpers.classPrivateFieldLooseBase(this,_)[_]);if(!babelHelpers.classPrivateFieldLooseBase(this,U)[U](s.customData.objectId).some((e=>i.has(e)))){babelHelpers.classPrivateFieldLooseBase(this,C)[C]([...i,s.serverFileId],s)}this.emit("onFileComplete",s)},"Item:onRemove":e=>{const{item:s}=e.getData();const i=new Set(babelHelpers.classPrivateFieldLooseBase(this,U)[U](s.customData.objectId));babelHelpers.classPrivateFieldLooseBase(this,A)[A](i);babelHelpers.classPrivateFieldLooseBase(this,K)[K](babelHelpers.classPrivateFieldLooseBase(this,D)[D](i),s);this.emit("onFileRemove",{file:s})}})}setEntityId(e,s=h.Task){babelHelpers.classPrivateFieldLooseBase(this,F)[F]=e;babelHelpers.classPrivateFieldLooseBase(this,P)[P]=s}getEntityId(){return babelHelpers.classPrivateFieldLooseBase(this,F)[F]}getAdapter(){return babelHelpers.classPrivateFieldLooseBase(this,B)[B]}getFiles(){return babelHelpers.classPrivateFieldLooseBase(this,B)[B].getReactiveItems()}getFileItems(){return babelHelpers.classPrivateFieldLooseBase(this,B)[B].getItems()}isUploading(){return this.getFileItems().some((({status:e})=>[i.FileStatus.UPLOADING,i.FileStatus.LOADING].includes(e)))}hasUploadingError(){return this.getFileItems().some((({status:e})=>[i.FileStatus.UPLOAD_FAILED,i.FileStatus.LOAD_FAILED].includes(e)))}browse(e){n.Runtime.loadExtension("disk.uploader.user-field-widget").then((({UserFieldMenu:s})=>{const i=new s({dialogId:"task-card",uploader:babelHelpers.classPrivateFieldLooseBase(this,B)[B].getUploader(),compact:e.compact||false,menuOptions:{minWidth:220,animation:"fading",closeByEsc:true,bindOptions:{forceBindPosition:true},events:{onPopupClose:()=>{e.onHideCallback==null?void 0:e.onHideCallback()},onPopupShow:()=>{e.onShowCallback==null?void 0:e.onShowCallback()}}}});i.show(e.bindElement)})).catch((e=>console.error(e)))}browseFiles(){if(!babelHelpers.classPrivateFieldLooseBase(this,w)[w]){babelHelpers.classPrivateFieldLooseBase(this,w)[w]=document.createElement("div");babelHelpers.classPrivateFieldLooseBase(this,B)[B].getUploader().assignBrowse(babelHelpers.classPrivateFieldLooseBase(this,w)[w])}babelHelpers.classPrivateFieldLooseBase(this,w)[w].click()}browseMyDrive(){n.Runtime.loadExtension("disk.uploader.user-field-widget").then((({openDiskFileDialog:e})=>{e({dialogId:"task-card",uploader:babelHelpers.classPrivateFieldLooseBase(this,B)[B].getUploader()})})).catch((e=>console.error(e)))}setFileBrowserClosed(e){babelHelpers.classPrivateFieldLooseBase(this,f)[f]=e}isFileBrowserClosed(){return babelHelpers.classPrivateFieldLooseBase(this,f)[f]}resetFileBrowserClosedState(){babelHelpers.classPrivateFieldLooseBase(this,f)[f]=false}destroy(){babelHelpers.classPrivateFieldLooseBase(this,B)[B].unsubscribeAll("Item:onAdd");babelHelpers.classPrivateFieldLooseBase(this,B)[B].unsubscribeAll("Item:onComplete");babelHelpers.classPrivateFieldLooseBase(this,B)[B].unsubscribeAll("Item:onRemove");babelHelpers.classPrivateFieldLooseBase(this,B)[B].getUploader().destroy();babelHelpers.classPrivateFieldLooseBase(this,O)[O]()}async sync(e){if(!n.Type.isArrayFilled(e)){return}await this.list(e)}async list(e){const s=e.filter((e=>!babelHelpers.classPrivateFieldLooseBase(this,u)[u].has(e)));if(s.length===0){await Promise.all(babelHelpers.classPrivateFieldLooseBase(this,H)[H]);return this.getFileItems()}const i=new de;babelHelpers.classPrivateFieldLooseBase(this,H)[H].push(i);babelHelpers.classPrivateFieldLooseBase(this,E)[E](s);try{const e=await d.apiClient.post(o.Endpoint.FileListObjects,{ids:s});babelHelpers.classPrivateFieldLooseBase(this,j)[j](e);i.resolve();await Promise.all(babelHelpers.classPrivateFieldLooseBase(this,H)[H]);return this.getFileItems()}catch(e){console.error(o.Endpoint.FileListObjects,e);return[]}}loadFilesFromData(e){const s=e.map((e=>e.id));babelHelpers.classPrivateFieldLooseBase(this,E)[E](s);babelHelpers.classPrivateFieldLooseBase(this,j)[j](e)}hasPendingRequests(){return babelHelpers.classPrivateFieldLooseBase(this,y)[y].length>0||babelHelpers.classPrivateFieldLooseBase(this,m)[m].length>0}notifyError(e){l.Notifier.notifyViaBrowserProvider({id:`file-service-error-${n.Text.getRandom()}`,text:e})}get $store(){return r.Core.getStore()}}function x(){if(babelHelpers.classPrivateFieldLooseBase(this,P)[P]===h.Task){n.Event.bind(window,"beforeunload",this.handleSave)}}function N(){if(babelHelpers.classPrivateFieldLooseBase(this,P)[P]===h.Task){n.Event.unbind(window,"beforeunload",this.handleSave)}}function W(e){const s=e.map((e=>v(e)));const i=new Set(Object.values(babelHelpers.classPrivateFieldLooseBase(this,L)[L]));const a=s.filter((({customData:e})=>!i.has(e.objectId)));babelHelpers.classPrivateFieldLooseBase(this,B)[B].getUploader().addFiles(a);babelHelpers.classPrivateFieldLooseBase(this,S)[S](s)}function z(e){e.forEach((e=>babelHelpers.classPrivateFieldLooseBase(this,u)[u].add(e)))}function G(e){e.forEach((e=>{babelHelpers.classPrivateFieldLooseBase(this,L)[L][e.serverFileId]=e.customData.objectId}))}function Y(e){e.forEach((e=>{delete babelHelpers.classPrivateFieldLooseBase(this,L)[L][e]}))}function q(e){return Object.entries(babelHelpers.classPrivateFieldLooseBase(this,L)[L]).filter((([,s])=>s===e)).map((([e])=>babelHelpers.classPrivateFieldLooseBase(this,X)[X](e)?e:Number(e)))}function Q(e,s){switch(babelHelpers.classPrivateFieldLooseBase(this,P)[P]){case h.Task:{const i=babelHelpers.classPrivateFieldLooseBase(this,F)[F];void c.taskService.updateStoreTask(i,{fileIds:e});if(babelHelpers.classPrivateFieldLooseBase(this,I)[I]){return}if(b.idUtils.isReal(i)&&babelHelpers.classPrivateFieldLooseBase(this,X)[X](s.serverFileId)){babelHelpers.classPrivateFieldLooseBase(this,y)[y].push(s);babelHelpers.classPrivateFieldLooseBase(this,g)[g]()}break}case h.CheckListItem:{babelHelpers.classPrivateFieldLooseBase(this,R)[R](e);break}case h.Result:{void this.$store.dispatch(`${o.Model.Results}/update`,{id:babelHelpers.classPrivateFieldLooseBase(this,F)[F],fields:{fileIds:e}});break}default:break}}function J(e,s){switch(babelHelpers.classPrivateFieldLooseBase(this,P)[P]){case h.Task:{const i=babelHelpers.classPrivateFieldLooseBase(this,F)[F];void c.taskService.updateStoreTask(i,{fileIds:e});if(b.idUtils.isReal(i)){const e=s.serverFileId;const i=babelHelpers.classPrivateFieldLooseBase(this,y)[y].findIndex((s=>s.serverFileId===e));if(i===-1){babelHelpers.classPrivateFieldLooseBase(this,m)[m].push(s);babelHelpers.classPrivateFieldLooseBase(this,k)[k]()}else{babelHelpers.classPrivateFieldLooseBase(this,y)[y].splice(i,1)}}break}case h.CheckListItem:{babelHelpers.classPrivateFieldLooseBase(this,R)[R](e);break}case h.Result:{void this.$store.dispatch(`${o.Model.Results}/update`,{id:babelHelpers.classPrivateFieldLooseBase(this,F)[F],fields:{fileIds:e}});break}default:break}}function Z(e=new Set){if(babelHelpers.classPrivateFieldLooseBase(this,P)[P]===h.Task||babelHelpers.classPrivateFieldLooseBase(this,P)[P]===h.Result){return babelHelpers.classPrivateFieldLooseBase(this,_)[_].filter((s=>!e.has(s)))}if(babelHelpers.classPrivateFieldLooseBase(this,P)[P]===h.CheckListItem){return babelHelpers.classPrivateFieldLooseBase(this,_)[_].filter((s=>!e.has(s.id)))}return[]}function ee(e){const s=p(e);void this.$store.dispatch(`${o.Model.CheckList}/update`,{id:babelHelpers.classPrivateFieldLooseBase(this,F)[F],fields:{attachments:s}})}function se(e){return String(e).startsWith("n")}async function ie(){if(n.Type.isArrayFilled(babelHelpers.classPrivateFieldLooseBase(this,y)[y])){const e=b.idUtils.unbox(babelHelpers.classPrivateFieldLooseBase(this,F)[F]);try{const s=babelHelpers.classPrivateFieldLooseBase(this,y)[y].map((e=>e.serverFileId));babelHelpers.classPrivateFieldLooseBase(this,y)[y]=[];if(b.idUtils.isTemplate(babelHelpers.classPrivateFieldLooseBase(this,F)[F])){await d.apiClient.post(o.Endpoint.TemplateUpdate,{template:{id:e,fileIds:babelHelpers.classPrivateFieldLooseBase(this,_)[_]}})}else{await d.apiClient.post(o.Endpoint.FileAttach,{task:{id:e},ids:s})}}catch(e){console.error("FileService: saveAttachedFiles error",e);this.notifyError(n.Loc.getMessage("TASKS_V2_NOTIFY_FILE_ATTACH_ERROR"))}}}async function ae(){if(n.Type.isArrayFilled(babelHelpers.classPrivateFieldLooseBase(this,m)[m])){const e=b.idUtils.unbox(babelHelpers.classPrivateFieldLooseBase(this,F)[F]);const s=babelHelpers.classPrivateFieldLooseBase(this,m)[m];try{const s=babelHelpers.classPrivateFieldLooseBase(this,m)[m].map((e=>e.serverFileId));babelHelpers.classPrivateFieldLooseBase(this,m)[m]=[];if(b.idUtils.isTemplate(babelHelpers.classPrivateFieldLooseBase(this,F)[F])){await d.apiClient.post(o.Endpoint.TemplateUpdate,{template:{id:e,fileIds:babelHelpers.classPrivateFieldLooseBase(this,_)[_]}})}else{await d.apiClient.post(o.Endpoint.FileDetach,{task:{id:e},ids:s})}}catch(e){console.error("FileService: saveDetachedFiles error",e);babelHelpers.classPrivateFieldLooseBase(this,I)[I]=true;babelHelpers.classPrivateFieldLooseBase(this,B)[B].getUploader().addFiles(s);babelHelpers.classPrivateFieldLooseBase(this,I)[I]=false;this.notifyError(n.Loc.getMessage("TASKS_V2_NOTIFY_FILE_DETACH_ERROR"))}}}function te(){if(babelHelpers.classPrivateFieldLooseBase(this,P)[P]===h.Task){return c.taskService.getStoreTask(babelHelpers.classPrivateFieldLooseBase(this,F)[F]).fileIds}if(babelHelpers.classPrivateFieldLooseBase(this,P)[P]===h.Result){return this.$store.getters[`${o.Model.Results}/getById`](babelHelpers.classPrivateFieldLooseBase(this,F)[F]).fileIds}return this.$store.getters[`${o.Model.CheckList}/getById`](babelHelpers.classPrivateFieldLooseBase(this,F)[F]).attachments}const le={};const re=(e,s)=>`${s}:${e}`;const oe={get(e,s=h.Task){var i;const a=re(e,s);(i=le[a])!=null?i:le[a]=new M(e,s);return le[a]},replace(e,s,i=h.Task){const a=re(e,i);const t=re(s,i);le[t]=le[a];le[t].setEntityId(s,i);delete le[a]},delete(e,s=h.Task){var i;const a=re(e,s);(i=le[a])==null?void 0:i.destroy();delete le[a]}};function de(){const e=new Promise((e=>{this.resolve=e}));e.resolve=this.resolve;return e}e.fileService=oe;e.EntityTypes=h})(this.BX.Tasks.V2.Provider.Service=this.BX.Tasks.V2.Provider.Service||{},BX.Event,BX.UI.Uploader,BX.UI.Uploader,BX.Vue3,BX.UI.NotificationManager,BX.Tasks.V2,BX.Tasks.V2.Const,BX.Tasks.V2.Lib,BX.Tasks.V2.Lib,BX.Tasks.V2.Provider.Service,BX);
//# sourceMappingURL=file-service.bundle.map.js