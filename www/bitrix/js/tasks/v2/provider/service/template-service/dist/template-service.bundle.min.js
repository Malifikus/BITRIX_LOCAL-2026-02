this.BX=this.BX||{};this.BX.Tasks=this.BX.Tasks||{};this.BX.Tasks.V2=this.BX.Tasks.V2||{};this.BX.Tasks.V2.Provider=this.BX.Tasks.V2.Provider||{};(function(e,t,s,i,a,r,l,o,n,d,c){"use strict";var p,m,u;const v=new(p=babelHelpers.classPrivateFieldLooseKey("grantUser"),m=babelHelpers.classPrivateFieldLooseKey("userGranted"),u=babelHelpers.classPrivateFieldLooseKey("buildUser"),class{constructor(){Object.defineProperty(this,u,{value:b});Object.defineProperty(this,m,{value:y});Object.defineProperty(this,p,{value:T})}getPermissions(e){var t;const s=i.Core.getParams().currentUser.id;const a=((t=e.permissions)!=null?t:[]).map((e=>({...e})));babelHelpers.classPrivateFieldLooseBase(this,p)[p](s,a);if(!o.idUtils.isReal(e.id)&&e.creatorId!==s){babelHelpers.classPrivateFieldLooseBase(this,p)[p](e.creatorId,a)}return a}buildFromItem(e){const t=e.getId();let s=e.getEntityId();if([a.EntitySelectorEntity.Group,a.EntitySelectorEntity.Project].includes(s)){s=a.EntitySelectorEntity.Group}return{id:this.buildId(s,t),entityType:s,entityId:t,title:e.getTitle(),image:e.getAvatar(),permission:a.PermissionType.Full}}buildItemId(e){const t=i.Core.getParams().mainDepartmentUfId;let s=e.entityType;let r=e.entityId;if(s===a.EntitySelectorEntity.Group){s=a.EntitySelectorEntity.Project}if(s===a.EntitySelectorEntity.Department&&e.entityId===t){s=a.EntitySelectorEntity.MetaUser;r=a.EntitySelectorEntity.AllUser}return[s,r]}buildId(e,t){return`${e}:${t}`}});function T(e,t){if(!babelHelpers.classPrivateFieldLooseBase(this,m)[m](e,t)){t.push(babelHelpers.classPrivateFieldLooseBase(this,u)[u](e))}return t}function y(e,t){return t.find((t=>t.entityType===a.EntitySelectorEntity.User&&t.entityId===e))}function b(e){const t=i.Core.getStore().getters[`${a.Model.Users}/getById`](e);return{id:this.buildId(a.EntitySelectorEntity.User,t.id),entityType:a.EntitySelectorEntity.User,entityId:t.id,title:t.name,image:t.image,permission:a.PermissionType.Full}}const h=e=>{var t,s;return{id:v.buildId(e.accessEntity.type,e.accessEntity.id),entityId:e.accessEntity.id,entityType:e.accessEntity.type,title:e.accessEntity.name,image:(t=e.accessEntity)==null?void 0:(s=t.image)==null?void 0:s.src,permission:e.permissionId}};const k=e=>({accessEntity:{id:e.entityId,type:e.entityType},permissionId:e.permission});const g=({read:e,edit:t,remove:s,create:i})=>({read:e,edit:t,remove:s,create:i,complete:t,approve:t,disapprove:t,start:t,take:t,delegate:t,defer:t,renew:t,deadline:t,datePlan:t,changeDirector:t,changeResponsible:t,changeAccomplices:t,pause:t,timeTracking:t,rate:t,changeStatus:t,reminder:t,addAuditors:t,elapsedTime:t,favorite:t,checklistAdd:t,checklistEdit:t,checklistSave:t,checklistToggle:t,automate:t,resultEdit:t,completeResult:t,removeResult:t,resultRead:t,admin:t,watch:t,mute:t,createSubtask:t,copy:t,createFromTemplate:t,saveAsTemplate:t,attachFile:t,detachFile:t,detachParent:t,detachRelated:t,changeDependence:t,createGanttDependence:t,sort:t});const P=e=>({title:e.title,responsibleCollection:e.responsibleCollection,deadlineTs:F(e.deadlineAfter,E(Date.now()+e.deadlineAfter*1e3)/1e3)});const S=60*1e3;const E=e=>Math.ceil(e/S)*S;const F=(e,s)=>t.Type.isNil(e)?e:s;var I,f,B,w,L,C;const U=new(I=babelHelpers.classPrivateFieldLooseKey("updateFields"),f=babelHelpers.classPrivateFieldLooseKey("updateTaskBefore"),B=babelHelpers.classPrivateFieldLooseKey("updatePromises"),w=babelHelpers.classPrivateFieldLooseKey("updateServerTaskDebounced"),L=babelHelpers.classPrivateFieldLooseKey("updateDebounced"),C=babelHelpers.classPrivateFieldLooseKey("requestUpdate"),class{constructor(){Object.defineProperty(this,C,{value:A});Object.defineProperty(this,L,{value:H});Object.defineProperty(this,I,{writable:true,value:{}});Object.defineProperty(this,f,{writable:true,value:{}});Object.defineProperty(this,B,{writable:true,value:{}});Object.defineProperty(this,w,{writable:true,value:{}});t.Event.bind(window,"beforeunload",(()=>{setTimeout((()=>{const e=Object.keys(babelHelpers.classPrivateFieldLooseBase(this,B)[B]);e.forEach((e=>babelHelpers.classPrivateFieldLooseBase(this,C)[C](e)))}))}))}async get(e){try{const t=await r.apiClient.post(a.Endpoint.TemplateGet,{templateId:o.idUtils.unbox(e)});t.id=e;l.taskService.extractTask({...t,rights:g(t.rights)},false)}catch(e){console.error(a.Endpoint.TemplateGet,e)}return l.taskService.getStoreTask(e)}async getCopy(e,s){var a;const r=await this.get(e);if(((a=r.checklist)==null?void 0:a.length)>0){await n.checkListService.load(e,s)}const o={title:r.title,description:r.description,creatorId:i.Core.getParams().currentUser.id,responsibleIds:r.responsibleIds,deadlineAfter:r.deadlineAfter,needsControl:r.needsControl,startDatePlanAfter:r.startDatePlanAfter,endDatePlanAfter:r.endDatePlanAfter,fileIds:r.fileIds,groupId:r.groupId,isImportant:r.isImportant,accomplicesIds:r.accomplicesIds,auditorsIds:r.auditorsIds,parentId:r.parentId,allowsChangeDeadline:r.allowsChangeDeadline,matchesWorkTime:r.matchesWorkTime,tags:r.tags,crmItemIds:r.crmItemIds,containsRelatedTasks:r.containsRelatedTasks,relatedTaskIds:r.relatedTaskIds,allowsTimeTracking:r.allowsTimeTracking,estimatedTime:r.estimatedTime,permissions:r.estimatedTime,userFields:r.userFields};if(t.Type.isArrayFilled(o.userFields)){o.userFields=c.userFieldsManager.prepareUserFieldsForTaskFromTemplate(o.userFields,i.Core.getParams().templateUserFieldScheme)}l.taskService.updateStoreTask(s,o)}async add(e){try{var t;const i=await r.apiClient.post(a.Endpoint.TemplateAdd,{template:l.TaskMappers.mapModelToDto(e)});i.id=o.idUtils.boxTemplate(i.id);l.taskService.updateStoreTask(e.id,{id:i.id});l.taskService.extractTask({...i,rights:g(i.rights)});s.EventEmitter.emit(a.EventName.TemplateAdded,{template:l.taskService.getStoreTask(i.id),initialTemplate:e});if(e.parentId){d.subTasksService.addStore(e.parentId,[i.id])}if(((t=e.checklist)==null?void 0:t.length)>0){void n.checkListService.save(i.id,this.$store.getters[`${a.Model.CheckList}/getByIds`](e.checklist))}return[i.id,null]}catch(e){var i,c;console.error(a.Endpoint.TemplateAdd,e);return[0,new Error((i=e.errors)==null?void 0:(c=i[0])==null?void 0:c.message)]}}async copy(e){try{const t=await r.apiClient.post(a.Endpoint.TemplateAdd,{template:l.TaskMappers.mapModelToDto({...e,id:e.copiedFromId})});t.id=o.idUtils.boxTemplate(t.id);l.taskService.updateStoreTask(e.id,{id:t.id});l.taskService.extractTask({...t,rights:g(t.rights)});s.EventEmitter.emit(a.EventName.TemplateAdded,{template:l.taskService.getStoreTask(t.id),initialTemplate:e});if(e.checklist.length>0){void n.checkListService.load(t.id)}return[t.id,null]}catch(e){var t,i;console.error(a.Endpoint.TemplateCopy,e);return[0,new Error((t=e.errors)==null?void 0:(i=t[0])==null?void 0:i.message)]}}async getTask(e,s){try{var o,d,p,m;const u=await r.apiClient.post(a.Endpoint.TaskFromTemplateGet,{templateId:e});u.id=s;u.templateId=e;const v=i.Core.getParams().rights.user.admin;if(!v&&(((o=u.responsible)==null?void 0:o.id)!==i.Core.getParams().currentUser.id||t.Type.isArrayFilled(u.multiResponsibles))){u.creator=i.Core.getParams().currentUser}(d=u.group)!=null?d:u.group={id:0};(p=u.stage)!=null?p:u.stage={id:0};const T=l.taskService.getStoreTask(s);if(T.flowId){u.creator=i.Core.getParams().currentUser;u.responsible=i.Core.getParams().currentUser;u.description=T.description+u.description;delete u.multiResponsibles;delete u.deadlineTs;delete u.group}if(t.Type.isArrayFilled(T.crmItemIds)){const e=new Set([...T.crmItemIds||[],...u.crmItemIds||[]]);u.crmItemIds=[...e];const s=new Set;[...T.tags||[],...u.tags||[]].forEach((e=>{if(t.Type.isString(e)){s.add(e);return}s.add(e.name)}));u.tags=[...s].map((e=>({name:e})))}if(t.Type.isArrayFilled(u.userFields)){u.userFields=c.userFieldsManager.prepareUserFieldsForTaskFromTemplate(u.userFields,i.Core.getParams().taskUserFieldScheme)}l.taskService.extractTask(u,false);if(((m=u.checklist)==null?void 0:m.length)>0){await n.checkListService.load(s)}}catch(e){console.error(a.Endpoint.TaskFromTemplateGet,e)}}async addTask(e,t,s){try{const i=await r.apiClient.post(a.Endpoint.TaskFromTemplateAdd,{template:{id:e},task:l.TaskMappers.mapModelToDto(t),withSubTasks:s});i.templateId=0;await l.taskService.onAfterTaskAdded(t,i);return[i.id,null]}catch(e){var i,o;console.error(a.Endpoint.TaskFromTemplateAdd,e);return[0,new Error((i=e.errors)==null?void 0:(o=i[0])==null?void 0:o.message)]}}async update(e,t){const i=l.taskService.getStoreTask(e);if(!l.taskService.hasChanges(i,t)){return}l.taskService.updateStoreTask(e,t);if(!o.idUtils.isReal(e)){return}s.EventEmitter.emit(a.EventName.TemplateBeforeUpdate,{template:l.taskService.getStoreTask(e),fields:{id:e,...t}});await babelHelpers.classPrivateFieldLooseBase(this,L)[L](e,t,i)}async delete(e){const t=l.taskService.getStoreTask(e);await l.taskService.deleteStore(e);if(!o.idUtils.isReal(e)){return}const i=o.idUtils.unbox(e);try{await r.apiClient.post(a.Endpoint.TemplateDelete,{templateId:i});s.EventEmitter.emit(a.EventName.TemplateDeleted,{id:i})}catch(e){await l.taskService.insertStoreTask(t);console.error(a.Endpoint.TemplateDelete,e)}}async insertStoreTask(e){await this.$store.dispatch(`${a.Model.Tasks}/insert`,{...e,permissions:[]})}get $store(){return i.Core.getStore()}});function H(e,s,i){var a,r,l,o,n,d;babelHelpers.classPrivateFieldLooseBase(this,I)[I][e]={...babelHelpers.classPrivateFieldLooseBase(this,I)[I][e],...s};(r=(a=babelHelpers.classPrivateFieldLooseBase(this,f)[f])[e])!=null?r:a[e]=i;(o=(l=babelHelpers.classPrivateFieldLooseBase(this,B)[B])[e])!=null?o:l[e]=new D;(d=(n=babelHelpers.classPrivateFieldLooseBase(this,w)[w])[e])!=null?d:n[e]=t.Runtime.debounce(babelHelpers.classPrivateFieldLooseBase(this,C)[C],500,this);babelHelpers.classPrivateFieldLooseBase(this,w)[w][e](e);return babelHelpers.classPrivateFieldLooseBase(this,B)[B][e]}async function A(e){const t=babelHelpers.classPrivateFieldLooseBase(this,I)[I][e];delete babelHelpers.classPrivateFieldLooseBase(this,I)[I][e];const s=babelHelpers.classPrivateFieldLooseBase(this,f)[f][e];delete babelHelpers.classPrivateFieldLooseBase(this,f)[f][e];const i=babelHelpers.classPrivateFieldLooseBase(this,B)[B][e];delete babelHelpers.classPrivateFieldLooseBase(this,B)[B][e];const n=o.idUtils.unbox(e);try{await r.apiClient.post(a.Endpoint.TemplateUpdate,{template:l.TaskMappers.mapModelToDto({id:n,...t})})}catch(t){l.taskService.updateStoreTask(e,s);console.error(a.Endpoint.TemplateUpdate,t)}i.resolve()}function D(){const e=new Promise((e=>{this.resolve=e}));e.resolve=this.resolve;return e}const X={mapPermissionDtoToModel:h,mapPermissionModelToDto:k,mapDtoToTaskDto:P,mapRights:g};e.TemplateMappers=X;e.templateService=U;e.permissionBuilder=v})(this.BX.Tasks.V2.Provider.Service=this.BX.Tasks.V2.Provider.Service||{},BX,BX.Event,BX.Tasks.V2,BX.Tasks.V2.Const,BX.Tasks.V2.Lib,BX.Tasks.V2.Provider.Service,BX.Tasks.V2.Lib,BX.Tasks.V2.Provider.Service,BX.Tasks.V2.Provider.Service,BX.Tasks.V2.Component.Fields);
//# sourceMappingURL=template-service.bundle.map.js