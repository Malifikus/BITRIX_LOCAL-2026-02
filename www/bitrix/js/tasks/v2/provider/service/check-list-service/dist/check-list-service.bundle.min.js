this.BX=this.BX||{};this.BX.Tasks=this.BX.Tasks||{};this.BX.Tasks.V2=this.BX.Tasks.V2||{};this.BX.Tasks.V2.Provider=this.BX.Tasks.V2.Provider||{};(function(e,s,t,a,i,l,o,r,n){"use strict";function d(e){const s=new Map;e.forEach((e=>{s.set(e.id,e.nodeId)}));return e.map((e=>{const t=e.parentId?s.get(e.parentId):0;return{...e,parentNodeId:t}}))}function c(e){return e.map((e=>{const s=v(e);return{...e,title:s}}))}function p(e){var s,a;return{id:e.id,nodeId:e.nodeId,title:e.title,creator:e.creator?t.UserMappers.mapDtoToModel(e.creator):null,toggledBy:e.toggledBy?t.UserMappers.mapDtoToModel(e.toggledBy):null,toggledDate:e.toggledDate,accomplices:(s=e.accomplices)==null?void 0:s.map((e=>t.UserMappers.mapDtoToModel(e))),auditors:(a=e.auditors)==null?void 0:a.map((e=>t.UserMappers.mapDtoToModel(e))),attachments:e.attachments,isComplete:e.isComplete,isImportant:e.isImportant,parentId:e.parentId,parentNodeId:e.parentNodeId,sortIndex:e.sortIndex,actions:e.actions,panelIsShown:e.panelIsShown,myFilterActive:e.myFilterActive,collapsed:e.collapsed,expanded:e.expanded,localCompleteState:e.localCompleteState,localCollapsedState:e.localCollapsedState,areCompletedCollapsed:e.areCompletedCollapsed,hidden:e.hidden,groupMode:e.groupMode}}function h(e){return Object.fromEntries(e.map((e=>{var t,a,i,l,o;const r=(t=e.accomplices)==null?void 0:t.map((e=>({ID:e.id,TYPE:"A",NAME:e.name,IMAGE:e.image,IS_COLLABER:e.type===s.UserTypes.Collaber?1:""})));const n=(a=e.auditors)==null?void 0:a.map((e=>({ID:e.id,TYPE:"U",NAME:e.name,IMAGE:e.image,IS_COLLABER:e.type===s.UserTypes.Collaber?1:""})));const d=Object.fromEntries((i=e.attachments)==null?void 0:i.map((e=>[e,e])));const c=[...r,...n].reduce(((e,s)=>{e[s.ID]=s;return e}),{});const p=v(e);const h=Object.fromEntries(Object.entries({NODE_ID:e.nodeId,TITLE:p,CREATED_BY:(l=e.creator)==null?void 0:l.id,TOGGLED_BY:(o=e.toggledBy)==null?void 0:o.id,TOGGLED_DATE:e.toggledDate,MEMBERS:c,NEW_FILE_IDS:d,ATTACHMENTS:d,IS_COMPLETE:e.isComplete,IS_IMPORTANT:e.isImportant,PARENT_ID:e.parentId,SORT_INDEX:e.sortIndex,ACTIONS:{MODIFY:e.actions.modify,REMOVE:e.actions.remove,TOGGLE:e.actions.toggle}}).filter((([,e])=>e!==null&&e!==undefined)));return[e.nodeId,h]})))}function u(e,s){return e.flatMap((e=>(e[s]||[]).map((e=>e.id)))).filter(((e,s,t)=>t.indexOf(e)===s))}function v(e){var s,t;const a=[...((s=e.accomplices)!=null?s:[]).map((e=>e.name)),...((t=e.auditors)!=null?t:[]).map((e=>e.name))].join(" ");if(a){return`${e.title} ${a}`}return e.title}var b=babelHelpers.classPrivateFieldLooseKey("getPromises");var m=babelHelpers.classPrivateFieldLooseKey("completeCheckListIds");var L=babelHelpers.classPrivateFieldLooseKey("renewCheckListIds");var P=babelHelpers.classPrivateFieldLooseKey("completePromises");var k=babelHelpers.classPrivateFieldLooseKey("renewPromises");var f=babelHelpers.classPrivateFieldLooseKey("completeDebounced");var I=babelHelpers.classPrivateFieldLooseKey("renewDebounced");var y=babelHelpers.classPrivateFieldLooseKey("completeCheckLists");var B=babelHelpers.classPrivateFieldLooseKey("renewCheckLists");var C=babelHelpers.classPrivateFieldLooseKey("getRootId");var T=babelHelpers.classPrivateFieldLooseKey("getById");var g=babelHelpers.classPrivateFieldLooseKey("updateTask");var w=babelHelpers.classPrivateFieldLooseKey("clone");class F{constructor(){Object.defineProperty(this,w,{value:$});Object.defineProperty(this,g,{value:O});Object.defineProperty(this,T,{value:S});Object.defineProperty(this,C,{value:E});Object.defineProperty(this,B,{value:M});Object.defineProperty(this,y,{value:H});Object.defineProperty(this,b,{writable:true,value:{}});Object.defineProperty(this,m,{writable:true,value:{}});Object.defineProperty(this,L,{writable:true,value:{}});Object.defineProperty(this,P,{writable:true,value:{}});Object.defineProperty(this,k,{writable:true,value:{}});Object.defineProperty(this,f,{writable:true,value:{}});Object.defineProperty(this,I,{writable:true,value:{}});this.handleBeforeUnload=()=>{void this.forceSaveAllPending()};a.Event.bind(window,"beforeunload",this.handleBeforeUnload)}async load(e,s){const t=n.taskService.getStoreTask(e);if(!r.idUtils.isReal(e)&&t.templateId){await this.load(r.idUtils.boxTemplate(t.templateId),e);return}const a=r.idUtils.isTemplate(e);const i=s!=null?s:e;const d=a?"Template.CheckList.get":l.Endpoint.CheckListGet;const c=a?"templateId":"taskId";babelHelpers.classPrivateFieldLooseBase(this,b)[b][i]=new Promise((async(t,a)=>{try{const a=await o.apiClient.post(d,{[c]:r.idUtils.unbox(e)});let h=a.map((e=>p(e)));if(s){h=babelHelpers.classPrivateFieldLooseBase(this,w)[w](h)}await Promise.all([this.$store.dispatch(`${l.Model.CheckList}/upsertMany`,h),n.taskService.updateStoreTask(i,{containsChecklist:h.length>0,checklist:h.map((({id:e})=>e))})]);t()}catch(e){a(e)}}));await babelHelpers.classPrivateFieldLooseBase(this,b)[b][i]}async save(e,s,t=false){return new Promise((async(h,u)=>{try{const u=r.idUtils.isTemplate(e);const v=r.idUtils.unbox(e);const b=u?"Template.CheckList.save":l.Endpoint.CheckListSave;const m=u?"template":"task";const L=i.Core.getParams().features;const P=n.taskService.getStoreTask(e);const k=L.isV2Enabled||a.Type.isArray(L.allowedGroups)&&L.allowedGroups.includes(P.groupId);if(!k){s=c(s)}const f=await o.apiClient.post(b,{[m]:{id:v,checklist:d(s)},skipNotification:t});const I=f.map((e=>p(e)));await Promise.all([this.$store.dispatch(`${l.Model.Interface}/setDisableCheckListAnimations`,true),this.$store.dispatch(`${l.Model.CheckList}/upsertMany`,I)]);await babelHelpers.classPrivateFieldLooseBase(this,g)[g](e,I);void this.$store.dispatch(`${l.Model.Interface}/setDisableCheckListAnimations`,false);h()}catch(e){u(e)}}))}async collapse(e,s){const t=r.idUtils.isTemplate(e);const a=r.idUtils.unbox(e);const i=t?"Template.CheckList.collapse":l.Endpoint.CheckListCollapse;const n=t?"template":"task";await o.apiClient.post(i,{[`${n}Id`]:a,checkListId:s});void this.$store.dispatch(`${l.Model.CheckList}/update`,{id:s,fields:{collapsed:true,expanded:false}})}async expand(e,s){const t=r.idUtils.isTemplate(e);const a=r.idUtils.unbox(e);const i=t?"Template.CheckList.expand":l.Endpoint.CheckListExpand;const n=t?"template":"task";await o.apiClient.post(i,{[`${n}Id`]:a,checkListId:s});void this.$store.dispatch(`${l.Model.CheckList}/update`,{id:s,fields:{collapsed:false,expanded:true}})}async complete(e,s){var t,i,o,r,n,d;await this.$store.dispatch(`${l.Model.CheckList}/update`,{id:s,fields:{isComplete:true}});(i=(t=babelHelpers.classPrivateFieldLooseBase(this,m)[m])[e])!=null?i:t[e]=new Set;babelHelpers.classPrivateFieldLooseBase(this,m)[m][e].add(s);(r=(o=babelHelpers.classPrivateFieldLooseBase(this,P)[P])[e])!=null?r:o[e]=new U;(d=(n=babelHelpers.classPrivateFieldLooseBase(this,f)[f])[e])!=null?d:n[e]=a.Runtime.debounce(babelHelpers.classPrivateFieldLooseBase(this,y)[y],1500,this);babelHelpers.classPrivateFieldLooseBase(this,f)[f][e](e);await babelHelpers.classPrivateFieldLooseBase(this,P)[P][e]}async renew(e,s){var t,i,o,r,n,d;await this.$store.dispatch(`${l.Model.CheckList}/update`,{id:s,fields:{isComplete:false}});(i=(t=babelHelpers.classPrivateFieldLooseBase(this,L)[L])[e])!=null?i:t[e]=new Set;babelHelpers.classPrivateFieldLooseBase(this,L)[L][e].add(s);(r=(o=babelHelpers.classPrivateFieldLooseBase(this,k)[k])[e])!=null?r:o[e]=new U;(d=(n=babelHelpers.classPrivateFieldLooseBase(this,I)[I])[e])!=null?d:n[e]=a.Runtime.debounce(babelHelpers.classPrivateFieldLooseBase(this,B)[B],1500,this);babelHelpers.classPrivateFieldLooseBase(this,I)[I][e](e);await babelHelpers.classPrivateFieldLooseBase(this,k)[k][e]}async delete(e,s){const t=n.taskService.getStoreTask(e);const a=this.$store.getters[`${l.Model.CheckList}/getByIds`](t.checklist);await this.save(e,a)}isCheckListExists(e){return babelHelpers.classPrivateFieldLooseBase(this,T)[T](e)!==null}filterItemsBelongingToCheckList(e,s){const t=[];s.forEach((s=>{const a=babelHelpers.classPrivateFieldLooseBase(this,C)[C](s);if(a===e){t.push(s)}}));return t}async forceCompletePending(e){var s;if(((s=babelHelpers.classPrivateFieldLooseBase(this,m)[m][e])==null?void 0:s.size)>0){await babelHelpers.classPrivateFieldLooseBase(this,y)[y](e)}}async forceRenewPending(e){var s;if(((s=babelHelpers.classPrivateFieldLooseBase(this,L)[L][e])==null?void 0:s.size)>0){await babelHelpers.classPrivateFieldLooseBase(this,B)[B](e)}}async forceSavePending(e){await Promise.all([this.forceCompletePending(e),this.forceRenewPending(e)])}async forceSaveAllPending(){const e=new Set([...Object.keys(babelHelpers.classPrivateFieldLooseBase(this,m)[m]),...Object.keys(babelHelpers.classPrivateFieldLooseBase(this,L)[L])]);await Promise.all([...e].map((e=>this.forceSavePending(parseInt(e,10)))))}get $store(){return i.Core.getStore()}}async function H(e){const s=r.idUtils.isTemplate(e);const t=r.idUtils.unbox(e);const a=s?"Template.CheckList.complete":l.Endpoint.CheckListComplete;const i=s?"template":"task";const n=babelHelpers.classPrivateFieldLooseBase(this,m)[m][e];delete babelHelpers.classPrivateFieldLooseBase(this,m)[m][e];const c=babelHelpers.classPrivateFieldLooseBase(this,P)[P][e];delete babelHelpers.classPrivateFieldLooseBase(this,P)[P][e];if(!n||n.size===0){c==null?void 0:c.resolve();return}try{const e=await Promise.all([...n].map((e=>this.$store.getters[`${l.Model.CheckList}/getById`](e))));await o.apiClient.post(a,{[i]:{id:t,checklist:d(e)}});c==null?void 0:c.resolve()}catch{c==null?void 0:c.resolve()}}async function M(e){const s=r.idUtils.isTemplate(e);const t=r.idUtils.unbox(e);const a=s?"Template.CheckList.renew":l.Endpoint.CheckListRenew;const i=s?"template":"task";const n=babelHelpers.classPrivateFieldLooseBase(this,L)[L][e];delete babelHelpers.classPrivateFieldLooseBase(this,L)[L][e];const c=babelHelpers.classPrivateFieldLooseBase(this,k)[k][e];delete babelHelpers.classPrivateFieldLooseBase(this,k)[k][e];if(!n||n.size===0){c==null?void 0:c.resolve();return}try{const e=await Promise.all([...n].map((async e=>this.$store.getters[`${l.Model.CheckList}/getById`](e))));await o.apiClient.post(a,{[i]:{id:t,checklist:d(e)}});c==null?void 0:c.resolve()}catch{c==null?void 0:c.resolve()}}function E(e){const s=babelHelpers.classPrivateFieldLooseBase(this,T)[T](e);if(!s){return 0}if(s.parentId===0){return s.id}return babelHelpers.classPrivateFieldLooseBase(this,C)[C](s.parentId)}function S(e){var s;return(s=this.$store.getters[`${l.Model.CheckList}/getById`](e))!=null?s:null}async function O(e,s){const t=n.taskService.getStoreTask(e);const a=new Set(t==null?void 0:t.accomplicesIds);const o=new Set(t==null?void 0:t.auditorsIds);const r=[];s.forEach((e=>{var s,t;(s=e.accomplices)==null?void 0:s.forEach((e=>{r.push(e);a.add(e.id)}));(t=e.auditors)==null?void 0:t.forEach((e=>{r.push(e);o.add(e.id)}))}));const d=[...a];const c=[...o];await i.Core.getStore().dispatch(`${l.Model.Users}/upsertMany`,r);await n.taskService.updateStoreTask(e,{containsChecklist:s.length>0,checklist:s.map((e=>e.id)),accomplicesIds:d,auditorsIds:c})}function $(e){const{idsMap:s,nodeIdsMap:t}=e.reduce(((e,{id:s,nodeId:t})=>{e.idsMap.set(s,a.Text.getRandom());if(t){e.nodeIdsMap.set(t,a.Text.getRandom())}return e}),{idsMap:new Map,nodeIdsMap:new Map});return e.map((e=>{var i,l,o;return{...e,id:s.get(e.id),copiedId:e.id,nodeId:(i=t.get(e.nodeId))!=null?i:a.Text.getRandom(),parentId:(l=s.get(e.parentId))!=null?l:0,parentNodeId:(o=t.get(e.parentNodeId))!=null?o:null,actions:{modify:true,remove:true,toggle:true}}}))}const D=new F;function U(){const e=new Promise((e=>{this.resolve=e}));e.resolve=this.resolve;return e}const x={mapModelToSliderData:h,getUserIdsFromChecklists:u};e.CheckListMappers=x;e.checkListService=D})(this.BX.Tasks.V2.Provider.Service=this.BX.Tasks.V2.Provider.Service||{},BX.Tasks.V2.Model,BX.Tasks.V2.Provider.Service,BX,BX.Tasks.V2,BX.Tasks.V2.Const,BX.Tasks.V2.Lib,BX.Tasks.V2.Lib,BX.Tasks.V2.Provider.Service);
//# sourceMappingURL=check-list-service.bundle.map.js