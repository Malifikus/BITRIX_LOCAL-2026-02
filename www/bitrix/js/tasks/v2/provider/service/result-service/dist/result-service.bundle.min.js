this.BX=this.BX||{};this.BX.Tasks=this.BX.Tasks||{};this.BX.Tasks.V2=this.BX.Tasks.V2||{};this.BX.Tasks.V2.Provider=this.BX.Tasks.V2.Provider||{};(function(e,t,s,a,i,l,r,o,n,d){"use strict";function u(e){return{id:e.id,taskId:e.taskId,text:s.Text.decode(e.text),author:e.author?t.UserMappers.mapDtoToModel(e.author):null,createdAtTs:e.createdAtTs*1e3,updatedAtTs:e.updatedAtTs*1e3,status:e.status,fileIds:e.fileIds,previewId:e.previewId,rights:e.rights,files:e.files}}function c(e){return{id:e.id,taskId:e.taskId,text:e.text,author:e.author.id,status:e.status,fileIds:e.fileIds,previewId:e.previewId}}const p=i.Limit.Results;var h=babelHelpers.classPrivateFieldLooseKey("handleResultAfterAdd");var v=babelHelpers.classPrivateFieldLooseKey("addResultToStore");var R=babelHelpers.classPrivateFieldLooseKey("updateStoreTask");class T{constructor(){Object.defineProperty(this,R,{value:f});Object.defineProperty(this,v,{value:S});Object.defineProperty(this,h,{value:k})}async get(e){const t=await r.apiClient.post(i.Endpoint.TaskResultGet,{result:{id:e}});await babelHelpers.classPrivateFieldLooseBase(this,v)[v](t)}async tail(e,t=true){const s=p;const a=1;const{results:l,map:n}=await r.apiClient.post(i.Endpoint.TaskResultTail,{taskId:e,withMap:t,navigation:{size:s,page:a}});for(const e of l){await babelHelpers.classPrivateFieldLooseBase(this,v)[v](e)}if(t){const t=Object.keys(n).map((e=>parseInt(e,10))).reverse();void o.taskService.updateStoreTask(e,{results:t,resultsMessageMap:n})}}async getAll(e){const{results:t}=await r.apiClient.post(i.Endpoint.TaskResultGetAll,{taskId:e,withMap:false});for(const e of t){await babelHelpers.classPrivateFieldLooseBase(this,v)[v](e)}}async save(e,t,s=false){const a=t.map((t=>c({...t,taskId:e})));const l=a.map((e=>e.id));try{const t=await r.apiClient.post(i.Endpoint.TaskResultAdd,{results:a,skipNotification:s});for(const s of t){const a=t.indexOf(s);const i=l[a];await babelHelpers.classPrivateFieldLooseBase(this,h)[h](e,i,s)}}catch(t){console.error("ResultService.save error",t);l.forEach((t=>{this.deleteResultFromTask(e,t);void this.deleteStoreResult(t)}))}}async add(e,t){const s=t.id;try{await this.updateStoreResult(s,t);this.addResultToTask(e,s);if(!l.idUtils.isReal(e)){return true}const a=await r.apiClient.post(i.Endpoint.TaskResultAdd,{results:[c(t)]});await babelHelpers.classPrivateFieldLooseBase(this,h)[h](e,s,a[0]);return true}catch(t){console.error("ResultService.add error",t);this.deleteResultFromTask(e,s);await this.deleteStoreResult(s);return false}}async update(e,t){const s=this.getStoreResult(e);const a=s==null?void 0:s.taskId;const o={...s,...t};await this.updateStoreResult(e,t);if(!l.idUtils.isReal(a)){return}try{await r.apiClient.post(i.Endpoint.TaskResultUpdate,{result:c(o)})}catch(t){await this.updateStoreResult(e,s);console.error("ResultService.update error",t)}}async delete(e){const t=this.getStoreResult(e);const s=t==null?void 0:t.taskId;this.deleteResultFromTask(s,e);await this.deleteStoreResult(e);if(!l.idUtils.isReal(s)){return}try{await r.apiClient.post(i.Endpoint.TaskResultDelete,{result:{id:e}})}catch(a){console.error("ResultService.delete error",a);await this.insertStoreResult(t);this.addResultToTask(s,e)}}async addResultFromMessage(e,t,s){const a=s.id;try{await babelHelpers.classPrivateFieldLooseBase(this,v)[v](s);this.addResultToTask(e,a,t);const l=await r.apiClient.post(i.Endpoint.TaskResultMessageAdd,{message:{id:t}});await babelHelpers.classPrivateFieldLooseBase(this,h)[h](e,a,l);return true}catch(t){console.error("ResultService.addResultFromMessage error",t);this.deleteResultFromTask(e,a);await this.deleteStoreResult(a);return false}}hasOpenedResults(e){const t=o.taskService.getStoreTask(e);if(!(t!=null&&t.results.length)>0){return false}for(const e of t.results){const t=this.getStoreResult(e);if(t&&t.status===i.ResultStatus.Open){return true}}return false}async closeResults(e){const t=o.taskService.getStoreTask(e);if(!(t!=null&&t.results.length)>0){return}for(const e of t.results){const t=this.getStoreResult(e);if(t&&t.status===i.ResultStatus.Open){await this.updateStoreResult(e,{status:i.ResultStatus.Closed})}}}getStoreResult(e){return this.$store.getters[`${i.Model.Results}/getById`](e)||null}hasStoreResult(e){return Boolean(this.getStoreResult(e))}async insertStoreResult(e){await this.$store.dispatch(`${i.Model.Results}/insert`,e)}async updateStoreResult(e,t){await this.$store.dispatch(`${i.Model.Results}/update`,{id:e,fields:t})}async deleteStoreResult(e){await this.$store.dispatch(`${i.Model.Results}/delete`,e)}addResultToTask(e,t,s=null){const a=o.taskService.getStoreTask(e);const i=[t,...(a==null?void 0:a.results)||[]];const l={...a==null?void 0:a.resultsMessageMap,[t]:s};babelHelpers.classPrivateFieldLooseBase(this,R)[R](e,i,l)}deleteResultFromTask(e,t){const s=o.taskService.getStoreTask(e);const a=((s==null?void 0:s.results)||[]).filter((e=>e!==t));const i={...s==null?void 0:s.resultsMessageMap};delete i[t];babelHelpers.classPrivateFieldLooseBase(this,R)[R](e,a,i)}get $store(){return a.Core.getStore()}}async function k(e,t,s){const{id:a}=s;n.fileService.replace(t,a,n.EntityTypes.Result);d.entityTextEditor.replace(t,a,d.EntityTextTypes.Result);await babelHelpers.classPrivateFieldLooseBase(this,v)[v](s);const i=o.taskService.getStoreTask(e);const l=((i==null?void 0:i.results)||[]).includes(t);if(l){const s=((i==null?void 0:i.results)||[]).map((e=>e===t?a:e));const l={...i==null?void 0:i.resultsMessageMap};l[a]=l[t];delete l[t];babelHelpers.classPrivateFieldLooseBase(this,R)[R](e,s,l)}else{this.addResultToTask(e,a)}await this.deleteStoreResult(t)}async function S(e){const t=u(e);await this.insertStoreResult(t);if(s.Type.isArrayFilled(t.files)){n.fileService.get(t.id,n.EntityTypes.Result).loadFilesFromData(t.files)}d.entityTextEditor.get(t.id,d.EntityTextTypes.Result,{content:t.text,blockSpaceInline:"var(--ui-space-stack-xl)"})}function f(e,t,s){const a=t.length>0;void o.taskService.updateStoreTask(e,{results:t,resultsMessageMap:s,containsResults:a})}const y=new T;const w={mapModelToDto:c,mapDtoToModel:u};e.ResultMappers=w;e.resultService=y})(this.BX.Tasks.V2.Provider.Service=this.BX.Tasks.V2.Provider.Service||{},BX.Tasks.V2.Provider.Service,BX,BX.Tasks.V2,BX.Tasks.V2.Const,BX.Tasks.V2.Lib,BX.Tasks.V2.Lib,BX.Tasks.V2.Provider.Service,BX.Tasks.V2.Provider.Service,BX.Tasks.V2.Component);
//# sourceMappingURL=result-service.bundle.map.js