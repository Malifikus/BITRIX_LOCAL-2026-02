{"version":3,"file":"status-service.bundle.js","sources":["../src/status-service.js"],"sourcesContent":["import { Event } from 'main.core';\n\nimport { Core } from 'tasks.v2.core';\nimport { EventName, Model, TaskStatus, Endpoint } from 'tasks.v2.const';\nimport { analytics } from 'tasks.v2.lib.analytics';\nimport { ScrumManager } from 'tasks.v2.lib.scrum-manager';\nimport { apiClient } from 'tasks.v2.lib.api-client';\nimport { idUtils } from 'tasks.v2.lib.id-utils';\nimport { taskService } from 'tasks.v2.provider.service.task-service';\nimport { resultService } from 'tasks.v2.provider.service.result-service';\n\nexport const statusService = new class\n{\n\tasync start(id: number): Promise<void>\n\t{\n\t\tawait this.#updateStatus(id, Endpoint.TaskStatusStart, TaskStatus.InProgress);\n\t}\n\n\tasync take(id: number): Promise<void>\n\t{\n\t\tawait this.#updateStatus(id, Endpoint.TaskStatusTake, TaskStatus.InProgress);\n\t}\n\n\tasync startTimer(id: number): Promise<void>\n\t{\n\t\tawait this.#updateStatus(id, 'Task.Tracking.Timer.start', TaskStatus.InProgress);\n\t}\n\n\tasync disapprove(id: number): Promise<void>\n\t{\n\t\tawait this.#updateStatus(id, Endpoint.TaskStatusDisapprove, TaskStatus.Pending);\n\t}\n\n\tasync defer(id: number): Promise<void>\n\t{\n\t\tawait this.#updateStatus(id, Endpoint.TaskStatusDefer, TaskStatus.Deferred);\n\t}\n\n\tasync approve(id: number): Promise<void>\n\t{\n\t\tawait this.#updateStatus(id, Endpoint.TaskStatusApprove, TaskStatus.Completed);\n\t}\n\n\tasync pause(id: number): Promise<void>\n\t{\n\t\tawait this.#updateStatus(id, Endpoint.TaskStatusPause, TaskStatus.Pending);\n\t}\n\n\tasync pauseTimer(id: number): Promise<void>\n\t{\n\t\tawait this.#updateStatus(id, 'Task.Tracking.Timer.stop', TaskStatus.Pending);\n\t}\n\n\tasync complete(id: number, analyticsParams: Object = {}): Promise<void>\n\t{\n\t\tconst task = taskService.getStoreTask(id);\n\t\tif (!task)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tconst currentUserId = Core.getStore().getters[`${Model.Interface}/currentUserId`];\n\t\tif (\n\t\t\ttask.requireResult\n\t\t\t&& !Core.getParams().rights.user.admin\n\t\t\t&& currentUserId !== task.creatorId\n\t\t\t&& !resultService.hasOpenedResults(id)\n\t\t)\n\t\t{\n\t\t\tEvent.EventEmitter.emit(EventName.RequiredResultsMissing, { taskId: id });\n\n\t\t\treturn;\n\t\t}\n\n\t\tconst group = Core.getStore().getters[`${Model.Groups}/getById`](task.groupId);\n\n\t\tconst scrumManager = new ScrumManager({\n\t\t\ttaskId: task.id,\n\t\t\tparentId: task.parentId,\n\t\t\tgroupId: task.groupId,\n\t\t});\n\n\t\tlet canComplete = true;\n\t\tif (scrumManager.isScrum(group?.type))\n\t\t{\n\t\t\tcanComplete = await scrumManager.handleDodDisplay();\n\t\t}\n\n\t\tif (!canComplete)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tconst status = task.needsControl ? TaskStatus.SupposedlyCompleted : TaskStatus.Completed;\n\n\t\tawait this.#updateStatus(id, Endpoint.TaskStatusComplete, status);\n\n\t\tif (scrumManager.isScrum(group?.type))\n\t\t{\n\t\t\tvoid scrumManager?.handleParentState();\n\t\t}\n\n\t\tif (analyticsParams.context)\n\t\t{\n\t\t\tanalytics.sendTaskComplete(analyticsParams, {\n\t\t\t\ttaskId: task.id,\n\t\t\t});\n\t\t}\n\n\t\tvoid resultService.closeResults(id);\n\t}\n\n\tasync renew(id: number): Promise<void>\n\t{\n\t\tawait this.#updateStatus(id, Endpoint.TaskStatusRenew, TaskStatus.Pending);\n\t}\n\n\tasync #updateStatus(id: number, action: string, status: string): Promise<void>\n\t{\n\t\tconst taskBeforeUpdate = taskService.getStoreTask(id);\n\n\t\tif (!idUtils.isReal(id))\n\t\t{\n\t\t\ttaskService.updateStoreTask(id, { status });\n\n\t\t\treturn;\n\t\t}\n\n\t\ttry\n\t\t{\n\t\t\tconst data = await apiClient.post(action, { task: { id } });\n\n\t\t\ttaskService.updateStoreTask(id, { status });\n\n\t\t\ttaskService.extractTask(data);\n\t\t}\n\t\tcatch (error)\n\t\t{\n\t\t\ttaskService.updateStoreTask(id, taskBeforeUpdate);\n\n\t\t\tconsole.error(`StatusService: ${action} error`, error);\n\t\t}\n\t}\n}();\n"],"names":["statusService","start","id","Endpoint","TaskStatusStart","TaskStatus","InProgress","take","TaskStatusTake","startTimer","disapprove","TaskStatusDisapprove","Pending","defer","TaskStatusDefer","Deferred","approve","TaskStatusApprove","Completed","pause","TaskStatusPause","pauseTimer","complete","analyticsParams","task","taskService","getStoreTask","currentUserId","Core","getStore","getters","Model","Interface","requireResult","getParams","rights","user","admin","creatorId","resultService","hasOpenedResults","Event","EventEmitter","emit","EventName","RequiredResultsMissing","taskId","group","Groups","groupId","scrumManager","ScrumManager","parentId","canComplete","isScrum","type","handleDodDisplay","status","needsControl","SupposedlyCompleted","TaskStatusComplete","handleParentState","context","analytics","sendTaskComplete","closeResults","renew","TaskStatusRenew","action","taskBeforeUpdate","idUtils","isReal","updateStoreTask","data","apiClient","post","extractTask","error","console"],"mappings":"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"}