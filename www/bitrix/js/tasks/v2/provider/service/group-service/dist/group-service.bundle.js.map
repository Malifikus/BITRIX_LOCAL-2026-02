{"version":3,"file":"group-service.bundle.js","sources":["../src/mappers.js","../src/group-service.js","../src/index.js"],"sourcesContent":["import { Type } from 'main.core';\nimport type { GroupModel } from 'tasks.v2.model.groups';\nimport type { StageModel } from 'tasks.v2.model.stages';\nimport type { GroupDto, StageDto } from './types';\n\nexport function mapDtoToModel(groupDto: GroupDto): GroupModel\n{\n\treturn {\n\t\tid: groupDto.id,\n\t\tname: groupDto.name,\n\t\timage: groupDto.image?.src,\n\t\ttype: groupDto.type,\n\t\tstagesIds: groupDto.stages?.map(({ id }) => id),\n\t};\n}\n\nexport function mapStageDtoToModel(stageDto: StageDto): StageModel\n{\n\tconst stage: StageModel = {\n\t\tid: stageDto.id,\n\t\ttitle: stageDto.title,\n\t\tcolor: stageDto.color,\n\t\tsystemType: stageDto.systemType,\n\t\tsort: stageDto.sort,\n\t};\n\n\treturn Object.fromEntries(Object.entries(stage).filter(([, value]) => !Type.isNil(value)));\n}\n","import { Core } from 'tasks.v2.core';\nimport { GroupType, Model, Endpoint } from 'tasks.v2.const';\nimport { apiClient } from 'tasks.v2.lib.api-client';\nimport { taskService } from 'tasks.v2.provider.service.task-service';\nimport type { GroupModel } from 'tasks.v2.model.groups';\n\nimport { mapDtoToModel, mapStageDtoToModel } from './mappers';\nimport type { GroupInfo } from './types';\n\nclass GroupService\n{\n\tasync getUrl(id: number, type: string): Promise<string>\n\t{\n\t\tif (type !== GroupType.Collab)\n\t\t{\n\t\t\treturn `/workgroups/group/${id}/`;\n\t\t}\n\n\t\ttry\n\t\t{\n\t\t\treturn apiClient.post(Endpoint.GroupUrlGet, { group: { id, type } });\n\t\t}\n\t\tcatch (error)\n\t\t{\n\t\t\tconsole.error('GroupService: getUrl error', error);\n\n\t\t\treturn '';\n\t\t}\n\t}\n\n\tasync getStages(id: number): Promise<void>\n\t{\n\t\ttry\n\t\t{\n\t\t\tconst data = await apiClient.post(Endpoint.GroupStageList, { group: { id } });\n\n\t\t\tconst stages = data.map((stage) => mapStageDtoToModel(stage));\n\t\t\tconst stagesIds = stages.map((stage) => stage.id);\n\n\t\t\tawait Promise.all([\n\t\t\t\tCore.getStore().dispatch(`${Model.Stages}/upsertMany`, stages),\n\t\t\t\tCore.getStore().dispatch(`${Model.Groups}/update`, {\n\t\t\t\t\tid,\n\t\t\t\t\tfields: { stagesIds },\n\t\t\t\t}),\n\t\t\t]);\n\t\t}\n\t\tcatch (error)\n\t\t{\n\t\t\tconsole.error('GroupService: getStages error', error);\n\t\t}\n\t}\n\n\tasync getGroup(id: number): Promise<?GroupModel>\n\t{\n\t\ttry\n\t\t{\n\t\t\tconst data = await apiClient.post(Endpoint.GroupGet, { group: { id } });\n\n\t\t\tconst group = mapDtoToModel(data);\n\n\t\t\tawait Core.getStore().dispatch(`${Model.Groups}/insert`, group);\n\n\t\t\treturn group;\n\t\t}\n\t\tcatch (error)\n\t\t{\n\t\t\tconsole.error('GroupService: getGroup error', error);\n\n\t\t\treturn null;\n\t\t}\n\t}\n\n\t#scrumInfoPromises: { [taskId: number | string]: Promise } = {};\n\n\tasync getScrumInfo(taskId: number): Promise<void>\n\t{\n\t\tif (this.hasScrumInfo(taskId))\n\t\t{\n\t\t\tawait this.#scrumInfoPromises[taskId];\n\n\t\t\treturn;\n\t\t}\n\n\t\tthis.#scrumInfoPromises[taskId] = new Resolvable();\n\n\t\ttry\n\t\t{\n\t\t\tconst data = await apiClient.post(Endpoint.ScrumGetTaskInfo, { taskId });\n\n\t\t\tawait Promise.all([\n\t\t\t\tCore.getStore().dispatch(`${Model.Epics}/upsert`, data.epic),\n\t\t\t\ttaskService.updateStoreTask(taskId, {\n\t\t\t\t\tstoryPoints: data.storyPoints,\n\t\t\t\t\tepicId: data.epic?.id,\n\t\t\t\t}),\n\t\t\t]);\n\n\t\t\tthis.#scrumInfoPromises[taskId].resolve();\n\t\t}\n\t\tcatch (error)\n\t\t{\n\t\t\tconsole.error('GroupService: getScrumInfo error', error);\n\t\t}\n\t}\n\n\tsetHasScrumInfo(taskId: number): boolean\n\t{\n\t\tthis.#scrumInfoPromises[taskId] = new Resolvable();\n\t\tthis.#scrumInfoPromises[taskId].resolve();\n\t}\n\n\thasScrumInfo(taskId: number | string): boolean\n\t{\n\t\treturn (Number.isInteger(taskId) && taskId > 0) ? (taskId in this.#scrumInfoPromises) : true;\n\t}\n\n\t#groupInfoPromises: { [groupId: number]: Promise<GroupInfo> } = {};\n\n\tasync getGroupInfo(groupId: number): Promise<GroupInfo>\n\t{\n\t\tif (this.#groupInfoPromises[groupId])\n\t\t{\n\t\t\treturn this.#groupInfoPromises[groupId];\n\t\t}\n\n\t\tthis.#groupInfoPromises[groupId] = new Resolvable();\n\n\t\ttry\n\t\t{\n\t\t\tconst GroupFields = Object.freeze({\n\t\t\t\tOwnerData: 'OWNER_DATA',\n\t\t\t\tDateCreate: 'DATE_CREATE',\n\t\t\t\tSubjectData: 'SUBJECT_DATA',\n\t\t\t\tNumberOfMembers: 'NUMBER_OF_MEMBERS',\n\t\t\t});\n\n\t\t\tconst { data } = await BX.ajax.runAction('socialnetwork.api.workgroup.get', {\n\t\t\t\tdata: {\n\t\t\t\t\tparams: {\n\t\t\t\t\t\tselect: Object.values(GroupFields),\n\t\t\t\t\t\tgroupId,\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t});\n\n\t\t\tthis.#groupInfoPromises[groupId].resolve({\n\t\t\t\townerId: data[GroupFields.OwnerData]?.ID,\n\t\t\t\townerName: data[GroupFields.OwnerData]?.FORMATTED_NAME,\n\t\t\t\tdateCreate: data[GroupFields.DateCreate],\n\t\t\t\tsubjectTitle: data[GroupFields.SubjectData]?.NAME,\n\t\t\t\tnumberOfMembers: data[GroupFields.NumberOfMembers],\n\t\t\t});\n\n\t\t\treturn this.#groupInfoPromises[groupId];\n\t\t}\n\t\tcatch (error)\n\t\t{\n\t\t\tconsole.error('GroupService: getGroupInfo error', error);\n\n\t\t\treturn {};\n\t\t}\n\t}\n}\n\nexport const groupService = new GroupService();\n\nfunction Resolvable(): Promise\n{\n\tconst promise = new Promise((resolve) => {\n\t\tthis.resolve = resolve;\n\t});\n\n\tpromise.resolve = this.resolve;\n\n\treturn promise;\n}\n","import { mapDtoToModel, mapStageDtoToModel } from './mappers';\n\nexport { groupService } from './group-service';\nexport const GroupMappers = { mapDtoToModel, mapStageDtoToModel };\nexport type { GroupDto, StageDto } from './types';\n"],"names":["mapDtoToModel","groupDto","id","name","image","src","type","stagesIds","stages","map","mapStageDtoToModel","stageDto","stage","title","color","systemType","sort","Object","fromEntries","entries","filter","value","Type","isNil","GroupService","getUrl","GroupType","Collab","apiClient","post","Endpoint","GroupUrlGet","group","error","console","getStages","data","GroupStageList","Promise","all","Core","getStore","dispatch","Model","Stages","Groups","fields","getGroup","GroupGet","getScrumInfo","taskId","hasScrumInfo","Resolvable","ScrumGetTaskInfo","Epics","epic","taskService","updateStoreTask","storyPoints","epicId","resolve","setHasScrumInfo","Number","isInteger","getGroupInfo","groupId","GroupFields","freeze","OwnerData","DateCreate","SubjectData","NumberOfMembers","BX","ajax","runAction","params","select","values","ownerId","ID","ownerName","FORMATTED_NAME","dateCreate","subjectTitle","NAME","numberOfMembers","groupService","promise","GroupMappers"],"mappings":"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"}