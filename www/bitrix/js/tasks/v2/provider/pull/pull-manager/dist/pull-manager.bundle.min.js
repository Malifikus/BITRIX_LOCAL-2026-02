this.BX=this.BX||{};this.BX.Tasks=this.BX.Tasks||{};this.BX.Tasks.V2=this.BX.Tasks.V2||{};this.BX.Tasks.V2.Provider=this.BX.Tasks.V2.Provider||{};(function(e,s,t,a,r,l,i,o,d,n,c,u,v,b){"use strict";class p{constructor(){if(new.target===p){throw new TypeError("BasePullHandler: An abstract class cannot be instantiated")}}getMap(){return{}}getDelayedMap(){return{}}}var P=babelHelpers.classPrivateFieldLooseKey("handleTagsDeleted");var h=babelHelpers.classPrivateFieldLooseKey("handleTagDeleted");var f=babelHelpers.classPrivateFieldLooseKey("currentUserId");class T extends p{constructor(...e){super(...e);Object.defineProperty(this,f,{get:y,set:void 0});Object.defineProperty(this,P,{writable:true,value:({tagNames:e,userId:s,groupId:t})=>{e.forEach((e=>babelHelpers.classPrivateFieldLooseBase(this,h)[h]({tagName:e,userId:s,groupId:t})))}});Object.defineProperty(this,h,{writable:true,value:({tagName:e,userId:s,groupId:a})=>{if(!a&&s!==babelHelpers.classPrivateFieldLooseBase(this,f)[f]){return}const r=this.$store.getters[`${d.Model.Tasks}/getAll`];const l=r.filter((s=>(s.groupId||0)===(a||0)&&s.tags.includes(e)));l.forEach((s=>{void u.taskService.updateStoreTask(s.id,{tags:s.tags.filter((s=>s!==e))})}));t.EventEmitter.emit(d.EventName.TagDeleted,{tagName:e,groupId:a})}})}getMap(){return{tags_deleted:babelHelpers.classPrivateFieldLooseBase(this,P)[P]}}get $store(){return n.Core.getStore()}}function y(){return this.$store.getters[`${d.Model.Interface}/currentUserId`]}function F(e){const s={id:e.id,deadlineTs:e.deadlineTs,status:e.status,stageId:e.stageId,auditorsIds:e.auditorsIds};return Object.fromEntries(Object.entries(s).filter((([,e])=>!o.Type.isUndefined(e))))}function S({AFTER:e,TASK_ID:s}){var t,a;const r={id:s,title:H(e.TITLE),isImportant:H(e.PRIORITY,e.PRIORITY===2),creatorId:H(e.CREATED_BY),responsibleIds:H(e.RESPONSIBLE_ID,B(e.RESPONSIBLE_ID)),deadlineTs:H(e.DEADLINE,e.DEADLINE*1e3),checklist:undefined,groupId:H(e.GROUP_ID),stageId:H(e.STAGE,(t=(a=e.STAGE_INFO)==null?void 0:a.id)!=null?t:0),flowId:H(e.FLOW_ID),status:H(e.STATUS,L(e.STATUS)),statusChangedTs:H(e.STATUS,Date.now()),accomplicesIds:H(e.ACCOMPLICES,g(e.ACCOMPLICES)),auditorsIds:H(e.AUDITORS,g(e.AUDITORS)),parentId:H(e.PARENT_ID,Number(e.PARENT_ID)||0),tags:H(e.TAGS,e.TAGS?e.TAGS.split(","):[]),mark:H(e.MARK,I(String(e.MARK)))};return Object.fromEntries(Object.entries(r).filter((([,e])=>!o.Type.isUndefined(e))))}function L(e){var s;return(s={2:d.TaskStatus.Pending,3:d.TaskStatus.InProgress,4:d.TaskStatus.SupposedlyCompleted,5:d.TaskStatus.Completed,6:d.TaskStatus.Deferred}[e])!=null?s:d.TaskStatus.Pending}function I(e){var s;return(s={false:d.Mark.None,P:d.Mark.Positive,N:d.Mark.Negative}[e])!=null?s:d.Mark.None}function g(e){if(!e){return[]}return e.split(",").map((e=>Number(e)))}function B(e){return o.Type.isNumber(e)?[e]:[]}function H(e,s=e){return o.Type.isUndefined(e)?undefined:s}var k=babelHelpers.classPrivateFieldLooseKey("handleTaskAdded");var E=babelHelpers.classPrivateFieldLooseKey("handleTaskUpdated");var O=babelHelpers.classPrivateFieldLooseKey("pushedTasks");var m=babelHelpers.classPrivateFieldLooseKey("handleTaskUpdatedDelayed");var R=babelHelpers.classPrivateFieldLooseKey("handleTaskUpdatedDebounced");var w=babelHelpers.classPrivateFieldLooseKey("handleTaskViewed");var D=babelHelpers.classPrivateFieldLooseKey("handleTaskDeleted");var K=babelHelpers.classPrivateFieldLooseKey("handleDefaultDeadlineChanged");var _=babelHelpers.classPrivateFieldLooseKey("upsertStage");var A=babelHelpers.classPrivateFieldLooseKey("loadTask");var j=babelHelpers.classPrivateFieldLooseKey("needToLoadTask");var M=babelHelpers.classPrivateFieldLooseKey("loadGroup");var U=babelHelpers.classPrivateFieldLooseKey("needToLoadGroup");var N=babelHelpers.classPrivateFieldLooseKey("loadFlow");var X=babelHelpers.classPrivateFieldLooseKey("needToLoadFlow");var C=babelHelpers.classPrivateFieldLooseKey("loadUsers");var V=babelHelpers.classPrivateFieldLooseKey("needToLoadUsers");var $=babelHelpers.classPrivateFieldLooseKey("getUsersIds");var G=babelHelpers.classPrivateFieldLooseKey("loadRights");var x=babelHelpers.classPrivateFieldLooseKey("currentUserId");class Q extends p{constructor(...e){super(...e);Object.defineProperty(this,x,{get:le,set:void 0});Object.defineProperty(this,G,{value:re});Object.defineProperty(this,$,{value:ae});Object.defineProperty(this,V,{value:te});Object.defineProperty(this,C,{value:se});Object.defineProperty(this,X,{value:ee});Object.defineProperty(this,N,{value:Z});Object.defineProperty(this,U,{value:J});Object.defineProperty(this,M,{value:z});Object.defineProperty(this,j,{value:q});Object.defineProperty(this,A,{value:W});Object.defineProperty(this,_,{value:Y});Object.defineProperty(this,k,{writable:true,value:e=>{const s=n.Core.getParams().features;const t=e.AFTER.USER_ID===babelHelpers.classPrivateFieldLooseBase(this,x)[x]&&s.isMiniformEnabled&&!s.isV2Enabled;if(t){var a;const s=(a=e.AFTER.URL)!=null?a:"";BX.UI.Notification.Center.notify({id:o.Text.getRandom(),content:o.Loc.getMessage("TASKS_V2_NOTIFY_TASK_CREATED"),actions:[{title:o.Loc.getMessage("TASKS_V2_NOTIFY_TASK_DO_VIEW"),events:{click:(e,t)=>{t.close();BX.SidePanel.Instance.open(s)}}}]})}}});Object.defineProperty(this,E,{writable:true,value:e=>{const s=S(e);babelHelpers.classPrivateFieldLooseBase(this,_)[_](e.AFTER.STAGE_INFO);if(e.BEFORE.PARENT_ID){a.subTasksService.deleteStore(e.BEFORE.PARENT_ID,[s.id])}if(s.parentId){a.subTasksService.addStore(s.parentId,[s.id])}const{id:t,...r}=F(s);void u.taskService.updateStoreTask(t,r)}});Object.defineProperty(this,O,{writable:true,value:{}});Object.defineProperty(this,m,{writable:true,value:async e=>{const s=S(e);const{TaskFullCard:t}=await o.Runtime.loadExtension("tasks.v2.application.task-full-card");if(e.USER_ID===babelHelpers.classPrivateFieldLooseBase(this,x)[x]&&t.isOpened(s.id)){return}if(!u.taskService.hasStoreTask(s.id)){return}babelHelpers.classPrivateFieldLooseBase(this,O)[O][s.id]={...babelHelpers.classPrivateFieldLooseBase(this,O)[O][s.id],...s};babelHelpers.classPrivateFieldLooseBase(this,R)[R](e)}});Object.defineProperty(this,R,{writable:true,value:o.Runtime.debounce((async e=>{const s=babelHelpers.classPrivateFieldLooseBase(this,O)[O][e.TASK_ID];delete babelHelpers.classPrivateFieldLooseBase(this,O)[O][s.id];if(babelHelpers.classPrivateFieldLooseBase(this,j)[j](e)){await babelHelpers.classPrivateFieldLooseBase(this,A)[A](s)}else{await Promise.all([babelHelpers.classPrivateFieldLooseBase(this,M)[M](s),babelHelpers.classPrivateFieldLooseBase(this,N)[N](s),babelHelpers.classPrivateFieldLooseBase(this,C)[C](s),babelHelpers.classPrivateFieldLooseBase(this,G)[G](s)]);const{id:e,...t}=s;u.taskService.updateStoreTask(e,t)}t.EventEmitter.emit(d.EventName.TaskPullUpdated,{task:u.taskService.getStoreTask(s.id)})}),0)});Object.defineProperty(this,w,{writable:true,value:e=>{}});Object.defineProperty(this,D,{writable:true,value:e=>{const s=e.TASK_ID;void u.taskService.deleteStore(s);t.EventEmitter.emit(d.EventName.CloseFullCard,{taskId:s});t.EventEmitter.emit(d.EventName.TaskDeleted,{id:s})}});Object.defineProperty(this,K,{writable:true,value:({deadlineUserOption:e})=>{void this.$store.dispatch(`${d.Model.Interface}/updateDeadlineUserOption`,e)}})}getMap(){return{task_add:babelHelpers.classPrivateFieldLooseBase(this,k)[k],task_update:babelHelpers.classPrivateFieldLooseBase(this,E)[E],task_view:babelHelpers.classPrivateFieldLooseBase(this,w)[w],task_remove:babelHelpers.classPrivateFieldLooseBase(this,D)[D],default_deadline_changed:babelHelpers.classPrivateFieldLooseBase(this,K)[K]}}getDelayedMap(){return{task_update:babelHelpers.classPrivateFieldLooseBase(this,m)[m]}}get $store(){return n.Core.getStore()}}function Y(e){if(e){const s=r.GroupMappers.mapStageDtoToModel(e);void this.$store.dispatch(`${d.Model.Stages}/upsert`,s)}}async function W(e){await u.taskService.get(e.id)}function q(e){const s=new Set(["DESCRIPTION","UF_TASK_WEBDAV_FILES","STATUS","ALLOW_TIME_TRACKING"]);return Object.keys(e.AFTER).some((e=>s.has(e)))}async function z(e){if(babelHelpers.classPrivateFieldLooseBase(this,U)[U](e)){await r.groupService.getGroup(e.groupId)}}function J(e){if(babelHelpers.classPrivateFieldLooseBase(this,X)[X](e)){return false}return e.groupId&&!this.$store.getters[`${d.Model.Groups}/getById`](e.groupId)}async function Z(e){if(babelHelpers.classPrivateFieldLooseBase(this,X)[X](e)){await l.flowService.getFlow(e.flowId)}}function ee(e){return Boolean(e.flowId)&&!this.$store.getters[`${d.Model.Flows}/getById`](e.flowId)}async function se(e){if(babelHelpers.classPrivateFieldLooseBase(this,V)[V](e)){await i.userService.list(babelHelpers.classPrivateFieldLooseBase(this,$)[$](e))}}function te(e){return!i.userService.hasUsers(babelHelpers.classPrivateFieldLooseBase(this,$)[$](e))}function ae(e){var s,t,a;return[e.creatorId,...(s=e.responsibleIds)!=null?s:[],...(t=e.accomplicesIds)!=null?t:[],...(a=e.auditorsIds)!=null?a:[]].filter((e=>e))}async function re(e){await u.taskService.getRights(e.id)}function le(){return this.$store.getters[`${d.Model.Interface}/currentUserId`]}var ie=babelHelpers.classPrivateFieldLooseKey("handleResultCreate");var oe=babelHelpers.classPrivateFieldLooseKey("handleResultUpdate");var de=babelHelpers.classPrivateFieldLooseKey("handleResultDelete");var ne=babelHelpers.classPrivateFieldLooseKey("currentUserId");class ce extends p{constructor(...e){super(...e);Object.defineProperty(this,ne,{get:ue,set:void 0});Object.defineProperty(this,ie,{writable:true,value:async e=>{const s=e.result;const{id:t,taskId:a,messageId:r}=s;if(v.resultService.hasStoreResult(t)||!u.taskService.hasStoreTask(a)){return}const l=v.ResultMappers.mapDtoToModel(s);await v.resultService.insertStoreResult(l);v.resultService.addResultToTask(a,t,r);void v.resultService.get(t)}});Object.defineProperty(this,oe,{writable:true,value:async e=>{const s=e.result;const{id:t,fileIds:a,author:r}=s;if(!v.resultService.hasStoreResult(t)||r.id===babelHelpers.classPrivateFieldLooseBase(this,ne)[ne]){return}const l=v.ResultMappers.mapDtoToModel(s);await v.resultService.updateStoreResult(t,l);await c.fileService.get(t,c.EntityTypes.Result).sync(a)}});Object.defineProperty(this,de,{writable:true,value:e=>{const s=e.result;const{id:t,taskId:a}=s;if(!u.taskService.hasStoreTask(a)||!v.resultService.hasStoreResult(a)){return}v.resultService.deleteResultFromTask(a,t);void v.resultService.deleteStoreResult(t)}})}getMap(){return{task_result_create:babelHelpers.classPrivateFieldLooseBase(this,ie)[ie],task_result_update:babelHelpers.classPrivateFieldLooseBase(this,oe)[oe],task_result_delete:babelHelpers.classPrivateFieldLooseBase(this,de)[de]}}get $store(){return n.Core.getStore()}}function ue(){return this.$store.getters[`${d.Model.Interface}/currentUserId`]}var ve=babelHelpers.classPrivateFieldLooseKey("params");var be=babelHelpers.classPrivateFieldLooseKey("loadItemsDelay");var pe=babelHelpers.classPrivateFieldLooseKey("handlers");var Pe=babelHelpers.classPrivateFieldLooseKey("onBeforePull");var he=babelHelpers.classPrivateFieldLooseKey("onPull");var fe=babelHelpers.classPrivateFieldLooseKey("onBeforeQueueExecute");var Te=babelHelpers.classPrivateFieldLooseKey("onQueueExecute");var ye=babelHelpers.classPrivateFieldLooseKey("onReload");var Fe=babelHelpers.classPrivateFieldLooseKey("executeQueue");class Se{constructor(e){Object.defineProperty(this,Fe,{value:ke});Object.defineProperty(this,ye,{value:He});Object.defineProperty(this,Te,{value:Be});Object.defineProperty(this,fe,{value:ge});Object.defineProperty(this,he,{value:Ie});Object.defineProperty(this,Pe,{value:Le});Object.defineProperty(this,ve,{writable:true,value:void 0});Object.defineProperty(this,be,{writable:true,value:500});Object.defineProperty(this,pe,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,ve)[ve]=e;babelHelpers.classPrivateFieldLooseBase(this,pe)[pe]=new Set([new Q,new T,new ce])}initQueueManager(){return new s.QueueManager({moduleId:d.Module.Tasks,userId:babelHelpers.classPrivateFieldLooseBase(this,ve)[ve].currentUserId,config:{loadItemsDelay:babelHelpers.classPrivateFieldLooseBase(this,be)[be]},additionalData:{},events:{onBeforePull:e=>{babelHelpers.classPrivateFieldLooseBase(this,Pe)[Pe](e)},onPull:e=>{babelHelpers.classPrivateFieldLooseBase(this,he)[he](e)}},callbacks:{onBeforeQueueExecute:e=>babelHelpers.classPrivateFieldLooseBase(this,fe)[fe](e),onQueueExecute:e=>babelHelpers.classPrivateFieldLooseBase(this,Te)[Te](e),onReload:()=>{babelHelpers.classPrivateFieldLooseBase(this,ye)[ye]()}}})}}function Le(e){const{pullData:{command:s,params:t}}=e.data;for(const e of babelHelpers.classPrivateFieldLooseBase(this,pe)[pe]){var a,r;(a=(r=e.getMap())[s])==null?void 0:a.call(r,t)}}function Ie(e){const{pullData:{command:s,params:t},promises:a}=e.data;for(const e of babelHelpers.classPrivateFieldLooseBase(this,pe)[pe]){if(e.getDelayedMap()[s]){var r;a.push(Promise.resolve({data:{id:(r=t.entityId)!=null?r:o.Text.getRandom(),command:s,params:t}}))}}}function ge(e){return Promise.resolve()}async function Be(e){await babelHelpers.classPrivateFieldLooseBase(this,Fe)[Fe](e)}function He(e){}function ke(e){return new Promise((s=>{e.forEach((e=>{const{data:{command:s,params:t}}=e;for(const e of babelHelpers.classPrivateFieldLooseBase(this,pe)[pe]){var a,r;(a=(r=e.getDelayedMap())[s])==null?void 0:a.call(r,t)}}));s()}))}e.PullManager=Se})(this.BX.Tasks.V2.Provider.Pull=this.BX.Tasks.V2.Provider.Pull||{},BX.Pull,BX.Event,BX.Tasks.V2.Provider.Service,BX.Tasks.V2.Provider.Service,BX.Tasks.V2.Provider.Service,BX.Tasks.V2.Provider.Service,BX,BX.Tasks.V2.Const,BX.Tasks.V2,BX.Tasks.V2.Provider.Service,BX.Tasks.V2.Provider.Service,BX.Tasks.V2.Provider.Service,BX.Vue3.Vuex);
//# sourceMappingURL=pull-manager.bundle.map.js