this.BX=this.BX||{};this.BX.Tasks=this.BX.Tasks||{};this.BX.Tasks.V2=this.BX.Tasks.V2||{};(function(e,s,t,r,a,i,o,n,l){"use strict";var c=babelHelpers.classPrivateFieldLooseKey("validatePayload");class d{constructor(){Object.defineProperty(this,c,{value:h})}execute(e){throw new Error(`Method execute must be implemented in ${this.constructor.name}`)}getName(){throw new Error(`Method getName must be implemented in ${this.constructor.name}`)}isValid(e){return babelHelpers.classPrivateFieldLooseBase(this,c)[c](e)}hasPermission(e){return true}}function h(e){if(!i.Type.isPlainObject(e)){return false}return i.Type.isNumber(e.taskId)&&e.taskId>0&&i.Type.isDomNode(e.bindElement)}var u=babelHelpers.classPrivateFieldLooseKey("actions");class b{constructor(){Object.defineProperty(this,u,{writable:true,value:new Map})}register(e){const s=e.getName();if(babelHelpers.classPrivateFieldLooseBase(this,u)[u].has(s)){throw new Error(`ChatActionDispatcher: action '${s}' already registered`)}babelHelpers.classPrivateFieldLooseBase(this,u)[u].set(s,e)}async execute(e,s){if(!i.Type.isString(e)||e.trim()===""){throw new Error("Invalid action name")}const t=babelHelpers.classPrivateFieldLooseBase(this,u)[u].get(e.trim());if(!t){throw new Error(`Action '${e}' not found`)}await t.execute(s)}}var v=babelHelpers.classPrivateFieldLooseKey("validateLink");var p=babelHelpers.classPrivateFieldLooseKey("parseUrlParams");var P=babelHelpers.classPrivateFieldLooseKey("parseArrayIds");var m=babelHelpers.classPrivateFieldLooseKey("parseNumber");class L{constructor(){Object.defineProperty(this,m,{value:C});Object.defineProperty(this,P,{value:H});Object.defineProperty(this,p,{value:y});Object.defineProperty(this,v,{value:f})}parse(e){if(!babelHelpers.classPrivateFieldLooseBase(this,v)[v](e)){console.error("ChatLinkParser: Link is not valid");return null}const{taskId:s,[n.ChatActionParam.ChatAction]:t,[n.ChatActionParam.EntityId]:r}=e.matches.groups;const a=babelHelpers.classPrivateFieldLooseBase(this,m)[m](s);if(a<=0){console.error("ChatLinkParser: taskId must be positive number");return null}if(!t||t.trim()===""){console.error("ChatLinkParser: actionName is required");return null}const i=babelHelpers.classPrivateFieldLooseBase(this,p)[p](e.url);return{actionName:t.trim(),payload:{taskId:a,entityId:r?babelHelpers.classPrivateFieldLooseBase(this,m)[m](r):null,bindElement:e.anchor,...i}}}}function f(e){if(!i.Type.isPlainObject(e)){return false}if(!i.Type.isString(e.url)||e.url.trim()===""){return false}if(!i.Type.isArray(e.matches)||e.matches.length<4){return false}return i.Type.isDomNode(e.anchor)}function y(e){try{const s=new URLSearchParams(e);return{[n.ChatActionParam.ChildrenIds]:babelHelpers.classPrivateFieldLooseBase(this,P)[P](s,n.ChatActionParam.ChildrenIds)}}catch{return{}}}function H(e,s){const t=[];e.forEach(((e,r)=>{if(r.startsWith(s)){t.push(babelHelpers.classPrivateFieldLooseBase(this,m)[m](e))}}));return t}function C(e){const s=parseInt(e,10);return Number.isInteger(s)?s:0}var k=babelHelpers.classPrivateFieldLooseKey("popupId");class I extends s.Hint{constructor(...e){super(...e);Object.defineProperty(this,k,{writable:true,value:"tasks-chat-hint"})}async show(e,s,t){var r;const a={id:babelHelpers.classPrivateFieldLooseBase(this,k)[k],bindElement:s.bindElement,content:e,offsetLeft:40,maxWidth:770,padding:12,targetContainer:document.body,...t};if((r=s.coordinates)!=null&&r.x){const e=s.bindElement.getBoundingClientRect();a.offsetLeft=s.coordinates.x-e.left}await super.showHint(a)}}const E=new I;class w extends d{showCheckListRemovedHint(e,s){void E.show(i.Loc.getMessage("TASKS_V2_CHAT_ACTION_CHECK_LIST_REMOVED_HINT"),{bindElement:e,coordinates:s})}showCheckListItemsRemovedHint(e,s){void E.show(i.Loc.getMessage("TASKS_V2_CHAT_ACTION_CHECK_LIST_ITEMS_REMOVED_HINT"),{bindElement:e,coordinates:s})}}class g extends w{getName(){return n.ChatAction.ShowCheckList}async execute(e){if(!this.isValid(e)){throw new Error("Invalid payload")}const{entityId:s,bindElement:r,coordinates:a}=e;if(!t.checkListService.isCheckListExists(s)){this.showCheckListRemovedHint(r,a);return}o.EventEmitter.emit(n.EventName.ShowCheckList,{checkListId:s})}}const T=new g;class F extends w{getName(){return n.ChatAction.ShowCheckListItems}async execute(e){if(!this.isValid(e)){throw new Error("Invalid payload")}const{entityId:s,childrenIds:r,bindElement:a,coordinates:i}=e;if(!t.checkListService.isCheckListExists(s)){this.showCheckListRemovedHint(a,i);return}const l=t.checkListService.filterItemsBelongingToCheckList(s,r);if(l.length===0){this.showCheckListItemsRemovedHint(a,i);return}o.EventEmitter.emit(n.EventName.ShowCheckListItems,{checkListItemIds:l.slice(0,10)})}}const S=new F;var A=babelHelpers.classPrivateFieldLooseKey("canChangeDeadline");var B=babelHelpers.classPrivateFieldLooseKey("exceededChangeCount");var O=babelHelpers.classPrivateFieldLooseKey("showAccessDeniedHint");var _=babelHelpers.classPrivateFieldLooseKey("emitOpenDeadlinePickerEvent");class N extends d{constructor(...e){super(...e);Object.defineProperty(this,_,{value:V});Object.defineProperty(this,O,{value:D});Object.defineProperty(this,B,{value:x});Object.defineProperty(this,A,{value:K})}getName(){return n.ChatAction.ChangeDeadline}async execute(e){if(!this.isValid(e)){throw new Error("Invalid payload")}if(!this.hasPermission(e)){babelHelpers.classPrivateFieldLooseBase(this,O)[O](e);return}babelHelpers.classPrivateFieldLooseBase(this,_)[_](e)}hasPermission(e){const s=l.taskService.getStoreTask(e.taskId);if(!s){return false}return babelHelpers.classPrivateFieldLooseBase(this,A)[A](s)}}function K(e){const s=e.flowId>0;return e.rights.deadline&&!babelHelpers.classPrivateFieldLooseBase(this,B)[B](e)&&!s}function x(e){const s=r.Core.getStore().getters[`${n.Model.Interface}/currentUserId`];const t=s===e.creatorId;if(t||!e.maxDeadlineChanges){return false}const a=r.Core.getStore().getters[`${n.Model.Interface}/deadlineChangeCount`];return a>=e.maxDeadlineChanges}function D(e){const s=l.taskService.getStoreTask(e.taskId);const t=babelHelpers.classPrivateFieldLooseBase(this,B)[B](s);const r=t?i.Loc.getMessage("TASKS_V2_CHAT_ACTION_CHANGE_DEADLINE_EXCEEDED"):i.Loc.getMessage("TASKS_V2_CHAT_ACTION_CHANGE_DEADLINE_NO_PERMISSION");const a=t?330:280;void E.show(r,e,{maxWidth:a})}function V(e){o.EventEmitter.emit(n.EventName.OpenDeadlinePicker,{taskId:e.taskId,bindElement:e.bindElement,coordinates:e.coordinates})}const j=new N;var M=babelHelpers.classPrivateFieldLooseKey("showAccessDeniedHint");class R extends d{constructor(...e){super(...e);Object.defineProperty(this,M,{value:X})}getName(){return n.ChatAction.CompleteTask}async execute(e){if(!this.isValid(e)){throw new Error("Invalid payload")}if(!this.hasPermission(e)){babelHelpers.classPrivateFieldLooseBase(this,M)[M](e);return}await a.statusService.complete(e.taskId)}hasPermission(e){var s;const t=l.taskService.getStoreTask(e.taskId);return t&&((s=t.rights)==null?void 0:s.complete)===true}get $store(){return r.Core.getStore()}}function X(e){void E.show(i.Loc.getMessage("TASKS_V2_CHAT_ACTION_COMPLETE_TASK_NO_PERMISSION"),e)}const $=new R;var U=babelHelpers.classPrivateFieldLooseKey("hasResult");var W=babelHelpers.classPrivateFieldLooseKey("showNoResultHint");var G=babelHelpers.classPrivateFieldLooseKey("emitOpenResultEvent");class q extends d{constructor(...e){super(...e);Object.defineProperty(this,G,{value:Q});Object.defineProperty(this,W,{value:J});Object.defineProperty(this,U,{value:z})}getName(){return n.ChatAction.OpenResult}async execute(e){if(!this.isValid(e)){throw new Error("Invalid payload")}if(!babelHelpers.classPrivateFieldLooseBase(this,U)[U](e)){babelHelpers.classPrivateFieldLooseBase(this,W)[W](e);return}babelHelpers.classPrivateFieldLooseBase(this,G)[G](e)}}function z(e){const{entityId:s,taskId:t}=e;if(!s||!t){return false}const r=l.taskService.getStoreTask(t);return!(!(r!=null&&r.results)||!r.results.includes(s))}function J(e){void E.show(i.Loc.getMessage("TASKS_V2_CHAT_ACTION_RESULT_NOT_FOUND"),e)}function Q(e){o.EventEmitter.emit(n.EventName.OpenResultFromChat,{taskId:e.taskId,resultId:e.entityId})}const Y=new q;var Z=babelHelpers.classPrivateFieldLooseKey("defaultActions");var ee=babelHelpers.classPrivateFieldLooseKey("actionDispatcher");var se=babelHelpers.classPrivateFieldLooseKey("linkParser");var te=babelHelpers.classPrivateFieldLooseKey("registerDefaultActions");class re{constructor(e){Object.defineProperty(this,te,{value:ae});Object.defineProperty(this,Z,{writable:true,value:[j,$,Y,T,S]});Object.defineProperty(this,ee,{writable:true,value:void 0});Object.defineProperty(this,se,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,ee)[ee]=e.actionDispatcher;babelHelpers.classPrivateFieldLooseBase(this,se)[se]=e.linkParser;babelHelpers.classPrivateFieldLooseBase(this,te)[te]()}async process(e,s={}){try{const t=babelHelpers.classPrivateFieldLooseBase(this,se)[se].parse(e);if(!t){return}const r={...t.payload,...s};await babelHelpers.classPrivateFieldLooseBase(this,ee)[ee].execute(t.actionName,r)}catch(e){console.error("ChatActionService: Failed to process link",e)}}}function ae(){babelHelpers.classPrivateFieldLooseBase(this,Z)[Z].forEach((e=>{try{babelHelpers.classPrivateFieldLooseBase(this,ee)[ee].register(e)}catch(s){console.error("ChatActionService: Failed to register action",e.getName(),s)}}))}const ie=new re({actionDispatcher:new b,linkParser:new L});e.ChatActionService=re;e.chatActionService=ie})(this.BX.Tasks.V2.Lib=this.BX.Tasks.V2.Lib||{},BX.Tasks.V2.Lib,BX.Tasks.V2.Provider.Service,BX.Tasks.V2,BX.Tasks.V2.Provider.Service,BX,BX.Event,BX.Tasks.V2.Const,BX.Tasks.V2.Provider.Service);
//# sourceMappingURL=chat-action-service.bundle.map.js