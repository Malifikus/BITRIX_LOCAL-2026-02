this.BX=this.BX||{};this.BX.Tasks=this.BX.Tasks||{};this.BX.Tasks.V2=this.BX.Tasks.V2||{};this.BX.Tasks.V2.Component=this.BX.Tasks.V2.Component||{};(function(t,e,s,i,n,l,r,o,d,u,a,h,c,m,p,R,S,f,v,E,T,I,k,g,A,C,B,b,y,M,_,L,O,U){"use strict";const w=Object.freeze({id:B.TaskField.Results,title:E.Loc.getMessage("TASKS_V2_RESULT_TITLE_META")});const x={components:{BIcon:g.BIcon,BMenu:I.BMenu,UserAvatar:o.UserAvatar,UserFieldWidgetComponent:d.DiskUserFieldWidgetComponent,EntityCollapsibleText:S.EntityCollapsibleText,TextSm:f.TextSm,TextXs:f.TextXs,TextMd:f.TextMd,Hint:i.Hint},directives:{hint:r.hint},inject:{taskId:{}},props:{resultId:{type:[Number,String],required:true}},emits:["titleClick","edit","highlightField"],setup(t){const e=R.fileService.get(t.resultId,R.EntityTypes.Result);const s=l.shallowRef(e);const i=l.shallowRef(e.getAdapter());return{Outline:g.Outline,resultsMeta:w,UserAvatarSize:o.UserAvatarSize,fileService:s,uploaderAdapter:i}},data(){return{opened:false,isMenuShown:false,showResultFromMessageHint:false,files:this.fileService.getFiles()}},computed:{result(){return this.$store.getters[`${B.Model.Results}/getById`](this.resultId)},isEdit(){return E.Type.isNumber(this.resultId)&&this.resultId>0},resultTitle(){return this.loc("TASKS_V2_RESULT_TITLE_WITH_DATE",{"#DATE#":this.resultDate})},resultDate(){if(!this.result.createdAtTs){return""}return p.calendar.formatDateTime(this.result.createdAtTs)},resultText(){var t;return(t=this.result.text)!=null?t:""},resultAuthor(){return this.result.author},filesCount(){return this.files.length},widgetOptions(){return{isEmbedded:true,withControlPanel:false,canCreateDocuments:false,tileWidgetOptions:{compact:true,hideDropArea:true,readonly:true,enableDropzone:false,autoCollapse:false}}},menuOptions(){return{id:`result-action-menu-${E.Text.getRandom()}`,bindOptions:{forceBindPosition:true},bindElement:this.$refs.moreIcon.$el,targetContainer:document.body,offsetLeft:-100,minWidth:250,items:this.menuItems,autoHide:true,closeByEsc:true}},menuItems(){return[this.result.rights.edit&&this.isEdit&&{title:this.loc("TASKS_V2_RESULT_EDIT"),icon:g.Outline.EDIT_L,onClick:this.handleEditClick.bind(this),dataset:{id:`MenuResultEdit-${this.resultId}`}},this.result.rights.remove&&{design:"alert",title:this.loc("TASKS_V2_RESULT_REMOVE"),icon:g.Outline.TRASHCAN,onClick:this.handleDeleteClick.bind(this),dataset:{id:`MenuResultRemove-${this.resultId}`}}].filter(Boolean)},hasMenuItems(){return this.menuItems.length>0},tooltip(){return()=>i.tooltip({text:this.loc("TASKS_V2_RESULT_ADD"),popupOptions:{offsetLeft:this.$refs.addIcon.offsetWidth/2}})}},watch:{resultId(t){this.fileService=R.fileService.get(t,R.EntityTypes.Result);this.uploaderAdapter=this.fileService.getAdapter();this.files=this.fileService.getFiles();this.opened=false},resultText(){var t;void this.$nextTick((t=this.$refs.collapsible)==null?void 0:t.updateIsOverflowing)}},mounted(){a.EventEmitter.subscribe(B.EventName.ResultFromMessageAdded,this.handleResultFromMessageAdded)},beforeUnmount(){a.EventEmitter.unsubscribe(B.EventName.ResultFromMessageAdded,this.handleResultFromMessageAdded)},methods:{handleEditClick(){this.$emit("edit",this.resultId)},handleDeleteClick(){void _.resultService.delete(this.resultId)},handleAuthorClick(){BX.SidePanel.Instance.emulateAnchorClick(U.userService.getUrl(this.resultAuthor.id))},handleResultFromMessageAdded(t){const{taskId:e}=t.getData();if(this.taskId!==e){return}this.$emit("highlightField");if(!s.ahaMoments.shouldShow(B.Option.AhaResultFromMessagePopup)){return}s.ahaMoments.setActive(B.Option.AhaResultFromMessagePopup);this.showResultFromMessageHint=true},handleResultFromMessageHintClose(){this.showResultFromMessageHint=false;s.ahaMoments.setInactive(B.Option.AhaResultFromMessagePopup)},handleResultFromMessageHintCloseComplete(){if(!this.showResultFromMessageHint){return}this.showResultFromMessageHint=false;s.ahaMoments.setShown(B.Option.AhaResultFromMessagePopup)}},template:`\n\t\t<div\n\t\t\tclass="tasks-field-results-result --card"\n\t\t\t:data-task-field-id="resultsMeta.id"\n\t\t\tdata-field-container\n\t\t>\n\t\t\t<div\n\t\t\t\tclass="tasks-field-results-title"\n\t\t\t\tref="title"\n\t\t\t\t@click="$emit('titleClick', resultId)"\n\t\t\t>\n\t\t\t\t<div class="tasks-field-results-title-main">\n\t\t\t\t\t<BIcon :name="Outline.WINDOW_FLAG"/>\n\t\t\t\t\t<TextMd accent>{{ resultTitle }}</TextMd>\n\t\t\t\t</div>\n\t\t\t\t<div class="tasks-field-results-title-actions">\n\t\t\t\t\t<BIcon\n\t\t\t\t\t\tv-if="hasMenuItems"\n\t\t\t\t\t\tclass="tasks-field-results-title-icon"\n\t\t\t\t\t\t:name="Outline.MORE_L"\n\t\t\t\t\t\thoverable\n\t\t\t\t\t\tref="moreIcon"\n\t\t\t\t\t\t@click.stop="isMenuShown = true"\n\t\t\t\t\t/>\n\t\t\t\t\t<BMenu v-if="isMenuShown" :options="menuOptions" @close="isMenuShown = false"/>\n\t\t\t\t\t<Hint\n\t\t\t\t\t\tv-if="showResultFromMessageHint"\n\t\t\t\t\t\t:bindElement="$refs.moreIcon.$el"\n\t\t\t\t\t\t:options="{\n\t\t\t\t\t\t\tcloseIcon: true,\n\t\t\t\t\t\t\toffsetLeft: 10,\n\t\t\t\t\t\t\tminWidth: 340,\n\t\t\t\t\t\t\tmaxWidth: 340,\n\t\t\t\t\t\t\tbindOptions: {\n\t\t\t\t\t\t\t\tforceBindPosition: true,\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t}"\n\t\t\t\t\t\t@close="handleResultFromMessageHintClose"\n\t\t\t\t\t>\n\t\t\t\t\t\t<div class="tasks-field-results-hint-info">\n\t\t\t\t\t\t\t<TextMd className="tasks-field-results-hint-info-text">\n\t\t\t\t\t\t\t\t{{ loc('TASKS_V2_RESULT_AHA_RESULT_FROM_MESSAGE') }}\n\t\t\t\t\t\t\t</TextMd>\n\t\t\t\t\t\t\t<TextXs\n\t\t\t\t\t\t\t\tclassName="tasks-field-results-hint-info-link"\n\t\t\t\t\t\t\t\t@click.stop="handleResultFromMessageHintCloseComplete"\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t{{ loc('TASKS_V2_RESULT_AHA_SHOW_NO_MORE') }}\n\t\t\t\t\t\t\t</TextXs>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</Hint>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t<div class="tasks-field-results-result-content" ref="content">\n\t\t\t\t<div class="tasks-field-results-result-author-border">\n\t\t\t\t\t<div\n\t\t\t\t\t\tclass="tasks-field-results-result-author-border-clickable"\n\t\t\t\t\t\t@click="handleAuthorClick"\n\t\t\t\t\t>\n\t\t\t\t\t\t<UserAvatar\n\t\t\t\t\t\t\t:src="resultAuthor.image"\n\t\t\t\t\t\t\t:type="resultAuthor.type"\n\t\t\t\t\t\t\t:size="UserAvatarSize.XS"\n\t\t\t\t\t\t\t:bx-tooltip-user-id="resultAuthor.id"\n\t\t\t\t\t\t\tbx-tooltip-context="b24"\n\t\t\t\t\t\t/>\n\t\t\t\t\t\t<TextSm\n\t\t\t\t\t\t\tclassName="tasks-field-results-result-author-name"\n\t\t\t\t\t\t\t:bx-tooltip-user-id="resultAuthor.id"\n\t\t\t\t\t\t\tbx-tooltip-context="b24"\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t{{ resultAuthor.name }}\n\t\t\t\t\t\t</TextSm>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t<EntityCollapsibleText\n\t\t\t\t\tref="collapsible"\n\t\t\t\t\t:files\n\t\t\t\t\t:content="resultText"\n\t\t\t\t\treadonly\n\t\t\t\t\t:showFilesIndicator="false"\n\t\t\t\t\tv-model:opened="opened"\n\t\t\t\t/>\n\t\t\t\t<div v-if="filesCount > 0" class="tasks-field-results-result-files" :key="resultId">\n\t\t\t\t\t<UserFieldWidgetComponent :uploaderAdapter :widgetOptions/>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</div>\n\t`};const F={components:{UiButton:v.Button,Hint:i.Hint,TextMd:f.TextMd,HeadlineSm:f.HeadlineSm},props:{bindElement:{type:Object,required:true},popupWidth:{type:Number,default:530},hasResults:{type:Boolean,default:false}},emits:["close","addResult"],setup(){return{Outline:g.Outline,AirButtonStyle:v.AirButtonStyle,ButtonSize:v.ButtonSize}},computed:{title(){return this.hasResults?this.loc("TASKS_V2_RESULT_AHA_REQUIRE_NEW_RESULT_RESPONSIBLE_TITLE"):this.loc("TASKS_V2_RESULT_AHA_REQUIRE_RESULT_RESPONSIBLE_TITLE")},description(){return this.hasResults?this.loc("TASKS_V2_RESULT_AHA_REQUIRE_NEW_RESULT_RESPONSIBLE_DESC"):this.loc("TASKS_V2_RESULT_AHA_REQUIRE_RESULT_RESPONSIBLE_DESC")}},template:`\n\t\t<Hint\n\t\t\t:bindElement\n\t\t\t:options="{\n\t\t\t\tcloseIcon: true,\n\t\t\t\tminWidth: popupWidth,\n\t\t\t\tmaxWidth: popupWidth,\n\t\t\t\tpadding: 0,\n\t\t\t}"\n\t\t\t@close="$emit('close')"\n\t\t>\n\t\t\t<div class="tasks-field-results-hint-container">\n\t\t\t\t<div class="tasks-field-results-hint-icon"/>\n\t\t\t\t<div class="tasks-field-results-hint-info">\n\t\t\t\t\t<HeadlineSm className="tasks-field-results-hint-info-text">{{ title }}</HeadlineSm>\n\t\t\t\t\t<TextMd className="tasks-field-results-hint-info-text">{{ description }}</TextMd>\n\t\t\t\t\t<div class="tasks-field-results-hint-button">\n\t\t\t\t\t\t<UiButton\n\t\t\t\t\t\t\t:text="loc('TASKS_V2_RESULT_ADD')"\n\t\t\t\t\t\t\t:size="ButtonSize.SMALL"\n\t\t\t\t\t\t\t:style="AirButtonStyle.TINTED"\n\t\t\t\t\t\t\t:leftIcon="Outline.PLUS_L"\n\t\t\t\t\t\t\t:wide="false"\n\t\t\t\t\t\t\t@click="$emit('addResult')"\n\t\t\t\t\t\t/>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</Hint>\n\t`};const D={name:"TaskResultListItem",components:{BIcon:g.BIcon,BMenu:I.BMenu,HeadlineSm:f.HeadlineSm,UserAvatar:o.UserAvatar,UserFieldWidgetComponent:d.DiskUserFieldWidgetComponent,EntityCollapsibleText:S.EntityCollapsibleText,TextSm:f.TextSm},directives:{hint:r.hint},props:{resultId:{type:[Number,String],required:true},showDelimiter:{type:Boolean,default:false},isResized:{type:Boolean,default:false}},emits:["titleClick","edit","resize"],setup(t){const e=R.fileService.get(t.resultId,R.EntityTypes.Result);const s=l.shallowRef(e);const i=l.shallowRef(e.getAdapter());return{Outline:g.Outline,resultsMeta:w,UserAvatarSize:o.UserAvatarSize,fileService:s,uploaderAdapter:i}},data(){return{isSticky:false,scrollContainer:null,mutationObserver:null,isMenuShown:false,files:this.fileService.getFiles()}},computed:{result(){return this.$store.getters[`${B.Model.Results}/getById`](this.resultId)},isEdit(){return E.Type.isNumber(this.resultId)&&this.resultId>0},resultTitle(){return this.loc("TASKS_V2_RESULT_TITLE_WITH_DATE",{"#DATE#":this.resultDate})},resultDate(){if(!this.result.createdAtTs){return""}return p.calendar.formatDateTime(this.result.createdAtTs)},resultText(){var t;return(t=this.result.text)!=null?t:""},resultAuthor(){return this.result.author},filesCount(){return this.files.length},widgetOptions(){return{isEmbedded:true,withControlPanel:false,canCreateDocuments:false,tileWidgetOptions:{compact:true,hideDropArea:true,readonly:true,enableDropzone:false,autoCollapse:false}}},menuOptions(){return{id:`result-action-menu-${E.Text.getRandom()}`,bindOptions:{forceBindPosition:true},bindElement:this.$refs.moreIcon.$el,targetContainer:document.body,offsetLeft:-100,minWidth:250,items:this.menuItems,autoHide:true,closeByEsc:true}},menuItems(){return[this.result.rights.edit&&this.isEdit&&{title:this.loc("TASKS_V2_RESULT_EDIT"),icon:g.Outline.EDIT_L,onClick:this.handleEditClick.bind(this),dataset:{id:`MenuResultEdit-${this.resultId}`}},this.result.rights.remove&&{design:"alert",title:this.loc("TASKS_V2_RESULT_REMOVE"),icon:g.Outline.TRASHCAN,onClick:this.handleDeleteClick.bind(this),dataset:{id:`MenuResultRemove-${this.resultId}`}}].filter(Boolean)},hasMenuItems(){return this.menuItems.length>0},resizeIcon(){return this.isResized?g.Outline.COLLAPSE_L:g.Outline.EXPAND_L}},watch:{resultId(t){this.fileService=R.fileService.get(t,R.EntityTypes.Result);this.uploaderAdapter=this.fileService.getAdapter();this.files=this.fileService.getFiles()}},mounted(){var t;this.scrollContainer=(t=this.$el)==null?void 0:t.closest(".tasks-field-results-result-list-content");if(this.scrollContainer){E.Event.bind(this.scrollContainer,"scroll",this.handleScroll);void this.$nextTick(this.checkSticky);this.mutationObserver=new MutationObserver((()=>this.checkSticky()));this.mutationObserver.observe(this.scrollContainer,{childList:true,subtree:true})}},beforeUnmount(){if(this.scrollContainer){E.Event.unbind(this.scrollContainer,"scroll",this.handleScroll)}if(this.mutationObserver){this.mutationObserver.disconnect()}},methods:{handleEditClick(){this.$emit("edit",this.resultId)},handleDeleteClick(){void _.resultService.delete(this.resultId)},handleResizeClick(){this.$emit("resize")},handleScroll(){this.checkSticky()},checkSticky(){if(!this.scrollContainer||!this.$refs.title){return}const t=this.$refs.title.getBoundingClientRect();const e=this.scrollContainer.getBoundingClientRect();this.isSticky=t.top<=e.top+t.height/2},handleAuthorClick(){BX.SidePanel.Instance.emulateAnchorClick(U.userService.getUrl(this.resultAuthor.id))}},template:`\n\t\t<div class="tasks-field-results-result --list-mode">\n\t\t\t<div\n\t\t\t\tclass="tasks-field-results-title --list-mode"\n\t\t\t\t:class="{ '--sticky': isSticky }"\n\t\t\t\tref="title"\n\t\t\t\t@click="$emit('titleClick', resultId)"\n\t\t\t>\n\t\t\t\t<div class="tasks-field-results-title-main">\n\t\t\t\t\t<BIcon :name="Outline.WINDOW_FLAG"/>\n\t\t\t\t\t<HeadlineSm>{{ resultTitle }}</HeadlineSm>\n\t\t\t\t</div>\n\t\t\t\t<div class="tasks-field-results-title-actions">\n\t\t\t\t\t<BIcon\n\t\t\t\t\t\tv-if="hasMenuItems"\n\t\t\t\t\t\tclass="tasks-field-results-title-icon --big"\n\t\t\t\t\t\t:name="Outline.MORE_L"\n\t\t\t\t\t\thoverable\n\t\t\t\t\t\tref="moreIcon"\n\t\t\t\t\t\t@click.stop="isMenuShown = true"\n\t\t\t\t\t/>\n\t\t\t\t\t<BIcon\n\t\t\t\t\t\tv-if="isSticky"\n\t\t\t\t\t\tclass="tasks-field-results-title-icon --big"\n\t\t\t\t\t\t:name="resizeIcon"\n\t\t\t\t\t\thoverable\n\t\t\t\t\t\t@click.stop="handleResizeClick"\n\t\t\t\t\t/>\n\t\t\t\t\t<div v-if="isSticky" class="tasks-field-results-result-empty"/>\n\t\t\t\t\t<BMenu\n\t\t\t\t\t\tv-if="isMenuShown"\n\t\t\t\t\t\t:options="menuOptions"\n\t\t\t\t\t\t@close="isMenuShown = false"\n\t\t\t\t\t/>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t<div\n\t\t\t\tclass="tasks-field-results-result-content"\n\t\t\t\tref="content"\n\t\t\t>\n\t\t\t\t<div\n\t\t\t\t\tclass="tasks-field-results-result-author"\n\t\t\t\t\t@click="handleAuthorClick"\n\t\t\t\t>\n\t\t\t\t\t<UserAvatar\n\t\t\t\t\t\t:src="resultAuthor.image"\n\t\t\t\t\t\t:type="resultAuthor.type"\n\t\t\t\t\t\t:size="UserAvatarSize.XS"\n\t\t\t\t\t\t:bx-tooltip-user-id="resultAuthor.id"\n\t\t\t\t\t\tbx-tooltip-context="b24"\n\t\t\t\t\t/>\n\t\t\t\t\t<TextSm\n\t\t\t\t\t\tclassName="tasks-field-results-result-author-name"\n\t\t\t\t\t\t:bx-tooltip-user-id="resultAuthor.id"\n\t\t\t\t\t\tbx-tooltip-context="b24"\n\t\t\t\t\t>\n\t\t\t\t\t\t{{ resultAuthor.name }}\n\t\t\t\t\t</TextSm>\n\t\t\t\t</div>\n\t\t\t\t<EntityCollapsibleText\n\t\t\t\t\tref="collapsible"\n\t\t\t\t\t:content="resultText"\n\t\t\t\t\t:files\n\t\t\t\t\treadonly\n\t\t\t\t\tshowFilesIndicator\n\t\t\t\t\topenByDefault\n\t\t\t\t\topened\n\t\t\t\t/>\n\t\t\t\t<div\n\t\t\t\t\tv-if="filesCount > 0"\n\t\t\t\t\tclass="tasks-field-results-result-files --list-mode"\n\t\t\t\t>\n\t\t\t\t\t<UserFieldWidgetComponent :uploaderAdapter :widgetOptions/>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t<div v-if="showDelimiter" class="tasks-field-results-result-separator"/>\n\t\t\t<div v-else class="tasks-field-results-result-last-padding"/>\n\t\t</div>\n\t`};const $={components:{BLine:u.BLine},template:`\n\t\t<div class="tasks-field-results-result-skeleton-container">\n\t\t\t<BLine :width="460" :height="12" :radius="60"/>\n\t\t\t<BLine :width="460" :height="12" :radius="60"/>\n\t\t\t<BLine :width="460" :height="12" :radius="60"/>\n\t\t\t<BLine :width="197" :height="12" :radius="60"/>\n\t\t</div>\n\t`};const H={name:"TaskResultEditor",components:{BIcon:g.BIcon,UiButton:v.Button,EntityTextArea:S.EntityTextArea,CopilotButton:S.CopilotButton,AttachButton:S.AttachButton,MentionButton:S.MentionButton,MoreButton:S.MoreButton,NumberListButton:S.NumberListButton,BulletListButton:S.BulletListButton},inject:{taskId:{},task:{},analytics:{},cardType:{}},provide(){return{editor:()=>this.editor,fileService:()=>this.fileService}},props:{resultId:{type:[Number,String],required:true},content:{type:String,default:""},isResized:{type:Boolean,default:false},showResize:{type:Boolean,default:true}},emits:["close","resize"],setup(t){return{ButtonSize:v.ButtonSize,ButtonColor:v.ButtonColor,Outline:g.Outline,EntityTypes:R.EntityTypes,EntityTextTypes:S.EntityTextTypes,fileService:R.fileService.get(t.resultId,R.EntityTypes.Result),entityTextEditor:S.entityTextEditor.get(t.resultId,S.EntityTextTypes.Result,{content:t.content,blockSpaceInline:"var(--ui-space-stack-xl)"})}},data(){return{isSaving:false,hasChanges:false,hasFilesChanges:false,buttonDisabled:!E.Type.isStringFilled(this.content)}},computed:{...T.mapGetters({currentUserId:`${B.Model.Interface}/currentUserId`}),result(){return this.$store.getters[`${B.Model.Results}/getById`](this.resultId)},currentUser(){return this.$store.getters[`${B.Model.Users}/getById`](this.currentUserId)},isEdit(){return E.Type.isNumber(this.resultId)&&this.resultId>0},resultDate(){if(!this.result.createdAtTs){return""}return p.calendar.formatDateTime(this.result.createdAtTs)},title(){if(this.isEdit){return this.loc("TASKS_V2_RESULT_TITLE_WITH_DATE",{"#DATE#":this.resultDate})}return this.loc("TASKS_V2_RESULT_ADD")},buttonTitle(){return this.isEdit?this.loc("TASKS_V2_RESULT_BUTTON_SAVE"):this.loc("TASKS_V2_RESULT_BUTTON_SEND")},readonly(){var t,e;if(!this.result){var s,i;return!((s=this.task)!=null&&(i=s.rights)!=null&&i.read)}return!((t=this.result)!=null&&(e=t.rights)!=null&&e.edit)},editor(){return this.entityTextEditor.getEditor()},hasEditorChanges(){return this.hasChanges||this.hasFilesChanges},resizeIcon(){return this.isResized?g.Outline.COLLAPSE_L:g.Outline.EXPAND_L},isDiskModuleInstalled(){return C.Core.getParams().features.disk},isCopilotEnabled(){return C.Core.getParams().features.isCopilotEnabled}},mounted(){if(!this.task.filledFields[w.id]){void this.$store.dispatch(`${B.Model.Tasks}/setFieldFilled`,{id:this.taskId,fieldName:w.id})}if(!E.Type.isStringFilled(this.content)||this.resultId===0){setTimeout(this.focusToEnd,400)}},unmounted(){if(!this.isEdit&&!this.isSaving){void this.$store.dispatch(`${B.Model.Results}/delete`,this.resultId);R.fileService.delete(this.resultId,R.EntityTypes.Result);S.entityTextEditor.delete(this.resultId,S.EntityTextTypes.Result)}},methods:{handleEditButtonClick(){if(this.isEdit){this.handleClose()}else{this.handleAddResult()}},handleAddResult(){this.isSaving=true;const t={...this.result,text:this.editor.getText(),author:this.currentUser,status:B.ResultStatus.Open,createdAtTs:Date.now(),updatedAtTs:Date.now()};void this.addResult(t);this.handleClose();E.Event.EventEmitter.emit(B.EventName.ResultAdded,{taskId:this.taskId})},async addResult(t){const e=await _.resultService.add(this.taskId,t);this.sendAnalyticsResultAdd(e)},sendAnalyticsResultAdd(t){b.analytics.sendStatusSummaryAdd(this.analytics,{isSuccess:t,cardType:this.cardType,taskId:E.Type.isNumber(this.taskId)?this.taskId:0,element:B.Analytics.Element.AddResult,subSection:B.Analytics.SubSection.TaskCard})},handleUpdateResult(){if(!this.hasEditorChanges){return}const t={text:this.editor.getText(),updatedAtTs:Date.now()/1e3,status:B.ResultStatus.Open};void _.resultService.update(this.resultId,t);this.hasChanges=false;this.hasFilesChanges=false;E.Event.EventEmitter.emit(B.EventName.ResultUpdated,{taskId:this.taskId,resultId:this.resultId})},handleEditorChange(){var t;const e=this.getPreparedText(this.content);const s=this.getPreparedText((t=this.editor)==null?void 0:t.getText());this.hasChanges=e!==s;this.buttonDisabled=!E.Type.isStringFilled(s)},getPreparedText(t){return t.replaceAll(/\[p]\n|\[p]\[\/p]|\[\/p]/gi,"").trim()},focusToEnd(){var t;(t=this.editor)==null?void 0:t.focus(null,{defaultSelection:"rootEnd"})},handleClose(){if(this.isEdit){this.handleUpdateResult()}this.$emit("close")}},template:`\n\t\t<div class="tasks-result-editor-wrapper" ref="wrapper">\n\t\t\t<div class="tasks-result-editor-header" ref="resultHeader">\n\t\t\t\t<div class="tasks-result-editor-title">{{ title }}</div>\n\t\t\t\t<div class="tasks-result-editor-field-actions">\n\t\t\t\t\t<BIcon\n\t\t\t\t\t\tv-if="showResize"\n\t\t\t\t\t\tclass="tasks-result-editor-field-icon"\n\t\t\t\t\t\t:name="resizeIcon"\n\t\t\t\t\t\thoverable\n\t\t\t\t\t\t@click="$emit('resize')"\n\t\t\t\t\t/>\n\t\t\t\t\t<BIcon\n\t\t\t\t\t\t:name="Outline.CROSS_L"\n\t\t\t\t\t\thoverable\n\t\t\t\t\t\tclass="tasks-result-editor-field-icon"\n\t\t\t\t\t\t@click="handleClose"\n\t\t\t\t\t/>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t<div class="tasks-result-editor-container">\n\t\t\t\t<EntityTextArea\n\t\t\t\t\t:entityId="resultId"\n\t\t\t\t\t:entityType="EntityTextTypes.Result"\n\t\t\t\t\t:readonly\n\t\t\t\t\t:removeFromServer="!isEdit"\n\t\t\t\t\tref="resultTextArea"\n\t\t\t\t\t@change="handleEditorChange"\n\t\t\t\t\t@filesChange="hasFilesChanges = true"\n\t\t\t\t/>\n\t\t\t</div>\n\t\t\t<div v-if="!readonly" class="tasks-result-editor-footer" ref="resultActions">\n\t\t\t\t<div class="tasks-result-editor-action-list">\n\t\t\t\t\t<AttachButton v-if="isDiskModuleInstalled" :fileService/>\n\t\t\t\t\t<MentionButton :editor/>\n\t\t\t\t\t<BulletListButton :editor/>\n\t\t\t\t\t<NumberListButton :editor/>\n\t\t\t\t\t<MoreButton :editor/>\n\t\t\t\t\t<CopilotButton v-if="isCopilotEnabled" :editor/>\n\t\t\t\t</div>\n\t\t\t\t<div class="tasks-result-editor-footer-buttons">\n\t\t\t\t\t<UiButton\n\t\t\t\t\t\t:text="buttonTitle"\n\t\t\t\t\t\t:size="ButtonSize.MEDIUM"\n\t\t\t\t\t\t:color="ButtonColor.PRIMARY"\n\t\t\t\t\t\t:disabled="buttonDisabled || isSaving"\n\t\t\t\t\t\t@click="handleEditButtonClick"\n\t\t\t\t\t/>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</div>\n\t`};const N={components:{BottomSheet:c.BottomSheet,DropZone:h.DropZone,ResultEditor:H},inject:{taskId:{}},props:{resultId:{type:[Number,String],required:true},showResize:{type:Boolean,default:true},sheetBindProps:{type:Object,required:true}},emits:["close"],setup(){return{EntityTypes:R.EntityTypes}},data(){return{isResized:false,uniqueKey:E.Text.getRandom()}},computed:{result(){return this.$store.getters[`${B.Model.Results}/getById`](this.resultId)},bottomSheetContainer(){return document.getElementById(`b24-bottom-sheet-${this.uniqueKey}`)||null},isDiskModuleInstalled(){return C.Core.getParams().features.disk}},mounted(){a.EventEmitter.subscribe(B.EventName.OpenResultFromChat,this.handleOpenResultFromMessage)},beforeUnmount(){a.EventEmitter.unsubscribe(B.EventName.OpenResultFromChat,this.handleOpenResultFromMessage)},methods:{handleOpenResultFromMessage(t){const{taskId:e}=t.getData();if(this.taskId===e){this.$emit("close")}}},template:`\n\t\t<BottomSheet\n\t\t\t:sheetBindProps\n\t\t\t:isExpanded="isResized"\n\t\t\t:padding="0"\n\t\t\t:popupPadding="0"\n\t\t\t:uniqueKey\n\t\t\t@close="$emit('close')"\n\t\t>\n\t\t\t<ResultEditor\n\t\t\t\t:resultId\n\t\t\t\t:content="result.text || ''"\n\t\t\t\t:isResized\n\t\t\t\t:showResize\n\t\t\t\t@close="$emit('close')"\n\t\t\t\t@resize="isResized = !isResized"\n\t\t\t/>\n\t\t\t<DropZone\n\t\t\t\tv-if="isDiskModuleInstalled"\n\t\t\t\t:container="bottomSheetContainer || {}"\n\t\t\t\t:entityId="resultId || 0"\n\t\t\t\t:entityType="EntityTypes.Result"\n\t\t\t/>\n\t\t</BottomSheet>\n\t`};const V={name:"ResultListEmpty",components:{TextLg:f.TextLg,UiButton:v.Button},emits:["addResult"],setup(){return{AirButtonStyle:v.AirButtonStyle,ButtonSize:v.ButtonSize,Outline:g.Outline}},template:`\n\t\t<div class="tasks-field-results-result-list-empty">\n\t\t\t<div class="tasks-field-results-result-list-empty-image"/>\n\t\t\t<TextLg className="tasks-field-results-result-list-empty-title">\n\t\t\t\t{{ loc('TASKS_V2_RESULT_LIST_EMPTY') }}\n\t\t\t</TextLg>\n\t\t\t<div class="tasks-field-results-result-list-empty-button">\n\t\t\t\t<UiButton\n\t\t\t\t\t:text="loc('TASKS_V2_RESULT_ADD')"\n\t\t\t\t\t:size="ButtonSize.MEDIUM"\n\t\t\t\t\t:style="AirButtonStyle.FILLED"\n\t\t\t\t\t:leftIcon="Outline.PLUS_L"\n\t\t\t\t\t:wide="false"\n\t\t\t\t\t@click="$emit('addResult')"\n\t\t\t\t/>\n\t\t\t</div>\n\t\t</div>\n\t`};const P={components:{BottomSheet:c.BottomSheet,BIcon:g.BIcon,UiButton:v.Button,ResultListItem:D,ResultSkeleton:$,ResultEditorSheet:N,ResultListEmpty:V,HeadlineMd:f.HeadlineMd},inject:{task:{},taskId:{}},props:{resultId:{type:[Number,String],required:true},sheetBindProps:{type:Object,required:true}},emits:["close"],setup(){return{Outline:g.Outline,AirButtonStyle:v.AirButtonStyle,ButtonSize:v.ButtonSize}},data(){return{editResultId:0,isResultEditorShown:false,isResized:false}},computed:{results(){return this.task.results},loadedResults(){return this.results.filter((t=>this.isResultLoaded(t)))},hasUnloadedResults(){return this.results.length!==this.loadedResults.length},isEmptyState(){return this.results.length===0}},watch:{async resultId(t){await this.$nextTick();if(t){this.focusTo(t)}}},mounted(){if(this.hasUnloadedResults){void _.resultService.getAll(this.taskId)}this.focusTo(this.resultId);a.EventEmitter.subscribe(B.EventName.ResultAdded,this.handleResultAdded);a.EventEmitter.subscribe(B.EventName.ResultUpdated,this.handleResultUpdated);a.EventEmitter.subscribe(B.EventName.OpenResultFromChat,this.handleOpenResultFromMessage)},beforeUnmount(){a.EventEmitter.unsubscribe(B.EventName.ResultAdded,this.handleResultAdded);a.EventEmitter.unsubscribe(B.EventName.ResultUpdated,this.handleResultUpdated);a.EventEmitter.unsubscribe(B.EventName.OpenResultFromChat,this.handleOpenResultFromMessage)},methods:{isResultLoaded(t){return Boolean(this.$store.getters[`${B.Model.Results}/getById`](t))},focusTo(t){if(!t){return}const e=this.$refs.scrollContainer;if(!e){return}const{targetId:s,offset:i,shouldHighlight:n}=this.calculateFocusTarget(t);this.scrollToTarget(s,i,n)},calculateFocusTarget(t){return{targetId:t,offset:80,shouldHighlight:true}},scrollToTarget(t,e,s){setTimeout((()=>{const i=this.$refs.scrollContainer.querySelector(`[data-result-id="${t}"]`);if(!i){return}if(s){this.highlightResult(t)}this.$refs.scrollContainer.scrollTop=i.offsetTop-e}),0)},highlightResult(t){const e=this.$refs.scrollContainer.querySelector(`[data-result-id="${t}"]`);if(e){void n.highlighter.highlight(e)}},openAddResultSheet(){this.editResultId=E.Text.getRandom();const t={id:this.editResultId,taskId:this.taskId,author:C.Core.getParams().currentUser};void this.$store.dispatch(`${B.Model.Results}/insert`,t);this.isResultEditorShown=true},openEditResult(t){this.editResultId=t;this.isResultEditorShown=true},closeResultEditor(){this.isResultEditorShown=false;this.editResultId=0},handleResultAdded(t){const{taskId:e}=t.getData();if(e!==this.taskId){return}this.$emit("close")},handleResultUpdated(t){const{taskId:e,resultId:s}=t.getData();if(e!==this.taskId){return}this.focusTo(s)},handleOpenResultFromMessage(t){const{taskId:e,resultId:s}=t.getData();if(this.taskId!==e||!this.isShown){return}this.focusTo(s)}},template:`\n\t\t<BottomSheet\n\t\t\t:sheetBindProps\n\t\t\t:isExpanded="isResized"\n\t\t\t:padding="0"\n\t\t\t:popupPadding="0"\n\t\t\t@close="$emit('close')"\n\t\t>\n\t\t\t<div class="tasks-field-results-result-list" ref="main">\n\t\t\t\t<div class="tasks-field-results-result-list-close-icon">\n\t\t\t\t\t<BIcon :name="Outline.CROSS_L" hoverable @click="$emit('close')"/>\n\t\t\t\t</div>\n\t\t\t\t<div  v-if="isEmptyState" class="tasks-field-results-result-list-header">\n\t\t\t\t\t<HeadlineMd className="tasks-field-results-result-list-title">\n\t\t\t\t\t\t{{ loc('TASKS_V2_RESULT_LIST_EMPTY_TITLE') }}\n\t\t\t\t\t</HeadlineMd>\n\t\t\t\t</div>\n\t\t\t\t<div class="tasks-field-results-result-list-content" ref="scrollContainer">\n\t\t\t\t\t<ResultListEmpty v-if="isEmptyState" @addResult="openAddResultSheet"/>\n\t\t\t\t\t<div\n\t\t\t\t\t\tv-else\n\t\t\t\t\t\tv-for="(result, resultIndex) in results"\n\t\t\t\t\t\t:key="result"\n\t\t\t\t\t\t:data-result-id="result"\n\t\t\t\t\t\tclass="tasks-field-results-result-item"\n\t\t\t\t\t>\n\t\t\t\t\t\t<ResultListItem\n\t\t\t\t\t\t\tv-if="isResultLoaded(result)"\n\t\t\t\t\t\t\t:resultId="result"\n\t\t\t\t\t\t\tlistMode\n\t\t\t\t\t\t\t:showDelimiter="resultIndex !== results.length - 1"\n\t\t\t\t\t\t\t:isResized\n\t\t\t\t\t\t\t@edit="openEditResult"\n\t\t\t\t\t\t\t@resize="isResized = !isResized"\n\t\t\t\t\t\t/>\n\t\t\t\t\t\t<ResultSkeleton v-else/>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t<div\n\t\t\t\tv-if="!isEmptyState"\n\t\t\t\tclass="tasks-field-results-result-add-button"\n\t\t\t>\n\t\t\t\t<UiButton\n\t\t\t\t\t:text="loc('TASKS_V2_RESULT_ADD')"\n\t\t\t\t\t:style="AirButtonStyle.SELECTION"\n\t\t\t\t\t:size="ButtonSize.SMALL"\n\t\t\t\t\t@click="openAddResultSheet"\n\t\t\t\t/>\n\t\t\t</div>\n\t\t\t<ResultEditorSheet\n\t\t\t\tv-if="isResultEditorShown"\n\t\t\t\t:resultId="editResultId"\n\t\t\t\t:sheetBindProps\n\t\t\t\t:showResize="false"\n\t\t\t\t@close="closeResultEditor"\n\t\t\t/>\n\t\t</BottomSheet>\n\t`};const q={name:"TaskResults",components:{BIcon:g.BIcon,BMenu:I.BMenu,Hint:i.Hint,TextMd:f.TextMd,TextXs:f.TextXs,ResultCardItem:x,ResultRequiredAha:F,ResultEditorSheet:N,ResultListSheet:P},directives:{hint:r.hint},inject:{task:{},taskId:{},isEdit:{}},props:{isSheetShown:{type:Boolean,default:false},isListSheetShown:{type:Boolean,default:false},sheetBindProps:{type:Object,required:true}},setup(){return{resultsMeta:w,Outline:g.Outline,Animated:g.Animated}},data(){return{isMenuShown:false,isLoading:null,showCreatorResultHint:false,showResponsibleResultHint:false,sheetResultId:0}},computed:{...T.mapGetters({stateFlags:`${B.Model.Interface}/stateFlags`}),requireResult(){var t;return((t=this.task)==null?void 0:t.requireResult)||false},isCreator(){return C.Core.getParams().currentUser.id===(this==null?void 0:this.task.creatorId)},isResponsible(){var t,e,s;const i=C.Core.getParams().currentUser.id;return((t=this.task)==null?void 0:(e=t.responsibleIds)==null?void 0:e.includes(i))||((s=this.task)==null?void 0:s.accomplicesIds.includes(i))},containsResults(){return this.task.containsResults},results(){return this.task.results||[]},hasResults(){return this.results.length>0},showMore(){return this.results.length>1},lastResultId(){return this.hasResults?this.results[0]:null},moreText(){const t=this.results.length-1;return E.Loc.getMessagePlural("TASKS_V2_RESULT_SHOW_MORE",t,{"#COUNT#":t})},emptyResultTitle(){return this.requireResult?E.Loc.getMessage("TASKS_V2_RESULT_TITLE_REQUIRED"):w.title},showMoreIcon(){return this.task.rights.edit},menuOptions(){return{id:`result-field-menu-${E.Text.getRandom()}`,bindOptions:{forceBindPosition:true},bindElement:this.$refs.moreIcon.$el,targetContainer:document.body,minWidth:240,offsetLeft:-100,items:this.menuItems,autoHide:true,closeByEsc:true}},menuItems(){return[{title:this.loc("TASKS_V2_RESULT_ADD"),icon:g.Outline.PLUS_L,onClick:this.openAddResultSheet,dataset:{id:`MenuResultAdd-${this.taskId}`}},this.requireResult&&{title:this.loc("TASKS_V2_RESULT_NOT_REQUIRED"),design:"alert",icon:g.Outline.CROSS_L,onClick:this.handleUnrequireResult,dataset:{id:`MenuResultNotRequire-${this.taskId}`}},!this.requireResult&&{title:this.loc("TASKS_V2_RESULT_REQUIRE"),icon:g.Outline.WINDOW_FLAG,isLocked:this.isLocked,onClick:this.handleRequireResult,dataset:{id:`MenuResultRequire-${this.taskId}`}}]},isLocked(){return!C.Core.getParams().restrictions.requiredResult.available},featureId(){return C.Core.getParams().restrictions.requiredResult.featureId}},watch:{requireResult:{async handler(t){if(t){await this.$nextTick();this.tryShowResultHints()}},deep:true}},async created(){if(!this.isEdit||!this.containsResults){return}if(E.Type.isArrayFilled(this.results)){return}this.isLoading=true;await _.resultService.tail(this.taskId);this.isLoading=false},mounted(){this.tryShowResultHints();a.EventEmitter.subscribe(B.EventName.ResultAdded,this.handleHighlightFieldAfterEdit);a.EventEmitter.subscribe(B.EventName.ResultUpdated,this.handleHighlightFieldAfterEdit);a.EventEmitter.subscribe(B.EventName.RequiredResultsMissing,this.showResponsibleHint);a.EventEmitter.subscribe(B.EventName.OpenResultFromChat,this.handleOpenResultFromMessage)},beforeUnmount(){a.EventEmitter.unsubscribe(B.EventName.ResultAdded,this.handleHighlightFieldAfterEdit);a.EventEmitter.unsubscribe(B.EventName.ResultUpdated,this.handleHighlightFieldAfterEdit);a.EventEmitter.unsubscribe(B.EventName.RequiredResultsMissing,this.showResponsibleHint);a.EventEmitter.unsubscribe(B.EventName.OpenResultFromChat,this.handleOpenResultFromMessage)},methods:{openMore(){this.openResultSheet(0)},handleTitleClick(){if(!this.isLoading){this.openAddResultSheet()}},openAddResultSheet(){const t=E.Text.getRandom();const e={id:t,taskId:this.taskId,author:C.Core.getParams().currentUser};void this.$store.dispatch(`${B.Model.Results}/insert`,e);this.openEditSheet(t)},handleResponsibleHintButtonClick(){this.handleResponsibleHintClose();this.openAddResultSheet()},handleRequireResult(){if(this.isLocked){void y.showLimit({featureId:this.featureId});return}this.setRequireResult(true)},handleUnrequireResult(){this.setRequireResult(false)},async setRequireResult(t){void L.taskService.update(this.taskId,{requireResult:t});if(!this.isEdit){await this.$store.dispatch(`${B.Model.Interface}/updateStateFlags`,{defaultRequireResult:t});void O.stateService.set(this.stateFlags)}},tryShowResultHints(){if(!this.requireResult||this.containsResults){return}if(!this.isEdit&&s.ahaMoments.shouldShow(B.Option.AhaRequiredResultCreatorPopup)){s.ahaMoments.setActive(B.Option.AhaRequiredResultCreatorPopup);this.showCreatorHint();return}if(this.isEdit&&this.isResponsible&&!this.isCreator&&s.ahaMoments.shouldShow(B.Option.AhaRequiredResultResponsiblePopup)){s.ahaMoments.setActive(B.Option.AhaRequiredResultResponsiblePopup);setTimeout((()=>{this.showResponsibleHint()}),2e3)}},showCreatorHint(){this.showCreatorResultHint=true;this.highlightField()},showResponsibleHint(){this.showResponsibleResultHint=true;this.highlightField()},handleHighlightFieldAfterEdit(t){const{taskId:e}=t.getData();if(this.taskId!==e){return}this.highlightField()},handleCreatorHintClose(){if(!this.showCreatorResultHint){return}this.showCreatorResultHint=false;s.ahaMoments.setInactive(B.Option.AhaRequiredResultCreatorPopup);s.ahaMoments.setShown(B.Option.AhaRequiredResultCreatorPopup)},handleResponsibleHintClose(){if(!this.showResponsibleResultHint){return}this.showResponsibleResultHint=false;s.ahaMoments.setInactive(B.Option.AhaRequiredResultResponsiblePopup);if(s.ahaMoments.shouldShow(B.Option.AhaRequiredResultResponsiblePopup)){s.ahaMoments.setShown(B.Option.AhaRequiredResultResponsiblePopup)}},handleOpenResultFromMessage(t){const{taskId:e,resultId:s}=t.getData();if(this.taskId!==e||this.isListSheetShown){return}this.openResultSheet(s)},highlightField(){void M.fieldHighlighter.setContainer(this.$root.$el).highlight(w.id)},getRequiredResultAhaWidth(){var t,e;return E.Type.isNumber((t=this.$refs)==null?void 0:(e=t.resultsContainer)==null?void 0:e.offsetWidth)?Math.min(this.$refs.resultsContainer.offsetWidth,530):530},openEditSheet(t){this.sheetResultId=t;this.setSheetShown(true)},openResultSheet(t){this.sheetResultId=t;this.setListSheetShown(true)},setSheetShown(t){this.$emit("update:isSheetShown",t)},setListSheetShown(t){this.$emit("update:isListSheetShown",t)}},template:`\n\t\t<div\n\t\t\tclass="tasks-field-results"\n\t\t\t:data-task-id="taskId"\n\t\t>\n\t\t\t<template v-if="lastResultId">\n\t\t\t\t<div ref="resultsContainer">\n\t\t\t\t\t<ResultCardItem\n\t\t\t\t\t\t:resultId="lastResultId"\n\t\t\t\t\t\t@titleClick="openResultSheet"\n\t\t\t\t\t\t@add="openAddResultSheet"\n\t\t\t\t\t\t@edit="openEditSheet"\n\t\t\t\t\t\t@highlightField="highlightField"\n\t\t\t\t\t/>\n\t\t\t\t</div>\n\t\t\t\t<div class="tasks-field-results-more-container">\n\t\t\t\t\t<div\n\t\t\t\t\t\tv-if="showMore"\n\t\t\t\t\t\tclass="tasks-field-results-more"\n\t\t\t\t\t\t@click="openMore"\n\t\t\t\t\t>\n\t\t\t\t\t\t<div class="tasks-field-results-more-text">{{ moreText }}</div>\n\t\t\t\t\t\t<BIcon\n\t\t\t\t\t\t\tclass="tasks-field-results-title-icon --auto-left"\n\t\t\t\t\t\t\t:name="Outline.CHEVRON_RIGHT_L"\n\t\t\t\t\t\t\thoverable\n\t\t\t\t\t\t/>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div\n\t\t\t\t\t\tclass="tasks-field-results-more"\n\t\t\t\t\t\t:class="{ '--border': showMore }"\n\t\t\t\t\t\t@click="openAddResultSheet"\n\t\t\t\t\t>\n\t\t\t\t\t\t<div class="tasks-field-results-more-text">{{ loc('TASKS_V2_RESULT_ADD_MORE') }}</div>\n\t\t\t\t\t\t<BIcon\n\t\t\t\t\t\t\tclass="tasks-field-results-title-icon --auto-left"\n\t\t\t\t\t\t\t:name="Outline.PLUS_L"\n\t\t\t\t\t\t\thoverable\n\t\t\t\t\t\t/>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</template>\n\t\t\t<template v-else>\n\t\t\t\t<div\n\t\t\t\t\tclass="tasks-field-results-empty-container"\n\t\t\t\t\t:data-task-field-id="resultsMeta.id"\n\t\t\t\t\tdata-field-container\n\t\t\t\t\tref="resultsContainer"\n\t\t\t\t>\n\t\t\t\t\t<div\n\t\t\t\t\t\tclass="tasks-field-results-title"\n\t\t\t\t\t\t@click="handleTitleClick"\n\t\t\t\t\t>\n\t\t\t\t\t\t<div\n\t\t\t\t\t\t\tv-if="isLoading"\n\t\t\t\t\t\t\tclass="tasks-field-results-title-main"\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<BIcon :name="Animated.LOADER_WAIT"/>\n\t\t\t\t\t\t\t<TextMd accent>{{ loc('TASKS_V2_RESULT_TITLE_LOADING') }}</TextMd>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div\n\t\t\t\t\t\t\tv-else\n\t\t\t\t\t\t\tclass="tasks-field-results-title-main"\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<BIcon :name="Outline.WINDOW_FLAG"/>\n\t\t\t\t\t\t\t<TextMd accent>{{ emptyResultTitle }}</TextMd>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div class="tasks-field-results-title-actions">\n\t\t\t\t\t\t\t<BIcon\n\t\t\t\t\t\t\t\tv-if="showMoreIcon"\n\t\t\t\t\t\t\t\tclass="tasks-field-results-title-icon"\n\t\t\t\t\t\t\t\t:name="Outline.MORE_L"\n\t\t\t\t\t\t\t\thoverable\n\t\t\t\t\t\t\t\tref="moreIcon"\n\t\t\t\t\t\t\t\t@click.stop="isMenuShown = true"\n\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t<BIcon\n\t\t\t\t\t\t\t\tv-else\n\t\t\t\t\t\t\t\tclass="tasks-field-results-title-icon"\n\t\t\t\t\t\t\t\t:name="Outline.PLUS_L"\n\t\t\t\t\t\t\t\thoverable\n\t\t\t\t\t\t\t\t:data-task-results-add="resultsMeta.id"\n\t\t\t\t\t\t\t\t@click.stop="openAddResultSheet"\n\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<BMenu\n\t\t\t\t\t\tv-if="isMenuShown"\n\t\t\t\t\t\t:options="menuOptions"\n\t\t\t\t\t\t@close="isMenuShown = false"\n\t\t\t\t\t/>\n\t\t\t\t</div>\n\t\t\t\t<Hint\n\t\t\t\t\tv-if="showCreatorResultHint"\n\t\t\t\t\t:bindElement="$refs.resultsContainer"\n\t\t\t\t\t:options="{ closeIcon: true }"\n\t\t\t\t\t@close="handleCreatorHintClose"\n\t\t\t\t>\n\t\t\t\t\t{{ loc('TASKS_V2_RESULT_AHA_REQUIRE_RESULT_CREATOR') }}\n\t\t\t\t</Hint>\n\t\t\t</template>\n\t\t\t<ResultRequiredAha\n\t\t\t\tv-if="showResponsibleResultHint"\n\t\t\t\t:bindElement="$refs.resultsContainer"\n\t\t\t\t:popupWidth="getRequiredResultAhaWidth()"\n\t\t\t\t:hasResults\n\t\t\t\t@close="handleResponsibleHintClose"\n\t\t\t\t@addResult="handleResponsibleHintButtonClick"\n\t\t\t/>\n\t\t</div>\n\t\t<ResultEditorSheet\n\t\t\tv-if="isSheetShown"\n\t\t\t:resultId="sheetResultId"\n\t\t\t:sheetBindProps\n\t\t\t@close="setSheetShown(false)"\n\t\t/>\n\t\t<ResultListSheet\n\t\t\tv-if="isListSheetShown"\n\t\t\t:resultId="sheetResultId"\n\t\t\t:sheetBindProps\n\t\t\t@close="setListSheetShown(false)"\n\t\t/>\n\t`};const z={components:{Chip:k.Chip,BMenu:I.BMenu,ResultEditorSheet:N},inject:{task:{},taskId:{},isEdit:{},analytics:{},cardType:{}},props:{isSheetShown:{type:Boolean,default:false},sheetBindProps:{type:Object,required:true}},emits:["update:isSheetShown"],setup(){return{Outline:g.Outline,resultsMeta:w}},data(){return{isMenuShown:false,sheetResultId:0}},computed:{...T.mapGetters({currentUserId:`${B.Model.Interface}/currentUserId`,stateFlags:`${B.Model.Interface}/stateFlags`}),design(){return this.isSelected?k.ChipDesign.ShadowAccent:k.ChipDesign.ShadowNoAccent},isSelected(){return this.task.filledFields[w.id]||this.task.requireResult},menuOptions(){return{id:`result-chip-menu-${E.Text.getRandom()}`,bindOptions:{forceBindPosition:true,forceTop:true,position:"top"},bindElement:this.$refs.chip.$el,targetContainer:document.body,minWidth:240,items:this.menuItems,autoHide:true,closeByEsc:true}},menuItems(){return[{title:this.loc("TASKS_V2_RESULT_ADD"),icon:g.Outline.PLUS_L,onClick:this.openAddResultSheet,dataset:{id:`MenuResultAdd-${this.taskId}`}},{title:this.loc("TASKS_V2_RESULT_REQUIRE"),icon:g.Outline.WINDOW_FLAG,onClick:this.requireResult,isLocked:this.isLocked,dataset:{id:`MenuResultRequire-${this.taskId}`}}]},isLocked(){return!C.Core.getParams().restrictions.requiredResult.available},featureId(){return C.Core.getParams().restrictions.requiredResult.featureId}},mounted(){E.Event.EventEmitter.subscribe(B.EventName.AddResultFromChat,this.handleAddResultFromChat);E.Event.EventEmitter.subscribe(B.EventName.DeleteResultFromChat,this.handleDeleteResultFromChat)},beforeUnmount(){E.Event.EventEmitter.unsubscribe(B.EventName.AddResultFromChat,this.handleAddResultFromChat);E.Event.EventEmitter.unsubscribe(B.EventName.DeleteResultFromChat,this.handleDeleteResultFromChat)},methods:{handleClick(){if(this.isSelected){this.highlightField();return}if(!this.isEdit&&!this.isLocked){this.requireResult();return}if(this.task.rights.edit){this.isMenuShown=true}else{this.openAddResultSheet()}},async handleAddResultFromChat(t){const{taskId:e,messageId:s,text:i,authorId:n}=t.data;if(e!==this.taskId){return}const l={text:E.Type.isStringFilled(i)?i:this.loc("TASKS_V2_RESULT_DEFAULT_TITLE_FROM_MESSAGE"),author:this.getUserDto(n),id:E.Text.getRandom(),taskId:this.taskId,createdAtTs:Date.now()/1e3,updatedAtTs:Date.now()/1e3,rights:{edit:true,remove:true}};const r=await _.resultService.addResultFromMessage(e,s,l);this.sendAnalyticsResultFromMessageAdd(r);if(r){E.Event.EventEmitter.emit(B.EventName.ResultFromMessageAdded,{taskId:e})}},sendAnalyticsResultFromMessageAdd(t){b.analytics.sendStatusSummaryAdd(this.analytics,{isSuccess:t,cardType:this.cardType,taskId:E.Type.isNumber(this.taskId)?this.taskId:0,element:B.Analytics.Element.ChatContextMenu,subSection:B.Analytics.SubSection.Chat})},handleDeleteResultFromChat(t){const{taskId:e,resultId:s}=t.data;if(e!==this.taskId){return}void _.resultService.delete(s)},openAddResultSheet(){const t=E.Text.getRandom();const e={id:t,taskId:this.taskId,author:this.getUser(this.currentUserId)};void this.$store.dispatch(`${B.Model.Results}/insert`,e);this.sheetResultId=t;this.setSheetShown(true)},async requireResult(){if(this.isLocked){void y.showLimit({featureId:this.featureId});return}void L.taskService.update(this.taskId,{requireResult:true});if(!this.isEdit){await this.$store.dispatch(`${B.Model.Interface}/updateStateFlags`,{defaultRequireResult:true});void O.stateService.set(this.stateFlags)}},highlightField(){void M.fieldHighlighter.setContainer(this.$root.$el).highlight(w.id)},getUser(t){return this.$store.getters[`${B.Model.Users}/getById`](t)},getUserDto(t){return U.UserMappers.mapModelToDto(this.getUser(t))},setSheetShown(t){this.$emit("update:isSheetShown",t)}},template:`\n\t\t<Chip\n\t\t\t:design\n\t\t\t:text="resultsMeta.title"\n\t\t\t:icon="Outline.WINDOW_FLAG"\n\t\t\t:data-task-id="taskId"\n\t\t\t:data-task-chip-id="resultsMeta.id"\n\t\t\tref="chip"\n\t\t\t@click="handleClick"\n\t\t/>\n\t\t<BMenu v-if="isMenuShown" :options="menuOptions" @close="isMenuShown = false"/>\n\t\t<ResultEditorSheet\n\t\t\tv-if="isSheetShown"\n\t\t\t:resultId="sheetResultId"\n\t\t\t:sheetBindProps\n\t\t\t@close="setSheetShown(false)"\n\t\t/>\n\t`};t.Results=q;t.ResultsChip=z;t.ResultListSheet=P;t.ResultEditorSheet=N;t.resultsMeta=w})(this.BX.Tasks.V2.Component.Fields=this.BX.Tasks.V2.Component.Fields||{},BX,BX.Tasks.V2.Lib,BX.Tasks.V2.Component.Elements,BX.Tasks.V2.Lib,BX.Vue3,BX.Vue3.Directives,BX.Tasks.V2.Component.Elements,BX.Tasks.V2.Component.Elements,BX.UI.System.Skeleton.Vue,BX.Event,BX.Tasks.V2.Component,BX.Tasks.V2.Component.Elements,BX.UI.TextEditor,BX.Tasks.V2.Lib,BX.Tasks.V2.Provider.Service,BX.Tasks.V2.Component,BX.UI.System.Typography.Vue,BX.Vue3.Components,BX,BX.Vue3.Vuex,BX.UI.Vue3.Components,BX.UI.System.Chip.Vue,BX.UI.IconSet,BX,BX.Tasks.V2,BX.Tasks.V2.Const,BX.Tasks.V2.Lib,BX.Tasks.V2.Lib,BX.Tasks.V2.Lib,BX.Tasks.V2.Provider.Service,BX.Tasks.V2.Provider.Service,BX.Tasks.V2.Provider.Service,BX.Tasks.V2.Provider.Service);
//# sourceMappingURL=results.bundle.map.js