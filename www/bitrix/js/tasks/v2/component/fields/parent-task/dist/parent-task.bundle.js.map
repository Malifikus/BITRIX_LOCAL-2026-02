{"version":3,"file":"parent-task.bundle.js","sources":["../src/parent-task-meta.js","../src/parent-task-dialog.js","../src/parent-task.js","../src/parent-task-chip.js"],"sourcesContent":["import { TaskField } from 'tasks.v2.const';\n\nexport const parentTaskMeta = Object.freeze({\n\tid: TaskField.Parent,\n});\n","import { Runtime } from 'main.core';\n\nimport { EntitySelectorEntity, TaskField } from 'tasks.v2.const';\nimport { EntitySelectorDialog, type ItemId } from 'tasks.v2.lib.entity-selector-dialog';\nimport { relationError } from 'tasks.v2.lib.relation-error';\nimport { idUtils, type TaskId } from 'tasks.v2.lib.id-utils';\nimport { subTasksService } from 'tasks.v2.provider.service.relation-service';\nimport { taskService } from 'tasks.v2.provider.service.task-service';\n\ntype Params = {\n\ttargetNode: HTMLElement,\n\ttaskId: TaskId,\n\tonUpdate: Function,\n};\n\nconst dialogs: { [isTemplate: boolean]: EntitySelectorDialog } = {};\n\nexport const parentTaskDialog = new class\n{\n\t#taskId: TaskId;\n\t#onUpdate: Function;\n\n\tshow(params: Params): void\n\t{\n\t\tthis.#taskId = params.taskId;\n\t\tthis.#onUpdate = params.onClose;\n\n\t\tthis.#dialog.selectItemsByIds(this.#items);\n\t\tthis.#dialog.showTo(params.targetNode);\n\t}\n\n\tget #dialog(): EntitySelectorDialog\n\t{\n\t\tconst isTemplate = idUtils.isTemplate(this.#taskId);\n\t\tdialogs[isTemplate] ??= this.#createDialog(isTemplate);\n\n\t\treturn dialogs[isTemplate];\n\t}\n\n\t#createDialog(isTemplate: boolean): EntitySelectorDialog\n\t{\n\t\tconst onItemChange = Runtime.debounce(this.#onItemChange, 10, this);\n\n\t\treturn new EntitySelectorDialog({\n\t\t\tcontext: 'tasks-card',\n\t\t\tmultiple: false,\n\t\t\thideOnDeselect: true,\n\t\t\tenableSearch: true,\n\t\t\twidth: 500,\n\t\t\tentities: [\n\t\t\t\t{\n\t\t\t\t\tid: EntitySelectorEntity.Task,\n\t\t\t\t\toptions: {\n\t\t\t\t\t\twithTab: true,\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t\tisTemplate && {\n\t\t\t\t\tid: EntitySelectorEntity.Template,\n\t\t\t\t\toptions: {\n\t\t\t\t\t\twithTab: true,\n\t\t\t\t\t\twithFooter: false,\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t].filter((it) => it),\n\t\t\tpreselectedItems: this.#items,\n\t\t\tevents: {\n\t\t\t\t'Item:onSelect': onItemChange,\n\t\t\t\t'Item:onDeselect': onItemChange,\n\t\t\t},\n\t\t});\n\t}\n\n\tasync #onItemChange(): void\n\t{\n\t\tconst item = this.#dialog.getSelectedItems()[0];\n\t\tconst isTemplate = item?.getEntityId() === EntitySelectorEntity.Template;\n\t\tconst selectedTaskId = isTemplate ? idUtils.boxTemplate(item.getId()) : (item?.getId() ?? 0);\n\n\t\tconst error = await subTasksService.setParent(this.#taskId, selectedTaskId);\n\n\t\tif (error)\n\t\t{\n\t\t\tvoid relationError.setTaskId(this.#taskId).showError(error, TaskField.Parent);\n\n\t\t\treturn;\n\t\t}\n\n\t\tthis.#onUpdate?.();\n\t}\n\n\tget #items(): ItemId[]\n\t{\n\t\tconst parentId = taskService.getStoreTask(this.#taskId).parentId;\n\t\tconst templateId = idUtils.unbox(parentId);\n\t\tconst isTemplate = idUtils.isTemplate(parentId);\n\t\tconst itemId = isTemplate ? [EntitySelectorEntity.Template, templateId] : [EntitySelectorEntity.Task, parentId];\n\n\t\treturn parentId ? [itemId] : [];\n\t}\n}();\n","import { hint, type HintParams } from 'ui.vue3.directives.hint';\nimport { TextMd } from 'ui.system.typography.vue';\nimport { BIcon, Outline } from 'ui.icon-set.api.vue';\nimport 'ui.icon-set.outline';\n\nimport { TaskList } from 'tasks.v2.component.task-list';\nimport { tooltip } from 'tasks.v2.component.elements.hint';\nimport { subTasksService } from 'tasks.v2.provider.service.relation-service';\nimport { idUtils } from 'tasks.v2.lib.id-utils';\nimport type { TaskModel } from 'tasks.v2.model.tasks';\n\nimport { parentTaskMeta } from './parent-task-meta';\nimport { parentTaskDialog } from './parent-task-dialog';\n\nimport './parent-task.css';\n\n// @vue/component\nexport const ParentTask = {\n\tname: 'TaskParentTask',\n\tcomponents: {\n\t\tBIcon,\n\t\tTaskList,\n\t\tTextMd,\n\t},\n\tdirectives: { hint },\n\tinject: {\n\t\ttask: {},\n\t\ttaskId: {},\n\t},\n\tsetup(): { task: TaskModel }\n\t{\n\t\treturn {\n\t\t\tOutline,\n\t\t\tparentTaskMeta,\n\t\t\tsubTasksService,\n\t\t};\n\t},\n\tcomputed: {\n\t\tparentId(): number\n\t\t{\n\t\t\treturn this.task.parentId;\n\t\t},\n\t\thasParent(): boolean\n\t\t{\n\t\t\treturn idUtils.isReal(this.parentId);\n\t\t},\n\t\ttitle(): string\n\t\t{\n\t\t\tif (idUtils.isTemplate(this.parentId))\n\t\t\t{\n\t\t\t\treturn this.loc('TASKS_V2_PARENT_TEMPLATE_TITLE');\n\t\t\t}\n\n\t\t\treturn this.loc('TASKS_V2_PARENT_TASK_TITLE');\n\t\t},\n\t\ttooltip(): Function\n\t\t{\n\t\t\treturn (): HintParams => tooltip({\n\t\t\t\ttext: this.loc('TASKS_V2_PARENT_TASK_SELECT'),\n\t\t\t\tpopupOptions: {\n\t\t\t\t\toffsetLeft: this.$refs.add.$el.offsetWidth / 2,\n\t\t\t\t},\n\t\t\t});\n\t\t},\n\t},\n\twatch: {\n\t\tparentId: {\n\t\t\timmediate: true,\n\t\t\thandler(): void\n\t\t\t{\n\t\t\t\tif (this.hasParent)\n\t\t\t\t{\n\t\t\t\t\tvoid subTasksService.getParent(this.taskId, this.parentId);\n\t\t\t\t}\n\t\t\t},\n\t\t},\n\t},\n\tmethods: {\n\t\thandleEditClick(): void\n\t\t{\n\t\t\tparentTaskDialog.show({\n\t\t\t\ttargetNode: this.$refs.add.$el,\n\t\t\t\ttaskId: this.taskId,\n\t\t\t});\n\t\t},\n\t\tasync handleRemoveParentTask(): void\n\t\t{\n\t\t\tawait subTasksService.setParent(this.taskId, 0);\n\t\t},\n\t},\n\ttemplate: `\n\t\t<div class=\"tasks-field-parent-task\" :data-task-id=\"taskId\" :data-task-field-id=\"parentTaskMeta.id\">\n\t\t\t<div class=\"tasks-field-parent-task-title\">\n\t\t\t\t<div class=\"tasks-field-parent-task-main\" :class=\"{ '--readonly': true }\">\n\t\t\t\t\t<BIcon :name=\"Outline.SUBTASK\"/>\n\t\t\t\t\t<TextMd accent>{{ title }}</TextMd>\n\t\t\t\t</div>\n\t\t\t\t<div v-if=\"task.rights.edit\" v-hint=\"tooltip\" class=\"tasks-field-parent-task-edit-container\">\n\t\t\t\t\t<BIcon\n\t\t\t\t\t\tclass=\"tasks-field-parent-task-icon\"\n\t\t\t\t\t\t:name=\"Outline.PLUS_L\"\n\t\t\t\t\t\thoverable\n\t\t\t\t\t\t:data-task-relation-add=\"parentTaskMeta.id\"\n\t\t\t\t\t\tref=\"add\"\n\t\t\t\t\t\t@click=\"handleEditClick\"\n\t\t\t\t\t/>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t<TaskList\n\t\t\t\tv-if=\"hasParent\"\n\t\t\t\t:ids=\"hasParent ? [parentId] : []\"\n\t\t\t\t:loadingIds=\"!subTasksService.hasStoreTask(parentId) ? [parentId] : []\"\n\t\t\t\t@removeTask=\"handleRemoveParentTask\"\n\t\t\t/>\n\t\t</div>\n\t`,\n};\n","import { Chip, ChipDesign } from 'ui.system.chip.vue';\nimport { Outline } from 'ui.icon-set.api.vue';\nimport 'ui.icon-set.outline';\n\nimport { fieldHighlighter } from 'tasks.v2.lib.field-highlighter';\nimport { idUtils } from 'tasks.v2.lib.id-utils';\nimport type { TaskModel } from 'tasks.v2.model.tasks';\n\nimport { parentTaskMeta } from './parent-task-meta';\nimport { parentTaskDialog } from './parent-task-dialog';\n\n// @vue/component\nexport const ParentTaskChip = {\n\tcomponents: {\n\t\tChip,\n\t},\n\tinject: {\n\t\ttask: {},\n\t\ttaskId: {},\n\t},\n\tsetup(): { task: TaskModel }\n\t{\n\t\treturn {\n\t\t\tparentTaskMeta,\n\t\t\tOutline,\n\t\t};\n\t},\n\tcomputed: {\n\t\ttext(): string\n\t\t{\n\t\t\tif (idUtils.isTemplate(this.task.parentId))\n\t\t\t{\n\t\t\t\treturn this.loc('TASKS_V2_PARENT_TEMPLATE_TITLE_CHIP');\n\t\t\t}\n\n\t\t\treturn this.loc('TASKS_V2_PARENT_TASK_TITLE_CHIP');\n\t\t},\n\t\tdesign(): string\n\t\t{\n\t\t\treturn this.isSelected ? ChipDesign.ShadowAccent : ChipDesign.ShadowNoAccent;\n\t\t},\n\t\tisSelected(): boolean\n\t\t{\n\t\t\treturn this.task.filledFields[parentTaskMeta.id];\n\t\t},\n\t},\n\tmethods: {\n\t\thandleClick(): void\n\t\t{\n\t\t\tif (this.isSelected)\n\t\t\t{\n\t\t\t\tthis.highlightField();\n\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tparentTaskDialog.show({\n\t\t\t\ttargetNode: this.$el,\n\t\t\t\ttaskId: this.taskId,\n\t\t\t\tonUpdate: this.highlightField,\n\t\t\t});\n\t\t},\n\t\thighlightField(): void\n\t\t{\n\t\t\tvoid fieldHighlighter.setContainer(this.$root.$el).highlight(parentTaskMeta.id);\n\t\t},\n\t},\n\ttemplate: `\n\t\t<Chip\n\t\t\tv-if=\"task.rights.edit || isSelected\"\n\t\t\t:design\n\t\t\t:text\n\t\t\t:icon=\"Outline.SUBTASK\"\n\t\t\t:data-task-id=\"taskId\"\n\t\t\t:data-task-chip-id=\"parentTaskMeta.id\"\n\t\t\tref=\"chip\"\n\t\t\t@click=\"handleClick\"\n\t\t/>\n\t`,\n};\n"],"names":["parentTaskMeta","Object","freeze","id","TaskField","Parent","dialogs","parentTaskDialog","show","params","taskId","onClose","selectItemsByIds","showTo","targetNode","isTemplate","idUtils","onItemChange","Runtime","debounce","EntitySelectorDialog","context","multiple","hideOnDeselect","enableSearch","width","entities","EntitySelectorEntity","Task","options","withTab","Template","withFooter","filter","it","preselectedItems","events","item","getSelectedItems","getEntityId","selectedTaskId","boxTemplate","getId","error","subTasksService","setParent","relationError","setTaskId","showError","parentId","taskService","getStoreTask","templateId","unbox","itemId","ParentTask","name","components","BIcon","TaskList","TextMd","directives","hint","inject","task","setup","Outline","computed","hasParent","isReal","title","loc","tooltip","text","popupOptions","offsetLeft","$refs","add","$el","offsetWidth","watch","immediate","handler","getParent","methods","handleEditClick","handleRemoveParentTask","template","ParentTaskChip","Chip","design","isSelected","ChipDesign","ShadowAccent","ShadowNoAccent","filledFields","handleClick","highlightField","onUpdate","fieldHighlighter","setContainer","$root","highlight"],"mappings":"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"}